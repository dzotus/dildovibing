# Cloud API Gateway - Следующие шаги развития

## Обзор

Документ описывает следующие шаги для улучшения реалистичности симуляции Cloud API Gateway компонента. Основная цель - приблизить поведение симуляции к реальным managed API Gateway провайдерам (AWS API Gateway, Azure API Management, GCP Cloud Endpoints).

## Приоритет 1: Критичные улучшения для симуляции

### 1.1 UI для настройки кэширования на уровне API

**Текущее состояние:**
- ✅ Логика кэширования реализована в `CloudAPIGatewayEmulationEngine`
- ✅ Типы поддерживают `api.caching.enabled`, `api.caching.ttl`, `api.caching.cacheKey`
- ❌ Нет UI для настройки кэширования для каждого API

**Что нужно сделать:**
- Добавить в UI редактирования API:
  - Switch для включения/выключения кэширования
  - Input для TTL (в секундах)
  - Multi-select для выбора параметров cache key (method, path, query, headers)
- Обновить форму создания API для включения кэширования

**Влияние на симуляцию:**
- Высокое: позволит тестировать разные стратегии кэширования
- Реалистичность: разные API могут иметь разные настройки кэша
- Метрики: cache hit rate будет различаться для разных API

**Файлы для изменения:**
- `src/components/config/edge/APIGatewayConfigAdvanced.tsx` - добавить UI элементы
- `src/core/api-gateway/types.ts` - проверить типы (уже есть)

---

### 1.2 Настройка аутентификации на уровне API

**Текущее состояние:**
- ✅ Типы поддерживают `api.authRequired` и `api.authScopes`
- ❌ Логика использует только глобальный `config.enableAuthentication`
- ❌ Нет UI для настройки аутентификации для каждого API

**Что нужно сделать:**

**Логика:**
- Обновить `authenticate()` методы в провайдер-специфичных движках:
  - Проверять `api.authRequired` перед глобальной настройкой
  - Если `api.authRequired === false`, пропускать аутентификацию для этого API
  - Если `api.authRequired === true`, требовать аутентификацию даже если глобально выключено
  - Проверять `api.authScopes` при наличии (для OAuth2/JWT)

**UI:**
- Добавить в форму редактирования API:
  - Switch для `authRequired`
  - Multi-select или Input для `authScopes` (список scopes через запятую)
  - Индикатор, что API публичный/приватный

**Влияние на симуляцию:**
- Высокое: позволит моделировать смешанные сценарии (публичные + приватные API)
- Реалистичность: соответствует реальным API Gateway (некоторые endpoints публичные, некоторые требуют auth)
- Ошибки: правильная генерация 401/403 для API без аутентификации

**Файлы для изменения:**
- `src/core/api-gateway/CloudAPIGatewayEmulationEngine.ts` - обновить логику authenticate()
- `src/components/config/edge/APIGatewayConfigAdvanced.tsx` - добавить UI элементы

---

### 1.3 Использование api.timeout в симуляции

**Текущее состояние:**
- ✅ Типы поддерживают `api.timeout`
- ✅ UI позволяет редактировать timeout
- ❌ Timeout не влияет на симуляцию (не генерирует ошибки, не влияет на latency)

**Что нужно сделать:**
- В `processRequest()` добавить проверку timeout:
  - Если запрос обрабатывается дольше `api.timeout`, вернуть 504 Gateway Timeout
  - Увеличить latency при приближении к timeout (симуляция замедления)
  - Учитывать timeout при расчете метрик (добавить timeout errors)

**Влияние на симуляцию:**
- Среднее: позволит моделировать проблемы с медленными backend
- Реалистичность: реальные gateway возвращают 504 при timeout
- Метрики: timeout errors будут учитываться в error rate

**Файлы для изменения:**
- `src/core/api-gateway/CloudAPIGatewayEmulationEngine.ts` - добавить проверку timeout в processRequest()

---

## Приоритет 2: Улучшения UX (не критично для симуляции)

### 2.1 Редактирование API Keys

**Что нужно сделать:**
- Добавить возможность редактировать имя ключа
- Добавить возможность редактировать rate limit ключа
- Добавить возможность изменять список API для ключа

**Влияние:** Только UX, не влияет на симуляцию

---

### 2.2 Валидация URL

**Что нужно сделать:**
- Добавить валидацию формата backend URL при вводе
- Проверка на валидный URL (http/https)
- Предупреждение при вводе невалидного URL

**Влияние:** Предотвращает ошибки конфигурации, не влияет на симуляцию

---

### 2.3 Визуализация связей

**Что нужно сделать:**
- Показывать связи между API Keys и API визуально
- При удалении API показывать какие ключи будут затронуты
- Граф зависимостей

**Влияние:** Улучшает понимание конфигурации, не влияет на симуляцию

---

### 2.4 Экспорт/импорт конфигурации

**Что нужно сделать:**
- Кнопка "Export Config" - сохраняет конфигурацию gateway в JSON
- Кнопка "Import Config" - загружает конфигурацию из JSON
- Валидация импортируемой конфигурации

**Влияние:** Удобство работы с конфигурациями, не влияет на симуляцию

---

## Приоритет 3: Дополнительные улучшения

### 3.1 Провайдер-специфичные метрики

**Что нужно сделать:**
- AWS: CloudWatch метрики, X-Ray traces
- Azure: Application Insights интеграция
- GCP: Cloud Monitoring метрики

**Влияние:** Повышает реалистичность метрик для каждого провайдера

---

### 3.2 Webhook поддержка

**Что нужно сделать:**
- Поддержка webhook endpoints
- Автоматическая отправка событий при изменениях
- Retry логика для webhook

**Влияние:** Расширяет функциональность gateway

---

### 3.3 GraphQL поддержка

**Что нужно сделать:**
- Поддержка GraphQL endpoints
- Query complexity limiting
- GraphQL-specific caching

**Влияние:** Расширяет типы поддерживаемых API

---

## План реализации

### Фаза 1: Критичные улучшения (1-2 недели)
1. ✅ UI для кэширования на уровне API
2. ✅ Логика + UI для аутентификации на уровне API
3. ✅ Использование timeout в симуляции

### Фаза 2: UX улучшения (1 неделя)
1. Редактирование API Keys
2. Валидация URL
3. Визуализация связей

### Фаза 3: Дополнительные функции (по необходимости)
1. Экспорт/импорт
2. Провайдер-специфичные метрики
3. Webhook/GraphQL поддержка

---

## Метрики успеха

После реализации Приоритета 1:
- ✅ Можно настроить разные стратегии кэширования для разных API
- ✅ Можно создать смешанные сценарии (публичные + приватные API)
- ✅ Timeout ошибки корректно моделируются
- ✅ Симуляция более реалистична и соответствует реальным API Gateway

---

## Технические детали

### Структура изменений

```
src/
├── components/
│   └── config/
│       └── edge/
│           └── APIGatewayConfigAdvanced.tsx  # UI улучшения
├── core/
│   └── api-gateway/
│       ├── CloudAPIGatewayEmulationEngine.ts # Логика симуляции
│       └── types.ts                          # Типы (уже готовы)
```

### Тестирование

После каждого изменения проверить:
1. UI корректно отображает настройки
2. Изменения сохраняются в конфигурации
3. Симуляция использует новые настройки
4. Метрики корректно рассчитываются

---

## Заключение

Реализация Приоритета 1 значительно повысит реалистичность симуляции Cloud API Gateway и позволит тестировать более сложные сценарии использования. Приоритеты 2 и 3 улучшат UX и расширят функциональность, но не критичны для базовой симуляции.

