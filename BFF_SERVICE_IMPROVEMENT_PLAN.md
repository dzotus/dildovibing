# План улучшения BFF Service до уровня 10/10

## Анализ текущего состояния

### ✅ Что уже реализовано:
1. **BFFRoutingEngine** - базовый движок с:
   - Агрегацией данных (merge, parallel, sequential)
   - Кэшированием (memory, redis, off)
   - Circuit breaking
   - Retry логикой
   - Метриками по бэкендам
2. **Интеграция в EmulationEngine** - симуляция метрик
3. **Интеграция в DataFlowEngine** - обработка сообщений
4. **UI компонент** - базовый интерфейс с табами
5. **Правила подключений** - автоматическое добавление бэкендов

### ❌ Критические проблемы:

#### 1. Симулятивность
- **Хардкод в generateMockResponse** - данные генерируются по имени бэкенда, а не из реальных ответов
- **Нет реальной связи с бэкендами** - BFF не отправляет запросы через DataFlowEngine к реальным бэкендам
- **Нет обновления routing engine** - изменения в UI не синхронизируются с движком
- **Нет метода updateConfig** в BFFRoutingEngine (в отличие от Kong, Apigee и др.)

#### 2. UI/UX
- **Нет редактирования endpoint'ов** - только просмотр и удаление
- **Нет редактирования backend'ов** - только просмотр и удаление
- **Нет настройки circuit breaker** для каждого backend
- **Нет настройки retry стратегий** для каждого backend
- **Нет настройки cache TTL** для endpoint'ов
- **Нет настройки timeout** для endpoint'ов
- **Нет поддержки audience** (mobile/web/partner) в UI
- **Нет поддержки fallback** в UI
- **Нет трансформации данных** (data transformation)
- **Нет фильтрации полей** (field filtering)
- **Нет поддержки аутентификации/авторизации**
- **Нет валидации** endpoint paths и других полей
- **Нет поддержки query parameters** в endpoint matching
- **Нет поддержки headers** в endpoint matching
- **Табы не адаптивны** - не переносятся на новую строку при узком экране

#### 3. Функциональность
- **Нет реальной связи с бэкендами** - запросы не проходят через DataFlowEngine
- **Нет трансформации данных** - BFF должен трансформировать ответы бэкендов
- **Нет фильтрации полей** - BFF должен фильтровать чувствительные данные
- **Нет поддержки аутентификации** - OAuth2, JWT и т.д.
- **Нет поддержки rate limiting** на уровне endpoint'ов
- **Нет поддержки request batching** (есть флаг, но нет реализации)
- **Нет поддержки response compression** (есть флаг, но нет влияния на метрики)

---

## План реализации

### Этап 1: Исправление симулятивности (критично)

#### 1.1. Добавить метод updateConfig в BFFRoutingEngine
**Файл:** `src/core/BFFRoutingEngine.ts`

**Задача:**
- Реализовать метод `updateConfig()` аналогично KongRoutingEngine
- Сохранять состояние (метрики, circuit breakers, кэш)
- Обновлять только измененные части конфигурации

**Критерии:**
- [ ] Метод updateConfig() реализован
- [ ] Сохраняется состояние circuit breakers
- [ ] Сохраняются метрики бэкендов
- [ ] Сохраняется кэш (если не изменился cacheMode)
- [ ] Удаляются несуществующие бэкенды/endpoint'ы
- [ ] Добавляются новые бэкенды/endpoint'ы

#### 1.2. Добавить метод updateBFFRoutingEngine в EmulationEngine
**Файл:** `src/core/EmulationEngine.ts`

**Задача:**
- Реализовать метод `updateBFFRoutingEngine(nodeId: string)` аналогично `updateKongRoutingEngine`
- Вызывать updateConfig() на routing engine
- Обновлять Redis connection если изменился cacheMode

**Критерии:**
- [ ] Метод updateBFFRoutingEngine() реализован
- [ ] Обновляется routing engine при изменении конфигурации
- [ ] Обновляется Redis connection если нужно
- [ ] Обрабатываются ошибки gracefully

#### 1.3. Убрать хардкод из generateMockResponse
**Файл:** `src/core/BFFRoutingEngine.ts`

**Задача:**
- Убрать хардкод генерации данных
- Использовать реальные ответы от бэкендов через DataFlowEngine
- Если бэкенд недоступен - возвращать структурированную ошибку

**Критерии:**
- [ ] Убран хардкод generateMockResponse
- [ ] Запросы к бэкендам идут через DataFlowEngine
- [ ] Обрабатываются ошибки бэкендов
- [ ] Сохраняется структура ответов бэкендов

#### 1.4. Реализовать реальную связь с бэкендами
**Файлы:** `src/core/BFFRoutingEngine.ts`, `src/core/DataFlowEngine.ts`

**Задача:**
- В executeBackend() отправлять запросы через DataFlowEngine к реальным бэкендам
- Использовать connection metadata для определения endpoint'а бэкенда
- Обрабатывать ответы и ошибки

**Критерии:**
- [ ] Запросы к бэкендам идут через DataFlowEngine
- [ ] Используется правильный протокол (HTTP/gRPC/GraphQL)
- [ ] Обрабатываются таймауты
- [ ] Обрабатываются ошибки соединения
- [ ] Сохраняется latency из реальных запросов

#### 1.5. Синхронизация UI с routing engine
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Добавить useEffect для синхронизации конфигурации с routing engine
- Вызывать updateBFFRoutingEngine при изменениях
- Обновлять метрики из routing engine в реальном времени

**Критерии:**
- [ ] useEffect для синхронизации конфигурации
- [ ] Вызывается updateBFFRoutingEngine при изменениях
- [ ] Метрики обновляются из routing engine
- [ ] Нет бесконечных циклов обновления

---

### Этап 2: Расширение UI до уровня оригинала

#### 2.1. Редактирование endpoint'ов
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Добавить модальное окно/форму для редактирования endpoint'а
- Поля: path, method, aggregator, cacheTtl, timeout
- Выбор бэкендов через чекбоксы
- Валидация path (должен начинаться с /)
- Валидация метода

**Критерии:**
- [ ] Модальное окно для редактирования endpoint'а
- [ ] Все поля редактируемы
- [ ] Валидация path и method
- [ ] Выбор бэкендов через UI
- [ ] Сохранение изменений

#### 2.2. Редактирование backend'ов
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Добавить модальное окно/форму для редактирования backend'а
- Поля: name, endpoint, protocol, timeout, retries, retryBackoff
- Настройка circuit breaker: enabled, failureThreshold, successThreshold, timeout
- Валидация endpoint (должен быть валидным URL)
- Валидация протокола

**Критерии:**
- [ ] Модальное окно для редактирования backend'а
- [ ] Все поля редактируемы
- [ ] Настройка circuit breaker
- [ ] Настройка retry стратегий
- [ ] Валидация полей
- [ ] Сохранение изменений

#### 2.3. Поддержка audience в UI
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Добавить поле audience в Settings таб
- Выбор: mobile, web, partner
- Влияние на поведение BFF (размер ответов, формат данных)

**Критерии:**
- [ ] Поле audience в Settings
- [ ] Выбор из опций: mobile, web, partner
- [ ] Влияние на симуляцию (размер payload, latency)

#### 2.4. Поддержка fallback в UI
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Добавить настройки fallback в Settings таб
- Поля: enableFallback, fallbackComponent
- Выбор fallback компонента из списка доступных

**Критерии:**
- [ ] Настройки fallback в Settings
- [ ] Выбор fallback компонента
- [ ] Влияние на симуляцию при ошибках

#### 2.5. Трансформация данных
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`, `src/core/BFFRoutingEngine.ts`

**Задача:**
- Добавить поле transformation в endpoint конфигурацию
- Поддержка JSONPath или шаблонов для трансформации
- UI для настройки трансформации (textarea с примером)

**Критерии:**
- [ ] Поле transformation в endpoint
- [ ] UI для настройки трансформации
- [ ] Реализация трансформации в routing engine
- [ ] Влияние на latency (добавляется overhead)

#### 2.6. Фильтрация полей
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`, `src/core/BFFRoutingEngine.ts`

**Задача:**
- Добавить поле fieldFilter в endpoint конфигурацию
- Список полей для включения/исключения
- UI для настройки фильтрации

**Критерии:**
- [ ] Поле fieldFilter в endpoint
- [ ] UI для настройки фильтрации
- [ ] Реализация фильтрации в routing engine
- [ ] Влияние на размер payload

#### 2.7. Валидация полей
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Валидация endpoint path (должен начинаться с /, валидный путь)
- Валидация backend endpoint (валидный URL)
- Валидация timeout (положительное число)
- Валидация retries (0-10)
- Показ ошибок валидации

**Критерии:**
- [ ] Валидация всех полей
- [ ] Показ ошибок валидации
- [ ] Блокировка сохранения при ошибках
- [ ] Подсказки для пользователя

#### 2.8. Адаптивность табов
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Табы должны переноситься на новую строку при узком экране
- Подложка должна расширяться под табы
- Использовать flex-wrap для TabsList

**Критерии:**
- [ ] Табы переносятся на новую строку
- [ ] Подложка расширяется
- [ ] Работает на разных размерах экрана

---

### Этап 3: Расширение функциональности

#### 3.1. Поддержка query parameters в endpoint matching
**Файл:** `src/core/BFFRoutingEngine.ts`

**Задача:**
- Расширить matchEndpoint() для поддержки query parameters
- Добавить поле queryParams в BFFEndpoint
- Матчинг по query параметрам

**Критерии:**
- [ ] Поддержка query parameters в endpoint
- [ ] Матчинг по query параметрам
- [ ] Влияние на кэширование (разные query = разные ключи)

#### 3.2. Поддержка headers в endpoint matching
**Файл:** `src/core/BFFRoutingEngine.ts`

**Задача:**
- Расширить matchEndpoint() для поддержки headers
- Добавить поле requiredHeaders в BFFEndpoint
- Матчинг по headers (например, Content-Type)

**Критерии:**
- [ ] Поддержка headers в endpoint
- [ ] Матчинг по headers
- [ ] Влияние на кэширование

#### 3.3. Реализация request batching
**Файл:** `src/core/BFFRoutingEngine.ts`

**Задача:**
- Реализовать request batching (если enableRequestBatching = true)
- Группировать запросы к одному бэкенду
- Отправлять батчи через DataFlowEngine

**Критерии:**
- [ ] Реализация request batching
- [ ] Группировка запросов
- [ ] Влияние на latency (уменьшение)
- [ ] Влияние на throughput (увеличение)

#### 3.4. Реализация response compression
**Файл:** `src/core/BFFRoutingEngine.ts`, `src/core/EmulationEngine.ts`

**Задача:**
- Реализовать response compression (если enableResponseCompression = true)
- Уменьшать размер payload
- Влиять на latency (добавляется overhead на сжатие)

**Критерии:**
- [ ] Реализация response compression
- [ ] Уменьшение размера payload
- [ ] Влияние на latency
- [ ] Влияние на метрики

#### 3.5. Поддержка rate limiting
**Файл:** `src/core/BFFRoutingEngine.ts`, `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Добавить rate limiting на уровне endpoint'ов
- Поля: rateLimit (requests per second)
- Блокировка запросов при превышении лимита

**Критерии:**
- [ ] Поддержка rate limiting
- [ ] UI для настройки rate limit
- [ ] Блокировка запросов при превышении
- [ ] Влияние на метрики (error rate)

---

### Этап 4: Улучшение UX

#### 4.1. Toast уведомления
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Toast при успешном сохранении endpoint'а
- Toast при успешном сохранении backend'а
- Toast при удалении
- Toast при ошибках валидации

**Критерии:**
- [ ] Toast для всех операций
- [ ] Информативные сообщения
- [ ] Автоматическое скрытие

#### 4.2. Подтверждения для критичных действий
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Подтверждение при удалении endpoint'а
- Подтверждение при удалении backend'а
- Диалог подтверждения

**Критерии:**
- [ ] Диалог подтверждения для удаления
- [ ] Возможность отмены
- [ ] Информативные сообщения

#### 4.3. Подсказки и описания
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Добавить Tooltip с описаниями для всех полей
- Объяснить что такое aggregator, circuit breaker, retry backoff
- Добавить примеры значений

**Критерии:**
- [ ] Tooltip для всех полей
- [ ] Понятные описания
- [ ] Примеры значений

#### 4.4. Визуальные индикаторы состояния
**Файл:** `src/components/config/integration/BFFServiceConfigAdvanced.tsx`

**Задача:**
- Показывать статус бэкенда (connected/disconnected/error) визуально
- Показывать circuit breaker состояние
- Показывать метрики в реальном времени

**Критерии:**
- [ ] Визуальные индикаторы статуса
- [ ] Обновление в реальном времени
- [ ] Понятные цвета и иконки

---

### Этап 5: Очистка и оптимизация

#### 5.1. Удаление неиспользуемых элементов
**Задача:**
- Проверить все кнопки и ссылки на функциональность
- Удалить неиспользуемые элементы
- Упростить навигацию

**Критерии:**
- [ ] Все элементы функциональны
- [ ] Нет неиспользуемых элементов
- [ ] Упрощенная навигация

#### 5.2. Оптимизация layout
**Задача:**
- Оптимизировать расположение элементов
- Улучшить читаемость
- Улучшить использование пространства

**Критерии:**
- [ ] Оптимизированный layout
- [ ] Улучшенная читаемость
- [ ] Эффективное использование пространства

---

## Приоритеты реализации

### Критично (делать первым):
1. ✅ Этап 1.1 - Добавить updateConfig в BFFRoutingEngine - **ВЫПОЛНЕНО**
2. ✅ Этап 1.2 - Добавить updateBFFRoutingEngine в EmulationEngine - **ВЫПОЛНЕНО**
3. ✅ Этап 1.3 - Убрать хардкод из generateMockResponse - **ВЫПОЛНЕНО** (метод удален, используется реальная связь с бэкендами)
4. ✅ Этап 1.4 - Реализовать реальную связь с бэкендами - **ВЫПОЛНЕНО** (создана функция sendMessageToBackend в EmulationEngine, которая отправляет запросы через DataFlowEngine к реальным бэкендам)
5. ✅ Этап 1.5 - Синхронизация UI с routing engine - **ВЫПОЛНЕНО** (updateBFFRoutingEngine вызывается при изменениях конфигурации)

### Важно (делать вторым):
6. ✅ Этап 2.1 - Редактирование endpoint'ов - **ВЫПОЛНЕНО** (версия 0.1.8i)
7. ✅ Этап 2.2 - Редактирование backend'ов - **ВЫПОЛНЕНО** (версия 0.1.8i)
8. ✅ Этап 2.7 - Валидация полей - **ВЫПОЛНЕНО** (версия 0.1.8i)
9. ✅ Этап 2.8 - Адаптивность табов - **ВЫПОЛНЕНО** (версия 0.1.8i)

### Желательно (делать третьим):
10. ✅ Этап 2.3 - Поддержка audience в UI - **ВЫПОЛНЕНО** (версия 0.1.8i)
11. ✅ Этап 2.4 - Поддержка fallback в UI - **ВЫПОЛНЕНО** (версия 0.1.8i)
12. ⏳ Этап 3.1 - Поддержка query parameters - **НЕ РЕАЛИЗОВАНО** (опционально)
13. ⏳ Этап 3.2 - Поддержка headers - **НЕ РЕАЛИЗОВАНО** (опционально)
14. ✅ Этап 4.1 - Toast уведомления - **ВЫПОЛНЕНО** (версия 0.1.8i)
15. ✅ Этап 4.2 - Подтверждения для критичных действий - **ВЫПОЛНЕНО** (версия 0.1.8i)

### Опционально (делать последним):
16. ✅ Этап 2.5 - Трансформация данных
17. ✅ Этап 2.6 - Фильтрация полей
18. ✅ Этап 3.3 - Реализация request batching
19. ✅ Этап 3.4 - Реализация response compression
20. ✅ Этап 3.5 - Поддержка rate limiting
21. ✅ Этап 4.3 - Подсказки и описания
22. ✅ Этап 4.4 - Визуальные индикаторы состояния

---

## Критерии качества

### Функциональность (10/10)
- [ ] Все функции оригинала реализованы
- [ ] Все CRUD операции работают
- [ ] Валидация данных корректна
- [ ] Обработка ошибок реализована
- [ ] Реальная связь с бэкендами работает

### UI/UX (10/10)
- [ ] Структура соответствует оригиналу
- [ ] Все элементы интерактивны
- [ ] Навигация интуитивна
- [ ] Визуальный стиль соответствует оригиналу
- [ ] Адаптивность работает

### Симулятивность (10/10)
- [ ] Компонент влияет на метрики системы
- [ ] Метрики отражают реальное состояние
- [ ] Конфигурация влияет на поведение
- [ ] Интеграция с другими компонентами работает
- [ ] Нет хардкода и скриптованности

---

## Важные принципы

1. **Избегай хардкода** - используй конфигурацию и данные
2. **Реализуй реальную логику** - не заглушки
3. **Синхронизируй UI с симуляцией** - показывай реальные данные
4. **Исправляй все баги** - ничего не должно быть сломано
5. **Оптимизируй UX** - делай интерфейс удобным
6. **Каждый компонент уникален** - не копируй логику других компонентов бездумно
7. **BFF специфичен** - он агрегирует данные, трансформирует их, фильтрует для фронтенда

---

## Примечания

- BFF Service должен быть уникальным по своей логике - он не API Gateway, не Load Balancer
- BFF специализируется на агрегации данных для конкретного фронтенда (mobile/web/partner)
- BFF должен трансформировать данные, фильтровать чувствительные поля, оптимизировать для клиента
- BFF должен кэшировать агрегированные ответы для уменьшения нагрузки на бэкенды
- BFF должен обрабатывать ошибки gracefully и предоставлять fallback
