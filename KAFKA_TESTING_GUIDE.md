# Руководство по тестированию компонента Apache Kafka

## Базовая функциональность (Задача 7.1)

### Тест 1: Создание Kafka ноды и топика
**Шаги:**
1. Добавить компонент Kafka на canvas
2. Открыть конфигурацию Kafka
3. Перейти на вкладку "Topics"
4. Нажать "Create Topic"
5. Заполнить:
   - Topic Name: `test-topic`
   - Partitions: `3`
   - Replication Factor: `1`
6. Сохранить

**Ожидаемый результат:**
- Топик создан и отображается в списке
- Метрики топика показывают 0 messages, 0 size
- Партиции инициализированы (3 партиции)

---

### Тест 2: Публикация сообщений
**Шаги:**
1. Создать компонент-производитель (например, REST API или бизнес-приложение)
2. Создать соединение от производителя к Kafka
3. Настроить соединение:
   - В metadata указать `topic: test-topic`
   - Опционально: указать `key` для key-based partitioning
4. Запустить симуляцию
5. Производитель должен отправлять сообщения

**Ожидаемый результат:**
- Сообщения попадают в топик
- Метрики топика обновляются (messages count, size увеличиваются)
- Сообщения распределяются по партициям (если указан key - в одну партицию, без key - round-robin)
- Offset сообщений увеличивается

**Проверка:**
- Открыть конфигурацию Kafka → Topics → Partition Details
- Убедиться, что сообщения распределены по партициям
- Проверить offset и high watermark для каждой партиции

---

### Тест 3: Создание Consumer Group и потребление
**Шаги:**
1. Создать компонент-потребитель (например, другой REST API или микросервис)
2. Создать соединение от Kafka к потребителю
3. Настроить consumer group:
   - В конфигурации Kafka → Consumers → Add Group
   - Group ID: `test-consumer-group`
   - Topic: `test-topic`
   - Members: `1`
   - Offset Strategy: `latest`
4. Запустить симуляцию

**Ожидаемый результат:**
- Consumer group создана и отображается
- Сообщения потребляются из топика
- Lag уменьшается (если был)
- Consumption rate отображается в UI
- Partition assignment отображается

**Проверка:**
- Открыть конфигурацию Kafka → Consumers
- Убедиться, что lag обновляется в реальном времени
- Проверить consumption rate (msg/s)
- Проверить partition assignment

---

### Тест 4: Проверка Lag
**Шаги:**
1. Остановить потребителя (удалить соединение или остановить симуляцию)
2. Продолжить публикацию сообщений
3. Проверить lag в consumer group

**Ожидаемый результат:**
- Lag увеличивается по мере публикации новых сообщений
- Lag = разница между latest offset и consumer offset

**Проверка:**
- Lag отображается в UI
- Lag рассчитывается правильно для всех партиций

---

## Edge Cases (Задача 7.2)

### Тест 5: Топик не существует → ошибка
**Шаги:**
1. Создать соединение от производителя к Kafka
2. Указать несуществующий топик в metadata: `topic: non-existent-topic`
3. Запустить симуляцию

**Ожидаемый результат:**
- Сообщение получает статус `failed`
- Ошибка: `Topic 'non-existent-topic' not found`
- Метрики ошибок увеличиваются

---

### Тест 6: ACL denied → блокировка
**Шаги:**
1. В конфигурации Kafka → ACLs добавить правило:
   - Principal: `User:test-producer`
   - Resource Type: `Topic`
   - Resource Name: `test-topic`
   - Operation: `Write`
   - Permission: `Deny`
2. Создать производителя с principal `User:test-producer`
3. Попытаться отправить сообщение в `test-topic`

**Ожидаемый результат:**
- Сообщение получает статус `failed`
- Ошибка: `ACL denied: No Write permission for topic 'test-topic'`
- Сообщение не попадает в топик

---

### Тест 7: Retention удаляет сообщения
**Шаги:**
1. Создать топик с настройками:
   - Retention: `10000` (10 секунд)
   - Cleanup Policy: `delete`
2. Отправить сообщения в топик
3. Подождать более 10 секунд
4. Проверить метрики топика

**Ожидаемый результат:**
- Старые сообщения удаляются через 10 секунд
- Message count уменьшается
- Size уменьшается
- Offsets обновляются

**Проверка:**
- Метрики топика обновляются
- Старые сообщения больше не доступны для потребления

---

### Тест 8: Compaction работает
**Шаги:**
1. Создать топик с настройками:
   - Cleanup Policy: `compact`
2. Отправить несколько сообщений с одинаковым key
3. Подождать обработки compaction
4. Проверить сообщения в топике

**Ожидаемый результат:**
- Только последнее сообщение для каждого key остается
- Старые сообщения с тем же key удаляются
- Сообщения без key остаются

**Проверка:**
- В топике только последние сообщения для каждого key
- Message count уменьшается

---

### Тест 9: Rebalancing при изменении members
**Шаги:**
1. Создать consumer group с 1 member
2. Запустить симуляцию и убедиться, что потребление работает
3. Изменить количество members на 2 (или больше)
4. Наблюдать за rebalancing

**Ожидаемый результат:**
- Индикатор "Rebalancing..." появляется
- Потребление временно приостанавливается
- Partition assignment пересчитывается
- После rebalancing потребление возобновляется
- Lag может увеличиться во время rebalancing

**Проверка:**
- В UI отображается индикатор rebalancing
- Partition assignment обновляется
- Consumption rate восстанавливается после rebalancing

---

### Тест 10: Множественные consumer groups на одном топике
**Шаги:**
1. Создать несколько consumer groups для одного топика:
   - Group 1: `group-1`, Members: `1`
   - Group 2: `group-2`, Members: `2`
2. Запустить симуляцию
3. Отправить сообщения в топик

**Ожидаемый результат:**
- Обе группы потребляют сообщения независимо
- Каждая группа имеет свой lag
- Partition assignment разный для каждой группы
- Сообщения доставляются в обе группы

**Проверка:**
- Обе группы отображаются в UI
- Lag рассчитывается отдельно для каждой группы
- Consumption rate отображается для каждой группы

---

## Leader Election (Задача 4.1)

### Тест 11: Leader election при падении leader
**Шаги:**
1. Создать топик с replication factor > 1 (например, 3)
2. Убедиться, что есть несколько брокеров
3. Симулировать падение leader (высокий error rate или utilization)
4. Наблюдать за leader election

**Ожидаемый результат:**
- ISR обновляется (нездоровые реплики удаляются)
- Новый leader выбирается из ISR
- Партиция продолжает работать с новым leader
- High watermark сохраняется

**Проверка:**
- В UI отображается новый leader для партиции
- ISR обновляется
- Партиция продолжает принимать сообщения

---

### Тест 12: ISR обновление на основе здоровья реплик
**Шаги:**
1. Создать топик с replication factor 3
2. Симулировать проблемы с одним из брокеров (высокий error rate)
3. Наблюдать за ISR

**Ожидаемый результат:**
- Нездоровые реплики удаляются из ISR
- ISR содержит только здоровые реплики
- Если все реплики нездоровы, ISR пустой

**Проверка:**
- ISR обновляется в реальном времени
- Количество реплик в ISR соответствует количеству здоровых брокеров

---

## Автоматическое определение Consumer Groups (Задача 5.1)

### Тест 13: Автоматическое создание consumer group
**Шаги:**
1. Создать соединение от Kafka к потребителю БЕЗ указания consumer group в конфигурации
2. Запустить симуляцию

**Ожидаемый результат:**
- Consumer group создается автоматически
- Group ID генерируется на основе connection ID
- Member count обновляется на основе количества соединений

**Проверка:**
- Consumer group появляется в списке (может быть с auto-generated ID)
- Lag рассчитывается для автоматически созданной группы

---

## Валидация (Задача 6.4)

### Тест 14: Валидация topic name
**Шаги:**
1. Попытаться создать топик с невалидным именем:
   - Начинается с точки: `.invalid-topic`
   - Начинается с двойного подчеркивания: `__invalid-topic`
   - Содержит недопустимые символы: `topic@name`
   - Слишком длинное имя (>249 символов)

**Ожидаемый результат:**
- Отображается ошибка валидации
- Топик не создается
- Поле подсвечивается красным

---

### Тест 15: Валидация replication factor
**Шаги:**
1. Попытаться установить replication factor больше количества брокеров
2. Попытаться установить replication factor < 1

**Ожидаемый результат:**
- Отображается ошибка валидации
- Значение не сохраняется
- Поле подсвечивается красным

---

### Тест 16: Валидация partitions
**Шаги:**
1. Попытаться установить partitions < 1
2. Попытаться установить partitions > 10000

**Ожидаемый результат:**
- Отображается ошибка валидации
- Значение не сохраняется
- Поле подсвечивается красным

---

## Производительность (Задача 7.3)

### Тест 17: Большое количество сообщений
**Шаги:**
1. Создать топик
2. Отправить большое количество сообщений (1000+)
3. Проверить производительность UI

**Ожидаемый результат:**
- UI остается отзывчивым
- Метрики обновляются плавно
- Нет задержек при отображении

---

### Тест 18: Множественные топики и партиции
**Шаги:**
1. Создать 10+ топиков
2. Каждый топик с 10+ партициями
3. Отправить сообщения во все топики

**Ожидаемый результат:**
- Система обрабатывает все топики
- Метрики рассчитываются для всех партиций
- UI отображает все данные

---

## Чеклист для быстрой проверки

- [ ] Kafka нода создается и инициализируется
- [ ] Топики создаются и отображаются
- [ ] Сообщения публикуются в топики
- [ ] Consumer groups создаются (вручную и автоматически)
- [ ] Сообщения потребляются из топиков
- [ ] Lag рассчитывается правильно
- [ ] Consumption rate отображается
- [ ] Rebalancing работает при изменении members
- [ ] Partition assignment отображается
- [ ] Retention удаляет старые сообщения
- [ ] Compaction работает для сообщений с key
- [ ] ACL блокирует неавторизованный доступ
- [ ] Leader election работает при падении leader
- [ ] ISR обновляется на основе здоровья реплик
- [ ] Валидация работает для всех полей
- [ ] Tooltips отображаются для всех полей
- [ ] Метрики обновляются в реальном времени

---

## Примечания

- Все тесты должны выполняться при запущенной симуляции
- Некоторые тесты требуют ожидания (retention, compaction)
- Для тестирования leader election может потребоваться симуляция проблем с брокерами
- Автоматические consumer groups создаются только при наличии исходящих соединений
