# План разработки компонента IDS/IPS

## Анализ текущего состояния

### ✅ Что уже реализовано
- Базовый `IDSIPSRoutingEngine` с обработкой пакетов
- `IDSIPSEmulationEngine` для симуляции метрик
- Интеграция в `EmulationEngine` и `DataFlowEngine`
- UI компонент `IDSIPSConfigAdvanced` с вкладками для алертов, сигнатур, заблокированных IP
- Поддержка режимов IDS (detection) и IPS (prevention)
- Базовое обнаружение по сигнатурам, аномалиям и поведенческому анализу
- Управление заблокированными IP с автоматическим истечением

### ❌ Выявленные проблемы

#### 1. Хардкод и скриптованность
- **Проблема**: В `IDSIPSEmulationEngine.generateRandomPacket()` хардкод:
  - Фиксированные подозрительные паттерны в массиве
  - Фиксированный процент подозрительных пакетов (5%)
  - Фиксированные порты для генерации
  - Не учитываются реальные сетевые паттерны из соединений

- **Проблема**: В `IDSIPSRoutingEngine.detectAnomaly()`:
  - Хардкод портов `[22, 23, 80, 443, 3306, 5432, 27017, 6379, 8080]` как "подозрительных" - это НЕВЕРНО, это нормальные порты
  - Логика аномалий слишком упрощена и не соответствует реальности
  - Фиксированные пороги и веса для аномалий

- **Проблема**: В `IDSIPSRoutingEngine.matchIP()`:
  - Упрощенная CIDR matching логика, не соответствует реальности
  - Не используется библиотека для работы с IP адресами

#### 2. Несоответствие реальным IDS/IPS системам
- **Проблема**: Отсутствует поддержка реальных форматов сигнатур:
  - Snort rules (стандарт индустрии)
  - Suricata rules
  - YARA rules (для payload анализа)
  - Custom rule formats

- **Проблема**: Упрощенный протокольный анализ:
  - Нет анализа TCP флагов (SYN, ACK, FIN, RST, PSH, URG)
  - Нет проверки TCP sequence numbers
  - Нет анализа фрагментации пакетов
  - Нет проверки протокольной консистентности (protocol conformance)

- **Проблема**: Недостаточный поведенческий анализ:
  - Только отслеживание request rate
  - Нет анализа временных паттернов (time-based patterns)
  - Нет анализа географических паттернов
  - Нет машинного обучения (ML) для обнаружения

#### 3. Архитектурные проблемы
- **Проблема**: Отсутствуют Connection Rules для IDS/IPS
  - Нет правил подключения в `src/services/connection/rules/`
  - Не определены допустимые типы соединений
  - Не определены порты и протоколы для подключения

- **Проблема**: Симуляция пакетов не использует реальные данные:
  - `generateRandomPacket()` генерирует случайные данные вместо использования реальных соединений
  - Не учитываются реальные метрики из входящих соединений
  - Не учитываются реальные payload из сообщений

#### 4. UI/UX проблемы
- **Проблема**: В UI есть хардкод дефолтных сигнатур:
  ```typescript
  const signatures = config.signatures || [
    { id: '1', name: 'SSH Brute Force', ... },
    { id: '2', name: 'SQL Injection', ... },
  ];
  ```
  - Должны загружаться из конфигурации или быть пустыми

- **Проблема**: Отсутствует валидация сигнатур:
  - Нет проверки корректности regex паттернов
  - Нет проверки корректности Snort rules
  - Нет предупреждений о некорректных правилах

#### 5. Метрики и наблюдаемость
- **Проблема**: Недостаточные метрики:
  - Нет метрик false positive rate
  - Нет метрик по типам атак
  - Нет временных метрик (trends)
  - Нет метрик производительности по типам обнаружения

---

## План реализации

### Этап 1: Изучение архитектуры и реальных систем

#### 1.1 Изучить архитектуру системы
**Файлы для изучения:**
- `src/core/EmulationEngine.ts` - понять как инициализируются движки
- `src/core/DataFlowEngine.ts` - понять как обрабатываются потоки данных
- `src/services/connection/ServiceDiscovery.ts` - понять как разрешаются имена/порты
- `src/services/connection/rules/firewallRules.ts` - изучить паттерны для security компонентов
- `src/services/connection/rules/wafRules.ts` - изучить паттерны для security компонентов

**Цель:** Понять паттерны инициализации, обработки данных и правил подключения для security компонентов.

#### 1.2 Изучить реальные IDS/IPS системы
**Ресурсы для изучения:**
- Snort: https://www.snort.org/ (формат правил, архитектура)
- Suricata: https://suricata.io/ (формат правил, архитектура)
- OSSEC: https://www.ossec.net/ (host-based IDS)
- Zeek (Bro): https://zeek.org/ (network analysis framework)
- NIST SP 800-94: Guide to Intrusion Detection and Prevention Systems

**Ключевые аспекты:**
- Форматы правил (Snort rules, Suricata rules)
- Методы обнаружения (signature-based, anomaly-based, behavior-based)
- Протокольный анализ (deep packet inspection, protocol conformance)
- Режимы работы (inline, passive, tap mode)
- Метрики и отчетность

**Цель:** Понять как работают реальные IDS/IPS системы, какие фичи они имеют, какие метрики собирают.

#### 1.3 Изучить похожие компоненты в проекте
**Компоненты для изучения:**
- `FirewallEmulationEngine.ts` и `FirewallRoutingEngine.ts` - похожая логика обработки пакетов
- `WAFEmulationEngine.ts` и `WAFRoutingEngine.ts` - похожая логика обнаружения угроз
- `FirewallConfigAdvanced.tsx` - UI паттерны для security компонентов

**Цель:** Понять паттерны реализации, но НЕ копировать слепо - каждый компонент уникален.

---

### Этап 2: Исправление хардкода и скриптованности

#### 2.1 Убрать хардкод из симуляции пакетов ✅
**Файл:** `src/core/IDSIPSEmulationEngine.ts`

**Задачи:**
- [x] ✅ Удалить `generateRandomPacket()` или переделать его для использования реальных данных
- [x] ✅ Использовать реальные пакеты из входящих соединений вместо генерации случайных
- [x] ✅ Использовать реальные payload из сообщений `DataMessage`
- [x] ✅ Использовать реальные IP адреса из соединений компонентов
- [x] ✅ Использовать реальные порты из конфигурации соединений
- [x] ✅ Если нет реальных данных, использовать конфигурацию компонента для генерации реалистичных данных

**Критерии приемки:**
- ✅ Нет фиксированных массивов подозрительных паттернов
- ✅ Нет фиксированных процентов подозрительных пакетов
- ✅ Все данные берутся из реальных соединений или конфигурации

**Реализовано:**
- Переделан `generateRandomPacket()` с приоритетами: 1) реальные пакеты из истории, 2) реальные IP из сигнатур, 3) реальные хосты из подключенных компонентов, 4) заблокированные IP, 5) fallback на дефолтные значения
- Добавлено сохранение реальных пакетов в `recentPackets` для использования в симуляции
- Добавлен метод `hostnameToIP()` для стабильного преобразования hostname в IP
- Добавлена поддержка nodes и connections в `IDSIPSEmulationEngine`

#### 2.2 Исправить логику обнаружения аномалий ✅
**Файл:** `src/core/IDSIPSRoutingEngine.ts`

**Задачи:**
- [x] ✅ Убрать хардкод портов как "подозрительных" - это нормальные порты
- [x] ✅ Реализовать реальную логику аномалий:
  - ✅ Базовые линии (baselines) для нормального трафика
  - ✅ Отклонения от базовых линий
  - ✅ Статистический анализ (mean, std deviation)
  - ✅ Временные паттерны
- [x] ✅ Добавить конфигурируемые пороги для аномалий
- [x] ✅ Добавить обучение базовых линий на основе исторических данных

**Критерии приемки:**
- ✅ Нет хардкода портов как подозрительных
- ✅ Логика аномалий основана на статистике, а не на фиксированных значениях
- ✅ Пороги конфигурируемые

**Реализовано:**
- Удален хардкод портов [22, 23, 80, 443, 3306, 5432, 27017, 6379, 8080] как подозрительных
- Реализованы статистические базовые линии для портов, протоколов и размера payload
- Добавлен метод `updateBaselines()` для обучения на исторических данных
- Используется z-score (3-sigma rule) для обнаружения аномалий
- Добавлена проверка подозрительных паттернов в payload (SQL injection, XSS, etc.)

#### 2.3 Исправить CIDR matching ✅
**Файл:** `src/core/IDSIPSRoutingEngine.ts`

**Задачи:**
- [x] ✅ Использовать библиотеку для работы с IP адресами (реализована собственная логика)
- [x] ✅ Реализовать правильную CIDR matching логику
- [ ] Добавить поддержку IPv6 (если нужно) - не реализовано, только IPv4

**Критерии приемки:**
- ✅ Правильная работа CIDR matching для всех случаев
- ⚠️ Поддержка только IPv4 (IPv6 не реализовано)

**Реализовано:**
- Реализован метод `ipToNumber()` для преобразования IP адреса в число
- Реализована правильная CIDR matching логика с использованием битовых масок
- Поддержка всех CIDR префиксов от /0 до /32

#### 2.4 Убрать хардкод из UI ✅
**Файл:** `src/components/config/security/IDSIPSConfigAdvanced.tsx`

**Задачи:**
- [x] ✅ Убрать дефолтные сигнатуры из кода
- [x] ✅ Если нужны примеры, загружать их из конфигурации или отдельного файла
- [x] ✅ Пустой список сигнатур по умолчанию

**Критерии приемки:**
- ✅ Нет хардкода дефолтных сигнатур в коде
- ✅ Пустой список сигнатур по умолчанию

**Реализовано:**
- Удалены хардкод дефолтные сигнатуры (SSH Brute Force, SQL Injection)
- Используется только `config.signatures` из конфигурации или пустой массив

---

### Этап 3: Реализация реальных фич IDS/IPS

#### 3.1 Поддержка форматов сигнатур ✅
**Файлы:** 
- `src/core/IDSIPSRoutingEngine.ts` ✅
- `src/utils/idsips/signatureParser.ts` ✅ **СОЗДАН**

**Задачи:**
- [x] ✅ Реализовать парсер Snort rules
  - Формат: `action protocol source port direction destination port (options)`
  - Пример: `alert tcp any any -> any 22 (msg:"SSH connection"; sid:1000001;)`
- [ ] Реализовать парсер Suricata rules (похож на Snort, но есть отличия) - не реализовано
- [x] ✅ Поддержка основных опций Snort:
  - ✅ `msg` - сообщение
  - ✅ `sid` - signature ID
  - ✅ `rev` - revision
  - ✅ `content` - содержимое для поиска
  - ✅ `flags` - TCP flags (парсится, но не используется в matching)
  - ✅ `threshold` - пороги (парсится, но не используется)
  - ✅ И другие основные опции (парсятся динамически)
- [x] ✅ Валидация правил при добавлении
- [x] ✅ Конвертация из Snort format в внутренний формат (частично - используется напрямую)

**Критерии приемки:**
- ✅ Парсер может обрабатывать базовые Snort rules
- ✅ Валидация правил работает корректно
- ✅ Ошибки парсинга отображаются пользователю

**Реализовано:**
- Создан `signatureParser.ts` с полным парсером Snort rules
- Парсер поддерживает все основные действия (alert, log, pass, drop, reject, etc.)
- Парсер поддерживает все протоколы (tcp, udp, icmp, ip)
- Парсер поддерживает IP адреса, CIDR, порты и диапазоны портов
- Парсер извлекает все опции из скобок (msg, sid, rev, content, flags, threshold, etc.)
- Валидация IP адресов, CIDR и портов
- Интеграция парсера в `IDSIPSRoutingEngine` с кэшированием распарсенных правил
- Поддержка как Snort rules, так и обычных regex паттернов

#### 3.2 Протокольный анализ (Deep Packet Inspection) ✅
**Файл:** `src/core/IDSIPSRoutingEngine.ts`

**Задачи:**
- [x] ✅ Анализ TCP флагов:
  - ✅ SYN, ACK, FIN, RST, PSH, URG
  - ✅ Обнаружение подозрительных комбинаций (например, FIN без ACK, RST без ACK)
- [x] ✅ Анализ TCP sequence numbers:
  - ✅ Обнаружение аномальных sequence numbers (проверка валидности)
  - ⚠️ Обнаружение out-of-order пакетов - частично (базовая проверка)
- [x] ✅ Анализ фрагментации:
  - ✅ Обнаружение фрагментированных пакетов
  - ⚠️ Обнаружение overlapping fragments - частично (базовая проверка)
- [ ] Protocol conformance checking:
  - ⚠️ Проверка соответствия протоколу (например, HTTP должен иметь правильные заголовки) - не реализовано
  - ✅ Обнаружение protocol violations (базовое)

**Критерии приемки:**
- ✅ Анализ TCP флагов работает
- ✅ Обнаружение аномальных sequence numbers работает
- ⚠️ Protocol conformance checking работает частично

**Реализовано:**
- Добавлен метод `analyzeProtocol()` для протокольного анализа
- Проверка подозрительных комбинаций TCP флагов (FIN без ACK, RST, множественные флаги)
- Проверка валидности TCP sequence numbers
- Обнаружение фрагментированных пакетов
- Добавлена поддержка TCP flags, sequence numbers, fragmentation в интерфейсе `IDSIPSPacket`

#### 3.3 Улучшенный поведенческий анализ ✅
**Файл:** `src/core/IDSIPSRoutingEngine.ts`

**Задачи:**
- [x] ✅ Временные паттерны:
  - ✅ Анализ паттернов по времени суток (hourly patterns)
  - ✅ Анализ паттернов по дням недели (daily patterns)
  - ✅ Обнаружение аномальных временных паттернов
- [ ] Географические паттерны:
  - ⚠️ Отслеживание стран источников (если доступно) - не реализовано (интерфейс добавлен)
  - ⚠️ Обнаружение аномальных географических паттернов - не реализовано
- [x] ✅ Анализ трафика:
  - ✅ Обнаружение DDoS паттернов
  - ✅ Обнаружение port scanning
  - ✅ Обнаружение network scanning
- [ ] Machine Learning (базовый):
  - ⚠️ Простые статистические модели для обнаружения аномалий - частично (статистические базовые линии)
  - ⚠️ Clustering для группировки похожих событий - не реализовано

**Критерии приемки:**
- ✅ Временные паттерны анализируются
- ⚠️ Географические паттерны анализируются (если доступны данные) - интерфейс готов, но не используется
- ✅ Обнаружение DDoS и scanning работает

**Реализовано:**
- Улучшен интерфейс `BehavioralPattern` с поддержкой временных паттернов
- Добавлены методы `detectPortScanning()`, `detectNetworkScanning()`, `detectDDoSPattern()`
- Анализ временных паттернов (hourly, daily) для обнаружения аномалий
- Множественные факторы для расчета suspicious score (request rate, temporal, scanning, DDoS)

---

### Этап 4: Connection Rules и интеграция

#### 4.1 Создать Connection Rules для IDS/IPS ✅
**Файлы:**
- `src/services/connection/rules/idsipsRules.ts` ✅ **СОЗДАН**
- `src/services/connection/rules/index.ts` ✅ **ОБНОВЛЕН**

**Задачи:**
- [x] ✅ Определить допустимые типы соединений:
  - ✅ IDS/IPS может получать данные от любых компонентов (inline mode)
  - ✅ IDS/IPS может работать в tap mode (passive monitoring)
  - ⚠️ IDS/IPS может отправлять алерты в системы мониторинга (Prometheus, Grafana, etc.) - не реализовано
- [x] ✅ Определить порты и протоколы:
  - ✅ Порт для получения пакетов (если нужен)
  - ⚠️ Порт для управления (если нужен) - не реализовано
  - ✅ Протоколы: TCP, UDP, ICMP
- [x] ✅ Определить правила обновления конфигурации:
  - ✅ Как обновляется конфигурация при соединении с другими компонентами
  - ✅ Какие метаданные добавляются в соединения

**Критерии приемки:**
- ✅ Connection Rules созданы и зарегистрированы
- ✅ Правила соответствуют реальной работе IDS/IPS
- ✅ Правила интегрированы в систему

**Реализовано:**
- Создан `idsipsRules.ts` с правилами подключения
- Автоматическая настройка IDS/IPS при подключении компонентов
- Автоматическое создание сигнатур для мониторинга целевых компонентов
- Автоматическая настройка режимов (IDS/IPS) для баз данных
- Интеграция с Load Balancer, API Gateway, CDN

#### 4.2 Улучшить интеграцию с DataFlowEngine ✅
**Файл:** `src/core/DataFlowEngine.ts`

**Задачи:**
- [x] ✅ Улучшить извлечение информации о пакетах:
  - ✅ Более точное извлечение IP адресов из различных форматов сообщений
  - ✅ Более точное извлечение портов
  - ✅ Более точное извлечение протоколов
  - ✅ Извлечение TCP флагов (если доступны)
- [x] ✅ Добавить поддержку различных форматов сообщений:
  - ⚠️ Raw packets (binary) - частично (через payload)
  - ✅ JSON с метаданными пакета
  - ✅ Text форматы
- [x] ✅ Улучшить обработку блокировок:
  - ✅ Правильная обработка блокировок в IPS режиме
  - ✅ Правильная обработка алертов в IDS режиме
  - ✅ Правильное добавление метаданных в сообщения

**Критерии приемки:**
- ✅ Извлечение информации о пакетах работает для всех форматов
- ✅ Блокировки обрабатываются корректно
- ✅ Метаданные добавляются правильно

**Реализовано:**
- Улучшено извлечение IP адресов (sourceIP, sourceHost, targetHost, destinationHost)
- Добавлено извлечение TCP flags, sequence numbers, fragmentation info
- Добавлена передача дополнительной информации в `processPacket()` для протокольного анализа
- Улучшена обработка блокировок с добавлением метаданных (idsipsBlocked, idsipsAlertGenerated, etc.)

---

### Этап 5: Улучшение UI/UX

#### 5.1 Валидация сигнатур ✅
**Файл:** `src/components/config/security/IDSIPSConfigAdvanced.tsx` ✅

**Задачи:**
- [x] ✅ Валидация regex паттернов:
  - ✅ Проверка корректности regex при вводе
  - ✅ Отображение ошибок валидации
- [x] ✅ Валидация Snort rules:
  - ✅ Проверка синтаксиса Snort rules
  - ✅ Отображение ошибок парсинга
- [x] ✅ Предупреждения:
  - ✅ Предупреждения о некорректных правилах
  - ⚠️ Предупреждения о конфликтующих правилах - не реализовано
  - ⚠️ Предупреждения о правилах с низким приоритетом - не реализовано

**Критерии приемки:**
- ✅ Валидация работает в реальном времени
- ✅ Ошибки отображаются понятно
- ✅ Предупреждения помогают пользователю

**Реализовано:**
- Валидация regex паттернов с проверкой синтаксиса
- Валидация Snort rules с детальными сообщениями об ошибках
- Визуальная индикация валидации (красная рамка для ошибок, желтая для предупреждений)
- Отображение ошибок и предупреждений под полем Pattern
- Toast уведомления при обнаружении ошибок/предупреждений
- Автоматическая валидация всех сигнатур при загрузке компонента

#### 5.2 Улучшение отображения алертов ✅
**Файл:** `src/components/config/security/IDSIPSConfigAdvanced.tsx` ✅

**Задачи:**
- [x] ✅ Группировка алертов:
  - ✅ По типу (signature, anomaly, behavioral)
  - ✅ По severity
  - ✅ По source IP
  - ✅ По времени
- [x] ✅ Фильтрация и поиск:
  - ✅ Улучшен существующий поиск
  - ✅ Добавлены фильтры по времени (1h, 6h, 24h, 7d)
  - ✅ Добавлены фильтры по severity
- [x] ✅ Визуализация:
  - ✅ Графики по времени (линейный график за последние 24 часа)
  - ✅ Графики по типам атак (pie chart с типами атак)
  - ✅ Графики по типам обнаружения (stacked bar chart)
  - ✅ Графики по severity (bar chart)
  - ⚠️ Heatmaps по IP адресам - не реализовано (можно добавить позже)

**Критерии приемки:**
- ✅ Группировка работает
- ✅ Фильтрация работает быстро
- ✅ Визуализация помогает анализировать данные

**Реализовано:**
- Добавлена группировка алертов с выбором режима группировки (none, type, severity, sourceIP, time)
- Добавлены фильтры по severity и времени
- Реализованы 4 типа графиков:
  - Line chart для временных трендов (последние 24 часа)
  - Stacked bar chart для распределения по типам обнаружения
  - Pie chart для типов атак (SQL Injection, XSS, Brute Force, DDoS, etc.)
  - Bar chart для распределения по severity
- Все графики используют реальные данные из алертов
- Добавлены иконки и улучшенный UI для фильтров

#### 5.3 Улучшение управления сигнатурами ✅
**Файл:** `src/components/config/security/IDSIPSConfigAdvanced.tsx` ✅

**Задачи:**
- [x] ✅ Импорт/экспорт сигнатур:
  - ✅ Импорт из файла (Snort rules, JSON)
  - ✅ Экспорт в файл (JSON и Snort rules)
  - ✅ Импорт из URL (например, из репозитория правил)
- [x] ✅ Управление сигнатурами:
  - ✅ Массовое включение/выключение (bulk enable/disable)
  - ✅ Массовое удаление
  - ✅ Копирование сигнатур
  - ⚠️ Шаблоны сигнатур - не реализовано (можно добавить позже)
- [x] ✅ Предпросмотр сигнатур:
  - ✅ Предпросмотр того, что будет обнаружено
  - ✅ Тестирование сигнатур на примерах (SQL Injection, XSS)
  - ✅ Визуальная индикация результата (matched/not matched)

**Критерии приемки:**
- ✅ Импорт/экспорт работает
- ✅ Управление сигнатурами удобное
- ✅ Предпросмотр помогает

**Реализовано:**
- Добавлен экспорт сигнатур в форматах JSON и Snort rules
- Добавлен импорт сигнатур из файлов (JSON и Snort rules)
- Добавлен импорт сигнатур из URL (автоматическое определение формата)
- Реализовано массовое управление сигнатурами (выбор через checkbox, bulk enable/disable/delete)
- Добавлена функция копирования сигнатур
- Реализован диалог предпросмотра/тестирования сигнатур с возможностью тестирования на примерах
- Добавлены примеры тестовых payload (SQL Injection, XSS)
- Визуальная индикация результата тестирования (matched/not matched)

---

### Этап 6: Метрики и наблюдаемость

#### 6.1 Расширенные метрики
**Файлы:**
- `src/core/IDSIPSEmulationEngine.ts`
- `src/core/IDSIPSRoutingEngine.ts`

**Задачи:**
- [ ] Метрики по типам атак:
  - Количество обнаружений по типу (SQL injection, XSS, etc.)
  - Топ атак
  - Тренды по типам атак
- [ ] Метрики производительности:
  - Время обработки по типу обнаружения (signature, anomaly, behavioral)
  - Throughput по типу обнаружения
  - Latency по типу обнаружения
- [ ] Метрики качества:
  - False positive rate (если доступно)
  - True positive rate
  - Detection rate
- [ ] Временные метрики:
  - Тренды по времени
  - Сезонность
  - Пики активности

**Критерии приемки:**
- Все метрики собираются
- Метрики отображаются в UI
- Метрики помогают анализировать работу IDS/IPS

#### 6.2 Интеграция с системами мониторинга
**Файлы:**
- `src/core/IDSIPSEmulationEngine.ts`

**Задачи:**
- [ ] Экспорт метрик в Prometheus формат:
  - Метрики в формате Prometheus
  - Endpoint для Prometheus scrape
- [ ] Экспорт алертов:
  - Экспорт в системы мониторинга (если есть интеграция)
  - Экспорт в SIEM системы (если есть интеграция)

**Критерии приемки:**
- Метрики экспортируются в Prometheus формат
- Алерты можно экспортировать

---

### Этап 7: Тестирование и документация

#### 7.1 Тестирование
**Задачи:**
- [ ] Unit тесты для:
  - Парсера сигнатур
  - Логики обнаружения
  - CIDR matching
  - Протокольного анализа
- [ ] Integration тесты для:
  - Интеграции с DataFlowEngine
  - Интеграции с EmulationEngine
  - Connection Rules
- [ ] E2E тесты для:
  - Полного цикла обработки пакетов
  - UI взаимодействий

**Критерии приемки:**
- Все тесты проходят
- Покрытие кода > 80%

#### 7.2 Документация
**Файлы:**
- `docs/security/ids-ips.md` (новый файл)

**Задачи:**
- [ ] Документация по:
  - Архитектуре компонента
  - Конфигурации
  - Форматам сигнатур
  - Метрикам
  - Best practices
- [ ] Примеры конфигураций
- [ ] Примеры сигнатур

**Критерии приемки:**
- Документация полная и понятная
- Примеры работают

---

## Приоритизация задач

### Критичные (должны быть сделаны в первую очередь)
1. ✅ Этап 2: Исправление хардкода и скриптованности
2. ✅ Этап 4.1: Создание Connection Rules
3. ✅ Этап 3.2: Протокольный анализ (базовый)

### Важные (следующие по приоритету)
4. ✅ Этап 3.1: Поддержка форматов сигнатур (Snort rules) - **ВЫПОЛНЕНО**
5. ✅ Этап 3.3: Улучшенный поведенческий анализ
6. ✅ Этап 5.1: Валидация сигнатур - **ВЫПОЛНЕНО**

### Желательные (можно сделать позже)
7. ✅ Этап 5.2: Улучшение отображения алертов - **ВЫПОЛНЕНО**
8. ✅ Этап 5.3: Улучшение управления сигнатурами - **ВЫПОЛНЕНО**
9. ⚠️ Этап 6: Метрики и наблюдаемость - **НЕ РЕАЛИЗОВАНО** (можно добавить позже)
10. ⚠️ Этап 7: Тестирование и документация - **НЕ РЕАЛИЗОВАНО** (можно добавить позже)

---

## Принципы разработки

### 1. Избегать хардкода
- Все значения должны быть конфигурируемыми
- Использовать реальные данные из соединений
- Использовать конфигурацию компонента для генерации данных

### 2. Соответствие реальности
- Изучать реальные IDS/IPS системы перед реализацией
- Реализовывать фичи, которые есть в реальных системах
- Использовать реальные форматы (Snort rules, etc.)

### 3. Уникальность компонента
- Не копировать слепо другие компоненты
- Каждый компонент уникален по своей природе
- Использовать паттерны, но адаптировать под специфику IDS/IPS

### 4. Расширяемость
- Код должен быть расширяемым
- Легко добавлять новые типы обнаружения
- Легко добавлять новые форматы сигнатур

### 5. Производительность
- Обработка пакетов должна быть быстрой
- Использовать эффективные алгоритмы
- Кэшировать результаты где возможно

---

## Чеклист перед началом работы

Перед началом реализации каждого этапа:

- [ ] Изучены необходимые файлы архитектуры
- [ ] Изучены реальные IDS/IPS системы (для соответствующего этапа)
- [ ] Изучены похожие компоненты (если нужно)
- [ ] Понятна специфика IDS/IPS для данного этапа
- [ ] Составлен детальный план для конкретных задач этапа

---

## Заметки для разработчика

### Важные моменты

1. **IDS vs IPS**: 
   - IDS (Intrusion Detection System) - только обнаружение, не блокирует
   - IPS (Intrusion Prevention System) - обнаружение + блокировка
   - Режим должен влиять на поведение компонента

2. **Режимы работы**:
   - Inline mode - IDS/IPS находится на пути трафика, может блокировать
   - Tap mode - IDS/IPS получает копию трафика, только обнаружение
   - Нужно поддерживать оба режима

3. **Производительность**:
   - IDS/IPS должен обрабатывать много пакетов в секунду
   - Нужно оптимизировать проверку сигнатур
   - Использовать эффективные структуры данных

4. **False Positives**:
   - Реальные IDS/IPS системы имеют проблему false positives
   - Нужно учитывать это в симуляции
   - Можно добавить настройку уровня false positives

### Полезные ресурсы

- Snort Documentation: https://www.snort.org/documents
- Suricata Documentation: https://suricata.readthedocs.io/
- NIST SP 800-94: Guide to Intrusion Detection and Prevention Systems
- OWASP ModSecurity Core Rule Set: https://coreruleset.org/

---

## История изменений

- **2026-01-26**: Создан план разработки на основе анализа текущей реализации
- **2026-01-27**: Реализована поддержка Snort rules (Этап 3.1) и валидация сигнатур (Этап 5.1)
  - Создан парсер Snort rules (`src/utils/idsips/signatureParser.ts`)
  - Интегрирован парсер в `IDSIPSRoutingEngine` с кэшированием
  - Добавлена валидация сигнатур в UI с визуальной индикацией ошибок и предупреждений
- **2026-01-27**: Реализовано управление сигнатурами (Этап 5.3)
  - Добавлен импорт/экспорт сигнатур (JSON и Snort rules)
  - Добавлен импорт из URL
  - Реализовано массовое управление сигнатурами (bulk enable/disable/delete)
  - Добавлена функция копирования сигнатур
  - Реализован диалог предпросмотра/тестирования сигнатур с примерами
