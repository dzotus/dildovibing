import{u as we,a as ke,j as e,e as Re,r as f,l as D,S as M,C as h,h as u,i as m,m as x,T as Se,b as Pe,c as b,ab as Te,F as Ae,A as De,d as Ie,f as y,k as C,P as ee,O as Be,I as g,B as j,x as w,o as se,L as d,q as k,s as R,t as S,v as P,w as l,U as Le,aa as z}from"./index-CK7lW0SB.js";import{u as We}from"./use-toast-CfMGnxqm.js";import{R as qe}from"./refresh-ccw-DMpGPr4r.js";import{S as Ee}from"./shield-Dv5bpRoA.js";import{G as Me}from"./globe-B_I8tWIP.js";import{C as Oe}from"./circle-check-big-ZHrlop6r.js";function Je({componentId:I}){const{nodes:te,updateNode:le}=we(),{getComponentMetrics:ie}=ke(),{toast:B}=We(),T=te.find(s=>s.id===I);if(!T)return e.jsx("div",{className:"p-4 text-muted-foreground",children:"Component not found"});const n=T.data.config||{},ne=n.mode||"detection",_=n.enableOWASP??!0,ae=n.owaspRuleset||"3.3",U=n.enableRateLimiting??!0,ce=n.rateLimitPerMinute||100,Q=n.enableGeoBlocking??!1,L=n.blockedCountries||[],$=n.enableIPWhitelist??!1,W=n.whitelistedIPs||[],H=n.enableDDoSProtection??!0,re=n.ddosThreshold||1e3,o=n.rules||[{id:"1",name:"Block SQL Injection",description:"Detect and block SQL injection attempts",enabled:!0,action:"block",priority:1,conditions:[{type:"body",operator:"contains",value:"'; DROP TABLE"}]},{id:"2",name:"Block XSS",description:"Detect and block cross-site scripting",enabled:!0,action:"block",priority:2,conditions:[{type:"body",operator:"contains",value:"<script>"}]}],v=ie(I),p=Re.getWAFEmulationEngine(I),[q,K]=f.useState({requestsBlocked:0,requestsAllowed:0,threatsDetected:0,activeRules:o.filter(s=>s.enabled).length}),[X,J]=f.useState([]);f.useEffect(()=>{const s=setInterval(()=>{if(p){const t=p.getStats(),c=p.getThreats(100);K({requestsBlocked:t.blockedRequests,requestsAllowed:t.allowedRequests,threatsDetected:t.threatsDetected,activeRules:t.activeRules});const i=c.map(r=>({id:r.id,type:r.type,sourceIP:r.sourceIP,target:r.target,timestamp:new Date(r.timestamp).toISOString(),severity:r.severity,blocked:r.blocked,ruleId:r.ruleId,ruleName:r.ruleName,details:r.details}));J(i)}else K({requestsBlocked:n.requestsBlocked||0,requestsAllowed:n.requestsAllowed||0,threatsDetected:n.threatsDetected||0,activeRules:o.filter(t=>t.enabled).length}),J(n.threats||[])},1e3);return()=>clearInterval(s)},[p,n,o]);const de=q.requestsBlocked,oe=q.requestsAllowed,he=q.threatsDetected,O=X.length>0?X:n.threats||[],[Fe,Ve]=f.useState(null),[Ge,xe]=f.useState(!1),[E,ue]=f.useState(""),[F,me]=f.useState("all"),[ze,_e]=f.useState(null),a=s=>{const t={...n,...s};if(le(I,{data:{...T.data,config:t}}),p){const c={...T,data:{...T.data,config:t}};p.initializeConfig(c)}},je=()=>{const s={id:`rule-${Date.now()}`,name:"New Rule",description:"",enabled:!0,action:"block",priority:o.length+1,conditions:[]};a({rules:[...o,s]}),xe(!1)},ge=s=>{a({rules:o.filter(t=>t.id!==s)})},A=(s,t,c)=>{const i=o.map(r=>r.id===s?{...r,[t]:c}:r);a({rules:i})},ve=s=>{L.includes(s)||a({blockedCountries:[...L,s]})},pe=s=>{a({blockedCountries:L.filter(t=>t!==s)})},fe=s=>{W.includes(s)||a({whitelistedIPs:[...W,s]})},Ne=s=>{a({whitelistedIPs:W.filter(t=>t!==s)}),B({title:"IP removed",description:`IP ${s} removed from whitelist`})},be=s=>{const t={type:"body",operator:"contains",value:""},c=o.map(i=>i.id===s?{...i,conditions:[...i.conditions||[],t]}:i);a({rules:c}),B({title:"Condition added",description:"New condition added to rule"})},ye=(s,t)=>{const c=o.map(i=>i.id===s?{...i,conditions:(i.conditions||[]).filter((r,N)=>N!==t)}:i);a({rules:c}),B({title:"Condition removed",description:"Condition removed from rule"})},V=(s,t,c,i)=>{const r=o.map(N=>{if(N.id===s&&N.conditions){const G=[...N.conditions];return G[t]={...G[t],[c]:i},{...N,conditions:G}}return N});a({rules:r})},Ce=()=>{p&&(p.resetMetrics(),B({title:"Metrics reset",description:"WAF metrics have been reset"}))},Y=o.filter(s=>s.name.toLowerCase().includes(E.toLowerCase())||s.description.toLowerCase().includes(E.toLowerCase())),Z=O.filter(s=>!(F==="blocked"&&!s.blocked||F==="not-blocked"&&s.blocked));return e.jsx("div",{className:"h-full overflow-y-auto bg-background",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase text-muted-foreground tracking-wide",children:"Web Application Firewall"}),e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"WAF Configuration"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Protect applications from web exploits and attacks"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(D,{variant:"outline",size:"sm",onClick:Ce,children:[e.jsx(qe,{className:"h-4 w-4 mr-2"}),"Refresh"]})})]}),e.jsx(M,{}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs(h,{children:[e.jsx(u,{className:"pb-3",children:e.jsx(m,{className:"text-sm font-medium",children:"Requests Blocked"})}),e.jsxs(x,{children:[e.jsx("span",{className:"text-2xl font-bold text-red-500",children:de.toLocaleString()}),v&&v.customMetrics&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Block Rate: ",((v.customMetrics.waf_block_rate||0)*100).toFixed(2),"%"]})]})]}),e.jsxs(h,{children:[e.jsx(u,{className:"pb-3",children:e.jsx(m,{className:"text-sm font-medium",children:"Requests Allowed"})}),e.jsxs(x,{children:[e.jsx("span",{className:"text-2xl font-bold text-green-500",children:oe.toLocaleString()}),v&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Throughput: ",Math.round(v.throughput||0)," req/s"]})]})]}),e.jsxs(h,{children:[e.jsx(u,{className:"pb-3",children:e.jsx(m,{className:"text-sm font-medium",children:"Threats Detected"})}),e.jsxs(x,{children:[e.jsx("span",{className:"text-2xl font-bold text-orange-500",children:he.toLocaleString()}),v&&v.customMetrics&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Detection Rate: ",((v.customMetrics.waf_threat_detection_rate||0)*100).toFixed(2),"%"]})]})]}),e.jsxs(h,{children:[e.jsx(u,{className:"pb-3",children:e.jsx(m,{className:"text-sm font-medium",children:"Active Rules"})}),e.jsxs(x,{children:[e.jsx("span",{className:"text-2xl font-bold",children:q.activeRules}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Total: ",o.length," rules"]})]})]})]}),e.jsxs(Se,{defaultValue:"rules",className:"space-y-4",children:[e.jsxs(Pe,{children:[e.jsxs(b,{value:"rules",children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Rules (",o.length,")"]}),e.jsxs(b,{value:"threats",children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),"Threats (",O.length,")"]}),e.jsxs(b,{value:"owasp",children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),"OWASP Rules"]}),e.jsxs(b,{value:"rate-limiting",children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Rate Limiting"]}),e.jsxs(b,{value:"geo-blocking",children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Geo-Blocking"]}),e.jsxs(b,{value:"settings",children:[e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Settings"]})]}),e.jsx(y,{value:"rules",className:"space-y-4",children:e.jsxs(h,{children:[e.jsx(u,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Custom Rules"}),e.jsx(C,{children:"Configure custom WAF rules"})]}),e.jsxs(D,{onClick:je,size:"sm",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Create Rule"]})]})}),e.jsxs(x,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(Be,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(g,{placeholder:"Search rules...",value:E,onChange:s=>ue(s.target.value),className:"pl-8"})]})}),e.jsxs("div",{className:"space-y-4",children:[Y.map(s=>e.jsxs(h,{className:"border-l-4 border-l-blue-500",children:[e.jsx(u,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(m,{className:"text-base",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(j,{variant:s.enabled?"default":"outline",children:s.enabled?"Enabled":"Disabled"}),e.jsx(j,{variant:"outline",children:s.action}),e.jsxs(j,{variant:"outline",children:["Priority: ",s.priority]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{checked:s.enabled,onCheckedChange:t=>A(s.id,"enabled",t)}),e.jsx(D,{variant:"ghost",size:"icon",onClick:()=>ge(s.id),children:e.jsx(se,{className:"h-4 w-4"})})]})]})}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Rule Name"}),e.jsx(g,{value:s.name,onChange:t=>A(s.id,"name",t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Action"}),e.jsxs(k,{value:s.action,onValueChange:t=>A(s.id,"action",t),children:[e.jsx(R,{children:e.jsx(S,{})}),e.jsxs(P,{children:[e.jsx(l,{value:"block",children:"Block"}),e.jsx(l,{value:"allow",children:"Allow"}),e.jsx(l,{value:"log",children:"Log"}),e.jsx(l,{value:"challenge",children:"Challenge"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Priority"}),e.jsx(g,{type:"number",value:s.priority,onChange:t=>A(s.id,"priority",Number(t.target.value)),min:1})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Description"}),e.jsx(g,{value:s.description,onChange:t=>A(s.id,"description",t.target.value),placeholder:"Rule description"})]})]}),e.jsx(M,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{children:"Conditions"}),e.jsxs(D,{variant:"outline",size:"sm",onClick:()=>be(s.id),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Add Condition"]})]}),s.conditions&&s.conditions.length>0?e.jsx("div",{className:"space-y-2",children:s.conditions.map((t,c)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[e.jsxs(k,{value:t.type,onValueChange:i=>V(s.id,c,"type",i),children:[e.jsx(R,{className:"w-32",children:e.jsx(S,{})}),e.jsxs(P,{children:[e.jsx(l,{value:"ip",children:"IP"}),e.jsx(l,{value:"uri",children:"URI"}),e.jsx(l,{value:"header",children:"Header"}),e.jsx(l,{value:"body",children:"Body"}),e.jsx(l,{value:"method",children:"Method"}),e.jsx(l,{value:"country",children:"Country"}),e.jsx(l,{value:"user-agent",children:"User-Agent"})]})]}),e.jsxs(k,{value:t.operator,onValueChange:i=>V(s.id,c,"operator",i),children:[e.jsx(R,{className:"w-40",children:e.jsx(S,{})}),e.jsxs(P,{children:[e.jsx(l,{value:"equals",children:"Equals"}),e.jsx(l,{value:"contains",children:"Contains"}),e.jsx(l,{value:"startsWith",children:"Starts With"}),e.jsx(l,{value:"endsWith",children:"Ends With"}),e.jsx(l,{value:"regex",children:"Regex"}),e.jsx(l,{value:"in",children:"In"}),e.jsx(l,{value:"not-in",children:"Not In"})]})]}),e.jsx(g,{value:t.value,onChange:i=>V(s.id,c,"value",i.target.value),placeholder:"Value",className:"flex-1"}),e.jsx(D,{variant:"ghost",size:"icon",onClick:()=>ye(s.id,c),children:e.jsx(se,{className:"h-4 w-4"})})]},c))}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No conditions. Add at least one condition for the rule to work."})]})]})]},s.id)),Y.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:E?"No rules found matching your search":"No rules configured"})]})]})]})}),e.jsx(y,{value:"threats",className:"space-y-4",children:e.jsxs(h,{children:[e.jsx(u,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Detected Threats"}),e.jsx(C,{children:"Recent security threats and attacks"})]}),e.jsxs(k,{value:F,onValueChange:s=>me(s),children:[e.jsxs(R,{className:"w-40",children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),e.jsx(S,{})]}),e.jsxs(P,{children:[e.jsx(l,{value:"all",children:"All Threats"}),e.jsx(l,{value:"blocked",children:"Blocked"}),e.jsx(l,{value:"not-blocked",children:"Not Blocked"})]})]})]})}),e.jsx(x,{children:Z.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:O.length===0?"No threats detected":"No threats match the filter"}):e.jsx("div",{className:"space-y-2",children:Z.map(s=>e.jsx(h,{className:`border-l-4 ${s.severity==="critical"?"border-l-red-500":s.severity==="high"?"border-l-orange-500":s.severity==="medium"?"border-l-yellow-500":"border-l-blue-500"}`,children:e.jsx(x,{className:"pt-4",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(j,{variant:s.severity==="critical"?"destructive":s.severity==="high"?"default":"outline",children:s.severity}),e.jsx(j,{variant:"outline",children:s.type}),s.blocked?e.jsxs(j,{variant:"default",className:"bg-green-500",children:[e.jsx(Oe,{className:"h-3 w-3 mr-1"}),"Blocked"]}):e.jsxs(j,{variant:"outline",children:[e.jsx(z,{className:"h-3 w-3 mr-1"}),"Not Blocked"]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsxs("p",{children:["Source IP: ",s.sourceIP]}),e.jsxs("p",{children:["Target: ",s.target]}),e.jsxs("p",{children:["Time: ",new Date(s.timestamp).toLocaleString()]}),s.ruleName&&e.jsx("p",{className:"mt-1",children:e.jsxs(j,{variant:"outline",className:"mr-2",children:["Rule: ",s.ruleName]})}),s.details&&Object.keys(s.details).length>0&&e.jsxs("details",{className:"mt-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs",children:"Details"}),e.jsx("pre",{className:"mt-1 text-xs bg-muted p-2 rounded overflow-auto",children:JSON.stringify(s.details,null,2)})]})]})]})})})},s.id))})})]})}),e.jsx(y,{value:"owasp",className:"space-y-4",children:e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(m,{children:"OWASP ModSecurity Rules"}),e.jsx(C,{children:"Core Rule Set configuration"})]}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{children:"Enable OWASP Rules"}),e.jsx(w,{checked:_,onCheckedChange:s=>a({enableOWASP:s})})]}),_&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"OWASP Rule Set Version"}),e.jsxs(k,{value:ae,onValueChange:s=>a({owaspRuleset:s}),children:[e.jsx(R,{children:e.jsx(S,{})}),e.jsxs(P,{children:[e.jsx(l,{value:"3.3",children:"3.3 (Latest)"}),e.jsx(l,{value:"3.2",children:"3.2"}),e.jsx(l,{value:"3.1",children:"3.1"})]})]})]})]})]})}),e.jsx(y,{value:"rate-limiting",className:"space-y-4",children:e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(m,{children:"Rate Limiting"}),e.jsx(C,{children:"Configure request rate limits"})]}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{children:"Enable Rate Limiting"}),e.jsx(w,{checked:U,onCheckedChange:s=>a({enableRateLimiting:s})})]}),U&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Rate Limit (requests per minute)"}),e.jsx(g,{type:"number",value:ce,onChange:s=>a({rateLimitPerMinute:Number(s.target.value)}),min:1,max:1e4})]})]})]})}),e.jsx(y,{value:"geo-blocking",className:"space-y-4",children:e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(m,{children:"Geo-Blocking"}),e.jsx(C,{children:"Block requests from specific countries"})]}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{children:"Enable Geo-Blocking"}),e.jsx(w,{checked:Q,onCheckedChange:s=>a({enableGeoBlocking:s})})]}),Q&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Blocked Countries (ISO codes)"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:L.map(s=>e.jsxs(j,{variant:"outline",className:"gap-1",children:[s,e.jsx("button",{onClick:()=>pe(s),className:"ml-1 hover:text-destructive",children:e.jsx(z,{className:"h-3 w-3"})})]},s))}),e.jsx(g,{placeholder:"Enter ISO country code (e.g., CN, RU)",onKeyDown:s=>{if(s.key==="Enter"){const t=s.currentTarget.value.trim().toUpperCase();t&&(ve(t),s.currentTarget.value="")}}})]})]})]})}),e.jsx(y,{value:"settings",className:"space-y-4",children:e.jsxs(h,{children:[e.jsxs(u,{children:[e.jsx(m,{children:"WAF Settings"}),e.jsx(C,{children:"General WAF configuration"})]}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Operation Mode"}),e.jsxs(k,{value:ne,onValueChange:s=>a({mode:s}),children:[e.jsx(R,{children:e.jsx(S,{})}),e.jsxs(P,{children:[e.jsx(l,{value:"prevention",children:"Prevention (Block threats)"}),e.jsx(l,{value:"detection",children:"Detection (Log only)"}),e.jsx(l,{value:"logging",children:"Logging Only"})]})]})]}),e.jsx(M,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{children:"Enable DDoS Protection"}),e.jsx(w,{checked:H,onCheckedChange:s=>a({enableDDoSProtection:s})})]}),H&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"DDoS Threshold (requests per second)"}),e.jsx(g,{type:"number",value:re,onChange:s=>a({ddosThreshold:Number(s.target.value)}),min:100,max:1e5})]}),e.jsx(M,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{children:"Enable IP Whitelist"}),e.jsx(w,{checked:$,onCheckedChange:s=>a({enableIPWhitelist:s})})]}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Whitelisted IPs"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:W.map(s=>e.jsxs(j,{variant:"outline",className:"gap-1",children:[s,e.jsx("button",{onClick:()=>Ne(s),className:"ml-1 hover:text-destructive",children:e.jsx(z,{className:"h-3 w-3"})})]},s))}),e.jsx(g,{placeholder:"Enter IP or CIDR (e.g., 192.168.1.0/24)",onKeyDown:s=>{if(s.key==="Enter"){const t=s.currentTarget.value.trim();t&&(fe(t),s.currentTarget.value="")}}})]})]})]})})]})]})})}export{Je as WAFConfigAdvanced};
