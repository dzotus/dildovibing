const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/KafkaConfigAdvanced-BMvFA8TZ.js","assets/progress-C5wuyoJE.js","assets/textarea-DVH1WsgN.js","assets/tooltip-6zq9E2rE.js","assets/database-nbyY3UWd.js","assets/users-D06x9Mc7.js","assets/shield-itON_tzT.js","assets/refresh-ccw-BnIOG7At.js","assets/RabbitMQConfigAdvanced-CzLt9wOL.js","assets/usePortValidation-Bz2AgUs2.js","assets/requiredFields-BLgUUVkB.js","assets/toast-DwHsfKQT.js","assets/message-square-CDCjLJpa.js","assets/arrow-right-left-Ddx0-rMZ.js","assets/key-B1vLWN55.js","assets/PostgreSQLConfigAdvanced-Di9J_5uN.js","assets/file-code-_pv0dJLZ.js","assets/table-BntmYIa5.js","assets/MongoDBConfigAdvanced-BUUcBd6v.js","assets/RedisConfigAdvanced-Rl01YOxk.js","assets/terminal-DnntkQDn.js","assets/ElasticsearchConfigAdvanced-BGlvMFbk.js","assets/code-DcbAXHsa.js","assets/CassandraConfigAdvanced-CL05MpF4.js","assets/ClickHouseConfigAdvanced-Doj3lzSE.js","assets/chart-column-BhHEhYjG.js","assets/SnowflakeConfigAdvanced-CbXEYRqH.js","assets/S3DataLakeConfigAdvanced-HfrTx3cx.js","assets/folder-ZCkCMtwh.js","assets/NginxConfigAdvanced-5DQhc154.js","assets/use-toast-cj88Vypl.js","assets/globe-ByOVpM83.js","assets/server-DndTJqmb.js","assets/RestApiConfigAdvanced-DL3w07M6.js","assets/index-D3ys2xdk.js","assets/trending-up-B8Ek1Up9.js","assets/clock-BaMwO330.js","assets/GRPCConfigAdvanced-D6UVBL1o.js","assets/circle-check-big-BnZiflL6.js","assets/WebSocketConfigAdvanced-C_qtt4JC.js","assets/send-UOHMC58H.js","assets/bell-CDo2XLfr.js","assets/pen-D9cTNiXX.js","assets/GraphQLConfigAdvanced-F6o6akgq.js","assets/pencil-CxtSDS7V.js","assets/SOAPConfigAdvanced-BeXxI6yx.js","assets/WebhookConfigAdvanced-BXfYor-6.js","assets/webhook-bqW-OI2y.js","assets/LineChart-q6jnunXf.js","assets/AreaChart-CgUi8nLn.js","assets/loader-circle-CP4AKAjX.js","assets/DockerK8sConfigAdvanced-BtvbjrvM.js","assets/alert-C5pwZTrm.js","assets/hard-drive-B5Mdq_UX.js","assets/InfrastructureConfig-DUWjzeNm.js","assets/KubernetesConfigAdvanced-BbnGVIiH.js","assets/HAProxyConfigAdvanced-B7NCHYQR.js","assets/TraefikConfigAdvanced-_4k6PvUH.js","assets/route-CWUzr1yD.js","assets/EnvoyConfigAdvanced-QeykLm-d.js","assets/ActiveMQConfigAdvanced-PUfLyZdz.js","assets/AWSSQSConfigAdvanced-DnL_F29D.js","assets/cloud-Cpw8e711.js","assets/AzureServiceBusConfigAdvanced-Bl9FSKIH.js","assets/GCPPubSubConfigAdvanced-wU58Y-kd.js","assets/KongConfigAdvanced-DNenV9Lf.js","assets/ApigeeConfigAdvanced-DoXrxHXg.js","assets/package-CFpf3lm_.js","assets/eye-off-CjApqv_k.js","assets/MuleSoftConfigAdvanced-BkEbNCa-.js","assets/git-branch-FLyvgkhv.js","assets/GraphQLGatewayConfigAdvanced-BgX0NhUn.js","assets/BFFServiceConfigAdvanced-B4jsDCpg.js","assets/WebhookRelayConfigAdvanced-Sux-zuzw.js","assets/PrometheusConfigAdvanced-BBzyiCQZ.js","assets/GrafanaConfigAdvanced-D6Q6OHH2.js","assets/BarChart-D8gEM77m.js","assets/LokiConfigAdvanced-ChNLK29K.js","assets/JaegerConfigAdvanced-CvHGJzbI.js","assets/OpenTelemetryCollectorConfigAdvanced-BtGpipeO.js","assets/PagerDutyConfigAdvanced-BqUbjtvy.js","assets/KeycloakConfigAdvanced-xQs6iIpN.js","assets/lock-tcXU_90Z.js","assets/mail-CxhNCYtY.js","assets/WAFConfigAdvanced-Cfs4kHJj.js","assets/SecretsVaultConfigAdvanced-CRZJvJDF.js","assets/IDSIPSConfigAdvanced-ComGaEyd.js","assets/FirewallConfigAdvanced-DNi-iZnC.js","assets/JenkinsConfigAdvanced-BuQgKsa6.js","assets/GitLabCIConfigAdvanced-DTq6IjOL.js","assets/calendar-Cvgj2gdJ.js","assets/ArgoCDConfigAdvanced-Dfwr3whk.js","assets/folder-git-2-CRsXqk20.js","assets/HarborConfigAdvanced-C4dtI5FQ.js","assets/TerraformConfigAdvanced-DwWokWjC.js","assets/AnsibleConfigAdvanced-CsvTAwDk.js","assets/IstioConfigAdvanced-C1Zfx6vV.js","assets/ServiceMeshConfigAdvanced-Bxootrd7.js","assets/APIGatewayConfigAdvanced-CM-erg39.js","assets/VPNConfigAdvanced-DSi9JLiU.js","assets/CDNConfigAdvanced-h978UR_c.js","assets/SparkConfigAdvanced-Dlf5ZkWM.js","assets/TensorFlowServingConfigAdvanced-CfSgDJah.js","assets/PyTorchServeConfigAdvanced-fQk2kAA_.js","assets/FeatureStoreConfigAdvanced-D-Oz3rXn.js","assets/CRMConfigAdvanced-Cxb9tHMg.js","assets/dollar-sign-DTMfwhk9.js","assets/building-CpvJycTh.js","assets/ERPConfigAdvanced-CR7plfTK.js","assets/credit-card-DrBdvhlF.js","assets/PaymentGatewayConfigAdvanced-DJRTT9ek.js"])))=>i.map(i=>d[i]);
function ER(c,e){for(var t=0;t<e.length;t++){const s=e[t];if(typeof s!="string"&&!Array.isArray(s)){for(const n in s)if(n!=="default"&&!(n in c)){const i=Object.getOwnPropertyDescriptor(s,n);i&&Object.defineProperty(c,n,i.get?i:{enumerable:!0,get:()=>s[n]})}}}return Object.freeze(Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();var b3=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Bf(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var Gh={exports:{}},Er={};var j0;function kR(){if(j0)return Er;j0=1;var c=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function t(s,n,i){var a=null;if(i!==void 0&&(a=""+i),n.key!==void 0&&(a=""+n.key),"key"in n){i={};for(var o in n)o!=="key"&&(i[o]=n[o])}else i=n;return n=i.ref,{$$typeof:c,type:s,key:a,ref:n!==void 0?n:null,props:i}}return Er.Fragment=e,Er.jsx=t,Er.jsxs=t,Er}var O0;function AR(){return O0||(O0=1,Gh.exports=kR()),Gh.exports}var y=AR(),Wh={exports:{}},Oe={};var q0;function DR(){if(q0)return Oe;q0=1;var c=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),t=Symbol.for("react.fragment"),s=Symbol.for("react.strict_mode"),n=Symbol.for("react.profiler"),i=Symbol.for("react.consumer"),a=Symbol.for("react.context"),o=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),h=Symbol.for("react.lazy"),p=Symbol.for("react.activity"),g=Symbol.iterator;function v(N){return N===null||typeof N!="object"?null:(N=g&&N[g]||N["@@iterator"],typeof N=="function"?N:null)}var b={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},M=Object.assign,x={};function S(N,J,K){this.props=N,this.context=J,this.refs=x,this.updater=K||b}S.prototype.isReactComponent={},S.prototype.setState=function(N,J){if(typeof N!="object"&&typeof N!="function"&&N!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,N,J,"setState")},S.prototype.forceUpdate=function(N){this.updater.enqueueForceUpdate(this,N,"forceUpdate")};function T(){}T.prototype=S.prototype;function E(N,J,K){this.props=N,this.context=J,this.refs=x,this.updater=K||b}var A=E.prototype=new T;A.constructor=E,M(A,S.prototype),A.isPureReactComponent=!0;var k=Array.isArray;function D(){}var L={H:null,A:null,T:null,S:null},I=Object.prototype.hasOwnProperty;function U(N,J,K){var ie=K.ref;return{$$typeof:c,type:N,key:J,ref:ie!==void 0?ie:null,props:K}}function Q(N,J){return U(N.type,J,N.props)}function se(N){return typeof N=="object"&&N!==null&&N.$$typeof===c}function F(N){var J={"=":"=0",":":"=2"};return"$"+N.replace(/[=:]/g,function(K){return J[K]})}var Y=/\/+/g;function ae(N,J){return typeof N=="object"&&N!==null&&N.key!=null?F(""+N.key):J.toString(36)}function de(N){switch(N.status){case"fulfilled":return N.value;case"rejected":throw N.reason;default:switch(typeof N.status=="string"?N.then(D,D):(N.status="pending",N.then(function(J){N.status==="pending"&&(N.status="fulfilled",N.value=J)},function(J){N.status==="pending"&&(N.status="rejected",N.reason=J)})),N.status){case"fulfilled":return N.value;case"rejected":throw N.reason}}throw N}function z(N,J,K,ie,Z){var re=typeof N;(re==="undefined"||re==="boolean")&&(N=null);var V=!1;if(N===null)V=!0;else switch(re){case"bigint":case"string":case"number":V=!0;break;case"object":switch(N.$$typeof){case c:case e:V=!0;break;case h:return V=N._init,z(V(N._payload),J,K,ie,Z)}}if(V)return Z=Z(N),V=ie===""?"."+ae(N,0):ie,k(Z)?(K="",V!=null&&(K=V.replace(Y,"$&/")+"/"),z(Z,J,K,"",function(fe){return fe})):Z!=null&&(se(Z)&&(Z=Q(Z,K+(Z.key==null||N&&N.key===Z.key?"":(""+Z.key).replace(Y,"$&/")+"/")+V)),J.push(Z)),1;V=0;var j=ie===""?".":ie+":";if(k(N))for(var ue=0;ue<N.length;ue++)ie=N[ue],re=j+ae(ie,ue),V+=z(ie,J,K,re,Z);else if(ue=v(N),typeof ue=="function")for(N=ue.call(N),ue=0;!(ie=N.next()).done;)ie=ie.value,re=j+ae(ie,ue++),V+=z(ie,J,K,re,Z);else if(re==="object"){if(typeof N.then=="function")return z(de(N),J,K,ie,Z);throw J=String(N),Error("Objects are not valid as a React child (found: "+(J==="[object Object]"?"object with keys {"+Object.keys(N).join(", ")+"}":J)+"). If you meant to render a collection of children, use an array instead.")}return V}function $(N,J,K){if(N==null)return N;var ie=[],Z=0;return z(N,ie,"","",function(re){return J.call(K,re,Z++)}),ie}function q(N){if(N._status===-1){var J=N._result;J=J(),J.then(function(K){(N._status===0||N._status===-1)&&(N._status=1,N._result=K)},function(K){(N._status===0||N._status===-1)&&(N._status=2,N._result=K)}),N._status===-1&&(N._status=0,N._result=J)}if(N._status===1)return N._result.default;throw N._result}var ee=typeof reportError=="function"?reportError:function(N){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var J=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof N=="object"&&N!==null&&typeof N.message=="string"?String(N.message):String(N),error:N});if(!window.dispatchEvent(J))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",N);return}console.error(N)},me={map:$,forEach:function(N,J,K){$(N,function(){J.apply(this,arguments)},K)},count:function(N){var J=0;return $(N,function(){J++}),J},toArray:function(N){return $(N,function(J){return J})||[]},only:function(N){if(!se(N))throw Error("React.Children.only expected to receive a single React element child.");return N}};return Oe.Activity=p,Oe.Children=me,Oe.Component=S,Oe.Fragment=t,Oe.Profiler=n,Oe.PureComponent=E,Oe.StrictMode=s,Oe.Suspense=l,Oe.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=L,Oe.__COMPILER_RUNTIME={__proto__:null,c:function(N){return L.H.useMemoCache(N)}},Oe.cache=function(N){return function(){return N.apply(null,arguments)}},Oe.cacheSignal=function(){return null},Oe.cloneElement=function(N,J,K){if(N==null)throw Error("The argument must be a React element, but you passed "+N+".");var ie=M({},N.props),Z=N.key;if(J!=null)for(re in J.key!==void 0&&(Z=""+J.key),J)!I.call(J,re)||re==="key"||re==="__self"||re==="__source"||re==="ref"&&J.ref===void 0||(ie[re]=J[re]);var re=arguments.length-2;if(re===1)ie.children=K;else if(1<re){for(var V=Array(re),j=0;j<re;j++)V[j]=arguments[j+2];ie.children=V}return U(N.type,Z,ie)},Oe.createContext=function(N){return N={$$typeof:a,_currentValue:N,_currentValue2:N,_threadCount:0,Provider:null,Consumer:null},N.Provider=N,N.Consumer={$$typeof:i,_context:N},N},Oe.createElement=function(N,J,K){var ie,Z={},re=null;if(J!=null)for(ie in J.key!==void 0&&(re=""+J.key),J)I.call(J,ie)&&ie!=="key"&&ie!=="__self"&&ie!=="__source"&&(Z[ie]=J[ie]);var V=arguments.length-2;if(V===1)Z.children=K;else if(1<V){for(var j=Array(V),ue=0;ue<V;ue++)j[ue]=arguments[ue+2];Z.children=j}if(N&&N.defaultProps)for(ie in V=N.defaultProps,V)Z[ie]===void 0&&(Z[ie]=V[ie]);return U(N,re,Z)},Oe.createRef=function(){return{current:null}},Oe.forwardRef=function(N){return{$$typeof:o,render:N}},Oe.isValidElement=se,Oe.lazy=function(N){return{$$typeof:h,_payload:{_status:-1,_result:N},_init:q}},Oe.memo=function(N,J){return{$$typeof:d,type:N,compare:J===void 0?null:J}},Oe.startTransition=function(N){var J=L.T,K={};L.T=K;try{var ie=N(),Z=L.S;Z!==null&&Z(K,ie),typeof ie=="object"&&ie!==null&&typeof ie.then=="function"&&ie.then(D,ee)}catch(re){ee(re)}finally{J!==null&&K.types!==null&&(J.types=K.types),L.T=J}},Oe.unstable_useCacheRefresh=function(){return L.H.useCacheRefresh()},Oe.use=function(N){return L.H.use(N)},Oe.useActionState=function(N,J,K){return L.H.useActionState(N,J,K)},Oe.useCallback=function(N,J){return L.H.useCallback(N,J)},Oe.useContext=function(N){return L.H.useContext(N)},Oe.useDebugValue=function(){},Oe.useDeferredValue=function(N,J){return L.H.useDeferredValue(N,J)},Oe.useEffect=function(N,J){return L.H.useEffect(N,J)},Oe.useEffectEvent=function(N){return L.H.useEffectEvent(N)},Oe.useId=function(){return L.H.useId()},Oe.useImperativeHandle=function(N,J,K){return L.H.useImperativeHandle(N,J,K)},Oe.useInsertionEffect=function(N,J){return L.H.useInsertionEffect(N,J)},Oe.useLayoutEffect=function(N,J){return L.H.useLayoutEffect(N,J)},Oe.useMemo=function(N,J){return L.H.useMemo(N,J)},Oe.useOptimistic=function(N,J){return L.H.useOptimistic(N,J)},Oe.useReducer=function(N,J,K){return L.H.useReducer(N,J,K)},Oe.useRef=function(N){return L.H.useRef(N)},Oe.useState=function(N){return L.H.useState(N)},Oe.useSyncExternalStore=function(N,J,K){return L.H.useSyncExternalStore(N,J,K)},Oe.useTransition=function(){return L.H.useTransition()},Oe.version="19.2.0",Oe}var H0;function Uf(){return H0||(H0=1,Wh.exports=DR()),Wh.exports}var R=Uf();const Dt=Bf(R),Ff=ER({__proto__:null,default:Dt},[R]);var Kh={exports:{}},kr={},Yh={exports:{}},Xh={};var $0;function PR(){return $0||($0=1,(function(c){function e(z,$){var q=z.length;z.push($);e:for(;0<q;){var ee=q-1>>>1,me=z[ee];if(0<n(me,$))z[ee]=$,z[q]=me,q=ee;else break e}}function t(z){return z.length===0?null:z[0]}function s(z){if(z.length===0)return null;var $=z[0],q=z.pop();if(q!==$){z[0]=q;e:for(var ee=0,me=z.length,N=me>>>1;ee<N;){var J=2*(ee+1)-1,K=z[J],ie=J+1,Z=z[ie];if(0>n(K,q))ie<me&&0>n(Z,K)?(z[ee]=Z,z[ie]=q,ee=ie):(z[ee]=K,z[J]=q,ee=J);else if(ie<me&&0>n(Z,q))z[ee]=Z,z[ie]=q,ee=ie;else break e}}return $}function n(z,$){var q=z.sortIndex-$.sortIndex;return q!==0?q:z.id-$.id}if(c.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var i=performance;c.unstable_now=function(){return i.now()}}else{var a=Date,o=a.now();c.unstable_now=function(){return a.now()-o}}var l=[],d=[],h=1,p=null,g=3,v=!1,b=!1,M=!1,x=!1,S=typeof setTimeout=="function"?setTimeout:null,T=typeof clearTimeout=="function"?clearTimeout:null,E=typeof setImmediate<"u"?setImmediate:null;function A(z){for(var $=t(d);$!==null;){if($.callback===null)s(d);else if($.startTime<=z)s(d),$.sortIndex=$.expirationTime,e(l,$);else break;$=t(d)}}function k(z){if(M=!1,A(z),!b)if(t(l)!==null)b=!0,D||(D=!0,F());else{var $=t(d);$!==null&&de(k,$.startTime-z)}}var D=!1,L=-1,I=5,U=-1;function Q(){return x?!0:!(c.unstable_now()-U<I)}function se(){if(x=!1,D){var z=c.unstable_now();U=z;var $=!0;try{e:{b=!1,M&&(M=!1,T(L),L=-1),v=!0;var q=g;try{t:{for(A(z),p=t(l);p!==null&&!(p.expirationTime>z&&Q());){var ee=p.callback;if(typeof ee=="function"){p.callback=null,g=p.priorityLevel;var me=ee(p.expirationTime<=z);if(z=c.unstable_now(),typeof me=="function"){p.callback=me,A(z),$=!0;break t}p===t(l)&&s(l),A(z)}else s(l);p=t(l)}if(p!==null)$=!0;else{var N=t(d);N!==null&&de(k,N.startTime-z),$=!1}}break e}finally{p=null,g=q,v=!1}$=void 0}}finally{$?F():D=!1}}}var F;if(typeof E=="function")F=function(){E(se)};else if(typeof MessageChannel<"u"){var Y=new MessageChannel,ae=Y.port2;Y.port1.onmessage=se,F=function(){ae.postMessage(null)}}else F=function(){S(se,0)};function de(z,$){L=S(function(){z(c.unstable_now())},$)}c.unstable_IdlePriority=5,c.unstable_ImmediatePriority=1,c.unstable_LowPriority=4,c.unstable_NormalPriority=3,c.unstable_Profiling=null,c.unstable_UserBlockingPriority=2,c.unstable_cancelCallback=function(z){z.callback=null},c.unstable_forceFrameRate=function(z){0>z||125<z?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):I=0<z?Math.floor(1e3/z):5},c.unstable_getCurrentPriorityLevel=function(){return g},c.unstable_next=function(z){switch(g){case 1:case 2:case 3:var $=3;break;default:$=g}var q=g;g=$;try{return z()}finally{g=q}},c.unstable_requestPaint=function(){x=!0},c.unstable_runWithPriority=function(z,$){switch(z){case 1:case 2:case 3:case 4:case 5:break;default:z=3}var q=g;g=z;try{return $()}finally{g=q}},c.unstable_scheduleCallback=function(z,$,q){var ee=c.unstable_now();switch(typeof q=="object"&&q!==null?(q=q.delay,q=typeof q=="number"&&0<q?ee+q:ee):q=ee,z){case 1:var me=-1;break;case 2:me=250;break;case 5:me=1073741823;break;case 4:me=1e4;break;default:me=5e3}return me=q+me,z={id:h++,callback:$,priorityLevel:z,startTime:q,expirationTime:me,sortIndex:-1},q>ee?(z.sortIndex=q,e(d,z),t(l)===null&&z===t(d)&&(M?(T(L),L=-1):M=!0,de(k,q-ee))):(z.sortIndex=me,e(l,z),b||v||(b=!0,D||(D=!0,F()))),z},c.unstable_shouldYield=Q,c.unstable_wrapCallback=function(z){var $=g;return function(){var q=g;g=$;try{return z.apply(this,arguments)}finally{g=q}}}})(Xh)),Xh}var B0;function LR(){return B0||(B0=1,Yh.exports=PR()),Yh.exports}var Jh={exports:{}},os={};var U0;function _R(){if(U0)return os;U0=1;var c=Uf();function e(l){var d="https://react.dev/errors/"+l;if(1<arguments.length){d+="?args[]="+encodeURIComponent(arguments[1]);for(var h=2;h<arguments.length;h++)d+="&args[]="+encodeURIComponent(arguments[h])}return"Minified React error #"+l+"; visit "+d+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function t(){}var s={d:{f:t,r:function(){throw Error(e(522))},D:t,C:t,L:t,m:t,X:t,S:t,M:t},p:0,findDOMNode:null},n=Symbol.for("react.portal");function i(l,d,h){var p=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:n,key:p==null?null:""+p,children:l,containerInfo:d,implementation:h}}var a=c.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function o(l,d){if(l==="font")return"";if(typeof d=="string")return d==="use-credentials"?d:""}return os.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=s,os.createPortal=function(l,d){var h=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!d||d.nodeType!==1&&d.nodeType!==9&&d.nodeType!==11)throw Error(e(299));return i(l,d,null,h)},os.flushSync=function(l){var d=a.T,h=s.p;try{if(a.T=null,s.p=2,l)return l()}finally{a.T=d,s.p=h,s.d.f()}},os.preconnect=function(l,d){typeof l=="string"&&(d?(d=d.crossOrigin,d=typeof d=="string"?d==="use-credentials"?d:"":void 0):d=null,s.d.C(l,d))},os.prefetchDNS=function(l){typeof l=="string"&&s.d.D(l)},os.preinit=function(l,d){if(typeof l=="string"&&d&&typeof d.as=="string"){var h=d.as,p=o(h,d.crossOrigin),g=typeof d.integrity=="string"?d.integrity:void 0,v=typeof d.fetchPriority=="string"?d.fetchPriority:void 0;h==="style"?s.d.S(l,typeof d.precedence=="string"?d.precedence:void 0,{crossOrigin:p,integrity:g,fetchPriority:v}):h==="script"&&s.d.X(l,{crossOrigin:p,integrity:g,fetchPriority:v,nonce:typeof d.nonce=="string"?d.nonce:void 0})}},os.preinitModule=function(l,d){if(typeof l=="string")if(typeof d=="object"&&d!==null){if(d.as==null||d.as==="script"){var h=o(d.as,d.crossOrigin);s.d.M(l,{crossOrigin:h,integrity:typeof d.integrity=="string"?d.integrity:void 0,nonce:typeof d.nonce=="string"?d.nonce:void 0})}}else d==null&&s.d.M(l)},os.preload=function(l,d){if(typeof l=="string"&&typeof d=="object"&&d!==null&&typeof d.as=="string"){var h=d.as,p=o(h,d.crossOrigin);s.d.L(l,h,{crossOrigin:p,integrity:typeof d.integrity=="string"?d.integrity:void 0,nonce:typeof d.nonce=="string"?d.nonce:void 0,type:typeof d.type=="string"?d.type:void 0,fetchPriority:typeof d.fetchPriority=="string"?d.fetchPriority:void 0,referrerPolicy:typeof d.referrerPolicy=="string"?d.referrerPolicy:void 0,imageSrcSet:typeof d.imageSrcSet=="string"?d.imageSrcSet:void 0,imageSizes:typeof d.imageSizes=="string"?d.imageSizes:void 0,media:typeof d.media=="string"?d.media:void 0})}},os.preloadModule=function(l,d){if(typeof l=="string")if(d){var h=o(d.as,d.crossOrigin);s.d.m(l,{as:typeof d.as=="string"&&d.as!=="script"?d.as:void 0,crossOrigin:h,integrity:typeof d.integrity=="string"?d.integrity:void 0})}else s.d.m(l)},os.requestFormReset=function(l){s.d.r(l)},os.unstable_batchedUpdates=function(l,d){return l(d)},os.useFormState=function(l,d,h){return a.H.useFormState(l,d,h)},os.useFormStatus=function(){return a.H.useHostTransitionStatus()},os.version="19.2.0",os}var F0;function eb(){if(F0)return Jh.exports;F0=1;function c(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(c)}catch(e){console.error(e)}}return c(),Jh.exports=_R(),Jh.exports}var Q0;function IR(){if(Q0)return kr;Q0=1;var c=LR(),e=Uf(),t=eb();function s(r){var u="https://react.dev/errors/"+r;if(1<arguments.length){u+="?args[]="+encodeURIComponent(arguments[1]);for(var f=2;f<arguments.length;f++)u+="&args[]="+encodeURIComponent(arguments[f])}return"Minified React error #"+r+"; visit "+u+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function n(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11)}function i(r){var u=r,f=r;if(r.alternate)for(;u.return;)u=u.return;else{r=u;do u=r,(u.flags&4098)!==0&&(f=u.return),r=u.return;while(r)}return u.tag===3?f:null}function a(r){if(r.tag===13){var u=r.memoizedState;if(u===null&&(r=r.alternate,r!==null&&(u=r.memoizedState)),u!==null)return u.dehydrated}return null}function o(r){if(r.tag===31){var u=r.memoizedState;if(u===null&&(r=r.alternate,r!==null&&(u=r.memoizedState)),u!==null)return u.dehydrated}return null}function l(r){if(i(r)!==r)throw Error(s(188))}function d(r){var u=r.alternate;if(!u){if(u=i(r),u===null)throw Error(s(188));return u!==r?null:r}for(var f=r,m=u;;){var w=f.return;if(w===null)break;var C=w.alternate;if(C===null){if(m=w.return,m!==null){f=m;continue}break}if(w.child===C.child){for(C=w.child;C;){if(C===f)return l(w),r;if(C===m)return l(w),u;C=C.sibling}throw Error(s(188))}if(f.return!==m.return)f=w,m=C;else{for(var P=!1,_=w.child;_;){if(_===f){P=!0,f=w,m=C;break}if(_===m){P=!0,m=w,f=C;break}_=_.sibling}if(!P){for(_=C.child;_;){if(_===f){P=!0,f=C,m=w;break}if(_===m){P=!0,m=C,f=w;break}_=_.sibling}if(!P)throw Error(s(189))}}if(f.alternate!==m)throw Error(s(190))}if(f.tag!==3)throw Error(s(188));return f.stateNode.current===f?r:u}function h(r){var u=r.tag;if(u===5||u===26||u===27||u===6)return r;for(r=r.child;r!==null;){if(u=h(r),u!==null)return u;r=r.sibling}return null}var p=Object.assign,g=Symbol.for("react.element"),v=Symbol.for("react.transitional.element"),b=Symbol.for("react.portal"),M=Symbol.for("react.fragment"),x=Symbol.for("react.strict_mode"),S=Symbol.for("react.profiler"),T=Symbol.for("react.consumer"),E=Symbol.for("react.context"),A=Symbol.for("react.forward_ref"),k=Symbol.for("react.suspense"),D=Symbol.for("react.suspense_list"),L=Symbol.for("react.memo"),I=Symbol.for("react.lazy"),U=Symbol.for("react.activity"),Q=Symbol.for("react.memo_cache_sentinel"),se=Symbol.iterator;function F(r){return r===null||typeof r!="object"?null:(r=se&&r[se]||r["@@iterator"],typeof r=="function"?r:null)}var Y=Symbol.for("react.client.reference");function ae(r){if(r==null)return null;if(typeof r=="function")return r.$$typeof===Y?null:r.displayName||r.name||null;if(typeof r=="string")return r;switch(r){case M:return"Fragment";case S:return"Profiler";case x:return"StrictMode";case k:return"Suspense";case D:return"SuspenseList";case U:return"Activity"}if(typeof r=="object")switch(r.$$typeof){case b:return"Portal";case E:return r.displayName||"Context";case T:return(r._context.displayName||"Context")+".Consumer";case A:var u=r.render;return r=r.displayName,r||(r=u.displayName||u.name||"",r=r!==""?"ForwardRef("+r+")":"ForwardRef"),r;case L:return u=r.displayName||null,u!==null?u:ae(r.type)||"Memo";case I:u=r._payload,r=r._init;try{return ae(r(u))}catch{}}return null}var de=Array.isArray,z=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,$=t.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,q={pending:!1,data:null,method:null,action:null},ee=[],me=-1;function N(r){return{current:r}}function J(r){0>me||(r.current=ee[me],ee[me]=null,me--)}function K(r,u){me++,ee[me]=r.current,r.current=u}var ie=N(null),Z=N(null),re=N(null),V=N(null);function j(r,u){switch(K(re,u),K(Z,r),K(ie,null),u.nodeType){case 9:case 11:r=(r=u.documentElement)&&(r=r.namespaceURI)?o0(r):0;break;default:if(r=u.tagName,u=u.namespaceURI)u=o0(u),r=r0(u,r);else switch(r){case"svg":r=1;break;case"math":r=2;break;default:r=0}}J(ie),K(ie,r)}function ue(){J(ie),J(Z),J(re)}function fe(r){r.memoizedState!==null&&K(V,r);var u=ie.current,f=r0(u,r.type);u!==f&&(K(Z,r),K(ie,f))}function ge(r){Z.current===r&&(J(ie),J(Z)),V.current===r&&(J(V),xr._currentValue=q)}var pe,we;function Re(r){if(pe===void 0)try{throw Error()}catch(f){var u=f.stack.trim().match(/\n( *(at )?)/);pe=u&&u[1]||"",we=-1<f.stack.indexOf(`
    at`)?" (<anonymous>)":-1<f.stack.indexOf("@")?"@unknown:0:0":""}return`
`+pe+r+we}var tt=!1;function ze(r,u){if(!r||tt)return"";tt=!0;var f=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var m={DetermineComponentFrameRoot:function(){try{if(u){var le=function(){throw Error()};if(Object.defineProperty(le.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(le,[])}catch(te){var X=te}Reflect.construct(r,[],le)}else{try{le.call()}catch(te){X=te}r.call(le.prototype)}}else{try{throw Error()}catch(te){X=te}(le=r())&&typeof le.catch=="function"&&le.catch(function(){})}}catch(te){if(te&&X&&typeof te.stack=="string")return[te.stack,X.stack]}return[null,null]}};m.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var w=Object.getOwnPropertyDescriptor(m.DetermineComponentFrameRoot,"name");w&&w.configurable&&Object.defineProperty(m.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var C=m.DetermineComponentFrameRoot(),P=C[0],_=C[1];if(P&&_){var O=P.split(`
`),W=_.split(`
`);for(w=m=0;m<O.length&&!O[m].includes("DetermineComponentFrameRoot");)m++;for(;w<W.length&&!W[w].includes("DetermineComponentFrameRoot");)w++;if(m===O.length||w===W.length)for(m=O.length-1,w=W.length-1;1<=m&&0<=w&&O[m]!==W[w];)w--;for(;1<=m&&0<=w;m--,w--)if(O[m]!==W[w]){if(m!==1||w!==1)do if(m--,w--,0>w||O[m]!==W[w]){var oe=`
`+O[m].replace(" at new "," at ");return r.displayName&&oe.includes("<anonymous>")&&(oe=oe.replace("<anonymous>",r.displayName)),oe}while(1<=m&&0<=w);break}}}finally{tt=!1,Error.prepareStackTrace=f}return(f=r?r.displayName||r.name:"")?Re(f):""}function Ct(r,u){switch(r.tag){case 26:case 27:case 5:return Re(r.type);case 16:return Re("Lazy");case 13:return r.child!==u&&u!==null?Re("Suspense Fallback"):Re("Suspense");case 19:return Re("SuspenseList");case 0:case 15:return ze(r.type,!1);case 11:return ze(r.type.render,!1);case 1:return ze(r.type,!0);case 31:return Re("Activity");default:return""}}function he(r){try{var u="",f=null;do u+=Ct(r,f),f=r,r=r.return;while(r);return u}catch(m){return`
Error generating stack: `+m.message+`
`+m.stack}}var Qe=Object.prototype.hasOwnProperty,Ue=c.unstable_scheduleCallback,Mt=c.unstable_cancelCallback,yt=c.unstable_shouldYield,Ht=c.unstable_requestPaint,nt=c.unstable_now,It=c.unstable_getCurrentPriorityLevel,wt=c.unstable_ImmediatePriority,vt=c.unstable_UserBlockingPriority,Xt=c.unstable_NormalPriority,Vt=c.unstable_LowPriority,Ln=c.unstable_IdlePriority,Xs=c.log,_s=c.unstable_setDisableYieldValue,pn=null,Jt=null;function Gt(r){if(typeof Xs=="function"&&_s(r),Jt&&typeof Jt.setStrictMode=="function")try{Jt.setStrictMode(pn,r)}catch{}}var Nt=Math.clz32?Math.clz32:ic,Gi=Math.log,Aa=Math.LN2;function ic(r){return r>>>=0,r===0?32:31-(Gi(r)/Aa|0)|0}var Ss=256,Wi=262144,li=4194304;function Js(r){var u=r&42;if(u!==0)return u;switch(r&-r){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return r&261888;case 262144:case 524288:case 1048576:case 2097152:return r&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return r&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return r}}function _n(r,u,f){var m=r.pendingLanes;if(m===0)return 0;var w=0,C=r.suspendedLanes,P=r.pingedLanes;r=r.warmLanes;var _=m&134217727;return _!==0?(m=_&~C,m!==0?w=Js(m):(P&=_,P!==0?w=Js(P):f||(f=_&~r,f!==0&&(w=Js(f))))):(_=m&~C,_!==0?w=Js(_):P!==0?w=Js(P):f||(f=m&~r,f!==0&&(w=Js(f)))),w===0?0:u!==0&&u!==w&&(u&C)===0&&(C=w&-w,f=u&-u,C>=f||C===32&&(f&4194048)!==0)?u:w}function In(r,u){return(r.pendingLanes&~(r.suspendedLanes&~r.pingedLanes)&u)===0}function Ou(r,u){switch(r){case 1:case 2:case 4:case 8:case 64:return u+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return u+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function ne(){var r=li;return li<<=1,(li&62914560)===0&&(li=4194304),r}function ye(r){for(var u=[],f=0;31>f;f++)u.push(r);return u}function Me(r,u){r.pendingLanes|=u,u!==268435456&&(r.suspendedLanes=0,r.pingedLanes=0,r.warmLanes=0)}function je(r,u,f,m,w,C){var P=r.pendingLanes;r.pendingLanes=f,r.suspendedLanes=0,r.pingedLanes=0,r.warmLanes=0,r.expiredLanes&=f,r.entangledLanes&=f,r.errorRecoveryDisabledLanes&=f,r.shellSuspendCounter=0;var _=r.entanglements,O=r.expirationTimes,W=r.hiddenUpdates;for(f=P&~f;0<f;){var oe=31-Nt(f),le=1<<oe;_[oe]=0,O[oe]=-1;var X=W[oe];if(X!==null)for(W[oe]=null,oe=0;oe<X.length;oe++){var te=X[oe];te!==null&&(te.lane&=-536870913)}f&=~le}m!==0&&$e(r,m,0),C!==0&&w===0&&r.tag!==0&&(r.suspendedLanes|=C&~(P&~u))}function $e(r,u,f){r.pendingLanes|=u,r.suspendedLanes&=~u;var m=31-Nt(u);r.entangledLanes|=u,r.entanglements[m]=r.entanglements[m]|1073741824|f&261930}function it(r,u){var f=r.entangledLanes|=u;for(r=r.entanglements;f;){var m=31-Nt(f),w=1<<m;w&u|r[m]&u&&(r[m]|=u),f&=~w}}function Wt(r,u){var f=u&-u;return f=(f&42)!==0?1:ls(f),(f&(r.suspendedLanes|u))!==0?0:f}function ls(r){switch(r){case 2:r=1;break;case 8:r=4;break;case 32:r=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:r=128;break;case 268435456:r=134217728;break;default:r=0}return r}function $t(r){return r&=-r,2<r?8<r?(r&134217727)!==0?32:268435456:8:2}function xs(){var r=$.p;return r!==0?r:(r=window.event,r===void 0?32:D0(r.type))}function Et(r,u){var f=$.p;try{return $.p=r,u()}finally{$.p=f}}var Tt=Math.random().toString(36).slice(2),bt="__reactFiber$"+Tt,Bt="__reactProps$"+Tt,gn="__reactContainer$"+Tt,We="__reactEvents$"+Tt,Is="__reactListeners$"+Tt,Ki="__reactHandles$"+Tt,Da="__reactResources$"+Tt,Oo="__reactMarker$"+Tt;function qu(r){delete r[bt],delete r[Bt],delete r[We],delete r[Is],delete r[Ki]}function Pa(r){var u=r[bt];if(u)return u;for(var f=r.parentNode;f;){if(u=f[gn]||f[bt]){if(f=u.alternate,u.child!==null||f!==null&&f.child!==null)for(r=p0(r);r!==null;){if(f=r[bt])return f;r=p0(r)}return u}r=f,f=r.parentNode}return null}function La(r){if(r=r[bt]||r[gn]){var u=r.tag;if(u===5||u===6||u===13||u===31||u===26||u===27||u===3)return r}return null}function qo(r){var u=r.tag;if(u===5||u===26||u===27||u===6)return r.stateNode;throw Error(s(33))}function _a(r){var u=r[Da];return u||(u=r[Da]={hoistableStyles:new Map,hoistableScripts:new Map}),u}function Kt(r){r[Oo]=!0}var Wp=new Set,Kp={};function Yi(r,u){Ia(r,u),Ia(r+"Capture",u)}function Ia(r,u){for(Kp[r]=u,r=0;r<u.length;r++)Wp.add(u[r])}var vC=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),Yp={},Xp={};function bC(r){return Qe.call(Xp,r)?!0:Qe.call(Yp,r)?!1:vC.test(r)?Xp[r]=!0:(Yp[r]=!0,!1)}function ac(r,u,f){if(bC(u))if(f===null)r.removeAttribute(u);else{switch(typeof f){case"undefined":case"function":case"symbol":r.removeAttribute(u);return;case"boolean":var m=u.toLowerCase().slice(0,5);if(m!=="data-"&&m!=="aria-"){r.removeAttribute(u);return}}r.setAttribute(u,""+f)}}function oc(r,u,f){if(f===null)r.removeAttribute(u);else{switch(typeof f){case"undefined":case"function":case"symbol":case"boolean":r.removeAttribute(u);return}r.setAttribute(u,""+f)}}function Nn(r,u,f,m){if(m===null)r.removeAttribute(f);else{switch(typeof m){case"undefined":case"function":case"symbol":case"boolean":r.removeAttribute(f);return}r.setAttributeNS(u,f,""+m)}}function Ns(r){switch(typeof r){case"bigint":case"boolean":case"number":case"string":case"undefined":return r;case"object":return r;default:return""}}function Jp(r){var u=r.type;return(r=r.nodeName)&&r.toLowerCase()==="input"&&(u==="checkbox"||u==="radio")}function MC(r,u,f){var m=Object.getOwnPropertyDescriptor(r.constructor.prototype,u);if(!r.hasOwnProperty(u)&&typeof m<"u"&&typeof m.get=="function"&&typeof m.set=="function"){var w=m.get,C=m.set;return Object.defineProperty(r,u,{configurable:!0,get:function(){return w.call(this)},set:function(P){f=""+P,C.call(this,P)}}),Object.defineProperty(r,u,{enumerable:m.enumerable}),{getValue:function(){return f},setValue:function(P){f=""+P},stopTracking:function(){r._valueTracker=null,delete r[u]}}}}function Hu(r){if(!r._valueTracker){var u=Jp(r)?"checked":"value";r._valueTracker=MC(r,u,""+r[u])}}function Zp(r){if(!r)return!1;var u=r._valueTracker;if(!u)return!0;var f=u.getValue(),m="";return r&&(m=Jp(r)?r.checked?"true":"false":r.value),r=m,r!==f?(u.setValue(r),!0):!1}function rc(r){if(r=r||(typeof document<"u"?document:void 0),typeof r>"u")return null;try{return r.activeElement||r.body}catch{return r.body}}var wC=/[\n"\\]/g;function zs(r){return r.replace(wC,function(u){return"\\"+u.charCodeAt(0).toString(16)+" "})}function $u(r,u,f,m,w,C,P,_){r.name="",P!=null&&typeof P!="function"&&typeof P!="symbol"&&typeof P!="boolean"?r.type=P:r.removeAttribute("type"),u!=null?P==="number"?(u===0&&r.value===""||r.value!=u)&&(r.value=""+Ns(u)):r.value!==""+Ns(u)&&(r.value=""+Ns(u)):P!=="submit"&&P!=="reset"||r.removeAttribute("value"),u!=null?Bu(r,P,Ns(u)):f!=null?Bu(r,P,Ns(f)):m!=null&&r.removeAttribute("value"),w==null&&C!=null&&(r.defaultChecked=!!C),w!=null&&(r.checked=w&&typeof w!="function"&&typeof w!="symbol"),_!=null&&typeof _!="function"&&typeof _!="symbol"&&typeof _!="boolean"?r.name=""+Ns(_):r.removeAttribute("name")}function eg(r,u,f,m,w,C,P,_){if(C!=null&&typeof C!="function"&&typeof C!="symbol"&&typeof C!="boolean"&&(r.type=C),u!=null||f!=null){if(!(C!=="submit"&&C!=="reset"||u!=null)){Hu(r);return}f=f!=null?""+Ns(f):"",u=u!=null?""+Ns(u):f,_||u===r.value||(r.value=u),r.defaultValue=u}m=m??w,m=typeof m!="function"&&typeof m!="symbol"&&!!m,r.checked=_?r.checked:!!m,r.defaultChecked=!!m,P!=null&&typeof P!="function"&&typeof P!="symbol"&&typeof P!="boolean"&&(r.name=P),Hu(r)}function Bu(r,u,f){u==="number"&&rc(r.ownerDocument)===r||r.defaultValue===""+f||(r.defaultValue=""+f)}function Na(r,u,f,m){if(r=r.options,u){u={};for(var w=0;w<f.length;w++)u["$"+f[w]]=!0;for(f=0;f<r.length;f++)w=u.hasOwnProperty("$"+r[f].value),r[f].selected!==w&&(r[f].selected=w),w&&m&&(r[f].defaultSelected=!0)}else{for(f=""+Ns(f),u=null,w=0;w<r.length;w++){if(r[w].value===f){r[w].selected=!0,m&&(r[w].defaultSelected=!0);return}u!==null||r[w].disabled||(u=r[w])}u!==null&&(u.selected=!0)}}function tg(r,u,f){if(u!=null&&(u=""+Ns(u),u!==r.value&&(r.value=u),f==null)){r.defaultValue!==u&&(r.defaultValue=u);return}r.defaultValue=f!=null?""+Ns(f):""}function sg(r,u,f,m){if(u==null){if(m!=null){if(f!=null)throw Error(s(92));if(de(m)){if(1<m.length)throw Error(s(93));m=m[0]}f=m}f==null&&(f=""),u=f}f=Ns(u),r.defaultValue=f,m=r.textContent,m===f&&m!==""&&m!==null&&(r.value=m),Hu(r)}function za(r,u){if(u){var f=r.firstChild;if(f&&f===r.lastChild&&f.nodeType===3){f.nodeValue=u;return}}r.textContent=u}var SC=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function ng(r,u,f){var m=u.indexOf("--")===0;f==null||typeof f=="boolean"||f===""?m?r.setProperty(u,""):u==="float"?r.cssFloat="":r[u]="":m?r.setProperty(u,f):typeof f!="number"||f===0||SC.has(u)?u==="float"?r.cssFloat=f:r[u]=(""+f).trim():r[u]=f+"px"}function ig(r,u,f){if(u!=null&&typeof u!="object")throw Error(s(62));if(r=r.style,f!=null){for(var m in f)!f.hasOwnProperty(m)||u!=null&&u.hasOwnProperty(m)||(m.indexOf("--")===0?r.setProperty(m,""):m==="float"?r.cssFloat="":r[m]="");for(var w in u)m=u[w],u.hasOwnProperty(w)&&f[w]!==m&&ng(r,w,m)}else for(var C in u)u.hasOwnProperty(C)&&ng(r,C,u[C])}function Uu(r){if(r.indexOf("-")===-1)return!1;switch(r){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var xC=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),CC=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function cc(r){return CC.test(""+r)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":r}function zn(){}var Fu=null;function Qu(r){return r=r.target||r.srcElement||window,r.correspondingUseElement&&(r=r.correspondingUseElement),r.nodeType===3?r.parentNode:r}var ja=null,Oa=null;function ag(r){var u=La(r);if(u&&(r=u.stateNode)){var f=r[Bt]||null;e:switch(r=u.stateNode,u.type){case"input":if($u(r,f.value,f.defaultValue,f.defaultValue,f.checked,f.defaultChecked,f.type,f.name),u=f.name,f.type==="radio"&&u!=null){for(f=r;f.parentNode;)f=f.parentNode;for(f=f.querySelectorAll('input[name="'+zs(""+u)+'"][type="radio"]'),u=0;u<f.length;u++){var m=f[u];if(m!==r&&m.form===r.form){var w=m[Bt]||null;if(!w)throw Error(s(90));$u(m,w.value,w.defaultValue,w.defaultValue,w.checked,w.defaultChecked,w.type,w.name)}}for(u=0;u<f.length;u++)m=f[u],m.form===r.form&&Zp(m)}break e;case"textarea":tg(r,f.value,f.defaultValue);break e;case"select":u=f.value,u!=null&&Na(r,!!f.multiple,u,!1)}}}var Vu=!1;function og(r,u,f){if(Vu)return r(u,f);Vu=!0;try{var m=r(u);return m}finally{if(Vu=!1,(ja!==null||Oa!==null)&&(Kc(),ja&&(u=ja,r=Oa,Oa=ja=null,ag(u),r)))for(u=0;u<r.length;u++)ag(r[u])}}function Ho(r,u){var f=r.stateNode;if(f===null)return null;var m=f[Bt]||null;if(m===null)return null;f=m[u];e:switch(u){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(m=!m.disabled)||(r=r.type,m=!(r==="button"||r==="input"||r==="select"||r==="textarea")),r=!m;break e;default:r=!1}if(r)return null;if(f&&typeof f!="function")throw Error(s(231,u,typeof f));return f}var jn=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),Gu=!1;if(jn)try{var $o={};Object.defineProperty($o,"passive",{get:function(){Gu=!0}}),window.addEventListener("test",$o,$o),window.removeEventListener("test",$o,$o)}catch{Gu=!1}var ui=null,Wu=null,lc=null;function rg(){if(lc)return lc;var r,u=Wu,f=u.length,m,w="value"in ui?ui.value:ui.textContent,C=w.length;for(r=0;r<f&&u[r]===w[r];r++);var P=f-r;for(m=1;m<=P&&u[f-m]===w[C-m];m++);return lc=w.slice(r,1<m?1-m:void 0)}function uc(r){var u=r.keyCode;return"charCode"in r?(r=r.charCode,r===0&&u===13&&(r=13)):r=u,r===10&&(r=13),32<=r||r===13?r:0}function dc(){return!0}function cg(){return!1}function hs(r){function u(f,m,w,C,P){this._reactName=f,this._targetInst=w,this.type=m,this.nativeEvent=C,this.target=P,this.currentTarget=null;for(var _ in r)r.hasOwnProperty(_)&&(f=r[_],this[_]=f?f(C):C[_]);return this.isDefaultPrevented=(C.defaultPrevented!=null?C.defaultPrevented:C.returnValue===!1)?dc:cg,this.isPropagationStopped=cg,this}return p(u.prototype,{preventDefault:function(){this.defaultPrevented=!0;var f=this.nativeEvent;f&&(f.preventDefault?f.preventDefault():typeof f.returnValue!="unknown"&&(f.returnValue=!1),this.isDefaultPrevented=dc)},stopPropagation:function(){var f=this.nativeEvent;f&&(f.stopPropagation?f.stopPropagation():typeof f.cancelBubble!="unknown"&&(f.cancelBubble=!0),this.isPropagationStopped=dc)},persist:function(){},isPersistent:dc}),u}var Xi={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(r){return r.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},hc=hs(Xi),Bo=p({},Xi,{view:0,detail:0}),RC=hs(Bo),Ku,Yu,Uo,fc=p({},Bo,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Ju,button:0,buttons:0,relatedTarget:function(r){return r.relatedTarget===void 0?r.fromElement===r.srcElement?r.toElement:r.fromElement:r.relatedTarget},movementX:function(r){return"movementX"in r?r.movementX:(r!==Uo&&(Uo&&r.type==="mousemove"?(Ku=r.screenX-Uo.screenX,Yu=r.screenY-Uo.screenY):Yu=Ku=0,Uo=r),Ku)},movementY:function(r){return"movementY"in r?r.movementY:Yu}}),lg=hs(fc),TC=p({},fc,{dataTransfer:0}),EC=hs(TC),kC=p({},Bo,{relatedTarget:0}),Xu=hs(kC),AC=p({},Xi,{animationName:0,elapsedTime:0,pseudoElement:0}),DC=hs(AC),PC=p({},Xi,{clipboardData:function(r){return"clipboardData"in r?r.clipboardData:window.clipboardData}}),LC=hs(PC),_C=p({},Xi,{data:0}),ug=hs(_C),IC={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},NC={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},zC={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function jC(r){var u=this.nativeEvent;return u.getModifierState?u.getModifierState(r):(r=zC[r])?!!u[r]:!1}function Ju(){return jC}var OC=p({},Bo,{key:function(r){if(r.key){var u=IC[r.key]||r.key;if(u!=="Unidentified")return u}return r.type==="keypress"?(r=uc(r),r===13?"Enter":String.fromCharCode(r)):r.type==="keydown"||r.type==="keyup"?NC[r.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Ju,charCode:function(r){return r.type==="keypress"?uc(r):0},keyCode:function(r){return r.type==="keydown"||r.type==="keyup"?r.keyCode:0},which:function(r){return r.type==="keypress"?uc(r):r.type==="keydown"||r.type==="keyup"?r.keyCode:0}}),qC=hs(OC),HC=p({},fc,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),dg=hs(HC),$C=p({},Bo,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Ju}),BC=hs($C),UC=p({},Xi,{propertyName:0,elapsedTime:0,pseudoElement:0}),FC=hs(UC),QC=p({},fc,{deltaX:function(r){return"deltaX"in r?r.deltaX:"wheelDeltaX"in r?-r.wheelDeltaX:0},deltaY:function(r){return"deltaY"in r?r.deltaY:"wheelDeltaY"in r?-r.wheelDeltaY:"wheelDelta"in r?-r.wheelDelta:0},deltaZ:0,deltaMode:0}),VC=hs(QC),GC=p({},Xi,{newState:0,oldState:0}),WC=hs(GC),KC=[9,13,27,32],Zu=jn&&"CompositionEvent"in window,Fo=null;jn&&"documentMode"in document&&(Fo=document.documentMode);var YC=jn&&"TextEvent"in window&&!Fo,hg=jn&&(!Zu||Fo&&8<Fo&&11>=Fo),fg=" ",pg=!1;function gg(r,u){switch(r){case"keyup":return KC.indexOf(u.keyCode)!==-1;case"keydown":return u.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function mg(r){return r=r.detail,typeof r=="object"&&"data"in r?r.data:null}var qa=!1;function XC(r,u){switch(r){case"compositionend":return mg(u);case"keypress":return u.which!==32?null:(pg=!0,fg);case"textInput":return r=u.data,r===fg&&pg?null:r;default:return null}}function JC(r,u){if(qa)return r==="compositionend"||!Zu&&gg(r,u)?(r=rg(),lc=Wu=ui=null,qa=!1,r):null;switch(r){case"paste":return null;case"keypress":if(!(u.ctrlKey||u.altKey||u.metaKey)||u.ctrlKey&&u.altKey){if(u.char&&1<u.char.length)return u.char;if(u.which)return String.fromCharCode(u.which)}return null;case"compositionend":return hg&&u.locale!=="ko"?null:u.data;default:return null}}var ZC={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function yg(r){var u=r&&r.nodeName&&r.nodeName.toLowerCase();return u==="input"?!!ZC[r.type]:u==="textarea"}function vg(r,u,f,m){ja?Oa?Oa.push(m):Oa=[m]:ja=m,u=sl(u,"onChange"),0<u.length&&(f=new hc("onChange","change",null,f,m),r.push({event:f,listeners:u}))}var Qo=null,Vo=null;function e1(r){e0(r,0)}function pc(r){var u=qo(r);if(Zp(u))return r}function bg(r,u){if(r==="change")return u}var Mg=!1;if(jn){var ed;if(jn){var td="oninput"in document;if(!td){var wg=document.createElement("div");wg.setAttribute("oninput","return;"),td=typeof wg.oninput=="function"}ed=td}else ed=!1;Mg=ed&&(!document.documentMode||9<document.documentMode)}function Sg(){Qo&&(Qo.detachEvent("onpropertychange",xg),Vo=Qo=null)}function xg(r){if(r.propertyName==="value"&&pc(Vo)){var u=[];vg(u,Vo,r,Qu(r)),og(e1,u)}}function t1(r,u,f){r==="focusin"?(Sg(),Qo=u,Vo=f,Qo.attachEvent("onpropertychange",xg)):r==="focusout"&&Sg()}function s1(r){if(r==="selectionchange"||r==="keyup"||r==="keydown")return pc(Vo)}function n1(r,u){if(r==="click")return pc(u)}function i1(r,u){if(r==="input"||r==="change")return pc(u)}function a1(r,u){return r===u&&(r!==0||1/r===1/u)||r!==r&&u!==u}var Cs=typeof Object.is=="function"?Object.is:a1;function Go(r,u){if(Cs(r,u))return!0;if(typeof r!="object"||r===null||typeof u!="object"||u===null)return!1;var f=Object.keys(r),m=Object.keys(u);if(f.length!==m.length)return!1;for(m=0;m<f.length;m++){var w=f[m];if(!Qe.call(u,w)||!Cs(r[w],u[w]))return!1}return!0}function Cg(r){for(;r&&r.firstChild;)r=r.firstChild;return r}function Rg(r,u){var f=Cg(r);r=0;for(var m;f;){if(f.nodeType===3){if(m=r+f.textContent.length,r<=u&&m>=u)return{node:f,offset:u-r};r=m}e:{for(;f;){if(f.nextSibling){f=f.nextSibling;break e}f=f.parentNode}f=void 0}f=Cg(f)}}function Tg(r,u){return r&&u?r===u?!0:r&&r.nodeType===3?!1:u&&u.nodeType===3?Tg(r,u.parentNode):"contains"in r?r.contains(u):r.compareDocumentPosition?!!(r.compareDocumentPosition(u)&16):!1:!1}function Eg(r){r=r!=null&&r.ownerDocument!=null&&r.ownerDocument.defaultView!=null?r.ownerDocument.defaultView:window;for(var u=rc(r.document);u instanceof r.HTMLIFrameElement;){try{var f=typeof u.contentWindow.location.href=="string"}catch{f=!1}if(f)r=u.contentWindow;else break;u=rc(r.document)}return u}function sd(r){var u=r&&r.nodeName&&r.nodeName.toLowerCase();return u&&(u==="input"&&(r.type==="text"||r.type==="search"||r.type==="tel"||r.type==="url"||r.type==="password")||u==="textarea"||r.contentEditable==="true")}var o1=jn&&"documentMode"in document&&11>=document.documentMode,Ha=null,nd=null,Wo=null,id=!1;function kg(r,u,f){var m=f.window===f?f.document:f.nodeType===9?f:f.ownerDocument;id||Ha==null||Ha!==rc(m)||(m=Ha,"selectionStart"in m&&sd(m)?m={start:m.selectionStart,end:m.selectionEnd}:(m=(m.ownerDocument&&m.ownerDocument.defaultView||window).getSelection(),m={anchorNode:m.anchorNode,anchorOffset:m.anchorOffset,focusNode:m.focusNode,focusOffset:m.focusOffset}),Wo&&Go(Wo,m)||(Wo=m,m=sl(nd,"onSelect"),0<m.length&&(u=new hc("onSelect","select",null,u,f),r.push({event:u,listeners:m}),u.target=Ha)))}function Ji(r,u){var f={};return f[r.toLowerCase()]=u.toLowerCase(),f["Webkit"+r]="webkit"+u,f["Moz"+r]="moz"+u,f}var $a={animationend:Ji("Animation","AnimationEnd"),animationiteration:Ji("Animation","AnimationIteration"),animationstart:Ji("Animation","AnimationStart"),transitionrun:Ji("Transition","TransitionRun"),transitionstart:Ji("Transition","TransitionStart"),transitioncancel:Ji("Transition","TransitionCancel"),transitionend:Ji("Transition","TransitionEnd")},ad={},Ag={};jn&&(Ag=document.createElement("div").style,"AnimationEvent"in window||(delete $a.animationend.animation,delete $a.animationiteration.animation,delete $a.animationstart.animation),"TransitionEvent"in window||delete $a.transitionend.transition);function Zi(r){if(ad[r])return ad[r];if(!$a[r])return r;var u=$a[r],f;for(f in u)if(u.hasOwnProperty(f)&&f in Ag)return ad[r]=u[f];return r}var Dg=Zi("animationend"),Pg=Zi("animationiteration"),Lg=Zi("animationstart"),r1=Zi("transitionrun"),c1=Zi("transitionstart"),l1=Zi("transitioncancel"),_g=Zi("transitionend"),Ig=new Map,od="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");od.push("scrollEnd");function Zs(r,u){Ig.set(r,u),Yi(u,[r])}var gc=typeof reportError=="function"?reportError:function(r){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var u=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof r=="object"&&r!==null&&typeof r.message=="string"?String(r.message):String(r),error:r});if(!window.dispatchEvent(u))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",r);return}console.error(r)},js=[],Ba=0,rd=0;function mc(){for(var r=Ba,u=rd=Ba=0;u<r;){var f=js[u];js[u++]=null;var m=js[u];js[u++]=null;var w=js[u];js[u++]=null;var C=js[u];if(js[u++]=null,m!==null&&w!==null){var P=m.pending;P===null?w.next=w:(w.next=P.next,P.next=w),m.pending=w}C!==0&&Ng(f,w,C)}}function yc(r,u,f,m){js[Ba++]=r,js[Ba++]=u,js[Ba++]=f,js[Ba++]=m,rd|=m,r.lanes|=m,r=r.alternate,r!==null&&(r.lanes|=m)}function cd(r,u,f,m){return yc(r,u,f,m),vc(r)}function ea(r,u){return yc(r,null,null,u),vc(r)}function Ng(r,u,f){r.lanes|=f;var m=r.alternate;m!==null&&(m.lanes|=f);for(var w=!1,C=r.return;C!==null;)C.childLanes|=f,m=C.alternate,m!==null&&(m.childLanes|=f),C.tag===22&&(r=C.stateNode,r===null||r._visibility&1||(w=!0)),r=C,C=C.return;return r.tag===3?(C=r.stateNode,w&&u!==null&&(w=31-Nt(f),r=C.hiddenUpdates,m=r[w],m===null?r[w]=[u]:m.push(u),u.lane=f|536870912),C):null}function vc(r){if(50<mr)throw mr=0,yh=null,Error(s(185));for(var u=r.return;u!==null;)r=u,u=r.return;return r.tag===3?r.stateNode:null}var Ua={};function u1(r,u,f,m){this.tag=r,this.key=f,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=u,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=m,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Rs(r,u,f,m){return new u1(r,u,f,m)}function ld(r){return r=r.prototype,!(!r||!r.isReactComponent)}function On(r,u){var f=r.alternate;return f===null?(f=Rs(r.tag,u,r.key,r.mode),f.elementType=r.elementType,f.type=r.type,f.stateNode=r.stateNode,f.alternate=r,r.alternate=f):(f.pendingProps=u,f.type=r.type,f.flags=0,f.subtreeFlags=0,f.deletions=null),f.flags=r.flags&65011712,f.childLanes=r.childLanes,f.lanes=r.lanes,f.child=r.child,f.memoizedProps=r.memoizedProps,f.memoizedState=r.memoizedState,f.updateQueue=r.updateQueue,u=r.dependencies,f.dependencies=u===null?null:{lanes:u.lanes,firstContext:u.firstContext},f.sibling=r.sibling,f.index=r.index,f.ref=r.ref,f.refCleanup=r.refCleanup,f}function zg(r,u){r.flags&=65011714;var f=r.alternate;return f===null?(r.childLanes=0,r.lanes=u,r.child=null,r.subtreeFlags=0,r.memoizedProps=null,r.memoizedState=null,r.updateQueue=null,r.dependencies=null,r.stateNode=null):(r.childLanes=f.childLanes,r.lanes=f.lanes,r.child=f.child,r.subtreeFlags=0,r.deletions=null,r.memoizedProps=f.memoizedProps,r.memoizedState=f.memoizedState,r.updateQueue=f.updateQueue,r.type=f.type,u=f.dependencies,r.dependencies=u===null?null:{lanes:u.lanes,firstContext:u.firstContext}),r}function bc(r,u,f,m,w,C){var P=0;if(m=r,typeof r=="function")ld(r)&&(P=1);else if(typeof r=="string")P=gR(r,f,ie.current)?26:r==="html"||r==="head"||r==="body"?27:5;else e:switch(r){case U:return r=Rs(31,f,u,w),r.elementType=U,r.lanes=C,r;case M:return ta(f.children,w,C,u);case x:P=8,w|=24;break;case S:return r=Rs(12,f,u,w|2),r.elementType=S,r.lanes=C,r;case k:return r=Rs(13,f,u,w),r.elementType=k,r.lanes=C,r;case D:return r=Rs(19,f,u,w),r.elementType=D,r.lanes=C,r;default:if(typeof r=="object"&&r!==null)switch(r.$$typeof){case E:P=10;break e;case T:P=9;break e;case A:P=11;break e;case L:P=14;break e;case I:P=16,m=null;break e}P=29,f=Error(s(130,r===null?"null":typeof r,"")),m=null}return u=Rs(P,f,u,w),u.elementType=r,u.type=m,u.lanes=C,u}function ta(r,u,f,m){return r=Rs(7,r,m,u),r.lanes=f,r}function ud(r,u,f){return r=Rs(6,r,null,u),r.lanes=f,r}function jg(r){var u=Rs(18,null,null,0);return u.stateNode=r,u}function dd(r,u,f){return u=Rs(4,r.children!==null?r.children:[],r.key,u),u.lanes=f,u.stateNode={containerInfo:r.containerInfo,pendingChildren:null,implementation:r.implementation},u}var Og=new WeakMap;function Os(r,u){if(typeof r=="object"&&r!==null){var f=Og.get(r);return f!==void 0?f:(u={value:r,source:u,stack:he(u)},Og.set(r,u),u)}return{value:r,source:u,stack:he(u)}}var Fa=[],Qa=0,Mc=null,Ko=0,qs=[],Hs=0,di=null,mn=1,yn="";function qn(r,u){Fa[Qa++]=Ko,Fa[Qa++]=Mc,Mc=r,Ko=u}function qg(r,u,f){qs[Hs++]=mn,qs[Hs++]=yn,qs[Hs++]=di,di=r;var m=mn;r=yn;var w=32-Nt(m)-1;m&=~(1<<w),f+=1;var C=32-Nt(u)+w;if(30<C){var P=w-w%5;C=(m&(1<<P)-1).toString(32),m>>=P,w-=P,mn=1<<32-Nt(u)+w|f<<w|m,yn=C+r}else mn=1<<C|f<<w|m,yn=r}function hd(r){r.return!==null&&(qn(r,1),qg(r,1,0))}function fd(r){for(;r===Mc;)Mc=Fa[--Qa],Fa[Qa]=null,Ko=Fa[--Qa],Fa[Qa]=null;for(;r===di;)di=qs[--Hs],qs[Hs]=null,yn=qs[--Hs],qs[Hs]=null,mn=qs[--Hs],qs[Hs]=null}function Hg(r,u){qs[Hs++]=mn,qs[Hs++]=yn,qs[Hs++]=di,mn=u.id,yn=u.overflow,di=r}var Zt=null,St=null,st=!1,hi=null,$s=!1,pd=Error(s(519));function fi(r){var u=Error(s(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw Yo(Os(u,r)),pd}function $g(r){var u=r.stateNode,f=r.type,m=r.memoizedProps;switch(u[bt]=r,u[Bt]=m,f){case"dialog":Ye("cancel",u),Ye("close",u);break;case"iframe":case"object":case"embed":Ye("load",u);break;case"video":case"audio":for(f=0;f<vr.length;f++)Ye(vr[f],u);break;case"source":Ye("error",u);break;case"img":case"image":case"link":Ye("error",u),Ye("load",u);break;case"details":Ye("toggle",u);break;case"input":Ye("invalid",u),eg(u,m.value,m.defaultValue,m.checked,m.defaultChecked,m.type,m.name,!0);break;case"select":Ye("invalid",u);break;case"textarea":Ye("invalid",u),sg(u,m.value,m.defaultValue,m.children)}f=m.children,typeof f!="string"&&typeof f!="number"&&typeof f!="bigint"||u.textContent===""+f||m.suppressHydrationWarning===!0||i0(u.textContent,f)?(m.popover!=null&&(Ye("beforetoggle",u),Ye("toggle",u)),m.onScroll!=null&&Ye("scroll",u),m.onScrollEnd!=null&&Ye("scrollend",u),m.onClick!=null&&(u.onclick=zn),u=!0):u=!1,u||fi(r,!0)}function Bg(r){for(Zt=r.return;Zt;)switch(Zt.tag){case 5:case 31:case 13:$s=!1;return;case 27:case 3:$s=!0;return;default:Zt=Zt.return}}function Va(r){if(r!==Zt)return!1;if(!st)return Bg(r),st=!0,!1;var u=r.tag,f;if((f=u!==3&&u!==27)&&((f=u===5)&&(f=r.type,f=!(f!=="form"&&f!=="button")||Lh(r.type,r.memoizedProps)),f=!f),f&&St&&fi(r),Bg(r),u===13){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(s(317));St=f0(r)}else if(u===31){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(s(317));St=f0(r)}else u===27?(u=St,Ei(r.type)?(r=jh,jh=null,St=r):St=u):St=Zt?Us(r.stateNode.nextSibling):null;return!0}function sa(){St=Zt=null,st=!1}function gd(){var r=hi;return r!==null&&(ms===null?ms=r:ms.push.apply(ms,r),hi=null),r}function Yo(r){hi===null?hi=[r]:hi.push(r)}var md=N(null),na=null,Hn=null;function pi(r,u,f){K(md,u._currentValue),u._currentValue=f}function $n(r){r._currentValue=md.current,J(md)}function yd(r,u,f){for(;r!==null;){var m=r.alternate;if((r.childLanes&u)!==u?(r.childLanes|=u,m!==null&&(m.childLanes|=u)):m!==null&&(m.childLanes&u)!==u&&(m.childLanes|=u),r===f)break;r=r.return}}function vd(r,u,f,m){var w=r.child;for(w!==null&&(w.return=r);w!==null;){var C=w.dependencies;if(C!==null){var P=w.child;C=C.firstContext;e:for(;C!==null;){var _=C;C=w;for(var O=0;O<u.length;O++)if(_.context===u[O]){C.lanes|=f,_=C.alternate,_!==null&&(_.lanes|=f),yd(C.return,f,r),m||(P=null);break e}C=_.next}}else if(w.tag===18){if(P=w.return,P===null)throw Error(s(341));P.lanes|=f,C=P.alternate,C!==null&&(C.lanes|=f),yd(P,f,r),P=null}else P=w.child;if(P!==null)P.return=w;else for(P=w;P!==null;){if(P===r){P=null;break}if(w=P.sibling,w!==null){w.return=P.return,P=w;break}P=P.return}w=P}}function Ga(r,u,f,m){r=null;for(var w=u,C=!1;w!==null;){if(!C){if((w.flags&524288)!==0)C=!0;else if((w.flags&262144)!==0)break}if(w.tag===10){var P=w.alternate;if(P===null)throw Error(s(387));if(P=P.memoizedProps,P!==null){var _=w.type;Cs(w.pendingProps.value,P.value)||(r!==null?r.push(_):r=[_])}}else if(w===V.current){if(P=w.alternate,P===null)throw Error(s(387));P.memoizedState.memoizedState!==w.memoizedState.memoizedState&&(r!==null?r.push(xr):r=[xr])}w=w.return}r!==null&&vd(u,r,f,m),u.flags|=262144}function wc(r){for(r=r.firstContext;r!==null;){if(!Cs(r.context._currentValue,r.memoizedValue))return!0;r=r.next}return!1}function ia(r){na=r,Hn=null,r=r.dependencies,r!==null&&(r.firstContext=null)}function es(r){return Ug(na,r)}function Sc(r,u){return na===null&&ia(r),Ug(r,u)}function Ug(r,u){var f=u._currentValue;if(u={context:u,memoizedValue:f,next:null},Hn===null){if(r===null)throw Error(s(308));Hn=u,r.dependencies={lanes:0,firstContext:u},r.flags|=524288}else Hn=Hn.next=u;return f}var d1=typeof AbortController<"u"?AbortController:function(){var r=[],u=this.signal={aborted:!1,addEventListener:function(f,m){r.push(m)}};this.abort=function(){u.aborted=!0,r.forEach(function(f){return f()})}},h1=c.unstable_scheduleCallback,f1=c.unstable_NormalPriority,zt={$$typeof:E,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function bd(){return{controller:new d1,data:new Map,refCount:0}}function Xo(r){r.refCount--,r.refCount===0&&h1(f1,function(){r.controller.abort()})}var Jo=null,Md=0,Wa=0,Ka=null;function p1(r,u){if(Jo===null){var f=Jo=[];Md=0,Wa=xh(),Ka={status:"pending",value:void 0,then:function(m){f.push(m)}}}return Md++,u.then(Fg,Fg),u}function Fg(){if(--Md===0&&Jo!==null){Ka!==null&&(Ka.status="fulfilled");var r=Jo;Jo=null,Wa=0,Ka=null;for(var u=0;u<r.length;u++)(0,r[u])()}}function g1(r,u){var f=[],m={status:"pending",value:null,reason:null,then:function(w){f.push(w)}};return r.then(function(){m.status="fulfilled",m.value=u;for(var w=0;w<f.length;w++)(0,f[w])(u)},function(w){for(m.status="rejected",m.reason=w,w=0;w<f.length;w++)(0,f[w])(void 0)}),m}var Qg=z.S;z.S=function(r,u){ky=nt(),typeof u=="object"&&u!==null&&typeof u.then=="function"&&p1(r,u),Qg!==null&&Qg(r,u)};var aa=N(null);function wd(){var r=aa.current;return r!==null?r:gt.pooledCache}function xc(r,u){u===null?K(aa,aa.current):K(aa,u.pool)}function Vg(){var r=wd();return r===null?null:{parent:zt._currentValue,pool:r}}var Ya=Error(s(460)),Sd=Error(s(474)),Cc=Error(s(542)),Rc={then:function(){}};function Gg(r){return r=r.status,r==="fulfilled"||r==="rejected"}function Wg(r,u,f){switch(f=r[f],f===void 0?r.push(u):f!==u&&(u.then(zn,zn),u=f),u.status){case"fulfilled":return u.value;case"rejected":throw r=u.reason,Yg(r),r;default:if(typeof u.status=="string")u.then(zn,zn);else{if(r=gt,r!==null&&100<r.shellSuspendCounter)throw Error(s(482));r=u,r.status="pending",r.then(function(m){if(u.status==="pending"){var w=u;w.status="fulfilled",w.value=m}},function(m){if(u.status==="pending"){var w=u;w.status="rejected",w.reason=m}})}switch(u.status){case"fulfilled":return u.value;case"rejected":throw r=u.reason,Yg(r),r}throw ra=u,Ya}}function oa(r){try{var u=r._init;return u(r._payload)}catch(f){throw f!==null&&typeof f=="object"&&typeof f.then=="function"?(ra=f,Ya):f}}var ra=null;function Kg(){if(ra===null)throw Error(s(459));var r=ra;return ra=null,r}function Yg(r){if(r===Ya||r===Cc)throw Error(s(483))}var Xa=null,Zo=0;function Tc(r){var u=Zo;return Zo+=1,Xa===null&&(Xa=[]),Wg(Xa,r,u)}function er(r,u){u=u.props.ref,r.ref=u!==void 0?u:null}function Ec(r,u){throw u.$$typeof===g?Error(s(525)):(r=Object.prototype.toString.call(u),Error(s(31,r==="[object Object]"?"object with keys {"+Object.keys(u).join(", ")+"}":r)))}function Xg(r){function u(B,H){if(r){var G=B.deletions;G===null?(B.deletions=[H],B.flags|=16):G.push(H)}}function f(B,H){if(!r)return null;for(;H!==null;)u(B,H),H=H.sibling;return null}function m(B){for(var H=new Map;B!==null;)B.key!==null?H.set(B.key,B):H.set(B.index,B),B=B.sibling;return H}function w(B,H){return B=On(B,H),B.index=0,B.sibling=null,B}function C(B,H,G){return B.index=G,r?(G=B.alternate,G!==null?(G=G.index,G<H?(B.flags|=67108866,H):G):(B.flags|=67108866,H)):(B.flags|=1048576,H)}function P(B){return r&&B.alternate===null&&(B.flags|=67108866),B}function _(B,H,G,ce){return H===null||H.tag!==6?(H=ud(G,B.mode,ce),H.return=B,H):(H=w(H,G),H.return=B,H)}function O(B,H,G,ce){var Pe=G.type;return Pe===M?oe(B,H,G.props.children,ce,G.key):H!==null&&(H.elementType===Pe||typeof Pe=="object"&&Pe!==null&&Pe.$$typeof===I&&oa(Pe)===H.type)?(H=w(H,G.props),er(H,G),H.return=B,H):(H=bc(G.type,G.key,G.props,null,B.mode,ce),er(H,G),H.return=B,H)}function W(B,H,G,ce){return H===null||H.tag!==4||H.stateNode.containerInfo!==G.containerInfo||H.stateNode.implementation!==G.implementation?(H=dd(G,B.mode,ce),H.return=B,H):(H=w(H,G.children||[]),H.return=B,H)}function oe(B,H,G,ce,Pe){return H===null||H.tag!==7?(H=ta(G,B.mode,ce,Pe),H.return=B,H):(H=w(H,G),H.return=B,H)}function le(B,H,G){if(typeof H=="string"&&H!==""||typeof H=="number"||typeof H=="bigint")return H=ud(""+H,B.mode,G),H.return=B,H;if(typeof H=="object"&&H!==null){switch(H.$$typeof){case v:return G=bc(H.type,H.key,H.props,null,B.mode,G),er(G,H),G.return=B,G;case b:return H=dd(H,B.mode,G),H.return=B,H;case I:return H=oa(H),le(B,H,G)}if(de(H)||F(H))return H=ta(H,B.mode,G,null),H.return=B,H;if(typeof H.then=="function")return le(B,Tc(H),G);if(H.$$typeof===E)return le(B,Sc(B,H),G);Ec(B,H)}return null}function X(B,H,G,ce){var Pe=H!==null?H.key:null;if(typeof G=="string"&&G!==""||typeof G=="number"||typeof G=="bigint")return Pe!==null?null:_(B,H,""+G,ce);if(typeof G=="object"&&G!==null){switch(G.$$typeof){case v:return G.key===Pe?O(B,H,G,ce):null;case b:return G.key===Pe?W(B,H,G,ce):null;case I:return G=oa(G),X(B,H,G,ce)}if(de(G)||F(G))return Pe!==null?null:oe(B,H,G,ce,null);if(typeof G.then=="function")return X(B,H,Tc(G),ce);if(G.$$typeof===E)return X(B,H,Sc(B,G),ce);Ec(B,G)}return null}function te(B,H,G,ce,Pe){if(typeof ce=="string"&&ce!==""||typeof ce=="number"||typeof ce=="bigint")return B=B.get(G)||null,_(H,B,""+ce,Pe);if(typeof ce=="object"&&ce!==null){switch(ce.$$typeof){case v:return B=B.get(ce.key===null?G:ce.key)||null,O(H,B,ce,Pe);case b:return B=B.get(ce.key===null?G:ce.key)||null,W(H,B,ce,Pe);case I:return ce=oa(ce),te(B,H,G,ce,Pe)}if(de(ce)||F(ce))return B=B.get(G)||null,oe(H,B,ce,Pe,null);if(typeof ce.then=="function")return te(B,H,G,Tc(ce),Pe);if(ce.$$typeof===E)return te(B,H,G,Sc(H,ce),Pe);Ec(H,ce)}return null}function Se(B,H,G,ce){for(var Pe=null,at=null,Ee=H,Fe=H=0,Je=null;Ee!==null&&Fe<G.length;Fe++){Ee.index>Fe?(Je=Ee,Ee=null):Je=Ee.sibling;var ot=X(B,Ee,G[Fe],ce);if(ot===null){Ee===null&&(Ee=Je);break}r&&Ee&&ot.alternate===null&&u(B,Ee),H=C(ot,H,Fe),at===null?Pe=ot:at.sibling=ot,at=ot,Ee=Je}if(Fe===G.length)return f(B,Ee),st&&qn(B,Fe),Pe;if(Ee===null){for(;Fe<G.length;Fe++)Ee=le(B,G[Fe],ce),Ee!==null&&(H=C(Ee,H,Fe),at===null?Pe=Ee:at.sibling=Ee,at=Ee);return st&&qn(B,Fe),Pe}for(Ee=m(Ee);Fe<G.length;Fe++)Je=te(Ee,B,Fe,G[Fe],ce),Je!==null&&(r&&Je.alternate!==null&&Ee.delete(Je.key===null?Fe:Je.key),H=C(Je,H,Fe),at===null?Pe=Je:at.sibling=Je,at=Je);return r&&Ee.forEach(function(Li){return u(B,Li)}),st&&qn(B,Fe),Pe}function Ie(B,H,G,ce){if(G==null)throw Error(s(151));for(var Pe=null,at=null,Ee=H,Fe=H=0,Je=null,ot=G.next();Ee!==null&&!ot.done;Fe++,ot=G.next()){Ee.index>Fe?(Je=Ee,Ee=null):Je=Ee.sibling;var Li=X(B,Ee,ot.value,ce);if(Li===null){Ee===null&&(Ee=Je);break}r&&Ee&&Li.alternate===null&&u(B,Ee),H=C(Li,H,Fe),at===null?Pe=Li:at.sibling=Li,at=Li,Ee=Je}if(ot.done)return f(B,Ee),st&&qn(B,Fe),Pe;if(Ee===null){for(;!ot.done;Fe++,ot=G.next())ot=le(B,ot.value,ce),ot!==null&&(H=C(ot,H,Fe),at===null?Pe=ot:at.sibling=ot,at=ot);return st&&qn(B,Fe),Pe}for(Ee=m(Ee);!ot.done;Fe++,ot=G.next())ot=te(Ee,B,Fe,ot.value,ce),ot!==null&&(r&&ot.alternate!==null&&Ee.delete(ot.key===null?Fe:ot.key),H=C(ot,H,Fe),at===null?Pe=ot:at.sibling=ot,at=ot);return r&&Ee.forEach(function(TR){return u(B,TR)}),st&&qn(B,Fe),Pe}function ft(B,H,G,ce){if(typeof G=="object"&&G!==null&&G.type===M&&G.key===null&&(G=G.props.children),typeof G=="object"&&G!==null){switch(G.$$typeof){case v:e:{for(var Pe=G.key;H!==null;){if(H.key===Pe){if(Pe=G.type,Pe===M){if(H.tag===7){f(B,H.sibling),ce=w(H,G.props.children),ce.return=B,B=ce;break e}}else if(H.elementType===Pe||typeof Pe=="object"&&Pe!==null&&Pe.$$typeof===I&&oa(Pe)===H.type){f(B,H.sibling),ce=w(H,G.props),er(ce,G),ce.return=B,B=ce;break e}f(B,H);break}else u(B,H);H=H.sibling}G.type===M?(ce=ta(G.props.children,B.mode,ce,G.key),ce.return=B,B=ce):(ce=bc(G.type,G.key,G.props,null,B.mode,ce),er(ce,G),ce.return=B,B=ce)}return P(B);case b:e:{for(Pe=G.key;H!==null;){if(H.key===Pe)if(H.tag===4&&H.stateNode.containerInfo===G.containerInfo&&H.stateNode.implementation===G.implementation){f(B,H.sibling),ce=w(H,G.children||[]),ce.return=B,B=ce;break e}else{f(B,H);break}else u(B,H);H=H.sibling}ce=dd(G,B.mode,ce),ce.return=B,B=ce}return P(B);case I:return G=oa(G),ft(B,H,G,ce)}if(de(G))return Se(B,H,G,ce);if(F(G)){if(Pe=F(G),typeof Pe!="function")throw Error(s(150));return G=Pe.call(G),Ie(B,H,G,ce)}if(typeof G.then=="function")return ft(B,H,Tc(G),ce);if(G.$$typeof===E)return ft(B,H,Sc(B,G),ce);Ec(B,G)}return typeof G=="string"&&G!==""||typeof G=="number"||typeof G=="bigint"?(G=""+G,H!==null&&H.tag===6?(f(B,H.sibling),ce=w(H,G),ce.return=B,B=ce):(f(B,H),ce=ud(G,B.mode,ce),ce.return=B,B=ce),P(B)):f(B,H)}return function(B,H,G,ce){try{Zo=0;var Pe=ft(B,H,G,ce);return Xa=null,Pe}catch(Ee){if(Ee===Ya||Ee===Cc)throw Ee;var at=Rs(29,Ee,null,B.mode);return at.lanes=ce,at.return=B,at}finally{}}}var ca=Xg(!0),Jg=Xg(!1),gi=!1;function xd(r){r.updateQueue={baseState:r.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function Cd(r,u){r=r.updateQueue,u.updateQueue===r&&(u.updateQueue={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,callbacks:null})}function mi(r){return{lane:r,tag:0,payload:null,callback:null,next:null}}function yi(r,u,f){var m=r.updateQueue;if(m===null)return null;if(m=m.shared,(rt&2)!==0){var w=m.pending;return w===null?u.next=u:(u.next=w.next,w.next=u),m.pending=u,u=vc(r),Ng(r,null,f),u}return yc(r,m,u,f),vc(r)}function tr(r,u,f){if(u=u.updateQueue,u!==null&&(u=u.shared,(f&4194048)!==0)){var m=u.lanes;m&=r.pendingLanes,f|=m,u.lanes=f,it(r,f)}}function Rd(r,u){var f=r.updateQueue,m=r.alternate;if(m!==null&&(m=m.updateQueue,f===m)){var w=null,C=null;if(f=f.firstBaseUpdate,f!==null){do{var P={lane:f.lane,tag:f.tag,payload:f.payload,callback:null,next:null};C===null?w=C=P:C=C.next=P,f=f.next}while(f!==null);C===null?w=C=u:C=C.next=u}else w=C=u;f={baseState:m.baseState,firstBaseUpdate:w,lastBaseUpdate:C,shared:m.shared,callbacks:m.callbacks},r.updateQueue=f;return}r=f.lastBaseUpdate,r===null?f.firstBaseUpdate=u:r.next=u,f.lastBaseUpdate=u}var Td=!1;function sr(){if(Td){var r=Ka;if(r!==null)throw r}}function nr(r,u,f,m){Td=!1;var w=r.updateQueue;gi=!1;var C=w.firstBaseUpdate,P=w.lastBaseUpdate,_=w.shared.pending;if(_!==null){w.shared.pending=null;var O=_,W=O.next;O.next=null,P===null?C=W:P.next=W,P=O;var oe=r.alternate;oe!==null&&(oe=oe.updateQueue,_=oe.lastBaseUpdate,_!==P&&(_===null?oe.firstBaseUpdate=W:_.next=W,oe.lastBaseUpdate=O))}if(C!==null){var le=w.baseState;P=0,oe=W=O=null,_=C;do{var X=_.lane&-536870913,te=X!==_.lane;if(te?(Xe&X)===X:(m&X)===X){X!==0&&X===Wa&&(Td=!0),oe!==null&&(oe=oe.next={lane:0,tag:_.tag,payload:_.payload,callback:null,next:null});e:{var Se=r,Ie=_;X=u;var ft=f;switch(Ie.tag){case 1:if(Se=Ie.payload,typeof Se=="function"){le=Se.call(ft,le,X);break e}le=Se;break e;case 3:Se.flags=Se.flags&-65537|128;case 0:if(Se=Ie.payload,X=typeof Se=="function"?Se.call(ft,le,X):Se,X==null)break e;le=p({},le,X);break e;case 2:gi=!0}}X=_.callback,X!==null&&(r.flags|=64,te&&(r.flags|=8192),te=w.callbacks,te===null?w.callbacks=[X]:te.push(X))}else te={lane:X,tag:_.tag,payload:_.payload,callback:_.callback,next:null},oe===null?(W=oe=te,O=le):oe=oe.next=te,P|=X;if(_=_.next,_===null){if(_=w.shared.pending,_===null)break;te=_,_=te.next,te.next=null,w.lastBaseUpdate=te,w.shared.pending=null}}while(!0);oe===null&&(O=le),w.baseState=O,w.firstBaseUpdate=W,w.lastBaseUpdate=oe,C===null&&(w.shared.lanes=0),Si|=P,r.lanes=P,r.memoizedState=le}}function Zg(r,u){if(typeof r!="function")throw Error(s(191,r));r.call(u)}function em(r,u){var f=r.callbacks;if(f!==null)for(r.callbacks=null,r=0;r<f.length;r++)Zg(f[r],u)}var Ja=N(null),kc=N(0);function tm(r,u){r=Yn,K(kc,r),K(Ja,u),Yn=r|u.baseLanes}function Ed(){K(kc,Yn),K(Ja,Ja.current)}function kd(){Yn=kc.current,J(Ja),J(kc)}var Ts=N(null),Bs=null;function vi(r){var u=r.alternate;K(Pt,Pt.current&1),K(Ts,r),Bs===null&&(u===null||Ja.current!==null||u.memoizedState!==null)&&(Bs=r)}function Ad(r){K(Pt,Pt.current),K(Ts,r),Bs===null&&(Bs=r)}function sm(r){r.tag===22?(K(Pt,Pt.current),K(Ts,r),Bs===null&&(Bs=r)):bi()}function bi(){K(Pt,Pt.current),K(Ts,Ts.current)}function Es(r){J(Ts),Bs===r&&(Bs=null),J(Pt)}var Pt=N(0);function Ac(r){for(var u=r;u!==null;){if(u.tag===13){var f=u.memoizedState;if(f!==null&&(f=f.dehydrated,f===null||Nh(f)||zh(f)))return u}else if(u.tag===19&&(u.memoizedProps.revealOrder==="forwards"||u.memoizedProps.revealOrder==="backwards"||u.memoizedProps.revealOrder==="unstable_legacy-backwards"||u.memoizedProps.revealOrder==="together")){if((u.flags&128)!==0)return u}else if(u.child!==null){u.child.return=u,u=u.child;continue}if(u===r)break;for(;u.sibling===null;){if(u.return===null||u.return===r)return null;u=u.return}u.sibling.return=u.return,u=u.sibling}return null}var Bn=0,Be=null,dt=null,jt=null,Dc=!1,Za=!1,la=!1,Pc=0,ir=0,eo=null,m1=0;function kt(){throw Error(s(321))}function Dd(r,u){if(u===null)return!1;for(var f=0;f<u.length&&f<r.length;f++)if(!Cs(r[f],u[f]))return!1;return!0}function Pd(r,u,f,m,w,C){return Bn=C,Be=u,u.memoizedState=null,u.updateQueue=null,u.lanes=0,z.H=r===null||r.memoizedState===null?qm:Vd,la=!1,C=f(m,w),la=!1,Za&&(C=im(u,f,m,w)),nm(r),C}function nm(r){z.H=rr;var u=dt!==null&&dt.next!==null;if(Bn=0,jt=dt=Be=null,Dc=!1,ir=0,eo=null,u)throw Error(s(300));r===null||Ot||(r=r.dependencies,r!==null&&wc(r)&&(Ot=!0))}function im(r,u,f,m){Be=r;var w=0;do{if(Za&&(eo=null),ir=0,Za=!1,25<=w)throw Error(s(301));if(w+=1,jt=dt=null,r.updateQueue!=null){var C=r.updateQueue;C.lastEffect=null,C.events=null,C.stores=null,C.memoCache!=null&&(C.memoCache.index=0)}z.H=Hm,C=u(f,m)}while(Za);return C}function y1(){var r=z.H,u=r.useState()[0];return u=typeof u.then=="function"?ar(u):u,r=r.useState()[0],(dt!==null?dt.memoizedState:null)!==r&&(Be.flags|=1024),u}function Ld(){var r=Pc!==0;return Pc=0,r}function _d(r,u,f){u.updateQueue=r.updateQueue,u.flags&=-2053,r.lanes&=~f}function Id(r){if(Dc){for(r=r.memoizedState;r!==null;){var u=r.queue;u!==null&&(u.pending=null),r=r.next}Dc=!1}Bn=0,jt=dt=Be=null,Za=!1,ir=Pc=0,eo=null}function us(){var r={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return jt===null?Be.memoizedState=jt=r:jt=jt.next=r,jt}function Lt(){if(dt===null){var r=Be.alternate;r=r!==null?r.memoizedState:null}else r=dt.next;var u=jt===null?Be.memoizedState:jt.next;if(u!==null)jt=u,dt=r;else{if(r===null)throw Be.alternate===null?Error(s(467)):Error(s(310));dt=r,r={memoizedState:dt.memoizedState,baseState:dt.baseState,baseQueue:dt.baseQueue,queue:dt.queue,next:null},jt===null?Be.memoizedState=jt=r:jt=jt.next=r}return jt}function Lc(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function ar(r){var u=ir;return ir+=1,eo===null&&(eo=[]),r=Wg(eo,r,u),u=Be,(jt===null?u.memoizedState:jt.next)===null&&(u=u.alternate,z.H=u===null||u.memoizedState===null?qm:Vd),r}function _c(r){if(r!==null&&typeof r=="object"){if(typeof r.then=="function")return ar(r);if(r.$$typeof===E)return es(r)}throw Error(s(438,String(r)))}function Nd(r){var u=null,f=Be.updateQueue;if(f!==null&&(u=f.memoCache),u==null){var m=Be.alternate;m!==null&&(m=m.updateQueue,m!==null&&(m=m.memoCache,m!=null&&(u={data:m.data.map(function(w){return w.slice()}),index:0})))}if(u==null&&(u={data:[],index:0}),f===null&&(f=Lc(),Be.updateQueue=f),f.memoCache=u,f=u.data[u.index],f===void 0)for(f=u.data[u.index]=Array(r),m=0;m<r;m++)f[m]=Q;return u.index++,f}function Un(r,u){return typeof u=="function"?u(r):u}function Ic(r){var u=Lt();return zd(u,dt,r)}function zd(r,u,f){var m=r.queue;if(m===null)throw Error(s(311));m.lastRenderedReducer=f;var w=r.baseQueue,C=m.pending;if(C!==null){if(w!==null){var P=w.next;w.next=C.next,C.next=P}u.baseQueue=w=C,m.pending=null}if(C=r.baseState,w===null)r.memoizedState=C;else{u=w.next;var _=P=null,O=null,W=u,oe=!1;do{var le=W.lane&-536870913;if(le!==W.lane?(Xe&le)===le:(Bn&le)===le){var X=W.revertLane;if(X===0)O!==null&&(O=O.next={lane:0,revertLane:0,gesture:null,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null}),le===Wa&&(oe=!0);else if((Bn&X)===X){W=W.next,X===Wa&&(oe=!0);continue}else le={lane:0,revertLane:W.revertLane,gesture:null,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null},O===null?(_=O=le,P=C):O=O.next=le,Be.lanes|=X,Si|=X;le=W.action,la&&f(C,le),C=W.hasEagerState?W.eagerState:f(C,le)}else X={lane:le,revertLane:W.revertLane,gesture:W.gesture,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null},O===null?(_=O=X,P=C):O=O.next=X,Be.lanes|=le,Si|=le;W=W.next}while(W!==null&&W!==u);if(O===null?P=C:O.next=_,!Cs(C,r.memoizedState)&&(Ot=!0,oe&&(f=Ka,f!==null)))throw f;r.memoizedState=C,r.baseState=P,r.baseQueue=O,m.lastRenderedState=C}return w===null&&(m.lanes=0),[r.memoizedState,m.dispatch]}function jd(r){var u=Lt(),f=u.queue;if(f===null)throw Error(s(311));f.lastRenderedReducer=r;var m=f.dispatch,w=f.pending,C=u.memoizedState;if(w!==null){f.pending=null;var P=w=w.next;do C=r(C,P.action),P=P.next;while(P!==w);Cs(C,u.memoizedState)||(Ot=!0),u.memoizedState=C,u.baseQueue===null&&(u.baseState=C),f.lastRenderedState=C}return[C,m]}function am(r,u,f){var m=Be,w=Lt(),C=st;if(C){if(f===void 0)throw Error(s(407));f=f()}else f=u();var P=!Cs((dt||w).memoizedState,f);if(P&&(w.memoizedState=f,Ot=!0),w=w.queue,Hd(cm.bind(null,m,w,r),[r]),w.getSnapshot!==u||P||jt!==null&&jt.memoizedState.tag&1){if(m.flags|=2048,to(9,{destroy:void 0},rm.bind(null,m,w,f,u),null),gt===null)throw Error(s(349));C||(Bn&127)!==0||om(m,u,f)}return f}function om(r,u,f){r.flags|=16384,r={getSnapshot:u,value:f},u=Be.updateQueue,u===null?(u=Lc(),Be.updateQueue=u,u.stores=[r]):(f=u.stores,f===null?u.stores=[r]:f.push(r))}function rm(r,u,f,m){u.value=f,u.getSnapshot=m,lm(u)&&um(r)}function cm(r,u,f){return f(function(){lm(u)&&um(r)})}function lm(r){var u=r.getSnapshot;r=r.value;try{var f=u();return!Cs(r,f)}catch{return!0}}function um(r){var u=ea(r,2);u!==null&&ys(u,r,2)}function Od(r){var u=us();if(typeof r=="function"){var f=r;if(r=f(),la){Gt(!0);try{f()}finally{Gt(!1)}}}return u.memoizedState=u.baseState=r,u.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Un,lastRenderedState:r},u}function dm(r,u,f,m){return r.baseState=f,zd(r,dt,typeof m=="function"?m:Un)}function v1(r,u,f,m,w){if(jc(r))throw Error(s(485));if(r=u.action,r!==null){var C={payload:w,action:r,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(P){C.listeners.push(P)}};z.T!==null?f(!0):C.isTransition=!1,m(C),f=u.pending,f===null?(C.next=u.pending=C,hm(u,C)):(C.next=f.next,u.pending=f.next=C)}}function hm(r,u){var f=u.action,m=u.payload,w=r.state;if(u.isTransition){var C=z.T,P={};z.T=P;try{var _=f(w,m),O=z.S;O!==null&&O(P,_),fm(r,u,_)}catch(W){qd(r,u,W)}finally{C!==null&&P.types!==null&&(C.types=P.types),z.T=C}}else try{C=f(w,m),fm(r,u,C)}catch(W){qd(r,u,W)}}function fm(r,u,f){f!==null&&typeof f=="object"&&typeof f.then=="function"?f.then(function(m){pm(r,u,m)},function(m){return qd(r,u,m)}):pm(r,u,f)}function pm(r,u,f){u.status="fulfilled",u.value=f,gm(u),r.state=f,u=r.pending,u!==null&&(f=u.next,f===u?r.pending=null:(f=f.next,u.next=f,hm(r,f)))}function qd(r,u,f){var m=r.pending;if(r.pending=null,m!==null){m=m.next;do u.status="rejected",u.reason=f,gm(u),u=u.next;while(u!==m)}r.action=null}function gm(r){r=r.listeners;for(var u=0;u<r.length;u++)(0,r[u])()}function mm(r,u){return u}function ym(r,u){if(st){var f=gt.formState;if(f!==null){e:{var m=Be;if(st){if(St){t:{for(var w=St,C=$s;w.nodeType!==8;){if(!C){w=null;break t}if(w=Us(w.nextSibling),w===null){w=null;break t}}C=w.data,w=C==="F!"||C==="F"?w:null}if(w){St=Us(w.nextSibling),m=w.data==="F!";break e}}fi(m)}m=!1}m&&(u=f[0])}}return f=us(),f.memoizedState=f.baseState=u,m={pending:null,lanes:0,dispatch:null,lastRenderedReducer:mm,lastRenderedState:u},f.queue=m,f=zm.bind(null,Be,m),m.dispatch=f,m=Od(!1),C=Qd.bind(null,Be,!1,m.queue),m=us(),w={state:u,dispatch:null,action:r,pending:null},m.queue=w,f=v1.bind(null,Be,w,C,f),w.dispatch=f,m.memoizedState=r,[u,f,!1]}function vm(r){var u=Lt();return bm(u,dt,r)}function bm(r,u,f){if(u=zd(r,u,mm)[0],r=Ic(Un)[0],typeof u=="object"&&u!==null&&typeof u.then=="function")try{var m=ar(u)}catch(P){throw P===Ya?Cc:P}else m=u;u=Lt();var w=u.queue,C=w.dispatch;return f!==u.memoizedState&&(Be.flags|=2048,to(9,{destroy:void 0},b1.bind(null,w,f),null)),[m,C,r]}function b1(r,u){r.action=u}function Mm(r){var u=Lt(),f=dt;if(f!==null)return bm(u,f,r);Lt(),u=u.memoizedState,f=Lt();var m=f.queue.dispatch;return f.memoizedState=r,[u,m,!1]}function to(r,u,f,m){return r={tag:r,create:f,deps:m,inst:u,next:null},u=Be.updateQueue,u===null&&(u=Lc(),Be.updateQueue=u),f=u.lastEffect,f===null?u.lastEffect=r.next=r:(m=f.next,f.next=r,r.next=m,u.lastEffect=r),r}function wm(){return Lt().memoizedState}function Nc(r,u,f,m){var w=us();Be.flags|=r,w.memoizedState=to(1|u,{destroy:void 0},f,m===void 0?null:m)}function zc(r,u,f,m){var w=Lt();m=m===void 0?null:m;var C=w.memoizedState.inst;dt!==null&&m!==null&&Dd(m,dt.memoizedState.deps)?w.memoizedState=to(u,C,f,m):(Be.flags|=r,w.memoizedState=to(1|u,C,f,m))}function Sm(r,u){Nc(8390656,8,r,u)}function Hd(r,u){zc(2048,8,r,u)}function M1(r){Be.flags|=4;var u=Be.updateQueue;if(u===null)u=Lc(),Be.updateQueue=u,u.events=[r];else{var f=u.events;f===null?u.events=[r]:f.push(r)}}function xm(r){var u=Lt().memoizedState;return M1({ref:u,nextImpl:r}),function(){if((rt&2)!==0)throw Error(s(440));return u.impl.apply(void 0,arguments)}}function Cm(r,u){return zc(4,2,r,u)}function Rm(r,u){return zc(4,4,r,u)}function Tm(r,u){if(typeof u=="function"){r=r();var f=u(r);return function(){typeof f=="function"?f():u(null)}}if(u!=null)return r=r(),u.current=r,function(){u.current=null}}function Em(r,u,f){f=f!=null?f.concat([r]):null,zc(4,4,Tm.bind(null,u,r),f)}function $d(){}function km(r,u){var f=Lt();u=u===void 0?null:u;var m=f.memoizedState;return u!==null&&Dd(u,m[1])?m[0]:(f.memoizedState=[r,u],r)}function Am(r,u){var f=Lt();u=u===void 0?null:u;var m=f.memoizedState;if(u!==null&&Dd(u,m[1]))return m[0];if(m=r(),la){Gt(!0);try{r()}finally{Gt(!1)}}return f.memoizedState=[m,u],m}function Bd(r,u,f){return f===void 0||(Bn&1073741824)!==0&&(Xe&261930)===0?r.memoizedState=u:(r.memoizedState=f,r=Dy(),Be.lanes|=r,Si|=r,f)}function Dm(r,u,f,m){return Cs(f,u)?f:Ja.current!==null?(r=Bd(r,f,m),Cs(r,u)||(Ot=!0),r):(Bn&42)===0||(Bn&1073741824)!==0&&(Xe&261930)===0?(Ot=!0,r.memoizedState=f):(r=Dy(),Be.lanes|=r,Si|=r,u)}function Pm(r,u,f,m,w){var C=$.p;$.p=C!==0&&8>C?C:8;var P=z.T,_={};z.T=_,Qd(r,!1,u,f);try{var O=w(),W=z.S;if(W!==null&&W(_,O),O!==null&&typeof O=="object"&&typeof O.then=="function"){var oe=g1(O,m);or(r,u,oe,Ds(r))}else or(r,u,m,Ds(r))}catch(le){or(r,u,{then:function(){},status:"rejected",reason:le},Ds())}finally{$.p=C,P!==null&&_.types!==null&&(P.types=_.types),z.T=P}}function w1(){}function Ud(r,u,f,m){if(r.tag!==5)throw Error(s(476));var w=Lm(r).queue;Pm(r,w,u,q,f===null?w1:function(){return _m(r),f(m)})}function Lm(r){var u=r.memoizedState;if(u!==null)return u;u={memoizedState:q,baseState:q,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Un,lastRenderedState:q},next:null};var f={};return u.next={memoizedState:f,baseState:f,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Un,lastRenderedState:f},next:null},r.memoizedState=u,r=r.alternate,r!==null&&(r.memoizedState=u),u}function _m(r){var u=Lm(r);u.next===null&&(u=r.alternate.memoizedState),or(r,u.next.queue,{},Ds())}function Fd(){return es(xr)}function Im(){return Lt().memoizedState}function Nm(){return Lt().memoizedState}function S1(r){for(var u=r.return;u!==null;){switch(u.tag){case 24:case 3:var f=Ds();r=mi(f);var m=yi(u,r,f);m!==null&&(ys(m,u,f),tr(m,u,f)),u={cache:bd()},r.payload=u;return}u=u.return}}function x1(r,u,f){var m=Ds();f={lane:m,revertLane:0,gesture:null,action:f,hasEagerState:!1,eagerState:null,next:null},jc(r)?jm(u,f):(f=cd(r,u,f,m),f!==null&&(ys(f,r,m),Om(f,u,m)))}function zm(r,u,f){var m=Ds();or(r,u,f,m)}function or(r,u,f,m){var w={lane:m,revertLane:0,gesture:null,action:f,hasEagerState:!1,eagerState:null,next:null};if(jc(r))jm(u,w);else{var C=r.alternate;if(r.lanes===0&&(C===null||C.lanes===0)&&(C=u.lastRenderedReducer,C!==null))try{var P=u.lastRenderedState,_=C(P,f);if(w.hasEagerState=!0,w.eagerState=_,Cs(_,P))return yc(r,u,w,0),gt===null&&mc(),!1}catch{}finally{}if(f=cd(r,u,w,m),f!==null)return ys(f,r,m),Om(f,u,m),!0}return!1}function Qd(r,u,f,m){if(m={lane:2,revertLane:xh(),gesture:null,action:m,hasEagerState:!1,eagerState:null,next:null},jc(r)){if(u)throw Error(s(479))}else u=cd(r,f,m,2),u!==null&&ys(u,r,2)}function jc(r){var u=r.alternate;return r===Be||u!==null&&u===Be}function jm(r,u){Za=Dc=!0;var f=r.pending;f===null?u.next=u:(u.next=f.next,f.next=u),r.pending=u}function Om(r,u,f){if((f&4194048)!==0){var m=u.lanes;m&=r.pendingLanes,f|=m,u.lanes=f,it(r,f)}}var rr={readContext:es,use:_c,useCallback:kt,useContext:kt,useEffect:kt,useImperativeHandle:kt,useLayoutEffect:kt,useInsertionEffect:kt,useMemo:kt,useReducer:kt,useRef:kt,useState:kt,useDebugValue:kt,useDeferredValue:kt,useTransition:kt,useSyncExternalStore:kt,useId:kt,useHostTransitionStatus:kt,useFormState:kt,useActionState:kt,useOptimistic:kt,useMemoCache:kt,useCacheRefresh:kt};rr.useEffectEvent=kt;var qm={readContext:es,use:_c,useCallback:function(r,u){return us().memoizedState=[r,u===void 0?null:u],r},useContext:es,useEffect:Sm,useImperativeHandle:function(r,u,f){f=f!=null?f.concat([r]):null,Nc(4194308,4,Tm.bind(null,u,r),f)},useLayoutEffect:function(r,u){return Nc(4194308,4,r,u)},useInsertionEffect:function(r,u){Nc(4,2,r,u)},useMemo:function(r,u){var f=us();u=u===void 0?null:u;var m=r();if(la){Gt(!0);try{r()}finally{Gt(!1)}}return f.memoizedState=[m,u],m},useReducer:function(r,u,f){var m=us();if(f!==void 0){var w=f(u);if(la){Gt(!0);try{f(u)}finally{Gt(!1)}}}else w=u;return m.memoizedState=m.baseState=w,r={pending:null,lanes:0,dispatch:null,lastRenderedReducer:r,lastRenderedState:w},m.queue=r,r=r.dispatch=x1.bind(null,Be,r),[m.memoizedState,r]},useRef:function(r){var u=us();return r={current:r},u.memoizedState=r},useState:function(r){r=Od(r);var u=r.queue,f=zm.bind(null,Be,u);return u.dispatch=f,[r.memoizedState,f]},useDebugValue:$d,useDeferredValue:function(r,u){var f=us();return Bd(f,r,u)},useTransition:function(){var r=Od(!1);return r=Pm.bind(null,Be,r.queue,!0,!1),us().memoizedState=r,[!1,r]},useSyncExternalStore:function(r,u,f){var m=Be,w=us();if(st){if(f===void 0)throw Error(s(407));f=f()}else{if(f=u(),gt===null)throw Error(s(349));(Xe&127)!==0||om(m,u,f)}w.memoizedState=f;var C={value:f,getSnapshot:u};return w.queue=C,Sm(cm.bind(null,m,C,r),[r]),m.flags|=2048,to(9,{destroy:void 0},rm.bind(null,m,C,f,u),null),f},useId:function(){var r=us(),u=gt.identifierPrefix;if(st){var f=yn,m=mn;f=(m&~(1<<32-Nt(m)-1)).toString(32)+f,u="_"+u+"R_"+f,f=Pc++,0<f&&(u+="H"+f.toString(32)),u+="_"}else f=m1++,u="_"+u+"r_"+f.toString(32)+"_";return r.memoizedState=u},useHostTransitionStatus:Fd,useFormState:ym,useActionState:ym,useOptimistic:function(r){var u=us();u.memoizedState=u.baseState=r;var f={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return u.queue=f,u=Qd.bind(null,Be,!0,f),f.dispatch=u,[r,u]},useMemoCache:Nd,useCacheRefresh:function(){return us().memoizedState=S1.bind(null,Be)},useEffectEvent:function(r){var u=us(),f={impl:r};return u.memoizedState=f,function(){if((rt&2)!==0)throw Error(s(440));return f.impl.apply(void 0,arguments)}}},Vd={readContext:es,use:_c,useCallback:km,useContext:es,useEffect:Hd,useImperativeHandle:Em,useInsertionEffect:Cm,useLayoutEffect:Rm,useMemo:Am,useReducer:Ic,useRef:wm,useState:function(){return Ic(Un)},useDebugValue:$d,useDeferredValue:function(r,u){var f=Lt();return Dm(f,dt.memoizedState,r,u)},useTransition:function(){var r=Ic(Un)[0],u=Lt().memoizedState;return[typeof r=="boolean"?r:ar(r),u]},useSyncExternalStore:am,useId:Im,useHostTransitionStatus:Fd,useFormState:vm,useActionState:vm,useOptimistic:function(r,u){var f=Lt();return dm(f,dt,r,u)},useMemoCache:Nd,useCacheRefresh:Nm};Vd.useEffectEvent=xm;var Hm={readContext:es,use:_c,useCallback:km,useContext:es,useEffect:Hd,useImperativeHandle:Em,useInsertionEffect:Cm,useLayoutEffect:Rm,useMemo:Am,useReducer:jd,useRef:wm,useState:function(){return jd(Un)},useDebugValue:$d,useDeferredValue:function(r,u){var f=Lt();return dt===null?Bd(f,r,u):Dm(f,dt.memoizedState,r,u)},useTransition:function(){var r=jd(Un)[0],u=Lt().memoizedState;return[typeof r=="boolean"?r:ar(r),u]},useSyncExternalStore:am,useId:Im,useHostTransitionStatus:Fd,useFormState:Mm,useActionState:Mm,useOptimistic:function(r,u){var f=Lt();return dt!==null?dm(f,dt,r,u):(f.baseState=r,[r,f.queue.dispatch])},useMemoCache:Nd,useCacheRefresh:Nm};Hm.useEffectEvent=xm;function Gd(r,u,f,m){u=r.memoizedState,f=f(m,u),f=f==null?u:p({},u,f),r.memoizedState=f,r.lanes===0&&(r.updateQueue.baseState=f)}var Wd={enqueueSetState:function(r,u,f){r=r._reactInternals;var m=Ds(),w=mi(m);w.payload=u,f!=null&&(w.callback=f),u=yi(r,w,m),u!==null&&(ys(u,r,m),tr(u,r,m))},enqueueReplaceState:function(r,u,f){r=r._reactInternals;var m=Ds(),w=mi(m);w.tag=1,w.payload=u,f!=null&&(w.callback=f),u=yi(r,w,m),u!==null&&(ys(u,r,m),tr(u,r,m))},enqueueForceUpdate:function(r,u){r=r._reactInternals;var f=Ds(),m=mi(f);m.tag=2,u!=null&&(m.callback=u),u=yi(r,m,f),u!==null&&(ys(u,r,f),tr(u,r,f))}};function $m(r,u,f,m,w,C,P){return r=r.stateNode,typeof r.shouldComponentUpdate=="function"?r.shouldComponentUpdate(m,C,P):u.prototype&&u.prototype.isPureReactComponent?!Go(f,m)||!Go(w,C):!0}function Bm(r,u,f,m){r=u.state,typeof u.componentWillReceiveProps=="function"&&u.componentWillReceiveProps(f,m),typeof u.UNSAFE_componentWillReceiveProps=="function"&&u.UNSAFE_componentWillReceiveProps(f,m),u.state!==r&&Wd.enqueueReplaceState(u,u.state,null)}function ua(r,u){var f=u;if("ref"in u){f={};for(var m in u)m!=="ref"&&(f[m]=u[m])}if(r=r.defaultProps){f===u&&(f=p({},f));for(var w in r)f[w]===void 0&&(f[w]=r[w])}return f}function Um(r){gc(r)}function Fm(r){console.error(r)}function Qm(r){gc(r)}function Oc(r,u){try{var f=r.onUncaughtError;f(u.value,{componentStack:u.stack})}catch(m){setTimeout(function(){throw m})}}function Vm(r,u,f){try{var m=r.onCaughtError;m(f.value,{componentStack:f.stack,errorBoundary:u.tag===1?u.stateNode:null})}catch(w){setTimeout(function(){throw w})}}function Kd(r,u,f){return f=mi(f),f.tag=3,f.payload={element:null},f.callback=function(){Oc(r,u)},f}function Gm(r){return r=mi(r),r.tag=3,r}function Wm(r,u,f,m){var w=f.type.getDerivedStateFromError;if(typeof w=="function"){var C=m.value;r.payload=function(){return w(C)},r.callback=function(){Vm(u,f,m)}}var P=f.stateNode;P!==null&&typeof P.componentDidCatch=="function"&&(r.callback=function(){Vm(u,f,m),typeof w!="function"&&(xi===null?xi=new Set([this]):xi.add(this));var _=m.stack;this.componentDidCatch(m.value,{componentStack:_!==null?_:""})})}function C1(r,u,f,m,w){if(f.flags|=32768,m!==null&&typeof m=="object"&&typeof m.then=="function"){if(u=f.alternate,u!==null&&Ga(u,f,w,!0),f=Ts.current,f!==null){switch(f.tag){case 31:case 13:return Bs===null?Yc():f.alternate===null&&At===0&&(At=3),f.flags&=-257,f.flags|=65536,f.lanes=w,m===Rc?f.flags|=16384:(u=f.updateQueue,u===null?f.updateQueue=new Set([m]):u.add(m),Mh(r,m,w)),!1;case 22:return f.flags|=65536,m===Rc?f.flags|=16384:(u=f.updateQueue,u===null?(u={transitions:null,markerInstances:null,retryQueue:new Set([m])},f.updateQueue=u):(f=u.retryQueue,f===null?u.retryQueue=new Set([m]):f.add(m)),Mh(r,m,w)),!1}throw Error(s(435,f.tag))}return Mh(r,m,w),Yc(),!1}if(st)return u=Ts.current,u!==null?((u.flags&65536)===0&&(u.flags|=256),u.flags|=65536,u.lanes=w,m!==pd&&(r=Error(s(422),{cause:m}),Yo(Os(r,f)))):(m!==pd&&(u=Error(s(423),{cause:m}),Yo(Os(u,f))),r=r.current.alternate,r.flags|=65536,w&=-w,r.lanes|=w,m=Os(m,f),w=Kd(r.stateNode,m,w),Rd(r,w),At!==4&&(At=2)),!1;var C=Error(s(520),{cause:m});if(C=Os(C,f),gr===null?gr=[C]:gr.push(C),At!==4&&(At=2),u===null)return!0;m=Os(m,f),f=u;do{switch(f.tag){case 3:return f.flags|=65536,r=w&-w,f.lanes|=r,r=Kd(f.stateNode,m,r),Rd(f,r),!1;case 1:if(u=f.type,C=f.stateNode,(f.flags&128)===0&&(typeof u.getDerivedStateFromError=="function"||C!==null&&typeof C.componentDidCatch=="function"&&(xi===null||!xi.has(C))))return f.flags|=65536,w&=-w,f.lanes|=w,w=Gm(w),Wm(w,r,f,m),Rd(f,w),!1}f=f.return}while(f!==null);return!1}var Yd=Error(s(461)),Ot=!1;function ts(r,u,f,m){u.child=r===null?Jg(u,null,f,m):ca(u,r.child,f,m)}function Km(r,u,f,m,w){f=f.render;var C=u.ref;if("ref"in m){var P={};for(var _ in m)_!=="ref"&&(P[_]=m[_])}else P=m;return ia(u),m=Pd(r,u,f,P,C,w),_=Ld(),r!==null&&!Ot?(_d(r,u,w),Fn(r,u,w)):(st&&_&&hd(u),u.flags|=1,ts(r,u,m,w),u.child)}function Ym(r,u,f,m,w){if(r===null){var C=f.type;return typeof C=="function"&&!ld(C)&&C.defaultProps===void 0&&f.compare===null?(u.tag=15,u.type=C,Xm(r,u,C,m,w)):(r=bc(f.type,null,m,u,u.mode,w),r.ref=u.ref,r.return=u,u.child=r)}if(C=r.child,!ih(r,w)){var P=C.memoizedProps;if(f=f.compare,f=f!==null?f:Go,f(P,m)&&r.ref===u.ref)return Fn(r,u,w)}return u.flags|=1,r=On(C,m),r.ref=u.ref,r.return=u,u.child=r}function Xm(r,u,f,m,w){if(r!==null){var C=r.memoizedProps;if(Go(C,m)&&r.ref===u.ref)if(Ot=!1,u.pendingProps=m=C,ih(r,w))(r.flags&131072)!==0&&(Ot=!0);else return u.lanes=r.lanes,Fn(r,u,w)}return Xd(r,u,f,m,w)}function Jm(r,u,f,m){var w=m.children,C=r!==null?r.memoizedState:null;if(r===null&&u.stateNode===null&&(u.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),m.mode==="hidden"){if((u.flags&128)!==0){if(C=C!==null?C.baseLanes|f:f,r!==null){for(m=u.child=r.child,w=0;m!==null;)w=w|m.lanes|m.childLanes,m=m.sibling;m=w&~C}else m=0,u.child=null;return Zm(r,u,C,f,m)}if((f&536870912)!==0)u.memoizedState={baseLanes:0,cachePool:null},r!==null&&xc(u,C!==null?C.cachePool:null),C!==null?tm(u,C):Ed(),sm(u);else return m=u.lanes=536870912,Zm(r,u,C!==null?C.baseLanes|f:f,f,m)}else C!==null?(xc(u,C.cachePool),tm(u,C),bi(),u.memoizedState=null):(r!==null&&xc(u,null),Ed(),bi());return ts(r,u,w,f),u.child}function cr(r,u){return r!==null&&r.tag===22||u.stateNode!==null||(u.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),u.sibling}function Zm(r,u,f,m,w){var C=wd();return C=C===null?null:{parent:zt._currentValue,pool:C},u.memoizedState={baseLanes:f,cachePool:C},r!==null&&xc(u,null),Ed(),sm(u),r!==null&&Ga(r,u,m,!0),u.childLanes=w,null}function qc(r,u){return u=$c({mode:u.mode,children:u.children},r.mode),u.ref=r.ref,r.child=u,u.return=r,u}function ey(r,u,f){return ca(u,r.child,null,f),r=qc(u,u.pendingProps),r.flags|=2,Es(u),u.memoizedState=null,r}function R1(r,u,f){var m=u.pendingProps,w=(u.flags&128)!==0;if(u.flags&=-129,r===null){if(st){if(m.mode==="hidden")return r=qc(u,m),u.lanes=536870912,cr(null,r);if(Ad(u),(r=St)?(r=h0(r,$s),r=r!==null&&r.data==="&"?r:null,r!==null&&(u.memoizedState={dehydrated:r,treeContext:di!==null?{id:mn,overflow:yn}:null,retryLane:536870912,hydrationErrors:null},f=jg(r),f.return=u,u.child=f,Zt=u,St=null)):r=null,r===null)throw fi(u);return u.lanes=536870912,null}return qc(u,m)}var C=r.memoizedState;if(C!==null){var P=C.dehydrated;if(Ad(u),w)if(u.flags&256)u.flags&=-257,u=ey(r,u,f);else if(u.memoizedState!==null)u.child=r.child,u.flags|=128,u=null;else throw Error(s(558));else if(Ot||Ga(r,u,f,!1),w=(f&r.childLanes)!==0,Ot||w){if(m=gt,m!==null&&(P=Wt(m,f),P!==0&&P!==C.retryLane))throw C.retryLane=P,ea(r,P),ys(m,r,P),Yd;Yc(),u=ey(r,u,f)}else r=C.treeContext,St=Us(P.nextSibling),Zt=u,st=!0,hi=null,$s=!1,r!==null&&Hg(u,r),u=qc(u,m),u.flags|=4096;return u}return r=On(r.child,{mode:m.mode,children:m.children}),r.ref=u.ref,u.child=r,r.return=u,r}function Hc(r,u){var f=u.ref;if(f===null)r!==null&&r.ref!==null&&(u.flags|=4194816);else{if(typeof f!="function"&&typeof f!="object")throw Error(s(284));(r===null||r.ref!==f)&&(u.flags|=4194816)}}function Xd(r,u,f,m,w){return ia(u),f=Pd(r,u,f,m,void 0,w),m=Ld(),r!==null&&!Ot?(_d(r,u,w),Fn(r,u,w)):(st&&m&&hd(u),u.flags|=1,ts(r,u,f,w),u.child)}function ty(r,u,f,m,w,C){return ia(u),u.updateQueue=null,f=im(u,m,f,w),nm(r),m=Ld(),r!==null&&!Ot?(_d(r,u,C),Fn(r,u,C)):(st&&m&&hd(u),u.flags|=1,ts(r,u,f,C),u.child)}function sy(r,u,f,m,w){if(ia(u),u.stateNode===null){var C=Ua,P=f.contextType;typeof P=="object"&&P!==null&&(C=es(P)),C=new f(m,C),u.memoizedState=C.state!==null&&C.state!==void 0?C.state:null,C.updater=Wd,u.stateNode=C,C._reactInternals=u,C=u.stateNode,C.props=m,C.state=u.memoizedState,C.refs={},xd(u),P=f.contextType,C.context=typeof P=="object"&&P!==null?es(P):Ua,C.state=u.memoizedState,P=f.getDerivedStateFromProps,typeof P=="function"&&(Gd(u,f,P,m),C.state=u.memoizedState),typeof f.getDerivedStateFromProps=="function"||typeof C.getSnapshotBeforeUpdate=="function"||typeof C.UNSAFE_componentWillMount!="function"&&typeof C.componentWillMount!="function"||(P=C.state,typeof C.componentWillMount=="function"&&C.componentWillMount(),typeof C.UNSAFE_componentWillMount=="function"&&C.UNSAFE_componentWillMount(),P!==C.state&&Wd.enqueueReplaceState(C,C.state,null),nr(u,m,C,w),sr(),C.state=u.memoizedState),typeof C.componentDidMount=="function"&&(u.flags|=4194308),m=!0}else if(r===null){C=u.stateNode;var _=u.memoizedProps,O=ua(f,_);C.props=O;var W=C.context,oe=f.contextType;P=Ua,typeof oe=="object"&&oe!==null&&(P=es(oe));var le=f.getDerivedStateFromProps;oe=typeof le=="function"||typeof C.getSnapshotBeforeUpdate=="function",_=u.pendingProps!==_,oe||typeof C.UNSAFE_componentWillReceiveProps!="function"&&typeof C.componentWillReceiveProps!="function"||(_||W!==P)&&Bm(u,C,m,P),gi=!1;var X=u.memoizedState;C.state=X,nr(u,m,C,w),sr(),W=u.memoizedState,_||X!==W||gi?(typeof le=="function"&&(Gd(u,f,le,m),W=u.memoizedState),(O=gi||$m(u,f,O,m,X,W,P))?(oe||typeof C.UNSAFE_componentWillMount!="function"&&typeof C.componentWillMount!="function"||(typeof C.componentWillMount=="function"&&C.componentWillMount(),typeof C.UNSAFE_componentWillMount=="function"&&C.UNSAFE_componentWillMount()),typeof C.componentDidMount=="function"&&(u.flags|=4194308)):(typeof C.componentDidMount=="function"&&(u.flags|=4194308),u.memoizedProps=m,u.memoizedState=W),C.props=m,C.state=W,C.context=P,m=O):(typeof C.componentDidMount=="function"&&(u.flags|=4194308),m=!1)}else{C=u.stateNode,Cd(r,u),P=u.memoizedProps,oe=ua(f,P),C.props=oe,le=u.pendingProps,X=C.context,W=f.contextType,O=Ua,typeof W=="object"&&W!==null&&(O=es(W)),_=f.getDerivedStateFromProps,(W=typeof _=="function"||typeof C.getSnapshotBeforeUpdate=="function")||typeof C.UNSAFE_componentWillReceiveProps!="function"&&typeof C.componentWillReceiveProps!="function"||(P!==le||X!==O)&&Bm(u,C,m,O),gi=!1,X=u.memoizedState,C.state=X,nr(u,m,C,w),sr();var te=u.memoizedState;P!==le||X!==te||gi||r!==null&&r.dependencies!==null&&wc(r.dependencies)?(typeof _=="function"&&(Gd(u,f,_,m),te=u.memoizedState),(oe=gi||$m(u,f,oe,m,X,te,O)||r!==null&&r.dependencies!==null&&wc(r.dependencies))?(W||typeof C.UNSAFE_componentWillUpdate!="function"&&typeof C.componentWillUpdate!="function"||(typeof C.componentWillUpdate=="function"&&C.componentWillUpdate(m,te,O),typeof C.UNSAFE_componentWillUpdate=="function"&&C.UNSAFE_componentWillUpdate(m,te,O)),typeof C.componentDidUpdate=="function"&&(u.flags|=4),typeof C.getSnapshotBeforeUpdate=="function"&&(u.flags|=1024)):(typeof C.componentDidUpdate!="function"||P===r.memoizedProps&&X===r.memoizedState||(u.flags|=4),typeof C.getSnapshotBeforeUpdate!="function"||P===r.memoizedProps&&X===r.memoizedState||(u.flags|=1024),u.memoizedProps=m,u.memoizedState=te),C.props=m,C.state=te,C.context=O,m=oe):(typeof C.componentDidUpdate!="function"||P===r.memoizedProps&&X===r.memoizedState||(u.flags|=4),typeof C.getSnapshotBeforeUpdate!="function"||P===r.memoizedProps&&X===r.memoizedState||(u.flags|=1024),m=!1)}return C=m,Hc(r,u),m=(u.flags&128)!==0,C||m?(C=u.stateNode,f=m&&typeof f.getDerivedStateFromError!="function"?null:C.render(),u.flags|=1,r!==null&&m?(u.child=ca(u,r.child,null,w),u.child=ca(u,null,f,w)):ts(r,u,f,w),u.memoizedState=C.state,r=u.child):r=Fn(r,u,w),r}function ny(r,u,f,m){return sa(),u.flags|=256,ts(r,u,f,m),u.child}var Jd={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function Zd(r){return{baseLanes:r,cachePool:Vg()}}function eh(r,u,f){return r=r!==null?r.childLanes&~f:0,u&&(r|=As),r}function iy(r,u,f){var m=u.pendingProps,w=!1,C=(u.flags&128)!==0,P;if((P=C)||(P=r!==null&&r.memoizedState===null?!1:(Pt.current&2)!==0),P&&(w=!0,u.flags&=-129),P=(u.flags&32)!==0,u.flags&=-33,r===null){if(st){if(w?vi(u):bi(),(r=St)?(r=h0(r,$s),r=r!==null&&r.data!=="&"?r:null,r!==null&&(u.memoizedState={dehydrated:r,treeContext:di!==null?{id:mn,overflow:yn}:null,retryLane:536870912,hydrationErrors:null},f=jg(r),f.return=u,u.child=f,Zt=u,St=null)):r=null,r===null)throw fi(u);return zh(r)?u.lanes=32:u.lanes=536870912,null}var _=m.children;return m=m.fallback,w?(bi(),w=u.mode,_=$c({mode:"hidden",children:_},w),m=ta(m,w,f,null),_.return=u,m.return=u,_.sibling=m,u.child=_,m=u.child,m.memoizedState=Zd(f),m.childLanes=eh(r,P,f),u.memoizedState=Jd,cr(null,m)):(vi(u),th(u,_))}var O=r.memoizedState;if(O!==null&&(_=O.dehydrated,_!==null)){if(C)u.flags&256?(vi(u),u.flags&=-257,u=sh(r,u,f)):u.memoizedState!==null?(bi(),u.child=r.child,u.flags|=128,u=null):(bi(),_=m.fallback,w=u.mode,m=$c({mode:"visible",children:m.children},w),_=ta(_,w,f,null),_.flags|=2,m.return=u,_.return=u,m.sibling=_,u.child=m,ca(u,r.child,null,f),m=u.child,m.memoizedState=Zd(f),m.childLanes=eh(r,P,f),u.memoizedState=Jd,u=cr(null,m));else if(vi(u),zh(_)){if(P=_.nextSibling&&_.nextSibling.dataset,P)var W=P.dgst;P=W,m=Error(s(419)),m.stack="",m.digest=P,Yo({value:m,source:null,stack:null}),u=sh(r,u,f)}else if(Ot||Ga(r,u,f,!1),P=(f&r.childLanes)!==0,Ot||P){if(P=gt,P!==null&&(m=Wt(P,f),m!==0&&m!==O.retryLane))throw O.retryLane=m,ea(r,m),ys(P,r,m),Yd;Nh(_)||Yc(),u=sh(r,u,f)}else Nh(_)?(u.flags|=192,u.child=r.child,u=null):(r=O.treeContext,St=Us(_.nextSibling),Zt=u,st=!0,hi=null,$s=!1,r!==null&&Hg(u,r),u=th(u,m.children),u.flags|=4096);return u}return w?(bi(),_=m.fallback,w=u.mode,O=r.child,W=O.sibling,m=On(O,{mode:"hidden",children:m.children}),m.subtreeFlags=O.subtreeFlags&65011712,W!==null?_=On(W,_):(_=ta(_,w,f,null),_.flags|=2),_.return=u,m.return=u,m.sibling=_,u.child=m,cr(null,m),m=u.child,_=r.child.memoizedState,_===null?_=Zd(f):(w=_.cachePool,w!==null?(O=zt._currentValue,w=w.parent!==O?{parent:O,pool:O}:w):w=Vg(),_={baseLanes:_.baseLanes|f,cachePool:w}),m.memoizedState=_,m.childLanes=eh(r,P,f),u.memoizedState=Jd,cr(r.child,m)):(vi(u),f=r.child,r=f.sibling,f=On(f,{mode:"visible",children:m.children}),f.return=u,f.sibling=null,r!==null&&(P=u.deletions,P===null?(u.deletions=[r],u.flags|=16):P.push(r)),u.child=f,u.memoizedState=null,f)}function th(r,u){return u=$c({mode:"visible",children:u},r.mode),u.return=r,r.child=u}function $c(r,u){return r=Rs(22,r,null,u),r.lanes=0,r}function sh(r,u,f){return ca(u,r.child,null,f),r=th(u,u.pendingProps.children),r.flags|=2,u.memoizedState=null,r}function ay(r,u,f){r.lanes|=u;var m=r.alternate;m!==null&&(m.lanes|=u),yd(r.return,u,f)}function nh(r,u,f,m,w,C){var P=r.memoizedState;P===null?r.memoizedState={isBackwards:u,rendering:null,renderingStartTime:0,last:m,tail:f,tailMode:w,treeForkCount:C}:(P.isBackwards=u,P.rendering=null,P.renderingStartTime=0,P.last=m,P.tail=f,P.tailMode=w,P.treeForkCount=C)}function oy(r,u,f){var m=u.pendingProps,w=m.revealOrder,C=m.tail;m=m.children;var P=Pt.current,_=(P&2)!==0;if(_?(P=P&1|2,u.flags|=128):P&=1,K(Pt,P),ts(r,u,m,f),m=st?Ko:0,!_&&r!==null&&(r.flags&128)!==0)e:for(r=u.child;r!==null;){if(r.tag===13)r.memoizedState!==null&&ay(r,f,u);else if(r.tag===19)ay(r,f,u);else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===u)break e;for(;r.sibling===null;){if(r.return===null||r.return===u)break e;r=r.return}r.sibling.return=r.return,r=r.sibling}switch(w){case"forwards":for(f=u.child,w=null;f!==null;)r=f.alternate,r!==null&&Ac(r)===null&&(w=f),f=f.sibling;f=w,f===null?(w=u.child,u.child=null):(w=f.sibling,f.sibling=null),nh(u,!1,w,f,C,m);break;case"backwards":case"unstable_legacy-backwards":for(f=null,w=u.child,u.child=null;w!==null;){if(r=w.alternate,r!==null&&Ac(r)===null){u.child=w;break}r=w.sibling,w.sibling=f,f=w,w=r}nh(u,!0,f,null,C,m);break;case"together":nh(u,!1,null,null,void 0,m);break;default:u.memoizedState=null}return u.child}function Fn(r,u,f){if(r!==null&&(u.dependencies=r.dependencies),Si|=u.lanes,(f&u.childLanes)===0)if(r!==null){if(Ga(r,u,f,!1),(f&u.childLanes)===0)return null}else return null;if(r!==null&&u.child!==r.child)throw Error(s(153));if(u.child!==null){for(r=u.child,f=On(r,r.pendingProps),u.child=f,f.return=u;r.sibling!==null;)r=r.sibling,f=f.sibling=On(r,r.pendingProps),f.return=u;f.sibling=null}return u.child}function ih(r,u){return(r.lanes&u)!==0?!0:(r=r.dependencies,!!(r!==null&&wc(r)))}function T1(r,u,f){switch(u.tag){case 3:j(u,u.stateNode.containerInfo),pi(u,zt,r.memoizedState.cache),sa();break;case 27:case 5:fe(u);break;case 4:j(u,u.stateNode.containerInfo);break;case 10:pi(u,u.type,u.memoizedProps.value);break;case 31:if(u.memoizedState!==null)return u.flags|=128,Ad(u),null;break;case 13:var m=u.memoizedState;if(m!==null)return m.dehydrated!==null?(vi(u),u.flags|=128,null):(f&u.child.childLanes)!==0?iy(r,u,f):(vi(u),r=Fn(r,u,f),r!==null?r.sibling:null);vi(u);break;case 19:var w=(r.flags&128)!==0;if(m=(f&u.childLanes)!==0,m||(Ga(r,u,f,!1),m=(f&u.childLanes)!==0),w){if(m)return oy(r,u,f);u.flags|=128}if(w=u.memoizedState,w!==null&&(w.rendering=null,w.tail=null,w.lastEffect=null),K(Pt,Pt.current),m)break;return null;case 22:return u.lanes=0,Jm(r,u,f,u.pendingProps);case 24:pi(u,zt,r.memoizedState.cache)}return Fn(r,u,f)}function ry(r,u,f){if(r!==null)if(r.memoizedProps!==u.pendingProps)Ot=!0;else{if(!ih(r,f)&&(u.flags&128)===0)return Ot=!1,T1(r,u,f);Ot=(r.flags&131072)!==0}else Ot=!1,st&&(u.flags&1048576)!==0&&qg(u,Ko,u.index);switch(u.lanes=0,u.tag){case 16:e:{var m=u.pendingProps;if(r=oa(u.elementType),u.type=r,typeof r=="function")ld(r)?(m=ua(r,m),u.tag=1,u=sy(null,u,r,m,f)):(u.tag=0,u=Xd(null,u,r,m,f));else{if(r!=null){var w=r.$$typeof;if(w===A){u.tag=11,u=Km(null,u,r,m,f);break e}else if(w===L){u.tag=14,u=Ym(null,u,r,m,f);break e}}throw u=ae(r)||r,Error(s(306,u,""))}}return u;case 0:return Xd(r,u,u.type,u.pendingProps,f);case 1:return m=u.type,w=ua(m,u.pendingProps),sy(r,u,m,w,f);case 3:e:{if(j(u,u.stateNode.containerInfo),r===null)throw Error(s(387));m=u.pendingProps;var C=u.memoizedState;w=C.element,Cd(r,u),nr(u,m,null,f);var P=u.memoizedState;if(m=P.cache,pi(u,zt,m),m!==C.cache&&vd(u,[zt],f,!0),sr(),m=P.element,C.isDehydrated)if(C={element:m,isDehydrated:!1,cache:P.cache},u.updateQueue.baseState=C,u.memoizedState=C,u.flags&256){u=ny(r,u,m,f);break e}else if(m!==w){w=Os(Error(s(424)),u),Yo(w),u=ny(r,u,m,f);break e}else{switch(r=u.stateNode.containerInfo,r.nodeType){case 9:r=r.body;break;default:r=r.nodeName==="HTML"?r.ownerDocument.body:r}for(St=Us(r.firstChild),Zt=u,st=!0,hi=null,$s=!0,f=Jg(u,null,m,f),u.child=f;f;)f.flags=f.flags&-3|4096,f=f.sibling}else{if(sa(),m===w){u=Fn(r,u,f);break e}ts(r,u,m,f)}u=u.child}return u;case 26:return Hc(r,u),r===null?(f=v0(u.type,null,u.pendingProps,null))?u.memoizedState=f:st||(f=u.type,r=u.pendingProps,m=nl(re.current).createElement(f),m[bt]=u,m[Bt]=r,ss(m,f,r),Kt(m),u.stateNode=m):u.memoizedState=v0(u.type,r.memoizedProps,u.pendingProps,r.memoizedState),null;case 27:return fe(u),r===null&&st&&(m=u.stateNode=g0(u.type,u.pendingProps,re.current),Zt=u,$s=!0,w=St,Ei(u.type)?(jh=w,St=Us(m.firstChild)):St=w),ts(r,u,u.pendingProps.children,f),Hc(r,u),r===null&&(u.flags|=4194304),u.child;case 5:return r===null&&st&&((w=m=St)&&(m=sR(m,u.type,u.pendingProps,$s),m!==null?(u.stateNode=m,Zt=u,St=Us(m.firstChild),$s=!1,w=!0):w=!1),w||fi(u)),fe(u),w=u.type,C=u.pendingProps,P=r!==null?r.memoizedProps:null,m=C.children,Lh(w,C)?m=null:P!==null&&Lh(w,P)&&(u.flags|=32),u.memoizedState!==null&&(w=Pd(r,u,y1,null,null,f),xr._currentValue=w),Hc(r,u),ts(r,u,m,f),u.child;case 6:return r===null&&st&&((r=f=St)&&(f=nR(f,u.pendingProps,$s),f!==null?(u.stateNode=f,Zt=u,St=null,r=!0):r=!1),r||fi(u)),null;case 13:return iy(r,u,f);case 4:return j(u,u.stateNode.containerInfo),m=u.pendingProps,r===null?u.child=ca(u,null,m,f):ts(r,u,m,f),u.child;case 11:return Km(r,u,u.type,u.pendingProps,f);case 7:return ts(r,u,u.pendingProps,f),u.child;case 8:return ts(r,u,u.pendingProps.children,f),u.child;case 12:return ts(r,u,u.pendingProps.children,f),u.child;case 10:return m=u.pendingProps,pi(u,u.type,m.value),ts(r,u,m.children,f),u.child;case 9:return w=u.type._context,m=u.pendingProps.children,ia(u),w=es(w),m=m(w),u.flags|=1,ts(r,u,m,f),u.child;case 14:return Ym(r,u,u.type,u.pendingProps,f);case 15:return Xm(r,u,u.type,u.pendingProps,f);case 19:return oy(r,u,f);case 31:return R1(r,u,f);case 22:return Jm(r,u,f,u.pendingProps);case 24:return ia(u),m=es(zt),r===null?(w=wd(),w===null&&(w=gt,C=bd(),w.pooledCache=C,C.refCount++,C!==null&&(w.pooledCacheLanes|=f),w=C),u.memoizedState={parent:m,cache:w},xd(u),pi(u,zt,w)):((r.lanes&f)!==0&&(Cd(r,u),nr(u,null,null,f),sr()),w=r.memoizedState,C=u.memoizedState,w.parent!==m?(w={parent:m,cache:m},u.memoizedState=w,u.lanes===0&&(u.memoizedState=u.updateQueue.baseState=w),pi(u,zt,m)):(m=C.cache,pi(u,zt,m),m!==w.cache&&vd(u,[zt],f,!0))),ts(r,u,u.pendingProps.children,f),u.child;case 29:throw u.pendingProps}throw Error(s(156,u.tag))}function Qn(r){r.flags|=4}function ah(r,u,f,m,w){if((u=(r.mode&32)!==0)&&(u=!1),u){if(r.flags|=16777216,(w&335544128)===w)if(r.stateNode.complete)r.flags|=8192;else if(Iy())r.flags|=8192;else throw ra=Rc,Sd}else r.flags&=-16777217}function cy(r,u){if(u.type!=="stylesheet"||(u.state.loading&4)!==0)r.flags&=-16777217;else if(r.flags|=16777216,!x0(u))if(Iy())r.flags|=8192;else throw ra=Rc,Sd}function Bc(r,u){u!==null&&(r.flags|=4),r.flags&16384&&(u=r.tag!==22?ne():536870912,r.lanes|=u,ao|=u)}function lr(r,u){if(!st)switch(r.tailMode){case"hidden":u=r.tail;for(var f=null;u!==null;)u.alternate!==null&&(f=u),u=u.sibling;f===null?r.tail=null:f.sibling=null;break;case"collapsed":f=r.tail;for(var m=null;f!==null;)f.alternate!==null&&(m=f),f=f.sibling;m===null?u||r.tail===null?r.tail=null:r.tail.sibling=null:m.sibling=null}}function xt(r){var u=r.alternate!==null&&r.alternate.child===r.child,f=0,m=0;if(u)for(var w=r.child;w!==null;)f|=w.lanes|w.childLanes,m|=w.subtreeFlags&65011712,m|=w.flags&65011712,w.return=r,w=w.sibling;else for(w=r.child;w!==null;)f|=w.lanes|w.childLanes,m|=w.subtreeFlags,m|=w.flags,w.return=r,w=w.sibling;return r.subtreeFlags|=m,r.childLanes=f,u}function E1(r,u,f){var m=u.pendingProps;switch(fd(u),u.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return xt(u),null;case 1:return xt(u),null;case 3:return f=u.stateNode,m=null,r!==null&&(m=r.memoizedState.cache),u.memoizedState.cache!==m&&(u.flags|=2048),$n(zt),ue(),f.pendingContext&&(f.context=f.pendingContext,f.pendingContext=null),(r===null||r.child===null)&&(Va(u)?Qn(u):r===null||r.memoizedState.isDehydrated&&(u.flags&256)===0||(u.flags|=1024,gd())),xt(u),null;case 26:var w=u.type,C=u.memoizedState;return r===null?(Qn(u),C!==null?(xt(u),cy(u,C)):(xt(u),ah(u,w,null,m,f))):C?C!==r.memoizedState?(Qn(u),xt(u),cy(u,C)):(xt(u),u.flags&=-16777217):(r=r.memoizedProps,r!==m&&Qn(u),xt(u),ah(u,w,r,m,f)),null;case 27:if(ge(u),f=re.current,w=u.type,r!==null&&u.stateNode!=null)r.memoizedProps!==m&&Qn(u);else{if(!m){if(u.stateNode===null)throw Error(s(166));return xt(u),null}r=ie.current,Va(u)?$g(u):(r=g0(w,m,f),u.stateNode=r,Qn(u))}return xt(u),null;case 5:if(ge(u),w=u.type,r!==null&&u.stateNode!=null)r.memoizedProps!==m&&Qn(u);else{if(!m){if(u.stateNode===null)throw Error(s(166));return xt(u),null}if(C=ie.current,Va(u))$g(u);else{var P=nl(re.current);switch(C){case 1:C=P.createElementNS("http://www.w3.org/2000/svg",w);break;case 2:C=P.createElementNS("http://www.w3.org/1998/Math/MathML",w);break;default:switch(w){case"svg":C=P.createElementNS("http://www.w3.org/2000/svg",w);break;case"math":C=P.createElementNS("http://www.w3.org/1998/Math/MathML",w);break;case"script":C=P.createElement("div"),C.innerHTML="<script><\/script>",C=C.removeChild(C.firstChild);break;case"select":C=typeof m.is=="string"?P.createElement("select",{is:m.is}):P.createElement("select"),m.multiple?C.multiple=!0:m.size&&(C.size=m.size);break;default:C=typeof m.is=="string"?P.createElement(w,{is:m.is}):P.createElement(w)}}C[bt]=u,C[Bt]=m;e:for(P=u.child;P!==null;){if(P.tag===5||P.tag===6)C.appendChild(P.stateNode);else if(P.tag!==4&&P.tag!==27&&P.child!==null){P.child.return=P,P=P.child;continue}if(P===u)break e;for(;P.sibling===null;){if(P.return===null||P.return===u)break e;P=P.return}P.sibling.return=P.return,P=P.sibling}u.stateNode=C;e:switch(ss(C,w,m),w){case"button":case"input":case"select":case"textarea":m=!!m.autoFocus;break e;case"img":m=!0;break e;default:m=!1}m&&Qn(u)}}return xt(u),ah(u,u.type,r===null?null:r.memoizedProps,u.pendingProps,f),null;case 6:if(r&&u.stateNode!=null)r.memoizedProps!==m&&Qn(u);else{if(typeof m!="string"&&u.stateNode===null)throw Error(s(166));if(r=re.current,Va(u)){if(r=u.stateNode,f=u.memoizedProps,m=null,w=Zt,w!==null)switch(w.tag){case 27:case 5:m=w.memoizedProps}r[bt]=u,r=!!(r.nodeValue===f||m!==null&&m.suppressHydrationWarning===!0||i0(r.nodeValue,f)),r||fi(u,!0)}else r=nl(r).createTextNode(m),r[bt]=u,u.stateNode=r}return xt(u),null;case 31:if(f=u.memoizedState,r===null||r.memoizedState!==null){if(m=Va(u),f!==null){if(r===null){if(!m)throw Error(s(318));if(r=u.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(s(557));r[bt]=u}else sa(),(u.flags&128)===0&&(u.memoizedState=null),u.flags|=4;xt(u),r=!1}else f=gd(),r!==null&&r.memoizedState!==null&&(r.memoizedState.hydrationErrors=f),r=!0;if(!r)return u.flags&256?(Es(u),u):(Es(u),null);if((u.flags&128)!==0)throw Error(s(558))}return xt(u),null;case 13:if(m=u.memoizedState,r===null||r.memoizedState!==null&&r.memoizedState.dehydrated!==null){if(w=Va(u),m!==null&&m.dehydrated!==null){if(r===null){if(!w)throw Error(s(318));if(w=u.memoizedState,w=w!==null?w.dehydrated:null,!w)throw Error(s(317));w[bt]=u}else sa(),(u.flags&128)===0&&(u.memoizedState=null),u.flags|=4;xt(u),w=!1}else w=gd(),r!==null&&r.memoizedState!==null&&(r.memoizedState.hydrationErrors=w),w=!0;if(!w)return u.flags&256?(Es(u),u):(Es(u),null)}return Es(u),(u.flags&128)!==0?(u.lanes=f,u):(f=m!==null,r=r!==null&&r.memoizedState!==null,f&&(m=u.child,w=null,m.alternate!==null&&m.alternate.memoizedState!==null&&m.alternate.memoizedState.cachePool!==null&&(w=m.alternate.memoizedState.cachePool.pool),C=null,m.memoizedState!==null&&m.memoizedState.cachePool!==null&&(C=m.memoizedState.cachePool.pool),C!==w&&(m.flags|=2048)),f!==r&&f&&(u.child.flags|=8192),Bc(u,u.updateQueue),xt(u),null);case 4:return ue(),r===null&&Eh(u.stateNode.containerInfo),xt(u),null;case 10:return $n(u.type),xt(u),null;case 19:if(J(Pt),m=u.memoizedState,m===null)return xt(u),null;if(w=(u.flags&128)!==0,C=m.rendering,C===null)if(w)lr(m,!1);else{if(At!==0||r!==null&&(r.flags&128)!==0)for(r=u.child;r!==null;){if(C=Ac(r),C!==null){for(u.flags|=128,lr(m,!1),r=C.updateQueue,u.updateQueue=r,Bc(u,r),u.subtreeFlags=0,r=f,f=u.child;f!==null;)zg(f,r),f=f.sibling;return K(Pt,Pt.current&1|2),st&&qn(u,m.treeForkCount),u.child}r=r.sibling}m.tail!==null&&nt()>Gc&&(u.flags|=128,w=!0,lr(m,!1),u.lanes=4194304)}else{if(!w)if(r=Ac(C),r!==null){if(u.flags|=128,w=!0,r=r.updateQueue,u.updateQueue=r,Bc(u,r),lr(m,!0),m.tail===null&&m.tailMode==="hidden"&&!C.alternate&&!st)return xt(u),null}else 2*nt()-m.renderingStartTime>Gc&&f!==536870912&&(u.flags|=128,w=!0,lr(m,!1),u.lanes=4194304);m.isBackwards?(C.sibling=u.child,u.child=C):(r=m.last,r!==null?r.sibling=C:u.child=C,m.last=C)}return m.tail!==null?(r=m.tail,m.rendering=r,m.tail=r.sibling,m.renderingStartTime=nt(),r.sibling=null,f=Pt.current,K(Pt,w?f&1|2:f&1),st&&qn(u,m.treeForkCount),r):(xt(u),null);case 22:case 23:return Es(u),kd(),m=u.memoizedState!==null,r!==null?r.memoizedState!==null!==m&&(u.flags|=8192):m&&(u.flags|=8192),m?(f&536870912)!==0&&(u.flags&128)===0&&(xt(u),u.subtreeFlags&6&&(u.flags|=8192)):xt(u),f=u.updateQueue,f!==null&&Bc(u,f.retryQueue),f=null,r!==null&&r.memoizedState!==null&&r.memoizedState.cachePool!==null&&(f=r.memoizedState.cachePool.pool),m=null,u.memoizedState!==null&&u.memoizedState.cachePool!==null&&(m=u.memoizedState.cachePool.pool),m!==f&&(u.flags|=2048),r!==null&&J(aa),null;case 24:return f=null,r!==null&&(f=r.memoizedState.cache),u.memoizedState.cache!==f&&(u.flags|=2048),$n(zt),xt(u),null;case 25:return null;case 30:return null}throw Error(s(156,u.tag))}function k1(r,u){switch(fd(u),u.tag){case 1:return r=u.flags,r&65536?(u.flags=r&-65537|128,u):null;case 3:return $n(zt),ue(),r=u.flags,(r&65536)!==0&&(r&128)===0?(u.flags=r&-65537|128,u):null;case 26:case 27:case 5:return ge(u),null;case 31:if(u.memoizedState!==null){if(Es(u),u.alternate===null)throw Error(s(340));sa()}return r=u.flags,r&65536?(u.flags=r&-65537|128,u):null;case 13:if(Es(u),r=u.memoizedState,r!==null&&r.dehydrated!==null){if(u.alternate===null)throw Error(s(340));sa()}return r=u.flags,r&65536?(u.flags=r&-65537|128,u):null;case 19:return J(Pt),null;case 4:return ue(),null;case 10:return $n(u.type),null;case 22:case 23:return Es(u),kd(),r!==null&&J(aa),r=u.flags,r&65536?(u.flags=r&-65537|128,u):null;case 24:return $n(zt),null;case 25:return null;default:return null}}function ly(r,u){switch(fd(u),u.tag){case 3:$n(zt),ue();break;case 26:case 27:case 5:ge(u);break;case 4:ue();break;case 31:u.memoizedState!==null&&Es(u);break;case 13:Es(u);break;case 19:J(Pt);break;case 10:$n(u.type);break;case 22:case 23:Es(u),kd(),r!==null&&J(aa);break;case 24:$n(zt)}}function ur(r,u){try{var f=u.updateQueue,m=f!==null?f.lastEffect:null;if(m!==null){var w=m.next;f=w;do{if((f.tag&r)===r){m=void 0;var C=f.create,P=f.inst;m=C(),P.destroy=m}f=f.next}while(f!==w)}}catch(_){ut(u,u.return,_)}}function Mi(r,u,f){try{var m=u.updateQueue,w=m!==null?m.lastEffect:null;if(w!==null){var C=w.next;m=C;do{if((m.tag&r)===r){var P=m.inst,_=P.destroy;if(_!==void 0){P.destroy=void 0,w=u;var O=f,W=_;try{W()}catch(oe){ut(w,O,oe)}}}m=m.next}while(m!==C)}}catch(oe){ut(u,u.return,oe)}}function uy(r){var u=r.updateQueue;if(u!==null){var f=r.stateNode;try{em(u,f)}catch(m){ut(r,r.return,m)}}}function dy(r,u,f){f.props=ua(r.type,r.memoizedProps),f.state=r.memoizedState;try{f.componentWillUnmount()}catch(m){ut(r,u,m)}}function dr(r,u){try{var f=r.ref;if(f!==null){switch(r.tag){case 26:case 27:case 5:var m=r.stateNode;break;case 30:m=r.stateNode;break;default:m=r.stateNode}typeof f=="function"?r.refCleanup=f(m):f.current=m}}catch(w){ut(r,u,w)}}function vn(r,u){var f=r.ref,m=r.refCleanup;if(f!==null)if(typeof m=="function")try{m()}catch(w){ut(r,u,w)}finally{r.refCleanup=null,r=r.alternate,r!=null&&(r.refCleanup=null)}else if(typeof f=="function")try{f(null)}catch(w){ut(r,u,w)}else f.current=null}function hy(r){var u=r.type,f=r.memoizedProps,m=r.stateNode;try{e:switch(u){case"button":case"input":case"select":case"textarea":f.autoFocus&&m.focus();break e;case"img":f.src?m.src=f.src:f.srcSet&&(m.srcset=f.srcSet)}}catch(w){ut(r,r.return,w)}}function oh(r,u,f){try{var m=r.stateNode;Y1(m,r.type,f,u),m[Bt]=u}catch(w){ut(r,r.return,w)}}function fy(r){return r.tag===5||r.tag===3||r.tag===26||r.tag===27&&Ei(r.type)||r.tag===4}function rh(r){e:for(;;){for(;r.sibling===null;){if(r.return===null||fy(r.return))return null;r=r.return}for(r.sibling.return=r.return,r=r.sibling;r.tag!==5&&r.tag!==6&&r.tag!==18;){if(r.tag===27&&Ei(r.type)||r.flags&2||r.child===null||r.tag===4)continue e;r.child.return=r,r=r.child}if(!(r.flags&2))return r.stateNode}}function ch(r,u,f){var m=r.tag;if(m===5||m===6)r=r.stateNode,u?(f.nodeType===9?f.body:f.nodeName==="HTML"?f.ownerDocument.body:f).insertBefore(r,u):(u=f.nodeType===9?f.body:f.nodeName==="HTML"?f.ownerDocument.body:f,u.appendChild(r),f=f._reactRootContainer,f!=null||u.onclick!==null||(u.onclick=zn));else if(m!==4&&(m===27&&Ei(r.type)&&(f=r.stateNode,u=null),r=r.child,r!==null))for(ch(r,u,f),r=r.sibling;r!==null;)ch(r,u,f),r=r.sibling}function Uc(r,u,f){var m=r.tag;if(m===5||m===6)r=r.stateNode,u?f.insertBefore(r,u):f.appendChild(r);else if(m!==4&&(m===27&&Ei(r.type)&&(f=r.stateNode),r=r.child,r!==null))for(Uc(r,u,f),r=r.sibling;r!==null;)Uc(r,u,f),r=r.sibling}function py(r){var u=r.stateNode,f=r.memoizedProps;try{for(var m=r.type,w=u.attributes;w.length;)u.removeAttributeNode(w[0]);ss(u,m,f),u[bt]=r,u[Bt]=f}catch(C){ut(r,r.return,C)}}var Vn=!1,qt=!1,lh=!1,gy=typeof WeakSet=="function"?WeakSet:Set,Yt=null;function A1(r,u){if(r=r.containerInfo,Dh=ul,r=Eg(r),sd(r)){if("selectionStart"in r)var f={start:r.selectionStart,end:r.selectionEnd};else e:{f=(f=r.ownerDocument)&&f.defaultView||window;var m=f.getSelection&&f.getSelection();if(m&&m.rangeCount!==0){f=m.anchorNode;var w=m.anchorOffset,C=m.focusNode;m=m.focusOffset;try{f.nodeType,C.nodeType}catch{f=null;break e}var P=0,_=-1,O=-1,W=0,oe=0,le=r,X=null;t:for(;;){for(var te;le!==f||w!==0&&le.nodeType!==3||(_=P+w),le!==C||m!==0&&le.nodeType!==3||(O=P+m),le.nodeType===3&&(P+=le.nodeValue.length),(te=le.firstChild)!==null;)X=le,le=te;for(;;){if(le===r)break t;if(X===f&&++W===w&&(_=P),X===C&&++oe===m&&(O=P),(te=le.nextSibling)!==null)break;le=X,X=le.parentNode}le=te}f=_===-1||O===-1?null:{start:_,end:O}}else f=null}f=f||{start:0,end:0}}else f=null;for(Ph={focusedElem:r,selectionRange:f},ul=!1,Yt=u;Yt!==null;)if(u=Yt,r=u.child,(u.subtreeFlags&1028)!==0&&r!==null)r.return=u,Yt=r;else for(;Yt!==null;){switch(u=Yt,C=u.alternate,r=u.flags,u.tag){case 0:if((r&4)!==0&&(r=u.updateQueue,r=r!==null?r.events:null,r!==null))for(f=0;f<r.length;f++)w=r[f],w.ref.impl=w.nextImpl;break;case 11:case 15:break;case 1:if((r&1024)!==0&&C!==null){r=void 0,f=u,w=C.memoizedProps,C=C.memoizedState,m=f.stateNode;try{var Se=ua(f.type,w);r=m.getSnapshotBeforeUpdate(Se,C),m.__reactInternalSnapshotBeforeUpdate=r}catch(Ie){ut(f,f.return,Ie)}}break;case 3:if((r&1024)!==0){if(r=u.stateNode.containerInfo,f=r.nodeType,f===9)Ih(r);else if(f===1)switch(r.nodeName){case"HEAD":case"HTML":case"BODY":Ih(r);break;default:r.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((r&1024)!==0)throw Error(s(163))}if(r=u.sibling,r!==null){r.return=u.return,Yt=r;break}Yt=u.return}}function my(r,u,f){var m=f.flags;switch(f.tag){case 0:case 11:case 15:Wn(r,f),m&4&&ur(5,f);break;case 1:if(Wn(r,f),m&4)if(r=f.stateNode,u===null)try{r.componentDidMount()}catch(P){ut(f,f.return,P)}else{var w=ua(f.type,u.memoizedProps);u=u.memoizedState;try{r.componentDidUpdate(w,u,r.__reactInternalSnapshotBeforeUpdate)}catch(P){ut(f,f.return,P)}}m&64&&uy(f),m&512&&dr(f,f.return);break;case 3:if(Wn(r,f),m&64&&(r=f.updateQueue,r!==null)){if(u=null,f.child!==null)switch(f.child.tag){case 27:case 5:u=f.child.stateNode;break;case 1:u=f.child.stateNode}try{em(r,u)}catch(P){ut(f,f.return,P)}}break;case 27:u===null&&m&4&&py(f);case 26:case 5:Wn(r,f),u===null&&m&4&&hy(f),m&512&&dr(f,f.return);break;case 12:Wn(r,f);break;case 31:Wn(r,f),m&4&&by(r,f);break;case 13:Wn(r,f),m&4&&My(r,f),m&64&&(r=f.memoizedState,r!==null&&(r=r.dehydrated,r!==null&&(f=O1.bind(null,f),iR(r,f))));break;case 22:if(m=f.memoizedState!==null||Vn,!m){u=u!==null&&u.memoizedState!==null||qt,w=Vn;var C=qt;Vn=m,(qt=u)&&!C?Kn(r,f,(f.subtreeFlags&8772)!==0):Wn(r,f),Vn=w,qt=C}break;case 30:break;default:Wn(r,f)}}function yy(r){var u=r.alternate;u!==null&&(r.alternate=null,yy(u)),r.child=null,r.deletions=null,r.sibling=null,r.tag===5&&(u=r.stateNode,u!==null&&qu(u)),r.stateNode=null,r.return=null,r.dependencies=null,r.memoizedProps=null,r.memoizedState=null,r.pendingProps=null,r.stateNode=null,r.updateQueue=null}var Rt=null,fs=!1;function Gn(r,u,f){for(f=f.child;f!==null;)vy(r,u,f),f=f.sibling}function vy(r,u,f){if(Jt&&typeof Jt.onCommitFiberUnmount=="function")try{Jt.onCommitFiberUnmount(pn,f)}catch{}switch(f.tag){case 26:qt||vn(f,u),Gn(r,u,f),f.memoizedState?f.memoizedState.count--:f.stateNode&&(f=f.stateNode,f.parentNode.removeChild(f));break;case 27:qt||vn(f,u);var m=Rt,w=fs;Ei(f.type)&&(Rt=f.stateNode,fs=!1),Gn(r,u,f),Mr(f.stateNode),Rt=m,fs=w;break;case 5:qt||vn(f,u);case 6:if(m=Rt,w=fs,Rt=null,Gn(r,u,f),Rt=m,fs=w,Rt!==null)if(fs)try{(Rt.nodeType===9?Rt.body:Rt.nodeName==="HTML"?Rt.ownerDocument.body:Rt).removeChild(f.stateNode)}catch(C){ut(f,u,C)}else try{Rt.removeChild(f.stateNode)}catch(C){ut(f,u,C)}break;case 18:Rt!==null&&(fs?(r=Rt,u0(r.nodeType===9?r.body:r.nodeName==="HTML"?r.ownerDocument.body:r,f.stateNode),po(r)):u0(Rt,f.stateNode));break;case 4:m=Rt,w=fs,Rt=f.stateNode.containerInfo,fs=!0,Gn(r,u,f),Rt=m,fs=w;break;case 0:case 11:case 14:case 15:Mi(2,f,u),qt||Mi(4,f,u),Gn(r,u,f);break;case 1:qt||(vn(f,u),m=f.stateNode,typeof m.componentWillUnmount=="function"&&dy(f,u,m)),Gn(r,u,f);break;case 21:Gn(r,u,f);break;case 22:qt=(m=qt)||f.memoizedState!==null,Gn(r,u,f),qt=m;break;default:Gn(r,u,f)}}function by(r,u){if(u.memoizedState===null&&(r=u.alternate,r!==null&&(r=r.memoizedState,r!==null))){r=r.dehydrated;try{po(r)}catch(f){ut(u,u.return,f)}}}function My(r,u){if(u.memoizedState===null&&(r=u.alternate,r!==null&&(r=r.memoizedState,r!==null&&(r=r.dehydrated,r!==null))))try{po(r)}catch(f){ut(u,u.return,f)}}function D1(r){switch(r.tag){case 31:case 13:case 19:var u=r.stateNode;return u===null&&(u=r.stateNode=new gy),u;case 22:return r=r.stateNode,u=r._retryCache,u===null&&(u=r._retryCache=new gy),u;default:throw Error(s(435,r.tag))}}function Fc(r,u){var f=D1(r);u.forEach(function(m){if(!f.has(m)){f.add(m);var w=q1.bind(null,r,m);m.then(w,w)}})}function ps(r,u){var f=u.deletions;if(f!==null)for(var m=0;m<f.length;m++){var w=f[m],C=r,P=u,_=P;e:for(;_!==null;){switch(_.tag){case 27:if(Ei(_.type)){Rt=_.stateNode,fs=!1;break e}break;case 5:Rt=_.stateNode,fs=!1;break e;case 3:case 4:Rt=_.stateNode.containerInfo,fs=!0;break e}_=_.return}if(Rt===null)throw Error(s(160));vy(C,P,w),Rt=null,fs=!1,C=w.alternate,C!==null&&(C.return=null),w.return=null}if(u.subtreeFlags&13886)for(u=u.child;u!==null;)wy(u,r),u=u.sibling}var en=null;function wy(r,u){var f=r.alternate,m=r.flags;switch(r.tag){case 0:case 11:case 14:case 15:ps(u,r),gs(r),m&4&&(Mi(3,r,r.return),ur(3,r),Mi(5,r,r.return));break;case 1:ps(u,r),gs(r),m&512&&(qt||f===null||vn(f,f.return)),m&64&&Vn&&(r=r.updateQueue,r!==null&&(m=r.callbacks,m!==null&&(f=r.shared.hiddenCallbacks,r.shared.hiddenCallbacks=f===null?m:f.concat(m))));break;case 26:var w=en;if(ps(u,r),gs(r),m&512&&(qt||f===null||vn(f,f.return)),m&4){var C=f!==null?f.memoizedState:null;if(m=r.memoizedState,f===null)if(m===null)if(r.stateNode===null){e:{m=r.type,f=r.memoizedProps,w=w.ownerDocument||w;t:switch(m){case"title":C=w.getElementsByTagName("title")[0],(!C||C[Oo]||C[bt]||C.namespaceURI==="http://www.w3.org/2000/svg"||C.hasAttribute("itemprop"))&&(C=w.createElement(m),w.head.insertBefore(C,w.querySelector("head > title"))),ss(C,m,f),C[bt]=r,Kt(C),m=C;break e;case"link":var P=w0("link","href",w).get(m+(f.href||""));if(P){for(var _=0;_<P.length;_++)if(C=P[_],C.getAttribute("href")===(f.href==null||f.href===""?null:f.href)&&C.getAttribute("rel")===(f.rel==null?null:f.rel)&&C.getAttribute("title")===(f.title==null?null:f.title)&&C.getAttribute("crossorigin")===(f.crossOrigin==null?null:f.crossOrigin)){P.splice(_,1);break t}}C=w.createElement(m),ss(C,m,f),w.head.appendChild(C);break;case"meta":if(P=w0("meta","content",w).get(m+(f.content||""))){for(_=0;_<P.length;_++)if(C=P[_],C.getAttribute("content")===(f.content==null?null:""+f.content)&&C.getAttribute("name")===(f.name==null?null:f.name)&&C.getAttribute("property")===(f.property==null?null:f.property)&&C.getAttribute("http-equiv")===(f.httpEquiv==null?null:f.httpEquiv)&&C.getAttribute("charset")===(f.charSet==null?null:f.charSet)){P.splice(_,1);break t}}C=w.createElement(m),ss(C,m,f),w.head.appendChild(C);break;default:throw Error(s(468,m))}C[bt]=r,Kt(C),m=C}r.stateNode=m}else S0(w,r.type,r.stateNode);else r.stateNode=M0(w,m,r.memoizedProps);else C!==m?(C===null?f.stateNode!==null&&(f=f.stateNode,f.parentNode.removeChild(f)):C.count--,m===null?S0(w,r.type,r.stateNode):M0(w,m,r.memoizedProps)):m===null&&r.stateNode!==null&&oh(r,r.memoizedProps,f.memoizedProps)}break;case 27:ps(u,r),gs(r),m&512&&(qt||f===null||vn(f,f.return)),f!==null&&m&4&&oh(r,r.memoizedProps,f.memoizedProps);break;case 5:if(ps(u,r),gs(r),m&512&&(qt||f===null||vn(f,f.return)),r.flags&32){w=r.stateNode;try{za(w,"")}catch(Se){ut(r,r.return,Se)}}m&4&&r.stateNode!=null&&(w=r.memoizedProps,oh(r,w,f!==null?f.memoizedProps:w)),m&1024&&(lh=!0);break;case 6:if(ps(u,r),gs(r),m&4){if(r.stateNode===null)throw Error(s(162));m=r.memoizedProps,f=r.stateNode;try{f.nodeValue=m}catch(Se){ut(r,r.return,Se)}}break;case 3:if(ol=null,w=en,en=il(u.containerInfo),ps(u,r),en=w,gs(r),m&4&&f!==null&&f.memoizedState.isDehydrated)try{po(u.containerInfo)}catch(Se){ut(r,r.return,Se)}lh&&(lh=!1,Sy(r));break;case 4:m=en,en=il(r.stateNode.containerInfo),ps(u,r),gs(r),en=m;break;case 12:ps(u,r),gs(r);break;case 31:ps(u,r),gs(r),m&4&&(m=r.updateQueue,m!==null&&(r.updateQueue=null,Fc(r,m)));break;case 13:ps(u,r),gs(r),r.child.flags&8192&&r.memoizedState!==null!=(f!==null&&f.memoizedState!==null)&&(Vc=nt()),m&4&&(m=r.updateQueue,m!==null&&(r.updateQueue=null,Fc(r,m)));break;case 22:w=r.memoizedState!==null;var O=f!==null&&f.memoizedState!==null,W=Vn,oe=qt;if(Vn=W||w,qt=oe||O,ps(u,r),qt=oe,Vn=W,gs(r),m&8192)e:for(u=r.stateNode,u._visibility=w?u._visibility&-2:u._visibility|1,w&&(f===null||O||Vn||qt||da(r)),f=null,u=r;;){if(u.tag===5||u.tag===26){if(f===null){O=f=u;try{if(C=O.stateNode,w)P=C.style,typeof P.setProperty=="function"?P.setProperty("display","none","important"):P.display="none";else{_=O.stateNode;var le=O.memoizedProps.style,X=le!=null&&le.hasOwnProperty("display")?le.display:null;_.style.display=X==null||typeof X=="boolean"?"":(""+X).trim()}}catch(Se){ut(O,O.return,Se)}}}else if(u.tag===6){if(f===null){O=u;try{O.stateNode.nodeValue=w?"":O.memoizedProps}catch(Se){ut(O,O.return,Se)}}}else if(u.tag===18){if(f===null){O=u;try{var te=O.stateNode;w?d0(te,!0):d0(O.stateNode,!1)}catch(Se){ut(O,O.return,Se)}}}else if((u.tag!==22&&u.tag!==23||u.memoizedState===null||u===r)&&u.child!==null){u.child.return=u,u=u.child;continue}if(u===r)break e;for(;u.sibling===null;){if(u.return===null||u.return===r)break e;f===u&&(f=null),u=u.return}f===u&&(f=null),u.sibling.return=u.return,u=u.sibling}m&4&&(m=r.updateQueue,m!==null&&(f=m.retryQueue,f!==null&&(m.retryQueue=null,Fc(r,f))));break;case 19:ps(u,r),gs(r),m&4&&(m=r.updateQueue,m!==null&&(r.updateQueue=null,Fc(r,m)));break;case 30:break;case 21:break;default:ps(u,r),gs(r)}}function gs(r){var u=r.flags;if(u&2){try{for(var f,m=r.return;m!==null;){if(fy(m)){f=m;break}m=m.return}if(f==null)throw Error(s(160));switch(f.tag){case 27:var w=f.stateNode,C=rh(r);Uc(r,C,w);break;case 5:var P=f.stateNode;f.flags&32&&(za(P,""),f.flags&=-33);var _=rh(r);Uc(r,_,P);break;case 3:case 4:var O=f.stateNode.containerInfo,W=rh(r);ch(r,W,O);break;default:throw Error(s(161))}}catch(oe){ut(r,r.return,oe)}r.flags&=-3}u&4096&&(r.flags&=-4097)}function Sy(r){if(r.subtreeFlags&1024)for(r=r.child;r!==null;){var u=r;Sy(u),u.tag===5&&u.flags&1024&&u.stateNode.reset(),r=r.sibling}}function Wn(r,u){if(u.subtreeFlags&8772)for(u=u.child;u!==null;)my(r,u.alternate,u),u=u.sibling}function da(r){for(r=r.child;r!==null;){var u=r;switch(u.tag){case 0:case 11:case 14:case 15:Mi(4,u,u.return),da(u);break;case 1:vn(u,u.return);var f=u.stateNode;typeof f.componentWillUnmount=="function"&&dy(u,u.return,f),da(u);break;case 27:Mr(u.stateNode);case 26:case 5:vn(u,u.return),da(u);break;case 22:u.memoizedState===null&&da(u);break;case 30:da(u);break;default:da(u)}r=r.sibling}}function Kn(r,u,f){for(f=f&&(u.subtreeFlags&8772)!==0,u=u.child;u!==null;){var m=u.alternate,w=r,C=u,P=C.flags;switch(C.tag){case 0:case 11:case 15:Kn(w,C,f),ur(4,C);break;case 1:if(Kn(w,C,f),m=C,w=m.stateNode,typeof w.componentDidMount=="function")try{w.componentDidMount()}catch(W){ut(m,m.return,W)}if(m=C,w=m.updateQueue,w!==null){var _=m.stateNode;try{var O=w.shared.hiddenCallbacks;if(O!==null)for(w.shared.hiddenCallbacks=null,w=0;w<O.length;w++)Zg(O[w],_)}catch(W){ut(m,m.return,W)}}f&&P&64&&uy(C),dr(C,C.return);break;case 27:py(C);case 26:case 5:Kn(w,C,f),f&&m===null&&P&4&&hy(C),dr(C,C.return);break;case 12:Kn(w,C,f);break;case 31:Kn(w,C,f),f&&P&4&&by(w,C);break;case 13:Kn(w,C,f),f&&P&4&&My(w,C);break;case 22:C.memoizedState===null&&Kn(w,C,f),dr(C,C.return);break;case 30:break;default:Kn(w,C,f)}u=u.sibling}}function uh(r,u){var f=null;r!==null&&r.memoizedState!==null&&r.memoizedState.cachePool!==null&&(f=r.memoizedState.cachePool.pool),r=null,u.memoizedState!==null&&u.memoizedState.cachePool!==null&&(r=u.memoizedState.cachePool.pool),r!==f&&(r!=null&&r.refCount++,f!=null&&Xo(f))}function dh(r,u){r=null,u.alternate!==null&&(r=u.alternate.memoizedState.cache),u=u.memoizedState.cache,u!==r&&(u.refCount++,r!=null&&Xo(r))}function tn(r,u,f,m){if(u.subtreeFlags&10256)for(u=u.child;u!==null;)xy(r,u,f,m),u=u.sibling}function xy(r,u,f,m){var w=u.flags;switch(u.tag){case 0:case 11:case 15:tn(r,u,f,m),w&2048&&ur(9,u);break;case 1:tn(r,u,f,m);break;case 3:tn(r,u,f,m),w&2048&&(r=null,u.alternate!==null&&(r=u.alternate.memoizedState.cache),u=u.memoizedState.cache,u!==r&&(u.refCount++,r!=null&&Xo(r)));break;case 12:if(w&2048){tn(r,u,f,m),r=u.stateNode;try{var C=u.memoizedProps,P=C.id,_=C.onPostCommit;typeof _=="function"&&_(P,u.alternate===null?"mount":"update",r.passiveEffectDuration,-0)}catch(O){ut(u,u.return,O)}}else tn(r,u,f,m);break;case 31:tn(r,u,f,m);break;case 13:tn(r,u,f,m);break;case 23:break;case 22:C=u.stateNode,P=u.alternate,u.memoizedState!==null?C._visibility&2?tn(r,u,f,m):hr(r,u):C._visibility&2?tn(r,u,f,m):(C._visibility|=2,so(r,u,f,m,(u.subtreeFlags&10256)!==0||!1)),w&2048&&uh(P,u);break;case 24:tn(r,u,f,m),w&2048&&dh(u.alternate,u);break;default:tn(r,u,f,m)}}function so(r,u,f,m,w){for(w=w&&((u.subtreeFlags&10256)!==0||!1),u=u.child;u!==null;){var C=r,P=u,_=f,O=m,W=P.flags;switch(P.tag){case 0:case 11:case 15:so(C,P,_,O,w),ur(8,P);break;case 23:break;case 22:var oe=P.stateNode;P.memoizedState!==null?oe._visibility&2?so(C,P,_,O,w):hr(C,P):(oe._visibility|=2,so(C,P,_,O,w)),w&&W&2048&&uh(P.alternate,P);break;case 24:so(C,P,_,O,w),w&&W&2048&&dh(P.alternate,P);break;default:so(C,P,_,O,w)}u=u.sibling}}function hr(r,u){if(u.subtreeFlags&10256)for(u=u.child;u!==null;){var f=r,m=u,w=m.flags;switch(m.tag){case 22:hr(f,m),w&2048&&uh(m.alternate,m);break;case 24:hr(f,m),w&2048&&dh(m.alternate,m);break;default:hr(f,m)}u=u.sibling}}var fr=8192;function no(r,u,f){if(r.subtreeFlags&fr)for(r=r.child;r!==null;)Cy(r,u,f),r=r.sibling}function Cy(r,u,f){switch(r.tag){case 26:no(r,u,f),r.flags&fr&&r.memoizedState!==null&&mR(f,en,r.memoizedState,r.memoizedProps);break;case 5:no(r,u,f);break;case 3:case 4:var m=en;en=il(r.stateNode.containerInfo),no(r,u,f),en=m;break;case 22:r.memoizedState===null&&(m=r.alternate,m!==null&&m.memoizedState!==null?(m=fr,fr=16777216,no(r,u,f),fr=m):no(r,u,f));break;default:no(r,u,f)}}function Ry(r){var u=r.alternate;if(u!==null&&(r=u.child,r!==null)){u.child=null;do u=r.sibling,r.sibling=null,r=u;while(r!==null)}}function pr(r){var u=r.deletions;if((r.flags&16)!==0){if(u!==null)for(var f=0;f<u.length;f++){var m=u[f];Yt=m,Ey(m,r)}Ry(r)}if(r.subtreeFlags&10256)for(r=r.child;r!==null;)Ty(r),r=r.sibling}function Ty(r){switch(r.tag){case 0:case 11:case 15:pr(r),r.flags&2048&&Mi(9,r,r.return);break;case 3:pr(r);break;case 12:pr(r);break;case 22:var u=r.stateNode;r.memoizedState!==null&&u._visibility&2&&(r.return===null||r.return.tag!==13)?(u._visibility&=-3,Qc(r)):pr(r);break;default:pr(r)}}function Qc(r){var u=r.deletions;if((r.flags&16)!==0){if(u!==null)for(var f=0;f<u.length;f++){var m=u[f];Yt=m,Ey(m,r)}Ry(r)}for(r=r.child;r!==null;){switch(u=r,u.tag){case 0:case 11:case 15:Mi(8,u,u.return),Qc(u);break;case 22:f=u.stateNode,f._visibility&2&&(f._visibility&=-3,Qc(u));break;default:Qc(u)}r=r.sibling}}function Ey(r,u){for(;Yt!==null;){var f=Yt;switch(f.tag){case 0:case 11:case 15:Mi(8,f,u);break;case 23:case 22:if(f.memoizedState!==null&&f.memoizedState.cachePool!==null){var m=f.memoizedState.cachePool.pool;m!=null&&m.refCount++}break;case 24:Xo(f.memoizedState.cache)}if(m=f.child,m!==null)m.return=f,Yt=m;else e:for(f=r;Yt!==null;){m=Yt;var w=m.sibling,C=m.return;if(yy(m),m===f){Yt=null;break e}if(w!==null){w.return=C,Yt=w;break e}Yt=C}}}var P1={getCacheForType:function(r){var u=es(zt),f=u.data.get(r);return f===void 0&&(f=r(),u.data.set(r,f)),f},cacheSignal:function(){return es(zt).controller.signal}},L1=typeof WeakMap=="function"?WeakMap:Map,rt=0,gt=null,Ke=null,Xe=0,lt=0,ks=null,wi=!1,io=!1,hh=!1,Yn=0,At=0,Si=0,ha=0,fh=0,As=0,ao=0,gr=null,ms=null,ph=!1,Vc=0,ky=0,Gc=1/0,Wc=null,xi=null,Ut=0,Ci=null,oo=null,Xn=0,gh=0,mh=null,Ay=null,mr=0,yh=null;function Ds(){return(rt&2)!==0&&Xe!==0?Xe&-Xe:z.T!==null?xh():xs()}function Dy(){if(As===0)if((Xe&536870912)===0||st){var r=Wi;Wi<<=1,(Wi&3932160)===0&&(Wi=262144),As=r}else As=536870912;return r=Ts.current,r!==null&&(r.flags|=32),As}function ys(r,u,f){(r===gt&&(lt===2||lt===9)||r.cancelPendingCommit!==null)&&(ro(r,0),Ri(r,Xe,As,!1)),Me(r,f),((rt&2)===0||r!==gt)&&(r===gt&&((rt&2)===0&&(ha|=f),At===4&&Ri(r,Xe,As,!1)),bn(r))}function Py(r,u,f){if((rt&6)!==0)throw Error(s(327));var m=!f&&(u&127)===0&&(u&r.expiredLanes)===0||In(r,u),w=m?N1(r,u):bh(r,u,!0),C=m;do{if(w===0){io&&!m&&Ri(r,u,0,!1);break}else{if(f=r.current.alternate,C&&!_1(f)){w=bh(r,u,!1),C=!1;continue}if(w===2){if(C=u,r.errorRecoveryDisabledLanes&C)var P=0;else P=r.pendingLanes&-536870913,P=P!==0?P:P&536870912?536870912:0;if(P!==0){u=P;e:{var _=r;w=gr;var O=_.current.memoizedState.isDehydrated;if(O&&(ro(_,P).flags|=256),P=bh(_,P,!1),P!==2){if(hh&&!O){_.errorRecoveryDisabledLanes|=C,ha|=C,w=4;break e}C=ms,ms=w,C!==null&&(ms===null?ms=C:ms.push.apply(ms,C))}w=P}if(C=!1,w!==2)continue}}if(w===1){ro(r,0),Ri(r,u,0,!0);break}e:{switch(m=r,C=w,C){case 0:case 1:throw Error(s(345));case 4:if((u&4194048)!==u)break;case 6:Ri(m,u,As,!wi);break e;case 2:ms=null;break;case 3:case 5:break;default:throw Error(s(329))}if((u&62914560)===u&&(w=Vc+300-nt(),10<w)){if(Ri(m,u,As,!wi),_n(m,0,!0)!==0)break e;Xn=u,m.timeoutHandle=c0(Ly.bind(null,m,f,ms,Wc,ph,u,As,ha,ao,wi,C,"Throttled",-0,0),w);break e}Ly(m,f,ms,Wc,ph,u,As,ha,ao,wi,C,null,-0,0)}}break}while(!0);bn(r)}function Ly(r,u,f,m,w,C,P,_,O,W,oe,le,X,te){if(r.timeoutHandle=-1,le=u.subtreeFlags,le&8192||(le&16785408)===16785408){le={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:zn},Cy(u,C,le);var Se=(C&62914560)===C?Vc-nt():(C&4194048)===C?ky-nt():0;if(Se=yR(le,Se),Se!==null){Xn=C,r.cancelPendingCommit=Se(Hy.bind(null,r,u,C,f,m,w,P,_,O,oe,le,null,X,te)),Ri(r,C,P,!W);return}}Hy(r,u,C,f,m,w,P,_,O)}function _1(r){for(var u=r;;){var f=u.tag;if((f===0||f===11||f===15)&&u.flags&16384&&(f=u.updateQueue,f!==null&&(f=f.stores,f!==null)))for(var m=0;m<f.length;m++){var w=f[m],C=w.getSnapshot;w=w.value;try{if(!Cs(C(),w))return!1}catch{return!1}}if(f=u.child,u.subtreeFlags&16384&&f!==null)f.return=u,u=f;else{if(u===r)break;for(;u.sibling===null;){if(u.return===null||u.return===r)return!0;u=u.return}u.sibling.return=u.return,u=u.sibling}}return!0}function Ri(r,u,f,m){u&=~fh,u&=~ha,r.suspendedLanes|=u,r.pingedLanes&=~u,m&&(r.warmLanes|=u),m=r.expirationTimes;for(var w=u;0<w;){var C=31-Nt(w),P=1<<C;m[C]=-1,w&=~P}f!==0&&$e(r,f,u)}function Kc(){return(rt&6)===0?(yr(0),!1):!0}function vh(){if(Ke!==null){if(lt===0)var r=Ke.return;else r=Ke,Hn=na=null,Id(r),Xa=null,Zo=0,r=Ke;for(;r!==null;)ly(r.alternate,r),r=r.return;Ke=null}}function ro(r,u){var f=r.timeoutHandle;f!==-1&&(r.timeoutHandle=-1,Z1(f)),f=r.cancelPendingCommit,f!==null&&(r.cancelPendingCommit=null,f()),Xn=0,vh(),gt=r,Ke=f=On(r.current,null),Xe=u,lt=0,ks=null,wi=!1,io=In(r,u),hh=!1,ao=As=fh=ha=Si=At=0,ms=gr=null,ph=!1,(u&8)!==0&&(u|=u&32);var m=r.entangledLanes;if(m!==0)for(r=r.entanglements,m&=u;0<m;){var w=31-Nt(m),C=1<<w;u|=r[w],m&=~C}return Yn=u,mc(),f}function _y(r,u){Be=null,z.H=rr,u===Ya||u===Cc?(u=Kg(),lt=3):u===Sd?(u=Kg(),lt=4):lt=u===Yd?8:u!==null&&typeof u=="object"&&typeof u.then=="function"?6:1,ks=u,Ke===null&&(At=1,Oc(r,Os(u,r.current)))}function Iy(){var r=Ts.current;return r===null?!0:(Xe&4194048)===Xe?Bs===null:(Xe&62914560)===Xe||(Xe&536870912)!==0?r===Bs:!1}function Ny(){var r=z.H;return z.H=rr,r===null?rr:r}function zy(){var r=z.A;return z.A=P1,r}function Yc(){At=4,wi||(Xe&4194048)!==Xe&&Ts.current!==null||(io=!0),(Si&134217727)===0&&(ha&134217727)===0||gt===null||Ri(gt,Xe,As,!1)}function bh(r,u,f){var m=rt;rt|=2;var w=Ny(),C=zy();(gt!==r||Xe!==u)&&(Wc=null,ro(r,u)),u=!1;var P=At;e:do try{if(lt!==0&&Ke!==null){var _=Ke,O=ks;switch(lt){case 8:vh(),P=6;break e;case 3:case 2:case 9:case 6:Ts.current===null&&(u=!0);var W=lt;if(lt=0,ks=null,co(r,_,O,W),f&&io){P=0;break e}break;default:W=lt,lt=0,ks=null,co(r,_,O,W)}}I1(),P=At;break}catch(oe){_y(r,oe)}while(!0);return u&&r.shellSuspendCounter++,Hn=na=null,rt=m,z.H=w,z.A=C,Ke===null&&(gt=null,Xe=0,mc()),P}function I1(){for(;Ke!==null;)jy(Ke)}function N1(r,u){var f=rt;rt|=2;var m=Ny(),w=zy();gt!==r||Xe!==u?(Wc=null,Gc=nt()+500,ro(r,u)):io=In(r,u);e:do try{if(lt!==0&&Ke!==null){u=Ke;var C=ks;t:switch(lt){case 1:lt=0,ks=null,co(r,u,C,1);break;case 2:case 9:if(Gg(C)){lt=0,ks=null,Oy(u);break}u=function(){lt!==2&&lt!==9||gt!==r||(lt=7),bn(r)},C.then(u,u);break e;case 3:lt=7;break e;case 4:lt=5;break e;case 7:Gg(C)?(lt=0,ks=null,Oy(u)):(lt=0,ks=null,co(r,u,C,7));break;case 5:var P=null;switch(Ke.tag){case 26:P=Ke.memoizedState;case 5:case 27:var _=Ke;if(P?x0(P):_.stateNode.complete){lt=0,ks=null;var O=_.sibling;if(O!==null)Ke=O;else{var W=_.return;W!==null?(Ke=W,Xc(W)):Ke=null}break t}}lt=0,ks=null,co(r,u,C,5);break;case 6:lt=0,ks=null,co(r,u,C,6);break;case 8:vh(),At=6;break e;default:throw Error(s(462))}}z1();break}catch(oe){_y(r,oe)}while(!0);return Hn=na=null,z.H=m,z.A=w,rt=f,Ke!==null?0:(gt=null,Xe=0,mc(),At)}function z1(){for(;Ke!==null&&!yt();)jy(Ke)}function jy(r){var u=ry(r.alternate,r,Yn);r.memoizedProps=r.pendingProps,u===null?Xc(r):Ke=u}function Oy(r){var u=r,f=u.alternate;switch(u.tag){case 15:case 0:u=ty(f,u,u.pendingProps,u.type,void 0,Xe);break;case 11:u=ty(f,u,u.pendingProps,u.type.render,u.ref,Xe);break;case 5:Id(u);default:ly(f,u),u=Ke=zg(u,Yn),u=ry(f,u,Yn)}r.memoizedProps=r.pendingProps,u===null?Xc(r):Ke=u}function co(r,u,f,m){Hn=na=null,Id(u),Xa=null,Zo=0;var w=u.return;try{if(C1(r,w,u,f,Xe)){At=1,Oc(r,Os(f,r.current)),Ke=null;return}}catch(C){if(w!==null)throw Ke=w,C;At=1,Oc(r,Os(f,r.current)),Ke=null;return}u.flags&32768?(st||m===1?r=!0:io||(Xe&536870912)!==0?r=!1:(wi=r=!0,(m===2||m===9||m===3||m===6)&&(m=Ts.current,m!==null&&m.tag===13&&(m.flags|=16384))),qy(u,r)):Xc(u)}function Xc(r){var u=r;do{if((u.flags&32768)!==0){qy(u,wi);return}r=u.return;var f=E1(u.alternate,u,Yn);if(f!==null){Ke=f;return}if(u=u.sibling,u!==null){Ke=u;return}Ke=u=r}while(u!==null);At===0&&(At=5)}function qy(r,u){do{var f=k1(r.alternate,r);if(f!==null){f.flags&=32767,Ke=f;return}if(f=r.return,f!==null&&(f.flags|=32768,f.subtreeFlags=0,f.deletions=null),!u&&(r=r.sibling,r!==null)){Ke=r;return}Ke=r=f}while(r!==null);At=6,Ke=null}function Hy(r,u,f,m,w,C,P,_,O){r.cancelPendingCommit=null;do Jc();while(Ut!==0);if((rt&6)!==0)throw Error(s(327));if(u!==null){if(u===r.current)throw Error(s(177));if(C=u.lanes|u.childLanes,C|=rd,je(r,f,C,P,_,O),r===gt&&(Ke=gt=null,Xe=0),oo=u,Ci=r,Xn=f,gh=C,mh=w,Ay=m,(u.subtreeFlags&10256)!==0||(u.flags&10256)!==0?(r.callbackNode=null,r.callbackPriority=0,H1(Xt,function(){return Qy(),null})):(r.callbackNode=null,r.callbackPriority=0),m=(u.flags&13878)!==0,(u.subtreeFlags&13878)!==0||m){m=z.T,z.T=null,w=$.p,$.p=2,P=rt,rt|=4;try{A1(r,u,f)}finally{rt=P,$.p=w,z.T=m}}Ut=1,$y(),By(),Uy()}}function $y(){if(Ut===1){Ut=0;var r=Ci,u=oo,f=(u.flags&13878)!==0;if((u.subtreeFlags&13878)!==0||f){f=z.T,z.T=null;var m=$.p;$.p=2;var w=rt;rt|=4;try{wy(u,r);var C=Ph,P=Eg(r.containerInfo),_=C.focusedElem,O=C.selectionRange;if(P!==_&&_&&_.ownerDocument&&Tg(_.ownerDocument.documentElement,_)){if(O!==null&&sd(_)){var W=O.start,oe=O.end;if(oe===void 0&&(oe=W),"selectionStart"in _)_.selectionStart=W,_.selectionEnd=Math.min(oe,_.value.length);else{var le=_.ownerDocument||document,X=le&&le.defaultView||window;if(X.getSelection){var te=X.getSelection(),Se=_.textContent.length,Ie=Math.min(O.start,Se),ft=O.end===void 0?Ie:Math.min(O.end,Se);!te.extend&&Ie>ft&&(P=ft,ft=Ie,Ie=P);var B=Rg(_,Ie),H=Rg(_,ft);if(B&&H&&(te.rangeCount!==1||te.anchorNode!==B.node||te.anchorOffset!==B.offset||te.focusNode!==H.node||te.focusOffset!==H.offset)){var G=le.createRange();G.setStart(B.node,B.offset),te.removeAllRanges(),Ie>ft?(te.addRange(G),te.extend(H.node,H.offset)):(G.setEnd(H.node,H.offset),te.addRange(G))}}}}for(le=[],te=_;te=te.parentNode;)te.nodeType===1&&le.push({element:te,left:te.scrollLeft,top:te.scrollTop});for(typeof _.focus=="function"&&_.focus(),_=0;_<le.length;_++){var ce=le[_];ce.element.scrollLeft=ce.left,ce.element.scrollTop=ce.top}}ul=!!Dh,Ph=Dh=null}finally{rt=w,$.p=m,z.T=f}}r.current=u,Ut=2}}function By(){if(Ut===2){Ut=0;var r=Ci,u=oo,f=(u.flags&8772)!==0;if((u.subtreeFlags&8772)!==0||f){f=z.T,z.T=null;var m=$.p;$.p=2;var w=rt;rt|=4;try{my(r,u.alternate,u)}finally{rt=w,$.p=m,z.T=f}}Ut=3}}function Uy(){if(Ut===4||Ut===3){Ut=0,Ht();var r=Ci,u=oo,f=Xn,m=Ay;(u.subtreeFlags&10256)!==0||(u.flags&10256)!==0?Ut=5:(Ut=0,oo=Ci=null,Fy(r,r.pendingLanes));var w=r.pendingLanes;if(w===0&&(xi=null),$t(f),u=u.stateNode,Jt&&typeof Jt.onCommitFiberRoot=="function")try{Jt.onCommitFiberRoot(pn,u,void 0,(u.current.flags&128)===128)}catch{}if(m!==null){u=z.T,w=$.p,$.p=2,z.T=null;try{for(var C=r.onRecoverableError,P=0;P<m.length;P++){var _=m[P];C(_.value,{componentStack:_.stack})}}finally{z.T=u,$.p=w}}(Xn&3)!==0&&Jc(),bn(r),w=r.pendingLanes,(f&261930)!==0&&(w&42)!==0?r===yh?mr++:(mr=0,yh=r):mr=0,yr(0)}}function Fy(r,u){(r.pooledCacheLanes&=u)===0&&(u=r.pooledCache,u!=null&&(r.pooledCache=null,Xo(u)))}function Jc(){return $y(),By(),Uy(),Qy()}function Qy(){if(Ut!==5)return!1;var r=Ci,u=gh;gh=0;var f=$t(Xn),m=z.T,w=$.p;try{$.p=32>f?32:f,z.T=null,f=mh,mh=null;var C=Ci,P=Xn;if(Ut=0,oo=Ci=null,Xn=0,(rt&6)!==0)throw Error(s(331));var _=rt;if(rt|=4,Ty(C.current),xy(C,C.current,P,f),rt=_,yr(0,!1),Jt&&typeof Jt.onPostCommitFiberRoot=="function")try{Jt.onPostCommitFiberRoot(pn,C)}catch{}return!0}finally{$.p=w,z.T=m,Fy(r,u)}}function Vy(r,u,f){u=Os(f,u),u=Kd(r.stateNode,u,2),r=yi(r,u,2),r!==null&&(Me(r,2),bn(r))}function ut(r,u,f){if(r.tag===3)Vy(r,r,f);else for(;u!==null;){if(u.tag===3){Vy(u,r,f);break}else if(u.tag===1){var m=u.stateNode;if(typeof u.type.getDerivedStateFromError=="function"||typeof m.componentDidCatch=="function"&&(xi===null||!xi.has(m))){r=Os(f,r),f=Gm(2),m=yi(u,f,2),m!==null&&(Wm(f,m,u,r),Me(m,2),bn(m));break}}u=u.return}}function Mh(r,u,f){var m=r.pingCache;if(m===null){m=r.pingCache=new L1;var w=new Set;m.set(u,w)}else w=m.get(u),w===void 0&&(w=new Set,m.set(u,w));w.has(f)||(hh=!0,w.add(f),r=j1.bind(null,r,u,f),u.then(r,r))}function j1(r,u,f){var m=r.pingCache;m!==null&&m.delete(u),r.pingedLanes|=r.suspendedLanes&f,r.warmLanes&=~f,gt===r&&(Xe&f)===f&&(At===4||At===3&&(Xe&62914560)===Xe&&300>nt()-Vc?(rt&2)===0&&ro(r,0):fh|=f,ao===Xe&&(ao=0)),bn(r)}function Gy(r,u){u===0&&(u=ne()),r=ea(r,u),r!==null&&(Me(r,u),bn(r))}function O1(r){var u=r.memoizedState,f=0;u!==null&&(f=u.retryLane),Gy(r,f)}function q1(r,u){var f=0;switch(r.tag){case 31:case 13:var m=r.stateNode,w=r.memoizedState;w!==null&&(f=w.retryLane);break;case 19:m=r.stateNode;break;case 22:m=r.stateNode._retryCache;break;default:throw Error(s(314))}m!==null&&m.delete(u),Gy(r,f)}function H1(r,u){return Ue(r,u)}var Zc=null,lo=null,wh=!1,el=!1,Sh=!1,Ti=0;function bn(r){r!==lo&&r.next===null&&(lo===null?Zc=lo=r:lo=lo.next=r),el=!0,wh||(wh=!0,B1())}function yr(r,u){if(!Sh&&el){Sh=!0;do for(var f=!1,m=Zc;m!==null;){if(r!==0){var w=m.pendingLanes;if(w===0)var C=0;else{var P=m.suspendedLanes,_=m.pingedLanes;C=(1<<31-Nt(42|r)+1)-1,C&=w&~(P&~_),C=C&201326741?C&201326741|1:C?C|2:0}C!==0&&(f=!0,Xy(m,C))}else C=Xe,C=_n(m,m===gt?C:0,m.cancelPendingCommit!==null||m.timeoutHandle!==-1),(C&3)===0||In(m,C)||(f=!0,Xy(m,C));m=m.next}while(f);Sh=!1}}function $1(){Wy()}function Wy(){el=wh=!1;var r=0;Ti!==0&&J1()&&(r=Ti);for(var u=nt(),f=null,m=Zc;m!==null;){var w=m.next,C=Ky(m,u);C===0?(m.next=null,f===null?Zc=w:f.next=w,w===null&&(lo=f)):(f=m,(r!==0||(C&3)!==0)&&(el=!0)),m=w}Ut!==0&&Ut!==5||yr(r),Ti!==0&&(Ti=0)}function Ky(r,u){for(var f=r.suspendedLanes,m=r.pingedLanes,w=r.expirationTimes,C=r.pendingLanes&-62914561;0<C;){var P=31-Nt(C),_=1<<P,O=w[P];O===-1?((_&f)===0||(_&m)!==0)&&(w[P]=Ou(_,u)):O<=u&&(r.expiredLanes|=_),C&=~_}if(u=gt,f=Xe,f=_n(r,r===u?f:0,r.cancelPendingCommit!==null||r.timeoutHandle!==-1),m=r.callbackNode,f===0||r===u&&(lt===2||lt===9)||r.cancelPendingCommit!==null)return m!==null&&m!==null&&Mt(m),r.callbackNode=null,r.callbackPriority=0;if((f&3)===0||In(r,f)){if(u=f&-f,u===r.callbackPriority)return u;switch(m!==null&&Mt(m),$t(f)){case 2:case 8:f=vt;break;case 32:f=Xt;break;case 268435456:f=Ln;break;default:f=Xt}return m=Yy.bind(null,r),f=Ue(f,m),r.callbackPriority=u,r.callbackNode=f,u}return m!==null&&m!==null&&Mt(m),r.callbackPriority=2,r.callbackNode=null,2}function Yy(r,u){if(Ut!==0&&Ut!==5)return r.callbackNode=null,r.callbackPriority=0,null;var f=r.callbackNode;if(Jc()&&r.callbackNode!==f)return null;var m=Xe;return m=_n(r,r===gt?m:0,r.cancelPendingCommit!==null||r.timeoutHandle!==-1),m===0?null:(Py(r,m,u),Ky(r,nt()),r.callbackNode!=null&&r.callbackNode===f?Yy.bind(null,r):null)}function Xy(r,u){if(Jc())return null;Py(r,u,!0)}function B1(){eR(function(){(rt&6)!==0?Ue(wt,$1):Wy()})}function xh(){if(Ti===0){var r=Wa;r===0&&(r=Ss,Ss<<=1,(Ss&261888)===0&&(Ss=256)),Ti=r}return Ti}function Jy(r){return r==null||typeof r=="symbol"||typeof r=="boolean"?null:typeof r=="function"?r:cc(""+r)}function Zy(r,u){var f=u.ownerDocument.createElement("input");return f.name=u.name,f.value=u.value,r.id&&f.setAttribute("form",r.id),u.parentNode.insertBefore(f,u),r=new FormData(r),f.parentNode.removeChild(f),r}function U1(r,u,f,m,w){if(u==="submit"&&f&&f.stateNode===w){var C=Jy((w[Bt]||null).action),P=m.submitter;P&&(u=(u=P[Bt]||null)?Jy(u.formAction):P.getAttribute("formAction"),u!==null&&(C=u,P=null));var _=new hc("action","action",null,m,w);r.push({event:_,listeners:[{instance:null,listener:function(){if(m.defaultPrevented){if(Ti!==0){var O=P?Zy(w,P):new FormData(w);Ud(f,{pending:!0,data:O,method:w.method,action:C},null,O)}}else typeof C=="function"&&(_.preventDefault(),O=P?Zy(w,P):new FormData(w),Ud(f,{pending:!0,data:O,method:w.method,action:C},C,O))},currentTarget:w}]})}}for(var Ch=0;Ch<od.length;Ch++){var Rh=od[Ch],F1=Rh.toLowerCase(),Q1=Rh[0].toUpperCase()+Rh.slice(1);Zs(F1,"on"+Q1)}Zs(Dg,"onAnimationEnd"),Zs(Pg,"onAnimationIteration"),Zs(Lg,"onAnimationStart"),Zs("dblclick","onDoubleClick"),Zs("focusin","onFocus"),Zs("focusout","onBlur"),Zs(r1,"onTransitionRun"),Zs(c1,"onTransitionStart"),Zs(l1,"onTransitionCancel"),Zs(_g,"onTransitionEnd"),Ia("onMouseEnter",["mouseout","mouseover"]),Ia("onMouseLeave",["mouseout","mouseover"]),Ia("onPointerEnter",["pointerout","pointerover"]),Ia("onPointerLeave",["pointerout","pointerover"]),Yi("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),Yi("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),Yi("onBeforeInput",["compositionend","keypress","textInput","paste"]),Yi("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),Yi("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),Yi("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var vr="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),V1=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(vr));function e0(r,u){u=(u&4)!==0;for(var f=0;f<r.length;f++){var m=r[f],w=m.event;m=m.listeners;e:{var C=void 0;if(u)for(var P=m.length-1;0<=P;P--){var _=m[P],O=_.instance,W=_.currentTarget;if(_=_.listener,O!==C&&w.isPropagationStopped())break e;C=_,w.currentTarget=W;try{C(w)}catch(oe){gc(oe)}w.currentTarget=null,C=O}else for(P=0;P<m.length;P++){if(_=m[P],O=_.instance,W=_.currentTarget,_=_.listener,O!==C&&w.isPropagationStopped())break e;C=_,w.currentTarget=W;try{C(w)}catch(oe){gc(oe)}w.currentTarget=null,C=O}}}}function Ye(r,u){var f=u[We];f===void 0&&(f=u[We]=new Set);var m=r+"__bubble";f.has(m)||(t0(u,r,2,!1),f.add(m))}function Th(r,u,f){var m=0;u&&(m|=4),t0(f,r,m,u)}var tl="_reactListening"+Math.random().toString(36).slice(2);function Eh(r){if(!r[tl]){r[tl]=!0,Wp.forEach(function(f){f!=="selectionchange"&&(V1.has(f)||Th(f,!1,r),Th(f,!0,r))});var u=r.nodeType===9?r:r.ownerDocument;u===null||u[tl]||(u[tl]=!0,Th("selectionchange",!1,u))}}function t0(r,u,f,m){switch(D0(u)){case 2:var w=MR;break;case 8:w=wR;break;default:w=Bh}f=w.bind(null,u,f,r),w=void 0,!Gu||u!=="touchstart"&&u!=="touchmove"&&u!=="wheel"||(w=!0),m?w!==void 0?r.addEventListener(u,f,{capture:!0,passive:w}):r.addEventListener(u,f,!0):w!==void 0?r.addEventListener(u,f,{passive:w}):r.addEventListener(u,f,!1)}function kh(r,u,f,m,w){var C=m;if((u&1)===0&&(u&2)===0&&m!==null)e:for(;;){if(m===null)return;var P=m.tag;if(P===3||P===4){var _=m.stateNode.containerInfo;if(_===w)break;if(P===4)for(P=m.return;P!==null;){var O=P.tag;if((O===3||O===4)&&P.stateNode.containerInfo===w)return;P=P.return}for(;_!==null;){if(P=Pa(_),P===null)return;if(O=P.tag,O===5||O===6||O===26||O===27){m=C=P;continue e}_=_.parentNode}}m=m.return}og(function(){var W=C,oe=Qu(f),le=[];e:{var X=Ig.get(r);if(X!==void 0){var te=hc,Se=r;switch(r){case"keypress":if(uc(f)===0)break e;case"keydown":case"keyup":te=qC;break;case"focusin":Se="focus",te=Xu;break;case"focusout":Se="blur",te=Xu;break;case"beforeblur":case"afterblur":te=Xu;break;case"click":if(f.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":te=lg;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":te=EC;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":te=BC;break;case Dg:case Pg:case Lg:te=DC;break;case _g:te=FC;break;case"scroll":case"scrollend":te=RC;break;case"wheel":te=VC;break;case"copy":case"cut":case"paste":te=LC;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":te=dg;break;case"toggle":case"beforetoggle":te=WC}var Ie=(u&4)!==0,ft=!Ie&&(r==="scroll"||r==="scrollend"),B=Ie?X!==null?X+"Capture":null:X;Ie=[];for(var H=W,G;H!==null;){var ce=H;if(G=ce.stateNode,ce=ce.tag,ce!==5&&ce!==26&&ce!==27||G===null||B===null||(ce=Ho(H,B),ce!=null&&Ie.push(br(H,ce,G))),ft)break;H=H.return}0<Ie.length&&(X=new te(X,Se,null,f,oe),le.push({event:X,listeners:Ie}))}}if((u&7)===0){e:{if(X=r==="mouseover"||r==="pointerover",te=r==="mouseout"||r==="pointerout",X&&f!==Fu&&(Se=f.relatedTarget||f.fromElement)&&(Pa(Se)||Se[gn]))break e;if((te||X)&&(X=oe.window===oe?oe:(X=oe.ownerDocument)?X.defaultView||X.parentWindow:window,te?(Se=f.relatedTarget||f.toElement,te=W,Se=Se?Pa(Se):null,Se!==null&&(ft=i(Se),Ie=Se.tag,Se!==ft||Ie!==5&&Ie!==27&&Ie!==6)&&(Se=null)):(te=null,Se=W),te!==Se)){if(Ie=lg,ce="onMouseLeave",B="onMouseEnter",H="mouse",(r==="pointerout"||r==="pointerover")&&(Ie=dg,ce="onPointerLeave",B="onPointerEnter",H="pointer"),ft=te==null?X:qo(te),G=Se==null?X:qo(Se),X=new Ie(ce,H+"leave",te,f,oe),X.target=ft,X.relatedTarget=G,ce=null,Pa(oe)===W&&(Ie=new Ie(B,H+"enter",Se,f,oe),Ie.target=G,Ie.relatedTarget=ft,ce=Ie),ft=ce,te&&Se)t:{for(Ie=G1,B=te,H=Se,G=0,ce=B;ce;ce=Ie(ce))G++;ce=0;for(var Pe=H;Pe;Pe=Ie(Pe))ce++;for(;0<G-ce;)B=Ie(B),G--;for(;0<ce-G;)H=Ie(H),ce--;for(;G--;){if(B===H||H!==null&&B===H.alternate){Ie=B;break t}B=Ie(B),H=Ie(H)}Ie=null}else Ie=null;te!==null&&s0(le,X,te,Ie,!1),Se!==null&&ft!==null&&s0(le,ft,Se,Ie,!0)}}e:{if(X=W?qo(W):window,te=X.nodeName&&X.nodeName.toLowerCase(),te==="select"||te==="input"&&X.type==="file")var at=bg;else if(yg(X))if(Mg)at=i1;else{at=s1;var Ee=t1}else te=X.nodeName,!te||te.toLowerCase()!=="input"||X.type!=="checkbox"&&X.type!=="radio"?W&&Uu(W.elementType)&&(at=bg):at=n1;if(at&&(at=at(r,W))){vg(le,at,f,oe);break e}Ee&&Ee(r,X,W),r==="focusout"&&W&&X.type==="number"&&W.memoizedProps.value!=null&&Bu(X,"number",X.value)}switch(Ee=W?qo(W):window,r){case"focusin":(yg(Ee)||Ee.contentEditable==="true")&&(Ha=Ee,nd=W,Wo=null);break;case"focusout":Wo=nd=Ha=null;break;case"mousedown":id=!0;break;case"contextmenu":case"mouseup":case"dragend":id=!1,kg(le,f,oe);break;case"selectionchange":if(o1)break;case"keydown":case"keyup":kg(le,f,oe)}var Fe;if(Zu)e:{switch(r){case"compositionstart":var Je="onCompositionStart";break e;case"compositionend":Je="onCompositionEnd";break e;case"compositionupdate":Je="onCompositionUpdate";break e}Je=void 0}else qa?gg(r,f)&&(Je="onCompositionEnd"):r==="keydown"&&f.keyCode===229&&(Je="onCompositionStart");Je&&(hg&&f.locale!=="ko"&&(qa||Je!=="onCompositionStart"?Je==="onCompositionEnd"&&qa&&(Fe=rg()):(ui=oe,Wu="value"in ui?ui.value:ui.textContent,qa=!0)),Ee=sl(W,Je),0<Ee.length&&(Je=new ug(Je,r,null,f,oe),le.push({event:Je,listeners:Ee}),Fe?Je.data=Fe:(Fe=mg(f),Fe!==null&&(Je.data=Fe)))),(Fe=YC?XC(r,f):JC(r,f))&&(Je=sl(W,"onBeforeInput"),0<Je.length&&(Ee=new ug("onBeforeInput","beforeinput",null,f,oe),le.push({event:Ee,listeners:Je}),Ee.data=Fe)),U1(le,r,W,f,oe)}e0(le,u)})}function br(r,u,f){return{instance:r,listener:u,currentTarget:f}}function sl(r,u){for(var f=u+"Capture",m=[];r!==null;){var w=r,C=w.stateNode;if(w=w.tag,w!==5&&w!==26&&w!==27||C===null||(w=Ho(r,f),w!=null&&m.unshift(br(r,w,C)),w=Ho(r,u),w!=null&&m.push(br(r,w,C))),r.tag===3)return m;r=r.return}return[]}function G1(r){if(r===null)return null;do r=r.return;while(r&&r.tag!==5&&r.tag!==27);return r||null}function s0(r,u,f,m,w){for(var C=u._reactName,P=[];f!==null&&f!==m;){var _=f,O=_.alternate,W=_.stateNode;if(_=_.tag,O!==null&&O===m)break;_!==5&&_!==26&&_!==27||W===null||(O=W,w?(W=Ho(f,C),W!=null&&P.unshift(br(f,W,O))):w||(W=Ho(f,C),W!=null&&P.push(br(f,W,O)))),f=f.return}P.length!==0&&r.push({event:u,listeners:P})}var W1=/\r\n?/g,K1=/\u0000|\uFFFD/g;function n0(r){return(typeof r=="string"?r:""+r).replace(W1,`
`).replace(K1,"")}function i0(r,u){return u=n0(u),n0(r)===u}function ht(r,u,f,m,w,C){switch(f){case"children":typeof m=="string"?u==="body"||u==="textarea"&&m===""||za(r,m):(typeof m=="number"||typeof m=="bigint")&&u!=="body"&&za(r,""+m);break;case"className":oc(r,"class",m);break;case"tabIndex":oc(r,"tabindex",m);break;case"dir":case"role":case"viewBox":case"width":case"height":oc(r,f,m);break;case"style":ig(r,m,C);break;case"data":if(u!=="object"){oc(r,"data",m);break}case"src":case"href":if(m===""&&(u!=="a"||f!=="href")){r.removeAttribute(f);break}if(m==null||typeof m=="function"||typeof m=="symbol"||typeof m=="boolean"){r.removeAttribute(f);break}m=cc(""+m),r.setAttribute(f,m);break;case"action":case"formAction":if(typeof m=="function"){r.setAttribute(f,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof C=="function"&&(f==="formAction"?(u!=="input"&&ht(r,u,"name",w.name,w,null),ht(r,u,"formEncType",w.formEncType,w,null),ht(r,u,"formMethod",w.formMethod,w,null),ht(r,u,"formTarget",w.formTarget,w,null)):(ht(r,u,"encType",w.encType,w,null),ht(r,u,"method",w.method,w,null),ht(r,u,"target",w.target,w,null)));if(m==null||typeof m=="symbol"||typeof m=="boolean"){r.removeAttribute(f);break}m=cc(""+m),r.setAttribute(f,m);break;case"onClick":m!=null&&(r.onclick=zn);break;case"onScroll":m!=null&&Ye("scroll",r);break;case"onScrollEnd":m!=null&&Ye("scrollend",r);break;case"dangerouslySetInnerHTML":if(m!=null){if(typeof m!="object"||!("__html"in m))throw Error(s(61));if(f=m.__html,f!=null){if(w.children!=null)throw Error(s(60));r.innerHTML=f}}break;case"multiple":r.multiple=m&&typeof m!="function"&&typeof m!="symbol";break;case"muted":r.muted=m&&typeof m!="function"&&typeof m!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(m==null||typeof m=="function"||typeof m=="boolean"||typeof m=="symbol"){r.removeAttribute("xlink:href");break}f=cc(""+m),r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",f);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":m!=null&&typeof m!="function"&&typeof m!="symbol"?r.setAttribute(f,""+m):r.removeAttribute(f);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":m&&typeof m!="function"&&typeof m!="symbol"?r.setAttribute(f,""):r.removeAttribute(f);break;case"capture":case"download":m===!0?r.setAttribute(f,""):m!==!1&&m!=null&&typeof m!="function"&&typeof m!="symbol"?r.setAttribute(f,m):r.removeAttribute(f);break;case"cols":case"rows":case"size":case"span":m!=null&&typeof m!="function"&&typeof m!="symbol"&&!isNaN(m)&&1<=m?r.setAttribute(f,m):r.removeAttribute(f);break;case"rowSpan":case"start":m==null||typeof m=="function"||typeof m=="symbol"||isNaN(m)?r.removeAttribute(f):r.setAttribute(f,m);break;case"popover":Ye("beforetoggle",r),Ye("toggle",r),ac(r,"popover",m);break;case"xlinkActuate":Nn(r,"http://www.w3.org/1999/xlink","xlink:actuate",m);break;case"xlinkArcrole":Nn(r,"http://www.w3.org/1999/xlink","xlink:arcrole",m);break;case"xlinkRole":Nn(r,"http://www.w3.org/1999/xlink","xlink:role",m);break;case"xlinkShow":Nn(r,"http://www.w3.org/1999/xlink","xlink:show",m);break;case"xlinkTitle":Nn(r,"http://www.w3.org/1999/xlink","xlink:title",m);break;case"xlinkType":Nn(r,"http://www.w3.org/1999/xlink","xlink:type",m);break;case"xmlBase":Nn(r,"http://www.w3.org/XML/1998/namespace","xml:base",m);break;case"xmlLang":Nn(r,"http://www.w3.org/XML/1998/namespace","xml:lang",m);break;case"xmlSpace":Nn(r,"http://www.w3.org/XML/1998/namespace","xml:space",m);break;case"is":ac(r,"is",m);break;case"innerText":case"textContent":break;default:(!(2<f.length)||f[0]!=="o"&&f[0]!=="O"||f[1]!=="n"&&f[1]!=="N")&&(f=xC.get(f)||f,ac(r,f,m))}}function Ah(r,u,f,m,w,C){switch(f){case"style":ig(r,m,C);break;case"dangerouslySetInnerHTML":if(m!=null){if(typeof m!="object"||!("__html"in m))throw Error(s(61));if(f=m.__html,f!=null){if(w.children!=null)throw Error(s(60));r.innerHTML=f}}break;case"children":typeof m=="string"?za(r,m):(typeof m=="number"||typeof m=="bigint")&&za(r,""+m);break;case"onScroll":m!=null&&Ye("scroll",r);break;case"onScrollEnd":m!=null&&Ye("scrollend",r);break;case"onClick":m!=null&&(r.onclick=zn);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!Kp.hasOwnProperty(f))e:{if(f[0]==="o"&&f[1]==="n"&&(w=f.endsWith("Capture"),u=f.slice(2,w?f.length-7:void 0),C=r[Bt]||null,C=C!=null?C[f]:null,typeof C=="function"&&r.removeEventListener(u,C,w),typeof m=="function")){typeof C!="function"&&C!==null&&(f in r?r[f]=null:r.hasAttribute(f)&&r.removeAttribute(f)),r.addEventListener(u,m,w);break e}f in r?r[f]=m:m===!0?r.setAttribute(f,""):ac(r,f,m)}}}function ss(r,u,f){switch(u){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":Ye("error",r),Ye("load",r);var m=!1,w=!1,C;for(C in f)if(f.hasOwnProperty(C)){var P=f[C];if(P!=null)switch(C){case"src":m=!0;break;case"srcSet":w=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(s(137,u));default:ht(r,u,C,P,f,null)}}w&&ht(r,u,"srcSet",f.srcSet,f,null),m&&ht(r,u,"src",f.src,f,null);return;case"input":Ye("invalid",r);var _=C=P=w=null,O=null,W=null;for(m in f)if(f.hasOwnProperty(m)){var oe=f[m];if(oe!=null)switch(m){case"name":w=oe;break;case"type":P=oe;break;case"checked":O=oe;break;case"defaultChecked":W=oe;break;case"value":C=oe;break;case"defaultValue":_=oe;break;case"children":case"dangerouslySetInnerHTML":if(oe!=null)throw Error(s(137,u));break;default:ht(r,u,m,oe,f,null)}}eg(r,C,_,O,W,P,w,!1);return;case"select":Ye("invalid",r),m=P=C=null;for(w in f)if(f.hasOwnProperty(w)&&(_=f[w],_!=null))switch(w){case"value":C=_;break;case"defaultValue":P=_;break;case"multiple":m=_;default:ht(r,u,w,_,f,null)}u=C,f=P,r.multiple=!!m,u!=null?Na(r,!!m,u,!1):f!=null&&Na(r,!!m,f,!0);return;case"textarea":Ye("invalid",r),C=w=m=null;for(P in f)if(f.hasOwnProperty(P)&&(_=f[P],_!=null))switch(P){case"value":m=_;break;case"defaultValue":w=_;break;case"children":C=_;break;case"dangerouslySetInnerHTML":if(_!=null)throw Error(s(91));break;default:ht(r,u,P,_,f,null)}sg(r,m,w,C);return;case"option":for(O in f)if(f.hasOwnProperty(O)&&(m=f[O],m!=null))switch(O){case"selected":r.selected=m&&typeof m!="function"&&typeof m!="symbol";break;default:ht(r,u,O,m,f,null)}return;case"dialog":Ye("beforetoggle",r),Ye("toggle",r),Ye("cancel",r),Ye("close",r);break;case"iframe":case"object":Ye("load",r);break;case"video":case"audio":for(m=0;m<vr.length;m++)Ye(vr[m],r);break;case"image":Ye("error",r),Ye("load",r);break;case"details":Ye("toggle",r);break;case"embed":case"source":case"link":Ye("error",r),Ye("load",r);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(W in f)if(f.hasOwnProperty(W)&&(m=f[W],m!=null))switch(W){case"children":case"dangerouslySetInnerHTML":throw Error(s(137,u));default:ht(r,u,W,m,f,null)}return;default:if(Uu(u)){for(oe in f)f.hasOwnProperty(oe)&&(m=f[oe],m!==void 0&&Ah(r,u,oe,m,f,void 0));return}}for(_ in f)f.hasOwnProperty(_)&&(m=f[_],m!=null&&ht(r,u,_,m,f,null))}function Y1(r,u,f,m){switch(u){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var w=null,C=null,P=null,_=null,O=null,W=null,oe=null;for(te in f){var le=f[te];if(f.hasOwnProperty(te)&&le!=null)switch(te){case"checked":break;case"value":break;case"defaultValue":O=le;default:m.hasOwnProperty(te)||ht(r,u,te,null,m,le)}}for(var X in m){var te=m[X];if(le=f[X],m.hasOwnProperty(X)&&(te!=null||le!=null))switch(X){case"type":C=te;break;case"name":w=te;break;case"checked":W=te;break;case"defaultChecked":oe=te;break;case"value":P=te;break;case"defaultValue":_=te;break;case"children":case"dangerouslySetInnerHTML":if(te!=null)throw Error(s(137,u));break;default:te!==le&&ht(r,u,X,te,m,le)}}$u(r,P,_,O,W,oe,C,w);return;case"select":te=P=_=X=null;for(C in f)if(O=f[C],f.hasOwnProperty(C)&&O!=null)switch(C){case"value":break;case"multiple":te=O;default:m.hasOwnProperty(C)||ht(r,u,C,null,m,O)}for(w in m)if(C=m[w],O=f[w],m.hasOwnProperty(w)&&(C!=null||O!=null))switch(w){case"value":X=C;break;case"defaultValue":_=C;break;case"multiple":P=C;default:C!==O&&ht(r,u,w,C,m,O)}u=_,f=P,m=te,X!=null?Na(r,!!f,X,!1):!!m!=!!f&&(u!=null?Na(r,!!f,u,!0):Na(r,!!f,f?[]:"",!1));return;case"textarea":te=X=null;for(_ in f)if(w=f[_],f.hasOwnProperty(_)&&w!=null&&!m.hasOwnProperty(_))switch(_){case"value":break;case"children":break;default:ht(r,u,_,null,m,w)}for(P in m)if(w=m[P],C=f[P],m.hasOwnProperty(P)&&(w!=null||C!=null))switch(P){case"value":X=w;break;case"defaultValue":te=w;break;case"children":break;case"dangerouslySetInnerHTML":if(w!=null)throw Error(s(91));break;default:w!==C&&ht(r,u,P,w,m,C)}tg(r,X,te);return;case"option":for(var Se in f)if(X=f[Se],f.hasOwnProperty(Se)&&X!=null&&!m.hasOwnProperty(Se))switch(Se){case"selected":r.selected=!1;break;default:ht(r,u,Se,null,m,X)}for(O in m)if(X=m[O],te=f[O],m.hasOwnProperty(O)&&X!==te&&(X!=null||te!=null))switch(O){case"selected":r.selected=X&&typeof X!="function"&&typeof X!="symbol";break;default:ht(r,u,O,X,m,te)}return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var Ie in f)X=f[Ie],f.hasOwnProperty(Ie)&&X!=null&&!m.hasOwnProperty(Ie)&&ht(r,u,Ie,null,m,X);for(W in m)if(X=m[W],te=f[W],m.hasOwnProperty(W)&&X!==te&&(X!=null||te!=null))switch(W){case"children":case"dangerouslySetInnerHTML":if(X!=null)throw Error(s(137,u));break;default:ht(r,u,W,X,m,te)}return;default:if(Uu(u)){for(var ft in f)X=f[ft],f.hasOwnProperty(ft)&&X!==void 0&&!m.hasOwnProperty(ft)&&Ah(r,u,ft,void 0,m,X);for(oe in m)X=m[oe],te=f[oe],!m.hasOwnProperty(oe)||X===te||X===void 0&&te===void 0||Ah(r,u,oe,X,m,te);return}}for(var B in f)X=f[B],f.hasOwnProperty(B)&&X!=null&&!m.hasOwnProperty(B)&&ht(r,u,B,null,m,X);for(le in m)X=m[le],te=f[le],!m.hasOwnProperty(le)||X===te||X==null&&te==null||ht(r,u,le,X,m,te)}function a0(r){switch(r){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function X1(){if(typeof performance.getEntriesByType=="function"){for(var r=0,u=0,f=performance.getEntriesByType("resource"),m=0;m<f.length;m++){var w=f[m],C=w.transferSize,P=w.initiatorType,_=w.duration;if(C&&_&&a0(P)){for(P=0,_=w.responseEnd,m+=1;m<f.length;m++){var O=f[m],W=O.startTime;if(W>_)break;var oe=O.transferSize,le=O.initiatorType;oe&&a0(le)&&(O=O.responseEnd,P+=oe*(O<_?1:(_-W)/(O-W)))}if(--m,u+=8*(C+P)/(w.duration/1e3),r++,10<r)break}}if(0<r)return u/r/1e6}return navigator.connection&&(r=navigator.connection.downlink,typeof r=="number")?r:5}var Dh=null,Ph=null;function nl(r){return r.nodeType===9?r:r.ownerDocument}function o0(r){switch(r){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function r0(r,u){if(r===0)switch(u){case"svg":return 1;case"math":return 2;default:return 0}return r===1&&u==="foreignObject"?0:r}function Lh(r,u){return r==="textarea"||r==="noscript"||typeof u.children=="string"||typeof u.children=="number"||typeof u.children=="bigint"||typeof u.dangerouslySetInnerHTML=="object"&&u.dangerouslySetInnerHTML!==null&&u.dangerouslySetInnerHTML.__html!=null}var _h=null;function J1(){var r=window.event;return r&&r.type==="popstate"?r===_h?!1:(_h=r,!0):(_h=null,!1)}var c0=typeof setTimeout=="function"?setTimeout:void 0,Z1=typeof clearTimeout=="function"?clearTimeout:void 0,l0=typeof Promise=="function"?Promise:void 0,eR=typeof queueMicrotask=="function"?queueMicrotask:typeof l0<"u"?function(r){return l0.resolve(null).then(r).catch(tR)}:c0;function tR(r){setTimeout(function(){throw r})}function Ei(r){return r==="head"}function u0(r,u){var f=u,m=0;do{var w=f.nextSibling;if(r.removeChild(f),w&&w.nodeType===8)if(f=w.data,f==="/$"||f==="/&"){if(m===0){r.removeChild(w),po(u);return}m--}else if(f==="$"||f==="$?"||f==="$~"||f==="$!"||f==="&")m++;else if(f==="html")Mr(r.ownerDocument.documentElement);else if(f==="head"){f=r.ownerDocument.head,Mr(f);for(var C=f.firstChild;C;){var P=C.nextSibling,_=C.nodeName;C[Oo]||_==="SCRIPT"||_==="STYLE"||_==="LINK"&&C.rel.toLowerCase()==="stylesheet"||f.removeChild(C),C=P}}else f==="body"&&Mr(r.ownerDocument.body);f=w}while(f);po(u)}function d0(r,u){var f=r;r=0;do{var m=f.nextSibling;if(f.nodeType===1?u?(f._stashedDisplay=f.style.display,f.style.display="none"):(f.style.display=f._stashedDisplay||"",f.getAttribute("style")===""&&f.removeAttribute("style")):f.nodeType===3&&(u?(f._stashedText=f.nodeValue,f.nodeValue=""):f.nodeValue=f._stashedText||""),m&&m.nodeType===8)if(f=m.data,f==="/$"){if(r===0)break;r--}else f!=="$"&&f!=="$?"&&f!=="$~"&&f!=="$!"||r++;f=m}while(f)}function Ih(r){var u=r.firstChild;for(u&&u.nodeType===10&&(u=u.nextSibling);u;){var f=u;switch(u=u.nextSibling,f.nodeName){case"HTML":case"HEAD":case"BODY":Ih(f),qu(f);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(f.rel.toLowerCase()==="stylesheet")continue}r.removeChild(f)}}function sR(r,u,f,m){for(;r.nodeType===1;){var w=f;if(r.nodeName.toLowerCase()!==u.toLowerCase()){if(!m&&(r.nodeName!=="INPUT"||r.type!=="hidden"))break}else if(m){if(!r[Oo])switch(u){case"meta":if(!r.hasAttribute("itemprop"))break;return r;case"link":if(C=r.getAttribute("rel"),C==="stylesheet"&&r.hasAttribute("data-precedence"))break;if(C!==w.rel||r.getAttribute("href")!==(w.href==null||w.href===""?null:w.href)||r.getAttribute("crossorigin")!==(w.crossOrigin==null?null:w.crossOrigin)||r.getAttribute("title")!==(w.title==null?null:w.title))break;return r;case"style":if(r.hasAttribute("data-precedence"))break;return r;case"script":if(C=r.getAttribute("src"),(C!==(w.src==null?null:w.src)||r.getAttribute("type")!==(w.type==null?null:w.type)||r.getAttribute("crossorigin")!==(w.crossOrigin==null?null:w.crossOrigin))&&C&&r.hasAttribute("async")&&!r.hasAttribute("itemprop"))break;return r;default:return r}}else if(u==="input"&&r.type==="hidden"){var C=w.name==null?null:""+w.name;if(w.type==="hidden"&&r.getAttribute("name")===C)return r}else return r;if(r=Us(r.nextSibling),r===null)break}return null}function nR(r,u,f){if(u==="")return null;for(;r.nodeType!==3;)if((r.nodeType!==1||r.nodeName!=="INPUT"||r.type!=="hidden")&&!f||(r=Us(r.nextSibling),r===null))return null;return r}function h0(r,u){for(;r.nodeType!==8;)if((r.nodeType!==1||r.nodeName!=="INPUT"||r.type!=="hidden")&&!u||(r=Us(r.nextSibling),r===null))return null;return r}function Nh(r){return r.data==="$?"||r.data==="$~"}function zh(r){return r.data==="$!"||r.data==="$?"&&r.ownerDocument.readyState!=="loading"}function iR(r,u){var f=r.ownerDocument;if(r.data==="$~")r._reactRetry=u;else if(r.data!=="$?"||f.readyState!=="loading")u();else{var m=function(){u(),f.removeEventListener("DOMContentLoaded",m)};f.addEventListener("DOMContentLoaded",m),r._reactRetry=m}}function Us(r){for(;r!=null;r=r.nextSibling){var u=r.nodeType;if(u===1||u===3)break;if(u===8){if(u=r.data,u==="$"||u==="$!"||u==="$?"||u==="$~"||u==="&"||u==="F!"||u==="F")break;if(u==="/$"||u==="/&")return null}}return r}var jh=null;function f0(r){r=r.nextSibling;for(var u=0;r;){if(r.nodeType===8){var f=r.data;if(f==="/$"||f==="/&"){if(u===0)return Us(r.nextSibling);u--}else f!=="$"&&f!=="$!"&&f!=="$?"&&f!=="$~"&&f!=="&"||u++}r=r.nextSibling}return null}function p0(r){r=r.previousSibling;for(var u=0;r;){if(r.nodeType===8){var f=r.data;if(f==="$"||f==="$!"||f==="$?"||f==="$~"||f==="&"){if(u===0)return r;u--}else f!=="/$"&&f!=="/&"||u++}r=r.previousSibling}return null}function g0(r,u,f){switch(u=nl(f),r){case"html":if(r=u.documentElement,!r)throw Error(s(452));return r;case"head":if(r=u.head,!r)throw Error(s(453));return r;case"body":if(r=u.body,!r)throw Error(s(454));return r;default:throw Error(s(451))}}function Mr(r){for(var u=r.attributes;u.length;)r.removeAttributeNode(u[0]);qu(r)}var Fs=new Map,m0=new Set;function il(r){return typeof r.getRootNode=="function"?r.getRootNode():r.nodeType===9?r:r.ownerDocument}var Jn=$.d;$.d={f:aR,r:oR,D:rR,C:cR,L:lR,m:uR,X:hR,S:dR,M:fR};function aR(){var r=Jn.f(),u=Kc();return r||u}function oR(r){var u=La(r);u!==null&&u.tag===5&&u.type==="form"?_m(u):Jn.r(r)}var uo=typeof document>"u"?null:document;function y0(r,u,f){var m=uo;if(m&&typeof u=="string"&&u){var w=zs(u);w='link[rel="'+r+'"][href="'+w+'"]',typeof f=="string"&&(w+='[crossorigin="'+f+'"]'),m0.has(w)||(m0.add(w),r={rel:r,crossOrigin:f,href:u},m.querySelector(w)===null&&(u=m.createElement("link"),ss(u,"link",r),Kt(u),m.head.appendChild(u)))}}function rR(r){Jn.D(r),y0("dns-prefetch",r,null)}function cR(r,u){Jn.C(r,u),y0("preconnect",r,u)}function lR(r,u,f){Jn.L(r,u,f);var m=uo;if(m&&r&&u){var w='link[rel="preload"][as="'+zs(u)+'"]';u==="image"&&f&&f.imageSrcSet?(w+='[imagesrcset="'+zs(f.imageSrcSet)+'"]',typeof f.imageSizes=="string"&&(w+='[imagesizes="'+zs(f.imageSizes)+'"]')):w+='[href="'+zs(r)+'"]';var C=w;switch(u){case"style":C=ho(r);break;case"script":C=fo(r)}Fs.has(C)||(r=p({rel:"preload",href:u==="image"&&f&&f.imageSrcSet?void 0:r,as:u},f),Fs.set(C,r),m.querySelector(w)!==null||u==="style"&&m.querySelector(wr(C))||u==="script"&&m.querySelector(Sr(C))||(u=m.createElement("link"),ss(u,"link",r),Kt(u),m.head.appendChild(u)))}}function uR(r,u){Jn.m(r,u);var f=uo;if(f&&r){var m=u&&typeof u.as=="string"?u.as:"script",w='link[rel="modulepreload"][as="'+zs(m)+'"][href="'+zs(r)+'"]',C=w;switch(m){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":C=fo(r)}if(!Fs.has(C)&&(r=p({rel:"modulepreload",href:r},u),Fs.set(C,r),f.querySelector(w)===null)){switch(m){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(f.querySelector(Sr(C)))return}m=f.createElement("link"),ss(m,"link",r),Kt(m),f.head.appendChild(m)}}}function dR(r,u,f){Jn.S(r,u,f);var m=uo;if(m&&r){var w=_a(m).hoistableStyles,C=ho(r);u=u||"default";var P=w.get(C);if(!P){var _={loading:0,preload:null};if(P=m.querySelector(wr(C)))_.loading=5;else{r=p({rel:"stylesheet",href:r,"data-precedence":u},f),(f=Fs.get(C))&&Oh(r,f);var O=P=m.createElement("link");Kt(O),ss(O,"link",r),O._p=new Promise(function(W,oe){O.onload=W,O.onerror=oe}),O.addEventListener("load",function(){_.loading|=1}),O.addEventListener("error",function(){_.loading|=2}),_.loading|=4,al(P,u,m)}P={type:"stylesheet",instance:P,count:1,state:_},w.set(C,P)}}}function hR(r,u){Jn.X(r,u);var f=uo;if(f&&r){var m=_a(f).hoistableScripts,w=fo(r),C=m.get(w);C||(C=f.querySelector(Sr(w)),C||(r=p({src:r,async:!0},u),(u=Fs.get(w))&&qh(r,u),C=f.createElement("script"),Kt(C),ss(C,"link",r),f.head.appendChild(C)),C={type:"script",instance:C,count:1,state:null},m.set(w,C))}}function fR(r,u){Jn.M(r,u);var f=uo;if(f&&r){var m=_a(f).hoistableScripts,w=fo(r),C=m.get(w);C||(C=f.querySelector(Sr(w)),C||(r=p({src:r,async:!0,type:"module"},u),(u=Fs.get(w))&&qh(r,u),C=f.createElement("script"),Kt(C),ss(C,"link",r),f.head.appendChild(C)),C={type:"script",instance:C,count:1,state:null},m.set(w,C))}}function v0(r,u,f,m){var w=(w=re.current)?il(w):null;if(!w)throw Error(s(446));switch(r){case"meta":case"title":return null;case"style":return typeof f.precedence=="string"&&typeof f.href=="string"?(u=ho(f.href),f=_a(w).hoistableStyles,m=f.get(u),m||(m={type:"style",instance:null,count:0,state:null},f.set(u,m)),m):{type:"void",instance:null,count:0,state:null};case"link":if(f.rel==="stylesheet"&&typeof f.href=="string"&&typeof f.precedence=="string"){r=ho(f.href);var C=_a(w).hoistableStyles,P=C.get(r);if(P||(w=w.ownerDocument||w,P={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},C.set(r,P),(C=w.querySelector(wr(r)))&&!C._p&&(P.instance=C,P.state.loading=5),Fs.has(r)||(f={rel:"preload",as:"style",href:f.href,crossOrigin:f.crossOrigin,integrity:f.integrity,media:f.media,hrefLang:f.hrefLang,referrerPolicy:f.referrerPolicy},Fs.set(r,f),C||pR(w,r,f,P.state))),u&&m===null)throw Error(s(528,""));return P}if(u&&m!==null)throw Error(s(529,""));return null;case"script":return u=f.async,f=f.src,typeof f=="string"&&u&&typeof u!="function"&&typeof u!="symbol"?(u=fo(f),f=_a(w).hoistableScripts,m=f.get(u),m||(m={type:"script",instance:null,count:0,state:null},f.set(u,m)),m):{type:"void",instance:null,count:0,state:null};default:throw Error(s(444,r))}}function ho(r){return'href="'+zs(r)+'"'}function wr(r){return'link[rel="stylesheet"]['+r+"]"}function b0(r){return p({},r,{"data-precedence":r.precedence,precedence:null})}function pR(r,u,f,m){r.querySelector('link[rel="preload"][as="style"]['+u+"]")?m.loading=1:(u=r.createElement("link"),m.preload=u,u.addEventListener("load",function(){return m.loading|=1}),u.addEventListener("error",function(){return m.loading|=2}),ss(u,"link",f),Kt(u),r.head.appendChild(u))}function fo(r){return'[src="'+zs(r)+'"]'}function Sr(r){return"script[async]"+r}function M0(r,u,f){if(u.count++,u.instance===null)switch(u.type){case"style":var m=r.querySelector('style[data-href~="'+zs(f.href)+'"]');if(m)return u.instance=m,Kt(m),m;var w=p({},f,{"data-href":f.href,"data-precedence":f.precedence,href:null,precedence:null});return m=(r.ownerDocument||r).createElement("style"),Kt(m),ss(m,"style",w),al(m,f.precedence,r),u.instance=m;case"stylesheet":w=ho(f.href);var C=r.querySelector(wr(w));if(C)return u.state.loading|=4,u.instance=C,Kt(C),C;m=b0(f),(w=Fs.get(w))&&Oh(m,w),C=(r.ownerDocument||r).createElement("link"),Kt(C);var P=C;return P._p=new Promise(function(_,O){P.onload=_,P.onerror=O}),ss(C,"link",m),u.state.loading|=4,al(C,f.precedence,r),u.instance=C;case"script":return C=fo(f.src),(w=r.querySelector(Sr(C)))?(u.instance=w,Kt(w),w):(m=f,(w=Fs.get(C))&&(m=p({},f),qh(m,w)),r=r.ownerDocument||r,w=r.createElement("script"),Kt(w),ss(w,"link",m),r.head.appendChild(w),u.instance=w);case"void":return null;default:throw Error(s(443,u.type))}else u.type==="stylesheet"&&(u.state.loading&4)===0&&(m=u.instance,u.state.loading|=4,al(m,f.precedence,r));return u.instance}function al(r,u,f){for(var m=f.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),w=m.length?m[m.length-1]:null,C=w,P=0;P<m.length;P++){var _=m[P];if(_.dataset.precedence===u)C=_;else if(C!==w)break}C?C.parentNode.insertBefore(r,C.nextSibling):(u=f.nodeType===9?f.head:f,u.insertBefore(r,u.firstChild))}function Oh(r,u){r.crossOrigin==null&&(r.crossOrigin=u.crossOrigin),r.referrerPolicy==null&&(r.referrerPolicy=u.referrerPolicy),r.title==null&&(r.title=u.title)}function qh(r,u){r.crossOrigin==null&&(r.crossOrigin=u.crossOrigin),r.referrerPolicy==null&&(r.referrerPolicy=u.referrerPolicy),r.integrity==null&&(r.integrity=u.integrity)}var ol=null;function w0(r,u,f){if(ol===null){var m=new Map,w=ol=new Map;w.set(f,m)}else w=ol,m=w.get(f),m||(m=new Map,w.set(f,m));if(m.has(r))return m;for(m.set(r,null),f=f.getElementsByTagName(r),w=0;w<f.length;w++){var C=f[w];if(!(C[Oo]||C[bt]||r==="link"&&C.getAttribute("rel")==="stylesheet")&&C.namespaceURI!=="http://www.w3.org/2000/svg"){var P=C.getAttribute(u)||"";P=r+P;var _=m.get(P);_?_.push(C):m.set(P,[C])}}return m}function S0(r,u,f){r=r.ownerDocument||r,r.head.insertBefore(f,u==="title"?r.querySelector("head > title"):null)}function gR(r,u,f){if(f===1||u.itemProp!=null)return!1;switch(r){case"meta":case"title":return!0;case"style":if(typeof u.precedence!="string"||typeof u.href!="string"||u.href==="")break;return!0;case"link":if(typeof u.rel!="string"||typeof u.href!="string"||u.href===""||u.onLoad||u.onError)break;switch(u.rel){case"stylesheet":return r=u.disabled,typeof u.precedence=="string"&&r==null;default:return!0}case"script":if(u.async&&typeof u.async!="function"&&typeof u.async!="symbol"&&!u.onLoad&&!u.onError&&u.src&&typeof u.src=="string")return!0}return!1}function x0(r){return!(r.type==="stylesheet"&&(r.state.loading&3)===0)}function mR(r,u,f,m){if(f.type==="stylesheet"&&(typeof m.media!="string"||matchMedia(m.media).matches!==!1)&&(f.state.loading&4)===0){if(f.instance===null){var w=ho(m.href),C=u.querySelector(wr(w));if(C){u=C._p,u!==null&&typeof u=="object"&&typeof u.then=="function"&&(r.count++,r=rl.bind(r),u.then(r,r)),f.state.loading|=4,f.instance=C,Kt(C);return}C=u.ownerDocument||u,m=b0(m),(w=Fs.get(w))&&Oh(m,w),C=C.createElement("link"),Kt(C);var P=C;P._p=new Promise(function(_,O){P.onload=_,P.onerror=O}),ss(C,"link",m),f.instance=C}r.stylesheets===null&&(r.stylesheets=new Map),r.stylesheets.set(f,u),(u=f.state.preload)&&(f.state.loading&3)===0&&(r.count++,f=rl.bind(r),u.addEventListener("load",f),u.addEventListener("error",f))}}var Hh=0;function yR(r,u){return r.stylesheets&&r.count===0&&ll(r,r.stylesheets),0<r.count||0<r.imgCount?function(f){var m=setTimeout(function(){if(r.stylesheets&&ll(r,r.stylesheets),r.unsuspend){var C=r.unsuspend;r.unsuspend=null,C()}},6e4+u);0<r.imgBytes&&Hh===0&&(Hh=62500*X1());var w=setTimeout(function(){if(r.waitingForImages=!1,r.count===0&&(r.stylesheets&&ll(r,r.stylesheets),r.unsuspend)){var C=r.unsuspend;r.unsuspend=null,C()}},(r.imgBytes>Hh?50:800)+u);return r.unsuspend=f,function(){r.unsuspend=null,clearTimeout(m),clearTimeout(w)}}:null}function rl(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)ll(this,this.stylesheets);else if(this.unsuspend){var r=this.unsuspend;this.unsuspend=null,r()}}}var cl=null;function ll(r,u){r.stylesheets=null,r.unsuspend!==null&&(r.count++,cl=new Map,u.forEach(vR,r),cl=null,rl.call(r))}function vR(r,u){if(!(u.state.loading&4)){var f=cl.get(r);if(f)var m=f.get(null);else{f=new Map,cl.set(r,f);for(var w=r.querySelectorAll("link[data-precedence],style[data-precedence]"),C=0;C<w.length;C++){var P=w[C];(P.nodeName==="LINK"||P.getAttribute("media")!=="not all")&&(f.set(P.dataset.precedence,P),m=P)}m&&f.set(null,m)}w=u.instance,P=w.getAttribute("data-precedence"),C=f.get(P)||m,C===m&&f.set(null,w),f.set(P,w),this.count++,m=rl.bind(this),w.addEventListener("load",m),w.addEventListener("error",m),C?C.parentNode.insertBefore(w,C.nextSibling):(r=r.nodeType===9?r.head:r,r.insertBefore(w,r.firstChild)),u.state.loading|=4}}var xr={$$typeof:E,Provider:null,Consumer:null,_currentValue:q,_currentValue2:q,_threadCount:0};function bR(r,u,f,m,w,C,P,_,O){this.tag=1,this.containerInfo=r,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=ye(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=ye(0),this.hiddenUpdates=ye(null),this.identifierPrefix=m,this.onUncaughtError=w,this.onCaughtError=C,this.onRecoverableError=P,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=O,this.incompleteTransitions=new Map}function C0(r,u,f,m,w,C,P,_,O,W,oe,le){return r=new bR(r,u,f,P,O,W,oe,le,_),u=1,C===!0&&(u|=24),C=Rs(3,null,null,u),r.current=C,C.stateNode=r,u=bd(),u.refCount++,r.pooledCache=u,u.refCount++,C.memoizedState={element:m,isDehydrated:f,cache:u},xd(C),r}function R0(r){return r?(r=Ua,r):Ua}function T0(r,u,f,m,w,C){w=R0(w),m.context===null?m.context=w:m.pendingContext=w,m=mi(u),m.payload={element:f},C=C===void 0?null:C,C!==null&&(m.callback=C),f=yi(r,m,u),f!==null&&(ys(f,r,u),tr(f,r,u))}function E0(r,u){if(r=r.memoizedState,r!==null&&r.dehydrated!==null){var f=r.retryLane;r.retryLane=f!==0&&f<u?f:u}}function $h(r,u){E0(r,u),(r=r.alternate)&&E0(r,u)}function k0(r){if(r.tag===13||r.tag===31){var u=ea(r,67108864);u!==null&&ys(u,r,67108864),$h(r,67108864)}}function A0(r){if(r.tag===13||r.tag===31){var u=Ds();u=ls(u);var f=ea(r,u);f!==null&&ys(f,r,u),$h(r,u)}}var ul=!0;function MR(r,u,f,m){var w=z.T;z.T=null;var C=$.p;try{$.p=2,Bh(r,u,f,m)}finally{$.p=C,z.T=w}}function wR(r,u,f,m){var w=z.T;z.T=null;var C=$.p;try{$.p=8,Bh(r,u,f,m)}finally{$.p=C,z.T=w}}function Bh(r,u,f,m){if(ul){var w=Uh(m);if(w===null)kh(r,u,m,dl,f),P0(r,m);else if(xR(w,r,u,f,m))m.stopPropagation();else if(P0(r,m),u&4&&-1<SR.indexOf(r)){for(;w!==null;){var C=La(w);if(C!==null)switch(C.tag){case 3:if(C=C.stateNode,C.current.memoizedState.isDehydrated){var P=Js(C.pendingLanes);if(P!==0){var _=C;for(_.pendingLanes|=2,_.entangledLanes|=2;P;){var O=1<<31-Nt(P);_.entanglements[1]|=O,P&=~O}bn(C),(rt&6)===0&&(Gc=nt()+500,yr(0))}}break;case 31:case 13:_=ea(C,2),_!==null&&ys(_,C,2),Kc(),$h(C,2)}if(C=Uh(m),C===null&&kh(r,u,m,dl,f),C===w)break;w=C}w!==null&&m.stopPropagation()}else kh(r,u,m,null,f)}}function Uh(r){return r=Qu(r),Fh(r)}var dl=null;function Fh(r){if(dl=null,r=Pa(r),r!==null){var u=i(r);if(u===null)r=null;else{var f=u.tag;if(f===13){if(r=a(u),r!==null)return r;r=null}else if(f===31){if(r=o(u),r!==null)return r;r=null}else if(f===3){if(u.stateNode.current.memoizedState.isDehydrated)return u.tag===3?u.stateNode.containerInfo:null;r=null}else u!==r&&(r=null)}}return dl=r,null}function D0(r){switch(r){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(It()){case wt:return 2;case vt:return 8;case Xt:case Vt:return 32;case Ln:return 268435456;default:return 32}default:return 32}}var Qh=!1,ki=null,Ai=null,Di=null,Cr=new Map,Rr=new Map,Pi=[],SR="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function P0(r,u){switch(r){case"focusin":case"focusout":ki=null;break;case"dragenter":case"dragleave":Ai=null;break;case"mouseover":case"mouseout":Di=null;break;case"pointerover":case"pointerout":Cr.delete(u.pointerId);break;case"gotpointercapture":case"lostpointercapture":Rr.delete(u.pointerId)}}function Tr(r,u,f,m,w,C){return r===null||r.nativeEvent!==C?(r={blockedOn:u,domEventName:f,eventSystemFlags:m,nativeEvent:C,targetContainers:[w]},u!==null&&(u=La(u),u!==null&&k0(u)),r):(r.eventSystemFlags|=m,u=r.targetContainers,w!==null&&u.indexOf(w)===-1&&u.push(w),r)}function xR(r,u,f,m,w){switch(u){case"focusin":return ki=Tr(ki,r,u,f,m,w),!0;case"dragenter":return Ai=Tr(Ai,r,u,f,m,w),!0;case"mouseover":return Di=Tr(Di,r,u,f,m,w),!0;case"pointerover":var C=w.pointerId;return Cr.set(C,Tr(Cr.get(C)||null,r,u,f,m,w)),!0;case"gotpointercapture":return C=w.pointerId,Rr.set(C,Tr(Rr.get(C)||null,r,u,f,m,w)),!0}return!1}function L0(r){var u=Pa(r.target);if(u!==null){var f=i(u);if(f!==null){if(u=f.tag,u===13){if(u=a(f),u!==null){r.blockedOn=u,Et(r.priority,function(){A0(f)});return}}else if(u===31){if(u=o(f),u!==null){r.blockedOn=u,Et(r.priority,function(){A0(f)});return}}else if(u===3&&f.stateNode.current.memoizedState.isDehydrated){r.blockedOn=f.tag===3?f.stateNode.containerInfo:null;return}}}r.blockedOn=null}function hl(r){if(r.blockedOn!==null)return!1;for(var u=r.targetContainers;0<u.length;){var f=Uh(r.nativeEvent);if(f===null){f=r.nativeEvent;var m=new f.constructor(f.type,f);Fu=m,f.target.dispatchEvent(m),Fu=null}else return u=La(f),u!==null&&k0(u),r.blockedOn=f,!1;u.shift()}return!0}function _0(r,u,f){hl(r)&&f.delete(u)}function CR(){Qh=!1,ki!==null&&hl(ki)&&(ki=null),Ai!==null&&hl(Ai)&&(Ai=null),Di!==null&&hl(Di)&&(Di=null),Cr.forEach(_0),Rr.forEach(_0)}function fl(r,u){r.blockedOn===u&&(r.blockedOn=null,Qh||(Qh=!0,c.unstable_scheduleCallback(c.unstable_NormalPriority,CR)))}var pl=null;function I0(r){pl!==r&&(pl=r,c.unstable_scheduleCallback(c.unstable_NormalPriority,function(){pl===r&&(pl=null);for(var u=0;u<r.length;u+=3){var f=r[u],m=r[u+1],w=r[u+2];if(typeof m!="function"){if(Fh(m||f)===null)continue;break}var C=La(f);C!==null&&(r.splice(u,3),u-=3,Ud(C,{pending:!0,data:w,method:f.method,action:m},m,w))}}))}function po(r){function u(O){return fl(O,r)}ki!==null&&fl(ki,r),Ai!==null&&fl(Ai,r),Di!==null&&fl(Di,r),Cr.forEach(u),Rr.forEach(u);for(var f=0;f<Pi.length;f++){var m=Pi[f];m.blockedOn===r&&(m.blockedOn=null)}for(;0<Pi.length&&(f=Pi[0],f.blockedOn===null);)L0(f),f.blockedOn===null&&Pi.shift();if(f=(r.ownerDocument||r).$$reactFormReplay,f!=null)for(m=0;m<f.length;m+=3){var w=f[m],C=f[m+1],P=w[Bt]||null;if(typeof C=="function")P||I0(f);else if(P){var _=null;if(C&&C.hasAttribute("formAction")){if(w=C,P=C[Bt]||null)_=P.formAction;else if(Fh(w)!==null)continue}else _=P.action;typeof _=="function"?f[m+1]=_:(f.splice(m,3),m-=3),I0(f)}}}function N0(){function r(C){C.canIntercept&&C.info==="react-transition"&&C.intercept({handler:function(){return new Promise(function(P){return w=P})},focusReset:"manual",scroll:"manual"})}function u(){w!==null&&(w(),w=null),m||setTimeout(f,20)}function f(){if(!m&&!navigation.transition){var C=navigation.currentEntry;C&&C.url!=null&&navigation.navigate(C.url,{state:C.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var m=!1,w=null;return navigation.addEventListener("navigate",r),navigation.addEventListener("navigatesuccess",u),navigation.addEventListener("navigateerror",u),setTimeout(f,100),function(){m=!0,navigation.removeEventListener("navigate",r),navigation.removeEventListener("navigatesuccess",u),navigation.removeEventListener("navigateerror",u),w!==null&&(w(),w=null)}}}function Vh(r){this._internalRoot=r}gl.prototype.render=Vh.prototype.render=function(r){var u=this._internalRoot;if(u===null)throw Error(s(409));var f=u.current,m=Ds();T0(f,m,r,u,null,null)},gl.prototype.unmount=Vh.prototype.unmount=function(){var r=this._internalRoot;if(r!==null){this._internalRoot=null;var u=r.containerInfo;T0(r.current,2,null,r,null,null),Kc(),u[gn]=null}};function gl(r){this._internalRoot=r}gl.prototype.unstable_scheduleHydration=function(r){if(r){var u=xs();r={blockedOn:null,target:r,priority:u};for(var f=0;f<Pi.length&&u!==0&&u<Pi[f].priority;f++);Pi.splice(f,0,r),f===0&&L0(r)}};var z0=e.version;if(z0!=="19.2.0")throw Error(s(527,z0,"19.2.0"));$.findDOMNode=function(r){var u=r._reactInternals;if(u===void 0)throw typeof r.render=="function"?Error(s(188)):(r=Object.keys(r).join(","),Error(s(268,r)));return r=d(u),r=r!==null?h(r):null,r=r===null?null:r.stateNode,r};var RR={bundleType:0,version:"19.2.0",rendererPackageName:"react-dom",currentDispatcherRef:z,reconcilerVersion:"19.2.0"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var ml=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!ml.isDisabled&&ml.supportsFiber)try{pn=ml.inject(RR),Jt=ml}catch{}}return kr.createRoot=function(r,u){if(!n(r))throw Error(s(299));var f=!1,m="",w=Um,C=Fm,P=Qm;return u!=null&&(u.unstable_strictMode===!0&&(f=!0),u.identifierPrefix!==void 0&&(m=u.identifierPrefix),u.onUncaughtError!==void 0&&(w=u.onUncaughtError),u.onCaughtError!==void 0&&(C=u.onCaughtError),u.onRecoverableError!==void 0&&(P=u.onRecoverableError)),u=C0(r,1,!1,null,null,f,m,null,w,C,P,N0),r[gn]=u.current,Eh(r),new Vh(u)},kr.hydrateRoot=function(r,u,f){if(!n(r))throw Error(s(299));var m=!1,w="",C=Um,P=Fm,_=Qm,O=null;return f!=null&&(f.unstable_strictMode===!0&&(m=!0),f.identifierPrefix!==void 0&&(w=f.identifierPrefix),f.onUncaughtError!==void 0&&(C=f.onUncaughtError),f.onCaughtError!==void 0&&(P=f.onCaughtError),f.onRecoverableError!==void 0&&(_=f.onRecoverableError),f.formState!==void 0&&(O=f.formState)),u=C0(r,1,!0,u,f??null,m,w,O,C,P,_,N0),u.context=R0(null),f=u.current,m=Ds(),m=ls(m),w=mi(m),w.callback=null,yi(f,w,m),f=m,u.current.lanes=f,Me(u,f),bn(u),r[gn]=u.current,Eh(r),new gl(u)},kr.version="19.2.0",kr}var V0;function NR(){if(V0)return Kh.exports;V0=1;function c(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(c)}catch(e){console.error(e)}}return c(),Kh.exports=IR(),Kh.exports}var zR=NR();const jR=Bf(zR);let OR={data:""},qR=c=>{if(typeof window=="object"){let e=(c?c.querySelector("#_goober"):window._goober)||Object.assign(document.createElement("style"),{innerHTML:" ",id:"_goober"});return e.nonce=window.__nonce__,e.parentNode||(c||document.head).appendChild(e),e.firstChild}return c||OR},HR=/(?:([\u0080-\uFFFF\w-%@]+) *:? *([^{;]+?);|([^;}{]*?) *{)|(}\s*)/g,$R=/\/\*[^]*?\*\/|  +/g,G0=/\n+/g,Ni=(c,e)=>{let t="",s="",n="";for(let i in c){let a=c[i];i[0]=="@"?i[1]=="i"?t=i+" "+a+";":s+=i[1]=="f"?Ni(a,i):i+"{"+Ni(a,i[1]=="k"?"":e)+"}":typeof a=="object"?s+=Ni(a,e?e.replace(/([^,])+/g,o=>i.replace(/([^,]*:\S+\([^)]*\))|([^,])+/g,l=>/&/.test(l)?l.replace(/&/g,o):o?o+" "+l:l)):i):a!=null&&(i=/^--/.test(i)?i:i.replace(/[A-Z]/g,"-$&").toLowerCase(),n+=Ni.p?Ni.p(i,a):i+":"+a+";")}return t+(e&&n?e+"{"+n+"}":n)+s},Zn={},tb=c=>{if(typeof c=="object"){let e="";for(let t in c)e+=t+tb(c[t]);return e}return c},BR=(c,e,t,s,n)=>{let i=tb(c),a=Zn[i]||(Zn[i]=(l=>{let d=0,h=11;for(;d<l.length;)h=101*h+l.charCodeAt(d++)>>>0;return"go"+h})(i));if(!Zn[a]){let l=i!==c?c:(d=>{let h,p,g=[{}];for(;h=HR.exec(d.replace($R,""));)h[4]?g.shift():h[3]?(p=h[3].replace(G0," ").trim(),g.unshift(g[0][p]=g[0][p]||{})):g[0][h[1]]=h[2].replace(G0," ").trim();return g[0]})(c);Zn[a]=Ni(n?{["@keyframes "+a]:l}:l,t?"":"."+a)}let o=t&&Zn.g?Zn.g:null;return t&&(Zn.g=Zn[a]),((l,d,h,p)=>{p?d.data=d.data.replace(p,l):d.data.indexOf(l)===-1&&(d.data=h?l+d.data:d.data+l)})(Zn[a],e,s,o),a},UR=(c,e,t)=>c.reduce((s,n,i)=>{let a=e[i];if(a&&a.call){let o=a(t),l=o&&o.props&&o.props.className||/^go/.test(o)&&o;a=l?"."+l:o&&typeof o=="object"?o.props?"":Ni(o,""):o===!1?"":o}return s+n+(a??"")},"");function Zl(c){let e=this||{},t=c.call?c(e.p):c;return BR(t.unshift?t.raw?UR(t,[].slice.call(arguments,1),e.p):t.reduce((s,n)=>Object.assign(s,n&&n.call?n(e.p):n),{}):t,qR(e.target),e.g,e.o,e.k)}let sb,Mf,wf;Zl.bind({g:1});let ai=Zl.bind({k:1});function FR(c,e,t,s){Ni.p=e,sb=c,Mf=t,wf=s}function Ui(c,e){let t=this||{};return function(){let s=arguments;function n(i,a){let o=Object.assign({},i),l=o.className||n.className;t.p=Object.assign({theme:Mf&&Mf()},o),t.o=/ *go\d+/.test(l),o.className=Zl.apply(t,s)+(l?" "+l:"");let d=c;return c[0]&&(d=o.as||c,delete o.as),wf&&d[0]&&wf(o),sb(d,o)}return n}}var QR=c=>typeof c=="function",Ol=(c,e)=>QR(c)?c(e):c,VR=(()=>{let c=0;return()=>(++c).toString()})(),nb=(()=>{let c;return()=>{if(c===void 0&&typeof window<"u"){let e=matchMedia("(prefers-reduced-motion: reduce)");c=!e||e.matches}return c}})(),GR=20,Qf="default",ib=(c,e)=>{let{toastLimit:t}=c.settings;switch(e.type){case 0:return{...c,toasts:[e.toast,...c.toasts].slice(0,t)};case 1:return{...c,toasts:c.toasts.map(a=>a.id===e.toast.id?{...a,...e.toast}:a)};case 2:let{toast:s}=e;return ib(c,{type:c.toasts.find(a=>a.id===s.id)?1:0,toast:s});case 3:let{toastId:n}=e;return{...c,toasts:c.toasts.map(a=>a.id===n||n===void 0?{...a,dismissed:!0,visible:!1}:a)};case 4:return e.toastId===void 0?{...c,toasts:[]}:{...c,toasts:c.toasts.filter(a=>a.id!==e.toastId)};case 5:return{...c,pausedAt:e.time};case 6:let i=e.time-(c.pausedAt||0);return{...c,pausedAt:void 0,toasts:c.toasts.map(a=>({...a,pauseDuration:a.pauseDuration+i}))}}},Pl=[],ab={toasts:[],pausedAt:void 0,settings:{toastLimit:GR}},wn={},ob=(c,e=Qf)=>{wn[e]=ib(wn[e]||ab,c),Pl.forEach(([t,s])=>{t===e&&s(wn[e])})},rb=c=>Object.keys(wn).forEach(e=>ob(c,e)),WR=c=>Object.keys(wn).find(e=>wn[e].toasts.some(t=>t.id===c)),eu=(c=Qf)=>e=>{ob(e,c)},KR={blank:4e3,error:4e3,success:2e3,loading:1/0,custom:4e3},YR=(c={},e=Qf)=>{let[t,s]=R.useState(wn[e]||ab),n=R.useRef(wn[e]);R.useEffect(()=>(n.current!==wn[e]&&s(wn[e]),Pl.push([e,s]),()=>{let a=Pl.findIndex(([o])=>o===e);a>-1&&Pl.splice(a,1)}),[e]);let i=t.toasts.map(a=>{var o,l,d;return{...c,...c[a.type],...a,removeDelay:a.removeDelay||((o=c[a.type])==null?void 0:o.removeDelay)||c?.removeDelay,duration:a.duration||((l=c[a.type])==null?void 0:l.duration)||c?.duration||KR[a.type],style:{...c.style,...(d=c[a.type])==null?void 0:d.style,...a.style}}});return{...t,toasts:i}},XR=(c,e="blank",t)=>({createdAt:Date.now(),visible:!0,dismissed:!1,type:e,ariaProps:{role:"status","aria-live":"polite"},message:c,pauseDuration:0,...t,id:t?.id||VR()}),Qr=c=>(e,t)=>{let s=XR(e,c,t);return eu(s.toasterId||WR(s.id))({type:2,toast:s}),s.id},Qt=(c,e)=>Qr("blank")(c,e);Qt.error=Qr("error");Qt.success=Qr("success");Qt.loading=Qr("loading");Qt.custom=Qr("custom");Qt.dismiss=(c,e)=>{let t={type:3,toastId:c};e?eu(e)(t):rb(t)};Qt.dismissAll=c=>Qt.dismiss(void 0,c);Qt.remove=(c,e)=>{let t={type:4,toastId:c};e?eu(e)(t):rb(t)};Qt.removeAll=c=>Qt.remove(void 0,c);Qt.promise=(c,e,t)=>{let s=Qt.loading(e.loading,{...t,...t?.loading});return typeof c=="function"&&(c=c()),c.then(n=>{let i=e.success?Ol(e.success,n):void 0;return i?Qt.success(i,{id:s,...t,...t?.success}):Qt.dismiss(s),n}).catch(n=>{let i=e.error?Ol(e.error,n):void 0;i?Qt.error(i,{id:s,...t,...t?.error}):Qt.dismiss(s)}),c};var JR=1e3,ZR=(c,e="default")=>{let{toasts:t,pausedAt:s}=YR(c,e),n=R.useRef(new Map).current,i=R.useCallback((p,g=JR)=>{if(n.has(p))return;let v=setTimeout(()=>{n.delete(p),a({type:4,toastId:p})},g);n.set(p,v)},[]);R.useEffect(()=>{if(s)return;let p=Date.now(),g=t.map(v=>{if(v.duration===1/0)return;let b=(v.duration||0)+v.pauseDuration-(p-v.createdAt);if(b<0){v.visible&&Qt.dismiss(v.id);return}return setTimeout(()=>Qt.dismiss(v.id,e),b)});return()=>{g.forEach(v=>v&&clearTimeout(v))}},[t,s,e]);let a=R.useCallback(eu(e),[e]),o=R.useCallback(()=>{a({type:5,time:Date.now()})},[a]),l=R.useCallback((p,g)=>{a({type:1,toast:{id:p,height:g}})},[a]),d=R.useCallback(()=>{s&&a({type:6,time:Date.now()})},[s,a]),h=R.useCallback((p,g)=>{let{reverseOrder:v=!1,gutter:b=8,defaultPosition:M}=g||{},x=t.filter(E=>(E.position||M)===(p.position||M)&&E.height),S=x.findIndex(E=>E.id===p.id),T=x.filter((E,A)=>A<S&&E.visible).length;return x.filter(E=>E.visible).slice(...v?[T+1]:[0,T]).reduce((E,A)=>E+(A.height||0)+b,0)},[t]);return R.useEffect(()=>{t.forEach(p=>{if(p.dismissed)i(p.id,p.removeDelay);else{let g=n.get(p.id);g&&(clearTimeout(g),n.delete(p.id))}})},[t,i]),{toasts:t,handlers:{updateHeight:l,startPause:o,endPause:d,calculateOffset:h}}},eT=ai`
from {
  transform: scale(0) rotate(45deg);
	opacity: 0;
}
to {
 transform: scale(1) rotate(45deg);
  opacity: 1;
}`,tT=ai`
from {
  transform: scale(0);
  opacity: 0;
}
to {
  transform: scale(1);
  opacity: 1;
}`,sT=ai`
from {
  transform: scale(0) rotate(90deg);
	opacity: 0;
}
to {
  transform: scale(1) rotate(90deg);
	opacity: 1;
}`,nT=Ui("div")`
  width: 20px;
  opacity: 0;
  height: 20px;
  border-radius: 10px;
  background: ${c=>c.primary||"#ff4b4b"};
  position: relative;
  transform: rotate(45deg);

  animation: ${eT} 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
  animation-delay: 100ms;

  &:after,
  &:before {
    content: '';
    animation: ${tT} 0.15s ease-out forwards;
    animation-delay: 150ms;
    position: absolute;
    border-radius: 3px;
    opacity: 0;
    background: ${c=>c.secondary||"#fff"};
    bottom: 9px;
    left: 4px;
    height: 2px;
    width: 12px;
  }

  &:before {
    animation: ${sT} 0.15s ease-out forwards;
    animation-delay: 180ms;
    transform: rotate(90deg);
  }
`,iT=ai`
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
`,aT=Ui("div")`
  width: 12px;
  height: 12px;
  box-sizing: border-box;
  border: 2px solid;
  border-radius: 100%;
  border-color: ${c=>c.secondary||"#e0e0e0"};
  border-right-color: ${c=>c.primary||"#616161"};
  animation: ${iT} 1s linear infinite;
`,oT=ai`
from {
  transform: scale(0) rotate(45deg);
	opacity: 0;
}
to {
  transform: scale(1) rotate(45deg);
	opacity: 1;
}`,rT=ai`
0% {
	height: 0;
	width: 0;
	opacity: 0;
}
40% {
  height: 0;
	width: 6px;
	opacity: 1;
}
100% {
  opacity: 1;
  height: 10px;
}`,cT=Ui("div")`
  width: 20px;
  opacity: 0;
  height: 20px;
  border-radius: 10px;
  background: ${c=>c.primary||"#61d345"};
  position: relative;
  transform: rotate(45deg);

  animation: ${oT} 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
  animation-delay: 100ms;
  &:after {
    content: '';
    box-sizing: border-box;
    animation: ${rT} 0.2s ease-out forwards;
    opacity: 0;
    animation-delay: 200ms;
    position: absolute;
    border-right: 2px solid;
    border-bottom: 2px solid;
    border-color: ${c=>c.secondary||"#fff"};
    bottom: 6px;
    left: 6px;
    height: 10px;
    width: 6px;
  }
`,lT=Ui("div")`
  position: absolute;
`,uT=Ui("div")`
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  min-width: 20px;
  min-height: 20px;
`,dT=ai`
from {
  transform: scale(0.6);
  opacity: 0.4;
}
to {
  transform: scale(1);
  opacity: 1;
}`,hT=Ui("div")`
  position: relative;
  transform: scale(0.6);
  opacity: 0.4;
  min-width: 20px;
  animation: ${dT} 0.3s 0.12s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
`,fT=({toast:c})=>{let{icon:e,type:t,iconTheme:s}=c;return e!==void 0?typeof e=="string"?R.createElement(hT,null,e):e:t==="blank"?null:R.createElement(uT,null,R.createElement(aT,{...s}),t!=="loading"&&R.createElement(lT,null,t==="error"?R.createElement(nT,{...s}):R.createElement(cT,{...s})))},pT=c=>`
0% {transform: translate3d(0,${c*-200}%,0) scale(.6); opacity:.5;}
100% {transform: translate3d(0,0,0) scale(1); opacity:1;}
`,gT=c=>`
0% {transform: translate3d(0,0,-1px) scale(1); opacity:1;}
100% {transform: translate3d(0,${c*-150}%,-1px) scale(.6); opacity:0;}
`,mT="0%{opacity:0;} 100%{opacity:1;}",yT="0%{opacity:1;} 100%{opacity:0;}",vT=Ui("div")`
  display: flex;
  align-items: center;
  background: #fff;
  color: #363636;
  line-height: 1.3;
  will-change: transform;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1), 0 3px 3px rgba(0, 0, 0, 0.05);
  max-width: 350px;
  pointer-events: auto;
  padding: 8px 10px;
  border-radius: 8px;
`,bT=Ui("div")`
  display: flex;
  justify-content: center;
  margin: 4px 10px;
  color: inherit;
  flex: 1 1 auto;
  white-space: pre-line;
`,MT=(c,e)=>{let t=c.includes("top")?1:-1,[s,n]=nb()?[mT,yT]:[pT(t),gT(t)];return{animation:e?`${ai(s)} 0.35s cubic-bezier(.21,1.02,.73,1) forwards`:`${ai(n)} 0.4s forwards cubic-bezier(.06,.71,.55,1)`}},wT=R.memo(({toast:c,position:e,style:t,children:s})=>{let n=c.height?MT(c.position||e||"top-center",c.visible):{opacity:0},i=R.createElement(fT,{toast:c}),a=R.createElement(bT,{...c.ariaProps},Ol(c.message,c));return R.createElement(vT,{className:c.className,style:{...n,...t,...c.style}},typeof s=="function"?s({icon:i,message:a}):R.createElement(R.Fragment,null,i,a))});FR(R.createElement);var ST=({id:c,className:e,style:t,onHeightUpdate:s,children:n})=>{let i=R.useCallback(a=>{if(a){let o=()=>{let l=a.getBoundingClientRect().height;s(c,l)};o(),new MutationObserver(o).observe(a,{subtree:!0,childList:!0,characterData:!0})}},[c,s]);return R.createElement("div",{ref:i,className:e,style:t},n)},xT=(c,e)=>{let t=c.includes("top"),s=t?{top:0}:{bottom:0},n=c.includes("center")?{justifyContent:"center"}:c.includes("right")?{justifyContent:"flex-end"}:{};return{left:0,right:0,display:"flex",position:"absolute",transition:nb()?void 0:"all 230ms cubic-bezier(.21,1.02,.73,1)",transform:`translateY(${e*(t?1:-1)}px)`,...s,...n}},CT=Zl`
  z-index: 9999;
  > * {
    pointer-events: auto;
  }
`,yl=16,RT=({reverseOrder:c,position:e="top-center",toastOptions:t,gutter:s,children:n,toasterId:i,containerStyle:a,containerClassName:o})=>{let{toasts:l,handlers:d}=ZR(t,i);return R.createElement("div",{"data-rht-toaster":i||"",style:{position:"fixed",zIndex:9999,top:yl,left:yl,right:yl,bottom:yl,pointerEvents:"none",...a},className:o,onMouseEnter:d.startPause,onMouseLeave:d.endPause},l.map(h=>{let p=h.position||e,g=d.calculateOffset(h,{reverseOrder:c,gutter:s,defaultPosition:e}),v=xT(p,g);return R.createElement(ST,{id:h.id,key:h.id,onHeightUpdate:d.updateHeight,className:h.visible?CT:"",style:v},h.type==="custom"?Ol(h.message,h):n?n(h):R.createElement(wT,{toast:h,position:p}))}))},M3=Qt;function W0(c,e){if(typeof c=="function")return c(e);c!=null&&(c.current=e)}function An(...c){return e=>{let t=!1;const s=c.map(n=>{const i=W0(n,e);return!t&&typeof i=="function"&&(t=!0),i});if(t)return()=>{for(let n=0;n<s.length;n++){const i=s[n];typeof i=="function"?i():W0(c[n],null)}}}}function Ne(...c){return R.useCallback(An(...c),c)}var TT=Symbol.for("react.lazy"),ql=Ff[" use ".trim().toString()];function ET(c){return typeof c=="object"&&c!==null&&"then"in c}function cb(c){return c!=null&&typeof c=="object"&&"$$typeof"in c&&c.$$typeof===TT&&"_payload"in c&&ET(c._payload)}function Vf(c){const e=AT(c),t=R.forwardRef((s,n)=>{let{children:i,...a}=s;cb(i)&&typeof ql=="function"&&(i=ql(i._payload));const o=R.Children.toArray(i),l=o.find(PT);if(l){const d=l.props.children,h=o.map(p=>p===l?R.Children.count(d)>1?R.Children.only(null):R.isValidElement(d)?d.props.children:null:p);return y.jsx(e,{...a,ref:n,children:R.isValidElement(d)?R.cloneElement(d,void 0,h):null})}return y.jsx(e,{...a,ref:n,children:i})});return t.displayName=`${c}.Slot`,t}var kT=Vf("Slot");function AT(c){const e=R.forwardRef((t,s)=>{let{children:n,...i}=t;if(cb(n)&&typeof ql=="function"&&(n=ql(n._payload)),R.isValidElement(n)){const a=_T(n),o=LT(i,n.props);return n.type!==R.Fragment&&(o.ref=s?An(s,a):a),R.cloneElement(n,o)}return R.Children.count(n)>1?R.Children.only(null):null});return e.displayName=`${c}.SlotClone`,e}var DT=Symbol("radix.slottable");function PT(c){return R.isValidElement(c)&&typeof c.type=="function"&&"__radixId"in c.type&&c.type.__radixId===DT}function LT(c,e){const t={...e};for(const s in e){const n=c[s],i=e[s];/^on[A-Z]/.test(s)?n&&i?t[s]=(...o)=>{const l=i(...o);return n(...o),l}:n&&(t[s]=n):s==="style"?t[s]={...n,...i}:s==="className"&&(t[s]=[n,i].filter(Boolean).join(" "))}return{...c,...t}}function _T(c){let e=Object.getOwnPropertyDescriptor(c.props,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning;return t?c.ref:(e=Object.getOwnPropertyDescriptor(c,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning,t?c.props.ref:c.props.ref||c.ref)}function lb(c){var e,t,s="";if(typeof c=="string"||typeof c=="number")s+=c;else if(typeof c=="object")if(Array.isArray(c)){var n=c.length;for(e=0;e<n;e++)c[e]&&(t=lb(c[e]))&&(s&&(s+=" "),s+=t)}else for(t in c)c[t]&&(s&&(s+=" "),s+=t);return s}function ub(){for(var c,e,t=0,s="",n=arguments.length;t<n;t++)(c=arguments[t])&&(e=lb(c))&&(s&&(s+=" "),s+=e);return s}const K0=c=>typeof c=="boolean"?`${c}`:c===0?"0":c,Y0=ub,Gf=(c,e)=>t=>{var s;if(e?.variants==null)return Y0(c,t?.class,t?.className);const{variants:n,defaultVariants:i}=e,a=Object.keys(n).map(d=>{const h=t?.[d],p=i?.[d];if(h===null)return null;const g=K0(h)||K0(p);return n[d][g]}),o=t&&Object.entries(t).reduce((d,h)=>{let[p,g]=h;return g===void 0||(d[p]=g),d},{}),l=e==null||(s=e.compoundVariants)===null||s===void 0?void 0:s.reduce((d,h)=>{let{class:p,className:g,...v}=h;return Object.entries(v).every(b=>{let[M,x]=b;return Array.isArray(x)?x.includes({...i,...o}[M]):{...i,...o}[M]===x})?[...d,p,g]:d},[]);return Y0(c,a,l,t?.class,t?.className)},IT=(c,e)=>{const t=new Array(c.length+e.length);for(let s=0;s<c.length;s++)t[s]=c[s];for(let s=0;s<e.length;s++)t[c.length+s]=e[s];return t},NT=(c,e)=>({classGroupId:c,validator:e}),db=(c=new Map,e=null,t)=>({nextPart:c,validators:e,classGroupId:t}),Hl="-",X0=[],zT="arbitrary..",jT=c=>{const e=qT(c),{conflictingClassGroups:t,conflictingClassGroupModifiers:s}=c;return{getClassGroupId:a=>{if(a.startsWith("[")&&a.endsWith("]"))return OT(a);const o=a.split(Hl),l=o[0]===""&&o.length>1?1:0;return hb(o,l,e)},getConflictingClassGroupIds:(a,o)=>{if(o){const l=s[a],d=t[a];return l?d?IT(d,l):l:d||X0}return t[a]||X0}}},hb=(c,e,t)=>{if(c.length-e===0)return t.classGroupId;const n=c[e],i=t.nextPart.get(n);if(i){const d=hb(c,e+1,i);if(d)return d}const a=t.validators;if(a===null)return;const o=e===0?c.join(Hl):c.slice(e).join(Hl),l=a.length;for(let d=0;d<l;d++){const h=a[d];if(h.validator(o))return h.classGroupId}},OT=c=>c.slice(1,-1).indexOf(":")===-1?void 0:(()=>{const e=c.slice(1,-1),t=e.indexOf(":"),s=e.slice(0,t);return s?zT+s:void 0})(),qT=c=>{const{theme:e,classGroups:t}=c;return HT(t,e)},HT=(c,e)=>{const t=db();for(const s in c){const n=c[s];Wf(n,t,s,e)}return t},Wf=(c,e,t,s)=>{const n=c.length;for(let i=0;i<n;i++){const a=c[i];$T(a,e,t,s)}},$T=(c,e,t,s)=>{if(typeof c=="string"){BT(c,e,t);return}if(typeof c=="function"){UT(c,e,t,s);return}FT(c,e,t,s)},BT=(c,e,t)=>{const s=c===""?e:fb(e,c);s.classGroupId=t},UT=(c,e,t,s)=>{if(QT(c)){Wf(c(s),e,t,s);return}e.validators===null&&(e.validators=[]),e.validators.push(NT(t,c))},FT=(c,e,t,s)=>{const n=Object.entries(c),i=n.length;for(let a=0;a<i;a++){const[o,l]=n[a];Wf(l,fb(e,o),t,s)}},fb=(c,e)=>{let t=c;const s=e.split(Hl),n=s.length;for(let i=0;i<n;i++){const a=s[i];let o=t.nextPart.get(a);o||(o=db(),t.nextPart.set(a,o)),t=o}return t},QT=c=>"isThemeGetter"in c&&c.isThemeGetter===!0,VT=c=>{if(c<1)return{get:()=>{},set:()=>{}};let e=0,t=Object.create(null),s=Object.create(null);const n=(i,a)=>{t[i]=a,e++,e>c&&(e=0,s=t,t=Object.create(null))};return{get(i){let a=t[i];if(a!==void 0)return a;if((a=s[i])!==void 0)return n(i,a),a},set(i,a){i in t?t[i]=a:n(i,a)}}},Sf="!",J0=":",GT=[],Z0=(c,e,t,s,n)=>({modifiers:c,hasImportantModifier:e,baseClassName:t,maybePostfixModifierPosition:s,isExternal:n}),WT=c=>{const{prefix:e,experimentalParseClassName:t}=c;let s=n=>{const i=[];let a=0,o=0,l=0,d;const h=n.length;for(let M=0;M<h;M++){const x=n[M];if(a===0&&o===0){if(x===J0){i.push(n.slice(l,M)),l=M+1;continue}if(x==="/"){d=M;continue}}x==="["?a++:x==="]"?a--:x==="("?o++:x===")"&&o--}const p=i.length===0?n:n.slice(l);let g=p,v=!1;p.endsWith(Sf)?(g=p.slice(0,-1),v=!0):p.startsWith(Sf)&&(g=p.slice(1),v=!0);const b=d&&d>l?d-l:void 0;return Z0(i,v,g,b)};if(e){const n=e+J0,i=s;s=a=>a.startsWith(n)?i(a.slice(n.length)):Z0(GT,!1,a,void 0,!0)}if(t){const n=s;s=i=>t({className:i,parseClassName:n})}return s},KT=c=>{const e=new Map;return c.orderSensitiveModifiers.forEach((t,s)=>{e.set(t,1e6+s)}),t=>{const s=[];let n=[];for(let i=0;i<t.length;i++){const a=t[i],o=a[0]==="[",l=e.has(a);o||l?(n.length>0&&(n.sort(),s.push(...n),n=[]),s.push(a)):n.push(a)}return n.length>0&&(n.sort(),s.push(...n)),s}},YT=c=>({cache:VT(c.cacheSize),parseClassName:WT(c),sortModifiers:KT(c),...jT(c)}),XT=/\s+/,JT=(c,e)=>{const{parseClassName:t,getClassGroupId:s,getConflictingClassGroupIds:n,sortModifiers:i}=e,a=[],o=c.trim().split(XT);let l="";for(let d=o.length-1;d>=0;d-=1){const h=o[d],{isExternal:p,modifiers:g,hasImportantModifier:v,baseClassName:b,maybePostfixModifierPosition:M}=t(h);if(p){l=h+(l.length>0?" "+l:l);continue}let x=!!M,S=s(x?b.substring(0,M):b);if(!S){if(!x){l=h+(l.length>0?" "+l:l);continue}if(S=s(b),!S){l=h+(l.length>0?" "+l:l);continue}x=!1}const T=g.length===0?"":g.length===1?g[0]:i(g).join(":"),E=v?T+Sf:T,A=E+S;if(a.indexOf(A)>-1)continue;a.push(A);const k=n(S,x);for(let D=0;D<k.length;++D){const L=k[D];a.push(E+L)}l=h+(l.length>0?" "+l:l)}return l},ZT=(...c)=>{let e=0,t,s,n="";for(;e<c.length;)(t=c[e++])&&(s=pb(t))&&(n&&(n+=" "),n+=s);return n},pb=c=>{if(typeof c=="string")return c;let e,t="";for(let s=0;s<c.length;s++)c[s]&&(e=pb(c[s]))&&(t&&(t+=" "),t+=e);return t},eE=(c,...e)=>{let t,s,n,i;const a=l=>{const d=e.reduce((h,p)=>p(h),c());return t=YT(d),s=t.cache.get,n=t.cache.set,i=o,o(l)},o=l=>{const d=s(l);if(d)return d;const h=JT(l,t);return n(l,h),h};return i=a,(...l)=>i(ZT(...l))},tE=[],Ft=c=>{const e=t=>t[c]||tE;return e.isThemeGetter=!0,e},gb=/^\[(?:(\w[\w-]*):)?(.+)\]$/i,mb=/^\((?:(\w[\w-]*):)?(.+)\)$/i,sE=/^\d+\/\d+$/,nE=/^(\d+(\.\d+)?)?(xs|sm|md|lg|xl)$/,iE=/\d+(%|px|r?em|[sdl]?v([hwib]|min|max)|pt|pc|in|cm|mm|cap|ch|ex|r?lh|cq(w|h|i|b|min|max))|\b(calc|min|max|clamp)\(.+\)|^0$/,aE=/^(rgba?|hsla?|hwb|(ok)?(lab|lch)|color-mix)\(.+\)$/,oE=/^(inset_)?-?((\d+)?\.?(\d+)[a-z]+|0)_-?((\d+)?\.?(\d+)[a-z]+|0)/,rE=/^(url|image|image-set|cross-fade|element|(repeating-)?(linear|radial|conic)-gradient)\(.+\)$/,go=c=>sE.test(c),Ve=c=>!!c&&!Number.isNaN(Number(c)),_i=c=>!!c&&Number.isInteger(Number(c)),Zh=c=>c.endsWith("%")&&Ve(c.slice(0,-1)),ei=c=>nE.test(c),cE=()=>!0,lE=c=>iE.test(c)&&!aE.test(c),yb=()=>!1,uE=c=>oE.test(c),dE=c=>rE.test(c),hE=c=>!xe(c)&&!Ce(c),fE=c=>Do(c,Mb,yb),xe=c=>gb.test(c),fa=c=>Do(c,wb,lE),ef=c=>Do(c,vE,Ve),ev=c=>Do(c,vb,yb),pE=c=>Do(c,bb,dE),vl=c=>Do(c,Sb,uE),Ce=c=>mb.test(c),Ar=c=>Po(c,wb),gE=c=>Po(c,bE),tv=c=>Po(c,vb),mE=c=>Po(c,Mb),yE=c=>Po(c,bb),bl=c=>Po(c,Sb,!0),Do=(c,e,t)=>{const s=gb.exec(c);return s?s[1]?e(s[1]):t(s[2]):!1},Po=(c,e,t=!1)=>{const s=mb.exec(c);return s?s[1]?e(s[1]):t:!1},vb=c=>c==="position"||c==="percentage",bb=c=>c==="image"||c==="url",Mb=c=>c==="length"||c==="size"||c==="bg-size",wb=c=>c==="length",vE=c=>c==="number",bE=c=>c==="family-name",Sb=c=>c==="shadow",ME=()=>{const c=Ft("color"),e=Ft("font"),t=Ft("text"),s=Ft("font-weight"),n=Ft("tracking"),i=Ft("leading"),a=Ft("breakpoint"),o=Ft("container"),l=Ft("spacing"),d=Ft("radius"),h=Ft("shadow"),p=Ft("inset-shadow"),g=Ft("text-shadow"),v=Ft("drop-shadow"),b=Ft("blur"),M=Ft("perspective"),x=Ft("aspect"),S=Ft("ease"),T=Ft("animate"),E=()=>["auto","avoid","all","avoid-page","page","left","right","column"],A=()=>["center","top","bottom","left","right","top-left","left-top","top-right","right-top","bottom-right","right-bottom","bottom-left","left-bottom"],k=()=>[...A(),Ce,xe],D=()=>["auto","hidden","clip","visible","scroll"],L=()=>["auto","contain","none"],I=()=>[Ce,xe,l],U=()=>[go,"full","auto",...I()],Q=()=>[_i,"none","subgrid",Ce,xe],se=()=>["auto",{span:["full",_i,Ce,xe]},_i,Ce,xe],F=()=>[_i,"auto",Ce,xe],Y=()=>["auto","min","max","fr",Ce,xe],ae=()=>["start","end","center","between","around","evenly","stretch","baseline","center-safe","end-safe"],de=()=>["start","end","center","stretch","center-safe","end-safe"],z=()=>["auto",...I()],$=()=>[go,"auto","full","dvw","dvh","lvw","lvh","svw","svh","min","max","fit",...I()],q=()=>[c,Ce,xe],ee=()=>[...A(),tv,ev,{position:[Ce,xe]}],me=()=>["no-repeat",{repeat:["","x","y","space","round"]}],N=()=>["auto","cover","contain",mE,fE,{size:[Ce,xe]}],J=()=>[Zh,Ar,fa],K=()=>["","none","full",d,Ce,xe],ie=()=>["",Ve,Ar,fa],Z=()=>["solid","dashed","dotted","double"],re=()=>["normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"],V=()=>[Ve,Zh,tv,ev],j=()=>["","none",b,Ce,xe],ue=()=>["none",Ve,Ce,xe],fe=()=>["none",Ve,Ce,xe],ge=()=>[Ve,Ce,xe],pe=()=>[go,"full",...I()];return{cacheSize:500,theme:{animate:["spin","ping","pulse","bounce"],aspect:["video"],blur:[ei],breakpoint:[ei],color:[cE],container:[ei],"drop-shadow":[ei],ease:["in","out","in-out"],font:[hE],"font-weight":["thin","extralight","light","normal","medium","semibold","bold","extrabold","black"],"inset-shadow":[ei],leading:["none","tight","snug","normal","relaxed","loose"],perspective:["dramatic","near","normal","midrange","distant","none"],radius:[ei],shadow:[ei],spacing:["px",Ve],text:[ei],"text-shadow":[ei],tracking:["tighter","tight","normal","wide","wider","widest"]},classGroups:{aspect:[{aspect:["auto","square",go,xe,Ce,x]}],container:["container"],columns:[{columns:[Ve,xe,Ce,o]}],"break-after":[{"break-after":E()}],"break-before":[{"break-before":E()}],"break-inside":[{"break-inside":["auto","avoid","avoid-page","avoid-column"]}],"box-decoration":[{"box-decoration":["slice","clone"]}],box:[{box:["border","content"]}],display:["block","inline-block","inline","flex","inline-flex","table","inline-table","table-caption","table-cell","table-column","table-column-group","table-footer-group","table-header-group","table-row-group","table-row","flow-root","grid","inline-grid","contents","list-item","hidden"],sr:["sr-only","not-sr-only"],float:[{float:["right","left","none","start","end"]}],clear:[{clear:["left","right","both","none","start","end"]}],isolation:["isolate","isolation-auto"],"object-fit":[{object:["contain","cover","fill","none","scale-down"]}],"object-position":[{object:k()}],overflow:[{overflow:D()}],"overflow-x":[{"overflow-x":D()}],"overflow-y":[{"overflow-y":D()}],overscroll:[{overscroll:L()}],"overscroll-x":[{"overscroll-x":L()}],"overscroll-y":[{"overscroll-y":L()}],position:["static","fixed","absolute","relative","sticky"],inset:[{inset:U()}],"inset-x":[{"inset-x":U()}],"inset-y":[{"inset-y":U()}],start:[{start:U()}],end:[{end:U()}],top:[{top:U()}],right:[{right:U()}],bottom:[{bottom:U()}],left:[{left:U()}],visibility:["visible","invisible","collapse"],z:[{z:[_i,"auto",Ce,xe]}],basis:[{basis:[go,"full","auto",o,...I()]}],"flex-direction":[{flex:["row","row-reverse","col","col-reverse"]}],"flex-wrap":[{flex:["nowrap","wrap","wrap-reverse"]}],flex:[{flex:[Ve,go,"auto","initial","none",xe]}],grow:[{grow:["",Ve,Ce,xe]}],shrink:[{shrink:["",Ve,Ce,xe]}],order:[{order:[_i,"first","last","none",Ce,xe]}],"grid-cols":[{"grid-cols":Q()}],"col-start-end":[{col:se()}],"col-start":[{"col-start":F()}],"col-end":[{"col-end":F()}],"grid-rows":[{"grid-rows":Q()}],"row-start-end":[{row:se()}],"row-start":[{"row-start":F()}],"row-end":[{"row-end":F()}],"grid-flow":[{"grid-flow":["row","col","dense","row-dense","col-dense"]}],"auto-cols":[{"auto-cols":Y()}],"auto-rows":[{"auto-rows":Y()}],gap:[{gap:I()}],"gap-x":[{"gap-x":I()}],"gap-y":[{"gap-y":I()}],"justify-content":[{justify:[...ae(),"normal"]}],"justify-items":[{"justify-items":[...de(),"normal"]}],"justify-self":[{"justify-self":["auto",...de()]}],"align-content":[{content:["normal",...ae()]}],"align-items":[{items:[...de(),{baseline:["","last"]}]}],"align-self":[{self:["auto",...de(),{baseline:["","last"]}]}],"place-content":[{"place-content":ae()}],"place-items":[{"place-items":[...de(),"baseline"]}],"place-self":[{"place-self":["auto",...de()]}],p:[{p:I()}],px:[{px:I()}],py:[{py:I()}],ps:[{ps:I()}],pe:[{pe:I()}],pt:[{pt:I()}],pr:[{pr:I()}],pb:[{pb:I()}],pl:[{pl:I()}],m:[{m:z()}],mx:[{mx:z()}],my:[{my:z()}],ms:[{ms:z()}],me:[{me:z()}],mt:[{mt:z()}],mr:[{mr:z()}],mb:[{mb:z()}],ml:[{ml:z()}],"space-x":[{"space-x":I()}],"space-x-reverse":["space-x-reverse"],"space-y":[{"space-y":I()}],"space-y-reverse":["space-y-reverse"],size:[{size:$()}],w:[{w:[o,"screen",...$()]}],"min-w":[{"min-w":[o,"screen","none",...$()]}],"max-w":[{"max-w":[o,"screen","none","prose",{screen:[a]},...$()]}],h:[{h:["screen","lh",...$()]}],"min-h":[{"min-h":["screen","lh","none",...$()]}],"max-h":[{"max-h":["screen","lh",...$()]}],"font-size":[{text:["base",t,Ar,fa]}],"font-smoothing":["antialiased","subpixel-antialiased"],"font-style":["italic","not-italic"],"font-weight":[{font:[s,Ce,ef]}],"font-stretch":[{"font-stretch":["ultra-condensed","extra-condensed","condensed","semi-condensed","normal","semi-expanded","expanded","extra-expanded","ultra-expanded",Zh,xe]}],"font-family":[{font:[gE,xe,e]}],"fvn-normal":["normal-nums"],"fvn-ordinal":["ordinal"],"fvn-slashed-zero":["slashed-zero"],"fvn-figure":["lining-nums","oldstyle-nums"],"fvn-spacing":["proportional-nums","tabular-nums"],"fvn-fraction":["diagonal-fractions","stacked-fractions"],tracking:[{tracking:[n,Ce,xe]}],"line-clamp":[{"line-clamp":[Ve,"none",Ce,ef]}],leading:[{leading:[i,...I()]}],"list-image":[{"list-image":["none",Ce,xe]}],"list-style-position":[{list:["inside","outside"]}],"list-style-type":[{list:["disc","decimal","none",Ce,xe]}],"text-alignment":[{text:["left","center","right","justify","start","end"]}],"placeholder-color":[{placeholder:q()}],"text-color":[{text:q()}],"text-decoration":["underline","overline","line-through","no-underline"],"text-decoration-style":[{decoration:[...Z(),"wavy"]}],"text-decoration-thickness":[{decoration:[Ve,"from-font","auto",Ce,fa]}],"text-decoration-color":[{decoration:q()}],"underline-offset":[{"underline-offset":[Ve,"auto",Ce,xe]}],"text-transform":["uppercase","lowercase","capitalize","normal-case"],"text-overflow":["truncate","text-ellipsis","text-clip"],"text-wrap":[{text:["wrap","nowrap","balance","pretty"]}],indent:[{indent:I()}],"vertical-align":[{align:["baseline","top","middle","bottom","text-top","text-bottom","sub","super",Ce,xe]}],whitespace:[{whitespace:["normal","nowrap","pre","pre-line","pre-wrap","break-spaces"]}],break:[{break:["normal","words","all","keep"]}],wrap:[{wrap:["break-word","anywhere","normal"]}],hyphens:[{hyphens:["none","manual","auto"]}],content:[{content:["none",Ce,xe]}],"bg-attachment":[{bg:["fixed","local","scroll"]}],"bg-clip":[{"bg-clip":["border","padding","content","text"]}],"bg-origin":[{"bg-origin":["border","padding","content"]}],"bg-position":[{bg:ee()}],"bg-repeat":[{bg:me()}],"bg-size":[{bg:N()}],"bg-image":[{bg:["none",{linear:[{to:["t","tr","r","br","b","bl","l","tl"]},_i,Ce,xe],radial:["",Ce,xe],conic:[_i,Ce,xe]},yE,pE]}],"bg-color":[{bg:q()}],"gradient-from-pos":[{from:J()}],"gradient-via-pos":[{via:J()}],"gradient-to-pos":[{to:J()}],"gradient-from":[{from:q()}],"gradient-via":[{via:q()}],"gradient-to":[{to:q()}],rounded:[{rounded:K()}],"rounded-s":[{"rounded-s":K()}],"rounded-e":[{"rounded-e":K()}],"rounded-t":[{"rounded-t":K()}],"rounded-r":[{"rounded-r":K()}],"rounded-b":[{"rounded-b":K()}],"rounded-l":[{"rounded-l":K()}],"rounded-ss":[{"rounded-ss":K()}],"rounded-se":[{"rounded-se":K()}],"rounded-ee":[{"rounded-ee":K()}],"rounded-es":[{"rounded-es":K()}],"rounded-tl":[{"rounded-tl":K()}],"rounded-tr":[{"rounded-tr":K()}],"rounded-br":[{"rounded-br":K()}],"rounded-bl":[{"rounded-bl":K()}],"border-w":[{border:ie()}],"border-w-x":[{"border-x":ie()}],"border-w-y":[{"border-y":ie()}],"border-w-s":[{"border-s":ie()}],"border-w-e":[{"border-e":ie()}],"border-w-t":[{"border-t":ie()}],"border-w-r":[{"border-r":ie()}],"border-w-b":[{"border-b":ie()}],"border-w-l":[{"border-l":ie()}],"divide-x":[{"divide-x":ie()}],"divide-x-reverse":["divide-x-reverse"],"divide-y":[{"divide-y":ie()}],"divide-y-reverse":["divide-y-reverse"],"border-style":[{border:[...Z(),"hidden","none"]}],"divide-style":[{divide:[...Z(),"hidden","none"]}],"border-color":[{border:q()}],"border-color-x":[{"border-x":q()}],"border-color-y":[{"border-y":q()}],"border-color-s":[{"border-s":q()}],"border-color-e":[{"border-e":q()}],"border-color-t":[{"border-t":q()}],"border-color-r":[{"border-r":q()}],"border-color-b":[{"border-b":q()}],"border-color-l":[{"border-l":q()}],"divide-color":[{divide:q()}],"outline-style":[{outline:[...Z(),"none","hidden"]}],"outline-offset":[{"outline-offset":[Ve,Ce,xe]}],"outline-w":[{outline:["",Ve,Ar,fa]}],"outline-color":[{outline:q()}],shadow:[{shadow:["","none",h,bl,vl]}],"shadow-color":[{shadow:q()}],"inset-shadow":[{"inset-shadow":["none",p,bl,vl]}],"inset-shadow-color":[{"inset-shadow":q()}],"ring-w":[{ring:ie()}],"ring-w-inset":["ring-inset"],"ring-color":[{ring:q()}],"ring-offset-w":[{"ring-offset":[Ve,fa]}],"ring-offset-color":[{"ring-offset":q()}],"inset-ring-w":[{"inset-ring":ie()}],"inset-ring-color":[{"inset-ring":q()}],"text-shadow":[{"text-shadow":["none",g,bl,vl]}],"text-shadow-color":[{"text-shadow":q()}],opacity:[{opacity:[Ve,Ce,xe]}],"mix-blend":[{"mix-blend":[...re(),"plus-darker","plus-lighter"]}],"bg-blend":[{"bg-blend":re()}],"mask-clip":[{"mask-clip":["border","padding","content","fill","stroke","view"]},"mask-no-clip"],"mask-composite":[{mask:["add","subtract","intersect","exclude"]}],"mask-image-linear-pos":[{"mask-linear":[Ve]}],"mask-image-linear-from-pos":[{"mask-linear-from":V()}],"mask-image-linear-to-pos":[{"mask-linear-to":V()}],"mask-image-linear-from-color":[{"mask-linear-from":q()}],"mask-image-linear-to-color":[{"mask-linear-to":q()}],"mask-image-t-from-pos":[{"mask-t-from":V()}],"mask-image-t-to-pos":[{"mask-t-to":V()}],"mask-image-t-from-color":[{"mask-t-from":q()}],"mask-image-t-to-color":[{"mask-t-to":q()}],"mask-image-r-from-pos":[{"mask-r-from":V()}],"mask-image-r-to-pos":[{"mask-r-to":V()}],"mask-image-r-from-color":[{"mask-r-from":q()}],"mask-image-r-to-color":[{"mask-r-to":q()}],"mask-image-b-from-pos":[{"mask-b-from":V()}],"mask-image-b-to-pos":[{"mask-b-to":V()}],"mask-image-b-from-color":[{"mask-b-from":q()}],"mask-image-b-to-color":[{"mask-b-to":q()}],"mask-image-l-from-pos":[{"mask-l-from":V()}],"mask-image-l-to-pos":[{"mask-l-to":V()}],"mask-image-l-from-color":[{"mask-l-from":q()}],"mask-image-l-to-color":[{"mask-l-to":q()}],"mask-image-x-from-pos":[{"mask-x-from":V()}],"mask-image-x-to-pos":[{"mask-x-to":V()}],"mask-image-x-from-color":[{"mask-x-from":q()}],"mask-image-x-to-color":[{"mask-x-to":q()}],"mask-image-y-from-pos":[{"mask-y-from":V()}],"mask-image-y-to-pos":[{"mask-y-to":V()}],"mask-image-y-from-color":[{"mask-y-from":q()}],"mask-image-y-to-color":[{"mask-y-to":q()}],"mask-image-radial":[{"mask-radial":[Ce,xe]}],"mask-image-radial-from-pos":[{"mask-radial-from":V()}],"mask-image-radial-to-pos":[{"mask-radial-to":V()}],"mask-image-radial-from-color":[{"mask-radial-from":q()}],"mask-image-radial-to-color":[{"mask-radial-to":q()}],"mask-image-radial-shape":[{"mask-radial":["circle","ellipse"]}],"mask-image-radial-size":[{"mask-radial":[{closest:["side","corner"],farthest:["side","corner"]}]}],"mask-image-radial-pos":[{"mask-radial-at":A()}],"mask-image-conic-pos":[{"mask-conic":[Ve]}],"mask-image-conic-from-pos":[{"mask-conic-from":V()}],"mask-image-conic-to-pos":[{"mask-conic-to":V()}],"mask-image-conic-from-color":[{"mask-conic-from":q()}],"mask-image-conic-to-color":[{"mask-conic-to":q()}],"mask-mode":[{mask:["alpha","luminance","match"]}],"mask-origin":[{"mask-origin":["border","padding","content","fill","stroke","view"]}],"mask-position":[{mask:ee()}],"mask-repeat":[{mask:me()}],"mask-size":[{mask:N()}],"mask-type":[{"mask-type":["alpha","luminance"]}],"mask-image":[{mask:["none",Ce,xe]}],filter:[{filter:["","none",Ce,xe]}],blur:[{blur:j()}],brightness:[{brightness:[Ve,Ce,xe]}],contrast:[{contrast:[Ve,Ce,xe]}],"drop-shadow":[{"drop-shadow":["","none",v,bl,vl]}],"drop-shadow-color":[{"drop-shadow":q()}],grayscale:[{grayscale:["",Ve,Ce,xe]}],"hue-rotate":[{"hue-rotate":[Ve,Ce,xe]}],invert:[{invert:["",Ve,Ce,xe]}],saturate:[{saturate:[Ve,Ce,xe]}],sepia:[{sepia:["",Ve,Ce,xe]}],"backdrop-filter":[{"backdrop-filter":["","none",Ce,xe]}],"backdrop-blur":[{"backdrop-blur":j()}],"backdrop-brightness":[{"backdrop-brightness":[Ve,Ce,xe]}],"backdrop-contrast":[{"backdrop-contrast":[Ve,Ce,xe]}],"backdrop-grayscale":[{"backdrop-grayscale":["",Ve,Ce,xe]}],"backdrop-hue-rotate":[{"backdrop-hue-rotate":[Ve,Ce,xe]}],"backdrop-invert":[{"backdrop-invert":["",Ve,Ce,xe]}],"backdrop-opacity":[{"backdrop-opacity":[Ve,Ce,xe]}],"backdrop-saturate":[{"backdrop-saturate":[Ve,Ce,xe]}],"backdrop-sepia":[{"backdrop-sepia":["",Ve,Ce,xe]}],"border-collapse":[{border:["collapse","separate"]}],"border-spacing":[{"border-spacing":I()}],"border-spacing-x":[{"border-spacing-x":I()}],"border-spacing-y":[{"border-spacing-y":I()}],"table-layout":[{table:["auto","fixed"]}],caption:[{caption:["top","bottom"]}],transition:[{transition:["","all","colors","opacity","shadow","transform","none",Ce,xe]}],"transition-behavior":[{transition:["normal","discrete"]}],duration:[{duration:[Ve,"initial",Ce,xe]}],ease:[{ease:["linear","initial",S,Ce,xe]}],delay:[{delay:[Ve,Ce,xe]}],animate:[{animate:["none",T,Ce,xe]}],backface:[{backface:["hidden","visible"]}],perspective:[{perspective:[M,Ce,xe]}],"perspective-origin":[{"perspective-origin":k()}],rotate:[{rotate:ue()}],"rotate-x":[{"rotate-x":ue()}],"rotate-y":[{"rotate-y":ue()}],"rotate-z":[{"rotate-z":ue()}],scale:[{scale:fe()}],"scale-x":[{"scale-x":fe()}],"scale-y":[{"scale-y":fe()}],"scale-z":[{"scale-z":fe()}],"scale-3d":["scale-3d"],skew:[{skew:ge()}],"skew-x":[{"skew-x":ge()}],"skew-y":[{"skew-y":ge()}],transform:[{transform:[Ce,xe,"","none","gpu","cpu"]}],"transform-origin":[{origin:k()}],"transform-style":[{transform:["3d","flat"]}],translate:[{translate:pe()}],"translate-x":[{"translate-x":pe()}],"translate-y":[{"translate-y":pe()}],"translate-z":[{"translate-z":pe()}],"translate-none":["translate-none"],accent:[{accent:q()}],appearance:[{appearance:["none","auto"]}],"caret-color":[{caret:q()}],"color-scheme":[{scheme:["normal","dark","light","light-dark","only-dark","only-light"]}],cursor:[{cursor:["auto","default","pointer","wait","text","move","help","not-allowed","none","context-menu","progress","cell","crosshair","vertical-text","alias","copy","no-drop","grab","grabbing","all-scroll","col-resize","row-resize","n-resize","e-resize","s-resize","w-resize","ne-resize","nw-resize","se-resize","sw-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","zoom-in","zoom-out",Ce,xe]}],"field-sizing":[{"field-sizing":["fixed","content"]}],"pointer-events":[{"pointer-events":["auto","none"]}],resize:[{resize:["none","","y","x"]}],"scroll-behavior":[{scroll:["auto","smooth"]}],"scroll-m":[{"scroll-m":I()}],"scroll-mx":[{"scroll-mx":I()}],"scroll-my":[{"scroll-my":I()}],"scroll-ms":[{"scroll-ms":I()}],"scroll-me":[{"scroll-me":I()}],"scroll-mt":[{"scroll-mt":I()}],"scroll-mr":[{"scroll-mr":I()}],"scroll-mb":[{"scroll-mb":I()}],"scroll-ml":[{"scroll-ml":I()}],"scroll-p":[{"scroll-p":I()}],"scroll-px":[{"scroll-px":I()}],"scroll-py":[{"scroll-py":I()}],"scroll-ps":[{"scroll-ps":I()}],"scroll-pe":[{"scroll-pe":I()}],"scroll-pt":[{"scroll-pt":I()}],"scroll-pr":[{"scroll-pr":I()}],"scroll-pb":[{"scroll-pb":I()}],"scroll-pl":[{"scroll-pl":I()}],"snap-align":[{snap:["start","end","center","align-none"]}],"snap-stop":[{snap:["normal","always"]}],"snap-type":[{snap:["none","x","y","both"]}],"snap-strictness":[{snap:["mandatory","proximity"]}],touch:[{touch:["auto","none","manipulation"]}],"touch-x":[{"touch-pan":["x","left","right"]}],"touch-y":[{"touch-pan":["y","up","down"]}],"touch-pz":["touch-pinch-zoom"],select:[{select:["none","text","all","auto"]}],"will-change":[{"will-change":["auto","scroll","contents","transform",Ce,xe]}],fill:[{fill:["none",...q()]}],"stroke-w":[{stroke:[Ve,Ar,fa,ef]}],stroke:[{stroke:["none",...q()]}],"forced-color-adjust":[{"forced-color-adjust":["auto","none"]}]},conflictingClassGroups:{overflow:["overflow-x","overflow-y"],overscroll:["overscroll-x","overscroll-y"],inset:["inset-x","inset-y","start","end","top","right","bottom","left"],"inset-x":["right","left"],"inset-y":["top","bottom"],flex:["basis","grow","shrink"],gap:["gap-x","gap-y"],p:["px","py","ps","pe","pt","pr","pb","pl"],px:["pr","pl"],py:["pt","pb"],m:["mx","my","ms","me","mt","mr","mb","ml"],mx:["mr","ml"],my:["mt","mb"],size:["w","h"],"font-size":["leading"],"fvn-normal":["fvn-ordinal","fvn-slashed-zero","fvn-figure","fvn-spacing","fvn-fraction"],"fvn-ordinal":["fvn-normal"],"fvn-slashed-zero":["fvn-normal"],"fvn-figure":["fvn-normal"],"fvn-spacing":["fvn-normal"],"fvn-fraction":["fvn-normal"],"line-clamp":["display","overflow"],rounded:["rounded-s","rounded-e","rounded-t","rounded-r","rounded-b","rounded-l","rounded-ss","rounded-se","rounded-ee","rounded-es","rounded-tl","rounded-tr","rounded-br","rounded-bl"],"rounded-s":["rounded-ss","rounded-es"],"rounded-e":["rounded-se","rounded-ee"],"rounded-t":["rounded-tl","rounded-tr"],"rounded-r":["rounded-tr","rounded-br"],"rounded-b":["rounded-br","rounded-bl"],"rounded-l":["rounded-tl","rounded-bl"],"border-spacing":["border-spacing-x","border-spacing-y"],"border-w":["border-w-x","border-w-y","border-w-s","border-w-e","border-w-t","border-w-r","border-w-b","border-w-l"],"border-w-x":["border-w-r","border-w-l"],"border-w-y":["border-w-t","border-w-b"],"border-color":["border-color-x","border-color-y","border-color-s","border-color-e","border-color-t","border-color-r","border-color-b","border-color-l"],"border-color-x":["border-color-r","border-color-l"],"border-color-y":["border-color-t","border-color-b"],translate:["translate-x","translate-y","translate-none"],"translate-none":["translate","translate-x","translate-y","translate-z"],"scroll-m":["scroll-mx","scroll-my","scroll-ms","scroll-me","scroll-mt","scroll-mr","scroll-mb","scroll-ml"],"scroll-mx":["scroll-mr","scroll-ml"],"scroll-my":["scroll-mt","scroll-mb"],"scroll-p":["scroll-px","scroll-py","scroll-ps","scroll-pe","scroll-pt","scroll-pr","scroll-pb","scroll-pl"],"scroll-px":["scroll-pr","scroll-pl"],"scroll-py":["scroll-pt","scroll-pb"],touch:["touch-x","touch-y","touch-pz"],"touch-x":["touch"],"touch-y":["touch"],"touch-pz":["touch"]},conflictingClassGroupModifiers:{"font-size":["leading"]},orderSensitiveModifiers:["*","**","after","backdrop","before","details-content","file","first-letter","first-line","marker","placeholder","selection"]}},wE=eE(ME);function Ae(...c){return wE(ub(c))}function w3(c,e){return c?{...e,...c}:e}const Kf=Gf("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),De=R.forwardRef(({className:c,variant:e,size:t,asChild:s=!1,...n},i)=>{const a=s?kT:"button";return y.jsx(a,{className:Ae(Kf({variant:e,size:t,className:c})),ref:i,...n})});De.displayName="Button";var Vr=eb();const SE=Bf(Vr);var xE=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],CE=xE.reduce((c,e)=>{const t=Vf(`Primitive.${e}`),s=R.forwardRef((n,i)=>{const{asChild:a,...o}=n,l=a?t:e;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),y.jsx(l,{...o,ref:i})});return s.displayName=`Primitive.${e}`,{...c,[e]:s}},{}),RE="Separator",sv="horizontal",TE=["horizontal","vertical"],xb=R.forwardRef((c,e)=>{const{decorative:t,orientation:s=sv,...n}=c,i=EE(s)?s:sv,o=t?{role:"none"}:{"aria-orientation":i==="vertical"?i:void 0,role:"separator"};return y.jsx(CE.div,{"data-orientation":i,...o,...n,ref:e})});xb.displayName=RE;function EE(c){return TE.includes(c)}var Cb=xb;const vs=R.forwardRef(({className:c,orientation:e="horizontal",decorative:t=!0,...s},n)=>y.jsx(Cb,{ref:n,decorative:t,orientation:e,className:Ae("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",c),...s}));vs.displayName=Cb.displayName;const nv=c=>{let e;const t=new Set,s=(d,h)=>{const p=typeof d=="function"?d(e):d;if(!Object.is(p,e)){const g=e;e=h??(typeof p!="object"||p===null)?p:Object.assign({},e,p),t.forEach(v=>v(e,g))}},n=()=>e,o={setState:s,getState:n,getInitialState:()=>l,subscribe:d=>(t.add(d),()=>t.delete(d))},l=e=c(s,n,o);return o},kE=(c=>c?nv(c):nv),AE=c=>c;function DE(c,e=AE){const t=Dt.useSyncExternalStore(c.subscribe,Dt.useCallback(()=>e(c.getState()),[c,e]),Dt.useCallback(()=>e(c.getInitialState()),[c,e]));return Dt.useDebugValue(t),t}const iv=c=>{const e=kE(c),t=s=>DE(e,s);return Object.assign(t,e),t},hn=(c=>c?iv(c):iv);class Rb{transformForProtocol(e,t){const s=this.getProtocol(t);if(!s)return e;const n=t.data?.protocolConfig||{};switch(s){case"rest":return this.transformForREST(e,n);case"graphql":return this.transformForGraphQL(e,n);case"soap":return this.transformForSOAP(e,n);case"grpc":return this.transformForGRPC(e,n);case"websocket":return this.transformForWebSocket(e,n);case"webhook":return this.transformForWebhook(e,n);default:return e}}getProtocol(e){return e.type&&["rest","graphql","soap","grpc","websocket","webhook"].includes(e.type)?e.type:e.data?.protocol?e.data.protocol:e.type==="http"?"rest":null}transformForREST(e,t){if(e.format!=="json"&&(e.format="json",e.status="transformed"),typeof e.payload!="string")try{e.payload=JSON.stringify(e.payload)}catch{}const s=t.httpMethod||"POST",n=t.contentType||"json",i=t.headers||{};return e.metadata={...e.metadata,"Content-Type":n==="json"?"application/json":n==="xml"?"application/xml":"application/x-www-form-urlencoded",Accept:"application/json","X-HTTP-Method":s,...i},e}transformForGraphQL(e,t){e.format!=="json"&&(e.format="json",e.status="transformed");const s=t.query||"",n=t.operationName,i=t.variables||{},a={query:s,...n&&{operationName:n},...Object.keys(i).length>0&&{variables:i}};return e.payload=JSON.stringify(a),e.metadata={...e.metadata,"Content-Type":"application/json",Accept:"application/json"},e}transformForSOAP(e,t){e.format!=="xml"&&(e.format="xml",e.status="transformed");const s=t.soapAction||"",n=t.namespace||"http://schemas.xmlsoap.org/soap/envelope/";return e.metadata={...e.metadata,"Content-Type":"text/xml; charset=utf-8",SOAPAction:s,"X-SOAP-Namespace":n},e}transformForGRPC(e,t){e.format!=="binary"&&(e.format="binary",e.status="transformed");const s=t.serviceName||"",n=t.methodName||"",i=t.metadata||{};return e.metadata={...e.metadata,"grpc-service":s,"grpc-method":n,...i},e}transformForWebSocket(e,t){const s=t.binaryType||"blob",n=t.wsProtocol,i=t.subprotocols||[];return s==="arraybuffer"&&e.format!=="binary"?(e.format="binary",e.status="transformed"):e.format!=="text"&&e.format!=="binary"&&(e.format="text",e.status="transformed"),e.metadata={...e.metadata,...n&&{"Sec-WebSocket-Protocol":n},...i.length>0&&{"X-WebSocket-Subprotocols":i.join(",")}},e}transformForWebhook(e,t){e.format!=="json"&&(e.format="json",e.status="transformed");const s=t.webhookEvent||"",n=t.signatureHeader||"X-Signature";return e.metadata={...e.metadata,"Content-Type":"application/json","X-Webhook-Event":s,"X-Signature-Header":n},e}getSupportedFormats(e){switch(e){case"rest":return["json","xml"];case"graphql":return["json"];case"soap":return["xml"];case"grpc":return["binary"];case"websocket":return["text","binary"];case"webhook":return["json"];default:return["json","xml","text","binary"]}}calculateProtocolLatencyMultiplier(e){return{rest:1,graphql:1.1,soap:1.3,grpc:.7,websocket:.9,webhook:1}[e]||1}}class PE{nodes=[];connections=[];handlers=new Map;postgresQueryEngine=null;messageQueue=new Map;messageHistory=[];isRunning=!1;updateInterval=200;intervalId=null;messageIdCounter=0;MAX_HISTORY=1e3;traceContexts=new Map;traceIdCounter=0;protocolTransformer=new Rb;constructor(){this.registerDefaultHandlers()}registerDefaultHandlers(){this.registerHandler("crm",this.createBusinessDataHandler("crm")),this.registerHandler("erp",this.createBusinessDataHandler("erp")),this.registerHandler("payment-gateway",this.createBusinessDataHandler("payment")),this.registerHandler("postgres",this.createDatabaseHandler("postgres")),this.registerHandler("mongodb",this.createDatabaseHandler("mongodb")),this.registerHandler("redis",this.createDatabaseHandler("redis")),this.registerHandler("cassandra",this.createDatabaseHandler("cassandra")),this.registerHandler("clickhouse",this.createDatabaseHandler("clickhouse")),this.registerHandler("snowflake",this.createDatabaseHandler("snowflake")),this.registerHandler("elasticsearch",this.createDatabaseHandler("elasticsearch")),this.registerHandler("s3-datalake",this.createStorageHandler("s3-datalake")),this.registerHandler("kafka",this.createMessageBrokerHandler("kafka")),this.registerHandler("rabbitmq",this.createMessageBrokerHandler("rabbitmq")),this.registerHandler("activemq",this.createMessageBrokerHandler("activemq")),this.registerHandler("aws-sqs",this.createMessageBrokerHandler("aws-sqs")),this.registerHandler("gcp-pubsub",this.createMessageBrokerHandler("gcp-pubsub")),this.registerHandler("kong",this.createIntegrationHandler("kong")),this.registerHandler("api-gateway",this.createIntegrationHandler("api-gateway")),this.registerHandler("nginx",this.createIntegrationHandler("nginx")),this.registerHandler("haproxy",this.createIntegrationHandler("haproxy")),this.registerHandler("traefik",this.createIntegrationHandler("traefik")),this.registerHandler("envoy",this.createIntegrationHandler("envoy")),this.registerHandler("cdn",this.createIntegrationHandler("cdn")),this.registerHandler("apigee",this.createIntegrationHandler("apigee")),this.registerHandler("mulesoft",this.createIntegrationHandler("mulesoft")),this.registerHandler("graphql-gateway",this.createIntegrationHandler("graphql-gateway")),this.registerHandler("bff-service",this.createIntegrationHandler("bff-service")),this.registerHandler("webhook-relay",this.createIntegrationHandler("webhook-relay")),this.registerHandler("loki",this.createLokiHandler()),this.registerHandler("otel-collector",this.createOpenTelemetryCollectorHandler()),this.registerHandler("keycloak",this.createKeycloakHandler()),this.registerHandler("secrets-vault",this.createVaultHandler()),this.registerHandler("waf",this.createWAFHandler()),this.registerHandler("firewall",this.createFirewallHandler()),this.registerHandler("ids-ips",this.createIDSIPSHandler()),this.registerHandler("jenkins",this.createJenkinsHandler()),this.registerHandler("gitlab-ci",this.createGitLabCIHandler()),this.registerHandler("argo-cd",this.createArgoCDHandler()),this.registerHandler("terraform",this.createTerraformHandler()),this.registerHandler("harbor",this.createHarborHandler()),this.registerHandler("docker",this.createDockerHandler()),this.registerHandler("spark",this.createSparkHandler()),this.registerHandler("tensorflow-serving",this.createTensorFlowServingHandler()),this.registerHandler("pytorch-serve",this.createPyTorchServeHandler()),this.registerHandler("feature-store",this.createFeatureStoreHandler())}registerHandler(e,t){this.handlers.set(e,t)}initialize(e,t){this.nodes=e,this.connections=t,this.messageQueue.clear(),this.messageHistory=[];for(const s of t)this.messageQueue.set(s.id,[])}updateNodesAndConnections(e,t){this.nodes=e,this.connections=t;const s=new Set(t.map(n=>n.id));for(const[n]of this.messageQueue.entries())s.has(n)||this.messageQueue.delete(n);for(const n of t)this.messageQueue.has(n.id)||this.messageQueue.set(n.id,[])}start(){this.isRunning||(this.isRunning=!0,this.intervalId=setInterval(()=>{this.processDataFlow()},this.updateInterval))}stop(){this.isRunning=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}processDataFlow(){this.generateSourceData(),this.processInTransitMessages(),this.deliverMessages()}generateSourceData(){for(const e of this.connections){const t=this.nodes.find(a=>a.id===e.source);if(!t)continue;const s=this.handlers.get(t.type);if(!s?.generateData)continue;const n=t.data.config||{},i=s.generateData(t,n);if(i&&i.length>0){const a=this.messageQueue.get(e.id)||[];for(const o of i)o.connectionId=e.id,o.target=e.target,o.status="pending",o.id=`msg-${++this.messageIdCounter}`,o.timestamp=Date.now(),a.push(o);this.messageQueue.set(e.id,a)}}}processInTransitMessages(){for(const[e,t]of this.messageQueue.entries()){const s=this.connections.find(a=>a.id===e);if(!s)continue;const n=this.nodes.find(a=>a.id===s.source),i=this.nodes.find(a=>a.id===s.target);if(!(!n||!i)){for(const a of t)if(a.status==="pending")this.transformMessageIfNeeded(a,n,i,s)&&(a.status="in-transit",a.latency=this.calculateTransitTime(s));else if(a.status==="in-transit"){const o=Date.now()-a.timestamp;a.latency&&o>=a.latency&&(a.status="delivered")}}}}deliverMessages(){for(const[e,t]of this.messageQueue.entries()){const s=this.connections.find(l=>l.id===e);if(!s)continue;const n=this.nodes.find(l=>l.id===s.target);if(!n)continue;const i=this.handlers.get(n.type);if(!i?.processData)continue;const a=n.data.config||{},o=t.filter(l=>l.status==="delivered");for(const l of o)try{const d=this.nodes.find(p=>p.id===s.source),h=i.processData(n,l,a);h&&(d&&this.generateTraceForMessage(l,d,n,s,h),this.addToHistory(l),t.splice(t.indexOf(l),1))}catch(d){l.status="failed",l.error=d instanceof Error?d.message:"Unknown error";const h=this.nodes.find(p=>p.id===s.source);h&&this.generateTraceForMessage(l,h,n,s,l),this.addToHistory(l),t.splice(t.indexOf(l),1)}this.messageQueue.set(e,t)}}transformMessageIfNeeded(e,t,s,n){const i=this.getConnectionProtocol(n);i&&(e=this.protocolTransformer.transformForProtocol(e,n));const a=this.handlers.get(t.type),o=this.handlers.get(s.type),l=a?.getSupportedFormats?.(t)||[e.format],d=o?.getSupportedFormats?.(s)||[e.format];if(i&&this.protocolTransformer.getSupportedFormats(i).includes(e.format)||d.includes(e.format))return e;const h=d.find(g=>l.includes(g));if(h)return e.format=h,e.status="transformed",e;const p=this.findIntegrationHandler(n);if(p?.transformData){const g=p.transformData(t,e,s.type,t.data.config||{});if(g)return g}if(a?.transformData){const g=a.transformData(t,e,s.type,t.data.config||{});if(g)return g}return e.status="failed",e.error=`Format ${e.format} not supported by target ${s.type}`,null}getConnectionProtocol(e){return e.type&&["rest","graphql","soap","grpc","websocket","webhook"].includes(e.type)?e.type:e.data?.protocol?e.data.protocol:e.type==="http"?"rest":null}findIntegrationHandler(e){const t=this.nodes.find(s=>s.id===e.source);return t&&["kong","api-gateway","apigee","mulesoft","bff-service"].includes(t.type)&&this.handlers.get(t.type)||null}calculateTransitTime(e){const t=e.data||{},s=t.latencyMs||10,n=(t.jitterMs||0)*(Math.random()-.5),i=this.getConnectionProtocol(e);let a=1;return i&&(a=this.protocolTransformer.calculateProtocolLatencyMultiplier(i)),Math.max(1,(s+n)*a)}generateTraceForMessage(e,t,s,n,i){const a=ve.getAllJaegerEngines();if(a.size===0)return;let o=e.metadata?.traceContext;if(!o){const v=this.generateTraceId(),b=this.generateSpanId();o={traceId:v,spanId:b,sampled:!0},this.traceContexts.set(v,o)}const l=e.timestamp*1e3,d=(e.timestamp+(e.latency||0))*1e3,h=d-l,p=this.getOperationName(e,t,s),g={traceId:o.traceId,spanId:o.spanId,parentSpanId:o.parentSpanId,operationName:p,serviceName:t.data.label||t.type,startTime:l,duration:h,tags:[{key:"component.type",value:t.type},{key:"target.component",value:s.data.label||s.type},{key:"target.type",value:s.type},{key:"message.format",value:e.format},{key:"message.size",value:e.size},{key:"connection.id",value:n.id},{key:"status",value:i.status}],logs:[]};if((i.status==="failed"||i.error)&&(g.tags.push({key:"error",value:!0}),g.logs.push({timestamp:d,fields:[{key:"event",value:"error"},{key:"error.message",value:i.error||"Unknown error"}]})),e.metadata)for(const[v,b]of Object.entries(e.metadata))v!=="traceContext"&&b!==void 0&&b!==null&&g.tags.push({key:`metadata.${v}`,value:String(b)});for(const[,v]of a)v.receiveSpan(g);if(i.status==="delivered"&&s){const v=this.generateSpanId(),b={traceId:o.traceId,spanId:v,parentSpanId:o.spanId,sampled:o.sampled};i.metadata||(i.metadata={}),i.metadata.traceContext=b}}generateTraceId(){return`trace-${++this.traceIdCounter}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSpanId(){return`span-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getOperationName(e,t,s){return e.metadata?.operation?String(e.metadata.operation):t.type==="api-gateway"||t.type==="kong"||t.type==="apigee"?`HTTP ${e.metadata?.method||"REQUEST"}`:t.type.includes("database")||t.type==="postgres"||t.type==="mongodb"?`DB ${e.metadata?.queryType||"QUERY"}`:t.type.includes("queue")||t.type==="rabbitmq"||t.type==="kafka"?`MQ ${e.metadata?.queue||"SEND"}`:`${t.type} -> ${s.type}`}addToHistory(e){this.messageHistory.push(e),this.messageHistory.length>this.MAX_HISTORY&&this.messageHistory.shift()}getConnectionMessages(e){return this.messageQueue.get(e)||[]}getMessageHistory(e){const t=[...this.messageHistory].reverse();return e?t.slice(0,e):t}getComponentMessages(e){const t=[];for(const s of this.messageQueue.values())for(const n of s)(n.source===e||n.target===e)&&t.push(n);return t}createBusinessDataHandler(e){return{generateData:(t,s)=>{const n=[],i=s.generateInterval||2e3,a=t._lastGenerate||0,o=Date.now();if(o-a<i)return null;switch(t._lastGenerate=o,e){case"crm":n.push(this.createCRMDataMessage(t));break;case"erp":n.push(this.createERPDataMessage(t));break;case"payment":const l=this.createPaymentDataMessage(t);l&&n.push(l);break}return n},processData:(t,s,n)=>{if(e==="payment"){const i=ve.getPaymentGatewayEmulationEngine(t.id);if(i){const a=this.nodes.find(d=>d.id===s.source),o=s.metadata?.sourceType||a?.type||"unknown";s.metadata={...s.metadata,sourceType:o};const l=i.processIncomingData({payload:s.payload,source:s.source,metadata:s.metadata});l.processed?(s.status="delivered",s.latency=10):(s.status="failed",s.error=l.error||"Failed to process incoming data")}else s.status="delivered",s.latency=10}return s},transformData:(t,s,n,i)=>{if(e==="payment"){const a=ve.getPaymentGatewayEmulationEngine(t.id);if(a&&s.payload){const o=s.payload;if(o.data&&o.data.id){const l={id:o.data.id,amount:o.data.amount,currency:o.data.currency,status:o.data.status,paymentMethod:o.data.paymentMethod,customerId:o.data.customerId,timestamp:o.data.timestamp?new Date(o.data.timestamp).getTime():Date.now(),description:o.data.description,fee:o.data.fee,refundedAmount:o.data.refundedAmount,metadata:o.data.metadata},d=a.formatTransactionForTarget(l,n);s.payload=d,s.status="transformed";const h=JSON.stringify(d);s.size=new Blob([h]).size}}}return s},getSupportedFormats:()=>["json","xml"]}}validateMongoDBSchema(e,t){if(!t||!t.$jsonSchema)return{valid:!0};const s=t.$jsonSchema;if(s.required&&Array.isArray(s.required)){for(const n of s.required)if(!(n in e)||e[n]===void 0||e[n]===null)return{valid:!1,error:`Required field "${n}" is missing`}}if(s.properties){for(const[n,i]of Object.entries(s.properties))if(n in e){const a=e[n],o=i;if(o.type){const l=o.type,d=Array.isArray(a)?"array":typeof a;if(l==="string"&&d!=="string")return{valid:!1,error:`Field "${n}" must be of type string`};if(l==="number"&&d!=="number")return{valid:!1,error:`Field "${n}" must be of type number`};if(l==="boolean"&&d!=="boolean")return{valid:!1,error:`Field "${n}" must be of type boolean`};if(l==="array"&&d!=="array")return{valid:!1,error:`Field "${n}" must be of type array`};if(l==="object"&&(d!=="object"||Array.isArray(a)))return{valid:!1,error:`Field "${n}" must be of type object`}}}}return{valid:!0}}createDatabaseHandler(e){return{processData:(t,s,n)=>{if(e==="postgres"&&s.payload?.sql)return this.processPostgreSQLQuery(t,s,n);if(e==="redis")return this.processRedisCommand(t,s,n);if(e==="cassandra")return this.processCQLQuery(t,s,n);if(e==="clickhouse")return this.processClickHouseQuery(t,s,n);if(e==="snowflake")return this.processSnowflakeQuery(t,s,n);if(e==="elasticsearch")return this.processElasticsearchOperation(t,s,n);const i=s.payload?.operation||"insert";switch(i){case"insert":case"update":{const o=n.queryLatency||10;if(s.latency=o,e==="mongodb"){const d=t.data.config?.collections||[],h=s.payload;let p=h?.collection;if(!p&&d.length>0&&(h?.type?p=d.find(v=>v.name.toLowerCase().includes(h.type.toLowerCase()))?.name||d[0].name:p=d[0].name),p){const g=d.find(v=>v.name===p);if(g){if(g.validation){const v=g.validation;if(v.validationLevel!=="off"){const M={...h?.document||h?.data||h};delete M._id;const x=this.validateMongoDBSchema(M,v.validator);if(!x.valid){if(v.validationAction==="error")return s.status="failed",s.error=`Schema validation failed for collection "${p}": ${x.error}`,s;v.validationAction==="warn"&&(s.metadata={...s.metadata,validationWarning:x.error,collection:p})}}}i==="insert"?s.metadata={...s.metadata,collection:p,documentStored:!0}:i==="update"&&(s.metadata={...s.metadata,collection:p,documentUpdated:!0})}else return s.status="failed",s.error=`Collection "${p}" not found`,s}}return s.status="delivered",s}case"delete":const a=n.queryLatency||10;return s.latency=a,s.status="delivered",s;case"query":{let o=[];if(e==="mongodb"){const d=t.data.config?.collections||[],h=s.payload,p=h?.collection||d[0]?.name;if(p){const g=d.find(v=>v.name===p);if(g?.documents&&g.documents.length>0){if(o=g.documents.map(b=>({...b})),h?.filter)try{const b=typeof h.filter=="string"?JSON.parse(h.filter):h.filter;o=o.filter(M=>{for(const[x,S]of Object.entries(b))if(M[x]!==S)return!1;return!0})}catch{}const v=h?.limit||100;o=o.slice(0,v)}else o=this.generateQueryResults(e,h?.query)}else o=this.generateQueryResults(e,h?.query)}else o=this.generateQueryResults(e,s.payload?.query);return s.payload={...s.payload,results:o},s.status="delivered",s}default:return s.status="failed",s.error=`Unknown operation: ${i}`,s}},getSupportedFormats:()=>["json","binary"]}}processClickHouseQuery(e,t,s){const n=t.payload,i=ve.getClickHouseRoutingEngine(e.id);if(!i)return t.status="failed",t.error="ClickHouse Routing Engine not initialized",t;let a;if(n?.sql)a=n.sql;else if(n?.query)a=n.query;else if(typeof n=="string")a=n;else{const l=n?.operation||"select",d=e.data.config,h=n?.database||d?.database||"default",p=n?.table||"default_table";switch(l.toLowerCase()){case"select":case"read":case"query":a=`SELECT * FROM ${h}.${p}`,n?.where&&(a+=` WHERE ${n.where}`),n?.limit&&(a+=` LIMIT ${n.limit}`);break;case"insert":case"write":const g=n?.columns?Object.keys(n.columns).join(", "):"id, data",v=n?.columns?Object.values(n.columns).map(b=>`'${b}'`).join(", "):`${Date.now()}, 'data'`;a=`INSERT INTO ${h}.${p} (${g}) VALUES (${v})`;break;default:return t.status="failed",t.error=`Unknown ClickHouse operation: ${l}`,t}}const o=i.executeQuery(a);return o.success?(t.status="delivered",t.latency=o.latency||45,t.payload={...t.payload,sql:a,rows:o.rows||[],rowCount:o.rowCount||0,columns:o.columns||[],dataRead:o.dataRead,dataWritten:o.dataWritten,clickHouseResult:o.rows},t.metadata={...t.metadata,clickHouseQuery:a,rowsRead:o.dataRead,rowsWritten:o.dataWritten}):(t.status="failed",t.error=o.error||"ClickHouse query execution failed",t.latency=o.latency||0),t}processSnowflakeQuery(e,t,s){const n=t.payload,i=ve.getSnowflakeRoutingEngine(e.id);if(!i)return t.status="failed",t.error="Snowflake Routing Engine not initialized",t;let a,o,l,d;if(n?.sql)a=n.sql,o=n.warehouse,l=n.database,d=n.schema;else if(n?.query)a=n.query,o=n.warehouse,l=n.database,d=n.schema;else if(typeof n=="string")a=n;else{const p=n?.operation||"select",g=e.data.config;l=n?.database||g?.database||"PUBLIC",d=n?.schema||g?.schema||"PUBLIC",o=n?.warehouse||g?.warehouse;const v=n?.table||"default_table";switch(p.toLowerCase()){case"select":case"read":case"query":a=`SELECT * FROM ${l}.${d}.${v}`,n?.where&&(a+=` WHERE ${n.where}`),n?.limit&&(a+=` LIMIT ${n.limit}`);break;case"insert":case"write":const b=n?.columns?Object.keys(n.columns).join(", "):"id, data",M=n?.columns?Object.values(n.columns).map(x=>`'${x}'`).join(", "):`${Date.now()}, 'data'`;a=`INSERT INTO ${l}.${d}.${v} (${b}) VALUES (${M})`;break;default:return t.status="failed",t.error=`Unknown Snowflake operation: ${p}`,t}}const h=i.executeQuery(a,o,l,d);return h.success?(t.status="delivered",t.latency=h.latency||50,t.payload={...t.payload,sql:a,rows:h.rows||[],rowCount:h.rowCount||0,columns:h.columns||[],dataRead:h.dataRead,dataWritten:h.dataWritten,snowflakeResult:h.rows,queryId:h.queryId,warehouse:h.warehouse,resultCacheUsed:h.resultCacheUsed},t.metadata={...t.metadata,snowflakeQuery:a,rowsRead:h.dataRead,rowsWritten:h.dataWritten,warehouse:h.warehouse,queryId:h.queryId,cacheHit:h.resultCacheUsed||!1}):(t.status="failed",t.error=h.error||"Snowflake query execution failed",t.latency=h.latency||0),t}processElasticsearchOperation(e,t,s){const n=t.payload,i=ve.getElasticsearchRoutingEngine(e.id);if(!i)return t.status="failed",t.error="Elasticsearch Routing Engine not initialized",t;const a=n?.operation||n?.method||"index",o=n?.index||n?._index||e.data.config?.index||"archiphoenix-index",l=n?.id||n?._id,d=n?.document||n?._source||n?.body||n,h=n?.query,p=n?.routing||n?._routing;let g;switch(a.toLowerCase()){case"index":case"create":case"update":if(!l||!d)return t.status="failed",t.error="Index operation requires id and document",t;g=i.indexDocument(o,l,d,p);break;case"get":case"read":if(!l)return t.status="failed",t.error="Get operation requires id",t;g=i.getDocument(o,l,p);break;case"search":case"query":h?g=i.search(o,h):n?.queryString?g=i.executeQuery(n.queryString):g=i.search(o,{query:{match_all:{}}});break;case"delete":if(!l)return t.status="failed",t.error="Delete operation requires id",t;g=i.deleteDocument(o,l,p);break;default:if(typeof n=="string"||n?.queryString){const v=typeof n=="string"?n:n.queryString;g=i.executeQuery(v)}else return t.status="failed",t.error=`Unsupported Elasticsearch operation: ${a}`,t}return g.success?(t.status="delivered",t.latency=g.latency||g.took||10,t.payload={...t.payload,operation:g.operation,index:g.index,id:g.id,document:g.document,hits:g.hits,took:g.took,elasticsearchResult:g},t.metadata={...t.metadata,elasticsearchOperation:g.operation,index:g.index,hits:g.hits,took:g.took}):(t.status="failed",t.error=g.error||"Elasticsearch operation failed",t.latency=g.latency||g.took||0),t}createStorageHandler(e){return e==="s3-datalake"?{processData:(t,s,n)=>this.processS3Operation(t,s,n),getSupportedFormats:()=>["json","binary","text","xml"]}:{processData:(t,s,n)=>(s.status="delivered",s.latency=50,s),getSupportedFormats:()=>["json","binary","text"]}}processS3Operation(e,t,s){const n=t.payload,i=ve.getS3RoutingEngine(e.id);if(!i)return t.status="failed",t.error="S3 Routing Engine not initialized",t;const a=n?.operation||n?.method||"PUT",o=n?.bucket||n?.bucketName||e.data.config?.buckets?.[0]?.name||"default-bucket",l=n?.key||n?.objectKey||t.metadata?.key,d=n?.versionId||t.metadata?.versionId;let h;switch(a.toUpperCase()){case"PUT":case"UPLOAD":if(!l||!t.payload)return t.status="failed",t.error="PUT operation requires key and payload",t;const p=n?.data||n?.body||t.payload,g=n?.contentType||t.metadata?.contentType,v=n?.metadata||t.metadata;h=i.putObject(o,l,p,t.size,v,g);break;case"GET":case"DOWNLOAD":if(!l)return t.status="failed",t.error="GET operation requires key",t;h=i.getObject(o,l,d);break;case"DELETE":if(!l)return t.status="failed",t.error="DELETE operation requires key",t;h=i.deleteObject(o,l,d);break;case"LIST":const b=n?.prefix||t.metadata?.prefix,M=n?.maxKeys||n?.maxKeys||1e3;h=i.listObjects(o,b,M);break;case"HEAD":if(!l)return t.status="failed",t.error="HEAD operation requires key",t;h=i.headObject(o,l);break;default:return t.status="failed",t.error=`Unsupported S3 operation: ${a}`,t}return h.success?(t.status="delivered",t.latency=h.latency||50,h.object?t.payload={...t.payload,operation:a.toUpperCase(),bucket:o,key:l,object:h.object,etag:h.object.etag,versionId:h.versionId||h.object.versionId,size:h.object.size,storageClass:h.object.storageClass}:h.objects?t.payload={...t.payload,operation:"LIST",bucket:o,objects:h.objects,count:h.objects.length}:t.payload={...t.payload,operation:a.toUpperCase(),bucket:o,key:l,success:!0,versionId:h.versionId,deleteMarker:h.deleteMarker},t.metadata={...t.metadata,s3Operation:a.toUpperCase(),bucket:o,key:l,latency:h.latency}):(t.status="failed",t.error=h.error||`S3 ${a} operation failed`,t.latency=h.latency||0),t}processPostgreSQLQuery(e,t,s){if(!this.postgresQueryEngine)return t.status="failed",t.error="PostgreSQL Query Engine not initialized",t;const n=t.payload?.sql;if(!n||typeof n!="string")return t.status="failed",t.error="No SQL query provided",t;const i=e.data.config,a=i.tables||[],o=this.extractIndexesFromConfig(i,a),l=i.views||[],d=this.postgresQueryEngine.execute(n,a,o,l);return d.success?(t.status="delivered",t.latency=d.executionTime||s.queryLatency||10,t.payload={...t.payload,results:d.rows||[],rowCount:d.rowCount||0,queryPlan:d.queryPlan,indexesUsed:d.indexesUsed||[]}):(t.status="failed",t.error=d.error||"Query execution failed",t.latency=d.executionTime||0),t}processRedisCommand(e,t,s){const n=t.payload,i=ve.getRedisRoutingEngine(e.id);if(!i)return t.status="failed",t.error="Redis Routing Engine not initialized",t;let a,o;if(n?.command)a=n.command,o=n.args||[];else if(n?.redisCommand){const d=String(n.redisCommand).trim().split(/\s+/);a=d[0],o=d.slice(1)}else if(typeof n=="string"){const d=n.trim().split(/\s+/);a=d[0],o=d.slice(1)}else{const d=n?.operation||"get";switch(d.toLowerCase()){case"get":a="GET",o=[n?.key||"default:key"];break;case"set":a="SET",o=[n?.key||"default:key",typeof n?.value=="string"?n.value:JSON.stringify(n?.value||"")],n?.ttl&&o.push("EX",String(n.ttl));break;case"delete":case"del":a="DEL",o=Array.isArray(n?.keys)?n.keys:[n?.key||"default:key"];break;case"exists":a="EXISTS",o=Array.isArray(n?.keys)?n.keys:[n?.key||"default:key"];break;default:return t.status="failed",t.error=`Unknown Redis operation: ${d}`,t}}const l=i.executeCommand(a,o);return l.success?(t.status="delivered",t.latency=l.latency||1,t.payload={...t.payload,command:a,args:o,result:l.value,redisResult:l.value}):(t.status="failed",t.error=l.error||"Redis command execution failed",t.latency=l.latency||0),t}processCQLQuery(e,t,s){const n=t.payload,i=ve.getCassandraRoutingEngine(e.id);if(!i)return t.status="failed",t.error="Cassandra Routing Engine not initialized",t;let a,o;if(n?.cql)a=n.cql,o=n.consistency;else if(n?.query)a=n.query,o=n.consistency;else if(typeof n=="string")a=n;else{const d=n?.operation||"select",h=e.data.config,p=n?.keyspace||h?.keyspace||"system",g=n?.table||"default_table";switch(d.toLowerCase()){case"select":case"read":a=`SELECT * FROM ${p}.${g}`,n?.limit&&(a+=` LIMIT ${n.limit}`);break;case"insert":case"write":const v=n?.columns?Object.keys(n.columns).join(", "):"id, data",b=n?.columns?Object.values(n.columns).map(S=>`'${S}'`).join(", "):`${Date.now()}, 'data'`;a=`INSERT INTO ${p}.${g} (${v}) VALUES (${b})`;break;case"update":const M=n?.columns||{},x=Object.entries(M).map(([S,T])=>`${S} = '${T}'`).join(", ");a=`UPDATE ${p}.${g} SET ${x}`,n?.where&&(a+=` WHERE ${n.where}`);break;case"delete":a=`DELETE FROM ${p}.${g}`,n?.where&&(a+=` WHERE ${n.where}`);break;default:return t.status="failed",t.error=`Unknown CQL operation: ${d}`,t}}o||(o=e.data.config?.consistencyLevel||"QUORUM");const l=i.executeCQL(a,o);return l.success?(t.status="delivered",t.latency=l.latency||5,t.payload={...t.payload,cql:a,consistency:l.consistency,rows:l.rows||[],rowCount:l.rowCount||0,replicasQueried:l.replicasQueried,cqlResult:l.rows},t.metadata={...t.metadata,cassandraConsistency:l.consistency,cassandraReplicasQueried:l.replicasQueried}):(t.status="failed",t.error=l.error||"CQL query execution failed",t.latency=l.latency||0),t}extractIndexesFromConfig(e,t){const s=[];for(const n of t)for(const i of n.indexes||[]){const a=i.match(/CREATE\s+(?:UNIQUE\s+)?INDEX\s+(\w+)\s+ON\s+\w+\s*\(([^)]+)\)/i);a?s.push({name:a[1],table:n.name,schema:n.schema,columns:a[2].split(",").map(o=>o.trim()),unique:i.toUpperCase().includes("UNIQUE")}):s.push({name:i,table:n.name,schema:n.schema,columns:[i.replace(/^idx_|^index_/i,"")]})}return s}createMessageBrokerHandler(e){return e==="rabbitmq"?{processData:(t,s,n)=>{const i=ve.getRabbitMQRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=n?.messaging||s.metadata?.messaging||{},o=a.exchange||"amq.topic",l=a.routingKey||s.metadata?.routingKey||"default",d=s.metadata?.headers,h=s.metadata?.priority,p=i.routeMessage(o,l,s.payload,s.size,d,h);return p.length>0?(s.status="delivered",s.metadata={...s.metadata,routedQueues:p,exchange:o,routingKey:l}):(s.status="failed",s.error=`No queues bound to exchange '${o}' with routing key '${l}'`),s},getSupportedFormats:()=>["json","binary","text"]}:e==="activemq"?{processData:(t,s,n)=>{const i=ve.getActiveMQRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=n?.messaging||s.metadata?.messaging||{},o=a.queue,l=a.topic,d=s.metadata?.headers,h=s.metadata?.priority,p=s.metadata?.ttl;let g=!1,v="";const b=t.data.config||{},M=b.acls||[],S=this.nodes.find(E=>E.id===s.source)?.data.config,T=s.metadata?.principal||S?.username||S?.clientId||b.username||`user-${s.source.slice(0,8)}`;if(o){if(!(ve.checkActiveMQACLPermissionPublic?.(M,T,`queue://${o}`,"write")??!0))return s.status="failed",s.error=`Access denied: principal '${T}' does not have write permission for queue '${o}'`,s;i.routeToQueue(o,s.payload,s.size,d,h,p)&&(g=!0,v=o)}if(l){if(!(ve.checkActiveMQACLPermissionPublic?.(M,T,`topic://${l}`,"write")??!0))return s.status="failed",s.error=`Access denied: principal '${T}' does not have write permission for topic '${l}'`,s;i.publishToTopic(l,s.payload,s.size,d,h,p).length>0&&(g=!0,v=l)}return g?(s.status="delivered",s.metadata={...s.metadata,destination:v,queue:o||void 0,topic:l||void 0}):(s.status="failed",s.error=`No queue or topic found. Queue: '${o||"none"}', Topic: '${l||"none"}'`),s},getSupportedFormats:()=>["json","binary","text"]}:e==="aws-sqs"?{generateData:(t,s)=>{const n=ve.getSQSRoutingEngine(t.id);if(!n)return null;const i=t.data.config||{},a=i.queues||[],o=i.iamPolicies||[],l=this.connections.filter(b=>b.source===t.id);if(l.length===0)return null;const d=[],h=Date.now(),p=`_lastSQSConsume_${t.id}`,g=t[p]||0;if(h-g<500)return null;t[p]=h;for(const b of l){const M=b.data||{},x=M.messaging||s.messaging||{};let S=x.queueName||M.queueName;const T=x.queueUrl||M.queueUrl;if(!S&&T){const Q=T.split("/");S=Q[Q.length-1]}if(!S&&a.length>0&&(S=a[0].name),!S)continue;const E=this.nodes.find(Q=>Q.id===b.target);if(E){const Q=E.data.config||{},se=Q.messaging?.accessKeyId||Q.accessKeyId||i.accessKeyId||`arn:aws:iam::123456789012:user/${E.id.slice(0,8)}`;if(!(ve.checkSQSIAMPolicy?.(o,se,S,"sqs:ReceiveMessage")??!0))continue}const A=x.maxNumberOfMessages||x.batchSize||10,k=x.waitTimeSeconds!==void 0?x.waitTimeSeconds:0,D=x.visibilityTimeout,L=x.messageAttributeNames,I=x.attributeNames,U=n.receiveMessage(S,A,D,k,L,I);if(U.length!==0)for(const Q of U){const se={id:`sqs-msg-${++this.messageIdCounter}`,timestamp:Q.timestamp,source:t.id,target:b.target,connectionId:b.id,format:"json",payload:Q.payload,size:Q.size,metadata:{queueName:S,receiptHandle:Q.receiptHandle,messageId:Q.messageId,attributes:Q.attributes,systemAttributes:Q.systemAttributes,messageGroupId:Q.messageGroupId,messageDeduplicationId:Q.messageDeduplicationId,receiveCount:Q.receiveCount,approximateFirstReceiveTimestamp:Q.approximateFirstReceiveTimestamp,approximateReceiveCount:Q.approximateReceiveCount,sentTimestamp:Q.sentTimestamp},status:"pending"};d.push(se)}}return d.length>0?d:null},processData:(t,s,n)=>{const i=ve.getSQSRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=n?.messaging||s.metadata?.messaging||{},o=a.queueUrl,l=a.queueName||(o?o.split("/").pop():null)||s.metadata?.queueName||"default-queue",d=t.data.config||{},h=d.iamPolicies||[],g=this.nodes.find(A=>A.id===s.source)?.data.config,v=s.metadata?.principal||g?.accessKeyId||g?.clientId||d.accessKeyId||`arn:aws:iam::123456789012:user/${s.source.slice(0,8)}`;if(!(ve.checkSQSIAMPolicy?.(h,v,l,"sqs:SendMessage")??!0))return s.status="failed",s.error=`Access denied: principal '${v}' does not have sqs:SendMessage permission for queue '${l}'`,s;const M=s.metadata?.messageGroupId,x=s.metadata?.messageDeduplicationId,S=s.metadata?.attributes,T=s.metadata?.systemAttributes,E=i.sendMessage(l,s.payload,s.size,S,M,x,T);return E?(s.status="delivered",s.metadata={...s.metadata,queueName:l,messageId:E,queueUrl:o||`https://sqs.${d.defaultRegion||"us-east-1"}.amazonaws.com/.../${l}`}):(s.status="failed",s.error=`Queue '${l}' not found`),s},getSupportedFormats:()=>["json","binary","text"]}:e==="azure-service-bus"?{processData:(t,s,n)=>{const i=ve.getAzureServiceBusRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=n?.messaging||s.metadata?.messaging||{},o=a.queue,l=a.topic,d=s.metadata?.properties||s.metadata?.headers,h=s.metadata?.sessionId,p=s.metadata?.scheduledEnqueueTime,g=s.metadata?.messageId;let v=!1,b="",M=[];if(o){const x=i.sendToQueue(o,s.payload,s.size,d,h,p,g);x&&(v=!0,b=o,M.push(x))}if(l){const x=i.publishToTopic(l,s.payload,s.size,d,p,g);x.length>0&&(v=!0,b=l,M=x)}return v?(s.status="delivered",s.metadata={...s.metadata,destination:b,queue:o||void 0,topic:l||void 0,messageIds:M,sessionId:h||void 0}):(s.status="failed",s.error=`No queue or topic found. Queue: '${o||"none"}', Topic: '${l||"none"}'`),s},generateData:(t,s)=>{if(!ve.getAzureServiceBusRoutingEngine(t.id))return null;const i=t.data.config||{};i.queues,i.topics;const a=this.connections.filter(p=>p.source===t.id);if(a.length===0)return null;const o=[],l=Date.now(),d=`_azureServiceBusConsumedMessages_${t.id}`,h=t[d]||[];for(const p of h){const{message:g,queueName:v,topicName:b,subscriptionName:M}=p;for(const x of a){const S={id:`asb-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:l,source:t.id,target:x.target,connectionId:x.id,format:typeof g.payload=="string"?"text":"json",payload:g.payload,size:g.size,metadata:{messaging:{queue:v,topic:b,subscription:M},properties:g.properties,messageId:g.messageId,sessionId:g.sessionId,sequenceNumber:g.sequenceNumber},status:"pending"};o.push(S)}}return t[d]=[],o.length>0?o:null},getSupportedFormats:()=>["json","binary","text"]}:e==="gcp-pubsub"?{generateData:(t,s)=>{const n=ve.getPubSubRoutingEngine(t.id);if(!n)return null;const a=(t.data.config||{}).subscriptions||[],o=this.connections.filter(v=>v.source===t.id);if(o.length===0)return null;const l=[],d=Date.now(),h=`_lastPubSubConsume_${t.id}`,p=t[h]||0;if(d-p<500)return null;t[h]=d;for(const v of o){const b=v.data||{},M=b.messaging||s.messaging||{};let S=M.subscription||b.subscription;if(!S&&a.length>0&&(S=a[0].name),!S)continue;const T=a.find(E=>E.name===S);if(T)if(T.pushEndpoint){const E=n.pullFromSubscription(S,10);for(const A of E){const k=n.getFormattedPushPayload(S,A),D=k!==null?k:A.data;l.push({id:`pubsub-push-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:A.publishTime,source:t.id,target:v.target,connectionId:v.id,format:"json",payload:D,size:A.size,metadata:{topic:T.topic,subscription:S,messageId:A.messageId,ackId:A.ackId,orderingKey:A.orderingKey,attributes:A.attributes,pushEndpoint:T.pushEndpoint,deliveryMethod:"push",payloadFormat:T.payloadFormat||"WRAPPED"},status:"delivered"})}}else{const E=M.maxMessages||b.maxMessages||100;try{const A=n.pullFromSubscription(S,E);for(const k of A)l.push({id:`pubsub-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:k.publishTime,source:t.id,target:v.target,connectionId:v.id,format:"json",payload:k.data,size:k.size,metadata:{topic:T.topic,subscription:S,messageId:k.messageId,ackId:k.ackId,orderingKey:k.orderingKey,attributes:k.attributes},status:"pending"})}catch(A){console.error(`Error pulling from subscription ${S}:`,A)}}}return l.length>0?l:null},processData:(t,s,n)=>{const i=ve.getPubSubRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=n?.messaging||s.metadata?.messaging||{},o=a.topic||s.metadata?.topic,l=a.orderingKey||s.metadata?.orderingKey,d=s.metadata?.attributes||s.metadata?.headers,h=t.data.config||{},p=o||h.topics&&h.topics[0]?.name||null;if(!p)return s.status="failed",s.error="No topic specified for Pub/Sub message",s;const g=i.publishToTopic(p,s.payload,s.size,d,l);return g?(s.status="delivered",s.metadata={...s.metadata,topic:p,messageId:g,orderingKey:l||void 0}):(s.status="failed",s.error=`Topic '${p}' not found`),s},getSupportedFormats:()=>["json","binary","text"]}:e==="kafka"?{generateData:(t,s)=>{const n=ve.getKafkaRoutingEngine(t.id);if(!n)return null;const i=t.data.config||{},a=i.consumerGroups||[],o=i.acls||[],l=this.connections.filter(M=>M.source===t.id);if(l.length===0)return null;const d=[],h=Date.now(),p=`_lastKafkaConsume_${t.id}`,g=t[p]||0;if(h-g<500)return null;t[p]=h;const b=new Map;for(const M of l){const x=M.data||{},S=x.messaging||s.messaging||{};let T=S.consumerGroup||x.consumerGroup,E=S.topic||x.topic;if((!T||!E)&&this.nodes.find(D=>D.id===M.target)&&a.length>0){const D=a.find(L=>L.id&&L.topic)||a[0];D&&(T=T||D.id,E=E||D.topic)}if((!T||!E)&&(this.nodes.find(k=>k.id===M.target),T=T||`auto-group-${M.id.slice(0,8)}`,E=E||i.topics&&i.topics[0]?.name,!E))continue;const A=`${T}:${E}`;b.has(A)||b.set(A,{topic:E,connections:[]}),b.get(A).connections.push(M)}for(const[M,x]of b.entries()){const[S,T]=M.split(":"),E=x.connections.length;n.createOrUpdateConsumerGroup(S,T,E,"latest",!0)}for(const M of l){const x=M.data||{},S=x.messaging||s.messaging||{};let T=S.consumerGroup||x.consumerGroup,E=S.topic||x.topic;if((!T||!E)&&this.nodes.find(I=>I.id===M.target)&&a.length>0){const I=a.find(U=>U.id&&U.topic)||a[0];I&&(T=T||I.id,E=E||I.topic)}if((!T||!E)&&(T=T||`auto-group-${M.id.slice(0,8)}`,E=E||i.topics&&i.topics[0]?.name,!E))continue;const A=this.nodes.find(L=>L.id===M.target);if(A){const L=A.data.config||{},I=L.messaging?.consumerId||L.clientId||`User:${A.id.slice(0,8)}`;if(!n.checkACLPermission(o,I,"Topic",E,"Read"))continue}const k=S.batchSize||S.maxPollRecords||S.fetchSize||500,D=n.consumeFromTopic(T,E,k);if(D.length!==0)for(const L of D){const I={id:`kafka-msg-${++this.messageIdCounter}`,timestamp:L.timestamp,source:t.id,target:M.target,connectionId:M.id,format:"json",payload:L.value,size:L.size,metadata:{topic:L.topic,partition:L.partition,offset:L.offset,key:L.key,consumerGroup:T,headers:L.headers},status:"pending"};d.push(I)}}return d.length>0?d:null},processData:(t,s,n)=>{const i=ve.getKafkaRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=n?.messaging||s.metadata?.messaging||{},o=a.topic||s.metadata?.topic,l=a.key||s.metadata?.key||s.metadata?.partitionKey,d=s.metadata?.headers||s.metadata?.attributes,h=t.data.config||{},p=o||h.topics&&h.topics[0]?.name||null;if(!p)return s.status="failed",s.error="No topic specified for Kafka message",s;const g=h.acls||[],v=this.nodes.find(M=>M.id===s.source);if(v){const M=v.data.config||{},x=M.messaging?.producerId||M.clientId||`User:${v.id.slice(0,8)}`;if(!i.checkACLPermission(g,x,"Topic",p,"Write"))return s.status="failed",s.error=`ACL denied: No Write permission for topic '${p}'`,s}const b=i.publishToTopic(p,s.payload,s.size,l,d);return b!==null?(s.status="delivered",s.metadata={...s.metadata,topic:p,offset:b,partitionKey:l||void 0}):(s.status="failed",s.error=`Topic '${p}' not found`),s},getSupportedFormats:()=>["json","binary","text"]}:{processData:(t,s,n)=>(s.status="delivered",s),getSupportedFormats:()=>["json","binary","text"]}}createAPIHandler(e){return e==="rest"?{processData:(t,s,n)=>{const i=ve.getRestApiRoutingEngine(t.id);if(!i){const b={status:"success",data:s.payload,timestamp:Date.now()};return s.payload=b,s.status="delivered",s}const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=a?.body||a||s.payload,g=a?.clientIP||s.metadata?.clientIP,v=i.routeRequest({path:o,method:l,headers:d,query:h,body:p,clientIP:g});return v.status>=200&&v.status<300?(s.status="delivered",s.latency=v.latency,s.payload=v.data,s.metadata={...s.metadata,restApiEndpoint:v.endpoint,restApiStatus:v.status,restApiHeaders:v.headers}):(s.status="failed",s.error=v.error||`HTTP ${v.status}`,s.latency=v.latency,s.metadata={...s.metadata,restApiEndpoint:v.endpoint,restApiStatus:v.status}),s},transformData:(t,s,n,i)=>(s.format!=="json"&&(s.format="json",s.status="transformed"),s),getSupportedFormats:()=>["json","xml"]}:e==="grpc"?{processData:(t,s,n)=>{const i=ve.getGRPCRoutingEngine(t.id);if(!i){const b={status:"OK",data:s.payload,timestamp:Date.now()};return s.payload=b,s.status="delivered",s}const a=s.payload,o=a?.service||s.metadata?.service||"",l=a?.method||s.metadata?.method||"",d=a?.payload||a?.body||a||s.payload,h=a?.metadata||s.metadata||{},p=a?.timeout||s.metadata?.timeout,g=a?.clientIP||s.metadata?.clientIP,v=i.routeRequest({service:o,method:l,payload:d,metadata:h,timeout:p,clientIP:g});return v.status==="OK"?(s.status="delivered",s.latency=v.latency,s.payload=v.data,s.metadata={...s.metadata,grpcService:v.service,grpcMethod:v.method,grpcStatus:v.status,grpcMetadata:v.metadata}):(s.status="failed",s.error=v.error||`gRPC ${v.status}`,s.latency=v.latency,s.metadata={...s.metadata,grpcService:v.service,grpcMethod:v.method,grpcStatus:v.status}),s},transformData:(t,s,n,i)=>(s.format!=="protobuf"&&s.format!=="binary"&&(s.format="protobuf",s.status="transformed"),s),getSupportedFormats:()=>["protobuf","binary"]}:e==="graphql"?{processData:(t,s,n)=>{const i=ve.getGraphQLEmulationEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload;if(Array.isArray(a)){const v=i.processBatchQueries(a,this.nodes,this.connections);let b=null;v.then(x=>{b=x}).catch(()=>{});const M=b||[];return s.payload=M,s.status=M.every(x=>x.success)?"delivered":"error",(!s.status||s.status==="error")&&(s.error="Some batch queries failed"),s}const o=a?.query||a?.body?.query||s.metadata?.query,l=a?.variables||a?.body?.variables||s.metadata?.variables,d=a?.operationName||a?.body?.operationName||s.metadata?.operationName,h=a?.extensions||a?.body?.extensions||s.metadata?.extensions,p=o&&o.trim().toLowerCase().startsWith("mutation");let g;if(p)g=i.processMutation({query:o,variables:l,operationName:d});else{const v=()=>ve.getAllJaegerEngines(),b=i.processQuery({query:o,variables:l,operationName:d,extensions:h},this.nodes,this.connections,v);if(b&&typeof b.then=="function"){let M=null;b.then(S=>{M=S}).catch(()=>{});const x=Date.now();g=M||{success:!1,errors:[{message:"Query execution timeout"}],latency:Date.now()-x}}else g=b}return g.success?(s.payload={data:g.data,extensions:g.complexity!==void 0?{complexity:g.complexity,depth:g.depth}:void 0},s.metadata={...s.metadata,latency:g.latency,complexity:g.complexity,depth:g.depth,cached:g.cached},s.status="delivered"):(s.payload={errors:g.errors},s.status="error",s.error=g.errors?.[0]?.message||"GraphQL query failed"),s},transformData:(t,s,n,i)=>(s.format!=="json"&&(s.format="json",s.status="transformed"),s),getSupportedFormats:()=>["json"]}:e==="soap"?{processData:(t,s,n)=>{const i=ve.getSOAPEmulationEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.envelope||a?.body||(typeof a=="string"?a:""),l=a?.operation||s.metadata?.operation,d=a?.service||s.metadata?.service,h=a?.headers||s.metadata?.headers||{},p=a?.clientIP||s.metadata?.clientIP;if(!o)return s.status="error",s.error="SOAP envelope is required",s;const g=()=>{const b=new Map;for(const M of this.nodes)if(M.type==="jaeger"){const x=ve.getJaegerEmulationEngine(M.id);x&&b.set(M.id,x)}return b},v=i.processRequest({envelope:o,operation:l,service:d,headers:h,clientIP:p},this.nodes,this.connections,g);return v.success?(s.payload={envelope:v.envelope,status:v.status},s.metadata={...s.metadata,latency:v.latency,soapVersion:n?.soapVersion||"1.1"},s.status="delivered",s.latency=v.latency):(s.payload={envelope:v.envelope,fault:v.fault,error:v.error},s.status="error",s.error=v.error||v.fault?.string||"SOAP request failed",s.latency=v.latency),s},transformData:(t,s,n,i)=>(s.format!=="xml"&&(s.format="xml",s.status="transformed"),s),getSupportedFormats:()=>["xml","json"]}:e==="websocket"?{processData:(t,s,n)=>{const i=ve.getWebSocketEmulationEngine(t.id);if(i){const o=s.metadata?.connectionId||`conn-${Date.now()}`,l=i.processIncomingMessage(o,s.payload,s.metadata);if(!l.processed){const h={status:"error",type:"websocket",connectionId:o,data:s.payload,timestamp:Date.now(),processed:!1,error:l.error||"Failed to process message"};return s.payload=h,s.status="error",s}const d={status:"success",type:"websocket",connectionId:o,data:s.payload,timestamp:Date.now(),processed:l.processed,broadcastToRoom:l.broadcastToRoom,deliveredToSubscriptions:l.deliveredToSubscriptions,forwarded:l.forwarded};return s.payload=d,s.status="delivered",s}const a={status:"success",data:s.payload,timestamp:Date.now()};return s.payload=a,s.status="delivered",s},transformData:(t,s,n,i)=>(n==="rest"&&s.format==="binary"?(s.format="json",s.payload={data:"Binary data converted to JSON"}):n==="grpc"&&s.format==="text"&&(s.format="json",s.payload={message:s.payload}),s),getSupportedFormats:()=>["json","text","binary"]}:{processData:(t,s,n)=>{const i={status:"success",data:s.payload,timestamp:Date.now()};return s.payload=i,s.status="delivered",s},transformData:(t,s,n,i)=>s,getSupportedFormats:()=>["json"]}}createWebhookHandler(){return{processData:(e,t,s)=>{const n=ve.getWebhookEmulationEngine(e.id);if(!n)return t.status="delivered",t;const i=t.payload,a=i?.url||t.metadata?.url||i?.path||"/",o=i?.method||t.metadata?.method||"POST",l=i?.headers||t.metadata?.headers||{},d=i?.body||i||t.payload,h=i?.ip||t.metadata?.ip||l["x-forwarded-for"]?.split(",")[0]?.trim(),p=i?.event||t.metadata?.event||l["x-event"]||l["x-github-event"]||"",g=n.processWebhookRequest({url:a,method:o,headers:l,body:d,event:p,ip:h});return g.success?(t.status="delivered",t.latency=g.latency,t.metadata={...t.metadata,webhookDeliveryId:g.deliveryId,webhookAttempts:g.attempts,webhookStatus:g.status}):(t.status="failed",t.error=g.error||`Webhook processing failed (HTTP ${g.status})`,t.latency=g.latency,t.metadata={...t.metadata,webhookDeliveryId:g.deliveryId,webhookAttempts:g.attempts,webhookStatus:g.status}),t},transformData:(e,t,s,n)=>(t.format!=="json"&&(t.format="json",t.status="transformed"),t),getSupportedFormats:()=>["json"]}}createIntegrationHandler(e){return e==="kong"?{processData:(t,s,n)=>{const i=ve.getKongRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d.apikey||d["X-API-Key"]||h.apikey,g=s.metadata?.consumerId,v=i.routeRequest({path:o,method:l,headers:d,query:h,body:a?.body,consumerId:g,apiKey:p});return v.response.status>=200&&v.response.status<300?(s.status="delivered",s.latency=v.response.latency,s.metadata={...s.metadata,kongRoute:v.match?.route.id,kongService:v.match?.service.id,kongTarget:v.target,kongResponseStatus:v.response.status}):(s.status="failed",s.error=v.response.error||`HTTP ${v.response.status}`,s.latency=v.response.latency),s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary"]}:e==="api-gateway"?{processData:(t,s,n)=>{const i=ve.getCloudAPIGatewayEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d["x-api-key"]||d["X-API-Key"]||d["ocp-apim-subscription-key"]||h.key||h["subscription-key"]||h.apikey,g={path:o,method:l.toUpperCase(),headers:d,query:h,body:a?.body,apiKey:p},v=i.processRequest(g);if(v.status>=200&&v.status<300){if(s.status="delivered",s.latency=(s.latency||0)+v.latency,s.metadata={...s.metadata,gatewayProvider:v.metadata?.gatewayProvider,gatewayApiId:v.metadata?.apiId,gatewayKeyId:v.metadata?.keyId,gatewayCacheHit:v.metadata?.cacheHit||!1,gatewayRateLimitRemaining:v.metadata?.rateLimitRemaining,gatewayResponseStatus:v.status},v.metadata?.cacheHit)return s.status="delivered",s.payload=v.body||s.payload,s}else return s.status="failed",s.error=v.error||`HTTP ${v.status}`,s.latency=(s.latency||0)+v.latency,s.metadata={...s.metadata,gatewayProvider:v.metadata?.gatewayProvider,gatewayApiId:v.metadata?.apiId,gatewayError:v.error,gatewayResponseStatus:v.status},s;return s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary"]}:e==="nginx"?{processData:(t,s,n)=>{const i=ve.getNginxRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d["X-Real-IP"]||d["X-Forwarded-For"]||s.metadata?.clientIP,g=d["X-Forwarded-Proto"]==="https"||s.metadata?.protocol==="https"?"https":"http",v=i.routeRequest({path:o,method:l,headers:d,query:h,body:a?.body,clientIP:p,protocol:g});return v.response.status>=200&&v.response.status<300?(s.status="delivered",s.latency=v.response.latency,s.metadata={...s.metadata,nginxLocation:v.match?.location.path,nginxUpstream:v.upstreamTarget,nginxResponseStatus:v.response.status,nginxCacheHit:v.response.cacheHit},v.response.body&&(s.payload=v.response.body)):(s.status="failed",s.error=v.response.error||`HTTP ${v.response.status}`,s.latency=v.response.latency),s},transformData:(t,s,n,i)=>{(t.data.config||{}).enableGzip&&s.metadata?.nginxCacheHit&&(s.metadata={...s.metadata,contentEncoding:"gzip"});const o=this.getTargetFormats(n);return o.length>0&&!o.includes(s.format)&&(s.format=o[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text"]}:e==="envoy"?{processData:(t,s,n)=>{const i=ve.getEnvoyRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d["X-Real-IP"]||d["X-Forwarded-For"]||s.metadata?.clientIP,g=d["X-Forwarded-Proto"]==="https"||s.metadata?.protocol==="https"?"https":"http",v=d.Host||s.metadata?.host,b=i.routeRequest({path:o,method:l,headers:d,query:h,body:a?.body,clientIP:p,protocol:g,host:v});return b.response.status>=200&&b.response.status<300?(s.status="delivered",s.latency=(s.latency||0)+(b.response.latency||0),s.metadata={...s.metadata,envoyListener:b.listener?.name,envoyRoute:b.route?.name,envoyCluster:b.cluster?.name,envoyEndpoint:b.endpointTarget,envoyResponseStatus:b.response.status},b.response.body&&(s.payload=b.response.body)):(s.status="failed",s.error=b.response.error||`HTTP ${b.response.status}`,s.latency=(s.latency||0)+(b.response.latency||0)),s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text","grpc"]}:e==="haproxy"?{processData:(t,s,n)=>{const i=ve.getHAProxyRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d["X-Real-IP"]||d["X-Forwarded-For"]||s.metadata?.clientIP,g=d["X-Forwarded-Proto"]==="https"||s.metadata?.protocol==="https"?"https":"http",v=d.Host||s.metadata?.host,b=i.routeRequest({path:o,method:l,headers:d,query:h,body:a?.body,clientIP:p,protocol:g,host:v});return b.response.status>=200&&b.response.status<300?(s.status="delivered",s.latency=b.response.latency,s.metadata={...s.metadata,haproxyFrontend:b.frontend?.name,haproxyBackend:b.backendTarget,haproxyServer:b.serverTarget,haproxyResponseStatus:b.response.status},b.response.body&&(s.payload=b.response.body)):(s.status="failed",s.error=b.response.error||`HTTP ${b.response.status}`,s.latency=b.response.latency),s},transformData:(t,s,n,i)=>{t.data.config;const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text"]}:e==="traefik"?{processData:(t,s,n)=>{const i=ve.getTraefikEmulationEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d["X-Real-IP"]||d["X-Forwarded-For"]||s.metadata?.clientIP,g=d["X-Forwarded-Proto"]==="https"||s.metadata?.protocol==="https"?"https":"http",v=d.Host||s.metadata?.host,b=s.metadata?.entryPoint||(g==="https"?"websecure":"web"),M=i.processRequest({path:o,method:l,headers:d,query:h,body:a?.body,clientIP:p,protocol:g,host:v,entryPoint:b});return M.success?(s.status="delivered",s.latency=M.latency,s.metadata={...s.metadata,traefikRouter:M.routerMatched,traefikService:M.serviceTarget,traefikServer:M.serverTarget,traefikResponseStatus:M.status},a?.body&&(s.payload=a.body)):(s.status="failed",s.error=M.error||`HTTP ${M.status}`,s.latency=M.latency),s},transformData:(t,s,n,i)=>{t.data.config;const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text"]}:e==="cdn"?{processData:(t,s,n)=>{const i=ve.getCDNEmulationEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d["X-Real-IP"]||d["X-Forwarded-For"]||s.metadata?.clientIP,g=d["User-Agent"]||s.metadata?.userAgent,b=(t.data.config||{}).distributions||[],M=d.Host||s.metadata?.host||(b.length>0?b[0].domain:"cdn.example.com"),x=i.processRequest({method:l.toUpperCase(),path:o,domain:M,headers:d,query:h,body:a?.body,clientIP:p,userAgent:g});return x.success?(s.status="delivered",s.latency=(s.latency||0)+x.latency,s.metadata={...s.metadata,cdnCacheHit:x.cacheHit,cdnLatency:x.latency,cdnSize:x.size},x.cacheHit&&(s.payload={status:"ok",cached:!0})):(s.status="failed",s.error=x.error||"CDN request failed",s.latency=(s.latency||0)+x.latency),s},transformData:(t,s,n,i)=>{const a=t.data.config||{};a.enableCompression&&s.metadata?.cdnCacheHit&&(s.metadata={...s.metadata,contentEncoding:a.compressionType||"gzip"});const o=this.getTargetFormats(n);return o.length>0&&!o.includes(s.format)&&(s.format=o[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text","html"]}:e==="service-mesh"?{processData:(t,s,n)=>{const i=ve.getServiceMeshRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d["X-Real-IP"]||d["X-Forwarded-For"]||s.metadata?.clientIP,g=d["X-Forwarded-Proto"]==="https"||s.metadata?.protocol==="https"?"https":"http",v=d.Host||s.metadata?.host,b=d.Host||s.metadata?.authority,M=d["X-Source-Principal"]||s.metadata?.sourcePrincipal,x=d["X-Destination-Principal"]||s.metadata?.destinationPrincipal,S=i.routeRequest({path:o,method:l,headers:d,query:h,body:a?.body,clientIP:p,protocol:g==="https"?"https":g==="grpc"?"grpc":"http",host:v,authority:b,sourcePrincipal:M,destinationPrincipal:x});return S.response.status>=200&&S.response.status<300?(s.status="delivered",s.latency=S.response.latency,s.metadata={...s.metadata,serviceMeshVirtualService:S.virtualService?.name,serviceMeshDestinationRule:S.destinationRule?.name,serviceMeshService:S.serviceTarget,serviceMeshSubset:S.subsetTarget,serviceMeshEndpoint:S.endpointTarget,serviceMeshResponseStatus:S.response.status,serviceMeshRetryAttempts:S.response.retryAttempts,serviceMeshCircuitBreakerOpen:S.response.circuitBreakerOpen},S.response.body&&(s.payload=S.response.body)):(s.status="failed",s.error=S.response.error||`HTTP ${S.response.status}`,s.latency=S.response.latency,s.metadata={...s.metadata,serviceMeshVirtualService:S.virtualService?.name,serviceMeshDestinationRule:S.destinationRule?.name,serviceMeshService:S.serviceTarget,serviceMeshSubset:S.subsetTarget,serviceMeshEndpoint:S.endpointTarget,serviceMeshResponseStatus:S.response.status,serviceMeshError:S.response.error,serviceMeshRetryAttempts:S.response.retryAttempts,serviceMeshCircuitBreakerOpen:S.response.circuitBreakerOpen}),s},transformData:(t,s,n,i)=>{t.data.config;const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text"]}:e==="istio"?{processData:(t,s,n)=>{const i=ve.getIstioRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d["X-Real-IP"]||d["X-Forwarded-For"]||s.metadata?.clientIP,g=d["X-Forwarded-Proto"]==="https"||s.metadata?.protocol==="https"?"https":"http",v=d.Host||s.metadata?.host,b=d.Host||s.metadata?.authority,M=d["X-Source-Principal"]||s.metadata?.sourcePrincipal,x=d["X-Destination-Principal"]||s.metadata?.destinationPrincipal,S=i.routeRequest({path:o,method:l,headers:d,query:h,body:a?.body,clientIP:p,protocol:g==="https"?"https":g==="grpc"?"grpc":"http",host:v,authority:b,sourcePrincipal:M,destinationPrincipal:x});return S.response.status>=200&&S.response.status<300?(s.status="delivered",s.latency=S.response.latency,s.metadata={...s.metadata,istioVirtualService:S.virtualService?.name,istioDestinationRule:S.destinationRule?.name,istioService:S.serviceTarget,istioSubset:S.subsetTarget,istioEndpoint:S.endpointTarget,istioResponseStatus:S.response.status,istioRetryAttempts:S.response.retryAttempts,istioCircuitBreakerOpen:S.response.circuitBreakerOpen},S.response.body&&(s.payload=S.response.body)):(s.status="failed",s.error=S.response.error||`HTTP ${S.response.status}`,s.latency=S.response.latency,s.metadata={...s.metadata,istioVirtualService:S.virtualService?.name,istioDestinationRule:S.destinationRule?.name,istioService:S.serviceTarget,istioSubset:S.subsetTarget,istioEndpoint:S.endpointTarget,istioResponseStatus:S.response.status,istioError:S.response.error,istioRetryAttempts:S.response.retryAttempts,istioCircuitBreakerOpen:S.response.circuitBreakerOpen}),s},transformData:(t,s,n,i)=>{t.data.config;const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text","grpc"]}:e==="apigee"?{processData:(t,s,n)=>{const i=ve.getApigeeRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=d.apikey||d["X-API-Key"]||h.apikey,g=d.Authorization||"",v=g.startsWith("OAuth ")?g.replace("OAuth ",""):void 0,b=g.startsWith("Bearer ")?g.replace("Bearer ",""):d["X-JWT-Token"],M=i.routeRequest({path:o,method:l,headers:d,query:h,body:a?.body,apiKey:p,oauthToken:v,jwtToken:b});return M.response.status>=200&&M.response.status<300?(s.status="delivered",s.latency=M.response.latency,s.metadata={...s.metadata,apigeeProxy:M.match?.proxy.name,apigeeTarget:M.target,apigeeResponseStatus:M.response.status,apigeeEnvironment:M.match?.proxy.environment}):(s.status="failed",s.error=M.response.error||`HTTP ${M.response.status}`,s.latency=M.response.latency),s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary"]}:e==="graphql-gateway"?{processData:(t,s,n)=>{const i=ve.getGraphQLGatewayRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.query||a?.body||s.metadata?.query,l=a?.variables||s.metadata?.variables,d=a?.operationName||s.metadata?.operationName,h=a?.headers||s.metadata?.headers||{},p=i.routeRequest({query:o||"",variables:l,headers:h,operationName:d});s.latency=p.latency;try{const g=i.getCacheManager().getMetrics();ve.recordGraphQLGatewayRequest(t.id,p,g)}catch{}if(p.status>=200&&p.status<300){s.status="delivered";const b=i.getServiceRegistry().getConnectedServices().map(M=>M.endpoint);s.metadata={...s.metadata,graphqlGatewayStatus:p.status,graphqlGatewayEndpoints:b}}else s.status="failed",s.error=p.error||`HTTP ${p.status}`;return s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json"]}:e==="mulesoft"?{processData:(t,s,n)=>{const i=ve.getMuleSoftRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=this.nodes.find(h=>h.id===s.source),l=this.nodes.find(h=>h.id===s.target),d=i.processData({path:a?.path||s.metadata?.path,method:a?.method||s.metadata?.method||"POST",headers:a?.headers||s.metadata?.headers||{},query:a?.query||s.metadata?.query||{},body:a?.body||a||s.payload,format:s.format,sourceComponentType:o?.type,sourceComponentId:o?.id,targetComponentType:l?.type,targetComponentId:l?.id});return d.response.status==="success"?(s.status="delivered",s.latency=d.response.latency,s.payload=d.response.data,d.response.format&&(s.format=d.response.format),s.metadata={...s.metadata,mulesoftApplication:d.response.application,mulesoftFlow:d.response.flow,mulesoftConnector:d.response.connector}):(s.status="failed",s.error=d.response.error||"MuleSoft processing failed",s.latency=d.response.latency||0),s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text"]}:e==="bff-service"?{processData:(t,s,n)=>{const i=ve.getBFFRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.path||s.metadata?.path||"/",l=a?.method||s.metadata?.method||"GET",d=a?.headers||s.metadata?.headers||{},h=a?.query||s.metadata?.query||{},p=a?.body||a||s.payload,g=i.routeRequest({path:o,method:l,headers:d,query:h,body:p});return g.status>=200&&g.status<300?(s.status="delivered",s.latency=g.latency,s.payload=g.data,s.metadata={...s.metadata,bffCacheHit:g.cacheHit,bffBackendResponses:g.backendResponses.length,bffStatus:g.status}):(s.status="failed",s.error=g.error||`HTTP ${g.status}`,s.latency=g.latency),s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json"]}:e==="webhook-relay"?{processData:(t,s,n)=>{const i=ve.getWebhookRelayRoutingEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.url||s.metadata?.url||a?.path||"/",l=a?.method||s.metadata?.method||"POST",d=a?.headers||s.metadata?.headers||{},h=a?.body||a||s.payload,p=a?.ip||s.metadata?.ip||d["x-forwarded-for"]?.split(",")[0]?.trim(),g=a?.event||s.metadata?.event||d["x-event"]||d["x-github-event"]||"",v=i.relayWebhook({url:o,method:l,headers:d,body:h,ip:p,event:g});return v.success?(s.status="delivered",s.latency=v.latency,s.metadata={...s.metadata,webhookRelayId:v.relayId,webhookDeliveryId:v.deliveryId,webhookAttempts:v.attempts,webhookStatus:v.status}):(s.status="failed",s.error=v.error||`Webhook relay failed (HTTP ${v.status})`,s.latency=v.latency,s.metadata={...s.metadata,webhookRelayId:v.relayId,webhookDeliveryId:v.deliveryId,webhookAttempts:v.attempts,webhookStatus:v.status}),s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","text","binary"]}:e==="vpn"?{processData:(t,s,n)=>{const i=ve.getVPNEmulationEngine(t.id);if(!i)return s.status="delivered",s;const a=s.payload,o=a?.source||s.metadata?.source||s.source||"0.0.0.0",l=a?.destination||s.metadata?.destination||s.target||"0.0.0.0",d=a?.protocol||s.metadata?.protocol||"tcp",h=a?.port||s.metadata?.port,p=a?.sourcePort||s.metadata?.sourcePort,g=a?.encrypted||s.metadata?.encrypted||!1,v=a?.connectionId||s.metadata?.connectionId,b=a?.tunnelId||s.metadata?.tunnelId,M=i.processPacket({source:o,destination:l,protocol:d,port:h,sourcePort:p,payload:s.payload,encrypted:g,connectionId:v,tunnelId:b});return M.success?(s.status="delivered",s.latency=(s.latency||0)+M.latency,s.metadata={...s.metadata,vpnEncrypted:M.encrypted,vpnConnectionId:M.connectionId,vpnTunnelId:M.tunnelId,vpnBytesProcessed:M.bytesProcessed},M.encrypted&&(s.metadata={...s.metadata,encrypted:!0})):(s.status="failed",s.error=M.error||"VPN processing failed",s.latency=(s.latency||0)+M.latency),s},transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary","text"]}:{transformData:(t,s,n,i)=>{const a=this.getTargetFormats(n);return a.length>0&&!a.includes(s.format)&&(s.format=a[0],s.status="transformed"),s},getSupportedFormats:()=>["json","xml","binary"]}}getTargetFormats(e){return this.handlers.get(e)?.getSupportedFormats?.({type:e})||["json"]}createLokiHandler(){return{processData:(e,t,s)=>{const n=ve.getLokiEmulationEngine(e.id);if(!n)return t.status="delivered",t;const i=t.payload;if(i?.query||i?.logql){const a=i.query||i.logql,o=i.startTime||i.start,l=i.endTime||i.end,d=i.limit||100,h=n.executeQuery(a,o,l,d);h.success?(t.status="delivered",t.latency=h.latency,t.payload={...t.payload,query:a,results:h.result||[],resultsCount:h.resultsCount}):(t.status="failed",t.error=h.error||"LogQL query execution failed",t.latency=h.latency||0)}else{const a=[],o=i?.stream||i?.labels||t.metadata?.labels||{app:e.data.label?.toLowerCase().replace(/\s+/g,"-")||"unknown",source:t.source.slice(0,8)};let l=[];if(i?.values&&Array.isArray(i.values))l=i.values;else if(i?.logs&&Array.isArray(i.logs)){const d=Date.now()*1e6;l=i.logs.map((h,p)=>[(d+p).toString(),String(h)])}else if(i?.log)l=[[(Date.now()*1e6).toString(),String(i.log)]];else if(typeof i=="string")l=[[(Date.now()*1e6).toString(),i]];else{const d=JSON.stringify(i);l=[[(Date.now()*1e6).toString(),d]]}if(l.length>0){a.push({stream:o,values:l});const d=n.processIngestion(a,t.source);d.success?(t.status="delivered",t.latency=10,t.payload={...t.payload,ingestedLines:d.ingestedLines,ingestedBytes:d.ingestedBytes}):(t.status="failed",t.error=d.error||"Log ingestion failed")}else t.status="failed",t.error="No log entries found in payload"}return t},getSupportedFormats:()=>["json","text"]}}createKeycloakHandler(){return{processData:(e,t,s)=>{const n=ve.getKeycloakEmulationEngine(e.id);if(!n)return t.status="failed",t.error="Keycloak engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||i.grant_type;let o="login";if(typeof a=="string"){const g=a.toLowerCase();g.includes("refresh")||g==="refresh_token"?o="refresh":g.includes("introspect")?o="introspect":g.includes("userinfo")||g.includes("user_info")?o="userinfo":o="login"}const l=i.clientId||i.client_id||t.metadata?.clientId,d=i.username||i.user||t.metadata?.username,h=i.sub||i.subject||t.metadata?.subject||d,p=n.processAuthRequest(o,{clientId:l,username:d,subject:h,grantType:typeof a=="string"?a:void 0});return t.latency=p.latency,p.success?(t.status="delivered",t.payload={...i||{},keycloak:{realm:p.realm,clientId:p.clientId,subject:p.subject,tokenType:p.tokenType,expiresIn:p.expiresIn}},t.metadata={...t.metadata,authRealm:p.realm,authClientId:p.clientId,authSubject:p.subject,authResult:"success"}):(t.status="failed",t.error=p.error||"Keycloak auth failed"),t},getSupportedFormats:()=>["json","text"]}}createJenkinsHandler(){return{processData:(e,t,s)=>{const n=ve.getJenkinsEmulationEngine(e.id);if(!n)return t.status="failed",t.error="Jenkins engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"webhook";if(a==="webhook"||i.ref||i.branch||i.commit){const o=i.pipelineId||i.pipeline||i.job,l=i.branch||i.ref?.replace("refs/heads/","")||"main",d=i.commit||i.sha||void 0;if(o){const h=n.triggerWebhook(o,l,d);h.success?(t.status="delivered",t.latency=50,t.payload={...i||{},jenkins:{webhookReceived:!0,pipelineId:o,branch:l,commit:d,triggered:!0}}):(t.status="failed",t.error=h.reason||"Failed to trigger build",t.latency=50)}else t.status="delivered",t.latency=50,t.payload={...i||{},jenkins:{webhookReceived:!0,branch:l,commit:d,triggered:!1,reason:"No pipeline ID specified"}}}else if(a==="getBuildStatus"||i.buildId||i.buildNumber){const o=i.buildId||i.buildNumber,l=i.pipelineId||i.pipeline,d=n.getBuildById(o||`${l}-${i.buildNumber}`),h=d?.status||"unknown";t.status="delivered",t.latency=20,t.payload={...i||{},jenkins:{buildId:o,pipelineId:l,status:h,progress:d?.progress,duration:d?.duration}}}else t.status="delivered",t.latency=30,t.payload={...i||{},jenkins:{processed:!0,operation:a}};return n.processRequest(t.status==="delivered"),t},getSupportedFormats:()=>["json","text"]}}createGitLabCIHandler(){return{processData:(e,t,s)=>{const n=ve.getGitLabCIEmulationEngine(e.id);if(!n)return t.status="failed",t.error="GitLab CI engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"webhook";if(a==="webhook"||i.ref||i.branch||i.commit){const o=i.ref||i.branch?.replace("refs/heads/","")||"main",l=i.variables||{},d=n.triggerWebhook(o,l);d.success?(t.status="delivered",t.latency=50,t.payload={...i||{},gitlab:{webhookReceived:!0,pipelineId:d.pipelineId,ref:o,variables:l,triggered:!0}}):(t.status="failed",t.error=d.reason||"Failed to trigger pipeline",t.latency=50)}else if(a==="getPipelineStatus"||i.pipelineId||i.pipelineIid){const o=i.pipelineId||i.pipelineIid?.toString(),l=n.getPipeline(o||"");t.status="delivered",t.latency=20,t.payload={...i||{},gitlab:{pipelineId:o,status:l?.status||"unknown",duration:l?.duration,stages:l?.stages.map(d=>({name:d.name,status:d.status,duration:d.duration}))}}}else if(a==="getJobStatus"||i.jobId){const o=i.jobId,l=n.getJob(o||"");t.status="delivered",t.latency=20,t.payload={...i||{},gitlab:{jobId:o,status:l?.status||"unknown",progress:l?.progress,duration:l?.duration,logs:l?.logs?.slice(-10)}}}else if(a==="cancelPipeline"||i.cancel){const o=i.pipelineId,l=n.cancelPipeline(o||"");t.status=l.success?"delivered":"failed",t.error=l.reason,t.latency=30,t.payload={...i||{},gitlab:{pipelineId:o,canceled:l.success}}}else t.status="delivered",t.latency=30,t.payload={...i||{},gitlab:{processed:!0,operation:a}};return n.processRequest(t.status==="delivered"),t},getSupportedFormats:()=>["json","text"]}}createArgoCDHandler(){return{processData:(e,t,s)=>{const n=ve.getArgoCDEmulationEngine(e.id);if(!n)return t.status="failed",t.error="Argo CD engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"webhook";if(a==="webhook"||i.ref||i.branch||i.commit||i.repository){const o=i.repository||i.repo||"",l=i.ref||i.branch||i.commit||"main",d=i.application||i.app||"";d?n.startSync(d)?(t.status="delivered",t.latency=50,t.payload={...i||{},argocd:{webhookReceived:!0,application:d,repository:o,ref:l,syncTriggered:!0}}):(t.status="failed",t.error="Failed to trigger sync or application already syncing",t.latency=50):(t.status="delivered",t.latency=30,t.payload={...i||{},argocd:{webhookReceived:!0,repository:o,ref:l,syncTriggered:!1,reason:"No application specified"}})}else if(a==="sync"||a==="startSync"){const o=i.application||i.app||t.metadata?.application;if(!o)return t.status="failed",t.error="Application name is required for sync operation",t;n.startSync(o)?(t.status="delivered",t.latency=50,t.payload={...i||{},argocd:{operation:"sync",application:o,syncStarted:!0}}):(t.status="failed",t.error="Failed to start sync or application already syncing",t.latency=50)}else if(a==="getApplicationStatus"||a==="getAppStatus"||i.application){const o=i.application||i.app||"",l=n.getApplication(o);t.status="delivered",t.latency=20,t.payload={...i||{},argocd:{application:o,status:l?.status||"unknown",health:l?.health||"unknown",lastSync:l?.lastSync,lastSyncDuration:l?.lastSyncDuration,revision:l?.revision,sourceRevision:l?.sourceRevision}}}else if(a==="getSyncStatus"||i.syncOperationId){const o=i.syncOperationId||i.operationId,d=n.getSyncOperations().find(h=>h.id===o);t.status="delivered",t.latency=20,t.payload={...i||{},argocd:{syncOperationId:o,status:d?.status||"unknown",phase:d?.phase,startedAt:d?.startedAt,finishedAt:d?.finishedAt,error:d?.error}}}else if(a==="getMetrics"||a==="getStats"){const o=n.getMetrics(),l=n.getStats();t.status="delivered",t.latency=15,t.payload={...i||{},argocd:{metrics:o,stats:l}}}else t.status="delivered",t.latency=30,t.payload={...i||{},argocd:{processed:!0,operation:a}};return n.processRequest(t.status==="delivered"),t},getSupportedFormats:()=>["json","text"]}}createTerraformHandler(){return{processData:(e,t,s)=>{const n=ve.getTerraformEmulationEngine(e.id);if(!n)return t.status="failed",t.error="Terraform engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"webhook";if(a==="webhook"||i.ref||i.branch||i.commit||i.repository){const o=i.workspace||i.workspaceId||"",l=i.workspaceId||i.workspace,d=i.ref?.replace("refs/heads/","")||i.branch||"main",h=i.commit||i.sha||void 0;if(o||l){const p=n.getWorkspaces(),g=l?p.find(v=>v.id===l):p.find(v=>v.name===o);if(g){const v=n.triggerRun(g.id,{planOnly:i.planOnly??!1,source:"vcs",triggeredBy:"vcs-webhook"});v.success?(t.status="delivered",t.latency=50,t.payload={...i||{},terraform:{webhookReceived:!0,workspaceId:g.id,workspaceName:g.name,branch:d,commit:h,runTriggered:!0,runId:v.runId}}):(t.status="failed",t.error=v.reason||"Failed to trigger run",t.latency=50)}else t.status="failed",t.error="Workspace not found",t.latency=50}else t.status="delivered",t.latency=30,t.payload={...i||{},terraform:{webhookReceived:!0,branch:d,commit:h,runTriggered:!1,reason:"No workspace specified"}}}else if(a==="triggerRun"||a==="createRun"||a==="run"){const o=i.workspaceId||i.workspace||t.metadata?.workspaceId,l=i.planOnly??!1;if(!o)return t.status="failed",t.error="Workspace ID is required for run operation",t;const d=n.triggerRun(o,{planOnly:l,source:"api",triggeredBy:i.triggeredBy||"user"});d.success?(t.status="delivered",t.latency=50,t.payload={...i||{},terraform:{operation:"triggerRun",workspaceId:o,planOnly:l,runId:d.runId,runTriggered:!0}}):(t.status="failed",t.error=d.reason||"Failed to trigger run",t.latency=50)}else if(a==="cancelRun"||a==="cancel"){const o=i.runId||i.run||t.metadata?.runId;if(!o)return t.status="failed",t.error="Run ID is required for cancel operation",t;const l=n.cancelRun(o);l.success?(t.status="delivered",t.latency=30,t.payload={...i||{},terraform:{operation:"cancelRun",runId:o,canceled:!0}}):(t.status="failed",t.error=l.reason||"Failed to cancel run",t.latency=30)}else if(a==="getRunStatus"||a==="getRun"||i.runId){const o=i.runId||i.run||"",l=n.getRun(o);t.status="delivered",t.latency=20,t.payload={...i||{},terraform:{runId:o,status:l?.status||"unknown",workspaceId:l?.workspaceId,workspaceName:l?.workspaceName,createdAt:l?.createdAt,startedAt:l?.startedAt,finishedAt:l?.finishedAt,duration:l?.duration,planOnly:l?.planOnly,message:l?.message,error:l?.error,hasChanges:l?.hasChanges,resourceAdditions:l?.resourceAdditions,resourceChanges:l?.resourceChanges,resourceDestructions:l?.resourceDestructions}}}else if(a==="getWorkspaceStatus"||a==="getWorkspace"||i.workspaceId){const o=i.workspaceId||i.workspace||"",l=n.getWorkspace(o),d=l?n.getStateForWorkspace(o):void 0;t.status="delivered",t.latency=20,t.payload={...i||{},terraform:{workspaceId:o,workspace:l?{id:l.id,name:l.name,description:l.description,terraformVersion:l.terraformVersion,autoApply:l.autoApply,lastRun:l.lastRun}:null,state:d?{version:d.version,serial:d.serial,resources:d.resources,updatedAt:d.updatedAt}:null}}}else if(a==="getMetrics"||a==="getStats"){const o=n.getMetrics();t.status="delivered",t.latency=20,t.payload={...i||{},terraform:{metrics:{workspacesTotal:o.workspacesTotal,runsTotal:o.runsTotal,runsSuccess:o.runsSuccess,runsFailed:o.runsFailed,runsRunning:o.runsRunning,runsPending:o.runsPending,runsPerHour:o.runsPerHour,averageRunDuration:o.averageRunDuration,statesTotal:o.statesTotal,resourcesManaged:o.resourcesManaged}}}}else t.status="delivered",t.latency=30,t.payload={...i||{},terraform:{processed:!0,operation:a}};return n.processRequest(t.status==="delivered"),t},getSupportedFormats:()=>["json","text"]}}createHarborHandler(){return{processData:(e,t,s)=>{if(!ve.getHarborEmulationEngine(e.id))return t.status="failed",t.error="Harbor engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"pull";return a==="push"?(t.status="delivered",t.latency=500+Math.random()*1500,t.payload={...i||{},harbor:{operation:"push",repository:i.repository||"unknown",tag:i.tag||"latest",size:i.size||0,status:"completed"}}):a==="pull"?(t.status="delivered",t.latency=200+Math.random()*800,t.payload={...i||{},harbor:{operation:"pull",repository:i.repository||"unknown",tag:i.tag||"latest",status:"completed"}}):a==="scan"?(t.status="delivered",t.latency=5e3+Math.random()*15e3,t.payload={...i||{},harbor:{operation:"scan",repository:i.repository||"unknown",tag:i.tag||"latest",status:"completed"}}):(t.status="delivered",t.latency=100+Math.random()*200,t.payload={...i||{},harbor:{operation:a,status:"completed"}}),t},getSupportedFormats:()=>["json","binary"]}}createDockerHandler(){return{processData:(e,t,s)=>{if(!ve.getDockerEmulationEngine(e.id))return t.status="failed",t.error="Docker engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"container-operation";if(a.startsWith("container-")){const o=a.replace("container-","");switch(t.status="delivered",o){case"create":t.latency=500+Math.random()*1e3;break;case"start":t.latency=200+Math.random()*500;break;case"stop":t.latency=100+Math.random()*300;break;case"restart":t.latency=300+Math.random()*700;break;default:t.latency=100+Math.random()*200}t.payload={...i||{},docker:{operation:o,containerId:i.containerId||"unknown",status:"completed"}}}else if(a.startsWith("image-")){const o=a.replace("image-","");switch(t.status="delivered",o){case"pull":t.latency=2e3+Math.random()*8e3;break;case"push":t.latency=3e3+Math.random()*1e4;break;case"build":t.latency=5e3+Math.random()*15e3;break;default:t.latency=1e3+Math.random()*2e3}t.payload={...i||{},docker:{operation:o,imageId:i.imageId||"unknown",status:"completed"}}}else t.status="delivered",t.latency=100+Math.random()*200,t.payload={...i||{},docker:{operation:a,status:"completed"}};return t},getSupportedFormats:()=>["json","text"]}}createVaultHandler(){return{processData:(e,t,s)=>{const n=ve.getVaultEmulationEngine(e.id);if(!n)return t.status="failed",t.error="Vault engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"read",o=i?.path||t.metadata?.path||"secret/default",l=i?.token||t.metadata?.token;let d;if(typeof a=="string"){const h=a.toLowerCase();if(h.includes("write")||h==="create"||h==="update"){const p=i?.data||i?.value||{};d=n.processWriteRequest(o,p,l)}else if(h.includes("delete")||h==="remove")d=n.processDeleteRequest(o,l);else if(h.includes("encrypt")){const p=i?.plaintext||i?.data||"",g=i?.key||i?.keyName||"default";d=n.processEncryptRequest(p,g,l)}else if(h.includes("decrypt")){const p=i?.ciphertext||i?.data||"",g=i?.key||i?.keyName||"default";d=n.processDecryptRequest(p,g,l)}else if(h.includes("auth")||h==="login"||h==="authenticate"){const p=i?.method||i?.authMethod||"token";d=n.processAuthRequest(p,i)}else{const p=i?.key;d=n.processReadRequest(o,p,l)}}else{const h=i?.key;d=n.processReadRequest(o,h,l)}return t.latency=(t.latency||0)+d.latency,d.success?(t.status="delivered",t.payload={...i||{},vault:{path:o,data:d.data,token:d.token,policies:d.policies}},d.token&&(t.metadata={...t.metadata,vaultToken:d.token,vaultPolicies:d.policies})):(t.status="failed",t.error=d.error||"Vault operation failed"),t},getSupportedFormats:()=>["json","text"]}}createWAFHandler(){return{processData:(e,t,s)=>{const n=ve.getWAFEmulationEngine(e.id);if(!n)return t.status="delivered",t;const i=t.payload||{},a=i?.path||t.metadata?.path||"/",o=i?.method||t.metadata?.method||"GET",l=i?.headers||t.metadata?.headers||{},d=i?.query||t.metadata?.query||{},h=i?.body||i,p=i?.sourceIP||t.metadata?.sourceIP||l["x-forwarded-for"]||l["x-real-ip"],g=i?.country||t.metadata?.country||l["cf-ipcountry"],v=i?.userAgent||t.metadata?.userAgent||l["user-agent"],b=n.processRequest({path:a,method:o,headers:l,query:d,body:h,sourceIP:p,country:g,userAgent:v});return t.latency=(t.latency||0)+b.latency,b.blocked?(t.status="failed",t.error=b.error||`Request blocked by WAF: ${b.threatDetected?"Threat detected":"Rule matched"}`,b.threatDetected&&(t.metadata={...t.metadata,wafBlocked:!0,wafThreatDetected:!0,wafAction:"block"})):!b.success&&b.action==="challenge"?(t.status="pending",t.metadata={...t.metadata,wafChallenge:!0,wafAction:"challenge"}):(t.status="delivered",t.metadata={...t.metadata,wafChecked:!0,wafAllowed:!0,wafLatency:b.latency},b.threatDetected&&(t.metadata.wafThreatDetected=!0,t.metadata.wafAction="log")),t},getSupportedFormats:()=>["json","text","xml"]}}createFirewallHandler(){return{processData:(e,t,s)=>{const n=ve.getFirewallEmulationEngine(e.id);if(!n)return t.status="delivered",t;const i=t.payload||{},a=i?.source||t.metadata?.sourceIP||i?.sourceIP||"0.0.0.0",o=i?.destination||t.metadata?.destinationIP||i?.destinationIP||"10.0.0.1",l=i?.protocol||t.metadata?.protocol||"tcp",d=i?.port||t.metadata?.port||i?.destinationPort,h=i?.sourcePort||t.metadata?.sourcePort,p=n.processPacket({source:a,destination:o,protocol:l,port:d,sourcePort:h});return t.latency=(t.latency||0)+p.latency,p.blocked?(t.status="failed",t.error=p.error||`Packet ${p.action} by Firewall: ${p.matchedRule?.name||"Default policy"}`,t.metadata={...t.metadata,firewallBlocked:!0,firewallAction:p.action,firewallRuleId:p.matchedRule?.id,firewallRuleName:p.matchedRule?.name}):(t.status="delivered",t.metadata={...t.metadata,firewallChecked:!0,firewallAllowed:!0,firewallLatency:p.latency,firewallRuleId:p.matchedRule?.id,firewallRuleName:p.matchedRule?.name}),t},getSupportedFormats:()=>["json","text","binary"]}}createIDSIPSHandler(){return{processData:(e,t,s)=>{const n=ve.getIDSIPSEmulationEngine(e.id);if(!n)return t.status="delivered",t;const i=t.payload||{},a=i?.source||t.metadata?.sourceIP||i?.sourceIP||"0.0.0.0",o=i?.destination||t.metadata?.destinationIP||i?.destinationIP||"10.0.0.1",l=i?.protocol||t.metadata?.protocol||"tcp",d=i?.port||t.metadata?.port||i?.destinationPort,h=i?.sourcePort||t.metadata?.sourcePort,p=i?.payload||i?.body||(typeof i=="string"?i:JSON.stringify(i)),g=n.processPacket({source:a,destination:o,protocol:l,port:d,sourcePort:h,payload:p});return t.latency=(t.latency||0)+g.latency,g.blocked?(t.status="failed",t.error=g.error||"Packet blocked by IDS/IPS: Intrusion detected",t.metadata={...t.metadata,idsipsBlocked:!0,idsipsAlertGenerated:g.alertGenerated,idsipsAction:"block"},g.alertGenerated&&(t.metadata.idsipsAlertType="intrusion")):(t.status="delivered",t.metadata={...t.metadata,idsipsChecked:!0,idsipsAllowed:!0,idsipsLatency:g.latency,idsipsAlertGenerated:g.alertGenerated},g.alertGenerated&&(t.metadata.idsipsAction="alert",t.metadata.idsipsAlertType="intrusion")),t},getSupportedFormats:()=>["json","text","binary"]}}createOpenTelemetryCollectorHandler(){return{processData:(e,t,s)=>{const n=ve.getOpenTelemetryCollectorRoutingEngine(e.id);if(!n)return t.status="delivered",t;const i=this.nodes.find(o=>o.id===t.source),a=n.processMessage(t,i||void 0);return a.success?(t.status="delivered",t.latency=a.latency):(t.status="failed",t.error=a.error||"OpenTelemetry Collector processing failed",t.latency=a.latency),t},getSupportedFormats:()=>["json","protobuf","binary","text"]}}createCRMDataMessage(e){const t=e.data.config||{},s=t.contacts||[],n=t.deals||[],i=Math.random()>.5?"contact":"deal";let a;if(i==="contact"&&s.length>0){const l=s[Math.floor(Math.random()*s.length)];a={operation:"create",type:"contact",data:{name:l.name,email:l.email,company:l.company,status:l.status}}}else if(n.length>0){const l=n[Math.floor(Math.random()*n.length)];a={operation:"update",type:"deal",data:{id:l.id,name:l.name,value:l.value,stage:l.stage}}}else a={operation:"create",type:"contact",data:{name:`Contact ${Date.now()}`,email:`contact${Date.now()}@example.com`}};const o=JSON.stringify(a);return{id:"",timestamp:Date.now(),source:e.id,target:"",connectionId:"",format:"json",payload:a,size:new Blob([o]).size,metadata:{contentType:"application/json",operation:a.operation},status:"pending"}}createERPDataMessage(e){const t=e.data.config||{},s=t.orders||[],n=t.inventory||[],i=Math.random()>.5?"order":"inventory";let a;if(i==="order"&&s.length>0){const l=s[Math.floor(Math.random()*s.length)];a={operation:"create",type:"order",data:{orderNumber:l.orderNumber,customer:l.customer,total:l.total,items:l.items}}}else if(n.length>0){const l=n[Math.floor(Math.random()*n.length)];a={operation:"update",type:"inventory",data:{sku:l.sku,quantity:l.quantity,status:l.status}}}else a={operation:"create",type:"order",data:{orderNumber:`ORD-${Date.now()}`,total:Math.random()*1e3}};const o=JSON.stringify(a);return{id:"",timestamp:Date.now(),source:e.id,target:"",connectionId:"",format:"json",payload:a,size:new Blob([o]).size,metadata:{contentType:"application/json",operation:a.operation},status:"pending"}}createPaymentDataMessage(e){const t=ve.getPaymentGatewayEmulationEngine(e.id);let s;if(t){const i=t.getNewTransactionsForDataFlow(),a=t.getStatusChangedTransactions(),o=[...i,...a];if(o.length>0){const l=o[0];s={operation:"process",type:"transaction",data:{id:l.id,amount:l.amount,currency:l.currency,status:l.status,paymentMethod:l.paymentMethod,customerId:l.customerId,timestamp:l.timestamp,description:l.description,fee:l.fee,refundedAmount:l.refundedAmount,metadata:l.metadata}}}else return null}else{const a=(e.data.config||{}).transactions||[];if(a.length>0){const o=a[Math.floor(Math.random()*a.length)];s={operation:"process",type:"transaction",data:{id:o.id,amount:o.amount,currency:o.currency,status:o.status}}}else s={operation:"process",type:"transaction",data:{amount:Math.random()*1e3,currency:"USD"}}}const n=JSON.stringify(s);return{id:"",timestamp:Date.now(),source:e.id,target:"",connectionId:"",format:"json",payload:s,size:new Blob([n]).size,metadata:{contentType:"application/json",operation:s.operation},status:"pending"}}generateQueryResults(e,t){const s=Math.floor(Math.random()*10)+1,n=[];for(let i=0;i<s;i++)n.push({id:i+1,name:`Record ${i+1}`,value:Math.random()*100,timestamp:new Date().toISOString()});return n}createSparkHandler(){return{processData:(e,t,s)=>{const n=ve.getSparkEmulationEngine(e.id);if(!n)return t.status="failed",t.error="Spark engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"process-data";if(a==="process-data"||a==="job"||!a){const o=t.size||0,l=i.jobName||`Data Processing Job ${Date.now()}`,d={id:`job-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:l,status:"RUNNING",startTime:Date.now(),stages:3+Math.floor(Math.random()*5),tasks:10+Math.floor(Math.random()*90),executors:n.getExecutors().filter(h=>h.status==="ALIVE").length,inputBytes:o,outputBytes:Math.floor(o*.8),shuffleRead:Math.floor(o*.3),shuffleWrite:Math.floor(o*.3),submissionTime:Date.now()};return n.addJob(d),t.latency=100+Math.random()*200,t.status="delivered",t.payload={...t.payload,sparkJobId:d.id,jobName:d.name,status:"RUNNING",message:"Spark job created and started"},t}else if(a==="query"||a==="sql"){const o=i.sql||i.query||"";if(!o)return t.status="failed",t.error="SQL query is required",t;const l=n.executeSQL(o,Date.now()),d=l.executionTime||2e3;return t.latency=d,t.status="delivered",t.payload={...t.payload,sqlQueryId:l.id,explainPlan:l.explainPlan,physicalPlan:l.physicalPlan,logicalPlan:l.logicalPlan,results:this.generateQueryResults("spark",o),query:o,processed:!0,status:"RUNNING"},t}else if(a==="streaming"){const o=i.streamConfig||{},l=o.batchInterval||s.streamingBatchInterval||1e3,d=o.name||`Streaming Job ${Date.now()}`,h=n.createStreamingJob(d,l,Date.now());return t.latency=l,t.status="delivered",t.payload={...t.payload,streamingJobId:h.id,streaming:!0,batchInterval:l,message:"Streaming job started",status:"ACTIVE"},t}else return t.status="failed",t.error=`Unknown Spark operation: ${a}`,t},getSupportedFormats:()=>["json","text","binary"]}}createTensorFlowServingHandler(){return{processData:(e,t,s)=>{const n=ve.getTensorFlowServingEmulationEngine(e.id);if(!n)return t.status="failed",t.error="TensorFlow Serving engine not initialized",t;const i=t.payload||{},a=i.model||i.modelName||t.metadata?.model||t.metadata?.modelName||"",o=i.version||t.metadata?.version||"1",l=i.input||i.instances||i.data||t.payload;if(!a)return t.status="failed",t.error="Model name is required",t;try{n.addPendingPrediction(a,o,l).then(h=>{h.success?(t.status="delivered",t.latency=h.latency,t.payload={...t.payload,model:a,version:o,latency:h.latency,predictions:h.output}):(t.status="failed",t.error=h.error||"Prediction failed"),t.metadata={...t.metadata,model:a,version:o}}).catch(h=>{t.status="failed",t.error=h instanceof Error?h.message:"Prediction error"}),t.status="in-transit",t.metadata={...t.metadata,model:a,version:o}}catch(d){t.status="failed",t.error=d instanceof Error?d.message:"Prediction error"}return t},getSupportedFormats:()=>["json"]}}createPyTorchServeHandler(){return{processData:(e,t,s)=>{const n=ve.getPyTorchServeEmulationEngine(e.id);if(!n)return t.status="failed",t.error="PyTorch Serve engine not initialized",t;const i=t.payload||{},a=i.model||i.modelName||t.metadata?.model||t.metadata?.modelName||"",o=i.version||t.metadata?.version||"1",l=i.input||i.instances||i.data||t.payload;if(!a)return t.status="failed",t.error="Model name is required",t;try{n.addPendingPrediction(a,o,l).then(h=>{h.success?(t.status="delivered",t.latency=h.latency,t.payload={...t.payload,model:a,version:o,latency:h.latency,predictions:h.output}):(t.status="failed",t.error=h.error||"Prediction failed"),t.metadata={...t.metadata,model:a,version:o}}).catch(h=>{t.status="failed",t.error=h instanceof Error?h.message:"Prediction error"}),t.status="in-transit",t.metadata={...t.metadata,model:a,version:o}}catch(d){t.status="failed",t.error=d instanceof Error?d.message:"Prediction error"}return t},getSupportedFormats:()=>["json"]}}createFeatureStoreHandler(){return{processData:(e,t,s)=>{const n=ve.getFeatureStoreEmulationEngine(e.id);if(!n)return t.status="failed",t.error="Feature Store engine not initialized",t;const i=t.payload||{},a=t.metadata?.operation||i.operation||i.action||"get-features",o=i.features||i.featureNames||t.metadata?.features||[],l=i.entities||i.entityIds||t.metadata?.entities,d=i.requestType||t.metadata?.requestType||"online",h=i.pointInTime||t.metadata?.pointInTime;if(a==="get-features"||a==="get-feature-set"||!a){if(!Array.isArray(o)||o.length===0)return t.status="failed",t.error="Feature names are required",t;const p=n.processFeatureRequest(o,l,d,h);return t.latency=(t.latency||0)+p.latency,p.success?(t.status="delivered",t.payload={...t.payload,features:p.data,cacheHit:p.cacheHit,requestType:d},t.metadata={...t.metadata,operation:"get-features",features:o,requestType:d,cacheHit:p.cacheHit}):(t.status="failed",t.error=p.error||"Feature request failed"),t}else if(a==="write-features"||a==="write"){const p=i.features||i.data||{};if(Object.keys(p).length===0)return t.status="failed",t.error="Features data is required",t;const g=i.entities||i.entityIds||t.metadata?.entities,v=i.storeType||t.metadata?.storeType||"online",b=i.timestamp||t.metadata?.timestamp,M=n.writeFeatures(p,g,v,b);return t.latency=(t.latency||0)+M.latency,M.success?(t.status="delivered",t.payload={...t.payload,written:!0,featuresWritten:M.written,features:Object.keys(p)},t.metadata={...t.metadata,operation:"write-features",storeType:v}):(t.status="failed",t.error=M.error||"Feature write failed"),t}else if(a==="validate-features"||a==="validate"){const p=i.features||i.data||{};return Object.keys(p).length===0?(t.status="failed",t.error="Features data is required for validation",t):(t.latency=(t.latency||0)+5,t.status="delivered",t.payload={...t.payload,validated:!0,features:Object.keys(p)},t.metadata={...t.metadata,operation:"validate-features"},t)}else return t.status="failed",t.error=`Unknown Feature Store operation: ${a}`,t},getSupportedFormats:()=>["json","text"]}}}const rs=new PE;class LE{componentStates=new Map;setComponentState(e,t,s){const n={nodeId:e,state:t,degradedLevel:s?.degradedLevel||.5,failureRate:s?.failureRate||.1,latencyMultiplier:s?.latencyMultiplier||2,throughputMultiplier:s?.throughputMultiplier||.5};this.componentStates.set(e,n)}getComponentState(e){return this.componentStates.get(e)}isEnabled(e){const t=this.componentStates.get(e);return!t||t.state==="enabled"}applyStateEffects(e,t){const s=this.componentStates.get(e);if(!s||s.state==="enabled")return{...t};if(s.state==="disabled"||s.state==="failed")return{throughput:0,latency:1/0,errorRate:1,utilization:0};if(s.state==="degraded"){const n=s.degradedLevel||.5;return{throughput:t.throughput*(s.throughputMultiplier||.5)*(1-n*.5),latency:t.latency*(s.latencyMultiplier||2)*(1+n),errorRate:Math.min(1,t.errorRate+(s.failureRate||.1)*n),utilization:Math.min(1,t.utilization*(1+n*.3))}}return{...t}}reset(){this.componentStates.clear()}resetComponent(e){this.componentStates.delete(e)}getAllStates(){return Array.from(this.componentStates.values())}}const wo=new LE;class _E{queues=new Map;exchanges=new Map;bindings=new Map;queueMessages=new Map;unackedMessages=new Map;queueState=new Map;consumptionRate=10;processingTime=100;initialize(e){if(e.consumptionRate!==void 0&&(this.consumptionRate=e.consumptionRate),e.processingTime!==void 0&&(this.processingTime=e.processingTime),this.queues.clear(),this.exchanges.clear(),this.bindings.clear(),this.queueMessages.clear(),this.unackedMessages.clear(),this.queueState.clear(),e.queues)for(const t of e.queues)this.queues.set(t.name,{...t}),this.queueMessages.set(t.name,[]),this.unackedMessages.set(t.name,[]),this.queueState.set(t.name,{ready:t.ready||0,unacked:t.unacked||0,total:t.messages||0,lastUpdate:Date.now()});if(e.exchanges)for(const t of e.exchanges)this.exchanges.set(t.name,{...t}),this.bindings.set(t.name,[]);if(e.bindings)for(const t of e.bindings){const s=this.bindings.get(t.source)||[];s.push(t),this.bindings.set(t.source,s)}}routeMessage(e,t,s,n,i,a){const o=this.exchanges.get(e);if(!o)return[];const l=this.bindings.get(e)||[],d=[];for(const g of l)this.shouldRouteToQueue(o,g,t,i)&&d.push(g.destination);if(d.length===0&&o.alternateExchange)return this.routeMessage(o.alternateExchange,t,s,n,i,a);const h=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,p=Date.now();for(const g of d){const v=this.queues.get(g);if(!v)continue;if(v.maxLength&&(this.queueMessages.get(g)||[]).length>=v.maxLength){v.deadLetterExchange&&this.routeToDeadLetterExchange(v.deadLetterExchange,v.deadLetterRoutingKey||t,s,n,i,a);continue}const b={id:h,timestamp:p,routingKey:t,exchange:e,payload:s,size:n,priority:a||v.maxPriority?a||0:void 0,headers:i,ttl:v.messageTtl?p+v.messageTtl:void 0},M=this.queueMessages.get(g)||[];M.push(b),v.maxPriority&&b.priority!==void 0&&M.sort((x,S)=>(S.priority||0)-(x.priority||0)),this.queueMessages.set(g,M)}return d}shouldRouteToQueue(e,t,s,n){switch(e.type){case"direct":return t.routingKey===s;case"topic":return this.matchTopicPattern(t.routingKey,s);case"fanout":return!0;case"headers":if(!n||!t.arguments)return!1;const i=t.arguments["x-match"]||"all",a=Object.keys(t.arguments).filter(o=>!o.startsWith("x-"));if(a.length===0)return!0;if(i==="all"){for(const o of a){const l=t.arguments[o];if(n[o]!==l)return!1}return!0}else if(i==="any"){for(const o of a){const l=t.arguments[o];if(n[o]===l)return!0}return!1}return!1;default:return!1}}matchTopicPattern(e,t){const s=e.replace(/\./g,"\\.").replace(/\*/g,"[^.]+").replace(/#/g,".*");return new RegExp(`^${s}$`).test(t)}routeToDeadLetterExchange(e,t,s,n,i,a){this.routeMessage(e,t,s,n,i,a)}processConsumption(e){const t=Date.now();for(const[s,n]of this.queues.entries()){let i=this.queueMessages.get(s)||[],a=this.unackedMessages.get(s)||[];const o=this.queueState.get(s)||{ready:0,unacked:0,total:0,lastUpdate:t};i=i.filter(M=>M.ttl&&t>M.ttl?(n.deadLetterExchange&&this.routeToDeadLetterExchange(n.deadLetterExchange,n.deadLetterRoutingKey||M.routingKey,M.payload,M.size,M.headers,M.priority),!1):!0),this.queueMessages.set(s,i);const h=(n.consumers||0)*this.consumptionRate*e/1e3,p=Math.min(h,i.length),g=i.splice(0,p);a.push(...g),this.unackedMessages.set(s,a);const v=e/this.processingTime*a.length,b=Math.min(v,a.length);a.splice(0,Math.floor(b)),this.unackedMessages.set(s,a),o.ready=i.length,o.unacked=a.length,o.total=i.length+a.length,o.lastUpdate=t,this.queueState.set(s,o)}}getQueueMetrics(e){const t=this.queues.get(e);if(!t)return null;const s=this.queueMessages.get(e)||[],n=this.unackedMessages.get(e)||[];this.queueState.get(e);const i=s.length,a=n.length;return{messages:i+a,ready:i,unacked:a,consumers:t.consumers||0}}getAllQueueMetrics(){const e=new Map;for(const t of this.queues.keys()){const s=this.getQueueMetrics(t);s&&e.set(t,s)}return e}getTotalQueueDepth(){let e=0;for(const t of this.queueMessages.values())e+=t.length;for(const t of this.unackedMessages.values())e+=t.length;return e}getActiveConnections(){let e=0;for(const t of this.queues.values())t.consumers&&(e+=t.consumers);return e+=this.exchanges.size,Math.max(1,e)}updateQueue(e,t){const s=this.queues.get(e);s&&(Object.assign(s,t),this.queues.set(e,s))}}class IE{queues=new Map;topics=new Map;subscriptions=new Map;queueMessages=new Map;topicMessages=new Map;subscriptionMessages=new Map;deadLetterQueue=[];deadLetterQueueName="DLQ";queueState=new Map;topicState=new Map;consumptionRate=10;initialize(e){if(e.consumptionRate!==void 0&&(this.consumptionRate=e.consumptionRate),e.deadLetterQueue!==void 0&&(this.deadLetterQueueName=e.deadLetterQueue),this.queues.clear(),this.topics.clear(),this.subscriptions.clear(),this.queueMessages.clear(),this.topicMessages.clear(),this.subscriptionMessages.clear(),this.deadLetterQueue=[],this.queueState.clear(),this.topicState.clear(),e.queues)for(const t of e.queues)this.queues.set(t.name,{...t}),this.queueMessages.set(t.name,[]),this.queueState.set(t.name,{queueSize:t.queueSize||0,consumerCount:t.consumerCount||0,enqueueCount:t.enqueueCount||0,dequeueCount:t.dequeueCount||0,lastUpdate:Date.now()});if(e.topics)for(const t of e.topics)this.topics.set(t.name,{...t}),this.topicMessages.set(t.name,[]),this.subscriptions.set(t.name,[]),this.topicState.set(t.name,{subscriberCount:t.subscriberCount||0,enqueueCount:t.enqueueCount||0,dequeueCount:t.dequeueCount||0,lastUpdate:Date.now()});if(e.subscriptions)for(const t of e.subscriptions){const s=this.subscriptions.get(t.destination)||[];s.push(t),this.subscriptions.set(t.destination,s),this.subscriptionMessages.set(t.id,[])}}routeToQueue(e,t,s,n,i,a){const o=this.queues.get(e);if(!o)return!1;const l=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d=Date.now(),h=i!==void 0?i:o.defaultPriority!==void 0?o.defaultPriority:void 0,p=a!==void 0?a:o.defaultTTL!==void 0?o.defaultTTL:void 0,g=p&&p>0?d+p*1e3:void 0,v=this.queueMessages.get(e)||[],b=v.reduce((T,E)=>T+E.size,0),M=o.memoryLimit?o.memoryLimit*1024*1024:void 0;if(M&&b+s>M){const T={id:l,timestamp:d,destination:this.deadLetterQueueName,payload:t,size:s,headers:{...n,originalDestination:e,reason:"memoryLimitExceeded",memoryUsage:b,memoryLimit:M,movedToDLQAt:d},priority:h,ttl:g};return this.deadLetterQueue.push(T),!1}const x={id:l,timestamp:d,destination:e,payload:t,size:s,headers:n,priority:h,ttl:g};v.push(x),v.sort((T,E)=>(E.priority||0)-(T.priority||0)),this.queueMessages.set(e,v);const S=this.queueState.get(e)||{queueSize:0,consumerCount:0,enqueueCount:0,dequeueCount:0,lastUpdate:d};return S.queueSize=v.length,S.enqueueCount=(S.enqueueCount||0)+1,S.lastUpdate=d,this.queueState.set(e,S),!0}publishToTopic(e,t,s,n,i,a){const o=this.topics.get(e);if(!o)return[];const l=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d=Date.now(),h=this.subscriptions.get(e)||[],p=[],g=i!==void 0?i:o.defaultPriority!==void 0?o.defaultPriority:void 0,v=a!==void 0?a:o.defaultTTL!==void 0?o.defaultTTL:void 0,b=v&&v>0?d+v*1e3:void 0,M={id:l,timestamp:d,destination:e,payload:t,size:s,headers:n,priority:g,ttl:b};for(const S of h){if(S.selector&&!this.matchesSelector(S.selector,n))continue;const T=this.subscriptionMessages.get(S.id)||[];T.push(M),this.subscriptionMessages.set(S.id,T),p.push(S.id),S.pendingQueueSize=(S.pendingQueueSize||0)+1,S.enqueueCounter=(S.enqueueCounter||0)+1}if(h.length===0){const S=this.topicMessages.get(e)||[];S.push(M),this.topicMessages.set(e,S)}const x=this.topicState.get(e)||{subscriberCount:0,enqueueCount:0,dequeueCount:0,lastUpdate:d};return x.enqueueCount=(x.enqueueCount||0)+1,x.lastUpdate=d,this.topicState.set(e,x),p}matchesSelector(e,t){if(!t||!e)return!0;try{const s=e.trim(),n=s.match(/^(\w+)\s*=\s*['"]([^'"]+)['"]$/);if(n){const a=n[1],o=n[2];return t[a]===o}const i=s.match(/^(\w+)\s*([><=]+)\s*(\d+)$/);if(i){const a=i[1],o=i[2],l=Number(i[3]),d=Number(t[a]);if(isNaN(d))return!1;switch(o){case">":return d>l;case"<":return d<l;case">=":return d>=l;case"<=":return d<=l;case"=":return d===l;default:return!1}}for(const a in t)if(s.includes(a))return!0;return!1}catch{return!0}}calculateRedeliveryDelay(e,t){if(!t)return 0;t.maxRedeliveries;const s=t.initialRedeliveryDelay??1e3,n=t.maximumRedeliveryDelay??6e4,i=t.useExponentialBackOff??!1,a=t.backOffMultiplier??2;if(e<=1)return 0;let o=s;return i?o=s*Math.pow(a,e-2):o=s*(e-1),Math.min(o,n)}getRedeliveryPolicy(e){return e.redeliveryPolicy?e.redeliveryPolicy:{maxRedeliveries:e.maxRedeliveries??6,initialRedeliveryDelay:1e3,maximumRedeliveryDelay:6e4,useExponentialBackOff:!1,backOffMultiplier:2}}processConsumption(e){const t=Date.now();for(const[s,n]of this.queues.entries()){let i=this.queueMessages.get(s)||[];const a=this.queueState.get(s)||{queueSize:0,consumerCount:0,enqueueCount:0,dequeueCount:0,lastUpdate:t},o=this.getRedeliveryPolicy(n),l=o.maxRedeliveries??6,d=[];i=i.filter(D=>D.ttl&&t>D.ttl?(d.push(D),!1):!0);for(const D of d)D.destination=this.deadLetterQueueName,D.headers={...D.headers,originalDestination:s,reason:"expired",expiredAt:t},this.deadLetterQueue.push(D);const h=i.filter(D=>D.redeliveryTime===void 0?!0:t>=D.redeliveryTime),p=i.filter(D=>D.redeliveryTime===void 0?!1:t<D.redeliveryTime);this.queueMessages.set(s,[...h,...p]);const g=n.consumerCount||a.consumerCount||0,v=n.prefetch??0,M=g*this.consumptionRate*e/1e3;let x=h.length;if(v>0&&g>0){const D=g*v;x=Math.min(h.length,D)}const S=Math.min(M,x),T=h.splice(0,Math.floor(S)),E=[],A=[];for(const D of T)if(D.deliveryCount===void 0&&(D.deliveryCount=0),D.deliveryCount++,D.redelivered=D.deliveryCount>1,Math.random()<.001&&D.deliveryCount<=l){const I=this.calculateRedeliveryDelay(D.deliveryCount,o);D.redeliveryTime=t+I,E.push(D)}else D.deliveryCount>l?(D.destination=this.deadLetterQueueName,D.headers={...D.headers,originalDestination:s,reason:"maxRedeliveriesExceeded",deliveryCount:D.deliveryCount,movedToDLQAt:t},this.deadLetterQueue.push(D)):(D.redeliveryTime=void 0,A.push(D));const k=[...h,...E,...p];k.sort((D,L)=>{const I=(L.priority||0)-(D.priority||0);return I!==0?I:D.redeliveryTime===void 0&&L.redeliveryTime===void 0?0:D.redeliveryTime===void 0?-1:L.redeliveryTime===void 0?1:D.redeliveryTime-L.redeliveryTime}),i=k,this.queueMessages.set(s,i),a.queueSize=i.length,a.dequeueCount=(a.dequeueCount||0)+A.length,a.lastUpdate=t,this.queueState.set(s,a)}for(const[s,n]of this.subscriptions.entries()){const i=this.topics.get(s);if(!i)continue;const a=this.getRedeliveryPolicy(i),o=a.maxRedeliveries??6;for(const d of n){let h=this.subscriptionMessages.get(d.id)||[];const p=[];h=h.filter(k=>k.ttl&&t>k.ttl?(p.push(k),!1):!0);for(const k of p)k.destination=this.deadLetterQueueName,k.headers={...k.headers,originalDestination:s,subscriptionId:d.id,reason:"expired",expiredAt:t},this.deadLetterQueue.push(k);const g=h.filter(k=>k.redeliveryTime===void 0?!0:t>=k.redeliveryTime),v=h.filter(k=>k.redeliveryTime===void 0?!1:t<k.redeliveryTime),M=this.consumptionRate*e/1e3,x=Math.min(M,g.length),S=g.splice(0,Math.floor(x)),T=[],E=[];for(const k of S)if(k.deliveryCount===void 0&&(k.deliveryCount=0),k.deliveryCount++,k.redelivered=k.deliveryCount>1,Math.random()<.001&&k.deliveryCount<=o){const L=this.calculateRedeliveryDelay(k.deliveryCount,a);k.redeliveryTime=t+L,T.push(k)}else k.deliveryCount>o?(k.destination=this.deadLetterQueueName,k.headers={...k.headers,originalDestination:s,subscriptionId:d.id,reason:"maxRedeliveriesExceeded",deliveryCount:k.deliveryCount,movedToDLQAt:t},this.deadLetterQueue.push(k)):(k.redeliveryTime=void 0,E.push(k));const A=[...g,...T,...v];A.sort((k,D)=>{const L=(D.priority||0)-(k.priority||0);return L!==0?L:k.redeliveryTime===void 0&&D.redeliveryTime===void 0?0:k.redeliveryTime===void 0?-1:D.redeliveryTime===void 0?1:k.redeliveryTime-D.redeliveryTime}),h=A,d.pendingQueueSize=h.length,d.dispatchedQueueSize=(d.dispatchedQueueSize||0)+E.length,d.dequeueCounter=(d.dequeueCounter||0)+E.length,this.subscriptionMessages.set(d.id,h)}const l=this.topicState.get(s);l&&(l.dequeueCount=n.reduce((d,h)=>d+(h.dequeueCounter||0),0),l.lastUpdate=t)}}getQueueMetrics(e){if(!this.queues.get(e))return null;const s=this.queueState.get(e);return s?{queueSize:s.queueSize,consumerCount:s.consumerCount,enqueueCount:s.enqueueCount,dequeueCount:s.dequeueCount}:null}getTopicMetrics(e){if(!this.topics.get(e))return null;const s=this.topicState.get(e);return s?{subscriberCount:s.subscriberCount,enqueueCount:s.enqueueCount,dequeueCount:s.dequeueCount}:null}getAllQueueMetrics(){const e=new Map;for(const t of this.queues.keys()){const s=this.getQueueMetrics(t);s&&e.set(t,s)}return e}getAllTopicMetrics(){const e=new Map;for(const t of this.topics.keys()){const s=this.getTopicMetrics(t);s&&e.set(t,s)}return e}getTotalQueueDepth(){let e=0;for(const t of this.queueMessages.values())e+=t.length;return e}getTotalTopicMessages(){let e=0;for(const t of this.subscriptionMessages.values())e+=t.length;for(const t of this.topicMessages.values())e+=t.length;return e}getActiveConnections(){let e=0;for(const t of this.queues.values())t.consumerCount&&(e+=t.consumerCount);for(const t of this.subscriptions.values())e+=t.length;return Math.max(1,e+1)}updateQueue(e,t){const s=this.queues.get(e);if(s){Object.assign(s,t),this.queues.set(e,s);const n=this.queueState.get(e);n&&t.consumerCount!==void 0&&(n.consumerCount=t.consumerCount)}}updateTopic(e,t){const s=this.topics.get(e);if(s){Object.assign(s,t),this.topics.set(e,s);const n=this.topicState.get(e);n&&t.subscriberCount!==void 0&&(n.subscriberCount=t.subscriberCount)}}getStoreUsage(e){if(!e)return 0;let t=0;for(const s of this.queueMessages.values())for(const n of s)t+=n.size;for(const s of this.subscriptionMessages.values())for(const n of s)t+=n.size;return t}getTempUsage(e){if(e)return 0;let t=0;for(const s of this.queueMessages.values())for(const n of s)t+=n.size;for(const s of this.topicMessages.values())for(const n of s)t+=n.size;return t}getDeadLetterQueueMessages(){return[...this.deadLetterQueue]}getDeadLetterQueueSize(){return this.deadLetterQueue.length}getDeadLetterQueueName(){return this.deadLetterQueueName}clearDeadLetterQueue(){this.deadLetterQueue=[]}removeFromDeadLetterQueue(e){const t=this.deadLetterQueue.findIndex(s=>s.id===e);return t!==-1?(this.deadLetterQueue.splice(t,1),!0):!1}}class NE{queues=new Map;queueMessages=new Map;inFlightMessages=new Map;dlqMessages=new Map;queueState=new Map;messageGroups=new Map;deduplicationIds=new Map;deduplicationIdTimestamps=new Map;inFlightGroups=new Map;cloudWatchMetrics=new Map;initialize(e){if(this.queues.clear(),this.queueMessages.clear(),this.inFlightMessages.clear(),this.dlqMessages.clear(),this.queueState.clear(),this.messageGroups.clear(),this.deduplicationIds.clear(),this.deduplicationIdTimestamps.clear(),this.inFlightGroups.clear(),this.cloudWatchMetrics.clear(),e.queues)for(const t of e.queues)this.queues.set(t.name,{...t}),this.queueMessages.set(t.name,[]),this.inFlightMessages.set(t.name,[]),this.queueState.set(t.name,{approximateMessages:0,approximateMessagesNotVisible:0,approximateMessagesDelayed:0,sentCount:0,receivedCount:0,deletedCount:0,dlqCount:0,lastUpdate:Date.now()}),t.type==="fifo"&&(this.messageGroups.set(t.name,new Map),this.deduplicationIds.set(t.name,new Set),this.deduplicationIdTimestamps.set(t.name,new Map),this.inFlightGroups.set(t.name,new Set)),this.cloudWatchMetrics.set(t.name,{numberOfMessagesSent:0,numberOfMessagesReceived:0,numberOfMessagesDeleted:0,approximateNumberOfMessagesVisible:0,approximateNumberOfMessagesNotVisible:0,approximateNumberOfMessagesDelayed:0,sentMessageSize:0,receivedMessageSize:0,timestamp:Date.now()}),t.maxReceiveCount&&!t.deadLetterQueue&&(`${t.name}`,t.type)}sendMessage(e,t,s,n,i,a,o){const l=this.queues.get(e);if(!l)return null;const d=Date.now(),h=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,p=`${e}-${h}`;if(l.type==="fifo"){if(l.contentBasedDedup&&!a){const A=JSON.stringify(t);a=this.hashString(A)}if(a){const A=this.deduplicationIds.get(e),k=this.deduplicationIdTimestamps.get(e);if(A&&k){if(A.has(a)){const D=k.get(a);if(D&&d-D<300*1e3)return p;A.delete(a),k.delete(a)}A.add(a),k.set(a,d)}}i||(i="default-group")}const g=l.messageRetention*24*60*60*1e3,v=d+g,b=l.delaySeconds*1e3,M=b>0?d+b:void 0,x={id:h,messageId:p,timestamp:d,queueName:e,payload:t,size:s,attributes:n,systemAttributes:o,messageGroupId:i,messageDeduplicationId:a,receiveCount:0,retentionExpiresAt:v,delayUntil:M,sentTimestamp:d},S=this.queueMessages.get(e)||[];if(l.type==="fifo"&&i){const A=this.messageGroups.get(e);if(A){const k=A.get(i)||[];k.push(x),A.set(i,k)}}else S.push(x);l.type!=="fifo"&&S.push(x),this.queueMessages.set(e,S);const T=this.queueState.get(e);if(T){let A=0;if(l.type==="fifo"){const I=this.messageGroups.get(e);if(I)for(const U of I.values())A+=U.filter(Q=>(!Q.delayUntil||d>=Q.delayUntil)&&d<Q.retentionExpiresAt).length}else A=(this.queueMessages.get(e)||[]).filter(U=>(!U.delayUntil||d>=U.delayUntil)&&d<U.retentionExpiresAt).length;const k=this.inFlightMessages.get(e)||[],L=(this.queueMessages.get(e)||[]).filter(I=>I.delayUntil&&d<I.delayUntil);T.approximateMessages=A,T.approximateMessagesNotVisible=k.length,T.approximateMessagesDelayed=L.length,T.sentCount=(T.sentCount||0)+1,T.lastUpdate=d}const E=this.cloudWatchMetrics.get(e);return E&&(E.numberOfMessagesSent+=1,E.sentMessageSize+=s,E.approximateNumberOfMessagesVisible=T?.approximateMessages||0,E.approximateNumberOfMessagesNotVisible=T?.approximateMessagesNotVisible||0,E.approximateNumberOfMessagesDelayed=T?.approximateMessagesDelayed||0,E.timestamp=d),p}receiveMessage(e,t=1,s,n=0,i,a){const o=this.queues.get(e);if(!o)return[];const l=Math.min(t,10),d=Date.now(),p=(s!==void 0?s:o.visibilityTimeout)*1e3,g=!a||a.includes("All"),v=g||a?.includes("ApproximateFirstReceiveTimestamp"),b=g||a?.includes("ApproximateReceiveCount"),M=g||a?.includes("SentTimestamp");let x=(this.queueMessages.get(e)||[]).filter(k=>!(k.delayUntil&&d<k.delayUntil||d>=k.retentionExpiresAt));if(o.type==="fifo"){const k=this.messageGroups.get(e),D=this.inFlightGroups.get(e)||new Set;if(k){x=[];let L=0;const I=o.highThroughputFifo===!0;if((o.fifoThroughputLimit||"perQueue")==="perMessageGroupId"||I)for(const[Q,se]of k.entries()){if(L>=l)break;if(!(D.has(Q)&&!I))for(const F of se){if(L>=l)break;(!F.delayUntil||d>=F.delayUntil)&&d<F.retentionExpiresAt&&(x.push(F),L++,I||D.add(Q))}}else{const Q=Array.from(k.entries());let se=0;for(;L<l&&Q.length>0;){const[F,Y]=Q[se%Q.length];if(D.has(F)){se++;continue}if(Y.length>0){const ae=Y[0];(!ae.delayUntil||d>=ae.delayUntil)&&d<ae.retentionExpiresAt&&(x.push(ae),L++,D.add(F))}if(se++,se>Q.length*10)break}}}}const S=Math.min(l,x.length),T=[];for(let k=0;k<S;k++){const D=x[k],L=`receipt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;if(D.receiptHandle=L,D.receiveCount=(D.receiveCount||0)+1,D.firstReceivedAt||(D.firstReceivedAt=d),v&&!D.approximateFirstReceiveTimestamp&&(D.approximateFirstReceiveTimestamp=d),b&&(D.approximateReceiveCount=D.receiveCount),M&&!D.sentTimestamp&&(D.sentTimestamp=D.timestamp),i&&i.length>0&&D.attributes){const F={};for(const Y of i)D.attributes[Y]&&(F[Y]=D.attributes[Y]);D.attributes=F}(g||a)&&(D.systemAttributes={},v&&D.approximateFirstReceiveTimestamp&&(D.systemAttributes.ApproximateFirstReceiveTimestamp=D.approximateFirstReceiveTimestamp.toString()),b&&D.approximateReceiveCount&&(D.systemAttributes.ApproximateReceiveCount=D.approximateReceiveCount.toString()),M&&D.sentTimestamp&&(D.systemAttributes.SentTimestamp=D.sentTimestamp.toString()));const I={message:D,receivedAt:d,visibilityTimeoutExpiresAt:d+p},U=this.inFlightMessages.get(e)||[];U.push(I),this.inFlightMessages.set(e,U);const Q=this.queueMessages.get(e)||[],se=Q.indexOf(D);if(se>-1&&Q.splice(se,1),this.queueMessages.set(e,Q),o.type==="fifo"&&D.messageGroupId){const F=this.messageGroups.get(e);if(F){const Y=F.get(D.messageGroupId)||[],ae=Y.indexOf(D);if(ae>-1&&Y.splice(ae,1),Y.length===0){F.delete(D.messageGroupId);const de=this.inFlightGroups.get(e);de&&de.delete(D.messageGroupId)}else F.set(D.messageGroupId,Y)}}T.push(D)}const E=this.cloudWatchMetrics.get(e);E&&T.length>0&&(E.numberOfMessagesReceived+=T.length,E.receivedMessageSize+=T.reduce((k,D)=>k+D.size,0),E.approximateNumberOfMessagesNotVisible=(this.inFlightMessages.get(e)||[]).length,E.timestamp=d);const A=this.queueState.get(e);return A&&(A.receivedCount=(A.receivedCount||0)+T.length,A.lastUpdate=d),T}sendMessageBatch(e,t){const s=this.queues.get(e);if(!s)return{successful:[],failed:t.map(o=>({id:o.id,code:"AWS.SimpleQueueService.NonExistentQueue",message:`Queue '${e}' does not exist`}))};if(t.length>10)return{successful:[],failed:t.map(o=>({id:o.id,code:"AWS.SimpleQueueService.TooManyEntriesInBatchRequest",message:"Maximum number of entries per request is 10"}))};const n=[],i=[],a=new Set;for(const o of t){if(a.has(o.id)){i.push({id:o.id,code:"AWS.SimpleQueueService.BatchEntryIdsNotDistinct",message:`Id ${o.id} is duplicated`});continue}if(a.add(o.id),o.size>256*1024){i.push({id:o.id,code:"AWS.SimpleQueueService.InvalidMessageContents",message:"Message size exceeds 256 KB limit"});continue}const l=s.delaySeconds;o.delaySeconds!==void 0&&(s.delaySeconds=o.delaySeconds);const d=this.sendMessage(e,o.payload,o.size,o.attributes,o.messageGroupId,o.messageDeduplicationId,o.systemAttributes);s.delaySeconds=l,d?n.push({id:o.id,messageId:d}):i.push({id:o.id,code:"AWS.SimpleQueueService.InvalidMessageContents",message:"Failed to send message"})}return{successful:n,failed:i}}deleteMessageBatch(e,t){if(!this.queues.get(e))return{successful:[],failed:t.map(o=>({id:o.id,code:"AWS.SimpleQueueService.NonExistentQueue",message:`Queue '${e}' does not exist`}))};if(t.length>10)return{successful:[],failed:t.map(o=>({id:o.id,code:"AWS.SimpleQueueService.TooManyEntriesInBatchRequest",message:"Maximum number of entries per request is 10"}))};const n=[],i=[],a=new Set;for(const o of t){if(a.has(o.id)){i.push({id:o.id,code:"AWS.SimpleQueueService.BatchEntryIdsNotDistinct",message:`Id ${o.id} is duplicated`});continue}a.add(o.id),this.deleteMessage(e,o.receiptHandle)?n.push(o.id):i.push({id:o.id,code:"AWS.SimpleQueueService.ReceiptHandleIsInvalid",message:`Receipt handle '${o.receiptHandle}' is invalid`})}return{successful:n,failed:i}}changeMessageVisibility(e,t,s){if(!this.queues.get(e)||s<0||s>43200)return!1;const i=this.inFlightMessages.get(e)||[],a=i.findIndex(h=>h.message.receiptHandle===t);if(a===-1)return!1;const o=i[a],l=Date.now(),d=s*1e3;return o.visibilityTimeoutExpiresAt=l+d,i[a]=o,this.inFlightMessages.set(e,i),!0}changeMessageVisibilityBatch(e,t){if(!this.queues.get(e))return{successful:[],failed:t.map(o=>({id:o.id,code:"AWS.SimpleQueueService.NonExistentQueue",message:`Queue '${e}' does not exist`}))};if(t.length>10)return{successful:[],failed:t.map(o=>({id:o.id,code:"AWS.SimpleQueueService.TooManyEntriesInBatchRequest",message:"Maximum number of entries per request is 10"}))};const n=[],i=[],a=new Set;for(const o of t){if(a.has(o.id)){i.push({id:o.id,code:"AWS.SimpleQueueService.BatchEntryIdsNotDistinct",message:`Id ${o.id} is duplicated`});continue}if(a.add(o.id),o.visibilityTimeout<0||o.visibilityTimeout>43200){i.push({id:o.id,code:"AWS.SimpleQueueService.InvalidParameterValue",message:"VisibilityTimeout must be between 0 and 43200 seconds"});continue}this.changeMessageVisibility(e,o.receiptHandle,o.visibilityTimeout)?n.push(o.id):i.push({id:o.id,code:"AWS.SimpleQueueService.ReceiptHandleIsInvalid",message:`Receipt handle '${o.receiptHandle}' is invalid`})}return{successful:n,failed:i}}deleteMessage(e,t){const s=this.queues.get(e);if(!s)return!1;const n=this.inFlightMessages.get(e)||[],i=n.findIndex(d=>d.message.receiptHandle===t);if(i===-1)return!1;const a=n[i];n.splice(i,1),this.inFlightMessages.set(e,n);const o=this.queueState.get(e);o&&(o.deletedCount=(o.deletedCount||0)+1,o.lastUpdate=Date.now());const l=this.cloudWatchMetrics.get(e);if(l&&(l.numberOfMessagesDeleted+=1,l.approximateNumberOfMessagesNotVisible=(this.inFlightMessages.get(e)||[]).length,l.timestamp=Date.now()),s.type==="fifo"&&a.message.messageGroupId){const d=this.messageGroups.get(e),h=this.inFlightGroups.get(e);if(d&&h){const p=a.message.messageGroupId,g=d.get(p);(!g||g.length===0)&&h.delete(p)}}return!0}processConsumption(e){const t=Date.now();for(const[s,n]of this.deduplicationIdTimestamps.entries()){const i=this.queues.get(s);if(i&&i.type==="fifo"){const a=this.deduplicationIds.get(s);if(a&&n)for(const[o,l]of n.entries())t-l>=300*1e3&&(a.delete(o),n.delete(o))}}for(const[s,n]of this.queues.entries()){const i=this.inFlightMessages.get(s)||[],a=[],o=[];for(const v of i)if(t>=v.visibilityTimeoutExpiresAt){const b=v.message;b.receiptHandle=void 0,n.maxReceiveCount&&b.receiveCount>=n.maxReceiveCount?this.sendToDLQ(n,b):a.push(b)}else o.push(v);const l=o.filter(v=>!(t>=v.message.retentionExpiresAt));if(this.inFlightMessages.set(s,l),a.length>0){const v=this.queueMessages.get(s)||[];if(n.type==="fifo"){const b=this.messageGroups.get(s);if(b)for(const M of a){const x=M.messageGroupId||"default-group",S=b.get(x)||[];S.push(M),b.set(x,S)}}else v.push(...a);n.type!=="fifo"&&this.queueMessages.set(s,v)}const h=(this.queueMessages.get(s)||[]).filter(v=>!(t>=v.retentionExpiresAt));if(this.queueMessages.set(s,h),n.type==="fifo"){const v=this.messageGroups.get(s);if(v)for(const[b,M]of v.entries()){const x=M.filter(S=>!(t>=S.retentionExpiresAt));x.length===0?v.delete(b):v.set(b,x)}}const p=this.queueState.get(s);if(p){let v=0,b=0;if(n.type==="fifo"){const x=this.messageGroups.get(s);if(x)for(const S of x.values())for(const T of S)t<T.retentionExpiresAt&&(T.delayUntil&&t<T.delayUntil?b++:v++)}else{const x=this.queueMessages.get(s)||[];v=x.filter(S=>t<S.retentionExpiresAt&&(!S.delayUntil||t>=S.delayUntil)).length,b=x.filter(S=>S.delayUntil&&t<S.delayUntil&&t<S.retentionExpiresAt).length}const M=this.inFlightMessages.get(s)||[];p.approximateMessages=v,p.approximateMessagesNotVisible=M.length,p.approximateMessagesDelayed=b,p.lastUpdate=t}const g=this.cloudWatchMetrics.get(s);g&&p&&(g.approximateNumberOfMessagesVisible=p.approximateMessages,g.approximateNumberOfMessagesNotVisible=p.approximateMessagesNotVisible,g.approximateNumberOfMessagesDelayed=p.approximateMessagesDelayed,g.timestamp=t)}}sendToDLQ(e,t){if(!e.deadLetterQueue)if(e.maxReceiveCount){const o=`${e.name}-dlq${e.type==="fifo"?".fifo":""}`;if(!this.queues.has(o)){const l={name:o,type:e.type,region:e.region,visibilityTimeout:e.visibilityTimeout,messageRetention:e.messageRetention,delaySeconds:0,accountId:e.accountId};this.queues.set(o,l),this.queueMessages.set(o,[]),this.inFlightMessages.set(o,[]),this.queueState.set(o,{approximateMessages:0,approximateMessagesNotVisible:0,approximateMessagesDelayed:0,sentCount:0,receivedCount:0,deletedCount:0,dlqCount:0,lastUpdate:Date.now()}),l.type==="fifo"&&(this.messageGroups.set(o,new Map),this.deduplicationIds.set(o,new Set),this.deduplicationIdTimestamps.set(o,new Map),this.inFlightGroups.set(o,new Set)),this.cloudWatchMetrics.set(o,{numberOfMessagesSent:0,numberOfMessagesReceived:0,numberOfMessagesDeleted:0,approximateNumberOfMessagesVisible:0,approximateNumberOfMessagesNotVisible:0,approximateNumberOfMessagesDelayed:0,sentMessageSize:0,receivedMessageSize:0,timestamp:Date.now()})}e.deadLetterQueue=o}else return;if(!this.queues.get(e.deadLetterQueue))return;const n=this.dlqMessages.get(e.deadLetterQueue)||[];n.push(t),this.dlqMessages.set(e.deadLetterQueue,n);const i=this.queueState.get(e.deadLetterQueue);i&&(i.dlqCount=(i.dlqCount||0)+1,i.approximateMessages=n.length);const a=this.queueState.get(e.name);a&&(a.dlqCount=(a.dlqCount||0)+1)}redriveFromDLQ(e,t){if(!this.queues.get(e))return{redriven:0,failed:0};const n=[];for(const d of this.queues.values())d.deadLetterQueue===e&&n.push(d);if(n.length===0)return{redriven:0,failed:0};const i=this.dlqMessages.get(e)||[],a=t?Math.min(t,i.length):i.length;let o=0,l=0;for(let d=0;d<a;d++){const h=i[d];if(!h)continue;const p=n.find(v=>h.queueName===v.name||h.queueName.startsWith(v.name))||n[0];h.receiveCount=0,h.firstReceivedAt=void 0,h.receiptHandle=void 0,h.delayUntil=void 0,this.sendMessage(p.name,h.payload,h.size,h.attributes,h.messageGroupId,h.messageDeduplicationId,h.systemAttributes)?o++:l++}if(o>0){i.splice(0,o),this.dlqMessages.set(e,i);const d=this.queueState.get(e);d&&(d.approximateMessages=i.length)}return{redriven:o,failed:l}}hashString(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t=t&t}return Math.abs(t).toString(36)}getQueueMetrics(e){if(!this.queues.get(e))return null;const s=this.queueState.get(e);return s?{approximateMessages:s.approximateMessages,approximateMessagesNotVisible:s.approximateMessagesNotVisible,approximateMessagesDelayed:s.approximateMessagesDelayed,sentCount:s.sentCount,receivedCount:s.receivedCount,deletedCount:s.deletedCount,dlqCount:s.dlqCount}:null}getAllQueueMetrics(){const e=new Map;for(const t of this.queues.keys()){const s=this.getQueueMetrics(t);s&&e.set(t,s)}return e}getTotalQueueDepth(){let e=0;for(const t of this.queueMessages.values())e+=t.length;for(const t of this.inFlightMessages.values())e+=t.length;return e}getActiveConnections(){let e=0;for(const t of this.queueState.values())(t.sentCount>0||t.receivedCount>0)&&(e+=1);return Math.max(1,e)}updateQueue(e,t){const s=this.queues.get(e);s&&(Object.assign(s,t),this.queues.set(e,s))}getQueueUrl(e){const t=this.queues.get(e);if(!t)return null;const s=t.accountId||"123456789012";return`https://sqs.${t.region}.amazonaws.com/${s}/${e}`}getQueueArn(e){const t=this.queues.get(e);if(!t)return null;const s=t.accountId||"123456789012";return`arn:aws:sqs:${t.region}:${s}:${e}`}getCloudWatchMetrics(e){const t=this.cloudWatchMetrics.get(e);if(!t)return null;const s=t.numberOfMessagesSent,n=s>0?t.sentMessageSize/s:0;return{...t,averageMessageSize:n}}static validateQueueName(e,t){if(!e||e.length<1||e.length>80)return{valid:!1,error:"Queue name must be 1-80 characters"};if(t==="fifo"&&!e.endsWith(".fifo"))return{valid:!1,error:"FIFO queue name must end with .fifo"};if(t==="standard"&&e.endsWith(".fifo"))return{valid:!1,error:"Standard queue name cannot end with .fifo"};const s=/^[a-zA-Z0-9_-]+$/,n=t==="fifo"?e.slice(0,-5):e;return s.test(n)?{valid:!0}:{valid:!1,error:"Queue name can only contain alphanumeric characters, hyphens, and underscores"}}}class zE{queues=new Map;topics=new Map;subscriptions=new Map;queueMessages=new Map;topicMessages=new Map;subscriptionMessages=new Map;lockedMessages=new Map;deadLetterMessages=new Map;scheduledMessages=new Map;sessionMessages=new Map;deferredMessages=new Map;duplicateDetectionWindow=new Map;sequenceNumberCounter=new Map;queueState=new Map;subscriptionState=new Map;initialize(e){if(this.queues.clear(),this.topics.clear(),this.subscriptions.clear(),this.queueMessages.clear(),this.topicMessages.clear(),this.subscriptionMessages.clear(),this.lockedMessages.clear(),this.deadLetterMessages.clear(),this.scheduledMessages.clear(),this.sessionMessages.clear(),this.deferredMessages.clear(),this.duplicateDetectionWindow.clear(),this.sequenceNumberCounter.clear(),this.queueState.clear(),this.subscriptionState.clear(),e.queues)for(const t of e.queues)this.queues.set(t.name,{...t}),this.queueMessages.set(t.name,[]),this.lockedMessages.set(t.name,[]),this.deadLetterMessages.set(t.name,[]),this.scheduledMessages.set(t.name,[]),this.queueState.set(t.name,{activeMessageCount:t.activeMessageCount||0,deadLetterMessageCount:t.deadLetterMessageCount||0,scheduledMessageCount:t.scheduledMessageCount||0,deferredMessageCount:0,duplicateMessagesDetected:0,forwardedMessages:0,sentCount:0,receivedCount:0,completedCount:0,abandonedCount:0,lastUpdate:Date.now()}),t.enableDuplicateDetection&&this.duplicateDetectionWindow.set(t.name,new Map),this.sequenceNumberCounter.set(t.name,1),this.deferredMessages.set(t.name,[]),t.enableSessions&&this.sessionMessages.set(t.name,new Map);if(e.topics){for(const t of e.topics)if(this.topics.set(t.name,{...t}),this.topicMessages.set(t.name,[]),this.scheduledMessages.set(t.name,[]),this.subscriptions.set(t.name,[]),t.enableDuplicateDetection&&this.duplicateDetectionWindow.set(t.name,new Map),this.sequenceNumberCounter.set(t.name,1),t.subscriptions)for(const s of t.subscriptions){const n=this.subscriptions.get(t.name)||[];n.push(s),this.subscriptions.set(t.name,n);const i=`${t.name}/subscriptions/${s.name}`;this.subscriptionMessages.set(i,[]),this.lockedMessages.set(i,[]),this.deadLetterMessages.set(i,[]),this.subscriptionState.set(i,{activeMessageCount:s.activeMessageCount||0,deadLetterMessageCount:0,deferredMessageCount:0,filteredMessages:0,forwardedMessages:0,sentCount:0,receivedCount:0,completedCount:0,abandonedCount:0,lastUpdate:Date.now()}),this.deferredMessages.set(i,[]),this.sessionMessages.set(i,new Map)}}}checkDuplicateMessage(e,t,s){const n=this.duplicateDetectionWindow.get(e);if(!n)return!1;const i=Date.now(),a=s*1e3;for(const[o,l]of n.entries())i-l>a&&n.delete(o);return n.has(t)?!0:(n.set(t,i),!1)}sendToQueue(e,t,s,n,i,a,o){const l=this.queues.get(e);if(!l)return null;const d=Date.now(),h=o||`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,p=o||`${e}-${h}`;if(l.enableDuplicateDetection&&l.duplicateDetectionHistoryTimeWindow&&this.checkDuplicateMessage(e,p,l.duplicateDetectionHistoryTimeWindow)){const T=this.queueState.get(e);return T&&(T.duplicateMessagesDetected=(T.duplicateMessagesDetected||0)+1,T.lastUpdate=d),null}const g=this.sequenceNumberCounter.get(e)||1;this.sequenceNumberCounter.set(e,g+1);const v=l.defaultMessageTimeToLive*1e3,b=d+v,M={id:h,messageId:p,timestamp:d,destination:e,payload:t,size:s,properties:n,sessionId:i,scheduledEnqueueTime:a,expirationTime:b,deliveryCount:0,enqueuedTime:a||d,sequenceNumber:g,isDeferred:!1};if(a&&a>d){const S=this.scheduledMessages.get(e)||[];S.push(M),this.scheduledMessages.set(e,S);const T=this.queueState.get(e);return T&&(T.scheduledMessageCount=S.length),p}if(l.enableSessions&&i){const S=this.sessionMessages.get(e);if(S){const T=S.get(i)||[];T.push(M),S.set(i,T)}}else{const S=this.queueMessages.get(e)||[];S.push(M),this.queueMessages.set(e,S)}const x=this.queueState.get(e);if(x){const S=this.getAvailableMessages(e);x.activeMessageCount=S.length,x.sentCount=(x.sentCount||0)+1,x.lastUpdate=d}return p}forwardMessage(e,t){return this.queues.has(t)?this.sendToQueue(t,e.payload,e.size,e.properties,e.sessionId,e.scheduledEnqueueTime,e.messageId)!==null:this.topics.has(t)?this.publishToTopic(t,e.payload,e.size,e.properties,e.scheduledEnqueueTime,e.messageId).length>0:!1}evaluateSubscriptionRule(e,t){if(e.filterType==="Correlation"){if(e.correlationFilter?.correlationId&&t.properties?.correlationId!==e.correlationFilter.correlationId)return!1;if(e.correlationFilter?.properties){for(const[s,n]of Object.entries(e.correlationFilter.properties))if(t.properties?.[s]!==n)return!1}return!0}return e.filterType==="SQL"&&e.sqlFilter?this.evaluateSqlFilter(e.sqlFilter,t.properties||{}):!0}evaluateSqlFilter(e,t){try{const n=e.trim().toLowerCase().split(" and ");for(const i of n){const a=i.split(" or ");let o=!1;for(const l of a){const d=l.trim();if(d.includes(" = ")){const[h,p]=d.split(" = ").map(M=>M.trim()),g=h.replace(/\[|\]/g,""),v=p.replace(/'/g,"");if(String(t[g]||"").toLowerCase()===v.toLowerCase()){o=!0;break}}else if(d.includes(" != ")){const[h,p]=d.split(" != ").map(M=>M.trim()),g=h.replace(/\[|\]/g,""),v=p.replace(/'/g,"");if(String(t[g]||"").toLowerCase()!==v.toLowerCase()){o=!0;break}}else if(d.includes(" > ")){const[h,p]=d.split(" > ").map(M=>M.trim()),g=h.replace(/\[|\]/g,""),v=parseFloat(p),b=parseFloat(String(t[g]||0));if(!isNaN(b)&&!isNaN(v)&&b>v){o=!0;break}}else if(d.includes(" < ")){const[h,p]=d.split(" < ").map(M=>M.trim()),g=h.replace(/\[|\]/g,""),v=parseFloat(p),b=parseFloat(String(t[g]||0));if(!isNaN(b)&&!isNaN(v)&&b<v){o=!0;break}}else if(d.includes(" like ")){const[h,p]=d.split(" like ").map(x=>x.trim()),g=h.replace(/\[|\]/g,""),v=p.replace(/'/g,"").replace(/%/g,".*"),b=String(t[g]||"");if(new RegExp(v,"i").test(b)){o=!0;break}}}if(!o)return!1}return!0}catch(s){return console.warn("SQL filter evaluation error:",s),!0}}publishToTopic(e,t,s,n,i,a){const o=this.topics.get(e);if(!o)return[];const l=Date.now(),d=a||`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,h=a||`${e}-${d}`;if(o.enableDuplicateDetection&&o.duplicateDetectionHistoryTimeWindow&&this.checkDuplicateMessage(e,h,o.duplicateDetectionHistoryTimeWindow))return[];const p=this.sequenceNumberCounter.get(e)||1;this.sequenceNumberCounter.set(e,p+1);const g=o.defaultMessageTimeToLive*1e3,v=l+g,b={id:d,messageId:h,timestamp:l,destination:e,payload:t,size:s,properties:n,scheduledEnqueueTime:i,expirationTime:v,deliveryCount:0,enqueuedTime:i||l,sequenceNumber:p,isDeferred:!1},M=[];if(i&&i>l){const S=this.scheduledMessages.get(e)||[];return S.push(b),this.scheduledMessages.set(e,S),[h]}const x=this.subscriptions.get(e)||[];if(x.length===0)return[];for(const S of x){const T=`${e}/subscriptions/${S.name}`;let E=!0;if(S.rules&&S.rules.length>0){E=!1;for(const L of S.rules)if(this.evaluateSubscriptionRule(L,b)){E=!0;break}if(!E){const L=this.subscriptionState.get(T);L&&(L.filteredMessages=(L.filteredMessages||0)+1,L.lastUpdate=l);continue}}const A=this.subscriptionMessages.get(T)||[],k={...b,id:`${d}-${S.name}`,messageId:`${h}-${S.name}`,subscriptionName:S.name};A.push(k),this.subscriptionMessages.set(T,A),M.push(k.messageId);const D=this.subscriptionState.get(T);if(D){const L=this.getAvailableSubscriptionMessages(T);D.activeMessageCount=L.length,D.sentCount=(D.sentCount||0)+1,D.lastUpdate=l}}return M}receiveFromQueue(e,t,s){const n=this.queues.get(e);if(!n)return null;const i=Date.now(),a=(t||n.lockDuration)*1e3,o=i+a;let l;if(n.enableSessions&&s){const g=this.sessionMessages.get(e);if(!g)return null;l=g.get(s)||[]}else l=this.getAvailableMessages(e);if(l.length===0)return null;const d=l.shift();d.deliveryCount=(d.deliveryCount||0)+1,d.lockedUntil=o,d.lockToken=`lock_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;const h=this.lockedMessages.get(e)||[];if(h.push({message:d,lockedAt:i,lockExpiresAt:o}),this.lockedMessages.set(e,h),n.enableSessions&&s){const g=this.sessionMessages.get(e);if(g){const v=g.get(s)||[],b=v.findIndex(M=>M.id===d.id);b>=0&&(v.splice(b,1),g.set(s,v))}}const p=this.queueState.get(e);if(p){const g=this.getAvailableMessages(e);p.activeMessageCount=g.length,p.receivedCount=(p.receivedCount||0)+1,p.lastUpdate=i}return d}deferMessage(e,t){const s=this.lockedMessages.get(e)||[],n=s.findIndex(d=>d.message.lockToken===t);if(n<0)return!1;const i=s[n];s.splice(n,1),this.lockedMessages.set(e,s);const a=i.message;a.lockToken=void 0,a.lockedUntil=void 0,a.isDeferred=!0;const o=this.deferredMessages.get(e)||[];if(o.push(a),this.deferredMessages.set(e,o),this.queues.has(e)){const d=this.queueState.get(e);d&&(d.deferredMessageCount=o.length,d.lastUpdate=Date.now())}else{const d=this.subscriptionState.get(e);d&&(d.deferredMessageCount=o.length,d.lastUpdate=Date.now())}return!0}receiveDeferredMessages(e,t,s){const n=this.deferredMessages.get(e)||[],i=[],a=Date.now();let o=30*1e3;if(this.queues.has(e)){const h=this.queues.get(e);o=(s||h?.lockDuration||30)*1e3}else{const h=e.split("/subscriptions/");if(h.length===2){const p=h[0],g=h[1],v=this.subscriptions.get(p)?.find(b=>b.name===g);v&&(o=(s||v.lockDuration||30)*1e3)}}const l=a+o;for(let h=n.length-1;h>=0;h--){const p=n[h];if(p.sequenceNumber&&t.includes(p.sequenceNumber)){n.splice(h,1),p.lockToken=`lock_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,p.lockedUntil=l,p.isDeferred=!1,p.deliveryCount=(p.deliveryCount||0)+1;const g=this.lockedMessages.get(e)||[];g.push({message:p,lockedAt:a,lockExpiresAt:l}),this.lockedMessages.set(e,g),i.push(p)}}if(this.deferredMessages.set(e,n),this.queues.has(e)){const h=this.queueState.get(e);h&&(h.deferredMessageCount=n.length,h.receivedCount=(h.receivedCount||0)+i.length,h.lastUpdate=a)}else{const h=this.subscriptionState.get(e);h&&(h.deferredMessageCount=n.length,h.receivedCount=(h.receivedCount||0)+i.length,h.lastUpdate=a)}return i}completeDeferredMessage(e,t){const s=this.lockedMessages.get(e)||[],n=s.findIndex(a=>a.message.sequenceNumber===t);if(n<0)return!1;if(s.splice(n,1),this.lockedMessages.set(e,s),this.queues.has(e)){const a=this.queueState.get(e);a&&(a.completedCount=(a.completedCount||0)+1,a.lastUpdate=Date.now())}else{const a=this.subscriptionState.get(e);a&&(a.completedCount=(a.completedCount||0)+1,a.lastUpdate=Date.now())}return!0}receiveFromSubscription(e,t,s){const n=`${e}/subscriptions/${t}`,i=this.getAvailableSubscriptionMessages(n);if(i.length===0)return null;const a=this.subscriptions.get(e)?.find(v=>v.name===t);if(!a)return null;const o=Date.now(),l=(s||a.lockDuration)*1e3,d=o+l,h=i.shift();h.deliveryCount=(h.deliveryCount||0)+1,h.lockedUntil=d,h.lockToken=`lock_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;const p=this.lockedMessages.get(n)||[];p.push({message:h,lockedAt:o,lockExpiresAt:d}),this.lockedMessages.set(n,p);const g=this.subscriptionState.get(n);if(g){const v=this.getAvailableSubscriptionMessages(n);g.activeMessageCount=v.length,g.receivedCount=(g.receivedCount||0)+1,g.lastUpdate=o}return h}completeMessage(e,t){const s=this.lockedMessages.get(e)||[],n=s.findIndex(d=>d.message.lockToken===t);if(n<0)return!1;const a=s[n].message;s.splice(n,1),this.lockedMessages.set(e,s);const o=this.queues.has(e);let l=!1;if(o){const d=this.queues.get(e);if(d?.forwardTo){l=this.forwardMessage(a,d.forwardTo);const h=this.queueState.get(e);h&&l&&(h.forwardedMessages=(h.forwardedMessages||0)+1)}}else{const d=e.split("/subscriptions/");if(d.length===2){const h=d[0],p=d[1],g=this.subscriptions.get(h)?.find(v=>v.name===p);if(g?.forwardTo){l=this.forwardMessage(a,g.forwardTo);const v=this.subscriptionState.get(e);v&&l&&(v.forwardedMessages=(v.forwardedMessages||0)+1)}}}if(o){const d=this.queueState.get(e);d&&(d.completedCount=(d.completedCount||0)+1,d.lastUpdate=Date.now())}else{const d=this.subscriptionState.get(e);d&&(d.completedCount=(d.completedCount||0)+1,d.lastUpdate=Date.now())}return!0}abandonMessage(e,t){const s=this.lockedMessages.get(e)||[],n=s.findIndex(d=>d.message.lockToken===t);if(n<0)return!1;const i=s[n];s.splice(n,1),this.lockedMessages.set(e,s);const a=i.message;a.lockToken=void 0,a.lockedUntil=void 0;const o=this.queues.has(e),l=o?this.queues.get(e)?.maxDeliveryCount||10:this.subscriptions.get(a.destination)?.find(d=>d.name===a.subscriptionName)?.maxDeliveryCount||10;if(a.deliveryCount>=l){const d=this.deadLetterMessages.get(e)||[];if(d.push(a),this.deadLetterMessages.set(e,d),o){const h=this.queueState.get(e);h&&(h.deadLetterMessageCount=d.length,h.abandonedCount=(h.abandonedCount||0)+1,h.lastUpdate=Date.now())}else{const h=this.subscriptionState.get(e);h&&(h.deadLetterMessageCount=d.length,h.abandonedCount=(h.abandonedCount||0)+1,h.lastUpdate=Date.now())}}else{if(o){const d=this.queues.get(e);if(d)if(d.enableSessions&&a.sessionId){const h=this.sessionMessages.get(e);if(h){const p=h.get(a.sessionId)||[];p.push(a),h.set(a.sessionId,p)}}else{const h=this.queueMessages.get(e)||[];h.push(a),this.queueMessages.set(e,h)}}else{const d=this.subscriptionMessages.get(e)||[];d.push(a),this.subscriptionMessages.set(e,d)}if(o){const d=this.queueState.get(e);if(d){const h=this.getAvailableMessages(e);d.activeMessageCount=h.length,d.abandonedCount=(d.abandonedCount||0)+1,d.lastUpdate=Date.now()}}else{const d=this.subscriptionState.get(e);if(d){const h=this.getAvailableSubscriptionMessages(e);d.activeMessageCount=h.length,d.abandonedCount=(d.abandonedCount||0)+1,d.lastUpdate=Date.now()}}}return!0}processConsumption(e){const t=Date.now();for(const[s,n]of this.queues.entries()){const i=this.scheduledMessages.get(s)||[],a=this.queueMessages.get(s)||[],o=this.sessionMessages.get(s);for(let p=i.length-1;p>=0;p--){const g=i[p];if(g.scheduledEnqueueTime&&g.scheduledEnqueueTime<=t)if(i.splice(p,1),n.enableSessions&&g.sessionId&&o){const v=o.get(g.sessionId)||[];v.push(g),o.set(g.sessionId,v)}else a.push(g)}this.scheduledMessages.set(s,i),this.queueMessages.set(s,a);const l=this.lockedMessages.get(s)||[];for(let p=l.length-1;p>=0;p--){const g=l[p];g.lockExpiresAt<=t&&(l.splice(p,1),this.abandonMessage(s,g.message.lockToken))}this.lockedMessages.set(s,l);const d=this.getAvailableMessages(s);for(let p=d.length-1;p>=0;p--){const g=d[p];if(g.expirationTime<=t&&(d.splice(p,1),n.enableDeadLetteringOnMessageExpiration)){const v=this.deadLetterMessages.get(s)||[];v.push(g),this.deadLetterMessages.set(s,v)}}this.queueMessages.set(s,d);const h=this.queueState.get(s);h&&(h.activeMessageCount=this.getAvailableMessages(s).length,h.deadLetterMessageCount=(this.deadLetterMessages.get(s)||[]).length,h.scheduledMessageCount=i.length,h.deferredMessageCount=(this.deferredMessages.get(s)||[]).length,h.lastUpdate=t)}for(const[s,n]of this.topics.entries()){const i=this.scheduledMessages.get(s)||[];for(let o=i.length-1;o>=0;o--){const l=i[o];l.scheduledEnqueueTime&&l.scheduledEnqueueTime<=t&&(i.splice(o,1),this.publishToTopic(s,l.payload,l.size,l.properties))}this.scheduledMessages.set(s,i);const a=this.subscriptions.get(s)||[];for(const o of a){const l=`${s}/subscriptions/${o.name}`,d=this.lockedMessages.get(l)||[];for(let g=d.length-1;g>=0;g--){const v=d[g];v.lockExpiresAt<=t&&(d.splice(g,1),this.abandonMessage(l,v.message.lockToken))}this.lockedMessages.set(l,d);const h=this.getAvailableSubscriptionMessages(l);for(let g=h.length-1;g>=0;g--){const v=h[g];if(v.expirationTime<=t&&(h.splice(g,1),o.enableDeadLetteringOnMessageExpiration)){const b=this.deadLetterMessages.get(l)||[];b.push(v),this.deadLetterMessages.set(l,b)}}this.subscriptionMessages.set(l,h);const p=this.subscriptionState.get(l);p&&(p.activeMessageCount=this.getAvailableSubscriptionMessages(l).length,p.deadLetterMessageCount=(this.deadLetterMessages.get(l)||[]).length,p.deferredMessageCount=(this.deferredMessages.get(l)||[]).length,p.lastUpdate=t)}}}getAvailableMessages(e){if(!this.queues.get(e))return[];const s=Date.now();return(this.queueMessages.get(e)||[]).filter(i=>i.expirationTime>s)}getAvailableSubscriptionMessages(e){const t=Date.now();return(this.subscriptionMessages.get(e)||[]).filter(n=>n.expirationTime>t)}getTotalQueueDepth(){let e=0;for(const t of this.queues.keys())e+=this.getAvailableMessages(t).length;return e}getTotalSubscriptionMessages(){let e=0;for(const t of this.subscriptionMessages.keys())e+=this.getAvailableSubscriptionMessages(t).length;return e}getQueueMetrics(e){const t=this.queueState.get(e);return t?{activeMessageCount:t.activeMessageCount,deadLetterMessageCount:t.deadLetterMessageCount,scheduledMessageCount:t.scheduledMessageCount,deferredMessageCount:t.deferredMessageCount||0,duplicateMessagesDetected:t.duplicateMessagesDetected||0,forwardedMessages:t.forwardedMessages||0,sentCount:t.sentCount,receivedCount:t.receivedCount,completedCount:t.completedCount,abandonedCount:t.abandonedCount}:null}getSubscriptionMetrics(e,t){const s=`${e}/subscriptions/${t}`,n=this.subscriptionState.get(s);return n?{activeMessageCount:n.activeMessageCount,deadLetterMessageCount:n.deadLetterMessageCount,deferredMessageCount:n.deferredMessageCount||0,filteredMessages:n.filteredMessages||0,forwardedMessages:n.forwardedMessages||0,sentCount:n.sentCount,receivedCount:n.receivedCount,completedCount:n.completedCount,abandonedCount:n.abandonedCount}:null}getAllQueueMetrics(){const e=new Map;for(const t of this.queues.keys()){const s=this.getQueueMetrics(t);s&&e.set(t,s)}return e}getAllSubscriptionMetrics(){const e=new Map;for(const[t,s]of this.subscriptionState.entries())e.set(t,{activeMessageCount:s.activeMessageCount,deadLetterMessageCount:s.deadLetterMessageCount,deferredMessageCount:s.deferredMessageCount||0,filteredMessages:s.filteredMessages||0,forwardedMessages:s.forwardedMessages||0,sentCount:s.sentCount,receivedCount:s.receivedCount,completedCount:s.completedCount,abandonedCount:s.abandonedCount});return e}getActiveConnections(){return this.queues.size+this.topics.size}peekQueueMessages(e,t=10){return this.getAvailableMessages(e).slice(0,t)}peekSubscriptionMessages(e,t,s=10){const n=`${e}/subscriptions/${t}`;return this.getAvailableSubscriptionMessages(n).slice(0,s)}getLockedQueueMessages(e){return(this.lockedMessages.get(e)||[]).map(s=>s.message)}getLockedSubscriptionMessages(e,t){const s=`${e}/subscriptions/${t}`;return(this.lockedMessages.get(s)||[]).map(i=>i.message)}getDeadLetterQueueMessages(e){return this.deadLetterMessages.get(e)||[]}getDeadLetterSubscriptionMessages(e,t){const s=`${e}/subscriptions/${t}`;return this.deadLetterMessages.get(s)||[]}getDeferredQueueMessages(e){return this.deferredMessages.get(e)||[]}getDeferredSubscriptionMessages(e,t){const s=`${e}/subscriptions/${t}`;return this.deferredMessages.get(s)||[]}getScheduledQueueMessages(e){return this.scheduledMessages.get(e)||[]}getScheduledTopicMessages(e){return this.scheduledMessages.get(e)||[]}resubmitMessage(e,t){const s=this.queues.has(e),n=this.deadLetterMessages.get(e)||[],i=n.findIndex(o=>o.id===t||o.messageId===t);if(i<0)return!1;const a=n[i];if(n.splice(i,1),this.deadLetterMessages.set(e,n),a.deliveryCount=0,a.lockToken=void 0,a.lockedUntil=void 0,a.isDeferred=!1,s){const o=this.queueMessages.get(e)||[];o.push(a),this.queueMessages.set(e,o)}else{const o=this.subscriptionMessages.get(e)||[];o.push(a),this.subscriptionMessages.set(e,o)}if(s){const o=this.queueState.get(e);o&&(o.deadLetterMessageCount=n.length,o.activeMessageCount=this.getAvailableMessages(e).length,o.lastUpdate=Date.now())}else{const o=this.subscriptionState.get(e);o&&(o.deadLetterMessageCount=n.length,o.activeMessageCount=this.getAvailableSubscriptionMessages(e).length,o.lastUpdate=Date.now())}return!0}deleteDeadLetterMessage(e,t){const s=this.deadLetterMessages.get(e)||[],n=s.findIndex(a=>a.id===t||a.messageId===t);if(n<0)return!1;if(s.splice(n,1),this.deadLetterMessages.set(e,s),this.queues.has(e)){const a=this.queueState.get(e);a&&(a.deadLetterMessageCount=s.length,a.lastUpdate=Date.now())}else{const a=this.subscriptionState.get(e);a&&(a.deadLetterMessageCount=s.length,a.lastUpdate=Date.now())}return!0}sendToDeadLetter(e,t){const s=this.lockedMessages.get(e)||[],n=s.findIndex(d=>d.message.lockToken===t);if(n<0)return!1;const i=s[n];s.splice(n,1),this.lockedMessages.set(e,s);const a=i.message;a.lockToken=void 0,a.lockedUntil=void 0;const o=this.deadLetterMessages.get(e)||[];if(o.push(a),this.deadLetterMessages.set(e,o),this.queues.has(e)){const d=this.queueState.get(e);d&&(d.deadLetterMessageCount=o.length,d.lastUpdate=Date.now())}else{const d=this.subscriptionState.get(e);d&&(d.deadLetterMessageCount=o.length,d.lastUpdate=Date.now())}return!0}}class jE{topics=new Map;subscriptions=new Map;topicSubscriptions=new Map;topicMessages=new Map;subscriptionMessages=new Map;unackedMessages=new Map;orderingKeyQueues=new Map;topicState=new Map;subscriptionState=new Map;initialize(e){if(this.topics.clear(),this.subscriptions.clear(),this.topicSubscriptions.clear(),this.topicMessages.clear(),this.subscriptionMessages.clear(),this.unackedMessages.clear(),this.orderingKeyQueues.clear(),this.topicState.clear(),this.subscriptionState.clear(),e.topics)for(const t of e.topics)this.topics.set(t.name,{...t}),this.topicMessages.set(t.name,[]),this.topicSubscriptions.set(t.name,[]),this.orderingKeyQueues.set(t.name,new Map),this.topicState.set(t.name,{messageCount:t.messageCount||0,byteCount:t.byteCount||0,publishedCount:0,validationErrorCount:0,lastUpdate:Date.now()});if(e.subscriptions)for(const t of e.subscriptions){this.subscriptions.set(t.name,{...t}),this.subscriptionMessages.set(t.name,[]),this.unackedMessages.set(t.name,[]);const s=this.topicSubscriptions.get(t.topic)||[];s.includes(t.name)||s.push(t.name),this.topicSubscriptions.set(t.topic,s),this.subscriptionState.set(t.name,{messageCount:t.messageCount||0,unackedMessageCount:t.unackedMessageCount||0,deliveredCount:0,acknowledgedCount:0,nackedCount:0,deadLetterCount:0,pushDeliverySuccessCount:0,pushDeliveryFailureCount:0,expiredAckDeadlines:0,totalDeliveryAttempts:0,messagesWithAttempts:0,lastUpdate:Date.now(),lastActivity:Date.now(),deliveredMessageIds:new Set})}}validateMessageAgainstSchema(e,t){if(!e.schema||!e.schema.definition)return!0;const s=e.schema.type,n=e.schema.definition;try{switch(s){case"JSON":{if(typeof t!="object"||t===null)return!1;try{const i=JSON.parse(n);return!(i.type&&typeof t!==i.type)}catch{return!0}}case"AVRO":{if(typeof t!="object"||t===null)return!1;try{const i=JSON.parse(n);return i.type==="record"&&Array.isArray(i.fields)?typeof t=="object"&&t!==null:!0}catch{return!0}}case"PROTOCOL_BUFFER":return typeof t!="object"||t===null?!1:typeof t=="object"&&t!==null;default:return!0}}catch{return!1}}publishToTopic(e,t,s,n,i){const a=this.topics.get(e);if(!a)return null;const o=this.validateMessageAgainstSchema(a,t),l=this.topicState.get(e);if(!o)return l&&(l.validationErrorCount=(l.validationErrorCount||0)+1,l.lastUpdate=Date.now()),null;const d=Date.now(),h=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,p=d,g={id:`pubsub_${h}`,messageId:h,publishTime:p,data:t,attributes:n,orderingKey:i,size:s},v=this.topicMessages.get(e)||[];if(i){const x=this.orderingKeyQueues.get(e)||new Map,S=x.get(i)||[];S.push(g),x.set(i,S),this.orderingKeyQueues.set(e,x)}else v.push(g),this.topicMessages.set(e,v);const b=this.topicSubscriptions.get(e)||[];for(const x of b){const S=this.subscriptions.get(x);if(!S)continue;const T={...g,id:`${g.id}_${x}`},E=this.subscriptionMessages.get(x)||[];S.enableMessageOrdering,E.push(T),this.subscriptionMessages.set(x,E)}const M=l||{messageCount:0,byteCount:0,publishedCount:0,validationErrorCount:0,lastUpdate:d};return M.messageCount=v.length+(i&&this.orderingKeyQueues.get(e)?.get(i)?.length||0),M.byteCount=(M.byteCount||0)+s,M.publishedCount=(M.publishedCount||0)+1,M.lastUpdate=d,this.topicState.set(e,M),h}pullFromSubscription(e,t=100){const s=this.subscriptions.get(e);if(!s)return[];const n=this.subscriptionMessages.get(e)||[];if(n.length===0)return[];const i=this.unackedMessages.get(e)||[],a=s.flowControl||{},o=a.maxOutstandingMessages??1e3,l=a.maxOutstandingBytes??0,d=i.length;let h=0;for(const A of i)h+=A.message.size||0;if(o>0&&d>=o)return[];if(l>0&&h>=l)return[];const p=Date.now(),g=s.ackDeadlineSeconds*1e3,v=[],b=[],M=this.subscriptionState.get(e),x=s.enableExactlyOnceDelivery||!1,S=M?.deliveredMessageIds||new Set;if(s.enableMessageOrdering){const A=new Map;for(const k of n){const D=k.orderingKey||"__no_key__";A.has(D)||A.set(D,[]),A.get(D).push(k)}for(const[k,D]of A.entries()){if(v.length>=t)break;const L=x?D.filter(Q=>!S.has(Q.messageId)):D;let I=Math.min(L.length,t-v.length);if(o>0){const Q=o-d;I=Math.min(I,Q)}if(l>0&&I>0){let Q=l-h,se=0,F=0;for(const Y of L){const ae=Y.size||0;if(se+ae<=Q&&F<I)se+=ae,F++;else break}I=F}if(I<=0)break;const U=L.splice(0,I);for(const Q of U){const se=D.indexOf(Q);se!==-1&&D.splice(se,1)}v.push(...U),b.push(...D)}for(const[k,D]of A.entries())D.length>0&&b.find(L=>(L.orderingKey||"__no_key__")===k)===void 0&&b.push(...D)}else{const A=x?n.filter(L=>!S.has(L.messageId)):n;let k=Math.min(A.length,t);if(o>0){const L=o-d;k=Math.min(k,L)}if(l>0&&k>0){let L=l-h,I=0,U=0;for(const Q of A){const se=Q.size||0;if(I+se<=L&&U<k)I+=se,U++;else break}k=U}if(k<=0)return[];const D=A.splice(0,k);for(const L of D){const I=n.indexOf(L);I!==-1&&n.splice(I,1)}v.push(...D),b.push(...n)}this.subscriptionMessages.set(e,b);const T=this.subscriptionState.get(e);for(const A of v){const k=`ack_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;A.ackId=k,x&&T&&T.deliveredMessageIds.add(A.messageId),i.push({message:A,subscriptionName:e,ackDeadlineExpiresAt:p+g,deliveryAttempt:1,orderingKey:A.orderingKey})}this.unackedMessages.set(e,i);const E=T||{messageCount:0,unackedMessageCount:0,deliveredCount:0,acknowledgedCount:0,nackedCount:0,lastUpdate:p,lastActivity:p,deliveredMessageIds:new Set};return E.messageCount=b.length,E.unackedMessageCount=i.length,E.deliveredCount=(E.deliveredCount||0)+v.length,E.lastUpdate=p,E.lastActivity=p,this.subscriptionState.set(e,E),v}ackMessage(e,t){if(!this.subscriptions.get(e))return!1;const n=this.unackedMessages.get(e)||[],i=n.length;let a=null;const o=n.filter(l=>l.message.ackId===t?(a=l,!1):!0);if(this.unackedMessages.set(e,o),o.length<i&&a){const l=this.subscriptionState.get(e);return l&&(l.unackedMessageCount=o.length,l.acknowledgedCount=(l.acknowledgedCount||0)+1,l.lastUpdate=Date.now(),l.lastActivity=Date.now()),!0}return!1}nackMessage(e,t){if(!this.subscriptions.get(e))return!1;const n=this.unackedMessages.get(e)||[],i=n.findIndex(h=>h.message.ackId===t);if(i===-1)return!1;const o=n[i].message;n.splice(i,1),this.unackedMessages.set(e,n);const l=this.subscriptionMessages.get(e)||[];o.ackId=void 0,l.push(o),this.subscriptionMessages.set(e,l);const d=this.subscriptionState.get(e);return d&&(d.unackedMessageCount=n.length,d.messageCount=l.length,d.nackedCount=(d.nackedCount||0)+1,d.lastUpdate=Date.now(),d.lastActivity=Date.now()),!0}processConsumption(e){const t=Date.now();for(const[s,n]of this.unackedMessages.entries()){if(!this.subscriptions.get(s))continue;const a=[],o=[];for(const l of n)t>=l.ackDeadlineExpiresAt?a.push(l):o.push(l);if(a.length>0){const l=this.subscriptionMessages.get(s)||[];for(const h of a){const p=h.message;p.ackId=void 0,l.push(p)}this.subscriptionMessages.set(s,l);const d=this.subscriptionState.get(s);d&&(d.unackedMessageCount=o.length,d.messageCount=l.length,d.expiredAckDeadlines=(d.expiredAckDeadlines||0)+a.length,d.lastActivity=t)}this.unackedMessages.set(s,o)}for(const[s,n]of this.subscriptions.entries())if(n.pushEndpoint){const i=this.subscriptionMessages.get(s)||[];if(i.length>0){const d=Math.min(i.length,10),h=i.splice(0,d),p=this.unackedMessages.get(s)||[],g=Date.now(),v=n.ackDeadlineSeconds*1e3,b=n.maxDeliveryAttempts||5,M=(n.retryPolicy?.minimumBackoff||10)*1e3,x=(n.retryPolicy?.maximumBackoff||600)*1e3,S=n.enableExactlyOnceDelivery||!1,T=this.subscriptionState.get(s),E=T?.deliveredMessageIds||new Set;for(const k of h){if(S&&E.has(k.messageId))continue;const D=Math.random();let L;D<.9?L=200:D<.95?L=400+Math.floor(Math.random()*100):L=500+Math.floor(Math.random()*100);const I=`ack_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;if(k.ackId=I,L>=200&&L<300)S&&T&&T.deliveredMessageIds.add(k.messageId),p.push({message:k,subscriptionName:s,ackDeadlineExpiresAt:g+v,deliveryAttempt:1,orderingKey:k.orderingKey,lastPushResponse:L}),T&&(T.pushDeliverySuccessCount=(T.pushDeliverySuccessCount||0)+1,T.totalDeliveryAttempts=(T.totalDeliveryAttempts||0)+1,T.messagesWithAttempts=(T.messagesWithAttempts||0)+1,T.lastActivity=g);else{const Q=Math.min(M*Math.pow(2,0),x),se=g+Q;if(1<b)p.push({message:k,subscriptionName:s,ackDeadlineExpiresAt:g+v,deliveryAttempt:1,orderingKey:k.orderingKey,nextRetryAt:se,lastPushResponse:L});else{if(n.deadLetterTopic){if(this.topics.get(n.deadLetterTopic)){this.publishToTopic(n.deadLetterTopic,k.data,k.size,{...k.attributes,"original-subscription":s,"delivery-attempts":"1","last-error":`HTTP ${L}`},k.orderingKey);const ae=this.subscriptionState.get(s);ae&&(ae.deadLetterCount=(ae.deadLetterCount||0)+1)}}else i.push(k);const F=this.subscriptionState.get(s);F&&(F.pushDeliveryFailureCount=(F.pushDeliveryFailureCount||0)+1,F.totalDeliveryAttempts=(F.totalDeliveryAttempts||0)+1,F.messagesWithAttempts=(F.messagesWithAttempts||0)+1)}}}this.subscriptionMessages.set(s,i),this.unackedMessages.set(s,p);const A=this.subscriptionState.get(s);A&&(A.messageCount=i.length,A.unackedMessageCount=p.length,A.deliveredCount=(A.deliveredCount||0)+h.length,A.lastActivity=g)}const a=this.unackedMessages.get(s)||[],o=[];for(const l of a)if(l.nextRetryAt&&t>=l.nextRetryAt){const d=l.deliveryAttempt+1,h=Math.random();let p;const g=.85+d*.02;if(h<g?(p=200,l.nextRetryAt=void 0,l.lastPushResponse=p,o.push(l)):h<g+.1?p=400+Math.floor(Math.random()*100):p=500+Math.floor(Math.random()*100),p>=200&&p<300){l.deliveryAttempt=d,o.push(l);const v=this.subscriptionState.get(s);v&&(v.pushDeliverySuccessCount=(v.pushDeliverySuccessCount||0)+1,v.totalDeliveryAttempts=(v.totalDeliveryAttempts||0)+d,l.nextRetryAt||(v.messagesWithAttempts=(v.messagesWithAttempts||0)+1))}else if(d>=maxDeliveryAttempts){if(n.deadLetterTopic){if(this.topics.get(n.deadLetterTopic)){this.publishToTopic(n.deadLetterTopic,l.message.data,l.message.size,{...l.message.attributes,"original-subscription":s,"delivery-attempts":d.toString(),"last-error":`HTTP ${p}`},l.message.orderingKey);const M=this.subscriptionState.get(s);M&&(M.deadLetterCount=(M.deadLetterCount||0)+1)}}else{const b=this.subscriptionMessages.get(s)||[];l.message.ackId=void 0,b.push(l.message),this.subscriptionMessages.set(s,b)}const v=this.subscriptionState.get(s);v&&(v.pushDeliveryFailureCount=(v.pushDeliveryFailureCount||0)+1,v.totalDeliveryAttempts=(v.totalDeliveryAttempts||0)+d,v.messagesWithAttempts=(v.messagesWithAttempts||0)+1)}else{const v=Math.min(minBackoff*Math.pow(2,d-1),maxBackoff);l.deliveryAttempt=d,l.nextRetryAt=t+v,l.lastPushResponse=p,o.push(l);const b=this.subscriptionState.get(s);b&&(b.pushDeliveryFailureCount=(b.pushDeliveryFailureCount||0)+1,b.totalDeliveryAttempts=(b.totalDeliveryAttempts||0)+d)}}else o.push(l);this.unackedMessages.set(s,o)}for(const[s,n]of this.subscriptions.entries())if(n.expirationPolicy?.ttl){const i=this.subscriptionState.get(s);i&&i.lastActivity&&(t-i.lastActivity,n.expirationPolicy.ttl*1e3)}for(const[s,n]of this.topics.entries()){const a=(n.messageRetentionDuration||604800)*1e3,o=this.topicMessages.get(s)||[],l=o.filter(d=>t-d.publishTime<a);if(l.length<o.length){o.length-l.length,this.topicMessages.set(s,l);const d=this.topicState.get(s);d&&(d.messageCount=l.length)}}}formatPushPayload(e,t){if((t.payloadFormat||"WRAPPED")==="UNWRAPPED")return e.data;const n={message:{data:typeof e.data=="string"?e.data:JSON.stringify(e.data),messageId:e.messageId,publishTime:new Date(e.publishTime).toISOString()},subscription:`projects/${t.projectId}/subscriptions/${t.name}`};return e.attributes&&Object.keys(e.attributes).length>0&&(n.message.attributes=e.attributes),e.orderingKey&&(n.message.orderingKey=e.orderingKey),n}getFormattedPushPayload(e,t){const s=this.subscriptions.get(e);return s?this.formatPushPayload(t,s):null}getTopicMetrics(e){if(!this.topics.get(e))return null;const s=this.topicState.get(e);return s?{messageCount:s.messageCount,byteCount:s.byteCount,publishedCount:s.publishedCount,validationErrorCount:s.validationErrorCount||0}:null}getSubscriptionMetrics(e){if(!this.subscriptions.get(e))return null;const s=this.subscriptionState.get(e);if(!s)return null;const n=(s.pushDeliverySuccessCount||0)+(s.pushDeliveryFailureCount||0),i=n>0?(s.pushDeliverySuccessCount||0)/n:0,a=(s.messagesWithAttempts||0)>0?(s.totalDeliveryAttempts||0)/(s.messagesWithAttempts||1):0;return{messageCount:s.messageCount,unackedMessageCount:s.unackedMessageCount,deliveredCount:s.deliveredCount,acknowledgedCount:s.acknowledgedCount,nackedCount:s.nackedCount,deadLetterCount:s.deadLetterCount||0,pushDeliverySuccessRate:i,expiredAckDeadlines:s.expiredAckDeadlines||0,avgDeliveryAttempts:a}}getAllTopicMetrics(){const e=new Map;for(const t of this.topics.keys()){const s=this.getTopicMetrics(t);s&&e.set(t,s)}return e}getAllSubscriptionMetrics(){const e=new Map;for(const t of this.subscriptions.keys()){const s=this.getSubscriptionMetrics(t);s&&e.set(t,s)}return e}getTotalTopicMessages(){let e=0;for(const t of this.topicMessages.values())e+=t.length;for(const t of this.orderingKeyQueues.values())for(const s of t.values())e+=s.length;return e}getTotalUnackedMessages(){let e=0;for(const t of this.unackedMessages.values())e+=t.length;return e}getActiveConnections(){let e=0;for(const t of this.subscriptions.values())t.pushEndpoint,e+=1;return Math.max(1,e+1)}updateTopic(e,t){const s=this.topics.get(e);s&&(Object.assign(s,t),this.topics.set(e,s))}updateSubscription(e,t){const s=this.subscriptions.get(e);s&&(Object.assign(s,t),this.subscriptions.set(e,s))}}class OE{topics=new Map;partitions=new Map;messages=new Map;consumerGroups=new Map;consumerOffsets=new Map;partitionOffsets=new Map;topicState=new Map;partitionState=new Map;brokerHealth=new Map;brokers=[];initialize(e){this.topics.clear(),this.partitions.clear(),this.messages.clear(),this.consumerGroups.clear(),this.consumerOffsets.clear(),this.partitionOffsets.clear(),this.topicState.clear(),this.partitionState.clear();const t=e.brokers||["localhost:9092"];this.brokers=t;const s=t.length;this.brokerHealth.clear();for(let n=0;n<s;n++)this.brokerHealth.set(n,{isHealthy:!0,lastHealthCheck:Date.now(),consecutiveFailures:0});if(e.topics)for(const n of e.topics){const i={name:n.name,partitions:n.partitions||1,replication:n.replication||1,config:n.config,partitionInfo:n.partitionInfo};this.topics.set(i.name,i);const a=i.partitions;for(let o=0;o<a;o++){const l=`${i.name}-${o}`;let d;if(i.partitionInfo&&i.partitionInfo[o])d=i.partitionInfo[o];else{const p=o%s,g=[];for(let v=0;v<i.replication;v++)g.push((p+v)%s);d={id:o,leader:p,replicas:g,isr:[...g]}}const h={topicName:i.name,partitionId:o,leader:d.leader,replicas:d.replicas,isr:d.isr,highWatermark:0,messages:[]};this.partitions.set(l,h),this.messages.set(l,[]),this.partitionOffsets.set(l,0),this.partitionState.set(l,{messageCount:0,byteCount:0,latestOffset:0,highWatermark:0,lastUpdate:Date.now()})}this.topicState.set(i.name,{messageCount:0,byteCount:0,publishedCount:0,lastUpdate:Date.now()})}if(e.consumerGroups)for(const n of e.consumerGroups){const i=this.topics.get(n.topic);if(!i)continue;const a={id:n.id,topic:n.topic,members:n.members||1,partitionAssignment:new Map,offsetStrategy:n.offsetStrategy||"latest",autoCommit:n.autoCommit!==!1,isRebalancing:!1};if(this.assignPartitionsToConsumers(a.id,a.members,i.partitions),this.consumerGroups.set(a.id,a),this.consumerOffsets.set(a.id,new Map),a.offsetStrategy==="earliest")for(let o=0;o<i.partitions;o++){const l=`${a.topic}-${o}`;this.consumerOffsets.get(a.id).set(l,0)}else if(a.offsetStrategy==="latest")for(let o=0;o<i.partitions;o++){const l=`${a.topic}-${o}`,d=this.consumerOffsets.get(a.id),h=this.partitionOffsets.get(l)||0;d.set(l,h)}}}publishToTopic(e,t,s,n,i){const a=this.topics.get(e);if(!a)return null;let o;if(n!=null)o=this.hashKey(n)%a.partitions;else{const x=`${e}-0`;o=(this.partitionOffsets.get(x)||0)%a.partitions}const l=`${e}-${o}`,d=this.partitions.get(l);if(!d)return null;const p=(this.partitionOffsets.get(l)||0)+1,g={offset:p,timestamp:Date.now(),key:n,value:t,size:s,headers:i,partition:o,topic:e},v=this.messages.get(l)||[];v.push(g),this.messages.set(l,v),this.partitionOffsets.set(l,p),d.highWatermark=p;const b=this.partitionState.get(l);b&&(b.messageCount=v.length,b.byteCount=(b.byteCount||0)+s,b.latestOffset=p,b.highWatermark=p,b.lastUpdate=Date.now());const M=this.topicState.get(e);return M&&(M.messageCount=(M.messageCount||0)+1,M.byteCount=(M.byteCount||0)+s,M.publishedCount=(M.publishedCount||0)+1,M.lastUpdate=Date.now()),p}consumeFromTopic(e,t,s){const n=this.consumerGroups.get(e);if(!n)return[];if(n.topic!==t)return[];if(n.isRebalancing)return[];if(!this.topics.get(t))return[];const a=[];for(const[p,g]of n.partitionAssignment.entries())a.push(...g);const o=Array.from(new Set(a));if(o.length===0)return[];const l=s?Math.ceil(s/o.length):500,d=[],h=this.consumerOffsets.get(e);if(!h)return[];for(const p of o){const g=`${t}-${p}`,v=this.messages.get(g)||[],b=h.get(g)||0,x=v.filter(S=>S.offset>b).slice(0,l);if(x.length>0&&(d.push(...x),n.autoCommit)){const S=x[x.length-1].offset;h.set(g,S)}}return d}assignPartitionsToConsumers(e,t,s){const n=this.consumerGroups.get(e);if(!n)return new Map;if(t===0||s===0)return n.partitionAssignment.clear(),new Map;const i=new Map,a=Math.floor(s/t),o=s%t;let l=0;for(let d=0;d<t;d++){const h=[],p=a+(d<o?1:0);for(let g=0;g<p;g++)l<s&&(h.push(l),l++);i.set(d,h)}return n.partitionAssignment=i,i}commitOffset(e,t,s,n){const i=this.consumerOffsets.get(e);if(!i)return!1;const a=`${t}-${s}`,o=i.get(a)||0;return n>=o?(i.set(a,n),!0):!1}getOffset(e,t,s){const n=this.consumerOffsets.get(e);if(!n)return 0;const i=`${t}-${s}`;return n.get(i)||0}resetOffset(e,t,s){const n=this.consumerOffsets.get(e);if(!n)return!1;const i=this.topics.get(t);if(!i)return!1;for(let a=0;a<i.partitions;a++){const o=`${t}-${a}`;if(s==="earliest")n.set(o,0);else if(s==="latest"){const l=this.partitionOffsets.get(o)||0;n.set(o,l)}}return!0}processRetentionAndCompaction(e){const t=Date.now();for(const[s,n]of this.topics.entries()){const i=n.config||{},a=i.retentionMs||6048e5,o=i.retentionBytes,l=i.cleanupPolicy||"delete";for(let h=0;h<n.partitions;h++){const p=`${s}-${h}`,g=this.messages.get(p)||[];if(g.length===0)continue;const v=g.filter(M=>t-M.timestamp<a);let b=v;if(o&&o>0){let M=0;const x=[];for(let S=v.length-1;S>=0;S--){const T=v[S];if(M+T.size<=o)x.unshift(T),M+=T.size;else break}b=x}if(l==="compact"||l==="delete,compact"){const M=new Map;for(const x of b)if(x.key!==void 0&&x.key!==null){const S=String(x.key),T=M.get(S);(!T||x.offset>T.offset)&&M.set(S,x)}else M.set(`__no_key_${x.offset}`,x);b=Array.from(M.values()).sort((x,S)=>x.offset-S.offset)}if(b.length!==g.length){if(this.messages.set(p,b),b.length>0){b[0].offset;const x=this.partitions.get(p);if(x){const S=b[b.length-1].offset;x.highWatermark=Math.max(x.highWatermark,S)}}const M=this.partitionState.get(p);if(M){M.messageCount=b.length;const x=b.reduce((S,T)=>S+T.size,0);M.byteCount=x,M.lastUpdate=t}}}const d=this.topicState.get(s);if(d){let h=0,p=0;for(let g=0;g<n.partitions;g++){const v=`${s}-${g}`,b=this.partitionState.get(v);b&&(h+=b.messageCount,p+=b.byteCount)}d.messageCount=h,d.byteCount=p,d.lastUpdate=t}}}checkACLPermission(e,t,s,n,i){if(!e||e.length===0)return!0;const a=e.filter(d=>{const h=d.principal===t||d.principal==="*"||t.startsWith(d.principal),p=d.resourceType===s||d.resourceType==="*";let g=!1;d.resourcePatternType==="Literal"?g=d.resourceName===n:d.resourcePatternType==="Prefixed"?g=n.startsWith(d.resourceName):g=d.resourceName===n||d.resourceName==="*";const v=d.operation===i||d.operation==="All";return h&&p&&g&&v});return a.length===0||a.some(d=>d.permission==="Deny")?!1:a.some(d=>d.permission==="Allow")}getTopicMetrics(e){const t=this.topics.get(e);if(!t)return null;const s=this.topicState.get(e);return s?{messages:s.messageCount,size:s.byteCount,partitions:t.partitions}:null}getPartitionMetrics(e,t){const s=`${e}-${t}`,n=this.partitionState.get(s),i=this.partitions.get(s);return!n||!i?null:{messages:n.messageCount,size:n.byteCount,offset:n.latestOffset,highWatermark:i.highWatermark,leader:i.leader,replicas:i.replicas,isr:i.isr}}getAllPartitionMetrics(e){const t=this.topics.get(e);if(!t)return[];const s=[];for(let n=0;n<t.partitions;n++){const i=this.getPartitionMetrics(e,n);i&&s.push({partitionId:n,...i})}return s}getConsumerGroupLag(e,t){const s=this.consumerGroups.get(e);if(!s||s.topic!==t)return 0;const n=this.consumerOffsets.get(e);if(!n)return 0;let i=0;const a=this.topics.get(t);if(!a)return 0;for(let o=0;o<a.partitions;o++){const l=`${t}-${o}`,d=this.partitions.get(l);if(!d)continue;const h=n.get(l)||0,p=d.highWatermark,g=Math.max(0,p-h);i+=g}return i}getUnderReplicatedPartitions(){let e=0;for(const t of this.partitions.values()){const s=t.replicas.length;t.isr.length<s&&e++}return e}getPartitionAssignment(e){const t=this.consumerGroups.get(e);return t?t.partitionAssignment:null}getConsumerGroupState(e){return this.consumerGroups.get(e)||null}createOrUpdateConsumerGroup(e,t,s=1,n="latest",i=!0){const a=this.topics.get(t);if(!a)return!1;const o=this.consumerGroups.get(e),l=o&&o.members!==s;l&&(o.isRebalancing=!0,o.rebalanceEndTime=Date.now()+2e3);const d={id:e,topic:t,members:s,partitionAssignment:new Map,offsetStrategy:o?.offsetStrategy||n,autoCommit:o?.autoCommit!==!1?i:o.autoCommit,isRebalancing:l||!1,rebalanceEndTime:l?Date.now()+2e3:void 0};if(this.assignPartitionsToConsumers(e,s,Array.from({length:a.partitions},(h,p)=>p)),!o){if(this.consumerOffsets.set(e,new Map),d.offsetStrategy==="earliest")for(let h=0;h<a.partitions;h++){const p=`${t}-${h}`;this.consumerOffsets.get(e).set(p,0)}else if(d.offsetStrategy==="latest")for(let h=0;h<a.partitions;h++){const p=`${t}-${h}`,g=this.consumerOffsets.get(e),v=this.partitionOffsets.get(p)||0;g.set(p,v)}}return this.consumerGroups.set(e,d),!0}updateConsumerGroupMembers(e,t){const s=this.consumerGroups.get(e);if(!s)return!1;if(s.members===t)return!0;const n=this.topics.get(s.topic);return n?(s.isRebalancing=!0,s.rebalanceEndTime=Date.now()+2e3,s.members=t,this.assignPartitionsToConsumers(e,t,Array.from({length:n.partitions},(i,a)=>a)),!0):!1}checkRebalancing(){const e=Date.now();for(const t of this.consumerGroups.values())t.isRebalancing&&t.rebalanceEndTime&&e>=t.rebalanceEndTime&&(t.isRebalancing=!1,t.rebalanceEndTime=void 0)}getConsumptionRate(e,t){const s=this.consumerGroups.get(e);return!s||s.topic!==t?0:s.members*500/.5}updateBrokerHealth(e){const t=Date.now();for(const[s,n]of e.entries()){const i=this.brokerHealth.get(s);i&&(n?(i.consecutiveFailures=0,i.isHealthy=!0):(i.consecutiveFailures++,i.consecutiveFailures>=3&&(i.isHealthy=!1)),i.lastHealthCheck=t)}this.updateISRAndLeaderElection()}updateISRAndLeaderElection(){for(const[e,t]of this.partitions.entries()){if(!this.topics.get(t.topicName))continue;const n=t.replicas.filter(o=>this.brokerHealth.get(o)?.isHealthy!==!1);if(t.isr=n,!(this.brokerHealth.get(t.leader)?.isHealthy!==!1)&&t.isr.length>0&&this.electNewLeader(e,t),t.isr.length===0&&t.replicas.length>0){const o=t.replicas.find(l=>this.brokerHealth.get(l)?.isHealthy===!0);o!==void 0&&(t.leader=o,t.isr=[o])}}}electNewLeader(e,t){if(t.isr.length===0)return;const s=t.isr[0];s!==t.leader&&(t.leader=s,console.log(`[Kafka] Leader election for partition ${e}: new leader = broker ${s}`))}getBrokerHealth(e){return this.brokerHealth.get(e)||null}getAllBrokerHealth(){return new Map(this.brokerHealth)}hashKey(e){let n=0,i=e.length,a,o=0;for(;i>=4;)a=e.charCodeAt(o)|e.charCodeAt(o+1)<<8|e.charCodeAt(o+2)<<16|e.charCodeAt(o+3)<<24,a=(a&65535)*1540483477+(((a>>>16)*1540483477&65535)<<16),a^=a>>>24,a=(a&65535)*1540483477+(((a>>>16)*1540483477&65535)<<16),n=(n&65535)*1540483477+(((n>>>16)*1540483477&65535)<<16),n^=a,o+=4,i-=4;switch(i){case 3:n^=e.charCodeAt(o+2)<<16;case 2:n^=e.charCodeAt(o+1)<<8;case 1:n^=e.charCodeAt(o),n=(n&65535)*1540483477+(((n>>>16)*1540483477&65535)<<16)}return n^=n>>>13,n=(n&65535)*1540483477+(((n>>>16)*1540483477&65535)<<16),n^=n>>>15,n>>>0}}class qE{services=new Map;routes=new Map;upstreams=new Map;consumers=new Map;plugins=[];roundRobinCounters=new Map;connectionCounts=new Map;consistentHashRing=new Map;rateLimitCounters=new Map;healthCheckTimers=new Map;targetHealthStatus=new Map;targetHealthCounters=new Map;circuitBreakerState=new Map;circuitBreakerCounters=new Map;CIRCUIT_BREAKER_FAILURE_THRESHOLD=5;CIRCUIT_BREAKER_SUCCESS_THRESHOLD=2;CIRCUIT_BREAKER_TIMEOUT=3e4;initialize(e){for(const t of this.healthCheckTimers.values())clearInterval(t);if(this.healthCheckTimers.clear(),this.services.clear(),this.routes.clear(),this.upstreams.clear(),this.consumers.clear(),this.plugins=[],this.roundRobinCounters.clear(),this.connectionCounts.clear(),this.consistentHashRing.clear(),this.rateLimitCounters.clear(),this.targetHealthStatus.clear(),this.targetHealthCounters.clear(),this.circuitBreakerState.clear(),this.circuitBreakerCounters.clear(),e.services)for(const t of e.services)this.services.set(t.id,{...t});if(e.routes)for(const t of e.routes)this.routes.set(t.id,{...t});if(e.upstreams)for(const t of e.upstreams){if(this.upstreams.set(t.name,{...t}),this.roundRobinCounters.set(t.name,0),t.targets)for(const s of t.targets){const n=`${t.name}:${s.target}`;this.targetHealthStatus.set(n,s.health||"healthy"),this.targetHealthCounters.set(n,{successes:0,failures:0,lastCheck:Date.now()})}if(t.healthchecks?.active&&this.startActiveHealthChecks(t),t.algorithm==="consistent-hashing"&&t.targets){const s=[...t.targets].filter(n=>{const i=`${t.name}:${n.target}`;return(this.targetHealthStatus.get(i)||n.health||"healthy")==="healthy"}).sort((n,i)=>n.target.localeCompare(i.target));this.consistentHashRing.set(t.name,s.map(n=>n.target))}}if(e.consumers)for(const t of e.consumers)this.consumers.set(t.id,{...t});e.plugins&&(this.plugins=e.plugins.filter(t=>t.enabled))}updateConfig(e){if(e.services!==void 0){const t=new Set(e.services.map(s=>s.id));for(const[s]of this.services)t.has(s)||this.services.delete(s);for(const s of e.services)this.services.set(s.id,{...s})}if(e.routes!==void 0){const t=new Set(e.routes.map(s=>s.id));for(const[s]of this.routes)t.has(s)||this.routes.delete(s);for(const s of e.routes)this.routes.set(s.id,{...s})}if(e.upstreams!==void 0){const t=new Set(e.upstreams.map(s=>s.name));for(const[s]of this.upstreams)t.has(s)||(this.upstreams.delete(s),this.roundRobinCounters.delete(s),this.consistentHashRing.delete(s));for(const s of e.upstreams){const n=this.upstreams.get(s.name);if(this.upstreams.set(s.name,{...s}),n||this.roundRobinCounters.set(s.name,0),s.algorithm==="consistent-hashing"&&s.targets){const i=[...s.targets].filter(a=>{const o=`${s.name}:${a.target}`;return(this.targetHealthStatus.get(o)||a.health||"healthy")==="healthy"}).sort((a,o)=>a.target.localeCompare(o.target));this.consistentHashRing.set(s.name,i.map(a=>a.target))}s.healthchecks?.active&&this.startActiveHealthChecks(s)}}if(e.consumers!==void 0){const t=new Set(e.consumers.map(s=>s.id));for(const[s]of this.consumers)t.has(s)||this.consumers.delete(s);for(const s of e.consumers)this.consumers.set(s.id,{...s})}if(e.plugins!==void 0){this.plugins=e.plugins.filter(s=>s.enabled);const t=new Set(e.plugins.map(s=>s.id));for(const[s]of this.rateLimitCounters)t.has(s)||this.rateLimitCounters.delete(s)}}routeRequest(e){const t=Date.now(),s=this.matchRoute(e);if(!s)return{match:null,response:{status:404,error:"No route matched",latency:Date.now()-t}};const n=this.executePlugins(e,s,"access");if(n.blocked)return{match:s,response:{status:n.status||403,error:n.error||"Request blocked by plugin",latency:Date.now()-t}};const i=s.service.upstream||s.service.name,a=this.upstreams.get(i);if(a&&a.targets)for(const A of a.targets)this.checkCircuitBreakerTimeout(A.target);const o=this.selectUpstreamTarget(s.service);if(!o)return{match:s,response:{status:503,error:"No healthy upstream target available",latency:Date.now()-t}};if(this.circuitBreakerState.get(o)==="open")return{match:s,response:{status:503,error:"Circuit breaker is open",latency:Date.now()-t}};this.transformPath(e.path,s);const d=s.service,h=d.retries||0,p=d.connect_timeout||6e4,g=d.write_timeout||6e4,v=d.read_timeout||6e4;let b=null,M=null;for(let A=0;A<=h;A++){let k,D=!1;if(Math.random()*(p*2)>p)D=!0,k={status:504,latency:Date.now()-t+p,error:"Connection timeout"};else if(Math.random()*(g*2)>g)D=!0,k={status:504,latency:Date.now()-t+g,error:"Write timeout"};else{const Q=this.simulateUpstreamLatency(o);if(Q>v)D=!0,k={status:504,latency:Date.now()-t+v,error:"Read timeout"};else{const se=Date.now()-t+Q,F=Math.random()<.05;k={status:F?500:200,latency:se,error:F?"Internal server error":void 0}}}if(b=k,!(A<h&&(k.status>=500||k.status===504||D)))break;M=k.error||"Request failed",b&&(b.latency=(b.latency||0)+100*(A+1))}const x=b||{status:500,latency:Date.now()-t,error:M||"Request failed after retries"},S=s.service.upstream||s.service.name,T=this.upstreams.get(S);if(T&&T.healthchecks?.passive){const A=x.status>=200&&x.status<500;this.recordPassiveHealthCheck(S,o,A)}const E=x.status>=200&&x.status<500;return this.updateCircuitBreaker(o,E),{match:s,response:x,target:o}}matchRoute(e){const t=Array.from(this.routes.values()).sort((s,n)=>(n.regex_priority||n.priority||0)-(s.regex_priority||s.priority||0));for(const s of t){const n=s.methods||(s.method?[s.method]:[]);if(n.length>0&&!n.some(o=>o.toUpperCase()===e.method.toUpperCase()))continue;const i=s.paths||(s.path?[s.path]:[]);let a=null;for(const o of i)if(a=this.matchPath(o,e.path),a)break;if(a){const o=this.services.get(s.service);if(!o||o.enabled===!1)continue;return{route:s,service:o,matchedPath:a.matched,remainingPath:a.remaining}}}return null}matchPath(e,t){if(t.startsWith(e))return{matched:e,remaining:t.substring(e.length)};try{if(new RegExp(`^${e}$`).test(t))return{matched:t,remaining:""}}catch{}return null}selectUpstreamTarget(e){const t=e.upstream||e.name,s=this.upstreams.get(t);if(!s||!s.targets||s.targets.length===0){if(e.url)return e.url;if(e.host&&e.port){const a=e.protocol||"http",o=e.path||"";return`${a}://${e.host}:${e.port}${o}`}return null}const n=s.targets.filter(a=>{const o=`${t}:${a.target}`,l=this.targetHealthStatus.get(o)||a.health||"healthy";return(this.circuitBreakerState.get(a.target)||"closed")==="open"?!1:l==="healthy"});if(n.length===0)return null;switch(s.algorithm||"round-robin"){case"round-robin":return this.selectRoundRobin(t,n);case"consistent-hashing":return this.selectConsistentHash(t,n,e.name);case"least-connections":return this.selectLeastConnections(n);default:return n[0].target}}selectRoundRobin(e,t){const s=this.roundRobinCounters.get(e)||0,n=t[s%t.length];return this.roundRobinCounters.set(e,(s+1)%t.length),n.target}selectConsistentHash(e,t,s){const i=this.simpleHash(s)%t.length;return t[i].target}selectLeastConnections(e){let t=1/0,s=e[0].target;for(const i of e){const a=this.connectionCounts.get(i.target)||0;a<t&&(t=a,s=i.target)}const n=this.connectionCounts.get(s)||0;return this.connectionCounts.set(s,n+1),s}simpleHash(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t=t&t}return Math.abs(t)}transformPath(e,t){return(t.route.strip_path!==void 0?t.route.strip_path:t.route.stripPath)?t.remainingPath||"/":e}executePlugins(e,t,s){const n=this.plugins.filter(i=>!(i.route&&i.route!==t.route.id||i.service&&i.service!==t.service.id));for(const i of n){const a=this.executePlugin(i,e,t,s);if(a.blocked)return a}return{blocked:!1}}executePlugin(e,t,s,n){const i=e.config||{};switch(e.name){case"rate-limiting":return this.executeRateLimiting(e,t,s,i);case"key-auth":return this.executeKeyAuth(e,t,s,i);case"jwt":return this.executeJWT(e,t,s,i);case"cors":return{blocked:!1};case"ip-restriction":return this.executeIPRestriction(e,t,s,i);default:return{blocked:!1}}}executeRateLimiting(e,t,s,n){const i=t.consumerId||s.service.id||s.route.id,a=Date.now();let o=this.rateLimitCounters.get(e.id);o||(o=new Map,this.rateLimitCounters.set(e.id,o));let l=o.get(i);(!l||l.resetAt<a)&&(l={count:0,resetAt:a+6e4},o.set(i,l));const d=n.minute||1e3;return n.hour,l.count++,l.count>d?{blocked:!0,status:429,error:"Rate limit exceeded (per minute)"}:{blocked:!1}}executeKeyAuth(e,t,s,n){const i=n.key_names||["apikey"],a=t.apiKey||t.headers?.[i[0]]||t.query?.[i[0]];return a?Array.from(this.consumers.values()).find(l=>l.credentials?.some(d=>d.type==="key-auth"&&d.key===a))?{blocked:!1}:{blocked:!0,status:401,error:"Invalid API key"}:{blocked:!0,status:401,error:"API key required"}}executeJWT(e,t,s,n){const i=t.headers?.Authorization;return!i||!i.startsWith("Bearer ")?{blocked:!0,status:401,error:"JWT token required"}:{blocked:!1}}executeIPRestriction(e,t,s,n){const i=t.headers?.["X-Forwarded-For"]||t.headers?.["X-Real-IP"]||"unknown",a=n.whitelist||[];return(n.blacklist||[]).includes(i)?{blocked:!0,status:403,error:"IP address blocked"}:a.length>0&&!a.includes(i)?{blocked:!0,status:403,error:"IP address not whitelisted"}:{blocked:!1}}simulateUpstreamLatency(e){const t=10+Math.random()*40,s=Math.random()<.1;return t+(s?50+Math.random()*100:0)}startActiveHealthChecks(e){const t=this.healthCheckTimers.get(e.name);t&&clearInterval(t);const s=e.healthchecks?.active;if(!s||!e.targets)return;const n=s.healthy?.interval||1e4,i=s.timeout||1e3,a=setInterval(()=>{for(const o of e.targets||[]){const l=`${e.name}:${o.target}`;this.performActiveHealthCheck(e,o,l,s,i)}},n);this.healthCheckTimers.set(e.name,a)}performActiveHealthCheck(e,t,s,n,i){const a=Math.random()>.05,l=Math.random()*i>i,d=this.targetHealthCounters.get(s)||{successes:0,failures:0,lastCheck:Date.now()};if(l||!a){d.failures++;const h=n.unhealthy?.timeouts||0;d.failures>=h&&(this.targetHealthStatus.set(s,"unhealthy"),t.health!=="unhealthy"&&(t.health="unhealthy"))}else{d.successes++;const h=n.healthy?.successes||1;d.successes>=h&&(this.targetHealthStatus.set(s,"healthy"),t.health!=="healthy"&&(t.health="healthy"),d.failures=0)}d.lastCheck=Date.now(),this.targetHealthCounters.set(s,d)}recordPassiveHealthCheck(e,t,s){const n=this.upstreams.get(e);if(!n||!n.healthchecks?.passive)return;const i=`${e}:${t}`,a=this.targetHealthCounters.get(i)||{successes:0,failures:0,lastCheck:Date.now()},o=n.healthchecks.passive;if(s){a.successes++;const l=o.healthy?.successes||1;if(a.successes>=l){this.targetHealthStatus.set(i,"healthy");const d=n.targets?.find(h=>h.target===t);d&&d.health!=="healthy"&&(d.health="healthy"),a.failures=0}}else{a.failures++;const l=o.unhealthy?.http_failures||o.unhealthy?.tcp_failures||0;if(a.failures>=l){this.targetHealthStatus.set(i,"unhealthy");const d=n.targets?.find(h=>h.target===t);d&&d.health!=="unhealthy"&&(d.health="unhealthy")}}a.lastCheck=Date.now(),this.targetHealthCounters.set(i,a)}getStats(){return{services:this.services.size,routes:this.routes.size,upstreams:this.upstreams.size,consumers:this.consumers.size,plugins:this.plugins.length}}}class HE{proxies=new Map;policies=[];products=new Map;developerApps=new Map;organization;environment;apiKeys=[];oauthTokens=[];jwtConfigs=[];keyUsageMetrics=new Map;quotaCounters=new Map;spikeArrestBuckets=new Map;apiKeyCache=new Map;oauthTokenCache=new Map;jwtTokenCache=new Map;proxyMetrics=new Map;initialize(e){if(this.proxies.clear(),this.policies=[],this.products.clear(),this.developerApps.clear(),this.quotaCounters.clear(),this.spikeArrestBuckets.clear(),this.apiKeyCache.clear(),this.oauthTokenCache.clear(),this.jwtTokenCache.clear(),this.proxyMetrics.clear(),this.keyUsageMetrics.clear(),this.organization=e.organization||"archiphoenix-org",this.environment=e.environment||"prod",e.proxies)for(const t of e.proxies)this.proxies.set(t.name,{...t}),this.proxyMetrics.set(t.name,{requestCount:0,errorCount:0,totalLatency:0,lastRequestTime:0}),t.spikeArrest&&t.spikeArrest>0&&this.spikeArrestBuckets.set(t.name,{tokens:t.spikeArrest,lastRefill:Date.now(),rate:t.spikeArrest});if(e.policies&&(this.policies=e.policies.filter(t=>t.enabled)),e.products)for(const t of e.products)this.products.set(t.id,{...t});if(e.developerApps)for(const t of e.developerApps){this.developerApps.set(t.id,{...t});for(const s of t.keys)s.status==="approved"&&this.apiKeys.push({key:s.key,consumerId:t.developerId||t.id,appId:t.id,products:s.apiProducts||t.apiProducts,expiresAt:s.expiresAt,createdAt:s.createdAt})}e.apiKeys&&(this.apiKeys=[...this.apiKeys,...e.apiKeys]),e.oauthTokens&&(this.oauthTokens=e.oauthTokens),e.jwtConfigs&&(this.jwtConfigs=e.jwtConfigs)}updateConfig(e){if(e.organization!==void 0&&(this.organization=e.organization||"archiphoenix-org"),e.environment!==void 0&&(this.environment=e.environment||"prod"),e.proxies!==void 0){const t=new Set(this.proxies.keys()),s=new Set(e.proxies.map(n=>n.name));for(const n of t)s.has(n)||(this.proxies.delete(n),this.quotaCounters.delete(n),this.spikeArrestBuckets.delete(n),this.proxyMetrics.delete(n));for(const n of e.proxies){const i=this.proxies.has(n.name);if(this.proxies.set(n.name,{...n}),i||this.proxyMetrics.set(n.name,{requestCount:0,errorCount:0,totalLatency:0,lastRequestTime:0}),n.spikeArrest&&n.spikeArrest>0){const a=this.spikeArrestBuckets.get(n.name);a?a.rate=n.spikeArrest:this.spikeArrestBuckets.set(n.name,{tokens:n.spikeArrest,lastRefill:Date.now(),rate:n.spikeArrest})}else this.spikeArrestBuckets.delete(n.name)}}if(e.policies!==void 0&&(this.policies=e.policies.filter(t=>t.enabled)),e.products!==void 0){const t=new Set(this.products.keys()),s=new Set(e.products.map(n=>n.id));for(const n of t)s.has(n)||this.products.delete(n);for(const n of e.products)this.products.set(n.id,{...n})}if(e.developerApps!==void 0){const t=new Set(this.developerApps.keys()),s=new Set(e.developerApps.map(n=>n.id));for(const n of t)s.has(n)||this.developerApps.delete(n);this.apiKeys=e.apiKeys||[];for(const n of e.developerApps){this.developerApps.set(n.id,{...n});for(const i of n.keys)i.status==="approved"&&(this.apiKeys=this.apiKeys.filter(a=>a.key!==i.key),this.apiKeys.push({key:i.key,consumerId:n.developerId||n.id,appId:n.id,products:i.apiProducts||n.apiProducts,expiresAt:i.expiresAt,createdAt:i.createdAt}))}this.apiKeyCache.clear()}else e.apiKeys!==void 0&&(this.apiKeys=e.apiKeys,this.apiKeyCache.clear());e.oauthTokens!==void 0&&(this.oauthTokens=e.oauthTokens,this.oauthTokenCache.clear()),e.jwtConfigs!==void 0&&(this.jwtConfigs=e.jwtConfigs,this.jwtTokenCache.clear())}routeRequest(e){const t=Date.now(),s=this.matchProxy(e);if(!s)return{match:null,response:{status:404,error:"No API proxy matched for path",latency:Date.now()-t}};if(s.proxy.status==="undeployed")return this.updateProxyMetrics(s.proxy.name,!1,Date.now()-t),{match:s,response:{status:503,error:`Proxy '${s.proxy.name}' is not deployed`,latency:Date.now()-t}};const n=this.policies.filter(b=>b.enabled&&(b.executionFlow==="PreFlow"||!b.executionFlow&&this.isPreFlowPolicy(b.type))),i=this.executePolicies(n,e,s,"PreFlow");if(i.blocked)return this.updateProxyMetrics(s.proxy.name,!0,Date.now()-t),{match:s,response:{status:i.status||401,error:i.error||"Authentication failed",latency:Date.now()-t}};const a=this.policies.filter(b=>b.enabled&&(b.executionFlow==="RequestFlow"||!b.executionFlow&&this.isRequestFlowPolicy(b.type))),o=this.executePolicies(a,e,s,"RequestFlow");if(o.blocked)return this.updateProxyMetrics(s.proxy.name,!0,Date.now()-t),{match:s,response:{status:o.status||429,error:o.error||"Request policy violation",latency:Date.now()-t}};const l=this.buildTargetUrl(s.proxy,s.remainingPath),d=this.simulateUpstreamLatency(l),h=Date.now()-t+d,p={status:200,latency:h},g=this.policies.filter(b=>b.enabled&&b.executionFlow==="ResponseFlow");this.executePolicies(g,e,s,"ResponseFlow",p);const v=this.policies.filter(b=>b.enabled&&(b.executionFlow==="PostFlow"||!b.executionFlow&&this.isPostFlowPolicy(b.type)));return this.executePolicies(v,e,s,"PostFlow",p),this.updateProxyMetrics(s.proxy.name,!1,h),{match:s,response:p,target:l}}matchProxy(e){const t=Array.from(this.proxies.values()).filter(s=>s.status==="deployed"||s.status===void 0).sort((s,n)=>n.basePath.length-s.basePath.length);for(const s of t)if(e.path.startsWith(s.basePath)){const n=e.path.slice(s.basePath.length)||"/";return{proxy:s,matchedPath:s.basePath,remainingPath:n}}return null}isPreFlowPolicy(e){return["verify-api-key","oauth","jwt"].includes(e)}isRequestFlowPolicy(e){return["quota","spike-arrest"].includes(e)}isPostFlowPolicy(e){return["cors","xml-to-json"].includes(e)}evaluateCondition(e,t,s){if(!e)return!0;try{if(e.includes("request.path")){const n=e.match(/request\.path\s*[=!]=\s*['"]([^'"]+)['"]/);if(n)return t.path===n[1]}return e.length>0}catch{return!0}}executePolicies(e,t,s,n,i){for(const a of e)if(this.evaluateCondition(a.condition,t,s))if(n==="PreFlow"){const o=this.executePreFlowPolicy(a,t,s);if(o.blocked)return o}else if(n==="RequestFlow"){const o=this.executeRequestFlowPolicy(a,t,s);if(o.blocked)return o}else n==="ResponseFlow"&&i?this.executeResponseFlowPolicy(a,t,s,i):n==="PostFlow"&&i&&this.executePostFlowPolicy(a,t,s,i);return{blocked:!1}}executePreFlowPolicy(e,t,s){if(s.proxy,e.type==="verify-api-key"){const n=t.apiKey||t.headers?.["X-API-Key"]||t.headers?.apikey||t.query?.apikey;if(!n)return{blocked:!0,status:401,error:"API key is required"};if(!this.validateApiKey(n))return{blocked:!0,status:401,error:"Invalid API key"}}if(e.type==="oauth"&&s.proxy.enableOAuth){const i=t.oauthToken||t.headers?.Authorization?.replace("Bearer ","")||t.headers?.Authorization?.replace("OAuth ","");if(!i)return{blocked:!0,status:401,error:"OAuth token is required"};if(!this.validateOAuthToken(i))return{blocked:!0,status:401,error:"Invalid or expired OAuth token"}}if(e.type==="jwt"){const n=s.proxy;if(n.jwtIssuer){const i=t.jwtToken||t.headers?.Authorization?.replace("Bearer ","")||t.headers?.["X-JWT-Token"];if(!i)return{blocked:!0,status:401,error:"JWT token is required"};if(!this.validateJWTToken(i,n.jwtIssuer))return{blocked:!0,status:401,error:"Invalid or expired JWT token"}}}return{blocked:!1}}executeRequestFlowPolicy(e,t,s){const n=s.proxy,i=t.headers?.["X-Consumer-ID"]||"default";if(e.type==="quota"){const a=e.config?.quota||e.config?.allowCount||n.quota;let o=e.config?.interval||e.config?.quotaInterval||n.quotaInterval;const l=e.config?.timeUnit||"second";if(o)switch(l){case"minute":o=o*60;break;case"hour":o=o*3600;break;case"day":o=o*86400;break}if(a&&o&&!this.checkQuota(n.name,i,a,o))return{blocked:!0,status:429,error:`Quota exceeded: ${a} requests per ${o} seconds`}}if(e.type==="spike-arrest"){let a=e.config?.rate||n.spikeArrest;const o=e.config?.timeUnit||"second";if(a&&a>0&&(o==="minute"&&(a=a/60),!this.checkSpikeArrest(n.name,a)))return{blocked:!0,status:429,error:`Spike arrest limit exceeded: ${a} requests per second`}}return{blocked:!1}}executeResponseFlowPolicy(e,t,s,n){e.type==="xml-to-json"&&(n.headers||(n.headers={}),n.headers["Content-Type"]="application/json",e.config?.options,e.config?.attributes,e.config?.namespaces),e.config?.transformResponse&&(e.config.statusCode&&(n.status=e.config.statusCode),e.config.responseHeaders&&(n.headers||(n.headers={}),Object.assign(n.headers,e.config.responseHeaders)))}executePostFlowPolicy(e,t,s,n){if(e.type==="cors"){n.headers||(n.headers={});const i=e.config?.origins||["*"],a=e.config?.methods||["GET","POST","PUT","DELETE"],o=e.config?.headers||["Content-Type","Authorization"],l=e.config?.maxAge||3600,d=e.config?.allowCredentials||!1;n.headers["Access-Control-Allow-Origin"]=Array.isArray(i)?i[0]:i||"*",n.headers["Access-Control-Allow-Methods"]=Array.isArray(a)?a.join(", "):a,n.headers["Access-Control-Allow-Headers"]=Array.isArray(o)?o.join(", "):o,n.headers["Access-Control-Max-Age"]=l.toString(),d&&(n.headers["Access-Control-Allow-Credentials"]="true")}}checkQuota(e,t,s,n){const i=Date.now(),a=n*1e3;let o=this.quotaCounters.get(e);o||(o=new Map,this.quotaCounters.set(e,o));let l=o.get(t);return(!l||l.resetAt<i)&&(l={count:0,resetAt:i+a,identifier:t},o.set(t,l)),l.count>=s?!1:(l.count++,!0)}checkSpikeArrest(e,t){const s=Date.now();let n=this.spikeArrestBuckets.get(e);n||(n={tokens:t,lastRefill:s,rate:t},this.spikeArrestBuckets.set(e,n));const a=(s-n.lastRefill)/1e3*n.rate;return n.tokens=Math.min(n.rate,n.tokens+a),n.lastRefill=s,n.tokens<1?!1:(n.tokens-=1,!0)}validateApiKey(e){if(!e||e.trim()==="")return!1;const t=this.apiKeyCache.get(e);if(t&&t.expiresAt>Date.now())return t.valid&&t.consumerId&&this.trackKeyUsage(e,t.consumerId),t.valid;const s=this.apiKeys.find(n=>n.key===e);return s?s.expiresAt&&s.expiresAt<Date.now()?(this.apiKeyCache.set(e,{valid:!1,expiresAt:Date.now()+300*1e3}),!1):(this.apiKeyCache.set(e,{valid:!0,consumerId:s.consumerId,expiresAt:Date.now()+300*1e3}),s.appId&&this.trackKeyUsage(e,s.appId),!0):(this.apiKeyCache.set(e,{valid:!1,expiresAt:Date.now()+300*1e3}),!1)}trackKeyUsage(e,t){const s=this.keyUsageMetrics.get(e);s?(s.requestCount++,s.lastUsed=Date.now()):this.keyUsageMetrics.set(e,{appId:t,requestCount:1,lastUsed:Date.now()})}validateOAuthToken(e){if(!e||e.trim()==="")return!1;const t=this.oauthTokenCache.get(e);if(t&&t.expiresAt>Date.now())return t.valid;const s=this.oauthTokens.find(n=>n.token===e);return s?s.expiresAt&&s.expiresAt<Date.now()?(this.oauthTokenCache.set(e,{valid:!1,expiresAt:Date.now()+3600*1e3}),!1):(this.oauthTokenCache.set(e,{valid:!0,expiresAt:Date.now()+3600*1e3}),!0):(this.oauthTokenCache.set(e,{valid:!1,expiresAt:Date.now()+3600*1e3}),!1)}validateJWTToken(e,t){if(!e||e.trim()==="")return!1;const s=this.jwtTokenCache.get(e);if(s&&s.expiresAt>Date.now())return s.valid&&s.issuer===t;if(!this.jwtConfigs.find(o=>o.issuer===t)&&!this.jwtConfigs.some(l=>l.allowedIssuers?.includes(t)||l.issuer===t))return this.jwtTokenCache.set(e,{valid:!1,issuer:t,expiresAt:Date.now()+3600*1e3}),!1;const a=e.split(".").length===3;return this.jwtTokenCache.set(e,{valid:a,issuer:t,expiresAt:Date.now()+3600*1e3}),a}buildTargetUrl(e,t){const s=e.targetEndpoint.replace(/\/$/,""),n=t.startsWith("/")?t:`/${t}`;return`${s}${n}`}simulateUpstreamLatency(e){const t=10+Math.random()*40,s=(Math.random()-.5)*10;return Math.max(1,t+s)}updateProxyMetrics(e,t,s){const n=this.proxyMetrics.get(e);n&&(n.requestCount++,t&&n.errorCount++,n.totalLatency+=s,n.lastRequestTime=Date.now())}getProducts(){return Array.from(this.products.values())}getProduct(e){return this.products.get(e)||null}getProductsForProxy(e){return Array.from(this.products.values()).filter(t=>t.proxies.includes(e))}getDeveloperApps(){return Array.from(this.developerApps.values())}getDeveloperApp(e){return this.developerApps.get(e)||null}getDeveloperAppsForProduct(e){return Array.from(this.developerApps.values()).filter(t=>t.apiProducts.includes(e))}generateApiKey(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let s=0;s<32;s++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}getKeyUsageMetrics(e){return this.keyUsageMetrics.get(e)||null}getAppKeyUsageMetrics(e){const t=new Map;for(const[s,n]of this.keyUsageMetrics.entries())n.appId===e&&t.set(s,n);return t}getStats(){let e=0,t=0,s=0;for(const i of this.proxyMetrics.values())e+=i.requestCount,t+=i.errorCount,s+=i.totalLatency;const n=e>0?s/e:0;return{proxies:this.proxies.size,policies:this.policies.length,products:this.products.size,totalRequests:e,totalErrors:t,avgLatency:n}}getProxyMetrics(e){const t=this.proxyMetrics.get(e);return t?{requestCount:t.requestCount,errorCount:t.errorCount,avgResponseTime:t.requestCount>0?t.totalLatency/t.requestCount:0}:null}clearCaches(){this.apiKeyCache.clear(),this.oauthTokenCache.clear(),this.jwtTokenCache.clear()}}class $E{applications=new Map;connectors=new Map;organization;environment;applicationMetrics=new Map;connectorMetrics=new Map;reconnectionState=new Map;initialize(e){if(this.applications.clear(),this.connectors.clear(),this.applicationMetrics.clear(),this.connectorMetrics.clear(),this.reconnectionState.clear(),this.organization=e.organization||"archiphoenix-org",this.environment=e.environment||"production",e.applications)for(const t of e.applications)this.applications.set(t.name,{...t}),this.applicationMetrics.set(t.name,{requestCount:0,errorCount:0,totalLatency:0,lastRequestTime:0});if(e.connectors)for(const t of e.connectors)this.connectors.set(t.name,{...t}),this.connectorMetrics.set(t.name,{requestCount:0,errorCount:0,totalLatency:0,lastRequestTime:0}),this.reconnectionState.set(t.name,{attempts:0,lastAttempt:0,nextAttempt:0})}processData(e){const t=Date.now(),s=this.matchApplication(e);if(!s)return{match:null,response:{status:"error",error:"No Mule application matched for request",latency:Date.now()-t}};if(s.application.status!=="running")return this.updateApplicationMetrics(s.application.name,!1,Date.now()-t),{match:s,response:{status:"error",error:`Application '${s.application.name}' is not running (status: ${s.application.status})`,latency:Date.now()-t}};let n=0,i;try{n=this.processFlow(s,e)}catch(o){i=o instanceof Error?o.message:"Unknown error"}if(i&&!this.handleError(s.application,i))return this.updateApplicationMetrics(s.application.name,!0,Date.now()-t),{match:s,response:{status:"error",error:i,latency:Date.now()-t,application:s.application.name,flow:s.flow?.name}};const a=this.transformData(e,s);return this.updateApplicationMetrics(s.application.name,!1,Date.now()-t),s.matchedConnector&&this.updateConnectorMetrics(s.matchedConnector.name,!1,Date.now()-t),{match:s,response:{status:"success",data:a.data,format:a.format||e.format,latency:Date.now()-t,application:s.application.name,flow:s.flow?.name,connector:s.matchedConnector?.name}}}matchApplication(e){if(e.sourceComponentType||e.targetComponentType)for(const[t,s]of this.applications.entries()){if(s.status!=="running")continue;const n=this.findMatchingConnector(s,e.sourceComponentType,e.targetComponentType);if(n){const i=s.flows?.find(a=>typeof a.source=="string"?a.source===n.name:a.source?.type==="connector"&&a.source.config?.connectorName===n.name?!0:typeof a.target=="string"?a.target===n.name:a.target?.type==="connector"&&a.target.config?.connectorName===n.name)||s.flows?.[0];return{application:s,flow:i,matchedConnector:n}}}for(const[t,s]of this.applications.entries())if(s.status==="running")return{application:s,flow:s.flows?.[0]};return null}findMatchingConnector(e,t,s){const n=e.connectors||[];for(const i of n){const a=this.connectors.get(i);if(!(!a||!a.enabled)&&(t&&this.connectorMatchesComponentType(a,t)||s&&this.connectorMatchesComponentType(a,s)))return a}return null}connectorMatchesComponentType(e,t){const s={database:["postgres","mongodb","redis","cassandra","clickhouse","snowflake","elasticsearch"],api:["rest","grpc","graphql","soap","websocket","webhook"],messaging:["kafka","rabbitmq","activemq","aws-sqs","azure-service-bus","gcp-pubsub"],file:["s3-datalake"],business:["crm","erp","payment-gateway"]};for(const[n,i]of Object.entries(s))if(e.type===n&&i.includes(t))return!0;return e.targetComponentType===t}processFlow(e,t){if(!e.flow)return this.calculateBaseProcessingTime(e.application);let s=this.calculateBaseProcessingTime(e.application);if(e.flow.processors){const n=this.processProcessors(e.flow.processors,t,e);if(s+=n.latency,n.error)throw new Error(n.error)}return e.matchedConnector&&(s+=this.calculateConnectorLatency(e.matchedConnector)),s}processProcessors(e,t,s){let n=0;for(const i of e)try{const a=this.processProcessor(i,t,s);if(n+=a.latency,a.error)if(i.type==="try"&&i.children){if(!a.handled)return{latency:n,error:a.error}}else return{latency:n,error:a.error}}catch(a){return{latency:n,error:a instanceof Error?a.message:"Unknown error"}}return{latency:n}}calculateBaseProcessingTime(e){const t=5+Math.random()*10,s=parseFloat(e.runtimeVersion)>=4.5?.9:1;return t*s}processProcessor(e,t,s){switch(e.type){case"transform":return{latency:this.executeDataWeave(e.dataweave||"",t)};case"validate":const i=this.executeValidation(e.config||{},t);return i?{latency:1+Math.random()*2,error:i}:{latency:1+Math.random()*2};case"filter":return this.executeFilter(e.config||{},t)?{latency:.5+Math.random()*1.5}:{latency:.5+Math.random()*1.5,error:"Message filtered out"};case"enrich":return this.executeEnrich(e,t,s);case"logger":return{latency:.1+Math.random()*.4};case"choice":return this.executeChoice(e,t,s);case"try":return this.executeTryScope(e,t,s);case"set-variable":return this.setVariable(e.config||{},t),{latency:.1+Math.random()*.2};case"set-payload":return this.setPayload(e.config||{},t),{latency:.1+Math.random()*.4};case"async":return e.children?{latency:this.processProcessors(e.children,t,s).latency*.1}:{latency:.5};default:return{latency:1}}}executeDataWeave(e,t){if(!e||e.trim()==="")return 1+Math.random()*2;const s=this.calculateDataWeaveComplexity(e),n=2,i=s*3,a=Math.random()*2;return n+i+a}calculateDataWeaveComplexity(e){let t=0;const s=["map","filter","pluck","groupBy","orderBy","reduce","flatten"];for(const a of s){const o=e.match(new RegExp(`\\b${a}\\b`,"gi"));o&&(t+=o.length)}const n=(e.match(/\{/g)||[]).length;t+=Math.max(0,n-1);const i=(e.match(/\(/g)||[]).length;return t+=i*.5,Math.max(1,t)}executeValidation(e,t){return e.required&&t.body===void 0?"Required field missing":e.type&&typeof t.body!==e.type?`Type mismatch: expected ${e.type}`:e.minLength&&typeof t.body=="string"&&t.body.length<e.minLength?`String too short: minimum length ${e.minLength}`:e.maxLength&&typeof t.body=="string"&&t.body.length>e.maxLength?`String too long: maximum length ${e.maxLength}`:null}executeFilter(e,t){if(e.expression)try{return!0}catch{return!1}return!0}executeChoice(e,t,s){const n=.5+Math.random()*1.5;if(!e.children||e.children.length===0)return{latency:n};let i=null;for(const a of e.children)if(this.evaluateCondition(a.when||"",t)){i=a;break}if(!i){const a=e.children[e.children.length-1];a&&!a.when&&(i=a)}if(i&&i.children){const a=this.processProcessors(i.children,t,s);return{latency:n+a.latency,error:a.error}}return{latency:n}}evaluateCondition(e,t){return!e||e.trim()===""?!0:e.includes("payload")||e.includes("attributes")?Math.random()>.5:!0}executeTryScope(e,t,s){const n=1+Math.random()*2;if(!e.children||e.children.length===0)return{latency:n};const i=this.processProcessors(e.children,t,s);if(i.error){if(s.flow?.errorHandlers&&s.flow.errorHandlers.length>0){const a=s.flow.errorHandlers[0];if(a.type==="on-error-continue"){if(a.processors.length>0){const o=this.processProcessors(a.processors,t,s);return{latency:n+i.latency+o.latency,handled:!0}}return{latency:n+i.latency,handled:!0}}else if(a.type==="on-error-propagate")return{latency:n+i.latency,error:i.error,handled:!1}}return{latency:n+i.latency,error:i.error,handled:!1}}return{latency:n+i.latency}}setVariable(e,t){e.name&&e.value}setPayload(e,t){e.value!==void 0?t.body=e.value:e.dataweave&&this.executeDataWeave(e.dataweave,t)}executeEnrich(e,t,s){const n=e.config||{},i=n.source||"connector";let a=3;if(i==="connector"&&n.connectorName){const o=this.connectors.get(n.connectorName);if(o&&o.enabled){if(a=this.calculateConnectorLatency(o),o.config?.retryPolicy){const l=o.config.retryPolicy,d=l.maxRetries||3,h=l.retryInterval||1e3,p=l.exponentialBackoff||!1;if(Math.random()<.1)for(let v=0;v<d;v++){const b=p?h*Math.pow(2,v):h;a+=b+this.calculateConnectorLatency(o)}}}else return{latency:1,error:"Connector not found or disabled"}}else(i==="variable"||i==="payload")&&(a=1+Math.random()*2);return e.dataweave&&(a+=this.executeDataWeave(e.dataweave,t)),n.targetVariable,{latency:a}}calculateConnectorLatency(e){let s={database:10,api:20,messaging:5,file:50,custom:15}[e.type]||15;if(e.config){if(e.type==="database"&&e.config.connectionPoolSize){const i=e.config.connectionPoolSize||10;s=s*(10/Math.max(1,i))}if(e.type==="api"&&e.config.timeout){const i=e.config.timeout||3e4;s=Math.min(s*1.5,i*.001)}if(e.type==="file"&&e.config.bufferSize){const i=e.config.bufferSize||8192;s=s*(8192/Math.max(1024,i))}}const n=s*.5*Math.random();return s+n}transformData(e,t){if(e.targetComponentType){const s=this.getTargetFormat(e.targetComponentType);if(s&&s!==e.format)return{data:e.body,format:s}}return{data:e.body,format:e.format}}getTargetFormat(e){return{postgres:"json",mongodb:"json",redis:"json",rest:"json",graphql:"json",soap:"xml",grpc:"binary",kafka:"json",rabbitmq:"json"}[e]}handleError(e,t){switch(e.errorStrategy||"continue"){case"continue":return!0;case"rollback":return!1;case"propagate":return!1;default:return!1}}updateApplicationMetrics(e,t,s){const n=this.applicationMetrics.get(e);n&&(n.requestCount++,t&&n.errorCount++,n.totalLatency+=s,n.lastRequestTime=Date.now())}updateConnectorMetrics(e,t,s){const n=this.connectorMetrics.get(e);n&&(n.requestCount++,t&&n.errorCount++,n.totalLatency+=s,n.lastRequestTime=Date.now())}getStats(){let e=0,t=0,s=0;for(const a of this.applicationMetrics.values())e+=a.requestCount,t+=a.errorCount,s+=a.totalLatency;const n=Array.from(this.applications.values()).filter(a=>a.status==="running").length,i=Array.from(this.connectors.values()).filter(a=>a.enabled).length;return{applications:this.applications.size,runningApplications:n,connectors:this.connectors.size,enabledConnectors:i,totalRequests:e,totalErrors:t,avgLatency:e>0?s/e:0}}getApplicationMetrics(e){const t=this.applicationMetrics.get(e);return t?{requestCount:t.requestCount,errorCount:t.errorCount,avgLatency:t.requestCount>0?t.totalLatency/t.requestCount:0}:null}getConnectorMetrics(e){const t=this.connectorMetrics.get(e);return t?{requestCount:t.requestCount,errorCount:t.errorCount,avgLatency:t.requestCount>0?t.totalLatency/t.requestCount:0}:null}}class BE{locations=[];upstreams=new Map;rateLimitZones=new Map;sslCertificates=new Map;roundRobinCounters=new Map;connectionCounts=new Map;ipHashMap=new Map;hashRing=new Map;rateLimitCounters=new Map;cache=new Map;enableSSL=!1;sslPort=443;enableGzip=!0;enableCache=!0;maxWorkers=4;requestCount=0;cacheHits=0;cacheMisses=0;rateLimitBlocks=0;initialize(e){if(this.locations=[],this.upstreams.clear(),this.rateLimitZones.clear(),this.sslCertificates.clear(),this.roundRobinCounters.clear(),this.connectionCounts.clear(),this.ipHashMap.clear(),this.hashRing.clear(),this.rateLimitCounters.clear(),this.cache.clear(),e.locations&&(this.locations=[...e.locations].sort((t,s)=>s.path.length!==t.path.length?s.path.length-t.path.length:t.path.localeCompare(s.path))),e.upstreams){for(const t of e.upstreams)if(this.upstreams.set(t.name,{...t}),this.roundRobinCounters.set(t.name,0),t.method==="hash"&&t.servers){const s=[...t.servers].filter(n=>!n.down&&n.health!=="unhealthy").sort((n,i)=>n.address.localeCompare(i.address));this.hashRing.set(t.name,s.map(n=>n.address))}}if(e.rateLimitZones)for(const t of e.rateLimitZones)this.rateLimitZones.set(t.name,{...t});if(e.sslCertificates)for(const t of e.sslCertificates)this.sslCertificates.set(t.name,{...t});this.enableSSL=e.enableSSL??!1,this.sslPort=e.sslPort||443,this.enableGzip=e.enableGzip??!0,this.enableCache=e.enableCache??!0,this.maxWorkers=e.maxWorkers||4}routeRequest(e){const t=Date.now();if(this.requestCount++,!this.enableSSL&&e.protocol==="https")return{match:null,response:{status:400,error:"HTTPS not enabled",latency:Date.now()-t}};const s=this.matchLocation(e);if(!s)return{match:null,response:{status:404,error:"No location matched",latency:Date.now()-t}};if(s.location.rateLimit){const a=this.checkRateLimit(s.location.rateLimit,e);if(a.blocked)return this.rateLimitBlocks++,{match:s,response:{status:429,error:a.error||"Rate limit exceeded",latency:Date.now()-t}}}if(this.enableCache&&s.location.cache?.enabled&&e.method==="GET"){const a=this.getCacheKey(e,s),o=this.cache.get(a);if(o&&o.expiresAt>Date.now())return this.cacheHits++,{match:s,response:{status:200,body:o.data,latency:Date.now()-t,cacheHit:!0}};this.cacheMisses++}let n,i;switch(s.location.method){case"proxy":case"grpc":if(n=this.selectUpstreamTarget(s.location,e),!n)return{match:s,response:{status:503,error:"No healthy upstream server available",latency:Date.now()-t}};i=this.proxyRequest(e,s,n);break;case"static":i=this.serveStatic(e,s);break;case"fastcgi":case"uwsgi":case"scgi":if(n=this.selectUpstreamTarget(s.location,e),!n)return{match:s,response:{status:503,error:"No upstream server available",latency:Date.now()-t}};i=this.processFastCGI(e,s,n);break;default:i={status:501,error:"Method not implemented",latency:Date.now()-t}}if(this.enableGzip&&this.shouldCompress(i)&&(i.headers={...i.headers,"Content-Encoding":"gzip"}),this.enableCache&&s.location.cache?.enabled&&e.method==="GET"&&i.status===200){const a=this.getCacheKey(e,s),o=this.parseCacheValid(s.location.cache.valid||"1h");this.cache.set(a,{data:i.body,expiresAt:Date.now()+o})}return i.latency=Date.now()-t,i.upstreamTarget=n,{match:s,response:i,upstreamTarget:n}}matchLocation(e){for(const t of this.locations){const s=this.matchPath(t.path,e.path);if(s)return{location:t,matchedPath:s.matched,remainingPath:s.remaining,priority:this.getLocationPriority(t.path)}}return null}matchPath(e,t){const s=e.replace(/^[=~*^]/,""),n=e[0];switch(n){case"=":if(t===s)return{matched:t,remaining:""};break;case"~":case"~*":try{if(new RegExp(s,n==="~*"?"i":"").test(t))return{matched:t,remaining:""}}catch{}break;case"^~":case"*":default:if(t.startsWith(s))return{matched:s,remaining:t.substring(s.length)}}return null}getLocationPriority(e){return e.startsWith("=")?4:e.startsWith("^~")?3:e.startsWith("~")||e.startsWith("~*")?2:1}selectUpstreamTarget(e,t){const s=e.upstream||this.extractUpstreamFromProxyPass(e.proxyPass);if(!s)return e.proxyPass||null;const n=this.upstreams.get(s);if(!n||!n.servers||n.servers.length===0)return null;const i=n.servers.filter(o=>!o.down&&o.health!=="unhealthy");if(i.length===0)return null;switch(n.method||"round-robin"){case"round-robin":return this.selectRoundRobin(s,i);case"least_conn":return this.selectLeastConnections(i);case"ip_hash":return this.selectIPHash(s,i,t);case"hash":return this.selectHash(s,i,t);default:return i[0].address}}selectRoundRobin(e,t){const s=t.reduce((a,o)=>a+(o.weight||1),0);let n=this.roundRobinCounters.get(e)||0,i=0;for(const a of t)if(i+=a.weight||1,n<i)return this.roundRobinCounters.set(e,(n+1)%s),a.address;return this.roundRobinCounters.set(e,(n+1)%s),t[0].address}selectLeastConnections(e){let t=1/0,s=e[0].address;for(const i of e){const o=(this.connectionCounts.get(i.address)||0)/(i.weight||1);o<t&&(t=o,s=i.address)}const n=this.connectionCounts.get(s)||0;return this.connectionCounts.set(s,n+1),s}selectIPHash(e,t,s){const n=s.clientIP||s.headers?.["X-Real-IP"]||s.headers?.["X-Forwarded-For"]||"0.0.0.0",i=this.ipHashMap.get(n);if(i&&t.some(d=>d.address===i))return i;const o=this.simpleHash(n)%t.length,l=t[o].address;return this.ipHashMap.set(n,l),l}selectHash(e,t,s){const n=this.hashRing.get(e);if(!n||n.length===0)return t[0].address;const i=s.path,o=this.simpleHash(i)%n.length;return n[o]}simpleHash(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t=t&t}return Math.abs(t)}extractUpstreamFromProxyPass(e){if(!e)return null;const t=e.match(/^https?:\/\/([^\/:]+)/);return t&&this.upstreams.has(t[1])?t[1]:null}checkRateLimit(e,t){const s=this.rateLimitZones.get(e.zone);if(!s)return{blocked:!1};const n=s.rate.match(/^(\d+)r\/([smhd])$/);if(!n)return{blocked:!1};const i=parseInt(n[1],10),a=n[2],o=this.getPeriodMs(a),l=t.clientIP||t.headers?.["X-Real-IP"]||"default";let d=this.rateLimitCounters.get(e.zone);d||(d=new Map,this.rateLimitCounters.set(e.zone,d));let h=d.get(l);const p=Date.now();(!h||h.resetAt<p)&&(h={count:0,resetAt:p+o,burst:e.burst||0},d.set(l,h));const g=e.burst||0,v=i+g;return h.count>=v?{blocked:!0,error:`Rate limit exceeded: ${i} requests per ${a}`}:(h.count++,{blocked:!1})}getPeriodMs(e){switch(e){case"s":return 1e3;case"m":return 6e4;case"h":return 36e5;case"d":return 864e5;default:return 1e3}}proxyRequest(e,t,s){const n=10+Math.random()*90;return{status:200,body:{proxied:!0,upstream:s},latency:n}}serveStatic(e,t){const s=1+Math.random()*4;return{status:200,body:{static:!0,path:t.matchedPath},latency:s}}processFastCGI(e,t,s){const n=20+Math.random()*180;return{status:200,body:{processed:!0,upstream:s},latency:n}}getCacheKey(e,t){return t.location.cache?.key?t.location.cache.key.replace(/\$(\w+)/g,(s,n)=>{switch(n){case"uri":return e.path;case"args":return JSON.stringify(e.query);default:return""}}):`${e.method}:${e.path}:${JSON.stringify(e.query)}`}parseCacheValid(e){const t=e.match(/^(\d+)([smhd])$/);if(!t)return 36e5;const s=parseInt(t[1],10),n=t[2];return s*this.getPeriodMs(n)}shouldCompress(e){if(!e.body)return!1;const t=e.headers?.["Content-Type"]||"";return["text/","application/json","application/javascript","application/xml"].some(n=>t.includes(n))}getStats(){const e=this.cacheHits+this.cacheMisses,t=e>0?this.cacheHits/e:0;return{locations:this.locations.length,upstreams:this.upstreams.size,rateLimitZones:this.rateLimitZones.size,sslCertificates:this.sslCertificates.size,requests:this.requestCount,cacheHits:this.cacheHits,cacheMisses:this.cacheMisses,rateLimitBlocks:this.rateLimitBlocks,cacheHitRate:t}}updateServerHealth(e,t,s){const n=this.upstreams.get(e);if(!n)return;const i=n.servers.find(a=>a.address===t);i&&(i.health=s)}clearCache(){this.cache.clear(),this.cacheHits=0,this.cacheMisses=0}}class UE{frontends=new Map;backends=new Map;globalConfig={};roundRobinCounters=new Map;connectionCounts=new Map;sourceHashMap=new Map;uriHashMap=new Map;stickTable=new Map;requestCount=0;responseCount=0;errorCount=0;totalBytesIn=0;totalBytesOut=0;activeConnections=0;rateLimitBlocks=0;timeoutErrors=0;connectionRejects=0;healthCheckTimers=new Map;serverCheckFailures=new Map;serverCheckSuccesses=new Map;rateLimitTracker=new Map;initialize(e){this.frontends.clear(),this.backends.clear(),this.roundRobinCounters.clear(),this.connectionCounts.clear(),this.sourceHashMap.clear(),this.uriHashMap.clear(),this.stickTable.clear(),this.serverCheckFailures.clear(),this.serverCheckSuccesses.clear(),this.rateLimitTracker.clear(),this.globalConfig=e.globalConfig||{};for(const t of this.healthCheckTimers.values())clearInterval(t);if(this.healthCheckTimers.clear(),e.frontends)for(const t of e.frontends)this.frontends.set(t.name,{...t,acls:t.acls||[]});if(e.backends){for(const t of e.backends)if(this.backends.set(t.name,{...t,acls:t.acls||[]}),this.roundRobinCounters.set(t.name,0),t.healthCheck?.enabled&&t.servers)for(const s of t.servers)s.check&&this.startHealthCheck(t.name,s,t.healthCheck)}this.requestCount=0,this.responseCount=0,this.errorCount=0,this.totalBytesIn=0,this.totalBytesOut=0,this.activeConnections=0,this.rateLimitBlocks=0,this.timeoutErrors=0,this.connectionRejects=0}routeRequest(e,t){const s=Date.now();this.requestCount++;const n=this.globalConfig.maxConnections||4096;if(this.activeConnections>=n)return this.connectionRejects++,this.errorCount++,{frontend:null,backend:null,response:{status:503,error:"Max connections exceeded",latency:Date.now()-s}};if(this.activeConnections++,this.globalConfig.rateLimit?.enabled&&!this.checkRateLimit(e).allowed)return this.activeConnections--,this.rateLimitBlocks++,this.errorCount++,{frontend:null,backend:null,response:{status:429,error:"Rate limit exceeded",latency:Date.now()-s}};let i=null;if(t)i=this.frontends.get(t)||null;else{for(const[T,E]of this.frontends.entries()){const A=this.extractPort(E.bind);if(e.protocol==="https"&&A===443){i=E;break}else if(e.protocol==="http"&&A===80){i=E;break}}!i&&this.frontends.size>0&&(i=Array.from(this.frontends.values())[0])}if(!i)return this.activeConnections--,{frontend:null,backend:null,response:{status:503,error:"No frontend available",latency:Date.now()-s}};if(i.acls&&i.acls.length>0){const T=this.evaluateACLs(i.acls,e);if(!T.matched)return this.activeConnections--,this.errorCount++,{frontend:i,backend:null,response:{status:403,error:T.error||"ACL rule denied",latency:Date.now()-s}}}const a=i.defaultBackend||(i.backends&&i.backends.length>0?i.backends[0]:null);if(!a)return this.activeConnections--,this.errorCount++,{frontend:i,backend:null,response:{status:503,error:"No backend configured",latency:Date.now()-s}};const o=this.backends.get(a);if(!o)return this.activeConnections--,this.errorCount++,{frontend:i,backend:null,response:{status:503,error:`Backend ${a} not found`,latency:Date.now()-s}};if(o.acls&&o.acls.length>0){const T=this.evaluateACLs(o.acls,e);if(!T.matched)return this.activeConnections--,this.errorCount++,{frontend:i,backend:o,response:{status:403,error:T.error||"Backend ACL rule denied",latency:Date.now()-s}}}const l=this.selectServer(o,e);if(!l)return this.activeConnections--,this.errorCount++,{frontend:i,backend:o,response:{status:503,error:"No healthy server available",latency:Date.now()-s}};const d=o.servers.find(T=>`${T.address}:${T.port}`===l);if(d){d.sessions=(d.sessions||0)+1;const T=this.connectionCounts.get(l)||0;this.connectionCounts.set(l,T+1)}const h=10+Math.random()*90,p=i.ssl?5+Math.random()*15:0,g=this.globalConfig.timeoutServer||5e4,v=this.globalConfig.timeoutConnect||5e3,b=this.globalConfig.timeoutHttpRequest||1e4,M=Math.min(50+Math.random()*100,v);if(M>=v*.9)return this.activeConnections--,this.timeoutErrors++,this.errorCount++,d&&(d.errors=(d.errors||0)+1),{frontend:i,backend:o,response:{status:504,error:"Connection timeout",latency:v,backendTarget:a,serverTarget:l}};const x=M+h+p;if(x>g)return this.activeConnections--,this.timeoutErrors++,this.errorCount++,d&&(d.errors=(d.errors||0)+1),{frontend:i,backend:o,response:{status:504,error:"Server timeout",latency:g,backendTarget:a,serverTarget:l}};if(x>b)return this.activeConnections--,this.timeoutErrors++,this.errorCount++,d&&(d.errors=(d.errors||0)+1),{frontend:i,backend:o,response:{status:408,error:"Request timeout",latency:b,backendTarget:a,serverTarget:l}};const S={status:200,body:{proxied:!0,backend:a,server:l},latency:x,backendTarget:a,serverTarget:l};return d&&(d.bytesIn=(d.bytesIn||0)+1024,d.bytesOut=(d.bytesOut||0)+2048,d.responseTime=x,this.totalBytesIn+=1024,this.totalBytesOut+=2048),this.responseCount++,this.activeConnections--,{frontend:i,backend:o,response:S,backendTarget:a,serverTarget:l}}selectServer(e,t){const s=e.servers.filter(a=>a.status==="up"&&a.check!==!1);if(s.length===0)return null;if(e.stickTable?.enabled){const a=this.getStickTableKey(t,e.stickTable.type),o=this.stickTable.get(a);if(o&&o.expiresAt>Date.now()&&s.find(d=>`${d.address}:${d.port}`===o.server))return o.server}const n=e.balance||"roundrobin";let i;switch(n){case"roundrobin":i=this.selectRoundRobin(e.name,s);break;case"leastconn":i=this.selectLeastConnections(s);break;case"source":i=this.selectSourceIP(e.name,s,t);break;case"uri":i=this.selectURIHash(e.name,s,t);break;case"hdr":i=this.selectHeaderHash(e.name,s,t);break;default:i=`${s[0].address}:${s[0].port}`}if(e.stickTable?.enabled&&i){const a=this.getStickTableKey(t,e.stickTable.type),o=(e.stickTable.expire||3600)*1e3;this.stickTable.set(a,{server:i,expiresAt:Date.now()+o})}return i}selectRoundRobin(e,t){const s=t.reduce((a,o)=>a+(o.weight||1),0);let n=this.roundRobinCounters.get(e)||0,i=0;for(const a of t)if(i+=a.weight||1,n<i)return this.roundRobinCounters.set(e,(n+1)%s),`${a.address}:${a.port}`;return this.roundRobinCounters.set(e,(n+1)%s),`${t[0].address}:${t[0].port}`}selectLeastConnections(e){let t=1/0,s=e[0];for(const n of e){const i=`${n.address}:${n.port}`,o=(this.connectionCounts.get(i)||n.sessions||0)/(n.weight||1);o<t&&(t=o,s=n)}return`${s.address}:${s.port}`}selectSourceIP(e,t,s){const n=s.clientIP||s.headers?.["X-Real-IP"]||s.headers?.["X-Forwarded-For"]||"0.0.0.0",i=this.sourceHashMap.get(`${e}:${n}`);if(i&&t.some(d=>`${d.address}:${d.port}`===i))return i;const o=this.simpleHash(n)%t.length,l=`${t[o].address}:${t[o].port}`;return this.sourceHashMap.set(`${e}:${n}`,l),l}selectURIHash(e,t,s){const n=s.path,i=`${e}:${n}`,a=this.uriHashMap.get(i);if(a&&t.some(h=>`${h.address}:${h.port}`===a))return a;const l=this.simpleHash(n)%t.length,d=`${t[l].address}:${t[l].port}`;return this.uriHashMap.set(i,d),d}selectHeaderHash(e,t,s){const n=s.host||s.headers?.Host||s.path,a=this.simpleHash(n)%t.length;return`${t[a].address}:${t[a].port}`}simpleHash(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t=t&t}return Math.abs(t)}getStickTableKey(e,t){switch(t){case"ip":return e.clientIP||e.headers?.["X-Real-IP"]||"0.0.0.0";case"string":return e.host||e.headers?.Host||"";case"integer":return e.headers?.["X-Forwarded-Port"]||"0";default:return e.clientIP||"0.0.0.0"}}evaluateACLs(e,t){for(const s of e)if(!this.evaluateACL(s,t).matched)return{matched:!1,error:`ACL ${s.name} failed`};return{matched:!0}}evaluateACL(e,t){const s=e.operator||"eq",n=e.value||"";if(e.criterion.startsWith("hdr(")){const i=e.criterion.match(/hdr\(([^)]+)\)/)?.[1];if(i){const a=(t.headers?.[i.toLowerCase()]||"").toLowerCase(),o=n.toLowerCase();return{matched:this.compareValues(a,o,s)}}}else{if(e.criterion==="path_beg")return{matched:t.path.toLowerCase().startsWith(n.toLowerCase())};if(e.criterion==="path_end")return{matched:t.path.toLowerCase().endsWith(n.toLowerCase())};if(e.criterion==="path")return{matched:this.compareValues(t.path.toLowerCase(),n.toLowerCase(),s)};if(e.criterion==="src"){const i=t.clientIP||t.headers?.["X-Real-IP"]||t.headers?.["X-Forwarded-For"]||"0.0.0.0";if(n.includes("/")){const[a,o]=n.split("/");return{matched:this.isIPInCIDR(i,a,parseInt(o||"32",10))}}else return{matched:this.compareValues(i,n,s)}}else{if(e.criterion==="method")return{matched:this.compareValues(t.method.toUpperCase(),n.toUpperCase(),s)};if(e.criterion==="url_param"){const i=n.split("=")[0],a=n.split("=")[1]||"",o=t.query?.[i]||"";return a?{matched:this.compareValues(o,a,s)}:{matched:!!o}}}}return{matched:!0}}compareValues(e,t,s){switch(s){case"eq":return e===t;case"ne":return e!==t;case"beg":return e.startsWith(t);case"end":return e.endsWith(t);case"sub":return e.includes(t);case"gt":return parseFloat(e)>parseFloat(t);case"lt":return parseFloat(e)<parseFloat(t);case"gte":return parseFloat(e)>=parseFloat(t);case"lte":return parseFloat(e)<=parseFloat(t);default:return e===t}}isIPInCIDR(e,t,s){if(s===32)return e===t;const n=e.split("."),i=t.split(".");if(n.length!==4||i.length!==4)return!1;const a=Math.floor(s/8);for(let o=0;o<a;o++)if(n[o]!==i[o])return!1;return!0}checkRateLimit(e){if(!this.globalConfig.rateLimit?.enabled)return{allowed:!0};const t=this.globalConfig.rateLimit,s=t.rate||"10r/s",n=t.burst||5,i=s.match(/(\d+)r\/([smh])/);if(!i)return{allowed:!0};const a=parseInt(i[1],10),o=i[2];let l=1e3;switch(o){case"s":l=1e3;break;case"m":l=6e4;break;case"h":l=36e5;break}const d=e.clientIP||e.headers?.["X-Real-IP"]||e.headers?.["X-Forwarded-For"]||"0.0.0.0",h=Date.now(),p=d;let g=this.rateLimitTracker.get(p);return(!g||h>=g.resetAt)&&(g={count:0,resetAt:h+l}),g.count>=a+n?{allowed:!1}:(g.count++,this.rateLimitTracker.set(p,g),{allowed:!0})}startHealthCheck(e,t,s){const n=`${e}:${t.address}:${t.port}`,i=this.healthCheckTimers.get(n);i&&clearInterval(i);const a=s.interval||2e3,o=s.timeout||1e3,l=s.fall||3,d=s.rise||2,h=setInterval(()=>{t.lastCheck=Date.now(),t.checkStatus="checking";const p=Math.random()>.1;setTimeout(()=>{if(p){const g=(this.serverCheckSuccesses.get(n)||0)+1;this.serverCheckSuccesses.set(n,g),this.serverCheckFailures.set(n,0),t.status==="down"&&g>=d?(t.status="up",t.checkStatus="passed"):t.status==="up"&&(t.checkStatus="passed")}else{const g=(this.serverCheckFailures.get(n)||0)+1;this.serverCheckFailures.set(n,g),this.serverCheckSuccesses.set(n,0),t.status==="up"&&g>=l?(t.status="down",t.checkStatus="failed"):t.status==="down"&&(t.checkStatus="failed")}},o)},a);this.healthCheckTimers.set(n,h)}extractPort(e){const t=e.match(/:(\d+)$/);return t?parseInt(t[1],10):80}getStats(){let e=0,t=0,s=0;for(const i of this.backends.values()){e+=i.servers.length;for(const a of i.servers)a.status==="up"?t++:s++}const n=this.requestCount>0?this.errorCount/this.requestCount:0;return{frontends:this.frontends.size,backends:this.backends.size,totalServers:e,upServers:t,downServers:s,totalRequests:this.requestCount,totalResponses:this.responseCount,activeConnections:this.activeConnections,totalBytesIn:this.totalBytesIn,totalBytesOut:this.totalBytesOut,errorRate:n,rateLimitBlocks:this.rateLimitBlocks,timeoutErrors:this.timeoutErrors,connectionRejects:this.connectionRejects}}getFrontendStats(e){const t=this.frontends.get(e);return t?{requests:t.requests||0,responses:t.responses||0,bytesIn:t.bytesIn||0,bytesOut:t.bytesOut||0}:null}getBackendStats(e){const t=this.backends.get(e);if(!t)return null;let s=0,n=0,i=0,a=0,o=0,l=0;for(const d of t.servers)d.status==="up"?s++:n++,i+=d.sessions||0,a+=d.bytesIn||0,o+=d.bytesOut||0,l+=d.errors||0;return{servers:t.servers.length,upServers:s,downServers:n,totalSessions:i,totalBytesIn:a,totalBytesOut:o,totalErrors:l}}updateServerStatus(e,t,s){const n=this.backends.get(e);if(!n)return;const i=n.servers.find(a=>a.id===t);i&&(i.status=s)}destroy(){for(const e of this.healthCheckTimers.values())clearInterval(e);this.healthCheckTimers.clear()}}class FE{clusters=new Map;listeners=new Map;routes=new Map;globalConfig={};roundRobinCounters=new Map;leastRequestCounts=new Map;connectionCounts=new Map;ringHashMapping=new Map;maglevTable=new Map;circuitBreakerState=new Map;outlierDetectionState=new Map;requestCount=0;responseCount=0;errorCount=0;totalBytesIn=0;totalBytesOut=0;activeConnections=0;rateLimitBlocks=0;timeoutErrors=0;circuitBreakerTrips=0;healthCheckTimers=new Map;endpointCheckFailures=new Map;endpointCheckSuccesses=new Map;rateLimitTracker=new Map;initialize(e){this.clusters.clear(),this.listeners.clear(),this.routes.clear(),this.roundRobinCounters.clear(),this.leastRequestCounts.clear(),this.connectionCounts.clear(),this.ringHashMapping.clear(),this.maglevTable.clear(),this.circuitBreakerState.clear(),this.outlierDetectionState.clear(),this.endpointCheckFailures.clear(),this.endpointCheckSuccesses.clear(),this.rateLimitTracker.clear(),this.globalConfig=e.globalConfig||{};for(const t of this.healthCheckTimers.values())clearInterval(t);if(this.healthCheckTimers.clear(),e.clusters)for(const t of e.clusters){if(this.clusters.set(t.name,{...t}),this.roundRobinCounters.set(t.name,0),this.leastRequestCounts.set(t.name,new Map),this.circuitBreakerState.set(t.name,{isOpen:!1,consecutiveErrors:0}),this.outlierDetectionState.set(t.name,new Map),t.healthCheck?.enabled&&t.endpoints)for(const s of t.endpoints){const n=`${s.address}:${s.port}`;this.leastRequestCounts.get(t.name).set(n,0),this.startHealthCheck(t.name,s,t.healthCheck)}else for(const s of t.endpoints){const n=`${s.address}:${s.port}`;this.leastRequestCounts.get(t.name).set(n,0)}(t.loadBalancingPolicy==="RING_HASH"||t.loadBalancingPolicy==="MAGLEV")&&this.buildHashTable(t.name,t)}if(e.listeners)for(const t of e.listeners)this.listeners.set(t.name,{...t});if(e.routes){const t=[...e.routes].sort((s,n)=>(n.priority||0)-(s.priority||0));for(const s of t)this.routes.set(s.name,{...s})}this.requestCount=0,this.responseCount=0,this.errorCount=0,this.totalBytesIn=0,this.totalBytesOut=0,this.activeConnections=0,this.rateLimitBlocks=0,this.timeoutErrors=0,this.circuitBreakerTrips=0}routeRequest(e,t){const s=Date.now();this.requestCount++;const n=this.globalConfig.maxConnections||1024;if(this.activeConnections>=n)return this.errorCount++,{listener:null,route:null,cluster:null,response:{status:503,error:"Max connections exceeded",latency:Date.now()-s}};if(this.activeConnections++,this.globalConfig.rateLimit?.enabled&&!this.checkRateLimit(e).allowed)return this.activeConnections--,this.rateLimitBlocks++,this.errorCount++,{listener:null,route:null,cluster:null,response:{status:429,error:"Rate limit exceeded",latency:Date.now()-s}};let i=null;if(t)i=this.listeners.get(t)||null;else{for(const[k,D]of this.listeners.entries()){const L=D.protocol||"HTTP";if(e.protocol==="https"&&(L==="HTTPS"||D.port===443)){i=D;break}else if(e.protocol==="http"&&(L==="HTTP"||D.port===80)){i=D;break}}!i&&this.listeners.size>0&&(i=Array.from(this.listeners.values())[0])}if(!i)return this.activeConnections--,this.errorCount++,{listener:null,route:null,cluster:null,response:{status:503,error:"No listener available",latency:Date.now()-s}};i.requests=(i.requests||0)+1,i.activeConnections=(i.activeConnections||0)+1;for(const k of i.filters){const D=this.processFilter(k,e);if(!D.allowed)return this.activeConnections--,this.errorCount++,i.activeConnections=(i.activeConnections||1)-1,{listener:i,route:null,cluster:null,response:{status:D.status||403,error:D.error||"Filter denied",latency:Date.now()-s}};D.modifiedRequest&&(e=D.modifiedRequest)}let a=null;for(const k of this.routes.values())if(this.matchRoute(k,e)){a=k;break}if(!a)return this.activeConnections--,this.errorCount++,i.activeConnections=(i.activeConnections||1)-1,{listener:i,route:null,cluster:null,response:{status:404,error:"No route matched",latency:Date.now()-s}};a.requests=(a.requests||0)+1;const o=this.clusters.get(a.cluster);if(!o)return this.activeConnections--,this.errorCount++,a.errors=(a.errors||0)+1,i.activeConnections=(i.activeConnections||1)-1,{listener:i,route:a,cluster:null,response:{status:503,error:`Cluster ${a.cluster} not found`,latency:Date.now()-s}};const l=this.circuitBreakerState.get(o.name);if(l&&o.circuitBreaker?.enabled&&l.isOpen){if(l.openUntil&&Date.now()<l.openUntil)return this.activeConnections--,this.errorCount++,a.errors=(a.errors||0)+1,o.errors=(o.errors||0)+1,i.activeConnections=(i.activeConnections||1)-1,{listener:i,route:a,cluster:o,response:{status:503,error:"Circuit breaker is open",latency:Date.now()-s,clusterTarget:o.name}};l.isOpen=!1,l.consecutiveErrors=0}const d=this.selectEndpoint(o,e);if(!d)return this.activeConnections--,this.errorCount++,a.errors=(a.errors||0)+1,o.errors=(o.errors||0)+1,i.activeConnections=(i.activeConnections||1)-1,{listener:i,route:a,cluster:o,response:{status:503,error:"No healthy endpoint available",latency:Date.now()-s,clusterTarget:o.name}};o.requests=(o.requests||0)+1,o.activeConnections=(o.activeConnections||0)+1;const h=o.endpoints.find(k=>`${k.address}:${k.port}`===d);h&&(h.requests=(h.requests||0)+1);const p=o.connectTimeout||this.globalConfig.connectTimeout||5e3,g=a.timeout||this.globalConfig.requestTimeout||15e3,v=Math.min(50+Math.random()*100,p);if(v>=p*.9)return this.activeConnections--,this.timeoutErrors++,this.errorCount++,a.errors=(a.errors||0)+1,o.errors=(o.errors||0)+1,o.activeConnections=(o.activeConnections||1)-1,i.activeConnections=(i.activeConnections||1)-1,h&&(h.errors=(h.errors||0)+1,this.updateOutlierDetection(o.name,d,!0)),{listener:i,route:a,cluster:o,response:{status:504,error:"Connection timeout",latency:p,clusterTarget:o.name,endpointTarget:d}};const b=10+Math.random()*90,M=v+b;if(M>g)return this.activeConnections--,this.timeoutErrors++,this.errorCount++,a.errors=(a.errors||0)+1,o.errors=(o.errors||0)+1,o.activeConnections=(o.activeConnections||1)-1,i.activeConnections=(i.activeConnections||1)-1,h&&(h.errors=(h.errors||0)+1,this.updateOutlierDetection(o.name,d,!0)),{listener:i,route:a,cluster:o,response:{status:504,error:"Request timeout",latency:g,clusterTarget:o.name,endpointTarget:d}};const x=Math.random()>.1,S=x?200:500+Math.floor(Math.random()*3);x?(this.updateCircuitBreaker(o.name,!1),this.responseCount++,a.responses=(a.responses||0)+1):(this.errorCount++,a.errors=(a.errors||0)+1,o.errors=(o.errors||0)+1,h&&(h.errors=(h.errors||0)+1,this.updateOutlierDetection(o.name,d,!0)),this.updateCircuitBreaker(o.name,!0));const T=1024,E=2048;this.totalBytesIn+=T,this.totalBytesOut+=E,h&&(h.responseTime=M),this.activeConnections--,i.activeConnections=(i.activeConnections||1)-1,o.activeConnections=(o.activeConnections||1)-1;const A={status:S,body:{proxied:!0,cluster:o.name,endpoint:d},latency:M,clusterTarget:o.name,endpointTarget:d};return{listener:i,route:a,cluster:o,response:A,clusterTarget:o.name,endpointTarget:d}}matchRoute(e,t){const s=e.match;if(s.prefix&&!t.path.startsWith(s.prefix)||s.path&&t.path!==s.path||s.regex&&!new RegExp(s.regex).test(t.path))return!1;if(s.headers)for(const n of s.headers){const i=t.headers?.[QE(n.name)]||"";if(n.exact&&i!==n.exact||n.prefix&&!i.startsWith(n.prefix)||n.suffix&&!i.endsWith(n.suffix)||n.regex&&!new RegExp(n.regex).test(i))return!1}if(s.queryParameters)for(const n of s.queryParameters){const i=t.query?.[n.name]||"";if(n.exact&&i!==n.exact||n.regex&&!new RegExp(n.regex).test(i))return!1}return!0}processFilter(e,t){switch(e.type){case"http_connection_manager":return{allowed:!0};case"tls_inspector":return t.protocol==="https"?{allowed:!0}:{allowed:!0};case"router":return{allowed:!0};case"cors":return{allowed:!0,modifiedRequest:t};case"ratelimit":return{allowed:!0};case"fault":const s=e.config?.faultRate||0;return Math.random()<s?{allowed:!1,status:e.config?.faultStatusCode||503,error:"Fault injected"}:{allowed:!0};case"ext_authz":return{allowed:!0};default:return{allowed:!0}}}selectEndpoint(e,t){const s=e.endpoints.filter(a=>{const o=`${a.address}:${a.port}`,l=this.outlierDetectionState.get(e.name)?.get(o);return l?.ejectedUntil&&Date.now()<l.ejectedUntil?!1:a.healthStatus!=="unhealthy"&&a.healthStatus!=="timeout"});if(s.length===0)return null;const n=e.loadBalancingPolicy||"ROUND_ROBIN";let i;switch(n){case"ROUND_ROBIN":i=this.selectRoundRobin(e.name,s);break;case"LEAST_REQUEST":i=this.selectLeastRequest(e.name,s);break;case"RING_HASH":case"MAGLEV":i=this.selectHashBased(e.name,s,t);break;case"RANDOM":i=s[Math.floor(Math.random()*s.length)];break;default:i=s[0]}return`${i.address}:${i.port}`}selectRoundRobin(e,t){const s=t.reduce((a,o)=>a+(o.weight||1),0);let n=this.roundRobinCounters.get(e)||0,i=0;for(const a of t)if(i+=a.weight||1,n<i)return this.roundRobinCounters.set(e,(n+1)%s),a;return this.roundRobinCounters.set(e,(n+1)%s),t[0]}selectLeastRequest(e,t){const s=this.leastRequestCounts.get(e)||new Map;let n=1/0,i=t[0];for(const l of t){const d=`${l.address}:${l.port}`,p=(s.get(d)||0)/(l.weight||1);p<n&&(n=p,i=l)}const a=`${i.address}:${i.port}`,o=s.get(a)||0;return s.set(a,o+1),i}selectHashBased(e,t,s){const n=s.host||s.path||s.clientIP||"default",a=this.simpleHash(n)%t.length;return t[a]}simpleHash(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t=t&t}return Math.abs(t)}buildHashTable(e,t){const s=t.endpoints.map(n=>`${n.address}:${n.port}`);this.ringHashMapping.set(e,s)}checkRateLimit(e){if(!this.globalConfig.rateLimit?.enabled)return{allowed:!0};const t=this.globalConfig.rateLimit.rate||100,s=this.globalConfig.rateLimit.burst||10,n=e.clientIP||e.headers?.["X-Real-IP"]||e.headers?.["X-Forwarded-For"]||"0.0.0.0",i=Date.now(),a=n;let o=this.rateLimitTracker.get(a);return(!o||i>=o.resetAt)&&(o={count:0,resetAt:i+1e3}),o.count>=t+s?{allowed:!1}:(o.count++,this.rateLimitTracker.set(a,o),{allowed:!0})}updateCircuitBreaker(e,t){const s=this.clusters.get(e);if(!s||!s.circuitBreaker?.enabled)return;const n=this.circuitBreakerState.get(e);if(n)if(t){n.consecutiveErrors++;const i=s.circuitBreaker.consecutiveErrors||5;n.consecutiveErrors>=i&&!n.isOpen&&(n.isOpen=!0,n.openUntil=Date.now()+3e4,this.circuitBreakerTrips++)}else n.consecutiveErrors=0,n.isOpen&&(n.isOpen=!1,n.openUntil=void 0)}updateOutlierDetection(e,t,s){const n=this.clusters.get(e);if(!n||!n.outlierDetection?.enabled)return;let i=this.outlierDetectionState.get(e);i||(i=new Map,this.outlierDetectionState.set(e,i));let a=i.get(t);if(a||(a={consecutiveErrors:0},i.set(t,a)),s){a.consecutiveErrors++;const o=n.outlierDetection.consecutiveErrors||5,l=n.outlierDetection.baseEjectionTime||3e4;if(a.consecutiveErrors>=o){a.ejectedUntil=Date.now()+l;const d=n.endpoints.find(h=>`${h.address}:${h.port}`===t);d&&(d.healthStatus="unhealthy")}}else if(a.consecutiveErrors=0,a.ejectedUntil&&Date.now()>=a.ejectedUntil){a.ejectedUntil=void 0;const o=n.endpoints.find(l=>`${l.address}:${l.port}`===t);o&&(o.healthStatus="healthy")}}startHealthCheck(e,t,s){const n=`${e}:${t.address}:${t.port}`,i=this.healthCheckTimers.get(n);i&&clearInterval(i);const a=s.interval||1e4,o=s.timeout||5e3,l=s.healthyThreshold||1,d=s.unhealthyThreshold||2,h=setInterval(()=>{t.lastCheck=Date.now();const p=Math.random()>.1;setTimeout(()=>{if(p){const g=(this.endpointCheckSuccesses.get(n)||0)+1;this.endpointCheckSuccesses.set(n,g),this.endpointCheckFailures.set(n,0),(t.healthStatus==="unhealthy"&&g>=l||!t.healthStatus||t.healthStatus==="unknown")&&(t.healthStatus="healthy")}else{const g=(this.endpointCheckFailures.get(n)||0)+1;this.endpointCheckFailures.set(n,g),this.endpointCheckSuccesses.set(n,0),(t.healthStatus==="healthy"&&g>=d||!t.healthStatus||t.healthStatus==="unknown")&&(t.healthStatus="unhealthy")}},o)},a);this.healthCheckTimers.set(n,h)}getStats(){let e=0,t=0,s=0;for(const i of this.clusters.values()){e+=i.endpoints.length;for(const a of i.endpoints)a.healthStatus==="healthy"?t++:a.healthStatus==="unhealthy"&&s++}const n=this.requestCount>0?this.errorCount/this.requestCount:0;return{clusters:this.clusters.size,listeners:this.listeners.size,routes:this.routes.size,totalEndpoints:e,healthyEndpoints:t,unhealthyEndpoints:s,totalRequests:this.requestCount,totalResponses:this.responseCount,activeConnections:this.activeConnections,totalBytesIn:this.totalBytesIn,totalBytesOut:this.totalBytesOut,errorRate:n,rateLimitBlocks:this.rateLimitBlocks,timeoutErrors:this.timeoutErrors,circuitBreakerTrips:this.circuitBreakerTrips}}getClusterStats(e){const t=this.clusters.get(e);if(!t)return null;let s=0,n=0;for(const i of t.endpoints)i.healthStatus==="healthy"?s++:i.healthStatus==="unhealthy"&&n++;return{requests:t.requests||0,errors:t.errors||0,activeConnections:t.activeConnections||0,healthyEndpoints:s,unhealthyEndpoints:n}}getListenerStats(e){const t=this.listeners.get(e);return t?{activeConnections:t.activeConnections||0,requests:t.requests||0,responses:t.responses||0}:null}getRouteStats(e){const t=this.routes.get(e);return t?{requests:t.requests||0,responses:t.responses||0,errors:t.errors||0}:null}destroy(){for(const e of this.healthCheckTimers.values())clearInterval(e);this.healthCheckTimers.clear()}}function QE(c){return c.toLowerCase()}class VE{parseQuery(e){const t=e.query.trim(),s=this.extractOperationType(t),n=e.operationName||this.extractOperationName(t),i=this.extractFields(t),a=this.calculateDepth(t),o=this.estimateComplexity(t,n);return{operationName:n,operationType:s,fields:i,depth:a,complexity:o,rawQuery:t}}extractOperationType(e){const t=e.trim();return t.startsWith("mutation")?"mutation":t.startsWith("subscription")?"subscription":"query"}extractOperationName(e){const t=e.match(/(?:query|mutation|subscription)\s+([a-zA-Z0-9_]+)/);return t?t[1]:void 0}extractFields(e){const t=[],s=/([a-zA-Z0-9_]+)\s*(?:\(|\{)/g;let n;for(;(n=s.exec(e))!==null;)t.push(n[1]);return t.length>0?t:["unknown"]}calculateDepth(e){let t=0,s=0;for(const n of e)n==="{"?(t+=1,s=Math.max(s,t)):n==="}"&&(t=Math.max(0,t-1));return s}estimateComplexity(e,t){const s=e.match(/[a-zA-Z0-9_]+(\s*[({])/g),n=s?s.length:5,i=this.calculateDepth(e),a=t?Math.max(1,t.length%5):1;return Math.round(n*(1+i*.5)*a*10)}}class GE{federationConfig;variability;constructor(e,t){this.federationConfig=e,this.variability=t}planQuery(e,t){if(t.length===0)return{subqueries:[],requiresFederation:!1,estimatedLatency:0};const s=this.federationConfig?.enabled??!1,i=this.selectServices(e,t).map(l=>({serviceId:l.id,serviceName:l.name,endpoint:l.endpoint,query:e.rawQuery,fields:e.fields,estimatedLatency:this.estimateServiceLatency(l,e)})),a=i.reduce((l,d)=>l+d.estimatedLatency,0),o=s?this.getFederationOverhead():0;return{subqueries:i,requiresFederation:s,estimatedLatency:a+o}}selectServices(e,t){if(this.federationConfig?.enabled&&this.federationConfig.services?.length){const i=t.filter(a=>this.federationConfig.services.includes(a.name));return i.length>0?i:t.slice(0,Math.min(2,t.length))}const s=this.hashString(e.operationName||e.rawQuery),n=Math.abs(s)%t.length;return[t[n]]}estimateServiceLatency(e,t){const s=e.avgLatencyMs,n=Math.sqrt(t.complexity)*.8,i=t.depth*1.5,a=this.variability?.latencyJitterMultiplier??1,o=5*Math.max(a,0),l=o>0?o/2:0;return s+n+i+l}hashString(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t|=0}return t}updateFederationConfig(e){this.federationConfig=e}updateVariability(e){this.variability=e}getFederationOverhead(){const e=this.variability?.federationOverheadMs;return typeof e=="number"?e:5}}class WE{serviceRegistry;variability;constructor(e,t){this.serviceRegistry=e,this.variability=t}executePlan(e){if(e.subqueries.length===0)return{success:!1,totalLatency:0,error:"No services available",executedEndpoints:[]};let t=0;const s=[];for(const n of e.subqueries){const i=this.serviceRegistry.getService(n.serviceId);if(!i)return{success:!1,totalLatency:t,error:`Service ${n.serviceId} not found`,failedService:n.serviceId,executedEndpoints:s};const a=n.endpoint||i.endpoint;s.push(a);const l=this.getEndpointLatency(a,i.avgLatencyMs)+(n.estimatedLatency-i.avgLatencyMs);t+=l;const d=i.errorRate,h=this.variability?.baseRandomErrorRate??0,p=Math.min(Math.max(d+h,0),1);if(i.rollingErrors.length/Math.max(i.rollingLatency.length||1,1)>=p&&p>0)return this.serviceRegistry.recordRequest(i.id,l,!1),{success:!1,totalLatency:t,error:`Upstream error at ${i.name} (${a})`,failedService:i.id,executedEndpoints:s};this.serviceRegistry.recordRequest(i.id,l,!0)}return{success:!0,totalLatency:t,executedEndpoints:s}}getEndpointLatency(e,t){return e.includes("localhost")||e.includes("127.0.0.1")?t*.8:e.includes("https://")?t*1.1:t}updateVariability(e){this.variability=e}}class KE{services=new Map;registerService(e){const t=this.services.get(e.id);this.services.set(e.id,{id:e.id,name:e.name,endpoint:e.endpoint,avgLatencyMs:e.avgLatencyMs??20,errorRate:e.errorRate??.01,status:e.status??"connected",rollingLatency:t?.rollingLatency||[],rollingErrors:t?.rollingErrors||[]})}unregisterService(e){this.services.delete(e)}getConnectedServices(){return Array.from(this.services.values()).filter(e=>e.status==="connected")}getService(e){return this.services.get(e)}getServiceByName(e){return Array.from(this.services.values()).find(t=>t.name===e)}recordRequest(e,t,s){const n=this.services.get(e);if(!n)return;n.rollingLatency.push(t),n.rollingLatency.length>50&&n.rollingLatency.shift(),s||(n.rollingErrors.push(t),n.rollingErrors.length>50&&n.rollingErrors.shift());const i=n.rollingLatency.reduce((o,l)=>o+l,0)/n.rollingLatency.length;n.avgLatencyMs=i;const a=n.rollingErrors.length/Math.max(n.rollingLatency.length,1);n.errorRate=a}initialize(e){this.services.clear();for(const t of e)this.registerService(t)}getAllServices(){return Array.from(this.services.values())}}class YE{cache=new Map;ttl;persistQueries;hitCount=0;missCount=0;constructor(e=0,t=!1){this.ttl=e,this.persistQueries=t}generateCacheKey(e,t){const s=t?JSON.stringify(t):"";return this.hashString(e+s)}getCached(e,t){if(this.ttl<=0||!this.persistQueries)return this.missCount++,{hit:!1,latencyReduction:0};const s=this.generateCacheKey(e,t),n=this.cache.get(s);return n?Date.now()-n.timestamp>n.ttl*1e3?(this.cache.delete(s),this.missCount++,{hit:!1,latencyReduction:0}):(this.hitCount++,{hit:!0,latencyReduction:.7}):(this.missCount++,{hit:!1,latencyReduction:0})}setCached(e,t,s){if(this.ttl<=0||!this.persistQueries)return;const n=this.generateCacheKey(e,s);if(this.cache.set(n,{query:e,response:t,timestamp:Date.now(),ttl:this.ttl}),this.cache.size>1e3){const i=this.cache.keys().next().value;this.cache.delete(i)}}getCacheHitProbability(e){if(this.ttl<=0||!this.persistQueries)return 0;const t=.2,s=Math.min(e.complexity/2e3,.4);return Math.min(t+s,.6)}updateConfig(e,t){e!==void 0&&(this.ttl=e),t!==void 0&&(this.persistQueries=t)}clearCache(){this.cache.clear(),this.hitCount=0,this.missCount=0}hashString(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t|=0}return Math.abs(t).toString(16)}getMetrics(){return{cacheHitCount:this.hitCount,cacheMissCount:this.missCount,cacheSize:this.cache.size}}}class XE{enabled;limits=new Map;defaultLimit=100;windowMs=6e4;constructor(e=!1,t=100){this.enabled=e,this.defaultLimit=t}checkLimit(e,t){if(!this.enabled)return{allowed:!0,remaining:1/0,resetAt:Date.now()+this.windowMs};const s=t||this.defaultLimit,n=Date.now(),i=this.limits.get(e);if(!i||n>=i.resetAt){const a={count:1,resetAt:n+this.windowMs,windowStart:n};return this.limits.set(e,a),{allowed:!0,remaining:s-1,resetAt:a.resetAt}}return i.count>=s?{allowed:!1,remaining:0,resetAt:i.resetAt}:(i.count+=1,{allowed:!0,remaining:s-i.count,resetAt:i.resetAt})}getIdentifier(e){if(!e)return"default";const t=e["x-api-key"]||e.apikey;if(t)return`key:${t}`;const s=e["x-client-id"];return s?`client:${s}`:"default"}setEnabled(e){this.enabled=e}updateDefaultLimit(e){this.defaultLimit=e}clearLimits(){this.limits.clear()}}class JE{maxQueryDepth;maxQueryComplexity;enabled;constructor(e=15,t=1e3,s=!0){this.maxQueryDepth=e,this.maxQueryComplexity=t,this.enabled=s}validateQuery(e){return this.enabled?e.depth>this.maxQueryDepth?{valid:!1,error:`Query depth ${e.depth} exceeds limit ${this.maxQueryDepth}`}:e.complexity>this.maxQueryComplexity?{valid:!1,error:`Query complexity ${e.complexity} exceeds limit ${this.maxQueryComplexity}`}:{valid:!0}:{valid:!0}}updateLimits(e,t){e!==void 0&&(this.maxQueryDepth=e),t!==void 0&&(this.maxQueryComplexity=t)}setEnabled(e){this.enabled=e}}class ZE{config;variability;constructor(e,t){this.config=e,this.variability=t}isEnabled(){return this.config?.enabled??!1}getVersion(){return this.config?.version}getFederatedServices(){return this.config?.services||[]}getPlanningOverhead(){if(!this.isEnabled())return 0;const e=this.config?.version==="2"?2:4,t=this.variability?.federationOverheadMs??0;return e+t}isFederatedService(e){return this.isEnabled()?this.config?.services?.includes(e.name)??!1:!1}getSupergraphSchema(){return this.config?.supergraph}updateConfig(e){this.config=e}updateVariability(e){this.variability=e}}class ek{queryParser;queryPlanner;queryExecutor;serviceRegistry;cacheManager;rateLimiter;complexityAnalyzer;federationComposer;config=null;constructor(){this.serviceRegistry=new KE,this.queryParser=new VE,this.queryPlanner=new GE,this.queryExecutor=new WE(this.serviceRegistry),this.cacheManager=new YE,this.rateLimiter=new XE,this.complexityAnalyzer=new JE,this.federationComposer=new ZE}initialize(e){this.config=e,Array.isArray(e.services)&&this.serviceRegistry.initialize(e.services),this.federationComposer.updateConfig(e.federation),this.federationComposer.updateVariability(e.variability),this.queryPlanner.updateFederationConfig(e.federation),this.queryPlanner.updateVariability(e.variability),this.cacheManager.updateConfig(e.cacheTtl??0,e.persistQueries??!1),this.rateLimiter.setEnabled(e.enableRateLimiting??!1),typeof e.globalRateLimitPerMinute=="number"&&this.rateLimiter.updateDefaultLimit(e.globalRateLimitPerMinute),this.complexityAnalyzer.updateLimits(e.maxQueryDepth??15,e.maxQueryComplexity??1e3),this.complexityAnalyzer.setEnabled(e.enableQueryComplexityAnalysis??!0),this.queryExecutor.updateVariability(e.variability)}routeRequest(e){const t=Date.now();if(!e.query||e.query.trim().length===0)return{status:400,latency:Date.now()-t,complexityRejected:!1,cacheHit:!1,rateLimited:!1,federated:!1,usedServices:[],error:"Empty query"};const s=this.rateLimiter.getIdentifier(e.headers);if(!this.rateLimiter.checkLimit(s).allowed)return{status:429,latency:Date.now()-t,cacheHit:!1,rateLimited:!0,complexityRejected:!1,federated:!1,usedServices:[],error:"Rate limit exceeded"};const i=this.queryParser.parseQuery(e),a=this.cacheManager.getCached(e.query,e.variables);if(a.hit)return{status:200,latency:(Date.now()-t)*(1-a.latencyReduction),cacheHit:!0,rateLimited:!1,complexityRejected:!1,federated:!1,usedServices:[],plannedLatency:(Date.now()-t)*(1-a.latencyReduction)};const o=this.complexityAnalyzer.validateQuery(i);if(!o.valid)return{status:413,latency:Date.now()-t,cacheHit:!1,rateLimited:!1,complexityRejected:!0,federated:!1,usedServices:[],error:o.error};const l=this.serviceRegistry.getConnectedServices();if(l.length===0)return{status:503,latency:Date.now()-t,cacheHit:!1,rateLimited:!1,complexityRejected:!1,federated:!1,usedServices:[],error:"No connected services"};const d=this.queryPlanner.planQuery(i,l),h=this.queryExecutor.executePlan(d);if(!h.success){const g=Date.now()-t;return{status:502,latency:h.totalLatency+g,plannedLatency:d.estimatedLatency,cacheHit:!1,rateLimited:!1,complexityRejected:!1,federated:d.requiresFederation,usedServices:d.subqueries.map(v=>v.serviceName),error:h.error}}this.cacheManager.setCached(e.query,{success:!0},e.variables);const p=Date.now()-t;return{status:200,latency:h.totalLatency+p,plannedLatency:d.estimatedLatency,cacheHit:!1,rateLimited:!1,complexityRejected:!1,federated:d.requiresFederation,usedServices:d.subqueries.map(g=>g.serviceName)}}getServiceRegistry(){return this.serviceRegistry}getCacheManager(){return this.cacheManager}getRateLimiter(){return this.rateLimiter}}class tk{backends=new Map;endpoints=new Map;config={};circuitBreakers=new Map;cache=new Map;cacheMode="memory";defaultCacheTtl=5;redisEngine=null;redisNodeId="";backendMetrics=new Map;batchQueue=new Map;batchTimer=null;batchSize=10;batchTimeout=50;initialize(e){if(this.config=e,this.backends.clear(),this.endpoints.clear(),this.circuitBreakers.clear(),this.cache.clear(),this.backendMetrics.clear(),this.cacheMode=e.cacheMode||"memory",this.defaultCacheTtl=e.cacheTtl||5,this.redisEngine=e.redisEngine||null,this.redisNodeId=e.redisNodeId||"",e.backends)for(const t of e.backends)this.backends.set(t.id,{...t}),this.initializeCircuitBreaker(t.id,t.circuitBreaker),this.initializeBackendMetrics(t.id);if(e.endpoints)for(const t of e.endpoints)this.endpoints.set(t.id,{...t})}initializeCircuitBreaker(e,t){t?.enabled&&this.circuitBreakers.set(e,{failures:0,successes:0,state:"closed",lastFailureTime:0,nextAttemptTime:0})}initializeBackendMetrics(e){this.backendMetrics.set(e,{requestCount:0,errorCount:0,totalLatency:0,averageLatency:0,lastRequestTime:0,cacheHits:0,cacheMisses:0})}routeRequest(e){const t=Date.now(),s=this.matchEndpoint(e);if(!s)return{status:404,error:"Endpoint not found",latency:Date.now()-t,backendResponses:[],cacheHit:!1};if(this.config.enableCaching&&this.cacheMode!=="off"){const a=this.getCacheKey(s,e),o=this.getCached(a);if(o){const l=this.backendMetrics.get(s.backends[0])||this.initializeBackendMetrics(s.backends[0]);return l&&l.cacheHits++,{status:200,data:o.data,latency:Date.now()-t,backendResponses:[],cacheHit:!0}}}const n=this.aggregateBackends(s,e),i=this.aggregateResponses(s,n);if(this.config.enableCaching&&this.cacheMode!=="off"&&i.status===200){const a=this.getCacheKey(s,e),o=s.cacheTtl||this.defaultCacheTtl;this.setCached(a,i.data,o)}for(const a of n){const o=this.backendMetrics.get(a.backendId);o&&(o.requestCount++,a.status>=400&&o.errorCount++,o.totalLatency+=a.latency,o.averageLatency=o.totalLatency/o.requestCount,o.lastRequestTime=Date.now(),a.cached||o.cacheMisses++)}return{...i,latency:Date.now()-t,backendResponses:n,cacheHit:!1}}matchEndpoint(e){for(const t of this.endpoints.values())if(t.path===e.path&&t.method===e.method)return t;return null}aggregateBackends(e,t){const s=e.backends;switch(e.aggregator){case"parallel":return this.executeBackendsParallel(s,t,e);case"sequential":return this.executeBackendsSequential(s,t,e);case"merge":default:return this.executeBackendsParallel(s,t,e)}}executeBackendsParallel(e,t,s){const n=[];for(const i of e){const a=this.executeBackend(i,t,s);n.push(a)}return n}executeBackendsSequential(e,t,s){const n=[];let i={};for(const a of e){const o={...t,body:{...typeof t.body=="object"?t.body:{},...i}},l=this.executeBackend(a,o,s);if(n.push(l),l.status>=200&&l.status<300&&l.data)typeof l.data=="object"&&(i={...i,...l.data});else break}return n}executeBackend(e,t,s){const n=this.backends.get(e);if(!n)return{backendId:e,status:503,error:"Backend not found",latency:0,cached:!1};const i=this.circuitBreakers.get(e);if(i){const h=Date.now();if(i.state==="open"){if(h<i.nextAttemptTime)return{backendId:e,status:503,error:"Circuit breaker is open",latency:0,cached:!1};i.state="half-open"}}if(this.config.enableCaching&&this.cacheMode!=="off"){const h=`${e}:${s.path}:${JSON.stringify(t.query||{})}`,p=this.getCached(h);if(p)return{backendId:e,status:200,data:p.data,latency:1,cached:!0}}s.timeout||n.timeout||this.config.defaultTimeout;const a=n.retries||0,o=n.retryBackoff||"exponential";let l,d=0;for(let h=0;h<=a;h++){if(h>0){const x=this.calculateBackoff(h,o);d+=x}const p=50+Math.random()*150,g=(Math.random()-.5)*20,v=p+g;d+=v;const b=n.status==="connected"?.95:.5;if(Math.random()<b){i&&(i.state==="half-open"?(i.successes++,i.successes>=(n.circuitBreaker?.successThreshold||2)&&(i.state="closed",i.failures=0,i.successes=0)):i.failures=Math.max(0,i.failures-1));const x=this.generateMockResponse(n,t);return{backendId:e,status:200,data:x,latency:d,cached:!1}}else l=`Backend error (attempt ${h+1}/${a+1})`,i&&(i.failures++,i.lastFailureTime=Date.now(),i.failures>=(n.circuitBreaker?.failureThreshold||5)&&(i.state="open",i.nextAttemptTime=Date.now()+(n.circuitBreaker?.timeout||6e4)))}return{backendId:e,status:503,error:l||"Backend request failed",latency:d,cached:!1}}calculateBackoff(e,t){switch(t){case"exponential":return Math.min(1e3*Math.pow(2,e-1),1e4);case"linear":return 100*e;case"constant":default:return 100}}generateMockResponse(e,t){const s=e.name.toLowerCase();return s.includes("user")||s.includes("profile")?{id:Math.floor(Math.random()*1e3),name:"John Doe",email:"john.doe@example.com",avatar:"https://example.com/avatar.jpg"}:s.includes("order")||s.includes("cart")?{id:Math.floor(Math.random()*1e3),items:[{id:1,name:"Product 1",price:29.99,quantity:2},{id:2,name:"Product 2",price:49.99,quantity:1}],total:109.97}:s.includes("product")||s.includes("catalog")?{products:[{id:1,name:"Product 1",price:29.99,inStock:!0},{id:2,name:"Product 2",price:49.99,inStock:!0}],total:2}:{data:"Mock response",timestamp:Date.now()}}aggregateResponses(e,t){if(t.length===0)return{status:503,error:"No backends configured for endpoint"};if(t.every(i=>i.status>=400))return{status:503,error:"All backends failed"};const n=t.some(i=>i.status>=400);if(e.aggregator==="merge"||e.aggregator==="parallel"){const i={};for(const a of t)if(a.status>=200&&a.status<300&&a.data){const l=this.backends.get(a.backendId)?.name||a.backendId;typeof a.data=="object"&&a.data,i[l]=a.data}return{status:n?207:200,data:i}}else{const i=t[t.length-1];return i.status>=200&&i.status<300?{status:200,data:i.data}:{status:i.status,error:i.error}}}getCacheKey(e,t){return e.cacheKey?e.cacheKey:`${e.path}:${e.method}:${JSON.stringify(t.query||{})}`}getCached(e){if(this.cacheMode==="off")return null;if(this.cacheMode==="redis"&&this.redisEngine){const s=this.getRedisCacheKey(e),n=this.redisEngine.executeCommand("GET",[s]);if(n.success&&n.value!==null)try{const i=typeof n.value=="string"?JSON.parse(n.value):n.value;return{key:e,data:i,expiresAt:Date.now()+this.defaultCacheTtl*1e3,hitCount:1}}catch{return null}return null}const t=this.cache.get(e);return t?Date.now()>t.expiresAt?(this.cache.delete(e),null):(t.hitCount++,t):null}setCached(e,t,s){if(this.cacheMode!=="off"){if(this.cacheMode==="redis"&&this.redisEngine){const n=this.getRedisCacheKey(e),i=typeof t=="string"?t:JSON.stringify(t),a=[n,i];s>0&&a.push("EX",String(s)),this.redisEngine.executeCommand("SET",a);return}this.cache.set(e,{key:e,data:t,expiresAt:Date.now()+s*1e3,hitCount:0}),this.cache.size>1e3&&this.cleanupCache()}}getRedisCacheKey(e){return`${this.redisNodeId?`bff:${this.redisNodeId}:`:"bff:"}${e}`}cleanupCache(){const e=Date.now();for(const[t,s]of this.cache.entries())e>s.expiresAt&&this.cache.delete(t)}getStats(){let e=0,t=0,s=0,n=0,i=0;const a={};for(const[o,l]of this.backendMetrics.entries())e+=l.requestCount,t+=l.errorCount,s+=l.totalLatency,n+=l.cacheHits,i+=l.cacheMisses,a[o]={...l};return{totalRequests:e,totalErrors:t,averageLatency:e>0?s/e:0,cacheHitRate:n+i>0?n/(n+i):0,backendStats:a}}getBackendMetrics(e){return this.backendMetrics.get(e)}getBackends(){return Array.from(this.backends.values())}getEndpoints(){return Array.from(this.endpoints.values())}updateBackendStatus(e,t){const s=this.backends.get(e);s&&(s.status=t)}}class sk{endpoints=new Map;config={};endpointMetrics=new Map;rateLimitState=new Map;globalRateLimitState=null;requestHistory=[];maxHistorySize=1e3;initialize(e){if(this.config=e,this.endpoints.clear(),this.endpointMetrics.clear(),this.rateLimitState.clear(),this.requestHistory=[],this.globalRateLimitState=null,e.endpoints)for(const t of e.endpoints){const s=t.id||`${t.method}:${t.path}`;this.endpoints.set(s,{...t,id:s,enabled:t.enabled!==!1}),this.initializeEndpointMetrics(s),t.rateLimit&&this.rateLimitState.set(s,{count:0,resetAt:Date.now()+1e3,burst:t.rateLimit})}e.rateLimit?.enabled&&(this.globalRateLimitState={count:0,resetAt:Date.now()+1e3,burst:e.rateLimit.burst||e.rateLimit.requestsPerSecond||1e3})}initializeEndpointMetrics(e){this.endpointMetrics.set(e,{requestCount:0,errorCount:0,totalLatency:0,averageLatency:0,lastRequestTime:0,statusCodeCounts:new Map})}routeRequest(e){const t=Date.now(),s=this.matchEndpoint(e);if(!s)return{status:404,error:"Endpoint not found",latency:Date.now()-t};if(s.enabled===!1)return{status:503,error:"Endpoint is disabled",latency:Date.now()-t,endpoint:s.id};if(this.config.rateLimit?.enabled&&this.globalRateLimitState){const l=this.checkGlobalRateLimit();if(!l.allowed)return this.updateEndpointMetrics(s.id,Date.now()-t,429),{status:429,error:"Rate limit exceeded",latency:Date.now()-t,endpoint:s.id,headers:{"X-RateLimit-Limit":String(this.config.rateLimit.requestsPerSecond||1e3),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":String(l.resetAt||Date.now()+1e3)}}}if(s.rateLimit&&s.id){const l=this.checkEndpointRateLimit(s.id,s.rateLimit);if(!l.allowed)return this.updateEndpointMetrics(s.id,Date.now()-t,429),{status:429,error:"Endpoint rate limit exceeded",latency:Date.now()-t,endpoint:s.id,headers:{"X-RateLimit-Limit":String(s.rateLimit),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":String(l.resetAt||Date.now()+1e3)}}}const n=this.authenticate(e);if(!n.success)return this.updateEndpointMetrics(s.id,Date.now()-t,n.status||401),{status:n.status||401,error:n.error||"Authentication failed",latency:Date.now()-t,endpoint:s.id};const i=this.validateParameters(e,s);if(!i.valid)return this.updateEndpointMetrics(s.id,Date.now()-t,400),{status:400,error:i.error||"Invalid parameters",latency:Date.now()-t,endpoint:s.id};const a=this.simulateProcessingLatency(s),o=Date.now()-t+a;return this.updateEndpointMetrics(s.id,o,200),{status:200,data:this.generateResponse(s,e),latency:o,endpoint:s.id,headers:{"Content-Type":"application/json",...this.config.cors?.enabled?this.getCorsHeaders():{}}}}matchEndpoint(e){for(const t of this.endpoints.values())if(t.method===e.method&&t.path===e.path)return t;for(const t of this.endpoints.values())if(t.method===e.method&&this.matchPathPattern(t.path,e.path))return t;return null}matchPathPattern(e,t){const s=e.replace(/:[^/]+/g,"[^/]+").replace(/\*/g,".*");return new RegExp(`^${s}$`).test(t)}checkGlobalRateLimit(){if(!this.globalRateLimitState)return{allowed:!0};const e=Date.now();e>=this.globalRateLimitState.resetAt&&(this.globalRateLimitState.count=0,this.globalRateLimitState.resetAt=e+1e3);const t=this.config.rateLimit?.requestsPerSecond||1e3;return this.globalRateLimitState.count>=t?{allowed:!1,resetAt:this.globalRateLimitState.resetAt}:(this.globalRateLimitState.count++,{allowed:!0})}checkEndpointRateLimit(e,t){let s=this.rateLimitState.get(e);s||(s={count:0,resetAt:Date.now()+1e3,burst:t},this.rateLimitState.set(e,s));const n=Date.now();return n>=s.resetAt&&(s.count=0,s.resetAt=n+1e3),s.count>=t?{allowed:!1,resetAt:s.resetAt}:(s.count++,{allowed:!0})}authenticate(e){const t=this.config.authentication;if(!t||t.type==="none")return{success:!0};switch(t.type){case"bearer":{const s=e.headers?.Authorization||e.headers?.authorization;if(!s||!s.startsWith("Bearer "))return{success:!1,status:401,error:"Missing or invalid Bearer token"};const n=s.replace("Bearer ","");return t.token&&n!==t.token?{success:!1,status:401,error:"Invalid Bearer token"}:{success:!0}}case"apiKey":{const s=t.apiKeyHeader||"X-API-Key",n=e.headers?.[s]||e.headers?.[s.toLowerCase()];return n?t.apiKey&&n!==t.apiKey?{success:!1,status:401,error:"Invalid API key"}:{success:!0}:{success:!1,status:401,error:"Missing API key"}}case"oauth2":{const s=e.headers?.Authorization||e.headers?.authorization;return!s||!s.startsWith("Bearer ")?{success:!1,status:401,error:"Missing OAuth2 token"}:{success:!0}}case"basic":{const s=e.headers?.Authorization||e.headers?.authorization;if(!s||!s.startsWith("Basic "))return{success:!1,status:401,error:"Missing Basic Auth credentials"};const n=s.replace("Basic ","");try{const i=atob(n),[a,o]=i.split(":");return t.username&&a!==t.username?{success:!1,status:401,error:"Invalid username"}:t.password&&o!==t.password?{success:!1,status:401,error:"Invalid password"}:{success:!0}}catch{return{success:!1,status:401,error:"Invalid Basic Auth format"}}}default:return{success:!0}}}validateParameters(e,t){if(!t.parameters||t.parameters.length===0)return{valid:!0};for(const s of t.parameters)if(s.required){let n;switch(s.in){case"query":n=e.query?.[s.name];break;case"path":n="present";break;case"header":n=e.headers?.[s.name]||e.headers?.[s.name.toLowerCase()];break}if(!n&&!s.defaultValue)return{valid:!1,error:`Missing required parameter: ${s.name} (in ${s.in})`}}return{valid:!0}}simulateProcessingLatency(e){const t=10+Math.random()*40,n={GET:0,POST:20,PUT:15,PATCH:10,DELETE:5}[e.method]||0,i=e.timeout?Math.random()*.1*e.timeout:0;return t+n+i}generateResponse(e,t){if(e.responseExample)try{return JSON.parse(e.responseExample)}catch{return{message:e.responseExample}}switch(e.method){case"GET":return{data:[],count:0,message:"Success"};case"POST":return{id:Math.random().toString(36).substring(7),...t.body||{},createdAt:new Date().toISOString()};case"PUT":case"PATCH":return{...t.body||{},updatedAt:new Date().toISOString()};case"DELETE":return{message:"Deleted successfully"};default:return{message:"Success"}}}getCorsHeaders(){const e=this.config.cors;return!e||!e.enabled?{}:{"Access-Control-Allow-Origin":e.allowedOrigins?.join(",")||"*","Access-Control-Allow-Methods":e.allowedMethods?.join(",")||"GET,POST,PUT,DELETE,PATCH","Access-Control-Allow-Headers":e.allowedHeaders?.join(",")||"Content-Type,Authorization"}}updateEndpointMetrics(e,t,s){let n=this.endpointMetrics.get(e);n||(this.initializeEndpointMetrics(e),n=this.endpointMetrics.get(e)),n.requestCount++,s>=400&&n.errorCount++,n.totalLatency+=t,n.averageLatency=n.totalLatency/n.requestCount,n.lastRequestTime=Date.now();const i=n.statusCodeCounts.get(s)||0;n.statusCodeCounts.set(s,i+1),this.requestHistory.push({endpoint:e,timestamp:Date.now(),latency:t,status:s}),this.requestHistory.length>this.maxHistorySize&&this.requestHistory.shift()}getEndpointStats(e){const t=this.endpointMetrics.get(e);if(!t)return null;const s={};for(const[n,i]of t.statusCodeCounts.entries())s[n]=i;return{requestCount:t.requestCount,errorCount:t.errorCount,averageLatency:t.averageLatency,lastRequestTime:t.lastRequestTime,statusCodeCounts:s}}getAllEndpointStats(){const e={};for(const t of this.endpoints.keys())e[t]=this.getEndpointStats(t);return e}getStats(){let e=0,t=0,s=0,n=0;for(const i of this.endpoints.values()){i.enabled!==!1&&n++;const a=this.endpointMetrics.get(i.id);a&&(e+=a.requestCount,t+=a.errorCount,s+=a.totalLatency)}return{totalEndpoints:this.endpoints.size,enabledEndpoints:n,totalRequests:e,totalErrors:t,averageLatency:e>0?s/e:0}}}class nk{services=new Map;config={};methodMetrics=new Map;rateLimitState=new Map;globalRateLimitState=null;connectionState={activeConnections:0,idleConnections:0,totalConnections:0,lastActivity:0};requestHistory=[];maxHistorySize=1e3;initialize(e){if(this.config=e,this.services.clear(),this.methodMetrics.clear(),this.rateLimitState.clear(),this.requestHistory=[],this.globalRateLimitState=null,this.connectionState={activeConnections:0,idleConnections:0,totalConnections:0,lastActivity:0},e.services)for(const t of e.services){this.services.set(t.name,{...t,enabled:t.enabled!==!1});for(const s of t.methods){const n=`${t.name}.${s.name}`;this.initializeMethodMetrics(n),s.rateLimit&&this.rateLimitState.set(n,{count:0,resetAt:Date.now()+1e3,burst:s.rateLimit})}}e.rateLimit?.enabled&&(this.globalRateLimitState={count:0,resetAt:Date.now()+1e3,burst:e.rateLimit.burst||e.rateLimit.requestsPerSecond||1e3})}initializeMethodMetrics(e){this.methodMetrics.set(e,{requestCount:0,errorCount:0,totalLatency:0,averageLatency:0,lastRequestTime:0,statusCounts:new Map,streamingConnections:0})}routeRequest(e){const t=Date.now(),s=this.services.get(e.service);if(!s)return{status:"NOT_FOUND",error:`Service '${e.service}' not found`,latency:Date.now()-t};if(s.enabled===!1)return{status:"UNAVAILABLE",error:`Service '${e.service}' is disabled`,latency:Date.now()-t,service:e.service};const n=s.methods.find(h=>h.name===e.method);if(!n)return{status:"NOT_FOUND",error:`Method '${e.method}' not found in service '${e.service}'`,latency:Date.now()-t,service:e.service};const i=`${e.service}.${e.method}`;if(n.enabled===!1)return{status:"UNAVAILABLE",error:`Method '${e.method}' is disabled`,latency:Date.now()-t,service:e.service,method:e.method};if(this.config.rateLimit?.enabled&&this.globalRateLimitState&&!this.checkGlobalRateLimit().allowed)return this.updateMethodMetrics(i,Date.now()-t,"RESOURCE_EXHAUSTED"),{status:"RESOURCE_EXHAUSTED",error:"Rate limit exceeded",latency:Date.now()-t,service:e.service,method:e.method,metadata:{"grpc-status":"8","grpc-message":"Rate limit exceeded"}};if(n.rateLimit&&!this.checkMethodRateLimit(i,n.rateLimit).allowed)return this.updateMethodMetrics(i,Date.now()-t,"RESOURCE_EXHAUSTED"),{status:"RESOURCE_EXHAUSTED",error:"Method rate limit exceeded",latency:Date.now()-t,service:e.service,method:e.method,metadata:{"grpc-status":"8","grpc-message":"Method rate limit exceeded"}};const a=this.authenticate(e);if(!a.success)return this.updateMethodMetrics(i,Date.now()-t,a.status||"UNAUTHENTICATED"),{status:a.status||"UNAUTHENTICATED",error:a.error||"Authentication failed",latency:Date.now()-t,service:e.service,method:e.method};this.updateConnectionState(!0);const o=this.simulateProcessingLatency(n,e),l=Date.now()-t+o,d=e.timeout||n.timeout||this.config.maxConnectionIdle||3e4;if(l>d)return this.updateMethodMetrics(i,l,"DEADLINE_EXCEEDED"),this.updateConnectionState(!1),{status:"DEADLINE_EXCEEDED",error:"Request timeout exceeded",latency:l,service:e.service,method:e.method,metadata:{"grpc-status":"4","grpc-message":"Deadline exceeded"}};if(n.streaming&&n.streaming!=="unary"){const h=this.methodMetrics.get(i);h&&(h.streamingConnections=(h.streamingConnections||0)+1)}return this.updateMethodMetrics(i,l,"OK"),this.updateConnectionState(!1),{status:"OK",data:this.generateResponse(n,e),latency:l,service:e.service,method:e.method,metadata:{"grpc-status":"0","content-type":"application/grpc"}}}checkGlobalRateLimit(){if(!this.globalRateLimitState)return{allowed:!0};const e=Date.now();e>=this.globalRateLimitState.resetAt&&(this.globalRateLimitState.count=0,this.globalRateLimitState.resetAt=e+1e3);const t=this.config.rateLimit?.requestsPerSecond||1e3;return this.globalRateLimitState.count>=t?{allowed:!1,resetAt:this.globalRateLimitState.resetAt}:(this.globalRateLimitState.count++,{allowed:!0})}checkMethodRateLimit(e,t){let s=this.rateLimitState.get(e);s||(s={count:0,resetAt:Date.now()+1e3,burst:t},this.rateLimitState.set(e,s));const n=Date.now();return n>=s.resetAt&&(s.count=0,s.resetAt=n+1e3),s.count>=t?{allowed:!1,resetAt:s.resetAt}:(s.count++,{allowed:!0})}authenticate(e){const t=this.config.authentication;if(!t||t.type==="none")return{success:!0};switch(t.type){case"jwt":{const s=e.metadata?.authorization||e.metadata?.Authorization;if(!s||!s.startsWith("Bearer "))return{success:!1,status:"UNAUTHENTICATED",error:"Missing or invalid JWT token"};const n=s.replace("Bearer ","");return t.token&&n!==t.token?{success:!1,status:"UNAUTHENTICATED",error:"Invalid JWT token"}:{success:!0}}case"apiKey":{const s=e.metadata?.["x-api-key"]||e.metadata?.["X-API-Key"];return s?t.apiKey&&s!==t.apiKey?{success:!1,status:"UNAUTHENTICATED",error:"Invalid API key"}:{success:!0}:{success:!1,status:"UNAUTHENTICATED",error:"Missing API key"}}case"tls":case"mtls":return this.config.enableTLS?{success:!0}:{success:!1,status:"UNAUTHENTICATED",error:"TLS required but not enabled"};default:return{success:!0}}}simulateProcessingLatency(e,t){const s=5+Math.random()*15;let n=0;if(e.streaming)switch(e.streaming){case"unary":n=0;break;case"client-streaming":case"server-streaming":n=10+Math.random()*20;break;case"bidirectional":n=20+Math.random()*30;break}const i=this.config.enableCompression?2+Math.random()*3:0,a=this.estimateMessageSize(t.payload),o=(this.config.maxMessageSize||4)*1024*1024,l=a>o?50:a/o*10,d=e.timeout?Math.random()*.05*e.timeout:0;return s+n+i+l+d}estimateMessageSize(e){if(!e)return 0;try{return JSON.stringify(e).length}catch{return 0}}generateResponse(e,t){return t.payload?{...t.payload,processedAt:new Date().toISOString(),method:e.name}:{success:!0,message:`Response from ${e.name}`,data:{}}}updateConnectionState(e){e?(this.connectionState.activeConnections++,this.connectionState.totalConnections=Math.max(this.connectionState.totalConnections,this.connectionState.activeConnections+this.connectionState.idleConnections)):this.connectionState.activeConnections>0&&(this.connectionState.activeConnections--,this.connectionState.idleConnections++),this.connectionState.lastActivity=Date.now();const t=(this.config.maxConnectionIdle||300)*1e3;this.connectionState.idleConnections>0&&Date.now()-this.connectionState.lastActivity>t&&(this.connectionState.idleConnections=Math.max(0,this.connectionState.idleConnections-1))}updateMethodMetrics(e,t,s){let n=this.methodMetrics.get(e);n||(this.initializeMethodMetrics(e),n=this.methodMetrics.get(e)),n.requestCount++,s!=="OK"&&n.errorCount++,n.totalLatency+=t,n.averageLatency=n.totalLatency/n.requestCount,n.lastRequestTime=Date.now();const i=n.statusCounts.get(s)||0;n.statusCounts.set(s,i+1);const[a,o]=e.split(".");this.requestHistory.push({service:a||"",method:o||"",timestamp:Date.now(),latency:t,status:s}),this.requestHistory.length>this.maxHistorySize&&this.requestHistory.shift()}getMethodStats(e){const t=this.methodMetrics.get(e);if(!t)return null;const s={};for(const[n,i]of t.statusCounts.entries())s[n]=i;return{requestCount:t.requestCount,errorCount:t.errorCount,averageLatency:t.averageLatency,lastRequestTime:t.lastRequestTime,statusCounts:s,streamingConnections:t.streamingConnections}}getAllMethodStats(){const e={};for(const t of this.methodMetrics.keys())e[t]=this.getMethodStats(t);return e}getStats(){let e=0,t=0,s=0,n=0,i=0,a=0;for(const o of this.services.values()){o.enabled!==!1&&n++,i+=o.methods.length;for(const l of o.methods){l.enabled!==!1&&a++;const d=`${o.name}.${l.name}`,h=this.methodMetrics.get(d);h&&(e+=h.requestCount,t+=h.errorCount,s+=h.totalLatency)}}return{totalServices:this.services.size,enabledServices:n,totalMethods:i,enabledMethods:a,totalRequests:e,totalErrors:t,averageLatency:e>0?s/e:0,activeConnections:this.connectionState.activeConnections,idleConnections:this.connectionState.idleConnections,totalConnections:this.connectionState.totalConnections}}getConnectionState(){return{...this.connectionState}}}class ik{relays=new Map;config={};deliveries=new Map;pendingDeliveries=new Map;relayMetrics=new Map;initialize(e){if(this.config=e,this.relays.clear(),this.deliveries.clear(),this.pendingDeliveries.clear(),this.relayMetrics.clear(),e.relays)for(const t of e.relays)t.enabled&&(this.relays.set(t.id,{...t}),this.initializeRelayMetrics(t.id))}initializeRelayMetrics(e){this.relayMetrics.set(e,{totalRequests:0,successfulDeliveries:0,failedDeliveries:0,totalRetries:0,averageLatency:0,totalLatency:0,lastRequestTime:0})}relayWebhook(e){const t=Date.now(),s=this.findMatchingRelay(e);if(!s)return{success:!1,status:404,latency:Date.now()-t,attempts:0,error:"No matching relay found"};if(s.allowedIps&&s.allowedIps.length>0&&e.ip&&!this.isIpAllowed(e.ip,s.allowedIps))return this.updateRelayMetrics(s.id,!1,Date.now()-t),{success:!1,status:403,latency:Date.now()-t,attempts:0,error:"IP address not allowed",relayId:s.id};if(this.config.enableSignatureVerification&&s.signatureSecret&&!this.verifySignature(e,s.signatureSecret,s.signatureHeader||"X-Signature"))return this.updateRelayMetrics(s.id,!1,Date.now()-t),{success:!1,status:401,latency:Date.now()-t,attempts:0,error:"Invalid signature",relayId:s.id};let n=e.body;s.transformTemplate&&(n=this.transformPayload(e.body,s.transformTemplate));const i=this.deliverWebhook(s,{...e,body:n});return this.updateRelayMetrics(s.id,i.success,i.latency),{...i,relayId:s.id}}findMatchingRelay(e){for(const t of this.relays.values())if(e.url.startsWith(t.sourceUrl)||t.sourceUrl==="*"||e.url.includes(t.sourceUrl)){if(t.events&&t.events.length>0){const s=e.event||e.headers["x-event"]||e.headers["x-github-event"]||"";if(!t.events.includes(s)&&s!=="")continue}return t}return null}isIpAllowed(e,t){for(const s of t)if(this.matchesCidr(e,s))return!0;return!1}matchesCidr(e,t){if(t==="*"||t===e)return!0;if(t.includes("/")){const[s,n]=t.split("/"),i=parseInt(n,10),a=s.split("."),o=e.split(".");if(a.length!==4||o.length!==4)return!1;const l=Math.floor(i/8);for(let d=0;d<l;d++)if(a[d]!==o[d])return!1;return!0}return e===t}verifySignature(e,t,s){const n=e.headers[s.toLowerCase()]||e.headers[s]||e.headers["x-signature"]||e.headers["x-hub-signature-256"];return n?(typeof e.body=="string"?e.body:JSON.stringify(e.body),n.length>0&&t.length>0):!1}transformPayload(e,t){try{let s=t;if(s.includes("{{raw}}")){const n=typeof e=="string"?e:JSON.stringify(e);s=s.replace(/\{\{raw\}\}/g,n)}if(s.includes("{{json}}")){const n=typeof e=="string"?JSON.parse(e):e;s=s.replace(/\{\{json\}\}/g,JSON.stringify(n))}try{return JSON.parse(s)}catch{return s}}catch{return e}}deliverWebhook(e,t){const s=e.maxRetryAttempts||this.config.maxRetryAttempts||3,n=e.retryDelay||this.config.retryDelay||5,i=e.timeout||this.config.timeout||30,a=this.config.enableRetryOnFailure!==!1,o=e.retryBackoff||"exponential";let l=0,d,h;const p=Date.now();for(;l<s;){l++;const b=this.simulateHttpRequest(e.targetUrl,t,i);if(b.success){const M=`delivery-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,x={id:M,relayId:e.id,event:t.event||"unknown",payload:typeof t.body=="string"?t.body:JSON.stringify(t.body),status:"success",timestamp:new Date().toISOString(),attempts:l,responseCode:b.statusCode};return this.deliveries.set(M,x),{success:!0,status:b.statusCode||200,latency:Date.now()-p,deliveryId:M,attempts:l}}if(d=b.error,h=b.statusCode,!a||l>=s)break;this.calculateRetryDelay(l,n,o)}const g=`delivery-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,v={id:g,relayId:e.id,event:t.event||"unknown",payload:typeof t.body=="string"?t.body:JSON.stringify(t.body),status:"failed",timestamp:new Date().toISOString(),attempts:l,responseCode:h,error:d};return this.deliveries.set(g,v),{success:!1,status:h||500,latency:Date.now()-p,deliveryId:g,attempts:l,error:d||"Delivery failed after all retry attempts"}}simulateHttpRequest(e,t,s){const n=10+Math.random()*40,i=5+Math.random()*95,a=Math.random()<.05;if(Math.random()<.02)return{success:!1,statusCode:504,error:"Request timeout",latency:s*1e3};if(a){const l=[500,502,503,429],d=l[Math.floor(Math.random()*l.length)];return{success:!1,statusCode:d,error:`HTTP ${d} error`,latency:n+i}}return{success:!0,statusCode:200,latency:n+i}}calculateRetryDelay(e,t,s){switch(s){case"exponential":return t*Math.pow(2,e-1);case"linear":return t*e;case"constant":default:return t}}updateRelayMetrics(e,t,s){let n=this.relayMetrics.get(e);n||(n={totalRequests:0,successfulDeliveries:0,failedDeliveries:0,totalRetries:0,averageLatency:0,totalLatency:0,lastRequestTime:0},this.relayMetrics.set(e,n)),n.totalRequests++,n.totalLatency+=s,n.averageLatency=n.totalLatency/n.totalRequests,n.lastRequestTime=Date.now(),t?n.successfulDeliveries++:n.failedDeliveries++}getDeliveries(e){const t=Array.from(this.deliveries.values());return e?t.filter(s=>s.relayId===e):t}getRelayMetrics(e){return this.relayMetrics.get(e)}getAllRelayMetrics(){return new Map(this.relayMetrics)}getRelay(e){return this.relays.get(e)}getAllRelays(){return Array.from(this.relays.values())}}class ak{config=null;endpoints=new Map;deliveries=new Map;MAX_DELIVERY_HISTORY=1e3;webhookMetrics={endpointsTotal:0,endpointsEnabled:0,deliveriesTotal:0,deliveriesSuccess:0,deliveriesFailed:0,deliveriesPending:0,successRate:0,averageLatency:0,requestsPerSecond:0,errorRate:0,retriesTotal:0,utilization:0};deliveryHistory=[];MAX_DELIVERY_HISTORY_LIST=1e3;requestTimestamps=[];RPS_WINDOW_MS=1e3;rateLimitWindowStart=Date.now();rateLimitRequestsInWindow=0;tokenBucket=null;slidingWindow=[];rateLimitStrategy="fixed";processWebhookRequest(e){const t=Date.now();if(!this.config)return{success:!1,status:500,latency:Date.now()-t,attempts:0,error:"Webhook endpoint not configured"};if(e.ip&&!Array.from(this.endpoints.values()).find(h=>h.enabled&&this.isIPAllowed(e.ip,h.allowedIPs))&&Array.from(this.endpoints.values()).some(h=>h.allowedIPs&&h.allowedIPs.length>0)&&!Array.from(this.endpoints.values()).some(p=>p.enabled&&this.isIPAllowed(e.ip,p.allowedIPs)))return{success:!1,status:403,latency:Date.now()-t,attempts:0,error:"IP address not allowed"};if(this.config.enableRateLimiting&&this.config.rateLimitPerMinute&&!this.checkRateLimit())return{success:!1,status:429,latency:Date.now()-t,attempts:0,error:"Rate limit exceeded"};if(this.config.enableSignatureVerification||this.config.enableSignature){const d=this.config.signatureHeader||"X-Signature";if(!this.verifySignature(e,d))return this.webhookMetrics.deliveriesFailed++,this.webhookMetrics.deliveriesTotal++,this.updateErrorRate(),{success:!1,status:401,latency:Date.now()-t,attempts:0,error:"Invalid signature"}}const s=Date.now();this.requestTimestamps.push(s),this.cleanupOldRequestTimestamps(),this.webhookMetrics.requestsPerSecond=this.requestTimestamps.length;const n=e.event||e.headers?.["x-event"]||e.headers?.["x-github-event"]||"default",i=this.getMatchingEndpoints(n);if(i.length===0)return{success:!0,status:200,latency:Date.now()-t,attempts:0};let a=!0,o=[];for(const d of i){const h=this.deliverToEndpoint(d,e,n);h.deliveryId&&o.push(h.deliveryId),h.success||(a=!1)}const l=Date.now()-t;return this.updateAverageLatency(l),{success:a,status:a?200:500,latency:l,deliveryId:o[0],attempts:1}}transformPayload(e,t){if(!t.payloadTransformation?.enabled)return e;let s=typeof e=="string"?JSON.parse(e):{...e};if(t.payloadTransformation.removeFields)for(const n of t.payloadTransformation.removeFields)delete s[n];if(t.payloadTransformation.addFields&&(s={...s,...t.payloadTransformation.addFields}),t.payloadTransformation.transformFields)for(const[n,i]of Object.entries(t.payloadTransformation.transformFields)){const a=this.getNestedValue(s,n);a!==void 0&&(this.setNestedValue(s,i,a),n!==i&&this.deleteNestedValue(s,n))}if(t.payloadTransformation.template)try{const n=JSON.parse(t.payloadTransformation.template);s=this.applyTemplate(n,s)}catch{}return s}getNestedValue(e,t){return t.split(".").reduce((s,n)=>s?.[n],e)}setNestedValue(e,t,s){const n=t.split("."),i=n.pop(),a=n.reduce((o,l)=>(o[l]||(o[l]={}),o[l]),e);a[i]=s}deleteNestedValue(e,t){const s=t.split("."),n=s.pop(),i=s.reduce((a,o)=>a?.[o],e);i&&delete i[n]}applyTemplate(e,t){if(typeof e=="string")return e.replace(/\{\{([^}]+)\}\}/g,(s,n)=>{const i=this.getNestedValue(t,n.trim());return i!==void 0?String(i):s});if(Array.isArray(e))return e.map(s=>this.applyTemplate(s,t));if(typeof e=="object"&&e!==null){const s={};for(const[n,i]of Object.entries(e))s[n]=this.applyTemplate(i,t);return s}return e}deliverToEndpoint(e,t,s){const n=Date.now(),i=this.config?.maxRetryAttempts||3,a=this.config?.retryDelay||5,o=e.timeoutDuration||this.config?.timeout||this.config?.timeoutDuration||3e4,l=this.config?.enableRetryOnFailure!==!1,d=this.config?.retryBackoff||"exponential";let h=t.body;e.payloadTransformation?.enabled&&(h=this.transformPayload(t.body,e));const p={...t,body:h};let g=0,v,b;for(;g<i;){g++;const T=this.simulateHttpRequest(e.url,p,o);if(T.success){const E=Date.now()-n,A=`delivery-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,k={id:A,endpointId:e.id,event:s,payload:typeof h=="string"?h:JSON.stringify(h),status:"success",timestamp:new Date().toISOString(),attempts:g,responseCode:T.statusCode,responseBody:T.responseBody,latency:Date.now()-n};return this.addDelivery(k,E),this.updateAverageLatency(E),{success:!0,status:T.statusCode||200,latency:E,deliveryId:A,attempts:g}}if(v=T.error,b=T.statusCode,g>1&&this.webhookMetrics.retriesTotal++,!l||g>=i)break;this.calculateRetryDelay(g,a,d)}const M=Date.now()-n,x=`delivery-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,S={id:x,endpointId:e.id,event:s,payload:typeof h=="string"?h:JSON.stringify(h),status:"failed",timestamp:new Date().toISOString(),attempts:g,responseCode:b,error:v,latency:M};return this.addDelivery(S,M),this.updateAverageLatency(M),{success:!1,status:b||500,latency:M,deliveryId:x,attempts:g,error:v}}isIPAllowed(e,t){if(!t||t.length===0)return!0;for(const s of t)if(this.isIPInRange(e,s))return!0;return!1}isIPInRange(e,t){if(e===t)return!0;if(t.includes("/")){const[s,n]=t.split("/"),i=parseInt(n,10),a=this.ipToNumber(e),o=this.ipToNumber(s),l=4294967295<<32-i>>>0;return(a&l)===(o&l)}return!1}ipToNumber(e){const t=e.split(".").map(Number);return(t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3]}simulateHttpRequest(e,t,s){const n=Array.from(this.endpoints.values()).find(M=>M.url===e),i=n?.errorRate||this.config?.errorRate||10,a=n?.timeoutDuration||s,o=Math.random(),l=Math.random();let g=100+Math.sqrt(-2*Math.log(o))*Math.cos(2*Math.PI*l)*50;if(g=Math.max(10,Math.min(500,g)),g>a)return{success:!1,statusCode:408,error:"Request timeout"};const v=i/100;if(Math.random()>=v){const M=Math.random();let x=200;return M<.05?x=201:M<.1&&(x=202),{success:!0,statusCode:x,responseBody:JSON.stringify({received:!0,timestamp:Date.now()})}}else{const M=Math.random();if(M<.15){const x=Math.random();return x<.3?{success:!1,statusCode:408,error:"Connection timeout"}:x<.6?{success:!1,statusCode:0,error:"DNS resolution failed"}:{success:!1,statusCode:0,error:"Connection refused"}}else if(M<.3){const x=Math.random();return x<.3?{success:!1,statusCode:400,error:"Bad request"}:x<.6?{success:!1,statusCode:401,error:"Unauthorized"}:x<.8?{success:!1,statusCode:403,error:"Forbidden"}:{success:!1,statusCode:404,error:"Not found"}}else{const x=Math.random();return x<.4?{success:!1,statusCode:500,error:"Internal server error"}:x<.7?{success:!1,statusCode:502,error:"Bad gateway"}:x<.9?{success:!1,statusCode:503,error:"Service unavailable"}:{success:!1,statusCode:504,error:"Gateway timeout"}}}}calculateRetryDelay(e,t,s){switch(s){case"exponential":return t*Math.pow(2,e-1);case"linear":return t*e;case"constant":default:return t}}getMatchingEndpoints(e){const t=[];for(const s of this.endpoints.values())if(s.enabled){if(s.events.length===0){t.push(s);continue}(s.events.includes(e)||s.events.includes("*"))&&t.push(s)}return t}verifySignature(e,t){const s=e.headers?.[t.toLowerCase()]||e.headers?.[t]||e.headers?.["x-signature"]||e.headers?.["x-hub-signature-256"];if(!s)return!1;const n=Array.from(this.endpoints.values()).find(a=>a.secret);if(!n||!n.secret)return s.length>0;const i=this.config?.signatureAlgorithm||"hmac-sha256";return typeof e.body=="string"?e.body:JSON.stringify(e.body),i==="hmac-sha256"||i==="sha256"?/^[0-9a-f]{64}$/i.test(s.replace(/^sha256=/,"").replace(/^hmac-sha256=/,"")):i==="sha512"?/^[0-9a-f]{128}$/i.test(s.replace(/^sha512=/,"")):s.length>=32}checkRateLimit(){const e=this.config?.rateLimitPerMinute||100;switch(this.rateLimitStrategy){case"token-bucket":return this.checkTokenBucket(e);case"sliding-window":return this.checkSlidingWindow(e);case"fixed":default:return this.checkFixedWindow(e)}}checkFixedWindow(e){const t=Date.now();return t-this.rateLimitWindowStart>=6e4&&(this.rateLimitWindowStart=t,this.rateLimitRequestsInWindow=0),this.rateLimitRequestsInWindow>=e?!1:(this.rateLimitRequestsInWindow++,!0)}checkTokenBucket(e){const t=Date.now();this.tokenBucket||(this.tokenBucket={tokens:e,capacity:e,refillRate:e/60,lastRefill:t});const n=(t-this.tokenBucket.lastRefill)/1e3*this.tokenBucket.refillRate;return this.tokenBucket.tokens=Math.min(this.tokenBucket.capacity,this.tokenBucket.tokens+n),this.tokenBucket.lastRefill=t,this.tokenBucket.tokens>=1?(this.tokenBucket.tokens-=1,!0):!1}checkSlidingWindow(e){const t=Date.now(),s=6e4;return this.slidingWindow=this.slidingWindow.filter(n=>t-n.timestamp<s),this.slidingWindow.length>=e?!1:(this.slidingWindow.push({timestamp:t}),!0)}addDelivery(e,t){if(this.deliveries.set(e.id,e),this.webhookMetrics.deliveriesTotal++,e.status==="success"?this.webhookMetrics.deliveriesSuccess++:e.status==="failed"?this.webhookMetrics.deliveriesFailed++:this.webhookMetrics.deliveriesPending++,this.webhookMetrics.deliveriesTotal>0&&(this.webhookMetrics.successRate=this.webhookMetrics.deliveriesSuccess/this.webhookMetrics.deliveriesTotal*100),t!==void 0&&(this.deliveryHistory.push({timestamp:Date.now(),latency:t,status:e.status==="success"?"success":"failed"}),this.deliveryHistory.length>this.MAX_DELIVERY_HISTORY_LIST&&this.deliveryHistory.shift()),this.deliveries.size>this.MAX_DELIVERY_HISTORY){const s=this.deliveries.keys().next().value;this.deliveries.delete(s)}this.updateErrorRate()}updateAverageLatency(e){if(this.deliveryHistory.push({timestamp:Date.now(),latency:e,status:"success"}),this.deliveryHistory.length>this.MAX_DELIVERY_HISTORY_LIST&&this.deliveryHistory.shift(),this.deliveryHistory.length>0){const t=this.deliveryHistory.reduce((s,n)=>s+n.latency,0);this.webhookMetrics.averageLatency=t/this.deliveryHistory.length}}updateErrorRate(){this.webhookMetrics.deliveriesTotal>0&&(this.webhookMetrics.errorRate=this.webhookMetrics.deliveriesFailed/this.webhookMetrics.deliveriesTotal*100)}cleanupOldRequestTimestamps(){const e=Date.now();this.requestTimestamps=this.requestTimestamps.filter(t=>e-t<this.RPS_WINDOW_MS)}initializeConfig(e){const t=e.data.config||{};if(this.config=t,this.endpoints.clear(),t.endpoints)for(const s of t.endpoints)this.endpoints.set(s.id,{...s});this.webhookMetrics.endpointsTotal=this.endpoints.size,this.webhookMetrics.endpointsEnabled=Array.from(this.endpoints.values()).filter(s=>s.enabled).length}updateConfig(e){if(this.config=e,e.enableRateLimiting&&(this.rateLimitStrategy="token-bucket"),this.rateLimitWindowStart=Date.now(),this.rateLimitRequestsInWindow=0,this.tokenBucket=null,this.slidingWindow=[],this.endpoints.clear(),e.endpoints)for(const t of e.endpoints)this.endpoints.set(t.id,{...t});this.webhookMetrics.endpointsTotal=this.endpoints.size,this.webhookMetrics.endpointsEnabled=Array.from(this.endpoints.values()).filter(t=>t.enabled).length}getMetrics(){return this.webhookMetrics.utilization=Math.min(this.webhookMetrics.requestsPerSecond/100*100,100),{...this.webhookMetrics}}getDeliveries(){return Array.from(this.deliveries.values()).sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime())}getDeliveriesForEndpoint(e){return this.getDeliveries().filter(t=>t.endpointId===e)}getEndpoints(){return Array.from(this.endpoints.values())}getEndpoint(e){return this.endpoints.get(e)}getEndpointMetrics(e){const t=this.getDeliveriesForEndpoint(e),s=t.length,n=t.filter(v=>v.status==="success").length,i=t.filter(v=>v.status==="failed").length,a=t.filter(v=>v.latency!==void 0).map(v=>v.latency),o=a.length>0?a.reduce((v,b)=>v+b,0)/a.length:0,l=Date.now(),h=t.filter(v=>{const b=new Date(v.timestamp).getTime();return l-b<6e4}).length/60,p=s>0?i/s*100:0,g=s>0?n/s*100:0;return{totalDeliveries:s,successDeliveries:n,failedDeliveries:i,successRate:g,averageLatency:Math.round(o),requestsPerSecond:Math.round(h*100)/100,errorRate:p}}}class ok{keys=new Map;config={};maxMemoryBytes=256*1024*1024;currentMemoryUsage=0;metrics={totalKeys:0,keysByType:{string:0,hash:0,list:0,set:0,zset:0,stream:0},memoryUsage:0,memoryUsagePercent:0,operationsPerSecond:0,hitCount:0,missCount:0,hitRate:0,expiredKeys:0,evictedKeys:0,connectedClients:0};operationCount=0;lastMetricsUpdate=Date.now();operationHistory=[];clusterSlots=new Map;clusterNodes=[];initialize(e){if(this.config={...e},this.keys.clear(),this.currentMemoryUsage=0,this.operationCount=0,this.lastMetricsUpdate=Date.now(),this.operationHistory=[],e.maxMemory&&(this.maxMemoryBytes=this.parseMemorySize(e.maxMemory)),e.enableCluster&&e.clusterNodes&&(this.clusterNodes=[...e.clusterNodes],this.initializeClusterSlots()),e.keys&&Array.isArray(e.keys))for(const t of e.keys)this.setKey(t.key,t.type,t.value,t.ttl);this.updateMetrics()}parseMemorySize(e){const t=e.match(/^(\d+)([kmg]?b?)$/i);if(!t)return 256*1024*1024;const s=parseInt(t[1]);switch(t[2].toLowerCase()){case"kb":return s*1024;case"mb":return s*1024*1024;case"gb":return s*1024*1024*1024;default:return s}}initializeClusterSlots(){if(this.clusterNodes.length===0)return;const e=Math.floor(16384/this.clusterNodes.length);let t=0;for(let s=0;s<this.clusterNodes.length;s++){const n=s===this.clusterNodes.length-1?16383:t+e-1;for(let i=t;i<=n;i++)this.clusterSlots.set(i,this.clusterNodes[s]);t=n+1}}getClusterSlot(e){const t=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935];let s=0;for(let n=0;n<e.length;n++){const i=e.charCodeAt(n);s=(s<<8^t[(s>>8^i)&255])&65535}return s%16384}isKeyForThisNode(e){if(!this.config.enableCluster||this.clusterNodes.length===0)return!0;const t=this.getClusterSlot(e);return this.clusterSlots.get(t),!0}executeCommand(e,t){const s=Date.now(),n=e.toUpperCase();try{let i;switch(n){case"GET":i=this.get(t[0]);break;case"SET":i=this.set(t[0],t[1],t[2]?parseInt(t[2]):void 0);break;case"DEL":i=this.del(t);break;case"EXISTS":i=this.exists(t);break;case"EXPIRE":i=this.expire(t[0],parseInt(t[1]));break;case"TTL":i=this.ttl(t[0]);break;case"KEYS":i=this.keys(t[0]||"*");break;case"HGET":i=this.hget(t[0],t[1]);break;case"HSET":i=this.hset(t[0],t.slice(1));break;case"HGETALL":i=this.hgetall(t[0]);break;case"HDEL":i=this.hdel(t[0],t.slice(1));break;case"HKEYS":i=this.hkeys(t[0]);break;case"HVALS":i=this.hvals(t[0]);break;case"LPUSH":i=this.lpush(t[0],t.slice(1));break;case"RPUSH":i=this.rpush(t[0],t.slice(1));break;case"LPOP":i=this.lpop(t[0]);break;case"RPOP":i=this.rpop(t[0]);break;case"LLEN":i=this.llen(t[0]);break;case"LRANGE":i=this.lrange(t[0],parseInt(t[1]),parseInt(t[2]));break;case"SADD":i=this.sadd(t[0],t.slice(1));break;case"SREM":i=this.srem(t[0],t.slice(1));break;case"SMEMBERS":i=this.smembers(t[0]);break;case"SISMEMBER":i=this.sismember(t[0],t[1]);break;case"SCARD":i=this.scard(t[0]);break;case"ZADD":i=this.zadd(t[0],t.slice(1));break;case"ZREM":i=this.zrem(t[0],t.slice(1));break;case"ZRANGE":i=this.zrange(t[0],parseInt(t[1]),parseInt(t[2]));break;case"ZSCORE":i=this.zscore(t[0],t[1]);break;case"ZCARD":i=this.zcard(t[0]);break;case"PING":i="PONG";break;case"INFO":i=this.info(t[0]);break;case"DBSIZE":i=this.dbsize();break;default:return{success:!1,error:`Unknown command: ${e}`,latency:Date.now()-s}}const a=Date.now()-s;return this.recordOperation(),{success:!0,value:i,latency:a}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Unknown error",latency:Date.now()-s}}}recordOperation(){this.operationCount++,this.operationHistory.push({timestamp:Date.now()}),this.operationHistory.length>1e3&&this.operationHistory.shift()}get(e){if(!this.isKeyForThisNode(e))throw new Error("MOVED - key belongs to different node");const t=this.keys.get(e);return t?this.isExpired(t)?(this.deleteKey(e),this.metrics.missCount++,null):(this.metrics.hitCount++,typeof t.value=="string"?t.value:JSON.stringify(t.value)):(this.metrics.missCount++,null)}set(e,t,s){if(!this.isKeyForThisNode(e))throw new Error("MOVED - key belongs to different node");this.checkMemoryAndEvict();const n=this.keys.get(e);n&&(this.currentMemoryUsage-=this.calculateKeySize(n));const i={key:e,type:"string",value:t,ttl:s!==void 0?s:n?.ttl,expiresAt:s!==void 0&&s>0?Date.now()+s*1e3:n?.expiresAt,size:this.estimateSize(t)};return this.keys.set(e,i),this.currentMemoryUsage+=this.calculateKeySize(i),"OK"}del(e){let t=0;for(const s of e)this.deleteKey(s)&&t++;return t}exists(e){let t=0;for(const s of e){const n=this.keys.get(s);n&&!this.isExpired(n)&&t++}return t}expire(e,t){const s=this.keys.get(e);return s?this.isExpired(s)?(this.deleteKey(e),0):(s.ttl=t,s.expiresAt=t>0?Date.now()+t*1e3:void 0,1):0}ttl(e){const t=this.keys.get(e);if(!t)return-2;if(this.isExpired(t))return this.deleteKey(e),-2;if(!t.expiresAt)return-1;const s=Math.floor((t.expiresAt-Date.now())/1e3);return s>0?s:-2}keys(e){const t=this.patternToRegex(e),s=[];for(const[n,i]of this.keys.entries()){if(this.isExpired(i)){this.deleteKey(n);continue}t.test(n)&&s.push(n)}return s}hget(e,t){const s=this.keys.get(e);return!s||s.type!=="hash"?null:this.isExpired(s)?(this.deleteKey(e),null):s.value[t]||null}hset(e,t){if(!this.isKeyForThisNode(e))throw new Error("MOVED - key belongs to different node");this.checkMemoryAndEvict();let s=this.keys.get(e);(!s||s.type!=="hash")&&(s&&(this.currentMemoryUsage-=this.calculateKeySize(s)),s={key:e,type:"hash",value:{},size:0});const n=s.value;let i=0;for(let a=0;a<t.length;a+=2){const o=t[a],l=t[a+1];n[o]||i++,n[o]=l}return s.size=this.estimateSize(JSON.stringify(n)),this.keys.set(e,s),this.currentMemoryUsage+=this.calculateKeySize(s),i}hgetall(e){const t=this.keys.get(e);return!t||t.type!=="hash"?{}:this.isExpired(t)?(this.deleteKey(e),{}):{...t.value}}hdel(e,t){const s=this.keys.get(e);if(!s||s.type!=="hash")return 0;if(this.isExpired(s))return this.deleteKey(e),0;const n=s.value;let i=0;for(const a of t)n[a]&&(delete n[a],i++);return i>0&&(s.size=this.estimateSize(JSON.stringify(n)),this.keys.set(e,s)),i}hkeys(e){const t=this.keys.get(e);return!t||t.type!=="hash"?[]:this.isExpired(t)?(this.deleteKey(e),[]):Object.keys(t.value)}hvals(e){const t=this.keys.get(e);return!t||t.type!=="hash"?[]:this.isExpired(t)?(this.deleteKey(e),[]):Object.values(t.value)}lpush(e,t){if(!this.isKeyForThisNode(e))throw new Error("MOVED - key belongs to different node");this.checkMemoryAndEvict();let s=this.keys.get(e);(!s||s.type!=="list")&&(s&&(this.currentMemoryUsage-=this.calculateKeySize(s)),s={key:e,type:"list",value:[],size:0});const n=s.value;return n.unshift(...t),s.size=this.estimateSize(JSON.stringify(n)),this.keys.set(e,s),this.currentMemoryUsage+=this.calculateKeySize(s),n.length}rpush(e,t){if(!this.isKeyForThisNode(e))throw new Error("MOVED - key belongs to different node");this.checkMemoryAndEvict();let s=this.keys.get(e);(!s||s.type!=="list")&&(s&&(this.currentMemoryUsage-=this.calculateKeySize(s)),s={key:e,type:"list",value:[],size:0});const n=s.value;return n.push(...t),s.size=this.estimateSize(JSON.stringify(n)),this.keys.set(e,s),this.currentMemoryUsage+=this.calculateKeySize(s),n.length}lpop(e){const t=this.keys.get(e);if(!t||t.type!=="list")return null;if(this.isExpired(t))return this.deleteKey(e),null;const s=t.value;if(s.length===0)return null;const n=s.shift();return t.size=this.estimateSize(JSON.stringify(s)),this.keys.set(e,t),n}rpop(e){const t=this.keys.get(e);if(!t||t.type!=="list")return null;if(this.isExpired(t))return this.deleteKey(e),null;const s=t.value;if(s.length===0)return null;const n=s.pop();return t.size=this.estimateSize(JSON.stringify(s)),this.keys.set(e,t),n}llen(e){const t=this.keys.get(e);return!t||t.type!=="list"?0:this.isExpired(t)?(this.deleteKey(e),0):t.value.length}lrange(e,t,s){const n=this.keys.get(e);if(!n||n.type!=="list")return[];if(this.isExpired(n))return this.deleteKey(e),[];const i=n.value,a=i.length,o=t<0?Math.max(0,a+t):Math.min(t,a),l=s<0?Math.max(0,a+s):Math.min(s,a-1);return i.slice(o,l+1)}sadd(e,t){if(!this.isKeyForThisNode(e))throw new Error("MOVED - key belongs to different node");this.checkMemoryAndEvict();let s=this.keys.get(e);(!s||s.type!=="set")&&(s&&(this.currentMemoryUsage-=this.calculateKeySize(s)),s={key:e,type:"set",value:new Set,size:0});const n=s.value;let i=0;for(const a of t)n.has(a)||(n.add(a),i++);return s.size=this.estimateSize(JSON.stringify(Array.from(n))),this.keys.set(e,s),this.currentMemoryUsage+=this.calculateKeySize(s),i}srem(e,t){const s=this.keys.get(e);if(!s||s.type!=="set")return 0;if(this.isExpired(s))return this.deleteKey(e),0;const n=s.value;let i=0;for(const a of t)n.has(a)&&(n.delete(a),i++);return i>0&&(s.size=this.estimateSize(JSON.stringify(Array.from(n))),this.keys.set(e,s)),i}smembers(e){const t=this.keys.get(e);return!t||t.type!=="set"?[]:this.isExpired(t)?(this.deleteKey(e),[]):Array.from(t.value)}sismember(e,t){const s=this.keys.get(e);return!s||s.type!=="set"?0:this.isExpired(s)?(this.deleteKey(e),0):s.value.has(t)?1:0}scard(e){const t=this.keys.get(e);return!t||t.type!=="set"?0:this.isExpired(t)?(this.deleteKey(e),0):t.value.size}zadd(e,t){if(!this.isKeyForThisNode(e))throw new Error("MOVED - key belongs to different node");this.checkMemoryAndEvict();let s=this.keys.get(e);(!s||s.type!=="zset")&&(s&&(this.currentMemoryUsage-=this.calculateKeySize(s)),s={key:e,type:"zset",value:new Map,size:0});const n=s.value;let i=0;for(let a=0;a<t.length;a+=2){const o=parseFloat(t[a]),l=t[a+1];n.has(l)||i++,n.set(l,o)}return s.size=this.estimateSize(JSON.stringify(Array.from(n.entries()))),this.keys.set(e,s),this.currentMemoryUsage+=this.calculateKeySize(s),i}zrem(e,t){const s=this.keys.get(e);if(!s||s.type!=="zset")return 0;if(this.isExpired(s))return this.deleteKey(e),0;const n=s.value;let i=0;for(const a of t)n.has(a)&&(n.delete(a),i++);return i>0&&(s.size=this.estimateSize(JSON.stringify(Array.from(n.entries()))),this.keys.set(e,s)),i}zrange(e,t,s){const n=this.keys.get(e);if(!n||n.type!=="zset")return[];if(this.isExpired(n))return this.deleteKey(e),[];const i=n.value,a=Array.from(i.entries()).sort((h,p)=>h[1]-p[1]),o=a.length,l=t<0?Math.max(0,o+t):Math.min(t,o),d=s<0?Math.max(0,o+s):Math.min(s,o-1);return a.slice(l,d+1).map(h=>h[0])}zscore(e,t){const s=this.keys.get(e);return!s||s.type!=="zset"?null:this.isExpired(s)?(this.deleteKey(e),null):s.value.get(t)??null}zcard(e){const t=this.keys.get(e);return!t||t.type!=="zset"?0:this.isExpired(t)?(this.deleteKey(e),0):t.value.size}info(e){const t=this.getMetrics();return`# Server
redis_version:7.2.0
redis_mode:${this.config.enableCluster?"cluster":"standalone"}

# Memory
used_memory:${t.memoryUsage}
used_memory_human:${this.formatBytes(t.memoryUsage)}
maxmemory:${this.maxMemoryBytes}
maxmemory_human:${this.formatBytes(this.maxMemoryBytes)}
maxmemory_policy:${this.config.maxMemoryPolicy||"noeviction"}
mem_fragmentation_ratio:1.0

# Stats
total_keys:${t.totalKeys}
expired_keys:${t.expiredKeys}
evicted_keys:${t.evictedKeys}
keyspace_hits:${t.hitCount}
keyspace_misses:${t.missCount}

# Cluster
cluster_enabled:${this.config.enableCluster?1:0}
`}dbsize(){return this.cleanupExpiredKeys(),this.keys.size}setKey(e,t,s,n){const i={key:e,type:t,value:s,ttl:n!==void 0?n:-1,expiresAt:n!==void 0&&n>0?Date.now()+n*1e3:void 0,size:this.estimateSize(typeof s=="string"?s:JSON.stringify(s))};this.keys.set(e,i),this.currentMemoryUsage+=this.calculateKeySize(i)}deleteKey(e){const t=this.keys.get(e);return t?(this.currentMemoryUsage-=this.calculateKeySize(t),this.keys.delete(e),!0):!1}isExpired(e){return e.expiresAt?Date.now()>=e.expiresAt:!1}cleanupExpiredKeys(){let e=0;for(const[t,s]of this.keys.entries())this.isExpired(s)&&(this.deleteKey(t),e++);e>0&&(this.metrics.expiredKeys+=e)}checkMemoryAndEvict(){if(this.currentMemoryUsage<=this.maxMemoryBytes)return;const e=this.config.maxMemoryPolicy||"noeviction";if(e==="noeviction")return;const t=this.selectKeysToEvict(e);let s=0;for(const n of t)if(this.deleteKey(n),s++,this.currentMemoryUsage<=this.maxMemoryBytes*.9)break;s>0&&(this.metrics.evictedKeys+=s)}selectKeysToEvict(e){const t=Array.from(this.keys.keys());switch(e){case"allkeys-lru":case"allkeys-lfu":case"allkeys-random":return t;case"volatile-lru":case"volatile-lfu":case"volatile-ttl":case"volatile-random":return t.filter(s=>{const n=this.keys.get(s);return n&&n.expiresAt!==void 0});default:return[]}}calculateKeySize(e){if(e.size)return e.size;let t=0;return typeof e.value=="string"?t=Buffer.byteLength(e.value,"utf8"):t=Buffer.byteLength(JSON.stringify(e.value),"utf8"),Buffer.byteLength(e.key,"utf8")+t+100}estimateSize(e){return Buffer.byteLength(e,"utf8")}patternToRegex(e){const t=e.replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*").replace(/\?/g,".");return new RegExp(`^${t}$`)}formatBytes(e){if(e===0)return"0B";const t=1024,s=["B","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,n)*100)/100+s[n]}getMetrics(){return this.cleanupExpiredKeys(),this.updateMetrics(),{...this.metrics}}updateMetrics(){const e=Date.now();(e-this.lastMetricsUpdate)/1e3;const t={string:0,hash:0,list:0,set:0,zset:0,stream:0};for(const a of this.keys.values())t[a.type]++;const s=this.operationHistory.filter(a=>a.timestamp>e-1e3).length,n=this.metrics.hitCount+this.metrics.missCount,i=n>0?this.metrics.hitCount/n:0;this.metrics={totalKeys:this.keys.size,keysByType:t,memoryUsage:this.currentMemoryUsage,memoryUsagePercent:this.maxMemoryBytes>0?this.currentMemoryUsage/this.maxMemoryBytes*100:0,operationsPerSecond:s,hitCount:this.metrics.hitCount,missCount:this.metrics.missCount,hitRate:i,expiredKeys:this.metrics.expiredKeys,evictedKeys:this.metrics.evictedKeys,connectedClients:1},this.lastMetricsUpdate=e}getAllKeys(){return this.cleanupExpiredKeys(),Array.from(this.keys.values())}getKey(e){const t=this.keys.get(e);if(t&&this.isExpired(t)){this.deleteKey(e);return}return t}syncKeysFromConfig(e){const t=new Map;for(const s of e)t.set(s.key,s);for(const[s,n]of this.keys.entries());for(const s of e){const n=this.keys.get(s.key);if(!n)this.setKey(s.key,s.type,s.value,s.ttl);else if(n.type!==s.type||JSON.stringify(n.value)!==JSON.stringify(s.value)||n.ttl!==s.ttl){this.currentMemoryUsage-=this.calculateKeySize(n);const i={...s,expiresAt:s.ttl!==void 0&&s.ttl>0?Date.now()+s.ttl*1e3:void 0,size:this.estimateSize(typeof s.value=="string"?s.value:JSON.stringify(s.value))};this.keys.set(s.key,i),this.currentMemoryUsage+=this.calculateKeySize(i)}}this.updateMetrics()}}class rk{clusterName="archiphoenix-cluster";nodes=new Map;keyspaces=new Map;tables=new Map;tableData=new Map;defaultConsistencyLevel="QUORUM";defaultReplicationFactor=3;enableCompaction=!0;compactionStrategy="SizeTieredCompactionStrategy";datacenter="dc1";metrics={readLatency:5,writeLatency:10,totalNodes:0,healthyNodes:0,totalKeyspaces:0,totalTables:0,totalRows:0,totalSize:0,readOperationsPerSecond:0,writeOperationsPerSecond:0,readConsistencyViolations:0,writeConsistencyViolations:0,pendingCompactions:0,hintedHandoffs:0};readOperations=[];writeOperations=[];lastMetricsUpdate=Date.now();initialize(e){if(this.clusterName=e.clusterName||"archiphoenix-cluster",this.defaultConsistencyLevel=e.defaultConsistencyLevel||"QUORUM",this.defaultReplicationFactor=e.defaultReplicationFactor||3,this.enableCompaction=e.enableCompaction??!0,this.compactionStrategy=e.compactionStrategy||"SizeTieredCompactionStrategy",this.datacenter=e.datacenter||"dc1",this.nodes.clear(),e.nodes)for(const t of e.nodes)this.nodes.set(t.address,{...t});else this.nodes.set("localhost:9042",{address:"localhost:9042",status:"up",load:.5,tokens:256});if(this.keyspaces.clear(),e.keyspaces)for(const t of e.keyspaces)this.keyspaces.set(t.name,{...t});else this.keyspaces.set("system",{name:"system",replication:3,replicationStrategy:"NetworkTopologyStrategy",tables:0,size:0,durableWrites:!0});if(this.tables.clear(),this.tableData.clear(),e.tables)for(const t of e.tables){const s=`${t.keyspace}.${t.name}`;this.tables.set(s,{...t}),this.tableData.set(s,[])}this.updateMetrics()}syncFromConfig(e){if(e.clusterName&&(this.clusterName=e.clusterName),e.defaultConsistencyLevel&&(this.defaultConsistencyLevel=e.defaultConsistencyLevel),e.defaultReplicationFactor!==void 0&&(this.defaultReplicationFactor=e.defaultReplicationFactor),e.nodes)for(const t of e.nodes)this.nodes.set(t.address,{...t});if(e.keyspaces){new Set(this.keyspaces.keys());for(const t of e.keyspaces)this.keyspaces.set(t.name,{...t,tables:this.countTablesInKeyspace(t.name)})}if(e.tables)for(const t of e.tables){const s=`${t.keyspace}.${t.name}`,n=this.tables.get(s);if(n){const i=this.tableData.get(s)||[];this.tables.set(s,{...t,rows:n.rows||i.length||0,size:n.size||i.length*1024||0})}else this.tables.set(s,{...t,rows:0,size:0}),this.tableData.has(s)||this.tableData.set(s,[])}this.updateMetrics()}executeCQL(e,t){const s=Date.now(),n=t||this.defaultConsistencyLevel;try{const i=e.trim().replace(/\s+/g," "),a=i.toUpperCase();return a.startsWith("SELECT")?this.executeSelect(i,n,s):a.startsWith("INSERT")?this.executeInsert(i,n,s):a.startsWith("UPDATE")?this.executeUpdate(i,n,s):a.startsWith("DELETE")?this.executeDelete(i,n,s):a.startsWith("CREATE KEYSPACE")?this.executeCreateKeyspace(i,s):a.startsWith("CREATE TABLE")?this.executeCreateTable(i,s):a.startsWith("DROP TABLE")?this.executeDropTable(i,s):a.startsWith("DROP KEYSPACE")?this.executeDropKeyspace(i,s):{success:!1,error:`Unsupported CQL statement: ${i}`,latency:Date.now()-s}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Unknown error",latency:Date.now()-s}}}executeSelect(e,t,s){const n=e.match(/FROM\s+([\w.]+)/i);if(!n)return{success:!1,error:"Invalid SELECT query: missing FROM clause",latency:Date.now()-s};const i=n[1].trim(),a=this.normalizeTableKey(i),o=this.tables.get(a);if(!o)return{success:!1,error:`Table ${i} does not exist`,latency:Date.now()-s};const l=this.tableData.get(a)||[],d=e.match(/LIMIT\s+(\d+)/i),h=d?parseInt(d[1],10):void 0;let p=[...l];const g=e.match(/WHERE\s+(.+?)(?:\s+LIMIT|$)/i);if(g){const S=g[1].trim().match(/(\w+)\s*=\s*['"]?([^'"\s]+)['"]?/);if(S){const T=S[1],E=S[2];p=l.filter(A=>String(A[T])===E)}}h!==void 0&&h>0&&(p=p.slice(0,h));const v=this.calculateReadLatency(t),b=this.checkConsistencyViolation(t,o.keyspace);this.recordReadOperation(v,b);const M=this.getRequiredReplicas(t,o.keyspace);return{success:!0,latency:v,consistency:t,rows:p,rowCount:p.length,replicasQueried:M}}executeInsert(e,t,s){const n=e.match(/INTO\s+([\w.]+)/i);if(!n)return{success:!1,error:"Invalid INSERT query: missing INTO clause",latency:Date.now()-s};const i=n[1].trim(),a=this.normalizeTableKey(i);let o=this.tables.get(a);if(!o)return{success:!1,error:`Table ${i} does not exist`,latency:Date.now()-s};const l=e.match(/\(([^)]+)\)\s*VALUES/i),d=e.match(/VALUES\s*\(([^)]+)\)/i);if(!l||!d)return{success:!1,error:"Invalid INSERT query: missing columns or values",latency:Date.now()-s};const h=l[1].split(",").map(T=>T.trim()),p=d[1],g=this.parseValueList(p);if(h.length!==g.length)return{success:!1,error:"Column count does not match value count",latency:Date.now()-s};const v={};for(let T=0;T<h.length;T++)v[h[T]]=g[T];const b=this.tableData.get(a)||[];b.push(v),this.tableData.set(a,b),o.rows=b.length,o.size=b.length*1024,this.tables.set(a,o);const M=this.calculateWriteLatency(t,o.keyspace),x=this.checkConsistencyViolation(t,o.keyspace);this.recordWriteOperation(M,x);const S=this.getRequiredReplicas(t,o.keyspace);return this.updateMetrics(),{success:!0,latency:M,consistency:t,rowCount:1,replicasQueried:S}}executeUpdate(e,t,s){const n=e.match(/UPDATE\s+([\w.]+)\s+SET/i);if(!n)return{success:!1,error:"Invalid UPDATE query",latency:Date.now()-s};const i=n[1].trim(),a=this.normalizeTableKey(i),o=this.tables.get(a);if(!o)return{success:!1,error:`Table ${i} does not exist`,latency:Date.now()-s};const l=e.match(/SET\s+(.+?)(?:\s+WHERE|$)/i);if(!l)return{success:!1,error:"Invalid UPDATE query: missing SET clause",latency:Date.now()-s};const d=l[1].trim(),h={},p=d.split(",").map(D=>D.trim());for(const D of p){const L=D.match(/(\w+)\s*=\s*(.+)/);if(L){const I=L[1].trim(),U=this.parseValue(L[2].trim());h[I]=U}}const g=e.match(/WHERE\s+(.+)/i);if(!g)return{success:!1,error:"UPDATE requires WHERE clause",latency:Date.now()-s};const b=g[1].trim().match(/(\w+)\s*=\s*['"]?([^'"\s]+)['"]?/);if(!b)return{success:!1,error:"Unsupported WHERE clause format",latency:Date.now()-s};const M=b[1],x=b[2],S=this.tableData.get(a)||[];let T=0;for(const D of S)String(D[M])===x&&(Object.assign(D,h),T++);o.rows=S.length,o.size=S.length*1024,this.tables.set(a,o);const E=this.calculateWriteLatency(t,o.keyspace),A=this.checkConsistencyViolation(t,o.keyspace);this.recordWriteOperation(E,A);const k=this.getRequiredReplicas(t,o.keyspace);return this.updateMetrics(),{success:!0,latency:E,consistency:t,rowCount:T,replicasQueried:k}}executeDelete(e,t,s){const n=e.match(/FROM\s+([\w.]+)/i);if(!n)return{success:!1,error:"Invalid DELETE query: missing FROM clause",latency:Date.now()-s};const i=n[1].trim(),a=this.normalizeTableKey(i),o=this.tables.get(a);if(!o)return{success:!1,error:`Table ${i} does not exist`,latency:Date.now()-s};const l=e.match(/WHERE\s+(.+)/i);if(!l)return{success:!1,error:"DELETE requires WHERE clause",latency:Date.now()-s};const h=l[1].trim().match(/(\w+)\s*=\s*['"]?([^'"\s]+)['"]?/);if(!h)return{success:!1,error:"Unsupported WHERE clause format",latency:Date.now()-s};const p=h[1],g=h[2],v=this.tableData.get(a)||[],b=v.length,M=v.filter(A=>String(A[p])!==g);this.tableData.set(a,M),o.rows=M.length,o.size=M.length*1024,this.tables.set(a,o);const x=b-M.length,S=this.calculateWriteLatency(t,o.keyspace),T=this.checkConsistencyViolation(t,o.keyspace);this.recordWriteOperation(S,T);const E=this.getRequiredReplicas(t,o.keyspace);return this.updateMetrics(),{success:!0,latency:S,consistency:t,rowCount:x,replicasQueried:E}}executeCreateKeyspace(e,t){const s=e.match(/KEYSPACE\s+(\w+)/i);if(!s)return{success:!1,error:"Invalid CREATE KEYSPACE query",latency:Date.now()-t};const n=s[1].trim();if(this.keyspaces.has(n))return{success:!1,error:`Keyspace ${n} already exists`,latency:Date.now()-t};let i=this.defaultReplicationFactor;const a=e.match(/replication.*?(\d+)/i);return a&&(i=parseInt(a[1],10)),this.keyspaces.set(n,{name:n,replication:i,replicationStrategy:"NetworkTopologyStrategy",tables:0,size:0,durableWrites:!0}),this.updateMetrics(),{success:!0,latency:Date.now()-t,rowCount:0}}executeCreateTable(e,t){const s=e.match(/TABLE\s+([\w.]+)/i);if(!s)return{success:!1,error:"Invalid CREATE TABLE query",latency:Date.now()-t};const n=s[1].trim(),i=this.normalizeTableKey(n);if(this.tables.has(i))return{success:!1,error:`Table ${n} already exists`,latency:Date.now()-t};let a=e;const o=e.toUpperCase().indexOf(" WITH ");o>0&&(a=e.substring(0,o));const l=a.match(/\(([^)]+)\)/);if(!l)return{success:!1,error:"Invalid CREATE TABLE query: missing column definitions",latency:Date.now()-t};const d=l[1],h=[],p=d.split(",").map(S=>S.trim());for(const S of p){if(S.toUpperCase().includes("PRIMARY KEY"))continue;const T=S.match(/(\w+)\s+(\w+)/);T&&h.push({name:T[1],type:T[2]})}const g=n.split("."),v=g.length>1?g[0]:"system",b=g.length>1?g[1]:g[0];if(!this.keyspaces.has(v))return{success:!1,error:`Keyspace ${v} does not exist`,latency:Date.now()-t};const M={name:b,keyspace:v,columns:h,rows:0,size:0};this.tables.set(i,M),this.tableData.set(i,[]);const x=this.keyspaces.get(v);return x&&(x.tables=this.countTablesInKeyspace(v),this.keyspaces.set(v,x)),this.updateMetrics(),{success:!0,latency:Date.now()-t,rowCount:0}}executeDropTable(e,t){const s=e.match(/TABLE\s+([\w.]+)/i);if(!s)return{success:!1,error:"Invalid DROP TABLE query",latency:Date.now()-t};const n=s[1].trim(),i=this.normalizeTableKey(n);if(!this.tables.has(i))return{success:!1,error:`Table ${n} does not exist`,latency:Date.now()-t};const a=this.tables.get(i);this.tables.delete(i),this.tableData.delete(i);const o=this.keyspaces.get(a.keyspace);return o&&(o.tables=this.countTablesInKeyspace(a.keyspace),this.keyspaces.set(a.keyspace,o)),this.updateMetrics(),{success:!0,latency:Date.now()-t,rowCount:0}}executeDropKeyspace(e,t){const s=e.match(/KEYSPACE\s+(\w+)/i);if(!s)return{success:!1,error:"Invalid DROP KEYSPACE query",latency:Date.now()-t};const n=s[1].trim();if(!this.keyspaces.has(n))return{success:!1,error:`Keyspace ${n} does not exist`,latency:Date.now()-t};const i=[];for(const[a,o]of this.tables.entries())o.keyspace===n&&i.push(a);for(const a of i)this.tables.delete(a),this.tableData.delete(a);return this.keyspaces.delete(n),this.updateMetrics(),{success:!0,latency:Date.now()-t,rowCount:0}}getNodes(){return Array.from(this.nodes.values())}getKeyspaces(){return Array.from(this.keyspaces.values())}getTables(){return Array.from(this.tables.values())}getMetrics(){return this.updateMetrics(),{...this.metrics}}calculateReadLatency(e){const s=this.getRequiredReplicas(e,"system"),n=Math.log(s+1)*3,i=Math.random()*2;return Math.round(2+n+i)}calculateWriteLatency(e,t){const i=this.getRequiredReplicas(e,t)*2,a=Math.random()*3;return Math.round(5+i+a)}getRequiredReplicas(e,t){const n=this.keyspaces.get(t)?.replication||this.defaultReplicationFactor;switch(e){case"ONE":case"LOCAL_ONE":return 1;case"TWO":return 2;case"THREE":return 3;case"QUORUM":case"LOCAL_QUORUM":return Math.floor(n/2)+1;case"ALL":case"EACH_QUORUM":return n;case"SERIAL":case"LOCAL_SERIAL":return Math.floor(n/2)+1;default:return Math.floor(n/2)+1}}checkConsistencyViolation(e,t){const s=this.metrics.healthyNodes,n=this.getRequiredReplicas(e,t),i=s<n?.8:.05;return Math.random()<i}recordReadOperation(e,t){const s=Date.now();this.readOperations.push({timestamp:s,latency:e,violated:t}),this.readOperations.length>1e3&&this.readOperations.shift(),t&&this.metrics.readConsistencyViolations++}recordWriteOperation(e,t){const s=Date.now();this.writeOperations.push({timestamp:s,latency:e,violated:t}),this.writeOperations.length>1e3&&this.writeOperations.shift(),t&&this.metrics.writeConsistencyViolations++}updateMetrics(){const e=Date.now();(e-this.lastMetricsUpdate)/1e3,this.metrics.totalNodes=this.nodes.size,this.metrics.healthyNodes=Array.from(this.nodes.values()).filter(d=>d.status==="up").length,this.metrics.totalKeyspaces=this.keyspaces.size,this.metrics.totalTables=this.tables.size;let t=0,s=0;for(const[d,h]of this.tableData.entries())t+=h.length,s+=h.length*1024;this.metrics.totalRows=t,this.metrics.totalSize=s;const n=e-1e3,i=this.readOperations.filter(d=>d.timestamp>n),a=this.writeOperations.filter(d=>d.timestamp>n);if(this.metrics.readOperationsPerSecond=i.length,this.metrics.writeOperationsPerSecond=a.length,i.length>0){const d=i.reduce((h,p)=>h+p.latency,0)/i.length;this.metrics.readLatency=Math.round(d*10)/10}if(a.length>0){const d=a.reduce((h,p)=>h+p.latency,0)/a.length;this.metrics.writeLatency=Math.round(d*10)/10}this.metrics.pendingCompactions=Math.floor(this.metrics.totalSize/(10*1024*1024));const o=this.metrics.totalNodes-this.metrics.healthyNodes;this.metrics.hintedHandoffs=o>0?o*5:0;const l=this.metrics.readOperationsPerSecond+this.metrics.writeOperationsPerSecond;for(const d of this.nodes.values())if(d.status==="up"){const h=Math.min(.95,.3+l/100*.3);d.load=d.load*.9+h*.1,d.load+=(Math.random()-.5)*.05,d.load=Math.max(.1,Math.min(.95,d.load))}this.lastMetricsUpdate=e}countTablesInKeyspace(e){let t=0;for(const s of this.tables.values())s.keyspace===e&&t++;return t}normalizeTableKey(e){return e.includes(".")?e:`system.${e}`}parseValueList(e){const t=[];let s="",n=!1,i="";for(let a=0;a<e.length;a++){const o=e[a];if((o==='"'||o==="'")&&!n){n=!0,i=o;continue}else if(o===i&&n){n=!1,i="";continue}o===","&&!n?(t.push(this.parseValue(s.trim())),s=""):s+=o}return s.trim()&&t.push(this.parseValue(s.trim())),t}parseValue(e){return e=e.trim(),e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):/^-?\d+$/.test(e)?parseInt(e,10):/^-?\d*\.\d+$/.test(e)?parseFloat(e):e.toUpperCase()==="TRUE"?!0:e.toUpperCase()==="FALSE"?!1:e.toUpperCase()==="NULL"?null:e}}class ck{cluster="archiphoenix-cluster";replication=!1;tables=new Map;tableData=new Map;tableParts=new Map;maxMemoryUsage=10*1024*1024*1024;compression="LZ4";metrics={queryThroughput:0,avgQueryTime:45,queriesPerSecond:0,readRowsPerSecond:0,writtenRowsPerSecond:0,totalRows:0,totalSize:0,compressionRatio:5,activeQueries:0,memoryUsage:0,memoryUsagePercent:0,partsCount:0,pendingMerges:0,totalTables:0,clusterNodes:1,healthyNodes:1};queryOperations=[];lastMetricsUpdate=Date.now();activeQueriesSet=new Set;initialize(e){if(this.cluster=e.cluster||"archiphoenix-cluster",this.replication=e.replication||!1,this.maxMemoryUsage=e.maxMemoryUsage||10*1024*1024*1024,this.compression=e.compression||"LZ4",this.tables.clear(),this.tableData.clear(),this.tableParts.clear(),e.tables)for(const t of e.tables){const s=`${t.database||"default"}.${t.name}`;this.tables.set(s,{...t}),this.tableData.set(s,[]),this.tableParts.set(s,[])}this.updateMetrics()}syncFromConfig(e){if(e.cluster&&(this.cluster=e.cluster),e.replication!==void 0&&(this.replication=e.replication),e.maxMemoryUsage&&(this.maxMemoryUsage=e.maxMemoryUsage),e.compression&&(this.compression=e.compression),e.tables)for(const t of e.tables){const s=`${t.database||"default"}.${t.name}`,n=this.tables.get(s),i=this.tableData.get(s)||[];n?this.tables.set(s,{...t,rows:n.rows||i.length||0,size:n.size||i.length*512||0}):(this.tables.set(s,{...t,rows:0,size:0}),this.tableData.has(s)||(this.tableData.set(s,[]),this.tableParts.set(s,[])))}this.updateMetrics()}executeQuery(e){const t=Date.now(),s=`query-${Date.now()}-${Math.random()}`;try{const n=e.trim().replace(/\s+/g," "),i=n.toUpperCase();this.activeQueriesSet.add(s),this.metrics.activeQueries=this.activeQueriesSet.size;let a;i.startsWith("SELECT")?a=this.executeSelect(n,t):i.startsWith("INSERT")?a=this.executeInsert(n,t):i.startsWith("ALTER")?a=this.executeAlter(n,t):i.startsWith("CREATE TABLE")?a=this.executeCreateTable(n,t):i.startsWith("DROP TABLE")?a=this.executeDropTable(n,t):a={success:!1,error:`Unsupported SQL statement: ${n}`,latency:Date.now()-t};const o=a.latency||Date.now()-t;return this.queryOperations.push({timestamp:Date.now(),latency:o,rowsRead:a.dataRead||0,rowsWritten:a.dataWritten||0}),this.activeQueriesSet.delete(s),this.metrics.activeQueries=this.activeQueriesSet.size,a}catch(n){return this.activeQueriesSet.delete(s),this.metrics.activeQueries=this.activeQueriesSet.size,{success:!1,error:n instanceof Error?n.message:"Unknown error",latency:Date.now()-t}}}executeSelect(e,t){const s=e.match(/FROM\s+([\w.]+)/i);if(!s)return{success:!1,error:"Invalid SELECT query: missing FROM clause",latency:Date.now()-t};const n=s[1].trim(),i=this.normalizeTableKey(n),a=this.tables.get(i);if(!a)return{success:!1,error:`Table ${n} does not exist`,latency:Date.now()-t};const o=this.tableData.get(i)||[],l=e.match(/SELECT\s+(.+?)\s+FROM/i),d=l?l[1].trim().split(",").map(T=>T.trim()):["*"];let h=[...o];const p=e.match(/WHERE\s+(.+?)(?:\s+GROUP\s+BY|\s+ORDER\s+BY|\s+LIMIT|$)/i);if(p){const E=p[1].trim().match(/(\w+)\s*=\s*['"]?([^'"\s]+)['"]?/);if(E){const A=E[1],k=E[2];h=o.filter(D=>String(D[A])===k)}}const g=e.match(/GROUP\s+BY\s+(\w+)/i);if(g){const T=g[1],E=new Map;h.forEach(A=>{const k=String(A[T]||"null");E.set(k,(E.get(k)||0)+1)}),h=Array.from(E.entries()).map(([A,k])=>({[T]:A,count:k}))}const v=e.match(/ORDER\s+BY\s+(\w+)(?:\s+(ASC|DESC))?/i);if(v){const T=v[1],E=(v[2]||"ASC").toUpperCase();h.sort((A,k)=>{const D=A[T],L=k[T];return E==="DESC"?D>L?-1:D<L?1:0:D<L?-1:D>L?1:0})}const b=e.match(/LIMIT\s+(\d+)/i),M=b?parseInt(b[1],10):void 0;M!==void 0&&M>0&&(h=h.slice(0,M));const x=this.calculateQueryLatency(e,a,h.length);let S=h;return!d.includes("*")&&d.length>0&&(S=h.map(T=>{const E={};return d.forEach(A=>{T.hasOwnProperty(A)&&(E[A]=T[A])}),E})),{success:!0,latency:x,rows:S,rowCount:S.length,columns:d.includes("*")?Object.keys(o[0]||{}):d,dataRead:o.length}}executeInsert(e,t){const s=e.match(/INTO\s+([\w.]+)/i);if(!s)return{success:!1,error:"Invalid INSERT query: missing INTO clause",latency:Date.now()-t};const n=s[1].trim(),i=this.normalizeTableKey(n);let a=this.tables.get(i);if(!a)return{success:!1,error:`Table ${n} does not exist`,latency:Date.now()-t};const o=e.match(/VALUES\s+(.+)/i);if(!o)return{success:!1,error:"Invalid INSERT query: missing VALUES clause",latency:Date.now()-t};const l=o[1].trim(),d=this.parseValues(l),h=this.tableData.get(i)||[],p={},g=e.match(/\(([^)]+)\)\s+VALUES/i),v=g?g[1].split(",").map(M=>M.trim()):[];v.length>0&&v.length===d.length?v.forEach((M,x)=>{p[M]=d[x]}):d.forEach((M,x)=>{p[`column_${x}`]=M}),h.push(p),this.tableData.set(i,h),a.rows=h.length,a.size=h.length*512,this.tables.set(i,a);const b=10+Math.random()*5;return this.simulatePartCreation(i),this.updateMetrics(),{success:!0,latency:b,rowCount:1,dataWritten:1}}executeCreateTable(e,t){const s=e.match(/CREATE\s+TABLE\s+([\w.]+)/i);if(!s)return{success:!1,error:"Invalid CREATE TABLE query",latency:Date.now()-t};const n=s[1].trim(),i=this.normalizeTableKey(n);if(this.tables.has(i))return{success:!1,error:`Table ${n} already exists`,latency:Date.now()-t};const a=e.match(/ENGINE\s*=\s*(\w+)/i),o=a?a[1]:"MergeTree",[l,d]=i.split("."),h={name:d,database:l||"default",engine:o,rows:0,size:0,partitions:0};return this.tables.set(i,h),this.tableData.set(i,[]),this.tableParts.set(i,[]),this.updateMetrics(),{success:!0,latency:Date.now()-t}}executeDropTable(e,t){const s=e.match(/DROP\s+TABLE\s+([\w.]+)/i);if(!s)return{success:!1,error:"Invalid DROP TABLE query",latency:Date.now()-t};const n=s[1].trim(),i=this.normalizeTableKey(n);return this.tables.has(i)?(this.tables.delete(i),this.tableData.delete(i),this.tableParts.delete(i),this.updateMetrics(),{success:!0,latency:Date.now()-t}):{success:!1,error:`Table ${n} does not exist`,latency:Date.now()-t}}executeAlter(e,t){const s=e.match(/ALTER\s+TABLE\s+([\w.]+)/i);if(!s)return{success:!1,error:"Invalid ALTER TABLE query",latency:Date.now()-t};const n=s[1].trim(),i=this.normalizeTableKey(n);return this.tables.get(i)?{success:!0,latency:Date.now()-t}:{success:!1,error:`Table ${n} does not exist`,latency:Date.now()-t}}calculateQueryLatency(e,t,s){const i=s/1e6*5;let a=1;const o=e.toUpperCase();o.includes("JOIN")&&(a*=2),o.includes("GROUP BY")&&(a*=1.5),o.includes("ORDER BY")&&(a*=1.3),o.includes("COUNT")&&(a*=.8),(o.includes("SUM")||o.includes("AVG"))&&(a*=.9);const l=this.tableParts.get(`${t.database}.${t.name}`)||[],d=Math.min(1.5,1+l.length/100);return 10+i*a*d}parseValues(e){let t=e.trim();t.startsWith("(")&&t.endsWith(")")&&(t=t.slice(1,-1));const s=[];let n="",i=!1,a="";for(let o=0;o<t.length;o++){const l=t[o];(l==='"'||l==="'")&&!i?(i=!0,a=l):l===a&&i?(i=!1,a=""):l===","&&!i?(s.push(this.parseValue(n.trim())),n=""):n+=l}return n.trim()&&s.push(this.parseValue(n.trim())),s}parseValue(e){const t=e.trim();return t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'")?t.slice(1,-1):/^-?\d+$/.test(t)?parseInt(t,10):/^-?\d*\.\d+$/.test(t)?parseFloat(t):t.toLowerCase()==="true"?!0:t.toLowerCase()==="false"?!1:t.toLowerCase()==="null"?null:t}normalizeTableKey(e){return e.includes(".")?e:`default.${e}`}simulatePartCreation(e){const t=this.tableParts.get(e)||[],s=new Date().toISOString().split("T")[0],n={name:`${s}_${t.length+1}`,minDate:s,maxDate:s,rows:1e3,size:512*1e3,level:0};if(t.push(n),this.tableParts.set(e,t),t.length>10){const i=t.splice(0,5),a={name:`merged_${Date.now()}`,minDate:i[0].minDate,maxDate:i[i.length-1].maxDate,rows:i.reduce((o,l)=>o+l.rows,0),size:i.reduce((o,l)=>o+l.size,0),level:Math.max(...i.map(o=>o.level))+1};t.unshift(a),this.tableParts.set(e,t)}}updateMetrics(){const e=Date.now(),t=(e-this.lastMetricsUpdate)/1e3;this.metrics.totalTables=this.tables.size;let s=0,n=0,i=0;for(const[d,h]of this.tables.entries()){s+=h.rows,n+=h.size;const p=this.tableParts.get(d)||[];i+=p.length}this.metrics.totalRows=s,this.metrics.totalSize=n,this.metrics.partsCount=i;const a=e-1e3,o=this.queryOperations.filter(d=>d.timestamp>a);if(this.metrics.queriesPerSecond=o.length,this.metrics.queryThroughput=o.length,o.length>0){const d=o.reduce((g,v)=>g+v.latency,0)/o.length;this.metrics.avgQueryTime=Math.round(d*10)/10;const h=o.reduce((g,v)=>g+v.rowsRead,0),p=o.reduce((g,v)=>g+v.rowsWritten,0);this.metrics.readRowsPerSecond=Math.round(h/t),this.metrics.writtenRowsPerSecond=Math.round(p/t)}const l=n/this.metrics.compressionRatio;this.metrics.memoryUsage=l,this.metrics.memoryUsagePercent=l/this.maxMemoryUsage*100,this.metrics.pendingMerges=Math.floor(i/10),this.metrics.clusterNodes=this.replication?3:1,this.metrics.healthyNodes=this.metrics.clusterNodes,this.lastMetricsUpdate=e}getMetrics(){return this.updateMetrics(),{...this.metrics}}insertData(e,t){const s=this.normalizeTableKey(e),n=this.tables.get(s);if(!n)return{success:!1,rowsInserted:0,error:`Table ${e} does not exist`};const i=this.tableData.get(s)||[];return i.push(...t),this.tableData.set(s,i),n.rows=i.length,n.size=i.length*512,this.tables.set(s,n),this.simulatePartCreation(s),this.updateMetrics(),{success:!0,rowsInserted:t.length}}}const mo={"X-Small":{servers:1,creditsPerHour:1},Small:{servers:2,creditsPerHour:2},Medium:{servers:4,creditsPerHour:4},Large:{servers:8,creditsPerHour:8},"X-Large":{servers:16,creditsPerHour:16},"2X-Large":{servers:32,creditsPerHour:32},"3X-Large":{servers:64,creditsPerHour:64},"4X-Large":{servers:128,creditsPerHour:128}};class lk{account="archiphoenix";region="us-east-1";warehouses=new Map;databases=new Map;tables=new Map;tableData=new Map;queries=new Map;queryQueue=[];activeQueries=new Map;resultCache=new Map;cacheHits=0;cacheMisses=0;metrics={totalWarehouses:0,runningWarehouses:0,suspendedWarehouses:0,totalQueries:0,runningQueries:0,queuedQueries:0,queriesPerSecond:0,avgQueryTime:0,totalComputeTime:0,totalDataRead:0,totalDataWritten:0,cacheHitRate:0,warehouseUtilization:0,totalCost:0};queryOperations=[];lastMetricsUpdate=Date.now();warehouseLastUpdate=new Map;suspendTimers=new Map;initialize(e){if(this.account=e.account||"archiphoenix",this.region=e.region||"us-east-1",this.warehouses.clear(),e.warehouses&&e.warehouses.length>0)for(const t of e.warehouses)this.warehouses.set(t.name,{...t,status:t.status||"suspended",currentClusterCount:t.minClusterCount||1,runningQueries:0,queuedQueries:0,totalQueriesExecuted:0,totalComputeTime:0});else this.warehouses.set("COMPUTE_WH",{name:"COMPUTE_WH",size:"Small",status:"suspended",autoSuspend:60,autoResume:!0,minClusterCount:1,maxClusterCount:1,currentClusterCount:1,runningQueries:0,queuedQueries:0,totalQueriesExecuted:0,totalComputeTime:0});if(this.databases.clear(),this.tables.clear(),this.tableData.clear(),e.databases){for(const t of e.databases)if(this.databases.set(t.name,{...t}),t.schemas){for(const s of t.schemas)if(s.tables)for(const n of s.tables){const i=`${t.name}.${s.name}.${n.name}`;this.tables.set(i,{...n}),this.tableData.set(i,[])}}}this.databases.has("SNOWFLAKE")||this.databases.set("SNOWFLAKE",{name:"SNOWFLAKE",comment:"System database",retentionTime:1,size:0,schemas:[{name:"INFORMATION_SCHEMA",tables:[],views:0,functions:0}]}),this.updateMetrics()}syncFromConfig(e){if(e.account&&(this.account=e.account),e.region&&(this.region=e.region),e.warehouses){for(const s of e.warehouses){const n=this.warehouses.get(s.name);n?(this.warehouses.set(s.name,{...s,status:n.status,currentClusterCount:n.currentClusterCount,runningQueries:n.runningQueries,queuedQueries:n.queuedQueries,totalQueriesExecuted:n.totalQueriesExecuted,totalComputeTime:n.totalComputeTime,lastUsed:n.lastUsed}),this.updateWarehouseAutoSuspend(s.name,s)):this.warehouses.set(s.name,{...s,status:"suspended",currentClusterCount:s.minClusterCount||1,runningQueries:0,queuedQueries:0,totalQueriesExecuted:0,totalComputeTime:0})}const t=new Set(e.warehouses.map(s=>s.name));for(const[s]of this.warehouses.entries())if(!t.has(s)){this.warehouses.delete(s);const n=this.suspendTimers.get(s);n&&(clearTimeout(n),this.suspendTimers.delete(s))}}if(e.databases){for(const t of e.databases)if(this.databases.get(t.name),this.databases.set(t.name,{...t}),t.schemas){for(const s of t.schemas)if(s.tables)for(const n of s.tables){const i=`${t.name}.${s.name}.${n.name}`,a=this.tables.get(i),o=this.tableData.get(i)||[];a?this.tables.set(i,{...n,rows:a.rows||o.length||0,size:a.size||o.length*512||0}):(this.tables.set(i,{...n,rows:0,size:0}),this.tableData.set(i,[]))}}}this.updateMetrics()}executeQuery(e,t,s,n){const i=Date.now(),a=`query-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,o=this.getCacheKey(e,s,n),l=this.resultCache.get(o);if(l&&Date.now()-l.timestamp<l.ttl)return this.cacheHits++,this.updateMetrics(),{success:!0,latency:10,rows:l.data,rowCount:l.data.length,queryId:a,resultCacheUsed:!0};this.cacheMisses++;let d;if(t?d=this.warehouses.get(t):d=Array.from(this.warehouses.values()).find(p=>p.status==="running")||Array.from(this.warehouses.values())[0],!d)return{success:!1,error:"No warehouse available",latency:Date.now()-i,queryId:a};const h={id:a,queryText:e,status:"queued",warehouse:d.name,database:s,schema:n,startedAt:i};return this.queries.set(a,h),d.status==="suspended"&&d.autoResume&&this.resumeWarehouse(d.name),d.status==="running"?this.executeQueryOnWarehouse(h,d,i):(d.queuedQueries++,this.queryQueue.push(h),h.status="queued",d.autoResume&&this.resumeWarehouse(d.name),d.status==="running"&&this.processQueryQueue(d),{success:!0,latency:50,queryId:a,warehouse:d.name})}executeQueryOnWarehouse(e,t,s){e.status="running",e.startedAt=Date.now(),t.runningQueries++,this.activeQueries.set(e.id,e),1/(mo[t.size]||mo.Small).servers,this.estimateQueryComplexity(e.queryText);const i=this.executeSQL(e.queryText,e.database,e.schema),a=Date.now();if(e.completedAt=a,e.duration=a-(e.startedAt||s),e.status=i.success?"success":"failed",e.rowsReturned=i.rowCount,e.error=i.error,t.runningQueries--,t.totalQueriesExecuted++,t.totalComputeTime+=e.duration/1e3,t.lastUsed=a,this.activeQueries.delete(e.id),i.success&&i.rows){const o=this.getCacheKey(e.queryText,e.database,e.schema);this.resultCache.set(o,{data:i.rows,timestamp:a,ttl:3e5})}return this.queryOperations.push({timestamp:a,latency:e.duration,rowsRead:i.dataRead||0,rowsWritten:i.dataWritten||0}),t.autoSuspend&&t.runningQueries===0&&t.queuedQueries===0&&this.scheduleWarehouseSuspend(t.name,t.autoSuspend),this.updateMetrics(),{...i,queryId:e.id,warehouse:t.name,latency:e.duration}}executeSQL(e,t,s){const n=e.trim().replace(/\s+/g," "),i=n.toUpperCase();try{return i.startsWith("SELECT")?this.executeSelect(n,t,s):i.startsWith("INSERT")?this.executeInsert(n,t,s):i.startsWith("UPDATE")?this.executeUpdate(n,t,s):i.startsWith("DELETE")?this.executeDelete(n,t,s):i.startsWith("CREATE TABLE")?this.executeCreateTable(n,t,s):i.startsWith("DROP TABLE")?this.executeDropTable(n,t,s):{success:!1,error:`Unsupported SQL statement: ${n}`}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}executeSelect(e,t,s){const n=e.match(/FROM\s+([\w.]+)/i);if(!n)return{success:!1,error:"Invalid SELECT query: missing FROM clause"};const i=n[1].trim(),a=this.normalizeTableKey(i,t,s),o=this.tables.get(a);if(!o)return{success:!1,error:`Table ${i} does not exist`};const l=this.tableData.get(a)||[],d=e.match(/SELECT\s+(.+?)\s+FROM/i),h=d?d[1].trim().split(",").map(b=>b.trim()):["*"];let p=[...l];const g=e.match(/WHERE\s+(.+?)(?:\s+GROUP\s+BY|\s+ORDER\s+BY|\s+LIMIT|$)/i);if(g){const M=g[1].trim().match(/(\w+)\s*=\s*['"]?([^'"\s]+)['"]?/);if(M){const x=M[1],S=M[2];p=l.filter(T=>String(T[x])===S)}}const v=e.match(/LIMIT\s+(\d+)/i);if(v){const b=parseInt(v[1],10);p=p.slice(0,b)}return{success:!0,rows:p,rowCount:p.length,columns:h.includes("*")?o.columns?.map(b=>b.name)||[]:h,dataRead:l.length}}executeInsert(e,t,s){const n=e.match(/INTO\s+([\w.]+)/i);if(!n)return{success:!1,error:"Invalid INSERT query: missing INTO clause"};const i=n[1].trim(),a=this.normalizeTableKey(i,t,s),o=this.tables.get(a);if(!o)return{success:!1,error:`Table ${i} does not exist`};const l=e.match(/VALUES\s*\((.+?)\)/i);if(!l)return{success:!1,error:"Invalid INSERT query: missing VALUES clause"};const d=l[1].split(",").map(v=>v.trim().replace(/^['"]|['"]$/g,"")),h=o.columns||[];if(d.length!==h.length)return{success:!1,error:`Column count mismatch: expected ${h.length}, got ${d.length}`};const p={};h.forEach((v,b)=>{p[v.name]=d[b]});const g=this.tableData.get(a)||[];return g.push(p),this.tableData.set(a,g),o.rows=g.length,o.size=g.length*512,{success:!0,rowCount:1,dataWritten:1}}executeUpdate(e,t,s){return{success:!0,rowCount:0,dataWritten:0}}executeDelete(e,t,s){return{success:!0,rowCount:0,dataWritten:0}}executeCreateTable(e,t,s){const n=e.match(/CREATE\s+TABLE\s+([\w.]+)/i);if(!n)return{success:!1,error:"Invalid CREATE TABLE query"};const i=n[1].trim(),a=this.normalizeTableKey(i,t,s);if(this.tables.has(a))return{success:!1,error:`Table ${i} already exists`};const o=e.match(/\((.+?)\)/),l=[];if(o){const v=o[1].split(",").map(b=>b.trim());for(const b of v){const M=b.split(/\s+/);M.length>=2&&l.push({name:M[0],type:M[1],nullable:!b.toUpperCase().includes("NOT NULL")})}}const[d,h,p]=this.parseTableName(i,t,s),g={name:p,schema:h,database:d,columns:l,rows:0,size:0,created:Date.now()};return this.tables.set(a,g),this.tableData.set(a,[]),{success:!0,rowCount:0}}executeDropTable(e,t,s){const n=e.match(/DROP\s+TABLE\s+([\w.]+)/i);if(!n)return{success:!1,error:"Invalid DROP TABLE query"};const i=n[1].trim(),a=this.normalizeTableKey(i,t,s);return this.tables.has(a)?(this.tables.delete(a),this.tableData.delete(a),{success:!0,rowCount:0}):{success:!1,error:`Table ${i} does not exist`}}resumeWarehouse(e){const t=this.warehouses.get(e);if(!t)return!1;if(t.status==="running")return!0;const s=this.suspendTimers.get(e);return s&&(clearTimeout(s),this.suspendTimers.delete(e)),t.status="running",t.currentClusterCount=t.minClusterCount,this.processQueryQueue(t),this.updateMetrics(),!0}suspendWarehouse(e){const t=this.warehouses.get(e);return t?t.status==="suspended"?!0:t.runningQueries>0?!1:(t.status="suspended",t.currentClusterCount=0,this.updateMetrics(),!0):!1}scheduleWarehouseSuspend(e,t){const s=this.suspendTimers.get(e);s&&clearTimeout(s);const n=setTimeout(()=>{const i=this.warehouses.get(e);i&&i.runningQueries===0&&i.queuedQueries===0&&this.suspendWarehouse(e),this.suspendTimers.delete(e)},t*1e3);this.suspendTimers.set(e,n)}updateWarehouseAutoSuspend(e,t){const s=this.warehouses.get(e);if(s){if(t.autoSuspend!==void 0||t.autoResume!==void 0){const n=this.suspendTimers.get(e);n&&(clearTimeout(n),this.suspendTimers.delete(e))}s.status==="running"&&s.autoSuspend&&s.runningQueries===0&&s.queuedQueries===0&&this.scheduleWarehouseSuspend(e,s.autoSuspend)}}processQueryQueue(e){if(e.status!=="running")return;const t=this.queryQueue.filter(s=>s.warehouse===e.name&&s.status==="queued");for(const s of t)e.runningQueries<this.getMaxConcurrentQueries(e)&&(e.queuedQueries--,this.queryQueue=this.queryQueue.filter(n=>n.id!==s.id),this.executeQueryOnWarehouse(s,e,s.startedAt||Date.now()))}getMaxConcurrentQueries(e){return(mo[e.size]||mo.Small).servers*e.currentClusterCount*8}estimateQueryComplexity(e){let t=1;const s=(e.match(/\bJOIN\b/gi)||[]).length;t+=s*.5,e.match(/\bGROUP\s+BY\b/i)&&(t+=.3),e.match(/\bORDER\s+BY\b/i)&&(t+=.2);const n=(e.match(/\b(COUNT|SUM|AVG|MAX|MIN)\s*\(/gi)||[]).length;return t+=n*.2,Math.max(1,t)}normalizeTableKey(e,t,s){const n=e.split(".");return n.length===3?n.join("."):n.length===2?`${t||"PUBLIC"}.${n.join(".")}`:`${t||"PUBLIC"}.${s||"PUBLIC"}.${n[0]}`}parseTableName(e,t,s){const n=e.split(".");return n.length===3?[n[0],n[1],n[2]]:n.length===2?[t||"PUBLIC",n[0],n[1]]:[t||"PUBLIC",s||"PUBLIC",n[0]]}getCacheKey(e,t,s){return`${e}|${t||""}|${s||""}`}updateMetrics(){const e=Date.now(),t=(e-this.lastMetricsUpdate)/1e3;if(this.metrics.totalWarehouses=this.warehouses.size,this.metrics.runningWarehouses=Array.from(this.warehouses.values()).filter(o=>o.status==="running").length,this.metrics.suspendedWarehouses=Array.from(this.warehouses.values()).filter(o=>o.status==="suspended").length,this.metrics.totalQueries=this.queries.size,this.metrics.runningQueries=Array.from(this.warehouses.values()).reduce((o,l)=>o+l.runningQueries,0),this.metrics.queuedQueries=Array.from(this.warehouses.values()).reduce((o,l)=>o+l.queuedQueries,0),t>0){const o=this.queryOperations.filter(l=>l.timestamp>e-1e3);this.metrics.queriesPerSecond=o.length}if(this.queryOperations.length>0){const o=this.queryOperations.slice(-100),l=o.reduce((d,h)=>d+h.latency,0)/o.length;this.metrics.avgQueryTime=l}this.metrics.totalComputeTime=Array.from(this.warehouses.values()).reduce((o,l)=>o+l.totalComputeTime,0);const s=this.queryOperations.slice(-1e3);this.metrics.totalDataRead=s.reduce((o,l)=>o+l.rowsRead,0),this.metrics.totalDataWritten=s.reduce((o,l)=>o+l.rowsWritten,0);const n=this.cacheHits+this.cacheMisses;this.metrics.cacheHitRate=n>0?this.cacheHits/n:0;let i=0;for(const o of this.warehouses.values())if(o.status==="running"){const l=this.getMaxConcurrentQueries(o),d=l>0?o.runningQueries/l:0;i+=d}this.metrics.warehouseUtilization=this.metrics.runningWarehouses>0?i/this.metrics.runningWarehouses:0;let a=0;for(const o of this.warehouses.values())if(o.status==="running"&&o.totalComputeTime>0){const l=mo[o.size]||mo.Small,d=o.totalComputeTime/3600;a+=l.creditsPerHour*d*o.currentClusterCount}this.metrics.totalCost=a,this.lastMetricsUpdate=e}getMetrics(){return this.updateMetrics(),{...this.metrics}}getWarehouse(e){return this.warehouses.get(e)}getWarehouses(){return Array.from(this.warehouses.values())}getQuery(e){return this.queries.get(e)}getRecentQueries(e=100){return Array.from(this.queries.values()).sort((t,s)=>(s.startedAt||0)-(t.startedAt||0)).slice(0,e)}getTables(e,t){return!e&&!t?Array.from(this.tables.values()):Array.from(this.tables.values()).filter(s=>!(e&&s.database!==e||t&&s.schema!==t))}}class uk{clusterName="archiphoenix-cluster";nodes=new Map;indices=new Map;shards=new Map;documents=new Map;defaultShards=5;defaultReplicas=1;refreshInterval="1s";metrics={clusterHealth:"green",totalNodes:0,healthyNodes:0,totalIndices:0,totalDocs:0,totalSize:0,activeShards:0,relocatingShards:0,initializingShards:0,unassignedShards:0,indexOperationsPerSecond:0,searchOperationsPerSecond:0,averageIndexLatency:5,averageSearchLatency:10,averageGetLatency:2};indexOperations=[];searchOperations=[];getOperations=[];lastMetricsUpdate=Date.now();recentQueries=[];initialize(e){if(this.clusterName=e.clusterName||"archiphoenix-cluster",this.defaultShards=e.defaultShards||5,this.defaultReplicas=e.defaultReplicas||1,this.refreshInterval=e.refreshInterval||"1s",this.nodes.clear(),e.nodes&&e.nodes.length>0)for(const t of e.nodes)this.nodes.set(t,{address:t,status:"up",load:.3+Math.random()*.4,shards:0});else this.nodes.set("localhost:9200",{address:"localhost:9200",status:"up",load:.5,shards:0});if(this.indices.clear(),this.shards.clear(),this.documents.clear(),e.indices&&e.indices.length>0)for(const t of e.indices)this.createIndex(t.name,t.shards||this.defaultShards,t.replicas||this.defaultReplicas,t);else this.createIndex("archiphoenix-index",this.defaultShards,this.defaultReplicas);this.updateMetrics()}syncFromConfig(e){if(e.clusterName&&(this.clusterName=e.clusterName),e.defaultShards!==void 0&&(this.defaultShards=e.defaultShards),e.defaultReplicas!==void 0&&(this.defaultReplicas=e.defaultReplicas),e.refreshInterval&&(this.refreshInterval=e.refreshInterval),e.nodes){new Set(this.nodes.keys());for(const t of e.nodes)this.nodes.has(t)||this.nodes.set(t,{address:t,status:"up",load:.3+Math.random()*.4,shards:0})}if(e.indices){new Set(this.indices.keys());for(const t of e.indices)if(!this.indices.has(t.name))this.createIndex(t.name,t.shards||this.defaultShards,t.replicas||this.defaultReplicas,t);else{const s=this.indices.get(t.name),n=this.getTotalDocsForIndex(t.name),i=this.getTotalSizeForIndex(t.name);this.indices.set(t.name,{...t,docs:s.docs||n,size:s.size||i,health:this.calculateIndexHealth(t.name)})}}this.updateMetrics()}createIndex(e,t=5,s=1,n){const i={name:e,docs:n?.docs||0,size:n?.size||0,shards:t,replicas:s,health:"yellow",mappings:n?.mappings,settings:n?.settings};this.indices.set(e,i);const a=[],o=Array.from(this.nodes.keys());for(let l=0;l<t;l++){const d=o[l%o.length];a.push({index:e,shard:l,primary:!0,node:d,state:"STARTED",docs:0,size:0});for(let h=0;h<s;h++){const p=o[(l+h+1)%o.length];a.push({index:e,shard:l,primary:!1,node:p,state:"STARTED",docs:0,size:0})}}if(this.shards.set(e,a),!this.documents.has(e)){const l=new Map;for(let d=0;d<t;d++)l.set(d,[]);this.documents.set(e,l)}i.health=this.calculateIndexHealth(e),this.updateMetrics()}routeToShard(e,t){const s=this.indices.get(e);if(!s)return 0;let n=0;for(let i=0;i<t.length;i++){const a=t.charCodeAt(i);n=(n<<5)-n+a,n=n&n}return Math.abs(n)%s.shards}indexDocument(e,t,s,n){const i=Date.now(),a=this.indices.get(e);if(!a)return{operation:"index",index:e,id:t,document:s,routing:n,latency:Date.now()-i,success:!1,error:`Index ${e} does not exist`};const o=n||t,l=this.routeToShard(e,o),d={_id:t,_index:e,_source:s,_routing:n},h=this.documents.get(e),p=h.get(l)||[],g=p.findIndex(M=>M._id===t);g>=0?p[g]=d:p.push(d),h.set(l,p),this.documents.set(e,h),a.docs=this.getTotalDocsForIndex(e),a.size=this.getTotalSizeForIndex(e),a.health=this.calculateIndexHealth(e);const v=this.shards.get(e);for(const M of v)M.index===e&&M.shard===l&&M.primary&&(M.docs=p.length,M.size=p.length*1024);const b=this.calculateIndexLatency();return this.recordIndexOperation(b),this.updateMetrics(),{operation:"index",index:e,id:t,document:s,routing:n,latency:b,success:!0,took:b}}getDocument(e,t,s){const n=Date.now();if(!this.indices.get(e))return{operation:"get",index:e,id:t,routing:s,latency:Date.now()-n,success:!1,error:`Index ${e} does not exist`};const a=s||t,o=this.routeToShard(e,a),h=(this.documents.get(e).get(o)||[]).find(g=>g._id===t),p=this.calculateGetLatency();return this.recordGetOperation(p),this.updateMetrics(),h?{operation:"get",index:e,id:t,document:h._source,routing:s,latency:p,success:!0,took:p}:{operation:"get",index:e,id:t,routing:s,latency:p,success:!1,error:`Document ${t} not found`,took:p}}search(e,t){const s=Date.now(),n=this.indices.get(e);if(!n)return{operation:"search",index:e,query:t,latency:Date.now()-s,success:!1,error:`Index ${e} does not exist`};const i=this.documents.get(e);let a=[];for(let p=0;p<n.shards;p++){const g=i.get(p)||[];a=a.concat(g)}let o=a;if(t&&t.query){if(t.query.match_all)o=a;else if(t.query.match){const p=Object.keys(t.query.match)[0],g=t.query.match[p];g&&typeof g=="string"&&(o=a.filter(v=>{const b=v._source[p];return b&&String(b).toLowerCase().includes(g.toLowerCase())}))}}const l=t?.size||10;o=o.slice(0,l);const d=this.calculateSearchLatency(n.shards,o.length);this.recordSearchOperation(d,o.length),this.updateMetrics();const h={operation:"search",index:e,query:t,latency:d,success:!0,hits:o.length,took:d};return this.recentQueries.unshift(h),this.recentQueries.length>100&&(this.recentQueries=this.recentQueries.slice(0,100)),h}deleteDocument(e,t,s){const n=Date.now(),i=this.indices.get(e);if(!i)return{operation:"delete",index:e,id:t,routing:s,latency:Date.now()-n,success:!1,error:`Index ${e} does not exist`};const a=s||t,o=this.routeToShard(e,a),l=this.documents.get(e),d=l.get(o)||[],h=d.length,p=d.filter(b=>b._id!==t);l.set(o,p),this.documents.set(e,l),i.docs=this.getTotalDocsForIndex(e),i.size=this.getTotalSizeForIndex(e),i.health=this.calculateIndexHealth(e);const g=this.shards.get(e);for(const b of g)b.index===e&&b.shard===o&&b.primary&&(b.docs=p.length,b.size=p.length*1024);const v=this.calculateIndexLatency();return this.updateMetrics(),p.length===h?{operation:"delete",index:e,id:t,routing:s,latency:v,success:!1,error:`Document ${t} not found`,took:v}:{operation:"delete",index:e,id:t,routing:s,latency:v,success:!0,took:v}}executeQuery(e){const t=Date.now();try{let s;try{s=JSON.parse(e)}catch{const n=e.split(`
`);if(n.length>=2){const i=n[0].match(/^(GET|POST|PUT|DELETE)\s+(.+)/);if(i){const a=i[1],o=i[2].trim();if(a==="GET"&&o.includes("/_search")){s=n.length>1?JSON.parse(n.slice(1).join(`
`)):{query:{match_all:{}}};const l=o.match(/^\/([^\/]+)\/_search/),d=l?l[1]:"_all";return this.search(d,s)}else if(a==="GET"&&o.match(/\/[^\/]+\/_doc\/[^\/]+/)){const l=o.match(/\/([^\/]+)\/_doc\/([^\/]+)/);if(l)return this.getDocument(l[1],l[2])}}}return{operation:"search",query:e,latency:Date.now()-t,success:!1,error:"Invalid query format"}}return s.query||s.match_all?this.search("_all",s):{operation:"search",query:e,latency:Date.now()-t,success:!1,error:"Unsupported query format"}}catch(s){return{operation:"search",query:e,latency:Date.now()-t,success:!1,error:s instanceof Error?s.message:"Unknown error"}}}getMetrics(){return this.updateMetrics(),{...this.metrics}}getIndices(){return Array.from(this.indices.values())}getShards(e){return this.shards.get(e)||[]}getRecentQueries(e=10){return this.recentQueries.slice(0,e)}calculateIndexHealth(e){const t=this.shards.get(e)||[],s=t.filter(a=>a.state==="UNASSIGNED").length,n=t.filter(a=>a.state==="INITIALIZING").length,i=t.filter(a=>a.state==="RELOCATING").length;return s>0?"red":n>0||i>0?"yellow":"green"}calculateClusterHealth(){let e=!1,t=!1;for(const i of this.indices.values())i.health==="red"?e=!0:i.health==="yellow"&&(t=!0);const s=Array.from(this.nodes.values()).filter(i=>i.status==="up").length,n=this.nodes.size;return s===0||e?"red":s<n||t?"yellow":"green"}getTotalDocsForIndex(e){const t=this.documents.get(e);if(!t)return 0;let s=0;for(const n of t.values())s+=n.length;return s}getTotalSizeForIndex(e){const t=this.documents.get(e);if(!t)return 0;let s=0;for(const n of t.values())s+=n.length*1024;return s}calculateIndexLatency(){const t=this.metrics.totalDocs;return 5+Math.min(20,t/1e4)+Math.random()*5}calculateSearchLatency(e,t){const n=e*2,i=Math.min(50,t/100);return 10+n+i+Math.random()*10}calculateGetLatency(){return 2+Math.random()*3}recordIndexOperation(e){this.indexOperations.push({timestamp:Date.now(),latency:e}),this.indexOperations.length>500&&(this.indexOperations=this.indexOperations.slice(-500))}recordSearchOperation(e,t){this.searchOperations.push({timestamp:Date.now(),latency:e,hits:t}),this.searchOperations.length>500&&(this.searchOperations=this.searchOperations.slice(-500))}recordGetOperation(e){this.getOperations.push({timestamp:Date.now(),latency:e}),this.getOperations.length>500&&(this.getOperations=this.getOperations.slice(-500))}updateMetrics(){const e=Date.now(),t=1e3,s=this.indexOperations.filter(h=>e-h.timestamp<t),n=this.searchOperations.filter(h=>e-h.timestamp<t),i=this.getOperations.filter(h=>e-h.timestamp<t);this.metrics.indexOperationsPerSecond=s.length,this.metrics.searchOperationsPerSecond=n.length,s.length>0&&(this.metrics.averageIndexLatency=s.reduce((h,p)=>h+p.latency,0)/s.length),n.length>0&&(this.metrics.averageSearchLatency=n.reduce((h,p)=>h+p.latency,0)/n.length),i.length>0&&(this.metrics.averageGetLatency=i.reduce((h,p)=>h+p.latency,0)/i.length),this.metrics.totalNodes=this.nodes.size,this.metrics.healthyNodes=Array.from(this.nodes.values()).filter(h=>h.status==="up").length,this.metrics.totalIndices=this.indices.size,this.metrics.totalDocs=Array.from(this.indices.values()).reduce((h,p)=>h+p.docs,0),this.metrics.totalSize=Array.from(this.indices.values()).reduce((h,p)=>h+p.size,0);let a=0,o=0,l=0,d=0;for(const h of this.shards.values())for(const p of h)if(p.primary)switch(p.state){case"STARTED":a++;break;case"RELOCATING":o++;break;case"INITIALIZING":l++;break;case"UNASSIGNED":d++;break}this.metrics.activeShards=a,this.metrics.relocatingShards=o,this.metrics.initializingShards=l,this.metrics.unassignedShards=d,this.metrics.clusterHealth=this.calculateClusterHealth();for(const h of this.indices.values())h.health=this.calculateIndexHealth(h.name);this.lastMetricsUpdate=e}}class dk{buckets=new Map;objects=new Map;versions=new Map;operations=[];metrics=new Map;lifecycleTransitions=new Map;initialize(e){if(this.buckets.clear(),this.objects.clear(),this.versions.clear(),this.operations=[],this.metrics.clear(),this.lifecycleTransitions.clear(),e.buckets)for(const t of e.buckets)this.buckets.set(t.name,{...t}),this.objects.set(t.name,new Map),t.versioning&&this.versions.set(t.name,new Map),this.metrics.set(t.name,{bucket:t.name,objectCount:0,totalSize:0,versionsCount:0,putCount:0,getCount:0,deleteCount:0,listCount:0,errorCount:0,averageLatency:0}),this.lifecycleTransitions.set(t.name,new Map)}putObject(e,t,s,n,i,a){const o=Date.now(),l=this.buckets.get(e);if(!l)return{success:!1,etag:"",latency:Date.now()-o,error:`Bucket '${e}' does not exist`};const d=this.generateETag(t,n),h=l.versioning?`${Date.now()}-${Math.random().toString(36).substr(2,9)}`:void 0,p={key:t,bucket:e,size:n,lastModified:Date.now(),storageClass:"STANDARD",etag:d,contentType:a||"application/octet-stream",metadata:i||{},versionId:h,encryption:l.encryption},g=this.objects.get(e);if(l.versioning&&h){const S=this.versions.get(e),T=S.get(t)||[];T.push({versionId:h,object:p,isDeleteMarker:!1}),S.set(t,T),this.versions.set(e,S);const E=this.metrics.get(e);E.versionsCount=this.getTotalVersionsCount(e)}g.set(t,p),this.objects.set(e,g);const v=this.findMatchingLifecycleRule(l,t);if(v&&v.transitions&&v.transitions.length>0){const S=this.lifecycleTransitions.get(e),T=v.transitions[0],E=Date.now()+T.days*24*60*60*1e3;S.set(t,{currentClass:"STANDARD",transitionScheduled:E,targetClass:T.storageClass,ruleId:v.id,transitionIndex:0,allTransitions:v.transitions}),this.lifecycleTransitions.set(e,S)}else if(l.lifecycleEnabled&&l.lifecycleDays){const S=this.lifecycleTransitions.get(e),T=Date.now()+l.lifecycleDays*24*60*60*1e3;S.set(t,{currentClass:"STANDARD",transitionScheduled:T,targetClass:l.glacierEnabled?"GLACIER":"STANDARD_IA"}),this.lifecycleTransitions.set(e,S)}const b=this.metrics.get(e),M=g.get(t);M?b.totalSize-=M.size:b.objectCount++,b.totalSize+=n,b.putCount++;const x=this.calculatePutLatency(n);return this.recordOperation("PUT",e,t,!0,x),this.updateMetrics(e,x,!0),{success:!0,versionId:h,etag:d,latency:x}}getObject(e,t,s){const n=Date.now(),i=this.buckets.get(e);if(!i)return{success:!1,latency:Date.now()-n,error:`Bucket '${e}' does not exist`};const a=this.objects.get(e);if(i.versioning&&s){const p=(this.versions.get(e).get(t)||[]).find(v=>v.versionId===s);if(!p||p.isDeleteMarker){const v=this.calculateGetLatency(0);return this.recordOperation("GET",e,t,!1,v),this.updateMetrics(e,v,!1),{success:!1,latency:v,error:p?.isDeleteMarker?"Object version is a delete marker":`Object version '${s}' not found`}}if(p.object.storageClass==="GLACIER"||p.object.storageClass==="DEEP_ARCHIVE"){const v=this.calculateGlacierRestoreLatency();return this.recordOperation("GET",e,t,!1,v),this.updateMetrics(e,v,!1),{success:!1,latency:v,error:`Object is archived in ${p.object.storageClass}. Restore operation required.`}}const g=this.calculateGetLatency(p.object.size);return this.recordOperation("GET",e,t,!0,g),this.updateMetrics(e,g,!0),{success:!0,object:p.object,latency:g}}const o=a.get(t);if(!o){const d=this.calculateGetLatency(0);return this.recordOperation("GET",e,t,!1,d),this.updateMetrics(e,d,!1),{success:!1,latency:d,error:`Object '${t}' not found`}}if(o.storageClass==="GLACIER"||o.storageClass==="DEEP_ARCHIVE"){const d=this.calculateGlacierRestoreLatency();return this.recordOperation("GET",e,t,!1,d),this.updateMetrics(e,d,!1),{success:!1,latency:d,error:`Object is archived in ${o.storageClass}. Restore operation required.`}}const l=this.calculateGetLatency(o.size);return this.recordOperation("GET",e,t,!0,l),this.updateMetrics(e,l,!0),{success:!0,object:o,latency:l}}deleteObject(e,t,s){const n=Date.now(),i=this.buckets.get(e);if(!i)return{success:!1,latency:Date.now()-n,error:`Bucket '${e}' does not exist`};const a=this.objects.get(e),o=a.get(t);if(!o){const p=this.calculateDeleteLatency();return this.recordOperation("DELETE",e,t,!1,p),this.updateMetrics(e,p,!1),{success:!1,latency:p,error:`Object '${t}' not found`}}if(i.versioning){const p=this.versions.get(e),g=p.get(t)||[],v=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;g.push({versionId:v,object:{...o},isDeleteMarker:!0}),p.set(t,g),this.versions.set(e,p),a.delete(t),this.objects.set(e,a);const b=this.metrics.get(e);b.versionsCount=this.getTotalVersionsCount(e),b.deleteCount++;const M=this.calculateDeleteLatency();return this.recordOperation("DELETE",e,t,!0,M),this.updateMetrics(e,M,!0),{success:!0,deleteMarker:!0,latency:M}}const l=o.size;a.delete(t),this.objects.set(e,a);const d=this.metrics.get(e);d.objectCount--,d.totalSize-=l,d.deleteCount++;const h=this.calculateDeleteLatency();return this.recordOperation("DELETE",e,t,!0,h),this.updateMetrics(e,h,!0),{success:!0,latency:h}}listObjects(e,t,s){const n=Date.now();if(!this.buckets.get(e))return{success:!1,objects:[],latency:Date.now()-n,error:`Bucket '${e}' does not exist`};const a=this.objects.get(e);let o=Array.from(a.values());t&&(o=o.filter(h=>h.key.startsWith(t))),o.sort((h,p)=>h.key.localeCompare(p.key)),s&&(o=o.slice(0,s));const l=this.calculateListLatency(o.length);this.recordOperation("LIST",e,void 0,!0,l);const d=this.metrics.get(e);return d.listCount++,this.updateMetrics(e,l,!0),{success:!0,objects:o,latency:l}}headObject(e,t){const s=Date.now();if(!this.buckets.get(e))return{success:!1,latency:Date.now()-s,error:`Bucket '${e}' does not exist`};const a=this.objects.get(e).get(t);if(!a){const l=this.calculateHeadLatency();return this.recordOperation("HEAD",e,t,!1,l),this.updateMetrics(e,l,!1),{success:!1,latency:l,error:`Object '${t}' not found`}}const o=this.calculateHeadLatency();return this.recordOperation("HEAD",e,t,!0,o),this.updateMetrics(e,o,!0),{success:!0,object:a,latency:o}}processLifecycleTransitions(e=Date.now()){for(const[t,s]of this.lifecycleTransitions.entries()){const n=this.buckets.get(t);if(!(n&&(n.lifecycleEnabled||n.lifecycleRules&&n.lifecycleRules.some(o=>o.status==="Enabled"))))continue;const a=this.objects.get(t);for(const[o,l]of s.entries())if(e>=l.transitionScheduled){const d=a.get(o);if(d&&d.storageClass===l.currentClass)if(d.storageClass=l.targetClass,a.set(o,d),this.objects.set(t,a),l.ruleId&&l.allTransitions&&l.transitionIndex!==void 0){const h=l.transitionIndex+1;if(h<l.allTransitions.length){const p=l.allTransitions[h],g=e+p.days*24*60*60*1e3;s.set(o,{currentClass:l.targetClass,transitionScheduled:g,targetClass:p.storageClass,ruleId:l.ruleId,transitionIndex:h,allTransitions:l.allTransitions})}else{const p=this.findLifecycleRuleById(n,l.ruleId);if(p?.expiration?.days){const g=e+p.expiration.days*24*60*60*1e3;s.set(o,{currentClass:l.targetClass,transitionScheduled:g,targetClass:l.targetClass,ruleId:l.ruleId,expiration:!0})}else s.delete(o)}}else if(n.glacierEnabled&&n.glacierDays&&l.targetClass==="STANDARD_IA"){const h=e+n.glacierDays*24*60*60*1e3;s.set(o,{currentClass:"STANDARD_IA",transitionScheduled:h,targetClass:"GLACIER"})}else s.delete(o);else d||s.delete(o)}this.lifecycleTransitions.set(t,s)}this.processExpirations(e)}processExpirations(e){for(const[t,s]of this.lifecycleTransitions.entries()){if(!this.buckets.get(t))continue;const i=this.objects.get(t),a=[];for(const[o,l]of s.entries())l.expiration&&e>=l.transitionScheduled&&i.has(o)&&a.push(o);for(const o of a){const l=i.get(o);if(l){const d=this.metrics.get(t);d&&(d.objectCount=Math.max(0,d.objectCount-1),d.totalSize=Math.max(0,d.totalSize-l.size))}i.delete(o),s.delete(o)}this.objects.set(t,i),this.lifecycleTransitions.set(t,s)}}findMatchingLifecycleRule(e,t){return!e.lifecycleRules||e.lifecycleRules.length===0?void 0:e.lifecycleRules.filter(n=>n.status==="Enabled").filter(n=>!n.prefix||t.startsWith(n.prefix)).sort((n,i)=>{const a=n.prefix||"";return(i.prefix||"").length-a.length})[0]}findLifecycleRuleById(e,t){if(e.lifecycleRules)return e.lifecycleRules.find(s=>s.id===t)}findLifecycleRuleById(e,t){if(e.lifecycleRules)return e.lifecycleRules.find(s=>s.id===t)}getBucketMetrics(e){return this.metrics.get(e)}getAllBucketMetrics(){return new Map(this.metrics)}getTotalStorageSize(){let e=0;for(const t of this.metrics.values())e+=t.totalSize;return e}getTotalObjectCount(){let e=0;for(const t of this.metrics.values())e+=t.objectCount;return e}generateETag(e,t){const s=`${e}_${t}_${Date.now()}`;let n=0;for(let i=0;i<s.length;i++){const a=s.charCodeAt(i);n=(n<<5)-n+a,n=n&n}return Math.abs(n).toString(16)}calculatePutLatency(e){const s=e/1024*.1,n=(Math.random()-.5)*10;return Math.max(10,50+s+n)}calculateGetLatency(e){const s=e/1024*.15,n=(Math.random()-.5)*10;return Math.max(10,30+s+n)}calculateDeleteLatency(){const t=(Math.random()-.5)*5;return Math.max(5,20+t)}calculateListLatency(e){const s=e*.01,n=(Math.random()-.5)*10;return Math.max(20,40+s+n)}calculateHeadLatency(){const t=(Math.random()-.5)*5;return Math.max(5,15+t)}calculateGlacierRestoreLatency(){return 5e3}recordOperation(e,t,s,n,i){this.operations.push({operation:e,bucket:t,key:s,success:n,latency:i,timestamp:Date.now()}),this.operations.length>1e3&&this.operations.shift()}updateMetrics(e,t,s){const n=this.metrics.get(e);if(!n)return;const i=n.putCount+n.getCount+n.deleteCount+n.listCount;i>0?n.averageLatency=(n.averageLatency*(i-1)+t)/i:n.averageLatency=t,s||n.errorCount++,n.lastOperation=Date.now()}getTotalVersionsCount(e){const t=this.versions.get(e);if(!t)return 0;let s=0;for(const n of t.values())s+=n.length;return s}}class hk{connections=new Map;config;connectionCounter=0;queryHistory=[];MAX_HISTORY=1e3;constructor(e){this.config={maxConnections:e.maxConnections||100,minConnections:e.minConnections||0,idleTimeout:e.idleTimeout||3e5,maxLifetime:e.maxLifetime||36e5,connectionTimeout:e.connectionTimeout||5e3}}acquireConnection(e){const t=Date.now();this.cleanupIdleConnections(t);for(const[s,n]of this.connections.entries())if(n.status==="idle")return n.status="active",n.lastActivity=t,n.currentQuery=e,n.queryCount++,s;return this.connections.size<this.config.maxConnections?this.createConnection(e,t):null}releaseConnection(e,t){const s=this.connections.get(e);s&&(s.status="idle",s.lastActivity=Date.now(),s.currentQuery=void 0,t!==void 0&&this.recordQuery(t))}terminateConnection(e){const t=this.connections.get(e);t&&(t.status="terminated",this.connections.delete(e))}createConnection(e,t){const s=`conn_${++this.connectionCounter}_${t}`,n={id:s,status:"active",createdAt:t,lastActivity:t,queryCount:1,currentQuery:e};return this.connections.set(s,n),s}cleanupIdleConnections(e){const t=[];for(const[s,n]of this.connections.entries())n.status==="idle"&&(e-n.lastActivity>this.config.idleTimeout||e-n.createdAt>this.config.maxLifetime)&&t.push(s);for(const s of t)this.connections.delete(s)}recordQuery(e){const t=Date.now();this.queryHistory.push({timestamp:t,duration:e}),this.queryHistory.length>this.MAX_HISTORY&&this.queryHistory.shift()}getMetrics(){const e=Date.now();let t=0,s=0,n=0;for(const g of this.connections.values())switch(g.status){case"active":t++;break;case"idle":s++;break;case"waiting":n++;break}const i=this.connections.size,a=i>0?t/this.config.maxConnections:0,o=this.queryHistory.filter(g=>e-g.timestamp<6e4),l=o.length>0?o.reduce((g,v)=>g+v.duration,0)/o.length:0,h=this.queryHistory.filter(g=>e-g.timestamp<1e3).length,p=i>=this.config.maxConnections?this.config.connectionTimeout/2:0;return{totalConnections:i,activeConnections:t,idleConnections:s,waitingConnections:n,utilization:a,averageQueryTime:l,queriesPerSecond:h,connectionWaitTime:p}}getConnection(e){return this.connections.get(e)}getAllConnections(){return Array.from(this.connections.values())}updateConfig(e){if(this.config={...this.config,...e},e.maxConnections!==void 0&&e.maxConnections<this.connections.size){const t=this.connections.size-e.maxConnections,s=Array.from(this.connections.entries()).filter(([n,i])=>i.status==="idle").slice(0,t);for(const[n]of s)this.terminateConnection(n)}}reset(){this.connections.clear(),this.connectionCounter=0,this.queryHistory=[]}}class fk{static exportMetrics(e,t){const s=[],n=this.buildLabels(e,t),i=t.timestamp||Date.now();if(s.push("# HELP component_throughput_total Component throughput in operations per second"),s.push("# TYPE component_throughput_total gauge"),s.push(`component_throughput_total{${n}} ${t.throughput||0} ${i}`),s.push("# HELP component_latency_ms Component latency in milliseconds"),s.push("# TYPE component_latency_ms gauge"),s.push(`component_latency_ms{${n}} ${t.latency||0} ${i}`),t.latencyP50!==void 0&&(s.push("# HELP component_latency_p50_ms Component 50th percentile latency in milliseconds"),s.push("# TYPE component_latency_p50_ms gauge"),s.push(`component_latency_p50_ms{${n}} ${t.latencyP50} ${i}`)),t.latencyP99!==void 0&&(s.push("# HELP component_latency_p99_ms Component 99th percentile latency in milliseconds"),s.push("# TYPE component_latency_p99_ms gauge"),s.push(`component_latency_p99_ms{${n}} ${t.latencyP99} ${i}`)),s.push("# HELP component_error_rate Component error rate (0-1)"),s.push("# TYPE component_error_rate gauge"),s.push(`component_error_rate{${n}} ${t.errorRate||0} ${i}`),s.push("# HELP component_utilization Component utilization (0-1)"),s.push("# TYPE component_utilization gauge"),s.push(`component_utilization{${n}} ${t.utilization||0} ${i}`),t.customMetrics)for(const[a,o]of Object.entries(t.customMetrics)){const l=this.sanitizeMetricName(a);s.push(`# HELP component_${l} Component custom metric: ${a}`),s.push(`# TYPE component_${l} gauge`),s.push(`component_${l}{${n}} ${o} ${i}`)}return s.join(`
`)+`
`}static buildLabels(e,t){const s=[];s.push(`component_id="${this.escapeLabelValue(e.id)}"`),s.push(`component_type="${this.escapeLabelValue(e.type)}"`),e.data.label&&s.push(`component_name="${this.escapeLabelValue(e.data.label)}"`);const n=e.data.config||{};return n.environment&&s.push(`environment="${this.escapeLabelValue(String(n.environment))}"`),n.namespace&&s.push(`namespace="${this.escapeLabelValue(String(n.namespace))}"`),s.join(",")}static escapeLabelValue(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n")}static sanitizeMetricName(e){return e.replace(/[^a-zA-Z0-9_:]/g,"_").replace(/^[^a-zA-Z]/,"_")}static exportAllMetrics(e,t){const s=[];for(const n of e){const i=t.get(n.id);i&&s.push(this.exportMetrics(n,i))}return s.join(`
`)}static exportEndpointMetrics(e,t){return t?this.exportMetrics(e,t):""}}class pk{config=null;targetStatuses=new Map;scrapedMetrics=new Map;lastScrapeTimes=new Map;prometheusMetrics={scrapeRequestsTotal:0,scrapeErrorsTotal:0,scrapeDurationTotal:0,targetsUp:0,targetsDown:0,samplesScraped:0};initializeConfig(e){const t=e.data.config||{},s=typeof t.scrapeInterval=="number"?`${t.scrapeInterval/1e3}s`:t.scrapeInterval||"15s",n=typeof t.evaluationInterval=="number"?`${t.evaluationInterval/1e3}s`:t.evaluationInterval||"15s";this.config={global:{scrape_interval:s,evaluation_interval:n,external_labels:{prometheus:"archiphoenix"}},scrape_configs:this.buildScrapeConfigs(t),alerting:t.enableAlertmanager?{alertmanagers:[{static_configs:[{targets:[t.alertmanagerUrl||"http://alertmanager:9093"].map(i=>{const a=i.match(/^https?:\/\/([^\/]+)/);return a?a[1]:i})}]}]}:void 0,remote_write:t.enableRemoteWrite&&t.remoteWrite?t.remoteWrite.map(i=>({url:i.url})):void 0},this.initializeTargetStatuses()}buildScrapeConfigs(e){if(e.scrape_configs&&Array.isArray(e.scrape_configs))return e.scrape_configs.map(n=>({job_name:n.job_name,scrape_interval:n.scrape_interval,scrape_timeout:n.scrape_timeout,metrics_path:n.metrics_path,static_configs:n.static_configs||[]}));const t=[],s=e.scrapeInterval||"15s";if(e.targets&&Array.isArray(e.targets)){const n=new Map;for(const i of e.targets){const a=i.job||"default";n.has(a)||n.set(a,[]),n.get(a).push(i)}for(const[i,a]of n.entries()){const o=a[0],l=o.scrapeInterval||o.interval||s,d=o.metricsPath||"/metrics",h=[];for(const p of a)if(Array.isArray(p.targets))h.push(...p.targets);else if(p.endpoint)try{const g=new URL(p.endpoint);h.push(`${g.hostname}${g.port?":"+g.port:""}`)}catch{const g=p.endpoint.match(/^https?:\/\/([^\/]+)/);h.push(g?g[1]:p.endpoint)}else typeof p=="string"&&h.push(p);t.push({job_name:i,scrape_interval:l,metrics_path:d,static_configs:[{targets:h,labels:o.labels||{}}]})}}return t}initializeTargetStatuses(){if(this.targetStatuses.clear(),!!this.config){for(const e of this.config.scrape_configs)if(e.static_configs)for(const t of e.static_configs)for(const s of t.targets){const n=e.metrics_path?`http://${s}${e.metrics_path}`:`http://${s}/metrics`,i=`${e.job_name}:${s}`;this.targetStatuses.set(i,{job:e.job_name,endpoint:n,lastScrape:0,lastSuccess:null,lastError:null,scrapeDuration:null,up:!1,labels:t.labels})}}}performScraping(e,t,s){if(this.config){this.parseDuration(this.config.global.scrape_interval||"15s"),this.prometheusMetrics.targetsUp=0,this.prometheusMetrics.targetsDown=0;for(const[n,i]of this.targetStatuses.entries()){const a=this.lastScrapeTimes.get(n)||0,o=this.getScrapeIntervalForTarget(i.job),l=this.parseDuration(o);e-a>=l&&(this.scrapeTarget(n,i,e,t,s),this.lastScrapeTimes.set(n,e)),i.up?this.prometheusMetrics.targetsUp++:this.prometheusMetrics.targetsDown++}}}scrapeTarget(e,t,s,n,i){const a=performance.now();this.prometheusMetrics.scrapeRequestsTotal++;try{const o=this.findNodeByEndpoint(t.endpoint,n);if(!o)throw new Error(`Target not found: ${t.endpoint}`);const l=i.get(o.id);if(!l)throw new Error(`Metrics not available for component: ${o.id}`);const d=fk.exportMetrics(o,l);t.lastScrape=s,t.lastSuccess=s,t.lastError=null,t.up=!0;const h=performance.now()-a;t.scrapeDuration=h,this.prometheusMetrics.scrapeDurationTotal+=h,this.prometheusMetrics.samplesScraped+=this.countSamples(d),this.scrapedMetrics.set(e,l)}catch(o){const l=performance.now()-a;t.lastScrape=s,t.lastSuccess=null,t.lastError=o instanceof Error?o.message:String(o),t.up=!1,t.scrapeDuration=l,this.prometheusMetrics.scrapeErrorsTotal++}}findNodeByEndpoint(e,t){try{const s=new URL(e),n=s.hostname,i=s.port?parseInt(s.port):null;for(const a of t){const o=a.data.config||{},l=o.port||o.metricsPort||o.metrics?.port;if(a.data.label?.toLowerCase().replace(/\s+/g,"-")===n||i&&l===i)return a}}catch{}return null}getScrapeIntervalForTarget(e){return this.config&&(this.config.scrape_configs.find(s=>s.job_name===e)?.scrape_interval||this.config.global.scrape_interval)||"15s"}parseDuration(e){if(typeof e=="number")return e;if(typeof e!="string")return 15e3;const t=e.match(/^(\d+)([smhd])$/);if(!t)return 15e3;const s=parseInt(t[1]);switch(t[2]){case"s":return s*1e3;case"m":return s*60*1e3;case"h":return s*60*60*1e3;case"d":return s*24*60*60*1e3;default:return 15e3}}countSamples(e){return e.split(`
`).filter(t=>t.trim()&&!t.startsWith("#")).length}getTargetStatuses(){return Array.from(this.targetStatuses.values())}getPrometheusMetrics(){return{...this.prometheusMetrics}}calculateLoad(){const e=this.prometheusMetrics.scrapeRequestsTotal,t=this.prometheusMetrics.scrapeErrorsTotal,s=this.prometheusMetrics.scrapeDurationTotal,n=this.prometheusMetrics.samplesScraped,i=this.targetStatuses.size,a=this.parseDuration(this.config?.global.scrape_interval||"15s"),o=i>0?1e3/a*i:0,l=e>0?s/e:0,d=e>0?t/e:0,h=o*(n/e||0);return{scrapeRequestsPerSecond:o,averageScrapeDuration:l,errorRate:d,samplesPerSecond:h}}}class gk{config=null;lastRefreshTimes=new Map;lastAlertEvaluationTimes=new Map;grafanaMetrics={queriesPerSecond:0,dashboardRefreshesPerSecond:0,alertEvaluationsPerSecond:0,datasourceErrors:0,activeDashboards:0,activePanels:0,totalQueries:0,cachedQueries:0,queryLatency:0,renderingLatency:0};queryLatencyHistory=[];MAX_LATENCY_HISTORY=100;initializeConfig(e){const t=e.data.config||{};this.config=t,this.initializeRefreshTimes(),this.initializeAlertEvaluationTimes()}initializeRefreshTimes(){if(this.lastRefreshTimes.clear(),!this.config?.dashboards)return;const e=this.normalizeDashboards(this.config.dashboards);for(const t of e)this.lastRefreshTimes.set(t.id,0)}initializeAlertEvaluationTimes(){if(this.lastAlertEvaluationTimes.clear(),!(!this.config?.alerts||!this.config.enableAlerting))for(const e of this.config.alerts)this.lastAlertEvaluationTimes.set(e.id,0)}normalizeDashboards(e){return!e||!Array.isArray(e)?[]:e.map(t=>{if(t&&typeof t=="object"){if(typeof t.panels=="number")return{id:t.id||String(Date.now()),name:t.name||"Dashboard",panels:[],tags:Array.isArray(t.tags)?t.tags:[],refresh:t.refresh||"30s"};if(Array.isArray(t.panels))return{id:t.id||String(Date.now()),name:t.name||"Dashboard",panels:t.panels.map(s=>({id:s.id||`panel-${Date.now()}`,title:s.title||"Panel",type:s.type||"graph",datasource:s.datasource||"Prometheus",queries:Array.isArray(s.queries)?s.queries:[{refId:"A",expr:"up"}],gridPos:s.gridPos||{x:0,y:0,w:12,h:8}})),tags:Array.isArray(t.tags)?t.tags:[],variables:t.variables,refresh:t.refresh||"30s",timeRange:t.timeRange}}return t}).filter(t=>t&&typeof t=="object"&&t.id)}performUpdate(e,t=!0,s){this.config&&(this.updateDashboards(e,t,s),this.config.enableAlerting&&this.evaluateAlerts(e,t),this.updateMetrics())}updateDashboards(e,t,s){if(!this.config?.dashboards)return;const n=this.normalizeDashboards(this.config.dashboards);let i=0,a=0;for(const o of n){const l=this.parseDuration(o.refresh||"30s"),d=this.lastRefreshTimes.get(o.id)||0;if(e-d>=l){this.lastRefreshTimes.set(o.id,e);for(const h of o.panels){const p=h.datasource,g=p&&this.isLokiDatasource(p);for(const M of h.queries){i++;const x=this.simulateQueryExecution(M,t,g,s);a+=x,this.queryLatencyHistory.push(x),this.queryLatencyHistory.length>this.MAX_LATENCY_HISTORY&&this.queryLatencyHistory.shift()}const v=this.simulatePanelRendering(h),b=this.grafanaMetrics.renderingLatency;this.grafanaMetrics.renderingLatency=b*.9+v*.1}}}this.grafanaMetrics.totalQueries+=i,i>0&&(this.grafanaMetrics.queryLatency=a/i)}isLokiDatasource(e){if(!this.config?.datasources)return!1;const s=(Array.isArray(this.config.datasources)?this.config.datasources:[]).find(n=>typeof n=="string"?n===e:n.name===e);return typeof s=="object"&&s.type?s.type==="loki":!1}evaluateAlerts(e,t){if(this.config?.alerts)for(const s of this.config.alerts){const n=this.parseDuration(s.for||"1m"),i=this.lastAlertEvaluationTimes.get(s.id)||0;e-i>=n&&(this.lastAlertEvaluationTimes.set(s.id,e),this.simulateQueryExecution({refId:"A",expr:s.condition.query},t),t||this.grafanaMetrics.datasourceErrors++)}}simulateQueryExecution(e,t,s=!1,n){if(s&&n)try{const l=Date.now()-36e5,d=Date.now(),h=n(e.expr,l,d,100);return h.success||this.grafanaMetrics.datasourceErrors++,h.latency}catch{return this.grafanaMetrics.datasourceErrors++,1e3}if(!t)return this.grafanaMetrics.datasourceErrors++,1e3;let i=50;const a=this.estimateQueryComplexity(e.expr);i+=a*10;const o=(Math.random()-.5)*20;return Math.max(10,i+o)}estimateQueryComplexity(e){if(!e)return 0;let t=1;e.includes("[")&&(t+=2);const s=["sum","avg","max","min","count","rate","irate","increase"];for(const i of s)e.toLowerCase().includes(i)&&(t+=1);const n=(e.match(/\|/g)||[]).length;return t+=n,t}simulatePanelRendering(e){const s={stat:5,gauge:10,piechart:15,bargraph:20,table:25,graph:30}[e.type]||20,n=Math.sqrt(e.queries.length);return s*n}updateMetrics(){if(!this.config)return;const e=this.normalizeDashboards(this.config.dashboards);this.grafanaMetrics.activeDashboards=e.length,this.grafanaMetrics.activePanels=e.reduce((n,i)=>n+i.panels.length,0);let t=0,s=0;for(const n of e){const a=1e3/this.parseDuration(n.refresh||"30s");s+=a;const o=n.panels.reduce((l,d)=>l+d.queries.length,0);t+=a*o}if(this.grafanaMetrics.queriesPerSecond=t,this.grafanaMetrics.dashboardRefreshesPerSecond=s,this.config.enableAlerting&&this.config.alerts){let n=0;for(const i of this.config.alerts){const o=1e3/this.parseDuration(i.for||"1m");n+=o}this.grafanaMetrics.alertEvaluationsPerSecond=n}else this.grafanaMetrics.alertEvaluationsPerSecond=0;if(this.queryLatencyHistory.length>0){const n=this.queryLatencyHistory.reduce((i,a)=>i+a,0)/this.queryLatencyHistory.length;this.grafanaMetrics.queryLatency=n}}parseDuration(e){const t=e.match(/^(\d+)([smhd])$/);if(!t)return 3e4;const s=parseInt(t[1]);switch(t[2]){case"s":return s*1e3;case"m":return s*60*1e3;case"h":return s*60*60*1e3;case"d":return s*24*60*60*1e3;default:return 3e4}}getGrafanaMetrics(){return{...this.grafanaMetrics}}calculateLoad(){const e=this.grafanaMetrics,t=.1,s=Math.min(.7,e.queriesPerSecond/100),n=Math.min(.1,e.alertEvaluationsPerSecond/10),i=Math.min(.1,e.activePanels/100),a=Math.min(.95,t+s+n+i),o=.2,l=Math.min(.4,e.activeDashboards/50),d=Math.min(.3,e.cachedQueries/1e3),h=Math.min(.95,o+l+d),p=e.totalQueries+e.alertEvaluationsPerSecond,g=p>0?e.datasourceErrors/p:0;return{queriesPerSecond:e.queriesPerSecond,dashboardRefreshesPerSecond:e.dashboardRefreshesPerSecond,alertEvaluationsPerSecond:e.alertEvaluationsPerSecond,averageQueryLatency:e.queryLatency,averageRenderingLatency:e.renderingLatency,errorRate:g,cpuUtilization:a,memoryUtilization:h}}getActiveDatasources(){return this.config?.datasources?this.config.datasources.length>0&&typeof this.config.datasources[0]=="string"?this.config.datasources.map(e=>({name:e,type:"prometheus",url:"http://localhost:9090",access:"proxy",isDefault:e===this.config.datasources[0]})):this.config.datasources.filter(e=>e&&typeof e=="object"&&e.name):[]}isPrometheusAvailable(e){return!(!e||!this.getActiveDatasources().find(n=>n.type==="prometheus"))}}class mk{config=null;streams=new Map;queryStatuses=new Map;lastIngestionTimes=new Map;lokiMetrics={ingestionRequestsTotal:0,ingestionErrorsTotal:0,ingestionLinesTotal:0,ingestionBytesTotal:0,queryRequestsTotal:0,queryErrorsTotal:0,queryDurationTotal:0,activeStreams:0,totalStorageSize:0,retentionDeletions:0};ingestionLatencyHistory=[];queryLatencyHistory=[];MAX_LATENCY_HISTORY=100;initializeConfig(e){const t=e.data.config||{};this.config={serverUrl:t.serverUrl||"http://loki:3100",retentionPeriod:t.retentionPeriod||"168h",maxStreams:t.maxStreams||1e4,maxLineSize:t.maxLineSize||256e3,enableCompression:t.enableCompression??!0,compressionType:t.compressionType||"gzip",enableAuth:t.enableAuth??!1,enableMultiTenancy:t.enableMultiTenancy??!1,tenants:t.tenants||[],ingestionRateLimit:t.ingestionRateLimit,queryRateLimit:t.queryRateLimit},this.initializeStreamsFromConfig(t),this.initializeQueriesFromConfig(t)}initializeStreamsFromConfig(e){if(e.streams&&Array.isArray(e.streams))for(const t of e.streams){const s=this.getStreamKey(t.labels||{}),n=[];if(t.entries&&Array.isArray(t.entries))for(const a of t.entries)n.push({timestamp:a.timestamp||Date.now().toString()+"000000",line:a.line||""});const i=t.size?t.size*1024*1024*1024:0;this.streams.set(s,{labels:t.labels||{},entries:n,size:i,lastEntryTime:Date.now()})}}initializeQueriesFromConfig(e){if(e.queries&&Array.isArray(e.queries))for(const t of e.queries){const s=t.id||`query-${Date.now()}-${Math.random()}`;this.queryStatuses.set(s,{id:s,query:t.query||"",lastExecution:0,lastSuccess:null,lastError:null,executionDuration:null,resultsCount:t.results||0,success:!0})}}processIngestion(e,t){if(!this.config)return{success:!1,error:"Loki not configured",ingestedLines:0,ingestedBytes:0};const s=performance.now();this.lokiMetrics.ingestionRequestsTotal++;try{if(this.config.ingestionRateLimit){const o=t||"default",l=this.lastIngestionTimes.get(o)||0,d=Date.now();d-l<1e3,this.lastIngestionTimes.set(o,d)}let n=0,i=0;for(const o of e){const l=this.getStreamKey(o.stream);if(!this.streams.has(l)&&this.streams.size>=(this.config.maxStreams||1e4)){this.lokiMetrics.ingestionErrorsTotal++;continue}let d=this.streams.get(l);d||(d={labels:o.stream,entries:[],size:0,lastEntryTime:Date.now()},this.streams.set(l,d));for(const[h,p]of o.values){const g=new Blob([p]).size;if(g>(this.config.maxLineSize||256e3)){this.lokiMetrics.ingestionErrorsTotal++;continue}d.entries.push({timestamp:h,line:p}),d.size+=g,d.lastEntryTime=Math.max(d.lastEntryTime,this.parseTimestamp(h)),n++,i+=g}if(this.config.enableCompression){const h=this.getCompressionRatio(this.config.compressionType||"gzip");d.size=Math.floor(d.size*h)}}this.lokiMetrics.ingestionLinesTotal+=n,this.lokiMetrics.ingestionBytesTotal+=i,this.lokiMetrics.totalStorageSize+=i,this.lokiMetrics.activeStreams=this.streams.size;const a=performance.now()-s;return this.ingestionLatencyHistory.push(a),this.ingestionLatencyHistory.length>this.MAX_LATENCY_HISTORY&&this.ingestionLatencyHistory.shift(),{success:!0,ingestedLines:n,ingestedBytes:i}}catch(n){return performance.now()-s,this.lokiMetrics.ingestionErrorsTotal++,{success:!1,error:n instanceof Error?n.message:String(n),ingestedLines:0,ingestedBytes:0}}}executeQuery(e,t,s,n){if(!this.config)return{success:!1,error:"Loki not configured",latency:0,resultsCount:0};const i=performance.now();this.lokiMetrics.queryRequestsTotal++;try{this.config.queryRateLimit;const a=this.parseLogQL(e),o=this.executeLogQLQuery(a,t,s,n),l=performance.now()-i;return this.lokiMetrics.queryDurationTotal+=l,this.queryLatencyHistory.push(l),this.queryLatencyHistory.length>this.MAX_LATENCY_HISTORY&&this.queryLatencyHistory.shift(),{success:!0,result:o,latency:l,resultsCount:o.reduce((d,h)=>d+h.values.length,0)}}catch(a){const o=performance.now()-i;return this.lokiMetrics.queryErrorsTotal++,{success:!1,error:a instanceof Error?a.message:String(a),latency:o,resultsCount:0}}}parseLogQL(e){const t={},s=[],n=[],i=e.match(/^\{([^}]+)\}/);if(i){const v=i[1].matchAll(/(\w+)=["']([^"']+)["']/g);for(const b of v)t[b[1]]=b[2]}const a=e.match(/\|\s*=\s*["']([^"']+)["']/);a&&s.push({type:"contains",pattern:a[1]});const o=e.match(/!\s*=\s*["']([^"']+)["']/);o&&s.push({type:"not_contains",pattern:o[1]});const l=e.match(/\|\s*~\s*["']([^"']+)["']/);l&&s.push({type:"regex",pattern:l[1]});const d=e.matchAll(/\|\s*(\w+)\s*(=|=~|!=|!~)\s*["']([^"']+)["']/g);for(const g of d)n.push({label:g[1],operator:g[2],value:g[3]});let h;const p=e.match(/\|\s*(\w+)\(([^)]*)\)/);return p&&(h={function:p[1],params:p[2]?p[2].split(",").map(g=>g.trim()):[]}),{streamSelector:t,lineFilters:s,labelFilters:n,aggregation:h}}executeLogQLQuery(e,t,s,n){const i=[],a=Date.now(),o=t||a-36e5,l=s||a;for(const[d,h]of this.streams.entries()){let p=!0;for(const[b,M]of Object.entries(e.streamSelector))if(h.labels[b]!==M){p=!1;break}if(!p)continue;let v=h.entries.filter(b=>{const M=this.parseTimestamp(b.timestamp);return M>=o&&M<=l});for(const b of e.lineFilters)v=v.filter(M=>{switch(b.type){case"contains":return M.line.includes(b.pattern);case"not_contains":return!M.line.includes(b.pattern);case"regex":try{return new RegExp(b.pattern).test(M.line)}catch{return!1}}});for(const b of e.labelFilters){const M=h.labels[b.label];if(M===void 0){v=[];break}switch(b.operator){case"=":M!==b.value&&(v=[]);break;case"!=":M===b.value&&(v=[]);break;case"=~":try{new RegExp(b.value).test(M)||(v=[])}catch{v=[]}break;case"!~":try{new RegExp(b.value).test(M)&&(v=[])}catch{}break}}if(n&&v.length>n&&(v=v.slice(0,n)),e.aggregation){const b=this.applyAggregation(e.aggregation,v);i.push({stream:h.labels,values:[[Date.now().toString()+"000000",b.toString()]]})}else v.length>0&&i.push({stream:h.labels,values:v.map(b=>[b.timestamp,b.line])})}return i}applyAggregation(e,t){switch(e.function.toLowerCase()){case"rate":if(t.length<2)return 0;const s=this.parseTimestamp(t[0].timestamp),i=(this.parseTimestamp(t[t.length-1].timestamp)-s)/1e3;return i>0?t.length/i:0;case"count_over_time":return t.length;case"sum":return t.reduce((o,l)=>{const d=parseFloat(l.line);return o+(isNaN(d)?0:d)},0);case"avg":case"average":const a=t.map(o=>parseFloat(o.line)).filter(o=>!isNaN(o));return a.length>0?a.reduce((o,l)=>o+l,0)/a.length:0;default:return t.length}}performRetention(e){if(!this.config)return;const t=this.parseDuration(this.config.retentionPeriod||"168h"),s=e-t;let n=0,i=0;for(const[a,o]of this.streams.entries()){const l=o.entries.length;o.entries=o.entries.filter(d=>this.parseTimestamp(d.timestamp)>s),o.entries.length<l&&(n+=l-o.entries.length,o.size=o.entries.reduce((d,h)=>d+new Blob([h.line]).size,0),i+=o.size),o.entries.length===0&&this.streams.delete(a)}this.lokiMetrics.retentionDeletions+=n,this.lokiMetrics.totalStorageSize=Math.max(0,this.lokiMetrics.totalStorageSize-i),this.lokiMetrics.activeStreams=this.streams.size}getStreams(){return Array.from(this.streams.values())}getLokiMetrics(){return{...this.lokiMetrics}}calculateLoad(){const e=this.lokiMetrics.ingestionRequestsTotal,t=this.lokiMetrics.ingestionErrorsTotal,s=this.lokiMetrics.ingestionLinesTotal,n=this.lokiMetrics.ingestionBytesTotal,i=this.lokiMetrics.queryRequestsTotal,a=this.lokiMetrics.queryErrorsTotal,o=this.lokiMetrics.queryDurationTotal,l=this.ingestionLatencyHistory.length>0?this.ingestionLatencyHistory.reduce((S,T)=>S+T,0)/this.ingestionLatencyHistory.length:0,d=this.queryLatencyHistory.length>0?this.queryLatencyHistory.reduce((S,T)=>S+T,0)/this.queryLatencyHistory.length:i>0?o/i:0,h=e>0?t/e:0,p=i>0?a/i:0,g=s>0?s/100:0,v=n>0?n/100:0,b=i>0?i/100:0,M=(this.config?.maxStreams||1e4)*100*1024*1024,x=Math.min(1,this.lokiMetrics.totalStorageSize/M);return{ingestionLinesPerSecond:g,ingestionBytesPerSecond:v,averageIngestionLatency:l,ingestionErrorRate:h,queriesPerSecond:b,averageQueryLatency:d,queryErrorRate:p,storageUtilization:x,streamCount:this.streams.size}}getStreamKey(e){return Object.keys(e).sort().map(s=>`${s}=${e[s]}`).join(",")}parseTimestamp(e){const t=BigInt(e);return Number(t/BigInt(1e6))}parseDuration(e){const t=e.match(/^(\d+)([smhd])$/);if(!t)return 10080*60*1e3;const s=parseInt(t[1]);switch(t[2]){case"s":return s*1e3;case"m":return s*60*1e3;case"h":return s*60*60*1e3;case"d":return s*24*60*60*1e3;default:return 10080*60*1e3}}getCompressionRatio(e){switch(e){case"gzip":return .3;case"snappy":return .5;case"lz4":return .4;default:return .3}}}class yk{config=null;traces=new Map;serviceStats=new Map;jaegerMetrics={spansReceivedTotal:0,spansDroppedTotal:0,spansProcessedTotal:0,samplingDecisionsTotal:0,samplingErrorsTotal:0,tracesStoredTotal:0,tracesDroppedTotal:0,storageSizeBytes:0,queryRequestsTotal:0,queryErrorsTotal:0,queryDurationTotal:0,spansSentTotal:0,spansFailedTotal:0};samplingState={};queryHistory=[];MAX_QUERY_HISTORY=100;lastCleanupTime=0;CLEANUP_INTERVAL=6e4;initializeConfig(e){const t=e.data.config||{};this.config={serverUrl:t.serverUrl||"http://jaeger:16686",agentEndpoint:t.agentEndpoint||"http://jaeger-agent:6831",collectorEndpoint:t.collectorEndpoint||"http://jaeger-collector:14268",queryEndpoint:t.queryEndpoint||"http://jaeger-query:16686",samplingType:t.samplingType||"probabilistic",samplingParam:t.samplingParam??.001,storageBackend:t.storageBackend||"elasticsearch",storageUrl:t.storageUrl||"http://elasticsearch:9200",enableUIGraphQL:t.enableUIGraphQL??!0,enableMetrics:t.enableMetrics??!0,metricsBackend:t.metricsBackend||"prometheus",metricsUrl:t.metricsUrl||"http://prometheus:9090",maxTraces:t.maxTraces||1e4,traceTTL:t.traceTTL||864e5},this.initializeSampling()}initializeSampling(){if(!this.config)return;const{samplingType:e,samplingParam:t}=this.config;switch(e){case"probabilistic":this.samplingState.probabilistic={probability:Math.max(0,Math.min(1,t||.001))};break;case"ratelimiting":this.samplingState.rateLimiting={maxTracesPerSecond:Math.max(1,t||10),bucket:{tokens:t||10,lastRefill:Date.now()}};break;case"peroperation":this.samplingState.perOperation=new Map;break}}receiveSpan(e){if(!this.config)return{sample:!1};this.jaegerMetrics.spansReceivedTotal++;const t=this.makeSamplingDecision(e);return this.jaegerMetrics.samplingDecisionsTotal++,t.sample?(this.processSpan(e),t):(this.jaegerMetrics.spansDroppedTotal++,t)}receiveSpansFromDataFlow(e){for(const t of e)this.receiveSpan(t)}makeSamplingDecision(e){if(!this.config)return{sample:!1};const{samplingType:t}=this.config;try{switch(t){case"probabilistic":return this.probabilisticSampling(e);case"ratelimiting":return this.rateLimitingSampling(e);case"peroperation":return this.perOperationSampling(e);default:return{sample:!0}}}catch{return this.jaegerMetrics.samplingErrorsTotal++,{sample:!1}}}probabilisticSampling(e){const t=this.samplingState.probabilistic;if(!t)return{sample:!0};const s=Math.random()<t.probability;return{sample:s,tags:s?[{key:"sampler.type",value:"probabilistic"},{key:"sampler.param",value:t.probability.toString()}]:void 0}}rateLimitingSampling(e){const t=this.samplingState.rateLimiting;if(!t)return{sample:!0};const s=Date.now(),n=s-t.bucket.lastRefill,i=1e3/t.maxTracesPerSecond,a=Math.floor(n/i);return a>0&&(t.bucket.tokens=Math.min(t.maxTracesPerSecond,t.bucket.tokens+a),t.bucket.lastRefill=s),t.bucket.tokens>0?(t.bucket.tokens--,{sample:!0,tags:[{key:"sampler.type",value:"ratelimiting"},{key:"sampler.param",value:t.maxTracesPerSecond.toString()}]}):{sample:!1}}perOperationSampling(e){this.samplingState.perOperation||(this.samplingState.perOperation=new Map);const t=`${e.serviceName}:${e.operationName}`;let s=this.samplingState.perOperation.get(t);if(!s){const l=this.config?.samplingParam||10;s={maxTracesPerSecond:l,bucket:{tokens:l,lastRefill:Date.now()}},this.samplingState.perOperation.set(t,s)}const n=Date.now(),i=n-s.bucket.lastRefill,a=1e3/s.maxTracesPerSecond,o=Math.floor(i/a);return o>0&&(s.bucket.tokens=Math.min(s.maxTracesPerSecond,s.bucket.tokens+o),s.bucket.lastRefill=n),s.bucket.tokens>0?(s.bucket.tokens--,{sample:!0,tags:[{key:"sampler.type",value:"peroperation"},{key:"sampler.param",value:s.maxTracesPerSecond.toString()}]}):{sample:!1}}processSpan(e){this.jaegerMetrics.spansProcessedTotal++;let t=this.traces.get(e.traceId);t||(t={traceId:e.traceId,spans:[],startTime:e.startTime,duration:e.duration,serviceCount:0,spanCount:0,hasErrors:!1},this.traces.set(e.traceId,t),this.jaegerMetrics.tracesStoredTotal++),t.spans.push(e),t.spanCount=t.spans.length,e.startTime<t.startTime&&(t.startTime=e.startTime);const s=Math.max(...t.spans.map(i=>i.startTime+i.duration));t.duration=s-t.startTime,!e.parentSpanId&&!t.rootService&&(t.rootService=e.serviceName,t.rootOperation=e.operationName),(e.tags.some(i=>i.key==="error"&&i.value===!0)||e.logs.some(i=>i.fields.some(a=>a.key==="error")))&&(t.hasErrors=!0),this.updateServiceStats(e,t),this.config&&this.traces.size>this.config.maxTraces&&this.evictOldestTraces()}updateServiceStats(e,t){let s=this.serviceStats.get(e.serviceName);s||(s={name:e.serviceName,tracesTotal:0,errorsTotal:0,avgDuration:0,spansTotal:0,lastTraceTime:0},this.serviceStats.set(e.serviceName,s)),s.spansTotal++,s.lastTraceTime=Math.max(s.lastTraceTime,e.startTime/1e3);const n=s.avgDuration*(s.spansTotal-1)+e.duration;s.avgDuration=n/s.spansTotal,(t.spans.length===1||t.spans[0].serviceName===e.serviceName)&&(s.tracesTotal++,t.hasErrors&&s.errorsTotal++)}evictOldestTraces(){if(!this.config)return;const e=Date.now()*1e3,t=this.config.traceTTL*1e3,s=this.config.maxTraces,n=[];for(const[i,a]of this.traces.entries())e-a.startTime>t&&n.push(i);if(this.traces.size-n.length>s){const a=Array.from(this.traces.entries()).filter(([o])=>!n.includes(o)).sort(([,o],[,l])=>o.startTime-l.startTime).slice(0,this.traces.size-n.length-s);n.push(...a.map(([o])=>o))}for(const i of n){const a=this.traces.get(i);if(a){for(const l of a.spans){const d=this.serviceStats.get(l.serviceName);d&&(d.tracesTotal=Math.max(0,d.tracesTotal-1),a.hasErrors&&(d.errorsTotal=Math.max(0,d.errorsTotal-1)))}const o=this.calculateTraceSize(a);this.jaegerMetrics.storageSizeBytes=Math.max(0,this.jaegerMetrics.storageSizeBytes-o),this.jaegerMetrics.tracesDroppedTotal++,this.traces.delete(i)}}}performCleanup(e){e-this.lastCleanupTime<this.CLEANUP_INTERVAL||(this.lastCleanupTime=e,this.evictOldestTraces())}queryTraces(e){const t=performance.now();this.jaegerMetrics.queryRequestsTotal++;try{let s=Array.from(this.traces.values());if(e.service&&(s=s.filter(o=>o.spans.some(l=>l.serviceName===e.service))),e.operation&&(s=s.filter(o=>o.spans.some(l=>l.operationName===e.operation))),e.tags&&(s=s.filter(o=>o.spans.some(l=>Object.entries(e.tags).every(([d,h])=>l.tags.some(p=>p.key===d&&String(p.value)===String(h)))))),e.startTime){const o=e.startTime*1e3;s=s.filter(l=>l.startTime>=o)}if(e.endTime){const o=e.endTime*1e3;s=s.filter(l=>l.startTime+l.duration<=o)}s.sort((o,l)=>l.startTime-o.startTime);const n=e.limit||20,i=s.length;s=s.slice(0,n);const a=performance.now()-t;return this.jaegerMetrics.queryDurationTotal+=a,this.queryHistory.push({params:e,timestamp:Date.now(),duration:a,resultsCount:s.length}),this.queryHistory.length>this.MAX_QUERY_HISTORY&&this.queryHistory.shift(),{traces:s,total:i,limit:n}}catch(s){return this.jaegerMetrics.queryErrorsTotal++,{traces:[],total:0,limit:e.limit||20,errors:[s instanceof Error?s.message:String(s)]}}}getServiceStats(){return Array.from(this.serviceStats.values())}getRecentTraces(e=20){const t=Array.from(this.traces.values());return t.sort((s,n)=>n.startTime-s.startTime),t.slice(0,e)}getTraceById(e){return this.traces.get(e)}getJaegerMetrics(){return{...this.jaegerMetrics}}calculateTraceSize(e){let t=0;for(const s of e.spans)t+=100,t+=s.operationName.length,t+=s.serviceName.length,t+=s.tags.length*50,t+=s.logs.length*100;return t}calculateLoad(){const e=this.jaegerMetrics.spansReceivedTotal,t=this.jaegerMetrics.tracesStoredTotal,s=this.jaegerMetrics.spansDroppedTotal,n=this.jaegerMetrics.queryRequestsTotal,i=this.jaegerMetrics.queryDurationTotal,a=this.jaegerMetrics.queryErrorsTotal,o=e>0?1-s/e:0,l=n>0?i/n:0,d=n>0?a/n:0,h=this.config?.maxTraces||1e4,p=this.traces.size/h,g=e/60,v=t/60;return{spansPerSecond:g,tracesPerSecond:v,samplingRate:o,storageUtilization:p,queryLatency:l,errorRate:d}}getConfig(){return this.config?{...this.config}:null}}class vk{constructor(e,t,s,n){this.resolverId=e,this.executeResolverFn=t,this.nodes=s,this.connections=n}batchQueue=[];batchTimeout=null;BATCH_DELAY=10;cache=new Map;CACHE_TTL=1e3;totalBatches=0;totalRequests=0;totalBatchedRequests=0;totalDeduplicated=0;totalCacheHits=0;totalLatencyReduction=0;async load(e,t=!0){this.totalRequests++;const s=this.getCacheKey(e);if(t){const i=this.cache.get(s);if(i&&Date.now()-i.timestamp<this.CACHE_TTL)return this.totalCacheHits++,i.data}const n=this.batchQueue.find(i=>i.key===s);return n?(this.totalDeduplicated++,new Promise((i,a)=>{n.resolve=o=>{i(o),this.batchQueue.filter(d=>d.key===s&&d!==n).forEach(d=>d.resolve(o))},n.reject=a})):new Promise((i,a)=>{this.batchQueue.push({key:s,resolverId:this.resolverId,variables:e,resolve:o=>{t&&this.cache.set(s,{data:o,timestamp:Date.now()}),i(o)},reject:a}),this.batchTimeout||(this.batchTimeout=setTimeout(()=>{this.executeBatch()},this.BATCH_DELAY))})}async executeBatch(){if(this.batchQueue.length===0){this.batchTimeout=null;return}this.batchTimeout&&(clearTimeout(this.batchTimeout),this.batchTimeout=null);const e=new Map;for(const n of this.batchQueue)e.has(n.key)||e.set(n.key,n);const t=Array.from(e.values());if(this.batchQueue=[],t.length===0)return;this.totalBatches++,this.totalBatchedRequests+=t.length;const s=t.map(n=>n.variables);try{const n=Date.now(),i=await this.executeResolverFn(this.resolverId,s,this.nodes,this.connections),a=Date.now()-n,o=t.length>0?a/t.length:0,d=(o*1.5-o)*t.length;this.totalLatencyReduction+=Math.max(0,d);for(let h=0;h<t.length;h++){const p=t[h],g=i[h];g&&g.success?p.resolve(g.data):p.reject(new Error(g?.error||"Resolver execution failed"))}}catch(n){for(const i of t)i.reject(n instanceof Error?n:new Error(String(n)))}}getCacheKey(e){return`${this.resolverId}:${JSON.stringify(e)}`}getMetrics(){return{totalBatches:this.totalBatches,totalRequests:this.totalRequests,totalBatchedRequests:this.totalBatchedRequests,averageBatchSize:this.totalBatches>0?this.totalBatchedRequests/this.totalBatches:0,deduplicationRate:this.totalRequests>0?this.totalDeduplicated/this.totalRequests*100:0,cacheHitRate:this.totalRequests>0?this.totalCacheHits/this.totalRequests*100:0,averageLatencyReduction:this.totalBatches>0?this.totalLatencyReduction/this.totalBatches:0}}clearCache(){this.cache.clear()}clearQueue(){this.batchTimeout&&(clearTimeout(this.batchTimeout),this.batchTimeout=null),this.batchQueue.length>0&&this.executeBatch()}}class bk{config=null;graphQLMetrics={queriesPerSecond:0,mutationsPerSecond:0,subscriptionsActive:0,averageResponseTime:0,totalQueries:0,totalMutations:0,totalErrors:0,errorRate:0,cacheHitRate:0,averageComplexity:0,averageDepth:0};queryHistory=[];MAX_HISTORY_SIZE=1e3;queryCache=new Map;activeSubscriptions=new Map;latencyHistory=[];MAX_LATENCY_HISTORY=500;complexityHistory=[];depthHistory=[];lastSecondStart=Date.now();queriesThisSecond=0;mutationsThisSecond=0;resolverMetrics=new Map;componentId=null;traceContexts=new Map;traceIdCounter=0;spanIdCounter=0;activeSpans=new Map;dataLoaders=new Map;dataLoaderMetrics={totalBatches:0,totalRequests:0,totalBatchedRequests:0,averageBatchSize:0,deduplicationRate:0,cacheHitRate:0,averageLatencyReduction:0};nPlusOneProblems=[];MAX_N_PLUS_ONE_HISTORY=100;requestCache=new Map;subscriptionEvents=[];MAX_EVENTS_QUEUE=1e3;subscriptionMetrics={totalEvents:0,eventsPerSecond:0,averageDeliveryLatency:0,totalDeliveryErrors:0,deliveryErrorRate:0,lastEventTime:0};deliveryLatencyHistory=[];MAX_DELIVERY_LATENCY_HISTORY=500;eventsThisSecond=0;lastEventSecondStart=Date.now();MAX_SUBSCRIPTIONS=1e3;SUBSCRIPTION_TIMEOUT=3e5;persistedQueries=new Map;persistedQueriesUsage=0;batchQueryMetrics={totalBatches:0,totalBatchRequests:0,averageBatchSize:0,averageBatchLatency:0,totalBatchErrors:0,batchErrorRate:0};batchLatencyHistory=[];MAX_BATCH_LATENCY_HISTORY=500;introspectionMetrics={totalIntrospectionQueries:0,introspectionQueriesPerSecond:0};introspectionQueriesThisSecond=0;lastIntrospectionSecondStart=Date.now();schemaChanges=[];MAX_SCHEMA_CHANGES_HISTORY=100;schemaVersions=[];MAX_SCHEMA_VERSIONS=50;previousSchema=null;fieldMetrics=new Map;MAX_FIELD_METRICS_HISTORY=1e3;typeMetrics=new Map;operationMetrics=new Map;MAX_OPERATION_HISTORY=100;MAX_OPERATIONS=500;errorMetrics=new Map;MAX_ERROR_HISTORY=100;errorHistory=[];MAX_TOTAL_ERROR_HISTORY=500;fieldCallsThisSecond=new Map;typeOpsThisSecond=new Map;operationCallsThisSecond=new Map;errorCountsThisSecond=new Map;lastMetricsSecondStart=Date.now();rateLimitCounters=new Map;rateLimitMetrics={totalBlockedRequests:0,blockedRequestsPerSecond:0,totalRateLimitHits:0,rateLimitHitsPerSecond:0,blockedByType:{queries:0,mutations:0,subscriptions:0}};blockedRequestsThisSecond=0;rateLimitHitsThisSecond=0;lastRateLimitSecondStart=Date.now();timeoutMetrics={totalTimeouts:0,timeoutsPerSecond:0,queryTimeouts:0,mutationTimeouts:0,resolverTimeouts:0};timeoutsThisSecond=0;lastTimeoutSecondStart=Date.now();timeoutDurations=[];MAX_TIMEOUT_HISTORY=100;connectionPools=new Map;connectionPoolMetrics={totalConnections:0,activeConnections:0,idleConnections:0,maxConnections:0,connectionUtilization:0,totalConnectionAttempts:0,failedConnectionAttempts:0,connectionFailureRate:0,averageConnectionWaitTime:0};connectionWaitTimes=[];MAX_WAIT_TIME_HISTORY=100;connectionHealth=new Map;connectionHealthMetrics={healthyConnections:0,unhealthyConnections:0,totalHealthChecks:0,failedHealthChecks:0,healthCheckFailureRate:0,totalReconnects:0,successfulReconnects:0,failedReconnects:0,reconnectSuccessRate:0};healthCheckInterval=null;loadBalancingState=new Map;loadBalancingMetrics={totalRequests:0,averageLoadDistribution:0};initializeConfig(e){this.componentId=e.id;const t=e.data.config||{};if(this.config={endpoint:t.endpoint||"/graphql",schema:t.schema||this.getDefaultSchema(),queries:t.queries||[],subscriptions:t.subscriptions||[],resolvers:t.resolvers||[],subscriptionsEnabled:t.subscriptionsEnabled??!0,introspectionEnabled:t.introspectionEnabled??!0,enableQueryComplexityAnalysis:t.enableQueryComplexityAnalysis??!0,enableQueryDepthLimiting:t.enableQueryDepthLimiting??!0,maxQueryDepth:t.maxQueryDepth??15,maxQueryComplexity:t.maxQueryComplexity??1e3,enableCaching:t.enableCaching??!1,cacheTTL:t.cacheTTL??300,requestsPerSecond:t.requestsPerSecond||100,responseLatency:t.responseLatency||50,enableQueryBatching:t.enableQueryBatching??!0,enablePersistedQueries:t.enablePersistedQueries??!0,persistedQueries:t.persistedQueries||[],fieldComplexityWeights:t.fieldComplexityWeights||{},rateLimit:t.rateLimit||{enabled:!1,queriesPerSecond:100,mutationsPerSecond:50,subscriptionsPerSecond:10,globalPerSecond:200,windowMs:1e3,identifyBy:"ip"},timeout:t.timeout||{enabled:!1,queryTimeout:3e4,mutationTimeout:6e4,resolverTimeout:5e3,defaultTimeout:3e4},connectionPool:t.connectionPool||{enabled:!1,defaultPoolSize:10,maxIdleTime:3e5,healthCheckInterval:3e4,reconnectDelay:1e3,maxReconnectAttempts:3},loadBalancing:t.loadBalancing||{enabled:!1,strategy:"round-robin"}},this.config.connectionPool?.enabled&&this.config.resolvers)for(const s of this.config.resolvers)s.enabled!==!1&&this.initializeConnectionPool(s);if(this.config.loadBalancing?.enabled&&this.config.resolvers)for(const s of this.config.resolvers)s.instances&&s.instances.length>1&&this.initializeLoadBalancing(s);if(this.config.connectionPool?.enabled&&this.config.connectionPool.healthCheckInterval&&this.startHealthChecks(),this.config.persistedQueries)for(const s of this.config.persistedQueries)this.persistedQueries.set(s.hash,s);if(this.config.subscriptions)for(const s of this.config.subscriptions)s.active&&this.activeSubscriptions.set(s.id,s);if(this.config.resolvers)for(const s of this.config.resolvers)this.resolverMetrics.has(s.id)||this.resolverMetrics.set(s.id,{id:s.id,type:s.type,field:s.field,totalCalls:0,totalErrors:0,averageLatency:0,totalLatency:0,errorRate:0});this.graphQLMetrics.subscriptionsActive=this.activeSubscriptions.size,this.config.schema&&this.detectSchemaChanges(this.config.schema)}getDefaultSchema(){return{types:[],queries:[],mutations:[],subscriptions:[]}}computeQueryHash(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t=t&t}return Math.abs(t).toString(16).padStart(64,"0").substring(0,64)}getPersistedQuery(e){return this.persistedQueries.get(e)}savePersistedQuery(e,t){const s=this.computeQueryHash(e),n=this.persistedQueries.get(s);if(n)return n.lastUsedAt=Date.now(),n.useCount++,n;const i={id:`pq-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,hash:s,query:e,operationName:t,addedAt:Date.now(),lastUsedAt:Date.now(),useCount:1};return this.persistedQueries.set(s,i),this.config&&(this.config.persistedQueries=Array.from(this.persistedQueries.values())),i}async processBatchQueries(e,t,s){if(!this.config?.enableQueryBatching)return e.map(d=>({success:!1,errors:[{message:"Query batching is disabled"}],latency:0}));const n=Date.now();this.batchQueryMetrics.totalBatches++,this.batchQueryMetrics.totalBatchRequests+=e.length;const i=await Promise.all(e.map(d=>this.processSingleBatchRequest(d,t,s))),a=Date.now()-n;this.batchLatencyHistory.push(a),this.batchLatencyHistory.length>this.MAX_BATCH_LATENCY_HISTORY&&this.batchLatencyHistory.shift();const o=this.batchLatencyHistory.reduce((d,h)=>d+h,0);this.batchQueryMetrics.averageBatchLatency=o/this.batchLatencyHistory.length,this.batchQueryMetrics.averageBatchSize=this.batchQueryMetrics.totalBatchRequests/this.batchQueryMetrics.totalBatches;const l=i.filter(d=>!d.success).length;return this.batchQueryMetrics.totalBatchErrors+=l,this.batchQueryMetrics.batchErrorRate=this.batchQueryMetrics.totalBatchErrors/this.batchQueryMetrics.totalBatchRequests,i}async processSingleBatchRequest(e,t,s){let n=e.query;if(!n&&e.extensions?.persistedQuery){const i=e.extensions.persistedQuery.sha256Hash,a=this.getPersistedQuery(i);if(a)n=a.query,a.lastUsedAt=Date.now(),a.useCount++,this.persistedQueriesUsage++;else return{success:!1,errors:[{message:`Persisted query not found: ${i}`}],latency:0}}return n?await this.processQuery({query:n,variables:e.variables,operationName:e.operationName},t,s):{success:!1,errors:[{message:"Query is required"}],latency:0}}async processQuery(e,t,s,n){const i=Date.now();let a=e.query;if(!a&&e.extensions?.persistedQuery&&this.config?.enablePersistedQueries){const k=e.extensions.persistedQuery.sha256Hash,D=this.getPersistedQuery(k);if(D)a=D.query,D.lastUsedAt=Date.now(),D.useCount++,this.persistedQueriesUsage++;else{const L=Date.now()-i,I=Date.now()/1e3,U=i/1e3,Q=`Persisted query not found: ${k}`;return this.createQuerySpan("persisted_query","query",U,I,!1,void 0,void 0,Q,void 0,n),{success:!1,errors:[{message:Q}],latency:L}}}if(!a){const k=Date.now()-i,D=Date.now()/1e3,L=i/1e3,I="Query is required";return this.createQuerySpan("unknown","query",L,D,!1,void 0,void 0,I,void 0,n),{success:!1,errors:[{message:I}],latency:k}}const o=this.parseQuery(a),l=o.operationType||"query",d=o.fields,h=e.operationName||(d&&d.length>0?d[0].name:void 0),p=this.getClientIdentifier(e.headers,e.variables),g=this.checkRateLimit(l,p);if(!g.allowed){const k=Date.now()-i,D=`Rate limit exceeded. Limit: ${g.limit}/${g.resetAt-Date.now()}ms. Reset at: ${new Date(g.resetAt).toISOString()}`;this.recordQuery(!1,k,0,0,!1,h,l,d,D);const L=Date.now()/1e3,I=i/1e3;return this.createQuerySpan(h||"unknown",l,I,L,!1,void 0,void 0,D,void 0,n),{success:!1,errors:[{message:D}],latency:k}}if(this.config?.enableCaching){const k=this.getCacheKey({query:a,variables:e.variables}),D=this.queryCache.get(k);if(D&&Date.now()-D.timestamp<this.config.cacheTTL*1e3){const L=Date.now()-i;return this.recordQuery(!0,L,0,0,!0,h,l,d),{success:!0,data:D.data,latency:L,cached:!0}}}if(a.includes("__schema")||a.includes("__type")||a.includes("__typename")){const k=this.handleIntrospectionQuery(a),D=Date.now()-i;if(k.success){this.recordQuery(!0,D,0,0,!1,"__introspection","query",d);const L=Date.now()/1e3,I=i/1e3;return this.createQuerySpan("__introspection","query",I,L,!0,void 0,void 0,void 0,void 0,n),{success:!0,data:k.data,latency:D}}else{const L=k.error||"Introspection query failed";this.recordQuery(!1,D,0,0,!1,"__introspection","query",d,L);const I=Date.now()/1e3,U=i/1e3;return this.createQuerySpan("__introspection","query",U,I,!1,void 0,void 0,L,void 0,n),{success:!1,errors:[{message:L}],latency:D}}}if(!o.success){const k=Date.now()-i,D=o.error||"Invalid query";this.recordQuery(!1,k,0,0,!1,h,l,d,D);const L=Date.now()/1e3,I=i/1e3;return this.createQuerySpan(h||"unknown",l,I,L,!1,void 0,void 0,D,void 0,n),{success:!1,errors:[{message:D}],latency:k}}if(o.operationType&&o.fields){const k=this.validateQueryAgainstSchema(o.operation||"",o.operationType,o.fields,e.variables);if(!k.valid){const D=Date.now()-i,L=k.errors[0]?.message||"Validation failed";this.recordQuery(!1,D,0,0,!1,h,l,d,L);const I=Date.now()/1e3,U=i/1e3;return this.createQuerySpan(h||"unknown",l,U,I,!1,void 0,void 0,L,void 0,n),{success:!1,errors:k.errors.map(Q=>({message:Q.message,path:Q.path})),latency:D}}}const v=this.calculateComplexity(o.operation||""),b=this.calculateDepth(o.operation||"");if(this.config?.enableQueryDepthLimiting&&b>(this.config.maxQueryDepth||15)){const k=Date.now()-i,D=`Query depth ${b} exceeds maximum ${this.config.maxQueryDepth}`;this.recordQuery(!1,k,v,b,!1,h,l,d,D);const L=Date.now()/1e3,I=i/1e3;return this.createQuerySpan(h||"unknown",l,I,L,!1,v,b,D,void 0,n),{success:!1,errors:[{message:D}],latency:k,complexity:v,depth:b}}if(this.config?.enableQueryComplexityAnalysis&&v>(this.config.maxQueryComplexity||1e3)){const k=Date.now()-i,D=`Query complexity ${v} exceeds maximum ${this.config.maxQueryComplexity}`;this.recordQuery(!1,k,v,b,!1,h,l,d,D);const L=Date.now()/1e3,I=i/1e3;return this.createQuerySpan(h||"unknown",l,I,L,!1,v,b,D,void 0,n),{success:!1,errors:[{message:D}],latency:k,complexity:v,depth:b}}let M;if(n&&n().size>0){const D=this.generateTraceId(),L=this.generateSpanId();M={traceId:D,spanId:L,sampled:!0},this.traceContexts.set(D,M)}const x=l==="subscription"?0:this.getTimeoutForOperation(l);let S;try{t&&s&&this.config?.resolvers&&this.config.resolvers.length>0?x>0?S=await this.executeWithTimeout(()=>this.executeQuery(o.operation||"",e.variables,t,s,M,n),x,l==="subscription"?"query":l,h):S=await this.executeQuery(o.operation||"",e.variables,t,s,M,n):x>0?S=await this.executeWithTimeout(()=>Promise.resolve(this.executeQuery(o.operation||"",e.variables,t,s,M,n)),x,l==="subscription"?"query":l,h):S=await Promise.resolve(this.executeQuery(o.operation||"",e.variables,t,s,M,n))}catch(k){const D=Date.now()-i,L=k.message||"Query execution failed";this.recordQuery(!1,D,0,0,!1,h,l,d,L);const I=Date.now()/1e3,U=i/1e3;return this.createQuerySpan(h||"unknown",l,U,I,!1,void 0,void 0,L,void 0,n),{success:!1,errors:[{message:L}],latency:D}}const T=Date.now()-i;if(this.config?.enableCaching&&S){const k=this.getCacheKey({query:a,variables:e.variables});this.queryCache.set(k,{data:S,timestamp:Date.now()})}this.config?.enablePersistedQueries&&a&&this.savePersistedQuery(a,e.operationName),this.recordQuery(!0,T,v,b,!1,h,l,d);const E=Date.now()/1e3,A=i/1e3;return this.createQuerySpan(h||"unknown",l,A,E,!0,v,b,void 0,M,n),{success:!0,data:S,latency:T,complexity:v,depth:b}}processMutation(e){const t=Date.now(),s=this.parseQuery(e.query),n=s.fields,i=e.operationName||(n&&n.length>0?n[0].name:void 0);if(!s.success){const l=Date.now()-t,d=s.error||"Invalid mutation";return this.recordMutation(!1,l,i,n,d),{success:!1,errors:[{message:d}],latency:l}}const a=this.executeMutation(s.operation||"",e.variables),o=Date.now()-t;return this.recordMutation(!0,o,i,n),{success:!0,data:a,latency:o}}createSubscription(e){if(!this.config?.subscriptionsEnabled)return{success:!1,error:"Subscriptions are disabled"};if(this.activeSubscriptions.size>=this.MAX_SUBSCRIPTIONS)return{success:!1,error:`Maximum subscriptions limit reached (${this.MAX_SUBSCRIPTIONS})`};const t=`sub-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,s={id:t,query:e.query,variables:e.variables,timestamp:Date.now(),active:!0,clientId:e.clientId,lastEventTime:Date.now(),eventCount:0,filter:e.filter};return this.activeSubscriptions.set(t,s),this.graphQLMetrics.subscriptionsActive=this.activeSubscriptions.size,{success:!0,subscriptionId:t}}cancelSubscription(e){return this.activeSubscriptions.delete(e)?(this.graphQLMetrics.subscriptionsActive=this.activeSubscriptions.size,!0):!1}generateSubscriptionEvent(e,t,s,n,i){if(!this.config?.subscriptionsEnabled)return;const a={id:`event-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:e,field:t,data:s,timestamp:Date.now(),sourceComponentId:n,metadata:i};this.subscriptionEvents.push(a),this.subscriptionEvents.length>this.MAX_EVENTS_QUEUE&&this.subscriptionEvents.shift(),this.recordSubscriptionEvent(),this.processSubscriptionEvent(a)}processSubscriptionEvent(e){const t=Date.now(),s=[];for(const i of this.activeSubscriptions.values())if(i.active){if(i.filter){const a=i.filter;if(a.field&&a.field!==e.field||a.type&&a.type.length>0&&!a.type.includes(e.type)||a.sourceComponentId&&a.sourceComponentId!==e.sourceComponentId)continue}s.push(i)}for(const i of s)this.deliverEventToSubscription(i,e);const n=Date.now()-t;this.recordDeliveryLatency(n)}deliverEventToSubscription(e,t){try{e.lastEventTime=Date.now(),e.eventCount=(e.eventCount||0)+1,e.clientId}catch{this.subscriptionMetrics.totalDeliveryErrors++,this.updateDeliveryErrorRate()}}processSubscriptions(e,t){if(!this.config?.subscriptionsEnabled)return;const s=Date.now();this.cleanupInactiveSubscriptions(s),e&&t&&this.generateEventsFromComponents(e,t),this.processEventQueue()}cleanupInactiveSubscriptions(e){const t=[];for(const[s,n]of this.activeSubscriptions.entries()){const i=n.lastEventTime||n.timestamp;e-i>this.SUBSCRIPTION_TIMEOUT&&t.push(s)}for(const s of t)this.activeSubscriptions.delete(s);t.length>0&&(this.graphQLMetrics.subscriptionsActive=this.activeSubscriptions.size)}generateEventsFromComponents(e,t){if(this.config?.resolvers)for(const s of this.config.resolvers){if(!s.enabled||!s.targetService)continue;const n=e.find(a=>a.id===s.targetService);!n||!t.find(a=>a.source===this.componentId&&a.target===s.targetService)||this.simulateComponentEvents(n,s)}}simulateComponentEvents(e,t){const s=Date.now(),n=`lastEvent_${e.id}_${t.id}`,i=this[n]||0,a=s-i;if(Math.random()<.01&&a>1e3){let d="update";if(e.type==="postgres"||e.type==="mongodb"||e.type==="redis"){const h=["create","update","delete"];d=h[Math.floor(Math.random()*h.length)]}this.generateSubscriptionEvent(d,t.field,this.getFallbackDataForField(t.field,{}),e.id,{componentType:e.type,resolverId:t.id}),this[n]=s}}processEventQueue(){const e=this.subscriptionEvents.filter(t=>!t.processed);for(const t of e)this.processSubscriptionEvent(t),t.processed=!0;this.subscriptionEvents=this.subscriptionEvents.filter(t=>!t.processed||Date.now()-t.timestamp<6e4)}recordSubscriptionEvent(){const e=Date.now();e-this.lastEventSecondStart>=1e3&&(this.subscriptionMetrics.eventsPerSecond=this.eventsThisSecond,this.eventsThisSecond=0,this.lastEventSecondStart=e),this.eventsThisSecond++,this.subscriptionMetrics.totalEvents++,this.subscriptionMetrics.lastEventTime=e}recordDeliveryLatency(e){this.deliveryLatencyHistory.push(e),this.deliveryLatencyHistory.length>this.MAX_DELIVERY_LATENCY_HISTORY&&this.deliveryLatencyHistory.shift();const t=this.deliveryLatencyHistory.reduce((s,n)=>s+n,0);this.subscriptionMetrics.averageDeliveryLatency=t/this.deliveryLatencyHistory.length}updateDeliveryErrorRate(){this.subscriptionMetrics.totalEvents>0&&(this.subscriptionMetrics.deliveryErrorRate=this.subscriptionMetrics.totalDeliveryErrors/this.subscriptionMetrics.totalEvents)}getSubscriptionMetrics(){return{...this.subscriptionMetrics}}parseQuery(e){if(!e||!e.trim())return{success:!1,error:"Empty query"};const t=e.trim();let s;if(t.startsWith("query"))s="query";else if(t.startsWith("mutation"))s="mutation";else if(t.startsWith("subscription"))s="subscription";else if(t.startsWith("{"))s="query";else return{success:!1,error:"Invalid query format"};const n=[],i=t.match(/(\w+)\s*(\([^)]*\))?\s*\{/g);if(i)for(const a of i){const o=a.match(/(\w+)/);if(o){const l=o[1];if(!["query","mutation","subscription"].includes(l.toLowerCase())){const d=a.match(/\(([^)]*)\)/),h={};if(d&&d[1]){const v=d[1].split(",").map(b=>b.trim());for(const b of v){const[M,x]=b.split(":").map(S=>S.trim());M&&x&&(h[M]=x.replace(/^["']|["']$/g,""))}}const p=[],g=t.match(new RegExp(`${l}\\s*[^{]*\\{([^}]+)\\}`,"s"));if(g&&g[1]){const v=g[1].match(/(\w+)/g);v&&p.push(...v)}n.push({name:l,args:Object.keys(h).length>0?h:void 0,nestedFields:p.length>0?p:void 0})}}}return{success:!0,operation:t,operationType:s,fields:n}}validateQueryAgainstSchema(e,t,s,n){const i=[];if(!this.config?.schema)return{valid:!0,errors:[]};const a=this.config.schema;let o;if(t==="query"&&a.queries?o=a.queries.find(l=>l.name==="Query"):t==="mutation"&&a.mutations?o=a.mutations.find(l=>l.name==="Mutation"):t==="subscription"&&a.subscriptions&&(o=a.subscriptions.find(l=>l.name==="Subscription")),!o)return i.push({message:`Root type for ${t} not found in schema`,type:t}),{valid:!1,errors:i};for(const l of s){const d=o.fields?.find(h=>h.name===l.name);if(!d){i.push({message:`Field "${l.name}" does not exist on type "${o.name}"`,field:l.name,type:o.name});continue}if(l.args&&d.args){for(const[h,p]of Object.entries(l.args))d.args.find(v=>v.name===h)||i.push({message:`Argument "${h}" does not exist on field "${l.name}"`,field:l.name,path:[l.name,h]});for(const h of d.args)h.type.endsWith("!")&&!l.args[h.name]&&h.defaultValue===void 0&&(l.args[`$${h.name}`]||n?.[h.name]||i.push({message:`Required argument "${h.name}" is missing on field "${l.name}"`,field:l.name,path:[l.name,h.name]}))}else if(d.args&&d.args.length>0)for(const h of d.args)h.type.endsWith("!")&&h.defaultValue===void 0&&(n?.[h.name]||i.push({message:`Required argument "${h.name}" is missing on field "${l.name}"`,field:l.name,path:[l.name,h.name]}));if(l.nestedFields&&d.type){const h=this.extractTypeName(d.type),p=this.findTypeInSchema(h,a);if(p&&p.kind==="OBJECT")for(const g of l.nestedFields)p.fields?.find(b=>b.name===g)||i.push({message:`Field "${g}" does not exist on type "${h}"`,field:g,type:h,path:[l.name,g]})}}return{valid:i.length===0,errors:i}}extractTypeName(e){let t=e.replace(/^\[|\]$/g,"").replace(/!$/,"");return t=t.replace(/^\[|\]$/g,"").replace(/!$/,""),t}findTypeInSchema(e,t){return t.types?.find(s=>s.name===e)}handleIntrospectionQuery(e){if(!this.config?.introspectionEnabled)return{success:!1,error:"Introspection is disabled"};const t=Date.now();return t-this.lastIntrospectionSecondStart>=1e3&&(this.introspectionMetrics.introspectionQueriesPerSecond=this.introspectionQueriesThisSecond,this.introspectionQueriesThisSecond=0,this.lastIntrospectionSecondStart=t),this.introspectionQueriesThisSecond++,this.introspectionMetrics.totalIntrospectionQueries++,this.introspectionMetrics.lastIntrospectionTime=t,e.includes("__schema")||e.includes("__type")?{success:!0,data:this.buildIntrospectionResponse()}:e.includes("__typename")?{success:!0,data:{__typename:"Query"}}:{success:!1,error:"Invalid introspection query"}}buildIntrospectionResponse(){if(!this.config?.schema)return{__schema:null};const e=this.config.schema,t=(e.types||[]).map(a=>({name:a.name,kind:a.kind,description:a.description,fields:a.fields?.map(o=>({name:o.name,description:o.description,type:{name:this.extractTypeName(o.type),kind:this.getTypeKind(o.type)},args:o.args?.map(l=>({name:l.name,type:{name:this.extractTypeName(l.type),kind:this.getTypeKind(l.type)},defaultValue:l.defaultValue}))||[]}))||[]})),s=e.queries?.find(a=>a.name==="Query"),n=e.mutations?.find(a=>a.name==="Mutation"),i=e.subscriptions?.find(a=>a.name==="Subscription");return{__schema:{queryType:s?{name:s.name,kind:s.kind,fields:s.fields?.map(a=>({name:a.name,type:{name:this.extractTypeName(a.type)}}))}:null,mutationType:n?{name:n.name,kind:n.kind}:null,subscriptionType:i?{name:i.name,kind:i.kind}:null,types:t}}}getTypeKind(e){const t=this.extractTypeName(e);return this.findTypeInSchema(t,this.config?.schema||{})?.kind||"SCALAR"}detectSchemaChanges(e){const t=[];if(!this.previousSchema)return this.previousSchema=JSON.parse(JSON.stringify(e)),t;const s=this.previousSchema,n=new Map((s.types||[]).map(o=>[o.name,o])),i=new Map((e.types||[]).map(o=>[o.name,o]));for(const[o,l]of i.entries())if(!n.has(o))t.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"type_added",typeName:o,breaking:!1,timestamp:Date.now()});else{const d=n.get(o),h=this.detectFieldChanges(d,l,o);t.push(...h)}for(const[o]of n.entries())i.has(o)||t.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"type_removed",typeName:o,breaking:!0,timestamp:Date.now()});return this.detectRootTypeChanges(s.queries||[],e.queries||[],"Query",t),this.detectRootTypeChanges(s.mutations||[],e.mutations||[],"Mutation",t),this.detectRootTypeChanges(s.subscriptions||[],e.subscriptions||[],"Subscription",t),this.previousSchema=JSON.parse(JSON.stringify(e)),this.schemaChanges.push(...t),this.schemaChanges.length>this.MAX_SCHEMA_CHANGES_HISTORY&&this.schemaChanges.shift(),(t.some(o=>o.breaking)||t.length>0)&&this.createSchemaVersion(e,t),t}detectFieldChanges(e,t,s){const n=[],i=new Map((e.fields||[]).map(o=>[o.name,o])),a=new Map((t.fields||[]).map(o=>[o.name,o]));for(const[o,l]of a.entries())if(!i.has(o))n.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"field_added",field:o,typeName:s,newValue:l,breaking:!1,timestamp:Date.now()});else{const d=i.get(o);d.type!==l.type&&n.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"field_type_changed",field:o,typeName:s,oldValue:d.type,newValue:l.type,breaking:!0,timestamp:Date.now()});const h=this.detectArgumentChanges(d,l,s,o);n.push(...h)}for(const[o,l]of i.entries())a.has(o)||n.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"field_removed",field:o,typeName:s,oldValue:l,breaking:!0,timestamp:Date.now()});return n}detectArgumentChanges(e,t,s,n){const i=[],a=new Map((e.args||[]).map(l=>[l.name,l])),o=new Map((t.args||[]).map(l=>[l.name,l]));for(const[l,d]of o.entries())if(!a.has(l))i.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"argument_added",field:n,typeName:s,newValue:d,breaking:d.type.endsWith("!")&&d.defaultValue===void 0,timestamp:Date.now()});else{const h=a.get(l);h.type!==d.type&&i.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"argument_type_changed",field:n,typeName:s,oldValue:h.type,newValue:d.type,breaking:!0,timestamp:Date.now()})}for(const[l,d]of a.entries())o.has(l)||i.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"argument_removed",field:n,typeName:s,oldValue:d,breaking:!0,timestamp:Date.now()});return i}detectRootTypeChanges(e,t,s,n){const i=e.find(o=>o.name===s),a=t.find(o=>o.name===s);if(!i&&a)n.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"type_added",typeName:s,breaking:!1,timestamp:Date.now()});else if(i&&a){const o=this.detectFieldChanges(i,a,s);n.push(...o)}else i&&!a&&n.push({id:`change-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,changeType:"type_removed",typeName:s,breaking:!0,timestamp:Date.now()})}createSchemaVersion(e,t){const s={version:`v${this.schemaVersions.length+1}.0.0`,schema:JSON.parse(JSON.stringify(e)),timestamp:Date.now(),changes:[...t]};this.schemaVersions.push(s),this.schemaVersions.length>this.MAX_SCHEMA_VERSIONS&&this.schemaVersions.shift()}calculateComplexity(e){let t=1;const s=e.match(/(\w+)\s*(\([^)]*\))?\s*\{/g);if(s)for(const l of s){const d=l.match(/(\w+)/);if(d){const h=d[1];if(["query","mutation","subscription"].includes(h.toLowerCase()))continue;const p=this.config?.fieldComplexityWeights?.[h]||1;t+=p,this.isListField(h)&&(t+=p*2)}}const n=this.calculateDepth(e);t+=n*3;const i=e.match(/\([^)]+\)/g);i&&(t+=i.length*1.5);const a=e.match(/fragment\s+\w+/gi);a&&(t+=a.length*2);const o=e.match(/\.\.\.\s*on\s+\w+/gi);return o&&(t+=o.length*1.5),Math.round(t)}isListField(e){if(!this.config?.schema)return!1;const t=this.config.schema.queries?.find(s=>s.name==="Query");if(t?.fields){const s=t.fields.find(n=>n.name===e);if(s)return s.type.startsWith("[")||s.type.includes("List")}return!1}calculateDepth(e){let t=0,s=0;for(const n of e)n==="{"?(s++,t=Math.max(t,s)):n==="}"&&s--;return t}getClientIdentifier(e,t){if(!this.config?.rateLimit)return"default";const s=this.config.rateLimit.identifyBy||"ip",n=[];if(s==="ip"||s==="all"){const i=e?.["x-forwarded-for"]||e?.["x-real-ip"]||e?.["client-ip"]||"0.0.0.0";n.push(`ip:${i.split(",")[0].trim()}`)}if(s==="apiKey"||s==="all"){const i=e?.["x-api-key"]||e?.authorization?.replace(/^Bearer\s+/i,"")||t?.apiKey;i&&n.push(`key:${i.substring(0,20)}`)}if(s==="user"||s==="all"){const i=e?.["x-user-id"]||t?.userId||t?.user_id;i&&n.push(`user:${i}`)}return n.length>0?n.join("|"):"default"}checkRateLimit(e,t){if(!this.config?.rateLimit?.enabled)return{allowed:!0,remaining:1/0,resetAt:Date.now()+1e3,limit:1/0};const s=this.config.rateLimit,n=s.windowMs||1e3,i=Date.now();let a;e==="query"?a=s.queriesPerSecond||100:e==="mutation"?a=s.mutationsPerSecond||50:a=s.subscriptionsPerSecond||10;const o=s.globalPerSecond;if(o){const h=`global:${t}`,p=this.rateLimitCounters.get(h);if(p)if(i>=p.resetAt)this.rateLimitCounters.set(h,{count:1,resetAt:i+n,windowStart:i});else{if(p.count>=o)return this.rateLimitMetrics.totalRateLimitHits++,this.rateLimitHitsThisSecond++,this.rateLimitMetrics.totalBlockedRequests++,this.blockedRequestsThisSecond++,this.rateLimitMetrics.blockedByType[e+"s"]++,this.rateLimitMetrics.lastBlockedTime=i,{allowed:!1,remaining:0,resetAt:p.resetAt,limit:o};p.count++}else this.rateLimitCounters.set(h,{count:1,resetAt:i+n,windowStart:i})}const l=`${t}:${e}`,d=this.rateLimitCounters.get(l);return!d||i>=d.resetAt?(this.rateLimitCounters.set(l,{count:1,resetAt:i+n,windowStart:i}),{allowed:!0,remaining:a-1,resetAt:i+n,limit:a}):d.count>=a?(this.rateLimitMetrics.totalRateLimitHits++,this.rateLimitHitsThisSecond++,this.rateLimitMetrics.totalBlockedRequests++,this.blockedRequestsThisSecond++,this.rateLimitMetrics.blockedByType[e+"s"]++,this.rateLimitMetrics.lastBlockedTime=i,{allowed:!1,remaining:0,resetAt:d.resetAt,limit:a}):(d.count++,{allowed:!0,remaining:a-d.count,resetAt:d.resetAt,limit:a})}async executeWithTimeout(e,t,s,n){if(!this.config?.timeout?.enabled||t<=0)return await e();const i=Date.now();return Promise.race([e(),new Promise((a,o)=>{setTimeout(()=>{const l=Date.now()-i;this.recordTimeout(s,l,n),o(new Error(`${s} timeout after ${t}ms`))},t)})])}recordTimeout(e,t,s){if(this.timeoutMetrics.totalTimeouts++,this.timeoutsThisSecond++,e==="query"?this.timeoutMetrics.queryTimeouts++:e==="mutation"?this.timeoutMetrics.mutationTimeouts++:this.timeoutMetrics.resolverTimeouts++,this.timeoutMetrics.lastTimeoutTime=Date.now(),this.timeoutDurations.push(t),this.timeoutDurations.length>this.MAX_TIMEOUT_HISTORY&&this.timeoutDurations.shift(),this.timeoutDurations.length>0){const n=this.timeoutDurations.reduce((i,a)=>i+a,0);this.timeoutMetrics.averageTimeoutDuration=n/this.timeoutDurations.length}this.recordError("timeout",`Timeout after ${t}ms`,s,e==="resolver"?void 0:e)}getTimeoutForOperation(e){if(!this.config?.timeout?.enabled)return 0;const t=this.config.timeout;return e==="query"?t.queryTimeout||t.defaultTimeout||3e4:e==="mutation"?t.mutationTimeout||t.defaultTimeout||6e4:t.defaultTimeout||3e4}async executeQuery(e,t,s,n,i,a){const o=this.extractRequestedFields(e);return this.config?.resolvers&&this.config.resolvers.length>0&&s&&n?await this.executeQueryWithResolvers(e,t,o,s,n,i,a):this.executeQuerySimple(e,t)}async executeQueryWithResolvers(e,t,s,n,i,a,o){const l={};this.requestCache.clear();const d=e.trim().toLowerCase().startsWith("query");this.detectNPlusOneProblems(e,s,d?"Query":"Mutation");const h=new Map;for(const v of s){const b=this.findResolverForField(v,d?"Query":"Mutation");if(b&&b.enabled!==!1&&b.targetService){const M=b.id;h.has(M)||h.set(M,{resolver:b,fields:[]}),h.get(M).fields.push(v)}}const p=[];for(const[v,b]of h.entries()){const{resolver:M,fields:x}=b;let S=this.dataLoaders.get(v);if(!S){const T=async(E,A,k,D)=>this.executeResolverBatch(E,A,k,D,a,o);S=new vk(v,T,n,i),this.dataLoaders.set(v,S)}S.nodes=n,S.connections=i,S.traceContext=a,S.getJaegerEngines=o;for(const T of x){const E=this.extractFieldVariables(e,T,t);p.push(S.load(E,!0).then(A=>({field:T,data:A})).catch(A=>({field:T,data:this.getFallbackDataForField(T,t)})))}}for(const v of s)h.has(this.findResolverForField(v,d?"Query":"Mutation")?.id||"")||(l[v]=this.getFallbackDataForField(v,t));const g=await Promise.all(p);for(const{field:v,data:b}of g)l[v]=b;for(const v of this.dataLoaders.values())v.clearQueue();return l}extractFieldVariables(e,t,s){const n=new RegExp(`${t}\\s*\\(([^)]*)\\)`,"i"),i=e.match(n);if(i&&i[1]){const a={},o=i[1].split(",").map(l=>l.trim());for(const l of o){const[d,h]=l.split(":").map(p=>p.trim());d&&h&&(a[d]=h.replace(/^["']|["']$/g,""))}return{...s,...a}}return s||{}}async executeResolverBatch(e,t,s,n,i,a){const o=this.config?.resolvers?.find(p=>p.id===e);if(!o)return t.map(()=>({success:!1,error:`Resolver not found: ${e}`,latency:0,resolverId:e}));const l=Date.now(),d=await Promise.all(t.map(p=>this.executeResolver(o,p,s,n,i,a))),h=Date.now();if(i&&a&&t.length>1){const p=d.every(g=>g.success);this.createDataLoaderBatchSpan(e,t.length,l/1e3,h/1e3,p,i,a)}return d}detectNPlusOneProblems(e,t,s){for(const n of t){const i=this.findResolverForField(n,s);if(i&&i.enabled!==!1){const a=new RegExp(`\\[.*?${n}.*?\\{`,"s"),o=new RegExp(`${n}\\s*\\{[^}]*\\}`,"s");if(a.test(e)&&o.test(e)){const l=e.match(/\[/g),d=l?Math.pow(10,l.length):10;let h="low";d>100?h="high":d>20&&(h="medium"),this.nPlusOneProblems.find(g=>g.field===n&&g.resolverId===i.id)||(this.nPlusOneProblems.push({field:n,resolverId:i.id,parentType:s,estimatedCalls:d,severity:h,detectedAt:Date.now()}),this.nPlusOneProblems.length>this.MAX_N_PLUS_ONE_HISTORY&&this.nPlusOneProblems.shift())}}}}executeQuerySimple(e,t){return e.includes("users")?{users:[{id:"1",name:"John Doe",email:"john@example.com"},{id:"2",name:"Jane Smith",email:"jane@example.com"}]}:e.includes("user")?{user:{id:t?.id||"1",name:"John Doe",email:"john@example.com"}}:e.includes("posts")?{posts:[{id:"1",title:"Post 1",content:"Content 1",author:{id:"1",name:"John Doe"}},{id:"2",title:"Post 2",content:"Content 2",author:{id:"2",name:"Jane Smith"}}]}:{data:null}}extractRequestedFields(e){const t=[],s=e.match(/\b(\w+)\s*\{/g);if(s)for(const n of s){const i=n.replace(/\s*\{/,"").trim();["query","mutation","subscription"].includes(i.toLowerCase())||t.push(i)}return t}findResolverForField(e,t){if(this.config?.resolvers)return this.config.resolvers.find(s=>s.field===e&&s.type===t&&s.enabled!==!1)}async executeResolver(e,t,s,n,i,a){const o=Date.now(),d=this.selectInstanceForLoadBalancing(e)||e.targetService;let h=null;try{h=await this.getConnectionFromPool(e.id,d)}catch(M){const x=Date.now()-o,S=`Failed to get connection from pool: ${M.message}`;return this.recordResolverCall(e.id,!1,x),{success:!1,error:S,latency:x,resolverId:e.id}}const p=s.find(M=>M.id===d);if(!p){h&&(this.releaseConnectionToPool(e.id,h.connectionId,!1),this.releaseInstanceFromLoadBalancing(e.id,h.instanceId));const M=Date.now()-o,x=Date.now(),S=`Target service not found: ${e.targetService}`;return i&&a&&this.createResolverSpan(e,o/1e3,x/1e3,!1,S,i,a),this.recordResolverCall(e.id,!1,M),{success:!1,error:S,latency:M,resolverId:e.id}}if(!n.find(M=>M.source===this.componentId&&M.target===d)){h&&(this.releaseConnectionToPool(e.id,h.connectionId,!1),this.releaseInstanceFromLoadBalancing(e.id,h.instanceId));const M=Date.now()-o,x=Date.now(),S=`No connection found to target service: ${d}`;return i&&a&&this.createResolverSpan(e,o/1e3,x/1e3,!1,S,i,a),this.recordResolverCall(e.id,!1,M),{success:!1,error:S,latency:M,resolverId:e.id}}const v=e.latency||this.config?.responseLatency||50,b=this.config?.timeout?.resolverTimeout||this.config?.timeout?.defaultTimeout||5e3;try{const M=await this.executeWithTimeout(async()=>(await new Promise(T=>setTimeout(T,v)),this.simulateResolverData(p,e,t)),b,"resolver",`${e.type}.${e.field}`),x=Date.now()-o,S=Date.now();return i&&a&&this.createResolverSpan(e,o/1e3,S/1e3,!0,void 0,i,a),this.recordResolverCall(e.id,!0,x),h&&(this.releaseConnectionToPool(e.id,h.connectionId,!0),this.releaseInstanceFromLoadBalancing(e.id,h.instanceId)),{success:!0,data:M,latency:x,resolverId:e.id}}catch(M){const x=Date.now()-o,S=Date.now(),T=M.message||"Resolver execution failed";return h&&(this.releaseConnectionToPool(e.id,h.connectionId,!1),this.releaseInstanceFromLoadBalancing(e.id,h.instanceId)),i&&a&&this.createResolverSpan(e,o/1e3,S/1e3,!1,T,i,a),this.recordResolverCall(e.id,!1,x),{success:!1,error:T,latency:x,resolverId:e.id}}}initializeConnectionPool(e){const t=e.connectionPoolSize||this.config?.connectionPool?.defaultPoolSize||10;this.connectionPools.set(e.id,{connections:[],maxSize:t,currentSize:0,waitingQueue:[],totalRequests:0,failedRequests:0})}initializeLoadBalancing(e){if(!e.instances||e.instances.length<=1)return;const t=this.config?.loadBalancing?.strategy||"round-robin",s=this.config?.loadBalancing?.weights,n=new Map;if(t==="weighted"&&s)for(const i of e.instances)n.set(i,s[i]||1);this.loadBalancingState.set(e.id,{strategy:t,currentIndex:0,instanceConnections:new Map,instanceWeights:t==="weighted"?n:void 0,totalRequests:0,requestsByInstance:new Map});for(const i of e.instances)this.loadBalancingState.get(e.id).instanceConnections.set(i,0),this.loadBalancingState.get(e.id).requestsByInstance.set(i,0)}async getConnectionFromPool(e,t){if(!this.config?.connectionPool?.enabled)return{connectionId:`${e}:${t||"default"}`,instanceId:t||"default"};const s=this.connectionPools.get(e);if(!s){const a=this.config?.resolvers?.find(o=>o.id===e);if(a)return this.initializeConnectionPool(a),this.getConnectionFromPool(e,t);throw new Error(`Connection pool not found for resolver: ${e}`)}const n=Date.now();this.connectionPoolMetrics.totalConnectionAttempts++;const i=s.connections.find(a=>a.status==="idle"&&(!t||a.id.includes(t)));if(i){i.status="active",i.lastUsed=Date.now(),this.connectionPoolMetrics.activeConnections++,this.connectionPoolMetrics.idleConnections--;const a=Date.now()-n;return this.connectionWaitTimes.push(a),this.connectionWaitTimes.length>this.MAX_WAIT_TIME_HISTORY&&this.connectionWaitTimes.shift(),{connectionId:i.id,instanceId:t||i.id.split(":")[1]||"default"}}if(s.currentSize<s.maxSize){const a=`${e}:${t||"default"}:${Date.now()}`,o={id:a,status:"active",createdAt:Date.now(),lastUsed:Date.now(),consecutiveFailures:0};s.connections.push(o),s.currentSize++,this.connectionPoolMetrics.totalConnections++,this.connectionPoolMetrics.activeConnections++;const l=`${e}:${t||"default"}`;this.connectionHealth.has(l)||this.connectionHealth.set(l,{status:"healthy",lastCheckTime:Date.now(),consecutiveFailures:0,reconnectAttempts:0});const d=Date.now()-n;return this.connectionWaitTimes.push(d),this.connectionWaitTimes.length>this.MAX_WAIT_TIME_HISTORY&&this.connectionWaitTimes.shift(),{connectionId:a,instanceId:t||"default"}}return new Promise((a,o)=>{const l=setTimeout(()=>{s.waitingQueue=s.waitingQueue.filter(d=>d.reject!==o),this.connectionPoolMetrics.failedConnectionAttempts++,o(new Error("Connection pool timeout"))},5e3);s.waitingQueue.push({resolve:d=>{clearTimeout(l),a(d)},reject:d=>{clearTimeout(l),o(d)},timestamp:Date.now()})})}releaseConnectionToPool(e,t,s){if(!this.config?.connectionPool?.enabled)return;const n=this.connectionPools.get(e);if(!n)return;const i=n.connections.find(a=>a.id===t);if(i){if(n.totalRequests++,s)i.consecutiveFailures=0;else if(n.failedRequests++,i.consecutiveFailures++,i.consecutiveFailures>=3){i.status="unhealthy";const a=t.split(":").slice(0,2).join(":"),o=this.connectionHealth.get(a);o&&(o.status="unhealthy",o.consecutiveFailures=i.consecutiveFailures)}if(i.status==="unhealthy"){if(n.connections=n.connections.filter(a=>a.id!==t),n.currentSize--,this.connectionPoolMetrics.totalConnections--,this.connectionPoolMetrics.activeConnections--,n.waitingQueue.length>0){const a=n.waitingQueue.shift();a&&this.getConnectionFromPool(e).then(o=>{a.resolve(o)}).catch(o=>{a.reject(o)})}return}if(i.status="idle",i.lastUsed=Date.now(),this.connectionPoolMetrics.activeConnections--,this.connectionPoolMetrics.idleConnections++,n.waitingQueue.length>0){const a=n.waitingQueue.shift();a&&(i.status="active",i.lastUsed=Date.now(),this.connectionPoolMetrics.activeConnections++,this.connectionPoolMetrics.idleConnections--,a.resolve({connectionId:i.id,instanceId:i.id.split(":")[1]||"default"}))}}}selectInstanceForLoadBalancing(e){if(!this.config?.loadBalancing?.enabled||!e.instances||e.instances.length<=1)return e.targetService;const t=this.loadBalancingState.get(e.id);if(!t)return e.instances[0];let s=e.instances[0];switch(t.strategy){case"round-robin":s=e.instances[t.currentIndex%e.instances.length],t.currentIndex=(t.currentIndex+1)%e.instances.length;break;case"least-connections":let a=1/0;s=e.instances[0];for(const d of e.instances){const h=t.instanceConnections.get(d)||0;h<a&&(a=h,s=d)}break;case"random":s=e.instances[Math.floor(Math.random()*e.instances.length)];break;case"weighted":if(!t.instanceWeights){s=e.instances[0];break}const o=Array.from(t.instanceWeights.values()).reduce((d,h)=>d+h,0);let l=Math.random()*o;for(const d of e.instances){const h=t.instanceWeights.get(d)||1;if(l-=h,l<=0){s=d;break}}s||(s=e.instances[0]);break;default:s=e.instances[0]}t.totalRequests++;const n=t.requestsByInstance.get(s)||0;t.requestsByInstance.set(s,n+1);const i=t.instanceConnections.get(s)||0;return t.instanceConnections.set(s,i+1),this.loadBalancingMetrics.totalRequests++,s}releaseInstanceFromLoadBalancing(e,t){if(!this.config?.loadBalancing?.enabled)return;const s=this.loadBalancingState.get(e);if(!s)return;const n=s.instanceConnections.get(t)||0;n>0&&s.instanceConnections.set(t,n-1)}startHealthChecks(){if(this.healthCheckInterval)return;const e=this.config?.connectionPool?.healthCheckInterval||3e4;this.healthCheckInterval=setInterval(()=>{this.performHealthChecks()},e)}performHealthChecks(){if(!this.config?.connectionPool?.enabled)return;const e=Date.now();this.connectionHealthMetrics.totalHealthChecks++;for(const[n,i]of this.connectionPools.entries())for(const a of i.connections){const o=a.id.split(":").slice(0,2).join(":");let l=this.connectionHealth.get(o);l||(l={status:"healthy",lastCheckTime:e,consecutiveFailures:0,reconnectAttempts:0},this.connectionHealth.set(o,l)),l.lastCheckTime=e,this.connectionHealthMetrics.lastHealthCheckTime=e,Math.random()>.05?l.status==="unhealthy"&&(l.status="healthy",l.consecutiveFailures=0,a.status=a.status==="unhealthy"?"idle":a.status,this.connectionHealthMetrics.successfulReconnects++,this.connectionHealthMetrics.totalReconnects++):(this.connectionHealthMetrics.failedHealthChecks++,l.consecutiveFailures++,l.consecutiveFailures>=3&&(l.status="unhealthy",a.status="unhealthy",this.connectionHealthMetrics.unhealthyConnections++,l.reconnectAttempts<(this.config.connectionPool?.maxReconnectAttempts||3)?(l.status="reconnecting",l.reconnectAttempts++,this.connectionHealthMetrics.totalReconnects++,setTimeout(()=>{Math.random()>.3?(l.status="healthy",a.status="idle",l.consecutiveFailures=0,this.connectionHealthMetrics.successfulReconnects++):(l.status="unhealthy",this.connectionHealthMetrics.failedReconnects++)},this.config.connectionPool?.reconnectDelay||1e3)):this.connectionHealthMetrics.failedReconnects++))}let t=0,s=0;for(const n of this.connectionHealth.values())n.status==="healthy"?t++:s++;this.connectionHealthMetrics.healthyConnections=t,this.connectionHealthMetrics.unhealthyConnections=s,this.connectionHealthMetrics.healthCheckFailureRate=this.connectionHealthMetrics.totalHealthChecks>0?this.connectionHealthMetrics.failedHealthChecks/this.connectionHealthMetrics.totalHealthChecks:0,this.connectionHealthMetrics.reconnectSuccessRate=this.connectionHealthMetrics.totalReconnects>0?this.connectionHealthMetrics.successfulReconnects/this.connectionHealthMetrics.totalReconnects:0}simulateResolverData(e,t,s){switch(e.type){case"postgres":case"mongodb":case"redis":case"cassandra":case"clickhouse":case"snowflake":case"elasticsearch":return this.simulateDatabaseResponse(t,s);case"rest":case"grpc":return this.simulateAPIResponse(t,s);default:return this.getFallbackDataForField(t.field,s)}}simulateDatabaseResponse(e,t){const s=e.field.toLowerCase();return s.includes("user")?t?.id?{id:t.id,name:`User ${t.id}`,email:`user${t.id}@example.com`}:[{id:"1",name:"User 1",email:"user1@example.com"},{id:"2",name:"User 2",email:"user2@example.com"}]:s.includes("post")?[{id:"1",title:"Post 1",content:"Content 1"},{id:"2",title:"Post 2",content:"Content 2"}]:null}simulateAPIResponse(e,t){return{data:this.getFallbackDataForField(e.field,t),status:"success"}}getFallbackDataForField(e,t){const s=e.toLowerCase();return s.includes("user")?t?.id?{id:t.id,name:`User ${t.id}`,email:`user${t.id}@example.com`}:[{id:"1",name:"John Doe",email:"john@example.com"},{id:"2",name:"Jane Smith",email:"jane@example.com"}]:s.includes("post")?[{id:"1",title:"Post 1",content:"Content 1"},{id:"2",title:"Post 2",content:"Content 2"}]:null}recordResolverCall(e,t,s){let n=this.resolverMetrics.get(e);if(!n){const i=this.config?.resolvers?.find(a=>a.id===e);if(!i)return;n={id:e,type:i.type,field:i.field,totalCalls:0,totalErrors:0,averageLatency:0,totalLatency:0,errorRate:0},this.resolverMetrics.set(e,n)}n.totalCalls++,n.totalLatency+=s,n.averageLatency=n.totalLatency/n.totalCalls,n.lastCallTime=Date.now(),t||n.totalErrors++,n.errorRate=n.totalErrors/n.totalCalls}executeMutation(e,t){return e.includes("createUser")?{createUser:{id:`user-${Date.now()}`,name:t?.name||"New User",email:t?.email||"newuser@example.com"}}:e.includes("updateUser")?{updateUser:{id:t?.id||"1",name:t?.name||"Updated User",email:t?.email||"updated@example.com"}}:e.includes("deleteUser")?{deleteUser:!0}:{data:null}}getCacheKey(e){const t=e.variables?JSON.stringify(e.variables):"";return`${e.query}:${t}`}getPersistedQueries(){return Array.from(this.persistedQueries.values())}getPersistedQueryByHash(e){return this.persistedQueries.get(e)}deletePersistedQuery(e){const t=this.persistedQueries.delete(e);return t&&this.config&&(this.config.persistedQueries=Array.from(this.persistedQueries.values())),t}getBatchQueryMetrics(){return{...this.batchQueryMetrics}}recordQuery(e,t,s,n,i=!1,a,o="query",l,d){const h=Date.now();if(h-this.lastSecondStart>=1e3&&(this.graphQLMetrics.queriesPerSecond=this.queriesThisSecond,this.queriesThisSecond=0,this.lastSecondStart=h),this.queriesThisSecond++,this.graphQLMetrics.totalQueries++,!e&&(this.graphQLMetrics.totalErrors++,d)){const b=this.categorizeError(d,o);this.recordError(b,d,a,o)}this.latencyHistory.push(t),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift();const p=this.latencyHistory.reduce((b,M)=>b+M,0);if(this.graphQLMetrics.averageResponseTime=p/this.latencyHistory.length,s>0){this.complexityHistory.push(s),this.complexityHistory.length>this.MAX_LATENCY_HISTORY&&this.complexityHistory.shift();const b=this.complexityHistory.reduce((M,x)=>M+x,0);this.graphQLMetrics.averageComplexity=b/this.complexityHistory.length}if(n>0){this.depthHistory.push(n),this.depthHistory.length>this.MAX_LATENCY_HISTORY&&this.depthHistory.shift();const b=this.depthHistory.reduce((M,x)=>M+x,0);this.graphQLMetrics.averageDepth=b/this.depthHistory.length}this.graphQLMetrics.totalQueries>0&&(this.graphQLMetrics.errorRate=this.graphQLMetrics.totalErrors/this.graphQLMetrics.totalQueries);const g=o==="query"?"Query":o==="mutation"?"Mutation":"Subscription";if(this.recordTypeMetrics(g,e,t,s,n),a&&this.recordOperationMetrics(a,o,e,t,s,n),l)for(const b of l)this.recordFieldMetrics(b.name,g,e,t);const v={id:`query-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,query:"",timestamp:h,duration:t,success:e,complexity:s,depth:n,operationName:a};this.queryHistory.push(v),this.queryHistory.length>this.MAX_HISTORY_SIZE&&this.queryHistory.shift()}recordMutation(e,t,s,n,i){Date.now()-this.lastSecondStart>=1e3&&(this.graphQLMetrics.mutationsPerSecond=this.mutationsThisSecond,this.mutationsThisSecond=0),this.mutationsThisSecond++,this.graphQLMetrics.totalMutations++,e||(this.graphQLMetrics.totalErrors++,i&&this.recordError(this.categorizeError(i,"mutation"),i,s,"mutation"));const o=this.graphQLMetrics.totalQueries+this.graphQLMetrics.totalMutations;if(o>0&&(this.graphQLMetrics.errorRate=this.graphQLMetrics.totalErrors/o),this.recordTypeMetrics("Mutation",e,t,0,0),s&&this.recordOperationMetrics(s,"mutation",e,t,0,0),n)for(const l of n)this.recordFieldMetrics(l.name,"Mutation",e,t)}recordFieldMetrics(e,t,s,n){const i=`${t}:${e}`;let a=this.fieldMetrics.get(i);a||(a={fieldName:e,typeName:t,totalCalls:0,totalErrors:0,averageLatency:0,totalLatency:0,minLatency:n,maxLatency:n,errorRate:0,callsPerSecond:0},this.fieldMetrics.set(i,a)),a.totalCalls++,a.totalLatency+=n,a.averageLatency=a.totalLatency/a.totalCalls,a.minLatency=Math.min(a.minLatency,n),a.maxLatency=Math.max(a.maxLatency,n),a.lastCallTime=Date.now(),s||a.totalErrors++,a.errorRate=a.totalErrors/a.totalCalls;const o=Date.now();o-this.lastMetricsSecondStart>=1e3&&(this.updateFieldMetricsPerSecond(),this.lastMetricsSecondStart=o);const l=this.fieldCallsThisSecond.get(i)||0;this.fieldCallsThisSecond.set(i,l+1)}updateFieldMetricsPerSecond(){for(const[e,t]of this.fieldCallsThisSecond.entries()){const s=this.fieldMetrics.get(e);s&&(s.callsPerSecond=t)}this.fieldCallsThisSecond.clear()}recordTypeMetrics(e,t,s,n,i){let a=this.typeMetrics.get(e);a||(a={typeName:e,totalOperations:0,totalErrors:0,averageLatency:0,averageComplexity:0,averageDepth:0,errorRate:0,operationsPerSecond:0},this.typeMetrics.set(e,a)),a.totalOperations++,t||a.totalErrors++;const o=.1;a.averageLatency=a.averageLatency*(1-o)+s*o,n>0&&(a.averageComplexity=a.averageComplexity*(1-o)+n*o),i>0&&(a.averageDepth=a.averageDepth*(1-o)+i*o),a.errorRate=a.totalErrors/a.totalOperations,a.lastOperationTime=Date.now(),Date.now()-this.lastMetricsSecondStart>=1e3&&this.updateTypeMetricsPerSecond();const d=this.typeOpsThisSecond.get(e)||0;this.typeOpsThisSecond.set(e,d+1)}updateTypeMetricsPerSecond(){for(const[e,t]of this.typeOpsThisSecond.entries()){const s=this.typeMetrics.get(e);s&&(s.operationsPerSecond=t)}this.typeOpsThisSecond.clear()}recordOperationMetrics(e,t,s,n,i,a){if(this.operationMetrics.size>=this.MAX_OPERATIONS&&!this.operationMetrics.has(e)){let p=null,g=1/0;for(const[v,b]of this.operationMetrics.entries())b.totalCalls<g&&(g=b.totalCalls,p=v);p&&this.operationMetrics.delete(p)}let o=this.operationMetrics.get(e);o||(o={operationName:e,operationType:t,totalCalls:0,totalErrors:0,averageLatency:0,averageComplexity:0,averageDepth:0,errorRate:0,callsPerSecond:0,history:[]},this.operationMetrics.set(e,o)),o.totalCalls++,s||o.totalErrors++;const l=.1;o.averageLatency=o.averageLatency*(1-l)+n*l,i>0&&(o.averageComplexity=o.averageComplexity*(1-l)+i*l),a>0&&(o.averageDepth=o.averageDepth*(1-l)+a*l),o.errorRate=o.totalErrors/o.totalCalls,o.lastCallTime=Date.now(),o.history&&(o.history.push({timestamp:Date.now(),latency:n,success:s,complexity:i>0?i:void 0,depth:a>0?a:void 0}),o.history.length>this.MAX_OPERATION_HISTORY&&o.history.shift()),Date.now()-this.lastMetricsSecondStart>=1e3&&this.updateOperationMetricsPerSecond();const h=this.operationCallsThisSecond.get(e)||0;this.operationCallsThisSecond.set(e,h+1)}updateOperationMetricsPerSecond(){for(const[e,t]of this.operationCallsThisSecond.entries()){const s=this.operationMetrics.get(e);s&&(s.callsPerSecond=t)}this.operationCallsThisSecond.clear()}recordError(e,t,s,n){let i=this.errorMetrics.get(e);i||(i={category:e,totalErrors:0,errorsPerSecond:0,recentErrors:[]},this.errorMetrics.set(e,i)),i.totalErrors++,i.lastErrorTime=Date.now();const a={timestamp:Date.now(),category:e,message:t,operationName:s,operationType:n};i.recentErrors&&(i.recentErrors.push(a),i.recentErrors.length>this.MAX_ERROR_HISTORY&&i.recentErrors.shift()),this.errorHistory.push(a),this.errorHistory.length>this.MAX_TOTAL_ERROR_HISTORY&&this.errorHistory.shift(),Date.now()-this.lastMetricsSecondStart>=1e3&&this.updateErrorMetricsPerSecond();const l=this.errorCountsThisSecond.get(e)||0;this.errorCountsThisSecond.set(e,l+1)}updateErrorMetricsPerSecond(){for(const[e,t]of this.errorCountsThisSecond.entries()){const s=this.errorMetrics.get(e);s&&(s.errorsPerSecond=t)}this.errorCountsThisSecond.clear()}generateTraceId(){return`graphql-trace-${++this.traceIdCounter}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSpanId(){return`graphql-span-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}sendSpanToJaeger(e,t){if(!t)return;const s=t();if(s.size!==0)for(const[,n]of s)n&&typeof n.receiveSpan=="function"&&n.receiveSpan(e)}createQuerySpan(e,t,s,n,i,a,o,l,d,h){if(!h||h().size===0)return;let g;if(d)g={traceId:d.traceId,spanId:this.generateSpanId(),parentSpanId:d.spanId,sampled:d.sampled};else{const x=this.generateTraceId(),S=this.generateSpanId();g={traceId:x,spanId:S,sampled:!0},this.traceContexts.set(x,g)}const v=(n-s)*1e3,b=s*1e3,M={traceId:g.traceId,spanId:g.spanId,parentSpanId:g.parentSpanId,operationName:`graphql.${t}.${e||"unknown"}`,serviceName:this.componentId||"graphql",startTime:b,duration:v,tags:[{key:"component.type",value:"graphql"},{key:"graphql.operation.type",value:t},{key:"graphql.operation.name",value:e||"unknown"},{key:"status",value:i?"success":"error"}],logs:[]};return a!==void 0&&M.tags.push({key:"graphql.complexity",value:a}),o!==void 0&&M.tags.push({key:"graphql.depth",value:o}),!i&&l&&(M.tags.push({key:"error",value:!0}),M.logs.push({timestamp:b+v,fields:[{key:"event",value:"error"},{key:"error.message",value:l}]})),this.sendSpanToJaeger(M,h),g}createResolverSpan(e,t,s,n,i,a,o){if(!o||!a||o().size===0)return;const d=this.generateSpanId(),h=(s-t)*1e3,p=t*1e3,g={traceId:a.traceId,spanId:d,parentSpanId:a.spanId,sampled:a.sampled},v={traceId:g.traceId,spanId:g.spanId,parentSpanId:g.parentSpanId,operationName:`graphql.resolver.${e.field}`,serviceName:e.targetService||"unknown",startTime:p,duration:h,tags:[{key:"component.type",value:"graphql.resolver"},{key:"graphql.resolver.id",value:e.id},{key:"graphql.resolver.type",value:e.type},{key:"graphql.resolver.field",value:e.field},{key:"graphql.resolver.target",value:e.targetService||"unknown"},{key:"status",value:n?"success":"error"}],logs:[]};return!n&&i&&(v.tags.push({key:"error",value:!0}),v.logs.push({timestamp:p+h,fields:[{key:"event",value:"error"},{key:"error.message",value:i}]})),this.sendSpanToJaeger(v,o),g}createDataLoaderBatchSpan(e,t,s,n,i,a,o){if(!o||!a||o().size===0)return;const d=this.generateSpanId(),h=(n-s)*1e3,p=s*1e3,g={traceId:a.traceId,spanId:d,parentSpanId:a.spanId,operationName:"graphql.dataloader.batch",serviceName:this.componentId||"graphql",startTime:p,duration:h,tags:[{key:"component.type",value:"graphql.dataloader"},{key:"graphql.resolver.id",value:e},{key:"graphql.dataloader.batch.size",value:t},{key:"status",value:i?"success":"error"}],logs:[]};this.sendSpanToJaeger(g,o)}categorizeError(e,t){const s=e.toLowerCase();return s.includes("validation")||s.includes("invalid")||s.includes("schema")?"validation":s.includes("resolver")||s.includes("target service")?"resolver":s.includes("timeout")||s.includes("timed out")?"timeout":s.includes("rate limit")||s.includes("too many requests")?"rate_limit":s.includes("complexity")&&s.includes("exceed")?"complexity_limit":s.includes("depth")&&s.includes("exceed")?"depth_limit":s.includes("execution")||s.includes("execution failed")?"execution":"other"}getGraphQLMetrics(){let e=0,t=0,s=0,n=0,i=0,a=0;for(const l of this.dataLoaders.values()){const d=l.getMetrics();e+=d.totalBatches,t+=d.totalRequests,s+=d.totalBatchedRequests,n+=d.deduplicationRate*d.totalRequests/100,i+=d.cacheHitRate*d.totalRequests/100,a+=d.averageLatencyReduction*d.totalBatches}this.dataLoaderMetrics={totalBatches:e,totalRequests:t,totalBatchedRequests:s,averageBatchSize:e>0?s/e:0,deduplicationRate:t>0?n/t*100:0,cacheHitRate:t>0?i/t*100:0,averageLatencyReduction:e>0?a/e:0};const o=Date.now();return o-this.lastMetricsSecondStart>=1e3&&(this.updateFieldMetricsPerSecond(),this.updateTypeMetricsPerSecond(),this.updateOperationMetricsPerSecond(),this.updateErrorMetricsPerSecond(),this.updateRateLimitMetricsPerSecond(),this.updateTimeoutMetricsPerSecond(),this.lastMetricsSecondStart=o),{...this.graphQLMetrics,resolverMetrics:this.getResolverMetrics(),batchQueryMetrics:this.batchQueryMetrics,persistedQueriesCount:this.persistedQueries.size,persistedQueriesUsage:this.persistedQueriesUsage,introspectionMetrics:this.getIntrospectionMetrics(),fieldMetrics:Array.from(this.fieldMetrics.values()),typeMetrics:Array.from(this.typeMetrics.values()),operationMetrics:Array.from(this.operationMetrics.values()),errorMetrics:Array.from(this.errorMetrics.values()),rateLimitMetrics:{...this.rateLimitMetrics},timeoutMetrics:{...this.timeoutMetrics},connectionPoolMetrics:this.getConnectionPoolMetrics(),connectionHealthMetrics:{...this.connectionHealthMetrics},loadBalancingMetrics:this.getLoadBalancingMetrics()}}getConnectionPoolMetrics(){let e=0,t=0,s=0,n=0;const i={};for(const[a,o]of this.connectionPools.entries()){const l=o.connections.filter(h=>h.status==="active").length,d=o.connections.filter(h=>h.status==="idle").length;e+=o.currentSize,t+=l,s+=d,n+=o.maxSize,i[a]={poolSize:o.maxSize,activeConnections:l,idleConnections:d,utilization:o.maxSize>0?o.currentSize/o.maxSize:0,totalRequests:o.totalRequests,failedRequests:o.failedRequests}}if(this.connectionWaitTimes.length>0){const a=this.connectionWaitTimes.reduce((o,l)=>o+l,0);this.connectionPoolMetrics.averageConnectionWaitTime=a/this.connectionWaitTimes.length}return this.connectionPoolMetrics.totalConnections=e,this.connectionPoolMetrics.activeConnections=t,this.connectionPoolMetrics.idleConnections=s,this.connectionPoolMetrics.maxConnections=n,this.connectionPoolMetrics.connectionUtilization=n>0?e/n:0,this.connectionPoolMetrics.connectionFailureRate=this.connectionPoolMetrics.totalConnectionAttempts>0?this.connectionPoolMetrics.failedConnectionAttempts/this.connectionPoolMetrics.totalConnectionAttempts:0,this.connectionPoolMetrics.poolMetricsByResolver=i,{...this.connectionPoolMetrics}}getLoadBalancingMetrics(){const e={},t={},s={};for(const[i,a]of this.loadBalancingState.entries()){for(const[l,d]of a.requestsByInstance.entries()){const h=`${i}:${l}`;e[h]=(e[h]||0)+d}s[a.strategy]=(s[a.strategy]||0)+a.totalRequests;const o=this.config?.resolvers?.find(l=>l.id===i);if(o?.instances)for(const l of o.instances){const d=a.instanceConnections.get(l)||0,h=a.requestsByInstance.get(l)||0,p=`${i}:${l}`;t[p]=Math.min(1,d/Math.max(1,h/10))}}let n=0;if(Object.keys(e).length>0){const i=Object.values(e),a=i.reduce((d,h)=>d+h,0)/i.length,o=i.reduce((d,h)=>d+Math.pow(h-a,2),0)/i.length,l=Math.sqrt(o);n=a>0?l/a:0}return this.loadBalancingMetrics.requestsByInstance=e,this.loadBalancingMetrics.instanceUtilization=t,this.loadBalancingMetrics.requestsByStrategy=s,this.loadBalancingMetrics.averageLoadDistribution=n,{...this.loadBalancingMetrics}}updateRateLimitMetricsPerSecond(){const e=Date.now();e-this.lastRateLimitSecondStart>=1e3&&(this.rateLimitMetrics.blockedRequestsPerSecond=this.blockedRequestsThisSecond,this.rateLimitMetrics.rateLimitHitsPerSecond=this.rateLimitHitsThisSecond,this.blockedRequestsThisSecond=0,this.rateLimitHitsThisSecond=0,this.lastRateLimitSecondStart=e)}updateTimeoutMetricsPerSecond(){const e=Date.now();e-this.lastTimeoutSecondStart>=1e3&&(this.timeoutMetrics.timeoutsPerSecond=this.timeoutsThisSecond,this.timeoutsThisSecond=0,this.lastTimeoutSecondStart=e)}getDataLoaderMetrics(){return{...this.dataLoaderMetrics}}getNPlusOneProblems(){return[...this.nPlusOneProblems]}getResolverMetrics(){return Array.from(this.resolverMetrics.values())}getResolverMetricsById(e){return this.resolverMetrics.get(e)}getLoad(){const e=this.getGraphQLMetrics(),t=this.config?.requestsPerSecond||100,s=this.config?.responseLatency||50,n=e.queriesPerSecond+e.mutationsPerSecond,i=Math.min(1,n/t),a=Math.min(1,e.subscriptionsActive/100*.5+this.queryCache.size/1e3*.3+.2);return{queriesPerSecond:e.queriesPerSecond,mutationsPerSecond:e.mutationsPerSecond,averageLatency:e.averageResponseTime||s,errorRate:e.errorRate,cpuUtilization:i,memoryUtilization:a}}simulateRequests(e,t,s){if(e<=0)return;const n=Date.now(),i=n-(this.lastSecondStart||n);if(i<=0)return;const a=Math.floor(e*i/1e3);if(a===0)return;const o=["query { users { id name email } }",'query { user(id: "1") { id name email posts { id title } } }',"query { posts { id title author { name } } }"];for(let l=0;l<a;l++){const d=o[Math.floor(Math.random()*o.length)],h=this.processQuery({query:d},t,s);h instanceof Promise&&h.catch(()=>{})}}updateConfig(e){this.config||(this.config={}),e.schema&&this.config.schema&&this.detectSchemaChanges(e.schema),this.config={...this.config,...e},e.subscriptionsEnabled===!1&&(this.activeSubscriptions.clear(),this.graphQLMetrics.subscriptionsActive=0),e.enableCaching===!1&&this.queryCache.clear()}getIntrospectionMetrics(){return{...this.introspectionMetrics}}getSchemaChanges(e){return e?this.schemaChanges.slice(-e):[...this.schemaChanges]}getSchemaVersions(e){return e?this.schemaVersions.slice(-e):[...this.schemaVersions]}getLatestSchemaVersion(){return this.schemaVersions.length>0?this.schemaVersions[this.schemaVersions.length-1]:void 0}getQueryHistory(e){return e?this.queryHistory.slice(-e):[...this.queryHistory]}getActiveSubscriptions(){return Array.from(this.activeSubscriptions.values())}resetMetrics(){this.graphQLMetrics={queriesPerSecond:0,mutationsPerSecond:0,subscriptionsActive:this.activeSubscriptions.size,averageResponseTime:0,totalQueries:0,totalMutations:0,totalErrors:0,errorRate:0,cacheHitRate:0,averageComplexity:0,averageDepth:0},this.queryHistory=[],this.latencyHistory=[],this.complexityHistory=[],this.depthHistory=[],this.queriesThisSecond=0,this.mutationsThisSecond=0,this.lastSecondStart=Date.now(),this.rateLimitMetrics={totalBlockedRequests:0,blockedRequestsPerSecond:0,totalRateLimitHits:0,rateLimitHitsPerSecond:0,blockedByType:{queries:0,mutations:0,subscriptions:0}},this.blockedRequestsThisSecond=0,this.rateLimitHitsThisSecond=0,this.lastRateLimitSecondStart=Date.now(),this.timeoutMetrics={totalTimeouts:0,timeoutsPerSecond:0,queryTimeouts:0,mutationTimeouts:0,resolverTimeouts:0},this.timeoutsThisSecond=0,this.lastTimeoutSecondStart=Date.now(),this.timeoutDurations=[],this.connectionPoolMetrics={totalConnections:0,activeConnections:0,idleConnections:0,maxConnections:0,connectionUtilization:0,totalConnectionAttempts:0,failedConnectionAttempts:0,connectionFailureRate:0,averageConnectionWaitTime:0},this.connectionWaitTimes=[],this.connectionHealthMetrics={healthyConnections:0,unhealthyConnections:0,totalHealthChecks:0,failedHealthChecks:0,healthCheckFailureRate:0,totalReconnects:0,successfulReconnects:0,failedReconnects:0,reconnectSuccessRate:0},this.loadBalancingMetrics={totalRequests:0,averageLoadDistribution:0};for(const e of this.connectionPools.values())e.connections=[],e.currentSize=0,e.waitingQueue=[],e.totalRequests=0,e.failedRequests=0;for(const e of this.loadBalancingState.values())e.currentIndex=0,e.instanceConnections.clear(),e.totalRequests=0,e.requestsByInstance.clear();this.dataLoaderMetrics={totalBatches:0,totalRequests:0,totalBatchedRequests:0,averageBatchSize:0,deduplicationRate:0,cacheHitRate:0,averageLatencyReduction:0},this.nPlusOneProblems=[];for(const e of this.dataLoaders.values())e.clearCache();this.subscriptionMetrics={totalEvents:0,eventsPerSecond:0,averageDeliveryLatency:0,totalDeliveryErrors:0,deliveryErrorRate:0,lastEventTime:0},this.deliveryLatencyHistory=[],this.eventsThisSecond=0,this.lastEventSecondStart=Date.now(),this.subscriptionEvents=[],this.batchQueryMetrics={totalBatches:0,totalBatchRequests:0,averageBatchSize:0,averageBatchLatency:0,totalBatchErrors:0,batchErrorRate:0},this.batchLatencyHistory=[],this.persistedQueriesUsage=0,this.introspectionMetrics={totalIntrospectionQueries:0,introspectionQueriesPerSecond:0},this.introspectionQueriesThisSecond=0,this.lastIntrospectionSecondStart=Date.now(),this.fieldMetrics.clear(),this.typeMetrics.clear(),this.operationMetrics.clear(),this.errorMetrics.clear(),this.errorHistory=[],this.fieldCallsThisSecond.clear(),this.typeOpsThisSecond.clear(),this.operationCallsThisSecond.clear(),this.errorCountsThisSecond.clear(),this.lastMetricsSecondStart=Date.now()}getFieldMetrics(){return Array.from(this.fieldMetrics.values())}getFieldMetricsByName(e,t){const s=`${t}:${e}`;return this.fieldMetrics.get(s)}getTypeMetrics(){return Array.from(this.typeMetrics.values())}getTypeMetricsByName(e){return this.typeMetrics.get(e)}getOperationMetrics(){return Array.from(this.operationMetrics.values())}getOperationMetricsByName(e){return this.operationMetrics.get(e)}getErrorMetrics(){return Array.from(this.errorMetrics.values())}getErrorMetricsByCategory(e){return this.errorMetrics.get(e)}getErrorHistory(e){return e?this.errorHistory.slice(-e):[...this.errorHistory]}}class Mk{config=null;soapMetrics={requestsPerSecond:0,averageResponseTime:0,totalRequests:0,totalErrors:0,errorRate:0,successRate:0,averageLatency:0};requestHistory=[];MAX_HISTORY_SIZE=1e3;requestCache=new Map;latencyHistory=[];MAX_LATENCY_HISTORY=500;lastSecondStart=Date.now();requestsThisSecond=0;operationMetrics=new Map;serviceMetrics=new Map;componentId=null;sendMessageToTarget;activeRequests=new Map;traceContexts=new Map;traceIdCounter=0;spanIdCounter=0;errorMetrics=new Map;MAX_ERROR_HISTORY=100;errorHistory=[];MAX_TOTAL_ERROR_HISTORY=500;operationCallsThisSecond=new Map;serviceRequestsThisSecond=new Map;errorCountsThisSecond=new Map;lastMetricsSecondStart=Date.now();rateLimitCounters=new Map;rateLimitMetrics={totalBlockedRequests:0,blockedRequestsPerSecond:0,totalRateLimitHits:0,rateLimitHitsPerSecond:0};blockedRequestsThisSecond=0;rateLimitHitsThisSecond=0;lastRateLimitSecondStart=Date.now();timeoutMetrics={totalTimeouts:0,timeoutsPerSecond:0};timeoutsThisSecond=0;lastTimeoutSecondStart=Date.now();timeoutDurations=[];MAX_TIMEOUT_HISTORY=100;wsSecurityMetrics={totalValidations:0,successfulValidations:0,failedValidations:0,validationSuccessRate:0,signaturesProcessed:0,encryptionsProcessed:0};wsAddressingMetrics={totalMessages:0,messagesWithAddressing:0,asyncResponses:0,addressingUsageRate:0};mtomMetrics={totalMessages:0,messagesWithMTOM:0,totalAttachments:0,averageAttachmentsPerMessage:0,mtomUsageRate:0};requestSizeMetrics={totalRequests:0,averageRequestSize:0,minRequestSize:1/0,maxRequestSize:0,totalBytesReceived:0,totalBytesSent:0,averageResponseSize:0,sizeDistribution:[]};throughputHistory=[];MAX_THROUGHPUT_HISTORY=60;previousRPS=0;peakRPS=0;peakRPSTime=0;PERCENTILE_P50=50;PERCENTILE_P95=95;PERCENTILE_P99=99;initializeConfig(e){this.componentId=e.id;const t=e.data.config||{};if(this.config={endpoint:t.endpoint||"/soap",wsdlUrl:t.wsdlUrl||"",services:t.services||[],requests:t.requests||[],totalRequests:t.totalRequests||0,successRate:t.successRate||100,averageLatency:t.averageLatency||50,enableWSSecurity:t.enableWSSecurity??!1,enableWSAddressing:t.enableWSAddressing??!1,enableMTOM:t.enableMTOM??!1,enableValidation:t.enableValidation??!0,soapVersion:t.soapVersion||"1.1",requestsPerSecond:t.requestsPerSecond||100,responseLatency:t.responseLatency||50,enableCaching:t.enableCaching??!1,cacheTTL:t.cacheTTL??300,rateLimit:t.rateLimit||{enabled:!1,requestsPerSecond:1e3,windowMs:1e3,identifyBy:"ip"},timeout:t.timeout||{enabled:!1,requestTimeout:3e4,defaultTimeout:3e4},maxRequestSize:t.maxRequestSize||10*1024*1024,wsdl:t.wsdl},this.config.services)for(const s of this.config.services){this.initializeServiceMetrics(s.name);for(const n of s.operations)this.initializeOperationMetrics(s.name,n.name)}}updateConfig(e){if(this.config&&(this.config={...this.config,...e},e.services))for(const t of e.services){this.serviceMetrics.has(t.name)||this.initializeServiceMetrics(t.name);for(const s of t.operations){const n=`${t.name}:${s.name}`;this.operationMetrics.has(n)||this.initializeOperationMetrics(t.name,s.name)}}}initializeServiceMetrics(e){this.serviceMetrics.has(e)||this.serviceMetrics.set(e,{serviceName:e,totalRequests:0,totalErrors:0,averageLatency:0,errorRate:0,requestsPerSecond:0,operationsCount:0})}initializeOperationMetrics(e,t){const s=`${e}:${t}`;this.operationMetrics.has(s)||this.operationMetrics.set(s,{operationName:t,serviceName:e,totalCalls:0,totalErrors:0,averageLatency:0,totalLatency:0,minLatency:1/0,maxLatency:0,errorRate:0,callsPerSecond:0})}setSendMessageFunction(e){this.sendMessageToTarget=e}processRequest(e,t,s,n){const i=Date.now(),a=this.createRequestSpan(e.operation||"unknown",i,n);if(!this.config)return this.createErrorResponse("SOAP service not configured",500,i);const o=e.envelope?Buffer.byteLength(e.envelope,"utf8"):0;if(this.config.maxRequestSize&&o>this.config.maxRequestSize)return this.recordError("validation",`Request size ${o} bytes exceeds maximum ${this.config.maxRequestSize} bytes`,e.operation,e.service),this.createFaultResponse("Client",`Request too large: ${o} bytes exceeds maximum ${this.config.maxRequestSize} bytes`,Date.now()-i);if(this.config.rateLimit?.enabled){const E=this.getClientIdentifier(e.clientIP,e.headers);if(!this.checkRateLimit(E))return this.recordError("rate_limit","Rate limit exceeded",e.operation,e.service),this.createErrorResponse("Rate limit exceeded",429,i)}const l=this.parseSOAPEnvelope(e.envelope);if(!l.success)return this.recordError("validation",l.error||"Invalid SOAP envelope",e.operation,e.service),this.createFaultResponse("Client",l.error||"Invalid SOAP envelope",i);const d=e.operation||l.operation||"unknown",h=e.service||l.service||"default";if(this.config.enableWSSecurity&&l.headers){this.wsSecurityMetrics.totalValidations++;const E=this.validateWSSecurity(l.headers,e.envelope);if(!E.valid)return this.wsSecurityMetrics.failedValidations++,this.recordError("security",E.error||"WS-Security validation failed",d,h),this.createFaultResponse("Client",E.error||"WS-Security validation failed",i);this.wsSecurityMetrics.successfulValidations++,l.headers.Security?.includes("Signature")&&this.wsSecurityMetrics.signaturesProcessed++,l.headers.Security?.includes("EncryptedData")&&this.wsSecurityMetrics.encryptionsProcessed++,this.wsSecurityMetrics.validationSuccessRate=this.wsSecurityMetrics.totalValidations>0?this.wsSecurityMetrics.successfulValidations/this.wsSecurityMetrics.totalValidations*100:0}if(this.config.enableWSAddressing&&l.headers){this.wsAddressingMetrics.totalMessages++,l.headers.MessageID&&this.wsAddressingMetrics.messagesWithAddressing++;const E=this.processWSAddressing(l.headers);E.success||this.recordError("validation",E.error||"WS-Addressing processing failed",d,h),E.replyTo&&this.wsAddressingMetrics.asyncResponses++,this.wsAddressingMetrics.addressingUsageRate=this.wsAddressingMetrics.totalMessages>0?this.wsAddressingMetrics.messagesWithAddressing/this.wsAddressingMetrics.totalMessages*100:0}if(this.config.enableMTOM&&l.body){this.mtomMetrics.totalMessages++;const E=this.processMTOM(l.body);E.processed&&(this.mtomMetrics.messagesWithMTOM++,E.attachments&&(this.mtomMetrics.totalAttachments+=E.attachments.length),l.body=E.body||l.body,this.mtomMetrics.averageAttachmentsPerMessage=this.mtomMetrics.messagesWithMTOM>0?this.mtomMetrics.totalAttachments/this.mtomMetrics.messagesWithMTOM:0,this.mtomMetrics.mtomUsageRate=this.mtomMetrics.totalMessages>0?this.mtomMetrics.messagesWithMTOM/this.mtomMetrics.totalMessages*100:0)}if(this.config.enableValidation&&this.config.wsdl){const E=this.validateRequest(l,d,h);if(!E.valid)return this.recordError("validation",E.error||"Validation failed",d,h),this.createFaultResponse("Client",E.error||"Validation failed",i)}if(this.config.enableCaching){const E=this.generateCacheKey(e.envelope,d),A=this.requestCache.get(E);if(A&&Date.now()-A.timestamp<(this.config.cacheTTL||300)*1e3){const k=Date.now()-i,D=e.envelope?Buffer.byteLength(e.envelope,"utf8"):void 0,L=A.response.envelope?Buffer.byteLength(A.response.envelope,"utf8"):void 0;return this.recordRequest(d,h,k,!0,D,L),{...A.response,latency:k}}}const p=this.config.timeout?.enabled?this.config.timeout.requestTimeout||this.config.timeout.defaultTimeout||3e4:void 0,g=Date.now(),v=this.executeOperation(d,h,l.body||"",t,s,a,n),b=Date.now()-g;if(p&&b>p)return this.timeoutMetrics.totalTimeouts++,this.timeoutsThisSecond++,this.recordError("timeout",`Operation ${d} exceeded timeout of ${p}ms (took ${b}ms)`,d,h),this.createFaultResponse("Server",`Operation timed out: exceeded ${p}ms (took ${b}ms)`,Date.now()-i);const M=Date.now()-i;let x;if(v.success){if(x=this.createSuccessResponse(d,v.data||{},this.config.soapVersion||"1.1",M,l.headers),this.config.enableCaching){const E=this.generateCacheKey(e.envelope,d);this.requestCache.set(E,{response:x,timestamp:Date.now()})}}else x=this.createFaultResponse("Server",v.error||"Operation failed",M),this.recordError("fault",v.error||"Operation failed",d,h);const S=e.envelope?Buffer.byteLength(e.envelope,"utf8"):void 0,T=x.envelope?Buffer.byteLength(x.envelope,"utf8"):void 0;return this.recordRequest(d,h,M,v.success,S,T),this.finishRequestSpan(a,i,Date.now(),v.success,v.error,n),x}parseSOAPEnvelope(e){try{if(!e||typeof e!="string")return{success:!1,error:"Envelope is empty or invalid"};if(!e.includes("<")||!e.includes(">"))return{success:!1,error:"Invalid XML format"};if(!/<[^:>]*:?Envelope[^>]*>/i.test(e))return{success:!1,error:"SOAP Envelope element not found"};const s=e.includes("http://schemas.xmlsoap.org/soap/envelope/")?"1.1":e.includes("http://www.w3.org/2003/05/soap-envelope")?"1.2":"1.1",n=e.match(/<soap:?Header[^>]*>(.*?)<\/soap:?Header>/is),i=n?n[1]:void 0,a={};if(i){const M=i.match(/<wsa:MessageID[^>]*>(.*?)<\/wsa:MessageID>/is);M&&(a.MessageID=M[1].trim());const x=i.match(/<wsa:To[^>]*>(.*?)<\/wsa:To>/is);x&&(a.To=x[1].trim());const S=i.match(/<wsa:From[^>]*>(.*?)<\/wsa:From>/is);S&&(a.From=S[1].trim());const T=i.match(/<wsa:ReplyTo[^>]*>(.*?)<\/wsa:ReplyTo>/is);T&&(a.ReplyTo=T[1].trim());const E=i.match(/<wsa:Action[^>]*>(.*?)<\/wsa:Action>/is);E&&(a.Action=E[1].trim());const A=i.match(/<wsse:Security[^>]*>(.*?)<\/wsse:Security>/is);A&&(a.Security=A[1].trim())}const o=e.match(/<[^:>]*:?Body[^>]*>(.*?)<\/[^:>]*:?Body>/is);if(!o)return{success:!1,error:"SOAP Body not found"};const l=o[1];if(!l.trim())return{success:!1,error:"SOAP Body is empty"};const d=l.match(/<([^:>\/\s]+:)?([^:>\/\s]+?)(?:Request|Input|Response|Output)?[^>]*>/i),h=d?d[2]:void 0;if(!h){const M=l.match(/<([^:>\/\s]+:)?([^:>\/\s]+)[^>]*>/i);if(M){const S=M[2].replace(/(Request|Response|Input|Output)$/i,"");if(S)return{success:!0,operation:S,service:b,body:l,header:i,soapVersion:s,headers:a,bodyElements:[]}}}const p=[],g=/<([^:>]+:)?([^:>]+)[^>]*>(.*?)<\/\1?\2>/gis;let v;for(;(v=g.exec(l))!==null;){const M=v[2],x=v[3].trim();M&&x&&p.push({name:M,value:x})}let b;if(a.Action){const M=a.Action.split("/");M.length>1&&(b=M[M.length-2])}return{success:!0,operation:h,service:b,body:l,header:i,soapVersion:s,headers:a,bodyElements:p}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to parse SOAP envelope"}}}validateRequest(e,t,s){if(!this.config?.wsdl)return{valid:!0};const n=this.config.wsdl.services?.find(a=>a.name===s);if(!n)return{valid:!1,error:`Service ${s} not found in WSDL`};const i=n.operations.find(a=>a.name===t);if(!i)return{valid:!1,error:`Operation ${t} not found in service ${s}`};if(e.soapVersion&&this.config.soapVersion&&e.soapVersion!==this.config.soapVersion)return{valid:!1,error:`SOAP version mismatch: expected ${this.config.soapVersion}, got ${e.soapVersion}`};if(e.body){if(![new RegExp(`<[^:>]*:?${t}[^>]*>`,"i"),new RegExp(`<[^:>]*:?${t}Request[^>]*>`,"i"),new RegExp(`<[^:>]*:?${t}Input[^>]*>`,"i")].some(h=>h.test(e.body||"")))return{valid:!1,error:`Operation ${t} not found in SOAP Body`};const l=(e.body.match(/<[^\/][^>]*>/g)||[]).length,d=(e.body.match(/<\/[^>]+>/g)||[]).length;if(l!==d)return{valid:!1,error:`XML structure invalid: unbalanced tags (${l} open, ${d} close)`}}if(i.inputMessage&&this.config.wsdl.messages){const a=this.config.wsdl.messages.find(o=>o.name===i.inputMessage);if(a&&e.body)for(const o of a.parts)o.name&&e.body.includes(o.name)}return{valid:!0}}parseWSDL(e){try{const t={services:[],types:[],messages:[],portTypes:[],bindings:[]},s=e.match(/targetNamespace=["']([^"']+)["']/);s&&(t.targetNamespace=s[1]);const n=e.match(/<wsdl:types[^>]*>(.*?)<\/wsdl:types>/is),i=/<wsdl:message[^>]*name=["']([^"']+)["'][^>]*>(.*?)<\/wsdl:message>/gis;let a;for(;(a=i.exec(e))!==null;){const v=a[1],b=a[2],M=[],x=/<wsdl:part[^>]*name=["']([^"']+)["'][^>]*(?:type=["']([^"']+)["']|element=["']([^"']+)["'])/gi;let S;for(;(S=x.exec(b))!==null;)M.push({name:S[1],type:S[2]||S[3]||"string"});t.messages?.push({name:v,parts:M})}const o=/<wsdl:portType[^>]*name=["']([^"']+)["'][^>]*>(.*?)<\/wsdl:portType>/gis;let l;for(;(l=o.exec(e))!==null;){const v=l[1],b=l[2],M=[],x=/<wsdl:operation[^>]*name=["']([^"']+)["'][^>]*>(.*?)<\/wsdl:operation>/gis;let S;for(;(S=x.exec(b))!==null;){const T=S[1],E=S[2],A=E.match(/<wsdl:input[^>]*(?:message=["']([^"']+)["']|name=["']([^"']+)["'])/i),k=E.match(/<wsdl:output[^>]*(?:message=["']([^"']+)["']|name=["']([^"']+)["'])/i),D=E.matchAll(/<wsdl:fault[^>]*(?:message=["']([^"']+)["']|name=["']([^"']+)["'])/gi),L=[];for(const I of D)L.push(I[1]||I[2]||"");M.push({name:T,input:A?.[1]||A?.[2],output:k?.[1]||k?.[2],faults:L.length>0?L:void 0})}t.portTypes?.push({name:v,operations:M})}const d=/<wsdl:binding[^>]*name=["']([^"']+)["'][^>]*(?:type=["']([^"']+)["'])/gi;let h;for(;(h=d.exec(e))!==null;){const v=h[1],b=h[2],M=e.match(new RegExp(`<wsdl:binding[^>]*name=["']${v}["'][^>]*>.*?<soap:binding[^>]*style=["']([^"']+)["']`,"is")),x=e.match(new RegExp(`<wsdl:binding[^>]*name=["']${v}["'][^>]*>.*?<soap:binding[^>]*transport=["']([^"']+)["']`,"is"));t.bindings?.push({name:v,type:b,style:M?.[1],transport:x?.[1]})}const p=/<wsdl:service[^>]*name=["']([^"']+)["'][^>]*>(.*?)<\/wsdl:service>/gis;let g;for(;(g=p.exec(e))!==null;){const v=g[1],b=g[2],x=/<wsdl:port[^>]*name=["']([^"']+)["'][^>]*>.*?<soap:address[^>]*location=["']([^"']+)["']/gis.exec(b),S=x?.[1]||"default",T=x?.[2]||"",E=[];t.services?.push({name:v,port:S,operations:E,endpoint:T})}return t}catch(t){return console.error("Failed to parse WSDL:",t),null}}generateWSDL(){if(!this.config||!this.config.services||this.config.services.length===0)return"";const t=(this.config.soapVersion||"1.1")==="1.1"?"http://schemas.xmlsoap.org/wsdl/soap/":"http://schemas.xmlsoap.org/wsdl/soap12/",s=this.config.wsdl?.targetNamespace||"http://tempuri.org/",n=this.config.endpoint||"/soap";let i=`<?xml version="1.0" encoding="UTF-8"?>
<wsdl:definitions xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
                  xmlns:soap="${t}"
                  xmlns:tns="${s}"
                  targetNamespace="${s}">
  
  <wsdl:types>
    <xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" targetNamespace="${s}">
`;for(const a of this.config.services)for(const o of a.operations)i+=`      <xs:element name="${o.name}Request">
        <xs:complexType>
          <xs:sequence>
            <xs:element name="input" type="xs:string"/>
          </xs:sequence>
        </xs:complexType>
      </xs:element>
      <xs:element name="${o.name}Response">
        <xs:complexType>
          <xs:sequence>
            <xs:element name="output" type="xs:string"/>
          </xs:sequence>
        </xs:complexType>
      </xs:element>
`;i+=`    </xs:schema>
  </wsdl:types>
`;for(const a of this.config.services)for(const o of a.operations)i+=`  <wsdl:message name="${o.name}Request">
    <wsdl:part name="parameters" element="tns:${o.name}Request"/>
  </wsdl:message>
  <wsdl:message name="${o.name}Response">
    <wsdl:part name="parameters" element="tns:${o.name}Response"/>
  </wsdl:message>
`;for(const a of this.config.services){i+=`  <wsdl:portType name="${a.name}PortType">
`;for(const o of a.operations){if(i+=`    <wsdl:operation name="${o.name}">
      <wsdl:input message="tns:${o.name}Request"/>
      <wsdl:output message="tns:${o.name}Response"/>
`,o.faults&&o.faults.length>0)for(const l of o.faults)i+=`      <wsdl:fault name="${l}" message="tns:${l}"/>
`;i+=`    </wsdl:operation>
`}i+=`  </wsdl:portType>
`}for(const a of this.config.services){i+=`  <wsdl:binding name="${a.name}Binding" type="tns:${a.name}PortType">
    <soap:binding style="document" transport="http://schemas.xmlsoap.org/soap/http"/>
`;for(const o of a.operations)i+=`    <wsdl:operation name="${o.name}">
      <soap:operation soapAction="${s}${o.name}"/>
      <wsdl:input>
        <soap:body use="literal"/>
      </wsdl:input>
      <wsdl:output>
        <soap:body use="literal"/>
      </wsdl:output>
    </wsdl:operation>
`;i+=`  </wsdl:binding>
`}for(const a of this.config.services)i+=`  <wsdl:service name="${a.name}">
    <wsdl:port name="${a.port||"default"}" binding="tns:${a.name}Binding">
      <soap:address location="${n}"/>
    </wsdl:port>
  </wsdl:service>
`;return i+="</wsdl:definitions>",i}async loadWSDL(e){try{const t=this.parseWSDL(e);return t&&this.config&&(this.config.wsdl=t,t.services&&(this.config.services=t.services.map(s=>({name:s.name,port:s.port,operations:s.operations,wsdlUrl:this.config?.wsdlUrl,endpoint:s.endpoint})))),t}catch(t){return console.error("Failed to load WSDL:",t),null}}validateWSSecurity(e,t){return e.Security?e.Security.includes("Signature")||t.includes("<ds:Signature")||t.includes("<wsse:Signature")?(e.Security.includes("EncryptedData")||t.includes("<xenc:EncryptedData"),Math.random()>.05?{valid:!0}:{valid:!1,error:"WS-Security signature validation failed"}):{valid:!1,error:"WS-Security signature not found"}:{valid:!1,error:"WS-Security header not found"}}processWSAddressing(e){const t=e.MessageID,s=e.ReplyTo,n=e.To;e.From;const i=e.Action;return t?n?i?!t.startsWith("urn:uuid:")&&!t.startsWith("http://")?{success:!1,error:"WS-Addressing MessageID must be a valid URI"}:{success:!0,messageId:t,replyTo:s}:{success:!1,error:"WS-Addressing Action is required"}:{success:!1,error:"WS-Addressing To is required"}:{success:!1,error:"WS-Addressing MessageID is required"}}processMTOM(e){if(!(e.includes("xop:Include")||e.includes('href="cid:')||e.includes("Content-ID:")))return{processed:!1};const s=[],n=/<xop:Include[^>]*href=["']cid:([^"']+)["'][^>]*\/>/gi;let i;for(;(i=n.exec(e))!==null;){const o=i[1];s.push({id:o,content:`[Binary data for ${o}]`})}let a=e;for(const o of s)a=a.replace(new RegExp(`<xop:Include[^>]*href=["']cid:${o.id}["'][^>]*/>`,"gi"),`[Optimized binary data: ${o.id}]`);return{processed:!0,body:a,attachments:s}}executeOperation(e,t,s,n,i,a,o){if(!this.config)return{success:!1,error:"SOAP service not configured"};const l=this.config.services?.find(h=>h.name===t);if(!l)return{success:!1,error:`Service ${t} not found`};const d=l.operations.find(h=>h.name===e);return!d||!d.enabled?{success:!1,error:`Operation ${e} not found or disabled`}:d.targetService&&n&&i?this.simulateTargetServiceCall(d,s,n,i,a,o):(d.latency||this.config.responseLatency,{success:!0,data:this.generateMockResponseData(e)})}simulateTargetServiceCall(e,t,s,n,i,a){if(!e.targetService)return{success:!1,error:"No target service specified"};const o=s.find(d=>d.id===e.targetService);if(!o)return{success:!1,error:`Target service ${e.targetService} not found`};const l=n.find(d=>d.source===this.componentId&&d.target===e.targetService);if(!l)return e.latency,{success:!0,data:this.generateMockResponseData(e.name)};if(this.sendMessageToTarget&&this.componentId)try{const d={id:`soap-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),source:this.componentId,target:e.targetService,connectionId:l.id,format:"xml",payload:{envelope:t,operation:e.name,soapVersion:this.config?.soapVersion||"1.1"},size:Buffer.byteLength(t,"utf8"),metadata:{contentType:"application/soap+xml",traceContext:i},status:"pending"},h=Date.now(),p=e.latency||this.getTargetComponentLatency(o),g=this.simulateTargetResponse(o,t,e.name),v=p;return{success:!0,data:g}}catch(d){return{success:!1,error:d instanceof Error?d.message:"Failed to call target service"}}return e.latency,{success:!0,data:this.generateMockResponseData(e.name)}}getTargetComponentLatency(e){return{postgresql:10,mysql:15,mongodb:20,redis:5,rest:50,graphql:60,grpc:30}[e.type]||50}simulateTargetResponse(e,t,s){switch(e.type){case"postgresql":case"mysql":return{rows:[{id:1,name:"Result 1",value:100},{id:2,name:"Result 2",value:200}],count:2};case"mongodb":return{documents:[{_id:"1",data:"Result 1"},{_id:"2",data:"Result 2"}]};case"rest":case"graphql":return{data:{result:`Response from ${e.type} for ${s}`,timestamp:Date.now()}};default:return this.generateMockResponseData(s)}}generateMockResponseData(e){return{result:`Response from ${e}`,timestamp:Date.now()}}createSuccessResponse(e,t,s,n,i){const a=s==="1.1"?"http://schemas.xmlsoap.org/soap/envelope/":"http://www.w3.org/2003/05/soap-envelope";let o="";if(this.config?.enableWSAddressing&&i){const d=`urn:uuid:${Date.now()}-${Math.random().toString(36).substr(2,9)}`,h=i.MessageID||"";o=`  <soap:Header>
    <wsa:MessageID xmlns:wsa="http://www.w3.org/2005/08/addressing">${d}</wsa:MessageID>
    <wsa:RelatesTo xmlns:wsa="http://www.w3.org/2005/08/addressing">${h}</wsa:RelatesTo>
    <wsa:To xmlns:wsa="http://www.w3.org/2005/08/addressing">${i.ReplyTo||i.From||"http://www.w3.org/2005/08/addressing/anonymous"}</wsa:To>
    <wsa:Action xmlns:wsa="http://www.w3.org/2005/08/addressing">${i.Action?.replace("Request","Response")||`${this.config.wsdl?.targetNamespace||"http://tempuri.org/"}${e}Response`}</wsa:Action>
  </soap:Header>
`}return{envelope:`<?xml version="1.0" encoding="UTF-8"?>
<soap:Envelope xmlns:soap="${a}">
${o}  <soap:Body>
    <${e}Response>
      ${this.serializeDataToXML(t)}
    </${e}Response>
  </soap:Body>
</soap:Envelope>`,status:200,latency:n,success:!0}}createFaultResponse(e,t,s,n="1.1"){const i=n==="1.1"?"http://schemas.xmlsoap.org/soap/envelope/":"http://www.w3.org/2003/05/soap-envelope",a={code:e,string:t};return{envelope:`<?xml version="1.0" encoding="UTF-8"?>
<soap:Envelope xmlns:soap="${i}">
  <soap:Body>
    <soap:Fault>
      <faultcode>soap:${e}</faultcode>
      <faultstring>${t}</faultstring>
    </soap:Fault>
  </soap:Body>
</soap:Envelope>`,status:500,latency:s,success:!1,fault:a}}createErrorResponse(e,t,s){return{envelope:"",status:t,latency:Date.now()-s,success:!1,error:e}}serializeDataToXML(e){return typeof e=="string"?e:typeof e=="object"&&e!==null?Object.entries(e).map(([t,s])=>`<${t}>${this.serializeDataToXML(s)}</${t}>`).join(""):String(e)}generateCacheKey(e,t){return`${t}:${e.substring(0,100)}`}recordRequest(e,t,s,n){const i=Date.now();this.soapMetrics.totalRequests++,n||this.soapMetrics.totalErrors++,this.latencyHistory.push(s),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift();const a=this.latencyHistory.reduce((p,g)=>p+g,0);if(this.soapMetrics.averageLatency=a/this.latencyHistory.length,this.soapMetrics.averageResponseTime=this.soapMetrics.averageLatency,this.soapMetrics.errorRate=this.soapMetrics.totalRequests>0?this.soapMetrics.totalErrors/this.soapMetrics.totalRequests*100:0,this.soapMetrics.successRate=100-this.soapMetrics.errorRate,i-this.lastSecondStart>=1e3){this.previousRPS=this.soapMetrics.requestsPerSecond,this.soapMetrics.requestsPerSecond=this.requestsThisSecond,this.throughputHistory.push(this.requestsThisSecond),this.throughputHistory.length>this.MAX_THROUGHPUT_HISTORY&&this.throughputHistory.shift(),this.requestsThisSecond>this.peakRPS&&(this.peakRPS=this.requestsThisSecond,this.peakRPSTime=i);const p=this.previousRPS>0?(this.requestsThisSecond-this.previousRPS)/this.previousRPS*100:0,g=p>5?"increasing":p<-5?"decreasing":"stable";this.soapMetrics.throughputTrends={current:this.requestsThisSecond,previous:this.previousRPS,trend:g,changePercent:p,peak:this.peakRPS,peakTime:this.peakRPSTime},this.requestsThisSecond=0,this.lastSecondStart=i}else this.requestsThisSecond++;const o=`${t}:${e}`,l=this.operationMetrics.get(o);if(l){l.totalCalls++,n||l.totalErrors++,l.totalLatency+=s,l.averageLatency=l.totalLatency/l.totalCalls,l.minLatency=Math.min(l.minLatency,s),l.maxLatency=Math.max(l.maxLatency,s),l.lastCallTime=i,l.errorRate=l.totalCalls>0?l.totalErrors/l.totalCalls*100:0;const p=this.operationCallsThisSecond.get(o)||0;this.operationCallsThisSecond.set(o,p+1)}const d=this.serviceMetrics.get(t);if(d){d.totalRequests++,n||d.totalErrors++,d.averageLatency=(d.averageLatency*(d.totalRequests-1)+s)/d.totalRequests,d.errorRate=d.totalRequests>0?d.totalErrors/d.totalRequests*100:0;const p=this.serviceRequestsThisSecond.get(t)||0;this.serviceRequestsThisSecond.set(t,p+1)}const h={id:`req-${Date.now()}-${Math.random()}`,operation:e,service:t,envelope:"",timestamp:i,duration:s,success:n};this.requestHistory.push(h),this.requestHistory.length>this.MAX_HISTORY_SIZE&&this.requestHistory.shift()}recordError(e,t,s,n){const i=Date.now();let a=this.errorMetrics.get(e);a||(a={category:e,totalErrors:0,errorsPerSecond:0},this.errorMetrics.set(e,a)),a.totalErrors++,a.lastErrorTime=i;const o=this.errorCountsThisSecond.get(e)||0;this.errorCountsThisSecond.set(e,o+1),this.errorHistory.push({timestamp:i,category:e,message:t,operationName:s,serviceName:n}),this.errorHistory.length>this.MAX_TOTAL_ERROR_HISTORY&&this.errorHistory.shift()}checkRateLimit(e){if(!this.config?.rateLimit?.enabled)return!0;const t=e,s=Date.now(),n=this.config.rateLimit.windowMs||1e3,i=this.config.rateLimit.requestsPerSecond||1e3;let a=this.rateLimitCounters.get(t);return(!a||s>=a.resetAt)&&(a={count:0,resetAt:s+n,windowStart:s},this.rateLimitCounters.set(t,a)),a.count>=i?(this.rateLimitMetrics.totalBlockedRequests++,this.rateLimitHitsThisSecond++,!1):(a.count++,!0)}getClientIdentifier(e,t){const s=this.config?.rateLimit?.identifyBy||"ip";return s==="ip"&&e?`ip:${e}`:s==="apiKey"&&t?.["X-API-Key"]?`apikey:${t["X-API-Key"]}`:s==="user"&&t?.["X-User-Id"]?`user:${t["X-User-Id"]}`:"default"}createRequestSpan(e,t,s){if(!s||s().size===0)return;const i=this.generateTraceId(),a=this.generateSpanId(),o={traceId:i,spanId:a,parentSpanId:void 0};return this.traceContexts.set(i,o),o}finishRequestSpan(e,t,s,n,i,a){if(!e||!a)return;const o=a();if(o.size===0)return;const l=(s-t)*1e3,d=t*1e3,h={traceId:e.traceId,spanId:e.spanId,parentSpanId:e.parentSpanId,operationName:"soap.request",serviceName:this.componentId||"soap",startTime:d,duration:l,tags:[{key:"component.type",value:"soap"},{key:"soap.operation",value:"unknown"},{key:"status",value:n?"success":"error"}],logs:[]};i&&(h.tags.push({key:"error",value:!0}),h.logs.push({timestamp:d+l,fields:[{key:"event",value:"error"},{key:"error.message",value:i}]}));for(const p of o.values())p&&typeof p.addSpan=="function"&&p.addSpan(h)}generateTraceId(){return`trace-${++this.traceIdCounter}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSpanId(){return`span-${++this.spanIdCounter}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}calculatePercentile(e,t){if(e.length===0)return 0;if(e.length===1)return e[0];const s=t/100*(e.length-1),n=Math.floor(s),i=Math.ceil(s),a=s-n;return n===i?e[n]:e[n]*(1-a)+e[i]*a}updateRequestSizeDistribution(){const t=[{range:"0-1KB",min:0,max:1024},{range:"1-5KB",min:1024,max:5120},{range:"5-10KB",min:5120,max:10240},{range:"10-50KB",min:10240,max:51200},{range:"50-100KB",min:51200,max:102400},{range:"100KB+",min:102400,max:1/0}].map(s=>({range:s.range,count:0}));this.requestSizeMetrics.sizeDistribution=t}updateMetricsPerSecond(){const e=Date.now();if(!(e-this.lastMetricsSecondStart<1e3)){for(const[t,s]of this.operationCallsThisSecond.entries()){const n=this.operationMetrics.get(t);n&&(n.callsPerSecond=s)}this.operationCallsThisSecond.clear();for(const[t,s]of this.serviceRequestsThisSecond.entries()){const n=this.serviceMetrics.get(t);n&&(n.requestsPerSecond=s)}this.serviceRequestsThisSecond.clear();for(const[t,s]of this.errorCountsThisSecond.entries()){const n=this.errorMetrics.get(t);n&&(n.errorsPerSecond=s)}this.errorCountsThisSecond.clear(),e-this.lastRateLimitSecondStart>=1e3&&(this.rateLimitMetrics.blockedRequestsPerSecond=this.blockedRequestsThisSecond,this.rateLimitMetrics.rateLimitHitsPerSecond=this.rateLimitHitsThisSecond,this.blockedRequestsThisSecond=0,this.rateLimitHitsThisSecond=0,this.lastRateLimitSecondStart=e),e-this.lastTimeoutSecondStart>=1e3&&(this.timeoutMetrics.timeoutsPerSecond=this.timeoutsThisSecond,this.timeoutsThisSecond=0,this.lastTimeoutSecondStart=e),this.lastMetricsSecondStart=e}}getSOAPMetrics(){this.updateMetricsPerSecond(),this.updateRequestSizeDistribution();const e=[...this.latencyHistory].sort((i,a)=>i-a),t=e.length>0?this.calculatePercentile(e,this.PERCENTILE_P50):void 0,s=e.length>0?this.calculatePercentile(e,this.PERCENTILE_P95):void 0,n=e.length>0?this.calculatePercentile(e,this.PERCENTILE_P99):void 0;return{...this.soapMetrics,latencyP50:t,latencyP95:s,latencyP99:n,operationMetrics:Array.from(this.operationMetrics.values()),serviceMetrics:Array.from(this.serviceMetrics.values()),errorMetrics:Array.from(this.errorMetrics.values()),rateLimitMetrics:{...this.rateLimitMetrics},timeoutMetrics:{...this.timeoutMetrics},wsSecurityMetrics:{...this.wsSecurityMetrics},wsAddressingMetrics:{...this.wsAddressingMetrics},mtomMetrics:{...this.mtomMetrics},requestSizeMetrics:{...this.requestSizeMetrics},throughputTrends:this.soapMetrics.throughputTrends}}resetMetrics(){this.soapMetrics={requestsPerSecond:0,averageResponseTime:0,totalRequests:0,totalErrors:0,errorRate:0,successRate:0,averageLatency:0},this.requestHistory=[],this.latencyHistory=[],this.operationMetrics.clear(),this.serviceMetrics.clear(),this.errorMetrics.clear(),this.errorHistory=[],this.rateLimitMetrics={totalBlockedRequests:0,blockedRequestsPerSecond:0,totalRateLimitHits:0,rateLimitHitsPerSecond:0},this.timeoutMetrics={totalTimeouts:0,timeoutsPerSecond:0},this.wsSecurityMetrics={totalValidations:0,successfulValidations:0,failedValidations:0,validationSuccessRate:0,signaturesProcessed:0,encryptionsProcessed:0},this.wsAddressingMetrics={totalMessages:0,messagesWithAddressing:0,asyncResponses:0,addressingUsageRate:0},this.mtomMetrics={totalMessages:0,messagesWithMTOM:0,totalAttachments:0,averageAttachmentsPerMessage:0,mtomUsageRate:0},this.requestSizeMetrics={totalRequests:0,averageRequestSize:0,minRequestSize:1/0,maxRequestSize:0,totalBytesReceived:0,totalBytesSent:0,averageResponseSize:0,sizeDistribution:[]},this.throughputHistory=[],this.previousRPS=0,this.peakRPS=0,this.peakRPSTime=0,this.requestCache.clear()}getThroughputHistory(e=60){return this.throughputHistory.slice(-e)}getLatencyHistory(e=500){return this.latencyHistory.slice(-e)}getRequestHistory(e=100){return this.requestHistory.slice(-e)}getOperationMetrics(e,t){return this.operationMetrics.get(`${e}:${t}`)}getServiceMetrics(e){return this.serviceMetrics.get(e)}getErrorHistory(e=100){return this.errorHistory.slice(-e)}getWSDL(){return this.config?.wsdl}setWSDL(e){if(this.config&&(this.config.wsdl=e,e.services)){this.config.services=e.services.map(t=>({name:t.name,port:t.port,operations:t.operations,wsdlUrl:this.config?.wsdlUrl,endpoint:t.endpoint}));for(const t of e.services){this.initializeServiceMetrics(t.name);for(const s of t.operations)this.initializeOperationMetrics(t.name,s.name)}}}getWSDLXML(){return this.generateWSDL()}validateWSDL(e){const t=[];(!e.services||e.services.length===0)&&t.push("WSDL must contain at least one service");for(const s of e.services||[]){s.name||t.push("Service must have a name"),(!s.operations||s.operations.length===0)&&t.push(`Service ${s.name} must have at least one operation`);for(const n of s.operations)n.name||t.push(`Operation in service ${s.name} must have a name`)}return{valid:t.length===0,errors:t.length>0?t:void 0}}}class wk{config=null;wsMetrics={connectionsTotal:0,connectionsActive:0,connectionsPerSecond:0,messagesPerSecond:0,messagesTotal:0,messagesSent:0,messagesReceived:0,bytesSent:0,bytesReceived:0,averageLatency:0,errorRate:0,connectionErrorRate:0,pingPongSuccessRate:1,compressionRatio:.5,roomsCount:0,subscriptionsCount:0,averageConnectionsPerRoom:0,averageSubscriptionsPerConnection:0,utilization:0};connections=new Map;rooms=new Map;subscriptions=new Map;messageHistory=[];MAX_HISTORY_SIZE=1e3;latencyHistory=[];MAX_LATENCY_HISTORY=500;lastSecondStart=Date.now();connectionsThisSecond=0;messagesThisSecond=0;rateLimitWindowStart=Date.now();rateLimitConnectionsInWindow=0;rateLimitMessagesInWindow=0;connectionMetrics=new Map;roomMetrics=new Map;subscriptionMetrics=new Map;componentId=null;sendMessageToTarget;simulatedConnectionRate=0;simulatedMessageRate=0;lastSimulationTime=Date.now();pingPongHistory=[];MAX_PING_PONG_HISTORY=100;initialize(e,t){this.componentId=e.id,this.sendMessageToTarget=t;const s=e.data.config||{};if(this.config={endpoint:s.endpoint||"ws://localhost:8080/ws",protocol:s.protocol||"ws",enableCompression:s.enableCompression??!0,enablePingPong:s.enablePingPong??!0,pingInterval:s.pingInterval||30,maxConnections:s.maxConnections||1e3,maxMessageSize:s.maxMessageSize||1024,roomsEnabled:s.roomsEnabled??!0,subscriptionsEnabled:s.subscriptionsEnabled??!0,authentication:s.authentication||{enabled:!1,method:"none"},rateLimit:s.rateLimit||{enabled:!1,messagesPerSecond:1e3,connectionsPerSecond:100},...s},s.connections)for(const n of s.connections)n.status==="connected"&&this.connections.set(n.id,{...n});if(s.rooms)for(const n of s.rooms)this.rooms.set(n.id,{...n});if(s.subscriptions)for(const n of s.subscriptions)n.enabled&&this.subscriptions.set(n.id,{...n});s.messages&&(this.messageHistory=s.messages.slice(-this.MAX_HISTORY_SIZE))}updateMetrics(e,t){if(!this.config)return;const s=Date.now(),n=(s-this.lastSimulationTime)/1e3;if(!e){this.simulatedConnectionRate=Math.max(0,this.simulatedConnectionRate*.95),this.simulatedMessageRate=Math.max(0,this.simulatedMessageRate*.95),this.closeIdleConnections(),this.lastSimulationTime=s,this.calculateMetrics();return}if(n>0){const i=this.simulatedConnectionRate||5,a=Math.floor(i*n);for(let p=0;p<a;p++)this.connections.size<(this.config.maxConnections||1e3)&&this.simulateNewConnection();const o=Array.from(this.connections.values()).filter(p=>p.status==="connected"),d=(this.simulatedMessageRate||50)/Math.max(1,o.length),h=Math.floor(d*o.length*n);for(let p=0;p<h&&p<o.length*10;p++){const g=o[Math.floor(Math.random()*o.length)];g&&this.simulateMessage(g.id,"received")}}this.config.enablePingPong&&this.processPingPong(),this.updateConnectionMetrics(),this.updateRoomMetrics(),this.updateSubscriptionMetrics(),this.calculateMetrics(),this.lastSimulationTime=s}createConnection(e,t){if(!this.config||this.connections.size>=(this.config.maxConnections||1e3)||this.config.authentication?.enabled&&!this.authenticateConnection())return!1;const s=Date.now(),n={id:e,status:"connected",connectedAt:s,messagesSent:0,messagesReceived:0,bytesSent:0,bytesReceived:0,lastMessageAt:s,subscriptions:t?.subscriptions||[],authenticated:!0,authMethod:this.config.authentication?.method||"none",latency:10+Math.random()*20,clientIP:t?.clientIP,userAgent:t?.userAgent,roomId:t?.roomId};if(this.connections.set(e,n),this.wsMetrics.connectionsTotal++,this.connectionsThisSecond++,t?.roomId&&this.config.roomsEnabled){const i=this.rooms.get(t.roomId);i&&!i.connections.includes(e)&&i.connections.push(e)}if(t?.subscriptions&&this.config.subscriptionsEnabled)for(const i of t.subscriptions){const a=this.subscriptions.get(i);a&&a.enabled&&!a.connections.includes(e)&&a.connections.push(e)}return!0}closeConnection(e){const t=this.connections.get(e);if(t){if(t.status="disconnected",t.disconnectedAt=Date.now(),t.roomId){const s=this.rooms.get(t.roomId);s&&(s.connections=s.connections.filter(n=>n!==e))}for(const s of t.subscriptions){const n=this.subscriptions.get(s);n&&(n.connections=n.connections.filter(i=>i!==e))}}}simulateNewConnection(){if(!this.config)return;const e=Date.now();if(this.config.rateLimit?.enabled){e-this.rateLimitWindowStart>=1e3&&(this.rateLimitWindowStart=e,this.rateLimitConnectionsInWindow=0,this.rateLimitMessagesInWindow=0);const o=this.config.rateLimit.connectionsPerSecond||100;if(this.rateLimitConnectionsInWindow>=o){this.wsMetrics.connectionsTotal++,this.wsMetrics.connectionErrorRate=this.wsMetrics.connectionErrorRate*.9+.1*1;return}this.rateLimitConnectionsInWindow++}const t=`ws-conn-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let s=!0;if(this.config.authentication?.enabled&&(s=this.authenticateConnection()),!s){this.wsMetrics.connectionsTotal++,this.wsMetrics.connectionErrorRate=this.wsMetrics.connectionErrorRate*.9+.1*1;return}const n={id:t,status:"connected",connectedAt:e,messagesSent:0,messagesReceived:0,bytesSent:0,bytesReceived:0,lastMessageAt:e,subscriptions:[],authenticated:!0,authMethod:this.config.authentication?.method||"none",latency:10+Math.random()*20};if(this.connections.set(t,n),this.wsMetrics.connectionsTotal++,this.connectionsThisSecond++,this.config.roomsEnabled&&this.rooms.size>0){const i=Array.from(this.rooms.keys()),a=i[Math.floor(Math.random()*i.length)];if(a){const o=this.rooms.get(a);o&&(o.connections.push(t),n.roomId=a)}}if(this.config.subscriptionsEnabled&&this.subscriptions.size>0){const i=Array.from(this.subscriptions.keys()).filter(o=>this.subscriptions.get(o)?.enabled),a=i[Math.floor(Math.random()*i.length)];if(a){const o=this.subscriptions.get(a);o&&(o.connections.push(t),n.subscriptions.push(a))}}}simulateMessage(e,t){if(!this.config)return;const s=this.connections.get(e);if(!s||s.status!=="connected")return;const n=Date.now();if(this.config.rateLimit?.enabled){n-this.rateLimitWindowStart>=1e3&&(this.rateLimitWindowStart=n,this.rateLimitConnectionsInWindow=0,this.rateLimitMessagesInWindow=0);const h=this.config.rateLimit.messagesPerSecond||1e3;if(this.rateLimitMessagesInWindow>=h){const p={id:`ws-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,connectionId:e,type:"text",content:"Rate limit exceeded",timestamp:n,direction:t,size:0,error:"Rate limit exceeded"};this.messageHistory.push(p),this.messageHistory.length>this.MAX_HISTORY_SIZE&&this.messageHistory.shift();return}this.rateLimitMessagesInWindow++}const i=100+Math.random()*900,a=s.latency||10+Math.random()*20,o={id:`ws-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,connectionId:e,type:Math.random()>.9?"binary":"text",content:t==="sent"?"Message sent":"Message received",timestamp:n,direction:t,size:i,compressed:this.config.enableCompression&&Math.random()>.5,latency:a,roomId:s.roomId};if(t==="sent"?(s.messagesSent++,s.bytesSent+=i):(s.messagesReceived++,s.bytesReceived+=i),s.lastMessageAt=n,this.messageHistory.push(o),this.messageHistory.length>this.MAX_HISTORY_SIZE&&this.messageHistory.shift(),this.wsMetrics.messagesTotal++,this.messagesThisSecond++,t==="sent"?(this.wsMetrics.messagesSent++,this.wsMetrics.bytesSent+=i):(this.wsMetrics.messagesReceived++,this.wsMetrics.bytesReceived+=i),this.latencyHistory.push(a),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift(),s.roomId&&this.config.roomsEnabled){const l=this.rooms.get(s.roomId);if(l){l.messagesBroadcast++;const d=l.connections.filter(h=>h!==e);for(const h of d.slice(0,5)){const p=this.connections.get(h);p&&p.status==="connected"&&(p.messagesReceived++,p.bytesReceived+=i)}}}if(s.subscriptions.length>0&&this.config.subscriptionsEnabled)for(const l of s.subscriptions){const d=this.subscriptions.get(l);if(d&&d.enabled){d.messagesDelivered++;const h=d.connections.filter(p=>p!==e);for(const p of h.slice(0,10)){const g=this.connections.get(p);g&&g.status==="connected"&&(g.messagesReceived++,g.bytesReceived+=i)}}}}processPingPong(){if(!this.config)return;const e=Date.now(),t=(this.config.pingInterval||30)*1e3;for(const s of this.connections.values()){if(s.status!=="connected")continue;const n=s.lastPingAt||s.connectedAt||0;e-n>=t&&(s.lastPingAt=e,Math.random()>.1?(s.lastPongAt=e,this.pingPongHistory.push({timestamp:e,success:!0})):(this.pingPongHistory.push({timestamp:e,success:!1}),s.status="disconnected",s.disconnectedAt=e),this.pingPongHistory.length>this.MAX_PING_PONG_HISTORY&&this.pingPongHistory.shift())}}closeIdleConnections(){const e=Date.now(),t=3e5;for(const s of this.connections.values()){if(s.status!=="connected")continue;const n=s.lastMessageAt||s.connectedAt||0;e-n>t&&(s.status="disconnected",s.disconnectedAt=e)}}authenticateConnection(){if(!this.config?.authentication?.enabled)return!0;switch(this.config.authentication.method){case"token":return Math.random()>.1;case"apiKey":return Math.random()>.05;case"basic":return Math.random()>.15;default:return!0}}updateConnectionMetrics(){const e=Date.now();for(const t of this.connections.values()){if(t.status!=="connected")continue;const s={connectionId:t.id,messagesSent:t.messagesSent,messagesReceived:t.messagesReceived,bytesSent:t.bytesSent,bytesReceived:t.bytesReceived,averageLatency:t.latency||0,uptime:t.connectedAt?(e-t.connectedAt)/1e3:0,lastActivity:t.lastMessageAt||t.connectedAt||0};this.connectionMetrics.set(t.id,s)}}updateRoomMetrics(){for(const e of this.rooms.values()){const t=e.connections.filter(n=>this.connections.get(n)?.status==="connected"),s={roomId:e.id,connectionsCount:t.length,messagesBroadcast:e.messagesBroadcast,averageLatency:15+Math.random()*10};this.roomMetrics.set(e.id,s)}}updateSubscriptionMetrics(){for(const e of this.subscriptions.values()){if(!e.enabled)continue;const t=e.connections.filter(n=>this.connections.get(n)?.status==="connected"),s={subscriptionId:e.id,connectionsCount:t.length,messagesDelivered:e.messagesDelivered,averageLatency:20+Math.random()*15};this.subscriptionMetrics.set(e.id,s)}}calculateMetrics(){const e=Date.now(),t=(e-this.lastSecondStart)/1e3;if(t>=1&&(this.wsMetrics.connectionsPerSecond=this.connectionsThisSecond/t,this.wsMetrics.messagesPerSecond=this.messagesThisSecond/t,this.connectionsThisSecond=0,this.messagesThisSecond=0,this.lastSecondStart=e),this.wsMetrics.connectionsActive=Array.from(this.connections.values()).filter(d=>d.status==="connected").length,this.latencyHistory.length>0){const d=this.latencyHistory.reduce((p,g)=>p+g,0);this.wsMetrics.averageLatency=d/this.latencyHistory.length;const h=[...this.latencyHistory].sort((p,g)=>p-g);this.wsMetrics.latencyP50=h[Math.floor(h.length*.5)],this.wsMetrics.latencyP95=h[Math.floor(h.length*.95)],this.wsMetrics.latencyP99=h[Math.floor(h.length*.99)]}const s=this.wsMetrics.connectionsTotal,n=Array.from(this.connections.values()).filter(d=>d.status==="error"||d.status==="disconnected").length;if(this.wsMetrics.connectionErrorRate=s>0?n/s:0,this.pingPongHistory.length>0){const d=this.pingPongHistory.filter(h=>h.success).length;this.wsMetrics.pingPongSuccessRate=d/this.pingPongHistory.length}const i=this.messageHistory.filter(d=>d.compressed).length;if(this.wsMetrics.compressionRatio=this.messageHistory.length>0?i/this.messageHistory.length:.5,this.wsMetrics.roomsCount=this.rooms.size,this.wsMetrics.subscriptionsCount=Array.from(this.subscriptions.values()).filter(d=>d.enabled).length,this.rooms.size>0){const d=Array.from(this.rooms.values()).reduce((h,p)=>h+p.connections.length,0);this.wsMetrics.averageConnectionsPerRoom=d/this.rooms.size}if(this.wsMetrics.connectionsActive>0){const d=Array.from(this.connections.values()).reduce((h,p)=>h+p.subscriptions.length,0);this.wsMetrics.averageSubscriptionsPerConnection=d/this.wsMetrics.connectionsActive}const a=this.config?.maxConnections||1e3;this.wsMetrics.utilization=Math.min(1,this.wsMetrics.connectionsActive/a);const o=this.wsMetrics.messagesTotal,l=this.messageHistory.filter(d=>d.error).length;this.wsMetrics.errorRate=o>0?l/o:0}getWebSocketMetrics(){return{...this.wsMetrics}}getConnectionMetrics(){return Array.from(this.connectionMetrics.values())}getRoomMetrics(){return Array.from(this.roomMetrics.values())}getSubscriptionMetrics(){return Array.from(this.subscriptionMetrics.values())}getActiveConnections(){return Array.from(this.connections.values()).filter(e=>e.status==="connected")}getRooms(){return Array.from(this.rooms.values())}getSubscriptions(){return Array.from(this.subscriptions.values()).filter(e=>e.enabled)}getMessageHistory(e=100){return this.messageHistory.slice(-e)}processIncomingMessage(e,t,s,n="received"){if(!this.config)return{processed:!1,error:"Configuration not initialized"};const i=this.connections.get(e);if(!i||i.status!=="connected")return{processed:!1,error:"Connection not found or not connected"};const a=Date.now(),o=typeof t=="string"?t:JSON.stringify(t),l=new Blob([o]).size,d=(this.config.maxMessageSize||1024)*1024;if(l>d){const g={id:`ws-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,connectionId:e,type:"text",content:"Message size exceeds maximum",timestamp:a,direction:n,size:l,error:`Message size ${l} bytes exceeds maximum ${d} bytes`};return this.messageHistory.push(g),this.messageHistory.length>this.MAX_HISTORY_SIZE&&this.messageHistory.shift(),this.wsMetrics.errorRate=this.wsMetrics.errorRate*.9+.1*1,{processed:!1,error:`Message size exceeds maximum ${d} bytes`}}if(this.config.rateLimit?.enabled){a-this.rateLimitWindowStart>=1e3&&(this.rateLimitWindowStart=a,this.rateLimitConnectionsInWindow=0,this.rateLimitMessagesInWindow=0);const b=this.config.rateLimit.messagesPerSecond||1e3;if(this.rateLimitMessagesInWindow>=b){const M={id:`ws-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,connectionId:e,type:"text",content:"Rate limit exceeded",timestamp:a,direction:n,size:l,error:"Rate limit exceeded"};return this.messageHistory.push(M),this.messageHistory.length>this.MAX_HISTORY_SIZE&&this.messageHistory.shift(),this.wsMetrics.errorRate=this.wsMetrics.errorRate*.9+.1*1,{processed:!1,error:"Rate limit exceeded"}}this.rateLimitMessagesInWindow++}const h={id:`ws-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,connectionId:e,type:typeof t=="string"?"text":"binary",content:o,timestamp:a,direction:n,size:l,compressed:this.config.enableCompression&&Math.random()>.5,latency:i.latency||10+Math.random()*20,roomId:i.roomId};n==="sent"?(i.messagesSent++,i.bytesSent+=l):(i.messagesReceived++,i.bytesReceived+=l),i.lastMessageAt=a,this.messageHistory.push(h),this.messageHistory.length>this.MAX_HISTORY_SIZE&&this.messageHistory.shift(),this.wsMetrics.messagesTotal++,n==="sent"?(this.wsMetrics.messagesSent++,this.wsMetrics.bytesSent+=l):(this.wsMetrics.messagesReceived++,this.wsMetrics.bytesReceived+=l),this.messagesThisSecond++,h.latency&&(this.latencyHistory.push(h.latency),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift());const p={processed:!0};if(i.roomId&&this.config.roomsEnabled){const g=this.rooms.get(i.roomId);if(g){g.messagesBroadcast++,h.roomId=i.roomId,p.broadcastToRoom=i.roomId;const v=g.connections.filter(b=>b!==e);for(const b of v){const M=this.connections.get(b);M&&M.status==="connected"&&(M.messagesReceived++,M.bytesReceived+=l)}}}if(i.subscriptions.length>0&&this.config.subscriptionsEnabled){const g=[];for(const v of i.subscriptions){const b=this.subscriptions.get(v);if(b&&b.enabled){b.messagesDelivered++,h.subscriptionId=v,g.push(v);const M=b.connections.filter(x=>x!==e);for(const x of M){const S=this.connections.get(x);S&&S.status==="connected"&&(S.messagesReceived++,S.bytesReceived+=l)}}}g.length>0&&(p.deliveredToSubscriptions=g)}if(this.sendMessageToTarget&&this.componentId){const g=s?.targetIds||[];if(g.length>0){for(const v of g){const b={id:`ws-forward-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,source:this.componentId,target:v,payload:t,format:typeof t=="string"?"text":"json",timestamp:a,status:"in_transit",metadata:{...s,connectionId:e,roomId:i.roomId,subscriptions:i.subscriptions}};this.sendMessageToTarget(this.componentId,v,b).catch(()=>{})}p.forwarded=!0}}return p}resetMetrics(){this.wsMetrics={connectionsTotal:0,connectionsActive:0,connectionsPerSecond:0,messagesPerSecond:0,messagesTotal:0,messagesSent:0,messagesReceived:0,bytesSent:0,bytesReceived:0,averageLatency:0,errorRate:0,connectionErrorRate:0,pingPongSuccessRate:1,compressionRatio:.5,roomsCount:0,subscriptionsCount:0,averageConnectionsPerRoom:0,averageSubscriptionsPerConnection:0,utilization:0},this.messageHistory=[],this.latencyHistory=[],this.pingPongHistory=[],this.connectionsThisSecond=0,this.messagesThisSecond=0}updateConfig(e){if(this.config?this.config={...this.config,...e}:this.config={endpoint:e.endpoint||"ws://localhost:8080/ws",protocol:e.protocol||"ws",enableCompression:e.enableCompression??!0,enablePingPong:e.enablePingPong??!0,pingInterval:e.pingInterval||30,maxConnections:e.maxConnections||1e3,maxMessageSize:e.maxMessageSize||1024,roomsEnabled:e.roomsEnabled??!0,subscriptionsEnabled:e.subscriptionsEnabled??!0,authentication:e.authentication||{enabled:!1,method:"none"},rateLimit:e.rateLimit||{enabled:!1,messagesPerSecond:1e3,connectionsPerSecond:100},...e},e.rooms!==void 0){this.rooms.clear();for(const t of e.rooms)this.rooms.set(t.id,{...t})}if(e.subscriptions!==void 0){this.subscriptions.clear();for(const t of e.subscriptions)t.enabled&&this.subscriptions.set(t.id,{...t})}if(e.maxConnections!==void 0&&this.connections.size>e.maxConnections){const s=Array.from(this.connections.entries()).sort((n,i)=>(n[1].connectedAt||0)-(i[1].connectedAt||0)).slice(0,this.connections.size-e.maxConnections);for(const[n]of s){const i=this.connections.get(n);i&&(i.status="disconnected",i.disconnectedAt=Date.now())}}}}class Sk{config=null;receivers=new Map;processors=new Map;exporters=new Map;pipelines=new Map;metricsReceived=0;tracesReceived=0;logsReceived=0;metricsExported=0;tracesExported=0;logsExported=0;initializeConfig(e){const t=e.data.config||{};if(this.config={receivers:Array.isArray(t.receivers)?t.receivers:[],processors:Array.isArray(t.processors)?t.processors:[],exporters:Array.isArray(t.exporters)?t.exporters:[],pipelines:Array.isArray(t.pipelines)?t.pipelines:[]},this.receivers.clear(),this.config.receivers)for(const s of this.config.receivers)s.id&&this.receivers.set(s.id,s);if(this.processors.clear(),this.config.processors)for(const s of this.config.processors)s.id&&this.processors.set(s.id,s);if(this.exporters.clear(),this.config.exporters)for(const s of this.config.exporters)s.id&&this.exporters.set(s.id,s);if(this.pipelines.clear(),this.config.pipelines)for(const s of this.config.pipelines)s.id&&this.pipelines.set(s.id,s)}processMessage(e,t){const s=Date.now();try{const n=this.determineDataType(e,t),i=Array.from(this.pipelines.values()).filter(a=>a.type===n&&a.enabled!==!1);if(i.length===0)return{success:!0,latency:Date.now()-s};for(const a of i){if(a.receivers.map(p=>this.receivers.get(p)).filter(p=>p&&p.enabled).length===0)continue;let l=e.payload;const d=a.processors.map(p=>this.processors.get(p)).filter(p=>p&&p.enabled);for(const p of d)l=this.applyProcessor(p,l);const h=a.exporters.map(p=>this.exporters.get(p)).filter(p=>p&&p.enabled);for(const p of h)this.applyExporter(p,l,n);n==="metrics"?(this.metricsReceived++,this.metricsExported+=h.length):n==="traces"?(this.tracesReceived++,this.tracesExported+=h.length):n==="logs"&&(this.logsReceived++,this.logsExported+=h.length)}return{success:!0,latency:Date.now()-s}}catch(n){return{success:!1,latency:Date.now()-s,error:n instanceof Error?n.message:"Unknown error"}}}determineDataType(e,t){if(t){const s=t.type?.toLowerCase()||"";if(s.includes("prometheus")||s.includes("metric"))return"metrics";if(s.includes("jaeger")||s.includes("trace"))return"traces";if(s.includes("loki")||s.includes("log"))return"logs"}if(e.format){const s=e.format.toLowerCase();if(s.includes("prometheus")||s.includes("metric"))return"metrics";if(s.includes("jaeger")||s.includes("trace")||s.includes("zipkin"))return"traces";if(s.includes("log"))return"logs"}return"traces"}applyProcessor(e,t){switch(e.type){case"batch":return t;case"memory_limiter":return t;case"filter":return t;case"transform":return t;case"resource":return t;case"attributes":return t;default:return t}}applyExporter(e,t,s){e.type}getMetrics(){return{metricsReceived:this.metricsReceived,tracesReceived:this.tracesReceived,logsReceived:this.logsReceived,metricsExported:this.metricsExported,tracesExported:this.tracesExported,logsExported:this.logsExported,receiversCount:this.receivers.size,processorsCount:this.processors.size,exportersCount:this.exporters.size,pipelinesCount:this.pipelines.size}}resetMetrics(){this.metricsReceived=0,this.tracesReceived=0,this.logsReceived=0,this.metricsExported=0,this.tracesExported=0,this.logsExported=0}}class xk{config=null;incidents=new Map;incidentState=new Map;metrics={notificationsSent:0,escalationsTriggered:0,acknowledgements:0,totalAckLatency:0,totalAckCount:0,totalResolveLatency:0,totalResolveCount:0,apiRequests:0,webhookCalls:0,errors:0};initializeFromNode(e){const t=e.data.config||{},s=(t.services||[]).map(a=>({id:String(a.id??a.name??"service"),name:String(a.name??"service"),integrationKey:a.integrationKey,status:a.status??"active",escalationPolicy:a.escalationPolicy??t.escalationPolicy??"default-policy",autoResolve:a.autoResolve??t.enableAutoResolve??!0,resolveTimeout:a.resolveTimeout??t.resolveTimeout??300})),n=(t.escalationPolicies||[]).map(a=>({id:String(a.id??a.name??"policy"),name:String(a.name??"policy"),levels:Array.isArray(a.levels)?a.levels.map((o,l)=>({level:typeof o.level=="number"?o.level:l+1,timeout:typeof o.timeout=="number"?o.timeout:5,targets:Array.isArray(o.targets)?o.targets.map(d=>String(d)):[]})):[]})),i=(t.onCallUsers||[]).map(a=>({id:String(a.id??a.email??a.name??"user"),name:String(a.name??"On-Call User"),email:String(a.email??"user@example.com"),status:a.status==="off-call"?"off-call":"on-call"}));this.config={services:s,escalationPolicies:n,onCallUsers:i,severityMapping:t.severityMapping??"standard",enableAutoResolve:t.enableAutoResolve??!0,resolveTimeout:t.resolveTimeout??300}}processAlerts(e,t){if(!(!this.config||t.length===0))for(const s of t){const n=this.findServiceForAlert(s);if(!n||n.status==="disabled")continue;const i=this.mapSeverity(s),a=this.findExistingIncident(s,n);if(a)a.lastSignalAt=e,a.alertIds=Array.from(new Set([...a.alertIds||[],s.id])),this.incidents.set(a.id,a),this.metrics.apiRequests++;else{const o=`inc-${Date.now()}-${Math.floor(Math.random()*1e3)}`,l={id:o,title:s.title,serviceId:n.id,status:"triggered",severity:i,createdAt:e,lastSignalAt:e,alertIds:[s.id]};this.incidents.set(o,l),this.incidentState.set(o,{escalationLevelIndex:0,lastEscalationAt:e}),this.metrics.apiRequests++,this.triggerEscalation(e,l,n)}}}advanceTime(e){if(this.config)for(const[t,s]of this.incidents.entries()){if(s.status==="resolved")continue;const n=this.config.services.find(g=>g.id===s.serviceId);if(!n)continue;const i=n.autoResolve??this.config.enableAutoResolve,a=(n.resolveTimeout??this.config.resolveTimeout)*1e3;if(i&&s.status!=="resolved"&&s.lastSignalAt&&e-s.lastSignalAt>=a){this.resolveIncident(e,s),this.incidents.set(t,s);continue}const o=this.findEscalationPolicy(n);if(!o||o.levels.length===0)continue;const l=this.incidentState.get(t);if(!l)continue;const d=o.levels[l.escalationLevelIndex];if(!d)continue;const h=d.timeout*60*1e3;s.status==="triggered"&&e-l.lastEscalationAt>=h&&l.escalationLevelIndex<o.levels.length-1&&(l.escalationLevelIndex+=1,l.lastEscalationAt=e,this.incidentState.set(t,l),this.triggerEscalation(e,s,n,l.escalationLevelIndex))}}acknowledgeIncident(e,t){const s=this.incidents.get(t);!s||s.status!=="triggered"||(s.status="acknowledged",s.acknowledgedAt=e,this.incidents.set(t,s),this.metrics.acknowledgements++,this.metrics.totalAckCount++,this.metrics.totalAckLatency+=e-s.createdAt)}resolveIncidentManually(e,t){const s=this.incidents.get(t);!s||s.status==="resolved"||(this.resolveIncident(e,s),this.incidents.set(t,s))}getIncidents(){return Array.from(this.incidents.values())}getMetrics(){const e=Array.from(this.incidents.values()),t=e.length,s=e.filter(M=>M.status!=="resolved").length,n=e.filter(M=>M.status==="resolved").length,i=this.metrics.totalAckCount>0?this.metrics.totalAckLatency/this.metrics.totalAckCount:0,a=this.metrics.totalResolveCount>0?this.metrics.totalResolveLatency/this.metrics.totalResolveCount:0,o=300,l=this.metrics.apiRequests/o,d=this.metrics.webhookCalls/o,h=l+d+s*.1+this.metrics.notificationsSent/o,p=Math.min(.95,.1+h/200),g=Math.min(.95,.2+t/1e3),v=this.metrics.apiRequests+this.metrics.webhookCalls+1,b=this.metrics.errors/v;return{incidentsTotal:t,incidentsActive:s,incidentsResolved:n,notificationsSent:this.metrics.notificationsSent,escalationsTriggered:this.metrics.escalationsTriggered,acknowledgements:this.metrics.acknowledgements,averageAckLatency:i,averageResolveLatency:a,apiRequestsPerSecond:l,webhooksPerSecond:d,errorRate:b,cpuUtilization:p,memoryUtilization:g}}calculateLoad(){const e=this.getMetrics(),t=e.apiRequestsPerSecond+e.webhooksPerSecond+e.incidentsActive/60+e.notificationsSent/300,n=100+(e.averageAckLatency||0)*.01+(e.averageResolveLatency||0)*.005,i=(e.cpuUtilization+e.memoryUtilization)/2;return{throughput:t,latency:n,errorRate:e.errorRate,utilization:i}}findServiceForAlert(e){if(this.config){if(e.nodeLabel){const t=e.nodeLabel.toLowerCase(),s=this.config.services.find(n=>n.name.toLowerCase()===t||t.includes(n.name.toLowerCase()));if(s)return s}if(e.nodeId){const t=this.config.services.find(s=>s.id===e.nodeId);if(t)return t}return this.config.services[0]}}mapSeverity(e){if(!this.config)return"warning";const t=e.type==="critical"?"critical":e.type==="warning"?"warning":"info";switch(this.config.severityMapping){case"error-focused":return t==="warning"?"error":t;case"warning-demoted":return t==="warning"?"info":t;default:return t}}findExistingIncident(e,t){for(const s of this.incidents.values())if(s.serviceId===t.id&&s.status!=="resolved"&&s.title===e.title)return s}findEscalationPolicy(e){if(this.config)return e.escalationPolicy?this.config.escalationPolicies.find(t=>t.id===e.escalationPolicy||t.name===e.escalationPolicy)??this.config.escalationPolicies[0]:this.config.escalationPolicies[0]}resolveIncident(e,t){t.status!=="resolved"&&(t.status="resolved",t.resolvedAt=e,this.metrics.totalResolveCount++,this.metrics.totalResolveLatency+=e-t.createdAt)}triggerEscalation(e,t,s,n=0){if(!this.config)return;const i=this.findEscalationPolicy(s);if(!i)return;const a=i.levels[n];if(!a)return;const o=this.config.onCallUsers.filter(h=>h.status==="on-call"&&a.targets.includes(h.id)),l=o.length>0?o:this.config.onCallUsers,d=Math.max(1,l.length);this.metrics.notificationsSent+=d,this.metrics.escalationsTriggered++,this.metrics.webhookCalls+=1}}class Ck{alerts=new Map;alertCallbacks=[];isAnalyzing=!1;onAlert(e){this.alertCallbacks.push(e)}analyze(e,t,s,n){if(this.isAnalyzing)return[];this.isAnalyzing=!0;const i=[];try{for(const a of e){const o=t.get(a.id),l=n.find(d=>d.nodeId===a.id);if(!(!o||!l)){if(l.health==="down"){const d=`down-${a.id}`;if(!this.alerts.has(d)){const h={id:d,type:"critical",title:"Component Down",message:`${a.data.label} is down and not responding`,nodeId:a.id,nodeLabel:a.data.label,timestamp:Date.now(),acknowledged:!1,severity:1};this.addAlert(h),i.push(h)}}if(o.errorRate>.1){const d=`error-${a.id}`,h=this.alerts.get(d);if(!h||h.acknowledged){const p={id:d,type:"critical",title:"High Error Rate",message:`${a.data.label} has ${(o.errorRate*100).toFixed(1)}% error rate`,nodeId:a.id,nodeLabel:a.data.label,timestamp:Date.now(),acknowledged:!1,severity:.9};this.addAlert(p),i.push(p)}}if(o.latency>2e3){const d=`latency-${a.id}`,h=this.alerts.get(d);if(!h||h.acknowledged){const p={id:d,type:"warning",title:"High Latency",message:`${a.data.label} has latency of ${o.latency.toFixed(0)}ms`,nodeId:a.id,nodeLabel:a.data.label,timestamp:Date.now(),acknowledged:!1,severity:.7};this.addAlert(p),i.push(p)}}if(o.utilization>.9){const d=`utilization-${a.id}`,h=this.alerts.get(d);if(!h||h.acknowledged){const p={id:d,type:"warning",title:"High Utilization",message:`${a.data.label} is at ${(o.utilization*100).toFixed(0)}% capacity`,nodeId:a.id,nodeLabel:a.data.label,timestamp:Date.now(),acknowledged:!1,severity:.6};this.addAlert(p),i.push(p)}}}}for(const[a,o]of s.entries())if(o.bottleneck){const l=`bottleneck-${a}`,d=this.alerts.get(l);if(!d||d.acknowledged){const h={id:l,type:"critical",title:"Connection Bottleneck",message:"Bottleneck detected in connection",timestamp:Date.now(),acknowledged:!1,severity:.85};this.addAlert(h),i.push(h)}}this.cleanupResolvedAlerts(e,t,s,n)}finally{this.isAnalyzing=!1}return i}addAlert(e){this.alerts.set(e.id,e),this.alertCallbacks.forEach(t=>t(e))}cleanupResolvedAlerts(e,t,s,n){new Set(e.map(i=>i.id)),new Set(s.keys());for(const[i,a]of this.alerts.entries()){if(a.acknowledged)continue;let o=!1;if(a.nodeId)if(!e.find(d=>d.id===a.nodeId))o=!0;else{const d=t.get(a.nodeId),h=n.find(p=>p.nodeId===a.nodeId);(i.startsWith("down-")&&h&&h.health!=="down"||i.startsWith("error-")&&d&&d.errorRate<=.1||i.startsWith("latency-")&&d&&d.latency<=2e3||i.startsWith("utilization-")&&d&&d.utilization<=.9)&&(o=!0)}else if(i.startsWith("bottleneck-")){const l=i.replace("bottleneck-",""),d=s.get(l);(!d||!d.bottleneck)&&(o=!0)}o&&this.alerts.delete(i)}}acknowledge(e){const t=this.alerts.get(e);t&&(t.acknowledged=!0,this.alerts.set(e,t))}getAlerts(){return Array.from(this.alerts.values()).filter(e=>!e.acknowledged).sort((e,t)=>t.severity-e.severity)}getAlertsByType(e){return this.getAlerts().filter(t=>t.type===e)}clear(){this.alerts.clear()}}const ga=new Ck;class Rk{config=null;metrics={loginRequestsTotal:0,loginErrorsTotal:0,tokenRefreshTotal:0,introspectionRequestsTotal:0,userInfoRequestsTotal:0,sessionsCreatedTotal:0,sessionsExpiredTotal:0,activeSessions:0};sessions=new Map;firstRequestTime=null;lastRequestTime=null;latencyHistory=[];MAX_LATENCY_HISTORY=200;initializeConfig(e){const t=e.data.config||{},s=Array.isArray(t.clients)?t.clients.map(i=>({id:String(i.id??i.clientId??"client"),name:String(i.name??i.id??"Client"),type:i.type??"public",enabled:i.enabled??!0,protocol:i.protocol??"openid-connect"})):[{id:"archiphoenix-app",name:"ArchiPhoenix App",type:"public",enabled:!0,protocol:"openid-connect"}],n=Array.isArray(t.users)?t.users.map(i=>({id:String(i.id??i.username??"user"),username:String(i.username??`user-${i.id??"1"}`),email:i.email?String(i.email):void 0,enabled:i.enabled??!0,roles:Array.isArray(i.roles)?i.roles.map(a=>String(a)):[]})):[{id:"1",username:"admin",email:"admin@archiphoenix.com",enabled:!0,roles:["admin","user"]}];this.config={realm:String(t.realm||"archiphoenix"),adminUrl:String(t.adminUrl||"http://keycloak:8080"),enableSSL:t.enableSSL??!1,sslRequired:t.sslRequired||"external",accessTokenLifespan:Number(t.accessTokenLifespan||300),ssoSessionIdle:Number(t.ssoSessionIdle||1800),ssoSessionMax:Number(t.ssoSessionMax||36e3),enableOAuth2:t.enableOAuth2??!0,enableSAML:t.enableSAML??!1,enableLDAP:t.enableLDAP??!1,passwordPolicy:String(t.passwordPolicy||"length(8)"),clients:s,users:n}}processAuthRequest(e,t){const s=Date.now();this.firstRequestTime??=s,this.lastRequestTime=s,this.cleanupExpiredSessions(s);const n=this.config;if(!n)return this.recordLatency(50),this.metrics.loginErrorsTotal++,{success:!1,latency:50,error:"Keycloak not configured"};const i=t.clientId||this.inferDefaultClientId(),a=n.clients.find(p=>p.id===i&&p.enabled);let o=e==="login"?80:e==="refresh"?40:e==="introspect"?60:40;e==="login"&&(o+=this.estimatePasswordPolicyCost(n.passwordPolicy)),n.enableLDAP&&(o*=1.3);const l=(Math.random()-.5)*20,d=Math.max(10,o+l);if(this.recordLatency(d),!a)return this.metrics.loginErrorsTotal++,this.bumpCounter(e),{success:!1,latency:d,error:`Client ${i} not found or disabled`,clientId:i,realm:n.realm};let h;if(e==="login"||e==="userinfo"){const p=t.username||t.subject;if(p&&(h=n.users.find(g=>g.username===p)),!h||!h.enabled)return this.metrics.loginErrorsTotal++,this.bumpCounter(e),{success:!1,latency:d,error:`User ${p||"unknown"} not found or disabled`,clientId:i,realm:n.realm}}switch(e){case"login":return this.metrics.loginRequestsTotal++,this.createOrUpdateSession(s,n,i,h),{success:!0,latency:d,tokenType:"access",expiresIn:n.accessTokenLifespan,subject:h.username,clientId:i,realm:n.realm};case"refresh":return this.metrics.tokenRefreshTotal++,t.subject&&this.touchUserSessions(s,t.subject),{success:!0,latency:d,tokenType:"access",expiresIn:n.accessTokenLifespan,subject:t.subject,clientId:i,realm:n.realm};case"introspect":return this.metrics.introspectionRequestsTotal++,{success:!0,latency:d,tokenType:"access",expiresIn:n.accessTokenLifespan,subject:t.subject,clientId:i,realm:n.realm};case"userinfo":return this.metrics.userInfoRequestsTotal++,{success:!0,latency:d,tokenType:"id",expiresIn:n.accessTokenLifespan,subject:h?.username??t.subject,clientId:i,realm:n.realm}}}calculateLoad(){const e=this.metrics,t=e.loginRequestsTotal+e.tokenRefreshTotal+e.introspectionRequestsTotal+e.userInfoRequestsTotal,s=t>0?Math.min(1,e.loginErrorsTotal/t):0,n=this.latencyHistory.length>0?this.latencyHistory.reduce((o,l)=>o+l,0)/this.latencyHistory.length:0;let i=0;if(this.firstRequestTime&&this.lastRequestTime&&this.lastRequestTime>this.firstRequestTime){const o=(this.lastRequestTime-this.firstRequestTime)/1e3;i=t/Math.max(o,1)}const a=e.loginRequestsTotal>0?1-e.loginErrorsTotal/e.loginRequestsTotal:1;return{requestsPerSecond:i,averageLatency:n,errorRate:s,activeSessions:this.metrics.activeSessions,authSuccessRate:a}}getMetrics(){return{...this.metrics}}getConfig(){return this.config?{...this.config}:null}inferDefaultClientId(){return this.config?.clients.length?(this.config.clients.filter(t=>t.enabled)[0]||this.config.clients[0]).id:"default-client"}estimatePasswordPolicyCost(e){if(!e)return 0;let t=0;const s=e.toLowerCase();s.includes("length(")&&(t+=10),s.includes("digits(")&&(t+=15),s.includes("special(")&&(t+=20),s.includes("uppercase(")&&(t+=10),s.includes("lowercase(")&&(t+=5);const n=(e.match(/\)/g)||[]).length;return t+=n*5,t}recordLatency(e){this.latencyHistory.push(e),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift()}bumpCounter(e){switch(e){case"login":this.metrics.loginRequestsTotal++;break;case"refresh":this.metrics.tokenRefreshTotal++;break;case"introspect":this.metrics.introspectionRequestsTotal++;break;case"userinfo":this.metrics.userInfoRequestsTotal++;break}}createOrUpdateSession(e,t,s,n){for(const d of this.sessions.values())if(d.userId===n.id&&d.clientId===s)return d.lastAccess=e,d.sessionId;const i=`sess-${e}-${Math.random().toString(36).slice(2,8)}`,a=t.ssoSessionIdle*1e3,o=t.ssoSessionMax*1e3,l={sessionId:i,userId:n.id,clientId:s,realm:t.realm,createdAt:e,lastAccess:e,idleTimeoutMs:a,maxLifespanMs:o};return this.sessions.set(i,l),this.metrics.sessionsCreatedTotal++,this.metrics.activeSessions=this.sessions.size,i}touchUserSessions(e,t){if(!this.config)return;const s=this.config.users.find(n=>n.username===t);if(s)for(const n of this.sessions.values())n.userId===s.id&&(n.lastAccess=e)}cleanupExpiredSessions(e){let t=0;for(const[s,n]of this.sessions.entries()){const i=e-n.lastAccess>n.idleTimeoutMs,a=e-n.createdAt>n.maxLifespanMs;(i||a)&&(this.sessions.delete(s),t++)}t>0&&(this.metrics.sessionsExpiredTotal+=t,this.metrics.activeSessions=this.sessions.size)}}class Tk{config=null;rules=new Map;threats=[];stats={totalRequests:0,allowedRequests:0,blockedRequests:0,threatsDetected:0,activeRules:0,rateLimitHits:0,geoBlockHits:0,ipBlockHits:0,owaspHits:0};rateLimitTracker=new Map;RATE_LIMIT_WINDOW_MS=6e4;ddosTracker=new Map;DDOS_WINDOW_MS=1e3;MAX_THREATS=1e3;initializeConfig(e){const t=e.data.config||{};if(this.config={mode:t.mode||"detection",enableOWASP:t.enableOWASP??!0,owaspRuleset:t.owaspRuleset||"3.3",enableRateLimiting:t.enableRateLimiting??!0,rateLimitPerMinute:t.rateLimitPerMinute||100,enableGeoBlocking:t.enableGeoBlocking??!1,blockedCountries:Array.isArray(t.blockedCountries)?t.blockedCountries:[],enableIPWhitelist:t.enableIPWhitelist??!1,whitelistedIPs:Array.isArray(t.whitelistedIPs)?t.whitelistedIPs:[],enableDDoSProtection:t.enableDDoSProtection??!0,ddosThreshold:t.ddosThreshold||1e3,rules:Array.isArray(t.rules)?t.rules:[]},this.rules.clear(),this.config.rules)for(const s of this.config.rules)s.id&&this.rules.set(s.id,s);this.stats.activeRules=Array.from(this.rules.values()).filter(s=>s.enabled).length}processRequest(e){const t=performance.now(),s=e.timestamp||Date.now(),n=e.sourceIP||"0.0.0.0";if(this.stats.totalRequests++,this.config?.enableIPWhitelist&&this.config.whitelistedIPs?.includes(n))return this.stats.allowedRequests++,{allowed:!0,blocked:!1,action:"allow",latency:performance.now()-t};if(this.config?.enableGeoBlocking&&e.country&&this.config.blockedCountries?.includes(e.country)){const a={id:`threat-${Date.now()}-${Math.random()}`,type:"geo-block",sourceIP:n,target:e.path,timestamp:s,severity:"medium",blocked:!0,details:{country:e.country}};if(this.addThreat(a),this.stats.geoBlockHits++,this.stats.blockedRequests++,this.stats.threatsDetected++,this.config.mode==="prevention")return{allowed:!1,blocked:!0,action:"block",latency:performance.now()-t,threatDetected:a}}if(this.config?.enableDDoSProtection){const a=this.checkDDoS(n,s);if(a.blocked){const o={id:`threat-${Date.now()}-${Math.random()}`,type:"ddos",sourceIP:n,target:e.path,timestamp:s,severity:"critical",blocked:!0,details:{requestCount:a.count}};if(this.addThreat(o),this.stats.blockedRequests++,this.stats.threatsDetected++,this.config.mode==="prevention")return{allowed:!1,blocked:!0,action:"block",latency:performance.now()-t,threatDetected:o}}}if(this.config?.enableRateLimiting){const a=this.checkRateLimit(n,s);if(a.blocked){const o={id:`threat-${Date.now()}-${Math.random()}`,type:"rate-limit",sourceIP:n,target:e.path,timestamp:s,severity:"medium",blocked:!0,details:{requestCount:a.count}};if(this.addThreat(o),this.stats.rateLimitHits++,this.stats.blockedRequests++,this.stats.threatsDetected++,this.config.mode==="prevention")return{allowed:!1,blocked:!0,action:"block",latency:performance.now()-t,threatDetected:o}}}if(this.config?.enableOWASP){const a=this.checkOWASPRules(e);if(a.detected){const o={id:`threat-${Date.now()}-${Math.random()}`,type:a.threatType||"custom",sourceIP:n,target:e.path,timestamp:s,severity:a.severity||"high",blocked:!0,details:a.details};if(this.addThreat(o),this.stats.owaspHits++,this.stats.blockedRequests++,this.stats.threatsDetected++,this.config.mode==="prevention")return{allowed:!1,blocked:!0,action:"block",latency:performance.now()-t,threatDetected:o}}}const i=Array.from(this.rules.values()).filter(a=>a.enabled).sort((a,o)=>a.priority-o.priority);for(const a of i){const o=this.matchRule(a,e);if(o.matched){const l={id:`threat-${Date.now()}-${Math.random()}`,type:"custom",sourceIP:n,target:e.path,timestamp:s,severity:o.severity||"medium",blocked:a.action==="block",ruleId:a.id,ruleName:a.name,details:o.details};if(this.addThreat(l),this.stats.threatsDetected++,a.action==="block"&&this.config?.mode==="prevention")return this.stats.blockedRequests++,{allowed:!1,blocked:!0,action:"block",latency:performance.now()-t,threatDetected:l,matchedRule:a};if(a.action==="log")continue;if(a.action==="challenge")return{allowed:!1,blocked:!1,action:"challenge",latency:performance.now()-t,threatDetected:l,matchedRule:a}}}return this.stats.allowedRequests++,{allowed:!0,blocked:!1,action:"allow",latency:performance.now()-t}}matchRule(e,t){if(!e.conditions||e.conditions.length===0)return{matched:!1};for(const s of e.conditions){let n,i=!1;switch(s.type){case"ip":n=t.sourceIP;break;case"uri":n=t.path;break;case"method":n=t.method;break;case"header":n=t.headers?.[s.value]||"";break;case"body":n=typeof t.body=="string"?t.body:JSON.stringify(t.body||"");break;case"country":n=t.country;break;case"user-agent":n=t.userAgent;break}if(n===void 0)return{matched:!1};switch(s.operator){case"equals":i=n===s.value;break;case"contains":i=n.toLowerCase().includes(s.value.toLowerCase());break;case"startsWith":i=n.toLowerCase().startsWith(s.value.toLowerCase());break;case"endsWith":i=n.toLowerCase().endsWith(s.value.toLowerCase());break;case"regex":try{i=new RegExp(s.value,"i").test(n)}catch{i=!1}break;case"in":i=s.value.split(",").map(l=>l.trim()).includes(n);break;case"not-in":i=!s.value.split(",").map(l=>l.trim()).includes(n);break}if(!i)return{matched:!1}}return{matched:!0,severity:"medium",details:{matchedConditions:e.conditions.length}}}checkOWASPRules(e){const t=typeof e.body=="string"?e.body:JSON.stringify(e.body||""),s=e.path||"",n=JSON.stringify(e.query||""),i=`${t} ${s} ${n}`.toLowerCase(),a=[/(\bunion\b.*\bselect\b)/i,/(\bselect\b.*\bfrom\b)/i,/(\bdrop\b.*\btable\b)/i,/(\binsert\b.*\binto\b)/i,/(\bdelete\b.*\bfrom\b)/i,/('.*--)/,/(\bor\b.*=.*)/i,/(\band\b.*=.*)/i];for(const h of a)if(h.test(i))return{detected:!0,threatType:"sql-injection",severity:"critical",details:{pattern:h.toString()}};const o=[/<script[^>]*>/i,/javascript:/i,/on\w+\s*=/i,/<iframe[^>]*>/i,/eval\s*\(/i,/expression\s*\(/i];for(const h of o)if(h.test(i))return{detected:!0,threatType:"xss",severity:"high",details:{pattern:h.toString()}};const l=[/\.\.\//,/\.\.\\/,/\.\.%2f/i,/\.\.%5c/i];for(const h of l)if(h.test(i))return{detected:!0,threatType:"path-traversal",severity:"high",details:{pattern:h.toString()}};const d=[/\$\{[^}]*\}/,/\$\([^)]*\)/,/`[^`]*`/,/\|\s*\w+.*\s*\|/];for(const h of d)if(h.test(i))return{detected:!0,threatType:"rce",severity:"critical",details:{pattern:h.toString()}};return{detected:!1}}checkRateLimit(e,t){if(!this.config?.enableRateLimiting||!this.config.rateLimitPerMinute)return{blocked:!1,count:0};const s=t-this.RATE_LIMIT_WINDOW_MS,n=this.rateLimitTracker.get(e)||[],i=n.filter(a=>a>s);return i.length>=this.config.rateLimitPerMinute?{blocked:!0,count:i.length}:(i.push(t),this.rateLimitTracker.set(e,i),n.length>this.config.rateLimitPerMinute*2&&this.rateLimitTracker.set(e,i),{blocked:!1,count:i.length})}checkDDoS(e,t){if(!this.config?.enableDDoSProtection||!this.config.ddosThreshold)return{blocked:!1,count:0};const s=this.ddosTracker.get(e),n=t-this.DDOS_WINDOW_MS;return!s||s.windowStart<n?(this.ddosTracker.set(e,{count:1,windowStart:t}),{blocked:!1,count:1}):(s.count++,this.ddosTracker.set(e,s),s.count>=this.config.ddosThreshold?{blocked:!0,count:s.count}:{blocked:!1,count:s.count})}addThreat(e){this.threats.push(e),this.threats.length>this.MAX_THREATS&&this.threats.shift()}getThreats(e=100){return this.threats.slice(-e).reverse()}getStats(){return{...this.stats}}resetStats(){this.stats={totalRequests:0,allowedRequests:0,blockedRequests:0,threatsDetected:0,activeRules:this.stats.activeRules,rateLimitHits:0,geoBlockHits:0,ipBlockHits:0,owaspHits:0},this.threats=[],this.rateLimitTracker.clear(),this.ddosTracker.clear()}}class Ek{config=null;routingEngine;metrics={requestsTotal:0,requestsAllowed:0,requestsBlocked:0,threatsDetected:0,threatsBlocked:0,rateLimitHits:0,geoBlockHits:0,ipBlockHits:0,owaspHits:0,customRuleHits:0,activeRules:0,averageLatency:0};firstRequestTime=null;lastRequestTime=null;latencyHistory=[];MAX_LATENCY_HISTORY=200;simulatedRequestRate=0;lastSimulationTime=Date.now();constructor(){this.routingEngine=new Tk}initializeConfig(e){const t=e.data.config||{};this.config={mode:t.mode||"detection",enableOWASP:t.enableOWASP??!0,owaspRuleset:t.owaspRuleset||"3.3",enableRateLimiting:t.enableRateLimiting??!0,rateLimitPerMinute:t.rateLimitPerMinute||100,enableGeoBlocking:t.enableGeoBlocking??!1,blockedCountries:Array.isArray(t.blockedCountries)?t.blockedCountries:[],enableIPWhitelist:t.enableIPWhitelist??!1,whitelistedIPs:Array.isArray(t.whitelistedIPs)?t.whitelistedIPs:[],enableDDoSProtection:t.enableDDoSProtection??!0,ddosThreshold:t.ddosThreshold||1e3,rules:Array.isArray(t.rules)?t.rules:[]},this.routingEngine.initializeConfig(e),this.updateMetricsFromStats()}processRequest(e){const t=performance.now(),s={path:e.path||"/",method:e.method||"GET",headers:e.headers,query:e.query,body:e.body,sourceIP:e.sourceIP||this.generateRandomIP(),country:e.country||this.generateRandomCountry(),userAgent:e.userAgent||"Mozilla/5.0",timestamp:Date.now()},n=this.routingEngine.processRequest(s),i=performance.now()-t+n.latency;if(this.recordLatency(i),this.metrics.requestsTotal++,n.allowed?this.metrics.requestsAllowed++:(this.metrics.requestsBlocked++,n.blocked&&this.metrics.threatsBlocked++),n.threatDetected){this.metrics.threatsDetected++;const o=this.routingEngine.getStats();this.metrics.rateLimitHits=o.rateLimitHits,this.metrics.geoBlockHits=o.geoBlockHits,this.metrics.ipBlockHits=o.ipBlockHits,this.metrics.owaspHits=o.owaspHits,this.metrics.customRuleHits=o.threatsDetected-o.owaspHits-o.rateLimitHits-o.geoBlockHits-o.ipBlockHits}const a=Date.now();return this.firstRequestTime||(this.firstRequestTime=a),this.lastRequestTime=a,{success:n.allowed,blocked:n.blocked,latency:i,threatDetected:!!n.threatDetected,error:n.error}}simulateRequests(e){const t=Date.now(),s=t-this.lastSimulationTime;if(this.lastSimulationTime=t,s<=0||e<=0)return;const n=Math.floor(e*s/1e3);if(n!==0){for(let i=0;i<n;i++){const a=this.generateRandomRequest();this.processRequest(a)}this.updateMetricsFromStats()}}generateRandomRequest(){const e=["GET","POST","PUT","DELETE","PATCH"],t=["/api/users","/api/products","/api/orders","/api/auth","/api/data"],s=["US","GB","DE","FR","CN","RU","JP"],n=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36","Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"],i=Math.random()<.05;let a=t[Math.floor(Math.random()*t.length)],o=null;return i?Math.random()<.5?(a+="?id=1' OR '1'='1",o={query:"SELECT * FROM users WHERE id = '1' OR '1'='1'"}):o={content:'<script>alert("XSS")<\/script>'}:Math.random()<.3&&(o={data:Math.random().toString(36).substring(7)}),{path:a,method:e[Math.floor(Math.random()*e.length)],headers:{"Content-Type":"application/json","User-Agent":n[Math.floor(Math.random()*n.length)]},body:o,sourceIP:this.generateRandomIP(),country:s[Math.floor(Math.random()*s.length)],userAgent:n[Math.floor(Math.random()*n.length)]}}generateRandomIP(){return`${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`}generateRandomCountry(){const e=["US","GB","DE","FR","CN","RU","JP","BR","IN","AU"];return e[Math.floor(Math.random()*e.length)]}recordLatency(e){this.latencyHistory.push(e),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift();const t=this.latencyHistory.reduce((s,n)=>s+n,0);this.metrics.averageLatency=t/this.latencyHistory.length}updateMetricsFromStats(){const e=this.routingEngine.getStats();this.metrics.requestsTotal=e.totalRequests,this.metrics.requestsAllowed=e.allowedRequests,this.metrics.requestsBlocked=e.blockedRequests,this.metrics.threatsDetected=e.threatsDetected,this.metrics.rateLimitHits=e.rateLimitHits,this.metrics.geoBlockHits=e.geoBlockHits,this.metrics.ipBlockHits=e.ipBlockHits,this.metrics.owaspHits=e.owaspHits,this.metrics.activeRules=e.activeRules,this.metrics.customRuleHits=e.threatsDetected-e.owaspHits-e.rateLimitHits-e.geoBlockHits-e.ipBlockHits}calculateLoad(){let e=0;if(this.firstRequestTime&&this.lastRequestTime&&this.lastRequestTime>this.firstRequestTime){const a=(this.lastRequestTime-this.firstRequestTime)/1e3;a>0&&(e=this.metrics.requestsTotal/a)}e===0&&this.simulatedRequestRate>0&&(e=this.simulatedRequestRate);const t=this.metrics.averageLatency||5,s=this.metrics.requestsTotal>0?this.metrics.requestsBlocked/this.metrics.requestsTotal:0,n=this.metrics.requestsTotal>0?this.metrics.requestsBlocked/this.metrics.requestsTotal:0,i=this.metrics.requestsTotal>0?this.metrics.threatsDetected/this.metrics.requestsTotal:0;return{requestsPerSecond:e,averageLatency:t,errorRate:s,blockRate:n,threatDetectionRate:i}}getMetrics(){return{...this.metrics}}getConfig(){return this.config}getThreats(e=100){return this.routingEngine.getThreats(e)}getStats(){return this.routingEngine.getStats()}setSimulatedRequestRate(e){this.simulatedRequestRate=e}resetMetrics(){this.metrics={requestsTotal:0,requestsAllowed:0,requestsBlocked:0,threatsDetected:0,threatsBlocked:0,rateLimitHits:0,geoBlockHits:0,ipBlockHits:0,owaspHits:0,customRuleHits:0,activeRules:this.metrics.activeRules,averageLatency:0},this.latencyHistory=[],this.firstRequestTime=null,this.lastRequestTime=null,this.routingEngine.resetStats()}}class kk{config=null;rules=new Map;logs=[];stats={totalPackets:0,allowedPackets:0,blockedPackets:0,rejectedPackets:0,activeRules:0,totalConnections:0,activeConnections:0};connections=new Map;MAX_CONNECTIONS=1e4;CONNECTION_TIMEOUT_MS=3e5;MAX_LOGS=1e4;initializeConfig(e){const t=e.data.config||{};if(this.config={enableFirewall:t.enableFirewall??!0,enableLogging:t.enableLogging??!0,enableIntrusionDetection:t.enableIntrusionDetection??!1,enableStatefulInspection:t.enableStatefulInspection??!0,defaultPolicy:t.defaultPolicy||"deny",logRetention:t.logRetention||30,rules:Array.isArray(t.rules)?t.rules:[]},this.rules.clear(),this.config.rules)for(const s of this.config.rules)s.id&&s.enabled&&this.rules.set(s.id,s);this.stats.activeRules=Array.from(this.rules.values()).filter(s=>s.enabled).length,this.cleanOldLogs()}processPacket(e){const t=performance.now(),s=e.timestamp||Date.now();if(!this.config?.enableFirewall)return{allowed:!0,blocked:!1,action:"allow",latency:performance.now()-t};if(this.stats.totalPackets++,this.config?.enableStatefulInspection){const o=this.getConnectionKey(e),l=this.connections.get(o);if(l){if(l.lastSeen=s,l.packets++,l.state="established",l.state==="established")return this.stats.allowedPackets++,this.logPacket(e,"allowed",void 0,"Established connection"),{allowed:!0,blocked:!1,action:"allow",latency:performance.now()-t}}else this.connections.size<this.MAX_CONNECTIONS&&(this.connections.set(o,{source:e.source,destination:e.destination,sourcePort:e.sourcePort||0,destinationPort:e.port||0,protocol:e.protocol,state:"new",firstSeen:s,lastSeen:s,packets:1}),this.stats.totalConnections++)}const n=Array.from(this.rules.values()).filter(o=>o.enabled).sort((o,l)=>l.priority-o.priority);for(const o of n){const l=this.matchRule(o,e);if(l.matched){if(o.hits=(o.hits||0)+1,this.config?.enableLogging&&this.logPacket(e,o.action==="allow"?"allowed":o.action==="deny"?"blocked":"rejected",o,l.reason),o.action==="allow"?this.stats.allowedPackets++:o.action==="deny"?this.stats.blockedPackets++:this.stats.rejectedPackets++,o.action==="allow"&&this.config?.enableStatefulInspection){const d=this.getConnectionKey(e),h=this.connections.get(d);h&&(h.state="established")}return{allowed:o.action==="allow",blocked:o.action==="deny"||o.action==="reject",action:o.action,latency:performance.now()-t,matchedRule:o}}}const i=this.config?.defaultPolicy||"deny",a=i==="allow"?"allowed":i==="deny"?"blocked":"rejected";return this.config?.enableLogging&&this.logPacket(e,a,void 0,`Default policy: ${i}`),i==="allow"?this.stats.allowedPackets++:i==="deny"?this.stats.blockedPackets++:this.stats.rejectedPackets++,{allowed:i==="allow",blocked:i==="deny"||i==="reject",action:i,latency:performance.now()-t}}matchRule(e,t){return e.protocol!=="all"&&e.protocol!==t.protocol?{matched:!1}:e.source&&!this.matchIP(t.source,e.source)?{matched:!1}:e.destination&&!this.matchIP(t.destination,e.destination)?{matched:!1}:(t.protocol==="tcp"||t.protocol==="udp")&&e.port!==void 0&&t.port!==e.port?{matched:!1}:(t.protocol==="tcp"||t.protocol==="udp")&&e.sourcePort!==void 0&&t.sourcePort!==e.sourcePort?{matched:!1}:{matched:!0,reason:`Matched rule: ${e.name}`}}matchIP(e,t){if(e===t)return!0;if(t.includes("/")){const[s,n]=t.split("/"),i=parseInt(n,10);if(isNaN(i)||i<0||i>32)return!1;const a=this.ipToNumber(e),o=this.ipToNumber(s),l=4294967295<<32-i>>>0;return(a&l)===(o&l)}return!1}ipToNumber(e){const t=e.split(".");return t.length!==4?0:(parseInt(t[0],10)<<24)+(parseInt(t[1],10)<<16)+(parseInt(t[2],10)<<8)+parseInt(t[3],10)}getConnectionKey(e){return`${e.source}:${e.sourcePort||0}-${e.destination}:${e.port||0}-${e.protocol}`}logPacket(e,t,s,n){if(!this.config?.enableLogging)return;const i={id:`log-${Date.now()}-${Math.random()}`,timestamp:e.timestamp||Date.now(),action:t,source:e.source,destination:e.destination,protocol:e.protocol,port:e.port,sourcePort:e.sourcePort,ruleId:s?.id,ruleName:s?.name,reason:n||s?.name};this.logs.push(i),this.logs.length>this.MAX_LOGS&&this.logs.shift()}cleanOldLogs(){if(!this.config?.logRetention)return;const e=this.config.logRetention*24*60*60*1e3,t=Date.now()-e;this.logs=this.logs.filter(s=>s.timestamp>=t)}cleanupConnections(){const e=Date.now(),t=this.CONNECTION_TIMEOUT_MS;for(const[s,n]of this.connections.entries())e-n.lastSeen>t&&this.connections.delete(s);this.stats.activeConnections=this.connections.size}getStats(){return this.stats.activeConnections=this.connections.size,{...this.stats}}getLogs(e){const t=[...this.logs].reverse();return e?t.slice(0,e):t}getRules(){return Array.from(this.rules.values())}getConfig(){return this.config}}class Ak{config=null;routingEngine;metrics={packetsTotal:0,packetsAllowed:0,packetsBlocked:0,packetsRejected:0,activeRules:0,totalConnections:0,activeConnections:0,averageLatency:0};firstPacketTime=null;lastPacketTime=null;latencyHistory=[];MAX_LATENCY_HISTORY=200;simulatedPacketRate=0;lastSimulationTime=Date.now();constructor(){this.routingEngine=new kk}initializeConfig(e){const t=e.data.config||{};this.config={enableFirewall:t.enableFirewall??!0,enableLogging:t.enableLogging??!0,enableIntrusionDetection:t.enableIntrusionDetection??!1,enableStatefulInspection:t.enableStatefulInspection??!0,defaultPolicy:t.defaultPolicy||"deny",logRetention:t.logRetention||30,rules:Array.isArray(t.rules)?t.rules:[]},this.routingEngine.initializeConfig(e),this.updateMetricsFromStats()}processPacket(e){const t=performance.now(),s={source:e.source,destination:e.destination,protocol:e.protocol,port:e.port,sourcePort:e.sourcePort,timestamp:Date.now()},n=this.routingEngine.processPacket(s),i=performance.now()-t;return this.recordLatency(i),this.updateMetricsFromStats(),{success:n.allowed,blocked:n.blocked,latency:i,error:n.blocked?n.matchedRule?.name||`Packet ${n.action}`:void 0}}simulatePackets(e){const t=Date.now(),s=t-this.lastSimulationTime;if(this.lastSimulationTime=t,s<=0||e<=0)return;const n=Math.floor(e*s/1e3);if(n!==0){for(let i=0;i<n;i++){const a=this.generateRandomPacket();this.processPacket(a)}this.updateMetricsFromStats()}}generateRandomPacket(){const e=["tcp","udp","icmp"],t=e[Math.floor(Math.random()*e.length)],s=`${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`,n=`10.0.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`,i=t==="icmp"?void 0:Math.floor(Math.random()*65535),a=t==="icmp"?void 0:Math.floor(Math.random()*65535);return{source:s,destination:n,protocol:t,port:i,sourcePort:a}}recordLatency(e){this.latencyHistory.push(e),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift()}updateMetricsFromStats(){const e=this.routingEngine.getStats();if(this.routingEngine.getRules(),this.metrics.packetsTotal=e.totalPackets,this.metrics.packetsAllowed=e.allowedPackets,this.metrics.packetsBlocked=e.blockedPackets,this.metrics.packetsRejected=e.rejectedPackets,this.metrics.activeRules=e.activeRules,this.metrics.totalConnections=e.totalConnections,this.metrics.activeConnections=e.activeConnections,this.latencyHistory.length>0){const t=this.latencyHistory.reduce((s,n)=>s+n,0);this.metrics.averageLatency=t/this.latencyHistory.length}}setSimulatedPacketRate(e){this.simulatedPacketRate=e}getMetrics(){return{...this.metrics}}getStats(){return this.routingEngine.getStats()}getLogs(e){return this.routingEngine.getLogs(e)}getRules(){return this.routingEngine.getRules()}getConfig(){return this.config}calculateLoad(){let e=0;if(this.firstPacketTime&&this.lastPacketTime){const n=(this.lastPacketTime-this.firstPacketTime)/1e3;n>0&&(e=this.metrics.packetsTotal/n)}e===0&&this.simulatedPacketRate>0&&(e=this.simulatedPacketRate);const t=this.metrics.packetsTotal>0?this.metrics.packetsBlocked/this.metrics.packetsTotal:0,s=this.metrics.packetsTotal>0?this.metrics.packetsRejected/this.metrics.packetsTotal:0;return{packetsPerSecond:e,averageLatency:this.metrics.averageLatency,blockRate:t,rejectionRate:s}}cleanup(){this.routingEngine.cleanupConnections(),this.updateMetricsFromStats()}}class Dk{config=null;signatures=new Map;alerts=[];stats={totalPackets:0,packetsAnalyzed:0,alertsGenerated:0,alertsBlocked:0,signatureMatches:0,anomalyDetections:0,behavioralDetections:0,activeSignatures:0,blockedIPs:0};blockedIPs=new Map;behavioralPatterns=new Map;MAX_BEHAVIORAL_PATTERNS=1e4;BEHAVIORAL_WINDOW_MS=3e5;MAX_ALERTS=1e4;initializeConfig(e){const t=e.data.config||{};if(this.config={mode:t.mode||"ids",enableSignatureDetection:t.enableSignatureDetection??!0,enableAnomalyDetection:t.enableAnomalyDetection??!0,enableBehavioralAnalysis:t.enableBehavioralAnalysis??!1,alertThreshold:t.alertThreshold||"medium",enableAutoBlock:t.enableAutoBlock??!1,blockDuration:t.blockDuration||3600,enableLogging:t.enableLogging??!0,logRetention:t.logRetention||30,signatures:Array.isArray(t.signatures)?t.signatures:[]},this.signatures.clear(),this.config.signatures)for(const s of this.config.signatures)s.id&&s.enabled&&this.signatures.set(s.id,s);if(Array.isArray(t.blockedIPs)){this.blockedIPs.clear();for(const s of t.blockedIPs)if(s.ip){const n=s.expiresAt?new Date(s.expiresAt).getTime():Date.now()+(this.config.blockDuration||3600)*1e3;this.blockedIPs.set(s.ip,{ip:s.ip,reason:s.reason||"Intrusion detected",blockedAt:s.blockedAt?new Date(s.blockedAt).getTime():Date.now(),expiresAt:n})}}this.stats.activeSignatures=Array.from(this.signatures.values()).filter(s=>s.enabled).length,this.stats.blockedIPs=this.blockedIPs.size,this.cleanExpiredBlocks()}processPacket(e){const t=performance.now();if(this.stats.totalPackets++,this.isIPBlocked(e.source))return this.stats.alertsBlocked++,{allowed:!1,blocked:!0,alertGenerated:!1,latency:performance.now()-t,error:`IP ${e.source} is blocked`};this.stats.packetsAnalyzed++;let s,n=!1;if(this.config?.enableSignatureDetection){const a=this.detectSignature(e);if(a&&(s=a,this.stats.signatureMatches++,this.stats.alertsGenerated++,a.signatureId)){const o=this.signatures.get(a.signatureId);o&&o.action==="block"&&this.config.mode==="ips"&&(n=!0)}}if(!s&&this.config?.enableAnomalyDetection){const a=this.detectAnomaly(e);a&&(s=a,this.stats.anomalyDetections++,this.stats.alertsGenerated++,this.config.enableAutoBlock&&a.anomalyScore&&a.anomalyScore>.8&&(n=!0))}if(!s&&this.config?.enableBehavioralAnalysis){const a=this.detectBehavioral(e);a&&(s=a,this.stats.behavioralDetections++,this.stats.alertsGenerated++,this.config.enableAutoBlock&&a.behavioralPattern==="suspicious"&&(n=!0))}n&&this.config?.mode==="ips"&&(this.blockIP(e.source,s?.description||"Intrusion detected",s?.signatureId),this.stats.alertsBlocked++,s=s?{...s,blocked:!0}:void 0),s&&this.shouldGenerateAlert(s.severity)&&this.addAlert(s);const i=performance.now()-t;return{allowed:!n,blocked:n,alertGenerated:!!s,latency:i,alert:s}}detectSignature(e){const t=Array.from(this.signatures.values()).filter(s=>s.enabled).sort((s,n)=>{const i={critical:4,high:3,medium:2,low:1};return i[n.severity]-i[s.severity]});for(const s of t)if(!(s.protocol&&s.protocol!=="all"&&s.protocol!==e.protocol)&&!(s.sourceIP&&!this.matchIP(e.source,s.sourceIP))&&!(s.destinationIP&&!this.matchIP(e.destination,s.destinationIP))&&!(s.port!==void 0&&e.port!==void 0&&s.port!==e.port)&&!(s.sourcePort!==void 0&&e.sourcePort!==void 0&&s.sourcePort!==e.sourcePort)){if(s.pattern&&e.payload)try{if(new RegExp(s.pattern,"i").test(e.payload))return{id:`alert-${Date.now()}-${Math.random()}`,type:"signature",sourceIP:e.source,destinationIP:e.destination,protocol:e.protocol,port:e.port,sourcePort:e.sourcePort,severity:s.severity,timestamp:e.timestamp||Date.now(),description:s.description||`Signature match: ${s.name}`,blocked:!1,signature:s.name,signatureId:s.id}}catch{}else if(!s.pattern)return{id:`alert-${Date.now()}-${Math.random()}`,type:"signature",sourceIP:e.source,destinationIP:e.destination,protocol:e.protocol,port:e.port,sourcePort:e.sourcePort,severity:s.severity,timestamp:e.timestamp||Date.now(),description:s.description||`Signature match: ${s.name}`,blocked:!1,signature:s.name,signatureId:s.id}}return null}detectAnomaly(e){let t=0;const s=[22,23,80,443,3306,5432,27017,6379,8080];if(e.port&&s.includes(e.port)&&(t+=.2),e.protocol==="icmp"&&(t+=.1),e.payload){const i=e.payload.length;(i>1e4||i<10)&&(t+=.3)}if(e.payload){const i=["SELECT","UNION","DROP","DELETE","INSERT","UPDATE","<script","eval(","base64"];for(const a of i)if(e.payload.toLowerCase().includes(a.toLowerCase())){t+=.4;break}}const n=this.getAnomalyThreshold();if(t>=n){const i=t>=.8?"critical":t>=.6?"high":"medium";return{id:`alert-${Date.now()}-${Math.random()}`,type:"anomaly",sourceIP:e.source,destinationIP:e.destination,protocol:e.protocol,port:e.port,sourcePort:e.sourcePort,severity:i,timestamp:e.timestamp||Date.now(),description:`Anomaly detected: unusual network activity (score: ${t.toFixed(2)})`,blocked:!1,anomalyScore:t}}return null}detectBehavioral(e){const t=`${e.source}-${e.destination}-${e.protocol}-${e.port||"any"}`,s=Date.now();let n=this.behavioralPatterns.get(t);n||(n={sourceIP:e.source,destinationIP:e.destination,protocol:e.protocol,port:e.port,requestCount:0,firstSeen:s,lastSeen:s,suspiciousScore:0},this.behavioralPatterns.set(t,n)),n.requestCount++,n.lastSeen=s,this.behavioralPatterns.size>this.MAX_BEHAVIORAL_PATTERNS&&this.cleanOldBehavioralPatterns();const i=(s-n.firstSeen)/1e3,a=i>0?n.requestCount/i:n.requestCount;return a>10&&(n.suspiciousScore=Math.min(1,a/100)),n.suspiciousScore>.7?{id:`alert-${Date.now()}-${Math.random()}`,type:"behavioral",sourceIP:e.source,destinationIP:e.destination,protocol:e.protocol,port:e.port,sourcePort:e.sourcePort,severity:n.suspiciousScore>.9?"critical":"high",timestamp:s,description:`Behavioral pattern detected: high request rate (${a.toFixed(2)} req/s)`,blocked:!1,behavioralPattern:"suspicious"}:null}isIPBlocked(e){return this.cleanExpiredBlocks(),this.blockedIPs.has(e)}blockIP(e,t,s){const n=Date.now()+(this.config?.blockDuration||3600)*1e3;this.blockedIPs.set(e,{ip:e,reason:t,blockedAt:Date.now(),expiresAt:n}),this.stats.blockedIPs=this.blockedIPs.size}cleanExpiredBlocks(){const e=Date.now();for(const[t,s]of this.blockedIPs.entries())s.expiresAt<e&&this.blockedIPs.delete(t);this.stats.blockedIPs=this.blockedIPs.size}cleanOldBehavioralPatterns(){const e=Date.now();for(const[t,s]of this.behavioralPatterns.entries())e-s.lastSeen>this.BEHAVIORAL_WINDOW_MS&&this.behavioralPatterns.delete(t)}shouldGenerateAlert(e){const t=this.config?.alertThreshold||"medium",s={critical:4,high:3,medium:2,low:1},n={critical:4,high:3,medium:2,low:1};return s[e]>=n[t]}getAnomalyThreshold(){const e=this.config?.alertThreshold||"medium";return{low:.9,medium:.7,high:.5,critical:.3}[e]}matchIP(e,t){if(e===t)return!0;if(t.includes("/")){const[s,n]=t.split("/"),i=parseInt(n,10);return e.startsWith(s.split(".").slice(0,Math.floor(i/8)).join("."))}return!1}addAlert(e){this.alerts.push(e),this.alerts.length>this.MAX_ALERTS&&this.alerts.shift()}getAlerts(e=100){return this.alerts.slice(-e).reverse()}getBlockedIPs(){return this.cleanExpiredBlocks(),Array.from(this.blockedIPs.values())}unblockIP(e){this.blockedIPs.delete(e),this.stats.blockedIPs=this.blockedIPs.size}getStats(){return{...this.stats}}getSignatures(){return Array.from(this.signatures.values())}resetStats(){this.stats={totalPackets:0,packetsAnalyzed:0,alertsGenerated:0,alertsBlocked:0,signatureMatches:0,anomalyDetections:0,behavioralDetections:0,activeSignatures:this.stats.activeSignatures,blockedIPs:this.blockedIPs.size}}}class Pk{config=null;routingEngine;metrics={packetsTotal:0,packetsAnalyzed:0,alertsGenerated:0,alertsBlocked:0,signatureMatches:0,anomalyDetections:0,behavioralDetections:0,activeSignatures:0,blockedIPs:0,averageLatency:0};firstPacketTime=null;lastPacketTime=null;latencyHistory=[];MAX_LATENCY_HISTORY=200;simulatedPacketRate=0;lastSimulationTime=Date.now();constructor(){this.routingEngine=new Dk}initializeConfig(e){const t=e.data.config||{};this.config={mode:t.mode||"ids",enableSignatureDetection:t.enableSignatureDetection??!0,enableAnomalyDetection:t.enableAnomalyDetection??!0,enableBehavioralAnalysis:t.enableBehavioralAnalysis??!1,alertThreshold:t.alertThreshold||"medium",enableAutoBlock:t.enableAutoBlock??!1,blockDuration:t.blockDuration||3600,enableLogging:t.enableLogging??!0,logRetention:t.logRetention||30,signatures:Array.isArray(t.signatures)?t.signatures:[],blockedIPs:Array.isArray(t.blockedIPs)?t.blockedIPs:[]},this.routingEngine.initializeConfig(e),this.updateMetricsFromStats()}processPacket(e){const t=performance.now(),s={source:e.source,destination:e.destination,protocol:e.protocol,port:e.port,sourcePort:e.sourcePort,payload:e.payload,timestamp:Date.now()},n=this.routingEngine.processPacket(s),i=performance.now()-t+n.latency;this.recordLatency(i),this.metrics.packetsTotal++,n.alertGenerated&&this.metrics.alertsGenerated++,n.blocked&&this.metrics.alertsBlocked++;const a=Date.now();return this.firstPacketTime||(this.firstPacketTime=a),this.lastPacketTime=a,this.updateMetricsFromStats(),{success:n.allowed,blocked:n.blocked,latency:i,alertGenerated:n.alertGenerated,error:n.error}}simulatePackets(e){const t=Date.now(),s=t-this.lastSimulationTime;if(this.lastSimulationTime=t,s<=0||e<=0)return;const n=Math.floor(e*s/1e3);if(n!==0){for(let i=0;i<n;i++){const a=this.generateRandomPacket();this.processPacket(a)}this.updateMetricsFromStats()}}generateRandomPacket(){const e=["tcp","udp","icmp"],t=e[Math.floor(Math.random()*e.length)],s=`${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`,n=`10.0.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`,i=t==="icmp"?void 0:Math.floor(Math.random()*65535),a=t==="icmp"?void 0:Math.floor(Math.random()*65535),o=Math.random()<.05;let l;if(o){const d=["SELECT * FROM users WHERE id = 1 OR 1=1",'<script>alert("XSS")<\/script>',"DROP TABLE users","UNION SELECT password FROM users","../../../etc/passwd","eval(base64_decode("];l=d[Math.floor(Math.random()*d.length)]}else Math.random()<.3&&(l=`GET /api/data HTTP/1.1\r
Host: example.com\r
User-Agent: Mozilla/5.0`);return{source:s,destination:n,protocol:t,port:i,sourcePort:a,payload:l}}generateRandomIP(){return`${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`}recordLatency(e){this.latencyHistory.push(e),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift();const t=this.latencyHistory.reduce((s,n)=>s+n,0);this.metrics.averageLatency=t/this.latencyHistory.length}updateMetricsFromStats(){const e=this.routingEngine.getStats();this.metrics.packetsTotal=e.totalPackets,this.metrics.packetsAnalyzed=e.packetsAnalyzed,this.metrics.alertsGenerated=e.alertsGenerated,this.metrics.alertsBlocked=e.alertsBlocked,this.metrics.signatureMatches=e.signatureMatches,this.metrics.anomalyDetections=e.anomalyDetections,this.metrics.behavioralDetections=e.behavioralDetections,this.metrics.activeSignatures=e.activeSignatures,this.metrics.blockedIPs=e.blockedIPs}calculateLoad(){let e=0;if(this.firstPacketTime&&this.lastPacketTime&&this.lastPacketTime>this.firstPacketTime){const a=(this.lastPacketTime-this.firstPacketTime)/1e3;a>0&&(e=this.metrics.packetsTotal/a)}e===0&&this.simulatedPacketRate>0&&(e=this.simulatedPacketRate);const t=this.metrics.averageLatency||5,s=this.config?.mode==="ips"&&this.metrics.packetsTotal>0?this.metrics.alertsBlocked/this.metrics.packetsTotal:0,n=this.metrics.packetsTotal>0?this.metrics.alertsBlocked/this.metrics.packetsTotal:0,i=this.metrics.packetsTotal>0?this.metrics.alertsGenerated/this.metrics.packetsTotal:0;return{packetsPerSecond:e,averageLatency:t,errorRate:s,blockRate:n,alertRate:i}}getMetrics(){return{...this.metrics}}getConfig(){return this.config}getAlerts(e=100){return this.routingEngine.getAlerts(e)}getStats(){return this.routingEngine.getStats()}getBlockedIPs(){return this.routingEngine.getBlockedIPs()}unblockIP(e){this.routingEngine.unblockIP(e),this.updateMetricsFromStats()}setSimulatedPacketRate(e){this.simulatedPacketRate=e}resetMetrics(){this.metrics={packetsTotal:0,packetsAnalyzed:0,alertsGenerated:0,alertsBlocked:0,signatureMatches:0,anomalyDetections:0,behavioralDetections:0,activeSignatures:this.metrics.activeSignatures,blockedIPs:this.metrics.blockedIPs,averageLatency:0},this.latencyHistory=[],this.firstPacketTime=null,this.lastPacketTime=null,this.routingEngine.resetStats()}}class Lk{config=null;metrics={readRequestsTotal:0,writeRequestsTotal:0,deleteRequestsTotal:0,listRequestsTotal:0,authRequestsTotal:0,authErrorsTotal:0,tokenIssuedTotal:0,tokenRenewedTotal:0,tokenRevokedTotal:0,encryptionOperationsTotal:0,decryptionOperationsTotal:0,activeTokens:0,secretsTotal:0};tokens=new Map;secrets=new Map;firstRequestTime=null;lastRequestTime=null;latencyHistory=[];MAX_LATENCY_HISTORY=200;initializeConfig(e){const t=e.data.config||{},s=Array.isArray(t.secrets)?t.secrets.map(o=>({id:String(o.id??`secret-${Date.now()}`),path:String(o.path??"secret/default"),key:String(o.key??"key"),value:String(o.value??""),version:Number(o.version??1),created:o.created?String(o.created):new Date().toISOString(),updated:o.updated?String(o.updated):new Date().toISOString(),visible:o.visible??!1})):[],n=Array.isArray(t.engines)?t.engines.map(o=>({id:String(o.id??`engine-${Date.now()}`),name:String(o.name??"secret/"),type:o.type??"kv",enabled:o.enabled??!0,version:o.version?Number(o.version):void 0,description:o.description?String(o.description):void 0})):[{id:"1",name:"secret/",type:"kv",enabled:t.enableKV??!0,version:t.kvVersion==="1"?1:2,description:"Key-Value secrets"}],i=Array.isArray(t.policies)?t.policies.map(o=>({id:String(o.id??`policy-${Date.now()}`),name:String(o.name??"default"),rules:String(o.rules??'path "*" { capabilities = ["read"] }'),enabled:o.enabled??!0})):[{id:"1",name:"default",rules:'path "*" { capabilities = ["read", "list"] }',enabled:!0}],a=String(t.tokenTTL||"24h");this.parseTTL(a),this.config={vaultType:t.vaultType||"hashicorp",address:String(t.address||"http://vault:8200"),enableTLS:t.enableTLS??!1,enableTransit:t.enableTransit??!0,enableKV:t.enableKV??!0,kvVersion:String(t.kvVersion||"2"),enablePKI:t.enablePKI??!1,enableAuth:t.enableAuth??!0,authMethod:t.authMethod||"token",tokenTTL:a,secrets:s,engines:n,policies:i},this.secrets.clear(),s.forEach(o=>{this.secrets.set(o.id,o)}),this.metrics.secretsTotal=s.length,this.cleanupExpiredTokens(Date.now())}processReadRequest(e,t,s){const n=Date.now();this.firstRequestTime??=n,this.lastRequestTime=n,this.cleanupExpiredTokens(n);const i=this.config;if(!i)return this.recordLatency(50),this.metrics.readRequestsTotal++,{success:!1,latency:50,error:"Vault not configured"};if(i.enableAuth&&s&&!this.validateToken(s,n))return this.recordLatency(30),this.metrics.readRequestsTotal++,this.metrics.authErrorsTotal++,{success:!1,latency:30,error:"Invalid or expired token"};const a=Array.from(this.secrets.values()).find(h=>h.path===e&&(!t||h.key===t)),o=15,l=(Math.random()-.5)*10,d=Math.max(5,o+l);return this.recordLatency(d),this.metrics.readRequestsTotal++,a?{success:!0,latency:d,data:{[a.key]:a.value,version:a.version}}:{success:!1,latency:d,error:`Secret not found at path: ${e}`}}processWriteRequest(e,t,s){const n=Date.now();this.firstRequestTime??=n,this.lastRequestTime=n,this.cleanupExpiredTokens(n);const i=this.config;if(!i)return this.recordLatency(60),this.metrics.writeRequestsTotal++,{success:!1,latency:60,error:"Vault not configured"};if(i.enableAuth&&s&&!this.validateToken(s,n))return this.recordLatency(30),this.metrics.writeRequestsTotal++,this.metrics.authErrorsTotal++,{success:!1,latency:30,error:"Invalid or expired token"};if(!i.enableKV)return this.recordLatency(20),this.metrics.writeRequestsTotal++,{success:!1,latency:20,error:"KV engine is not enabled"};const a=25,o=(Math.random()-.5)*15,l=Math.max(10,a+o);this.recordLatency(l),this.metrics.writeRequestsTotal++;const d=Array.from(this.secrets.values()).find(h=>h.path===e&&h.key===Object.keys(t)[0]);if(d)d.value=Object.values(t)[0],d.version=(d.version||1)+1,d.updated=new Date().toISOString(),this.secrets.set(d.id,d);else{const h={id:`secret-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,path:e,key:Object.keys(t)[0],value:Object.values(t)[0],version:1,created:new Date().toISOString(),updated:new Date().toISOString(),visible:!1};this.secrets.set(h.id,h),this.metrics.secretsTotal=this.secrets.size}return{success:!0,latency:l,data:{path:e,version:d?.version||1}}}processDeleteRequest(e,t){const s=Date.now();this.firstRequestTime??=s,this.lastRequestTime=s,this.cleanupExpiredTokens(s);const n=this.config;if(!n)return this.recordLatency(50),this.metrics.deleteRequestsTotal++,{success:!1,latency:50,error:"Vault not configured"};if(n.enableAuth&&t&&!this.validateToken(t,s))return this.recordLatency(30),this.metrics.deleteRequestsTotal++,this.metrics.authErrorsTotal++,{success:!1,latency:30,error:"Invalid or expired token"};const i=20,a=(Math.random()-.5)*10,o=Math.max(8,i+a);this.recordLatency(o),this.metrics.deleteRequestsTotal++;const l=Array.from(this.secrets.values()).find(d=>d.path===e);return l?(this.secrets.delete(l.id),this.metrics.secretsTotal=this.secrets.size,{success:!0,latency:o}):{success:!1,latency:o,error:`Secret not found at path: ${e}`}}processAuthRequest(e,t){const s=Date.now();this.firstRequestTime??=s,this.lastRequestTime=s,this.cleanupExpiredTokens(s);const n=this.config;if(!n)return this.recordLatency(50),this.metrics.authRequestsTotal++,this.metrics.authErrorsTotal++,{success:!1,latency:50,error:"Vault not configured"};if(!n.enableAuth)return this.recordLatency(20),this.metrics.authRequestsTotal++,{success:!1,latency:20,error:"Authentication is not enabled"};let i=40;e==="ldap"?i=80:e==="approle"?i=50:e==="aws"&&(i=60);const a=(Math.random()-.5)*20,o=Math.max(15,i+a);this.recordLatency(o),this.metrics.authRequestsTotal++;const l=this.parseTTL(n.tokenTTL),d=`vault-token-${Date.now()}-${Math.random().toString(36).slice(2,10)}`,h={id:d,token:d,policies:n.policies.filter(p=>p.enabled).map(p=>p.name),ttl:l,renewable:!0,createdAt:s,expiresAt:s+l*1e3};return this.tokens.set(d,h),this.metrics.tokenIssuedTotal++,this.metrics.activeTokens=this.tokens.size,{success:!0,latency:o,token:d,policies:h.policies}}processEncryptRequest(e,t="default",s){const n=Date.now();this.firstRequestTime??=n,this.lastRequestTime=n,this.cleanupExpiredTokens(n);const i=this.config;if(!i)return this.recordLatency(50),this.metrics.encryptionOperationsTotal++,{success:!1,latency:50,error:"Vault not configured"};if(!i.enableTransit)return this.recordLatency(20),this.metrics.encryptionOperationsTotal++,{success:!1,latency:20,error:"Transit engine is not enabled"};if(i.enableAuth&&s&&!this.validateToken(s,n))return this.recordLatency(30),this.metrics.encryptionOperationsTotal++,this.metrics.authErrorsTotal++,{success:!1,latency:30,error:"Invalid or expired token"};const a=e.length,o=30+Math.min(100,a/100),l=(Math.random()-.5)*15,d=Math.max(15,o+l);this.recordLatency(d),this.metrics.encryptionOperationsTotal++;const h=Buffer.from(e).toString("base64");return{success:!0,latency:d,data:{ciphertext:`vault:v1:${h}`,key:t}}}processDecryptRequest(e,t="default",s){const n=Date.now();this.firstRequestTime??=n,this.lastRequestTime=n,this.cleanupExpiredTokens(n);const i=this.config;if(!i)return this.recordLatency(50),this.metrics.decryptionOperationsTotal++,{success:!1,latency:50,error:"Vault not configured"};if(!i.enableTransit)return this.recordLatency(20),this.metrics.decryptionOperationsTotal++,{success:!1,latency:20,error:"Transit engine is not enabled"};if(i.enableAuth&&s&&!this.validateToken(s,n))return this.recordLatency(30),this.metrics.decryptionOperationsTotal++,this.metrics.authErrorsTotal++,{success:!1,latency:30,error:"Invalid or expired token"};const a=25+Math.min(80,e.length/150),o=(Math.random()-.5)*12,l=Math.max(12,a+o);this.recordLatency(l),this.metrics.decryptionOperationsTotal++;const d=e.replace(/^vault:v1:/,"");let h;try{h=Buffer.from(d,"base64").toString("utf-8")}catch{return{success:!1,latency:l,error:"Invalid ciphertext format"}}return{success:!0,latency:l,data:{plaintext:h,key:t}}}calculateLoad(){const e=this.metrics,t=e.readRequestsTotal+e.writeRequestsTotal+e.deleteRequestsTotal+e.listRequestsTotal+e.authRequestsTotal+e.encryptionOperationsTotal+e.decryptionOperationsTotal,s=t>0?Math.min(1,e.authErrorsTotal/t):0,n=this.latencyHistory.length>0?this.latencyHistory.reduce((o,l)=>o+l,0)/this.latencyHistory.length:0;let i=0;if(this.firstRequestTime&&this.lastRequestTime&&this.lastRequestTime>this.firstRequestTime){const o=(this.lastRequestTime-this.firstRequestTime)/1e3;i=t/Math.max(o,1)}const a=this.config?.engines.filter(o=>o.enabled).length||0;return{requestsPerSecond:i,averageLatency:n,errorRate:s,activeTokens:this.metrics.activeTokens,secretsCount:this.metrics.secretsTotal,enginesEnabled:a}}getMetrics(){return{...this.metrics}}getConfig(){return this.config?{...this.config}:null}getSecrets(){return Array.from(this.secrets.values())}getActiveTokens(){const e=Date.now();return this.cleanupExpiredTokens(e),Array.from(this.tokens.values())}parseTTL(e){const t=e.match(/^(\d+)([smhd])$/);if(!t)return 86400;const s=parseInt(t[1],10);switch(t[2]){case"s":return s;case"m":return s*60;case"h":return s*3600;case"d":return s*86400;default:return 86400}}validateToken(e,t){const s=this.tokens.get(e);return s?t>s.expiresAt?(this.tokens.delete(e),this.metrics.activeTokens=this.tokens.size,!1):!0:!1}recordLatency(e){this.latencyHistory.push(e),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift()}cleanupExpiredTokens(e){let t=0;for(const[s,n]of this.tokens.entries())e>n.expiresAt&&(this.tokens.delete(s),t++);t>0&&(this.metrics.tokenRevokedTotal+=t,this.metrics.activeTokens=this.tokens.size)}}class _k{config=null;connections=new Map;tunnels=new Map;stats={totalConnections:0,activeConnections:0,totalTunnels:0,activeTunnels:0,totalBytesIn:0,totalBytesOut:0,totalPacketsIn:0,totalPacketsOut:0,encryptionOperations:0,compressionOperations:0,failedConnections:0,averageLatency:0};latencyHistory=[];MAX_LATENCY_HISTORY=200;CONNECTION_TIMEOUT_MS=3e5;initializeConfig(e){const t=e.data.config||{};if(this.config={vpnProtocol:t.vpnProtocol||"openvpn",encryptionAlgorithm:t.encryptionAlgorithm||"aes-256",enableCompression:t.enableCompression??!0,enableKeepAlive:t.enableKeepAlive??!0,maxConnections:t.maxConnections||1e3,connectionTimeout:t.connectionTimeout||300,enableSSL:t.enableSSL??!0,sslPort:t.sslPort||443,enableIPSec:t.enableIPSec??!0,ipsecPort:t.ipsecPort||500,enableL2TP:t.enableL2TP??!1,enablePPTP:t.enablePPTP??!1,enableRadius:t.enableRadius??!1,radiusServer:t.radiusServer||"",enableMFA:t.enableMFA??!1,mfaProvider:t.mfaProvider||"totp",connections:Array.isArray(t.connections)?t.connections:[],tunnels:Array.isArray(t.tunnels)?t.tunnels:[]},this.connections.clear(),this.config.connections)for(const s of this.config.connections)s.id&&this.connections.set(s.id,{...s,bytesIn:s.bytesIn||0,bytesOut:s.bytesOut||0,packetsIn:s.packetsIn||0,packetsOut:s.packetsOut||0,protocol:s.protocol||this.config.vpnProtocol||"openvpn",encryptionAlgorithm:s.encryptionAlgorithm||this.config.encryptionAlgorithm,compressionEnabled:s.compressionEnabled??this.config.enableCompression,lastActivity:s.lastActivity||Date.now()});if(this.tunnels.clear(),this.config.tunnels)for(const s of this.config.tunnels)s.id&&this.tunnels.set(s.id,{...s,bytesIn:s.bytesIn||0,bytesOut:s.bytesOut||0,packetsIn:s.packetsIn||0,packetsOut:s.packetsOut||0,protocol:s.protocol||this.config.vpnProtocol||"openvpn",encryptionAlgorithm:s.encryptionAlgorithm||this.config.encryptionAlgorithm,compressionEnabled:s.compressionEnabled??this.config.enableCompression,keepAliveEnabled:s.keepAliveEnabled??this.config.enableKeepAlive,keepAliveInterval:s.keepAliveInterval||30,connections:s.connections||[],lastActivity:s.lastActivity||Date.now()});this.updateStats()}processPacket(e){performance.now();const t=e.timestamp||Date.now();let s,n;if(e.connectionId)s=this.connections.get(e.connectionId);else if(e.tunnelId)n=this.tunnels.get(e.tunnelId);else for(const h of this.connections.values())if(h.remoteIP===e.source&&h.status==="connected"){s=h;break}if(!s&&!n){const h=this.calculateEncryptionLatency(this.config?.encryptionAlgorithm||"aes-256");return this.recordLatency(h),{success:!1,encrypted:!1,latency:h,error:"No active VPN connection or tunnel found",bytesProcessed:0}}const i=!e.encrypted&&s?.status==="connected",a=!!(e.encrypted&&s?.status==="connected");let o=0,l=0;(i||a)&&(o+=this.calculateEncryptionLatency(s?.encryptionAlgorithm||n?.encryptionAlgorithm||this.config?.encryptionAlgorithm||"aes-256"),this.stats.encryptionOperations++),(s?.compressionEnabled||n?.compressionEnabled||this.config?.enableCompression)&&(o+=this.calculateCompressionLatency(),this.stats.compressionOperations++);const d=this.estimatePacketSize(e);return l=d,s&&(i||a?(s.bytesIn+=d,s.packetsIn++,this.stats.totalBytesIn+=d,this.stats.totalPacketsIn++):(s.bytesOut+=d,s.packetsOut++,this.stats.totalBytesOut+=d,this.stats.totalPacketsOut++),s.lastActivity=t),n&&(i||a?(n.bytesIn+=d,n.packetsIn++):(n.bytesOut+=d,n.packetsOut++),n.lastActivity=t),this.recordLatency(o),this.updateStats(),{success:!0,encrypted:!!(i||e.encrypted&&a),latency:o,connectionId:s?.id,tunnelId:n?.id,bytesProcessed:l}}createConnection(e){if(this.connections.size>=(this.config?.maxConnections||1e3))throw this.stats.failedConnections++,new Error("Maximum connections reached");this.connections.set(e.id,{...e,bytesIn:e.bytesIn||0,bytesOut:e.bytesOut||0,packetsIn:e.packetsIn||0,packetsOut:e.packetsOut||0,protocol:e.protocol||this.config?.vpnProtocol||"openvpn",encryptionAlgorithm:e.encryptionAlgorithm||this.config?.encryptionAlgorithm,compressionEnabled:e.compressionEnabled??this.config?.enableCompression??!0,lastActivity:e.lastActivity||Date.now()}),this.stats.totalConnections++,this.updateStats()}updateConnectionStatus(e,t){const s=this.connections.get(e);s&&(s.status=t,t==="connected"&&(s.connectedAt=s.connectedAt||Date.now()),this.updateStats())}removeConnection(e){this.connections.delete(e)&&this.updateStats()}createTunnel(e){this.tunnels.set(e.id,{...e,bytesIn:e.bytesIn||0,bytesOut:e.bytesOut||0,packetsIn:e.packetsIn||0,packetsOut:e.packetsOut||0,protocol:e.protocol||this.config?.vpnProtocol||"openvpn",encryptionAlgorithm:e.encryptionAlgorithm||this.config?.encryptionAlgorithm,compressionEnabled:e.compressionEnabled??this.config?.enableCompression,keepAliveEnabled:e.keepAliveEnabled??this.config?.enableKeepAlive,keepAliveInterval:e.keepAliveInterval||30,connections:e.connections||[],lastActivity:e.lastActivity||Date.now()}),this.stats.totalTunnels++,this.updateStats()}updateTunnelStatus(e,t){const s=this.tunnels.get(e);s&&(s.status=t,this.updateStats())}removeTunnel(e){this.tunnels.delete(e)&&this.updateStats()}getConnections(){return Array.from(this.connections.values())}getTunnels(){return Array.from(this.tunnels.values())}getStats(){return{...this.stats}}getConfig(){return this.config?{...this.config}:null}calculateEncryptionLatency(e){switch(e){case"aes-128":return .5+Math.random()*.5;case"aes-256":return .8+Math.random()*.7;case"chacha20-poly1305":return .6+Math.random()*.6;default:return 1+Math.random()*1}}calculateCompressionLatency(){return .2+Math.random()*.3}estimatePacketSize(e){if(e.payload){if(typeof e.payload=="string")return Buffer.byteLength(e.payload,"utf8");if(typeof e.payload=="object")return Buffer.byteLength(JSON.stringify(e.payload),"utf8")}return 1500}recordLatency(e){this.latencyHistory.push(e),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift();const t=this.latencyHistory.reduce((s,n)=>s+n,0);this.stats.averageLatency=t/this.latencyHistory.length}updateStats(){this.stats.activeConnections=Array.from(this.connections.values()).filter(i=>i.status==="connected").length,this.stats.activeTunnels=Array.from(this.tunnels.values()).filter(i=>i.status==="up").length;let e=0,t=0,s=0,n=0;for(const i of this.connections.values())e+=i.bytesIn,t+=i.bytesOut,s+=i.packetsIn,n+=i.packetsOut;for(const i of this.tunnels.values())e+=i.bytesIn,t+=i.bytesOut,s+=i.packetsIn,n+=i.packetsOut;this.stats.totalBytesIn=e,this.stats.totalBytesOut=t,this.stats.totalPacketsIn=s,this.stats.totalPacketsOut=n}cleanupStaleConnections(){const e=(this.config?.connectionTimeout||300)*1e3,t=Date.now();for(const[s,n]of this.connections.entries())n.status==="connected"&&n.lastActivity&&t-n.lastActivity>e&&(n.status="disconnected",this.updateStats())}}class Ik{config=null;routingEngine;metrics={totalConnections:0,activeConnections:0,totalTunnels:0,activeTunnels:0,totalBytesIn:0,totalBytesOut:0,totalPacketsIn:0,totalPacketsOut:0,encryptionOperations:0,compressionOperations:0,failedConnections:0,averageLatency:0};firstPacketTime=null;lastPacketTime=null;packetCount=0;byteCount=0;connectionCount=0;lastConnectionTime=null;simulatedPacketRate=0;simulatedConnectionRate=0;lastSimulationTime=Date.now();constructor(){this.routingEngine=new _k}initializeConfig(e){const t=e.data.config||{};this.config={vpnProtocol:t.vpnProtocol||"openvpn",encryptionAlgorithm:t.encryptionAlgorithm||"aes-256",enableCompression:t.enableCompression??!0,enableKeepAlive:t.enableKeepAlive??!0,maxConnections:t.maxConnections||1e3,connectionTimeout:t.connectionTimeout||300,enableSSL:t.enableSSL??!0,sslPort:t.sslPort||443,enableIPSec:t.enableIPSec??!0,ipsecPort:t.ipsecPort||500,enableL2TP:t.enableL2TP??!1,enablePPTP:t.enablePPTP??!1,enableRadius:t.enableRadius??!1,radiusServer:t.radiusServer||"",enableMFA:t.enableMFA??!1,mfaProvider:t.mfaProvider||"totp",connections:Array.isArray(t.connections)?t.connections:[],tunnels:Array.isArray(t.tunnels)?t.tunnels:[]},this.routingEngine.initializeConfig(e),this.updateMetricsFromStats()}processPacket(e){performance.now();const t={source:e.source,destination:e.destination,protocol:e.protocol,port:e.port,sourcePort:e.sourcePort,payload:e.payload,encrypted:e.encrypted,connectionId:e.connectionId,tunnelId:e.tunnelId,timestamp:Date.now()},s=this.routingEngine.processPacket(t),n=Date.now();return this.firstPacketTime||(this.firstPacketTime=n),this.lastPacketTime=n,this.packetCount++,this.byteCount+=s.bytesProcessed,this.updateMetricsFromStats(),{success:s.success,encrypted:s.encrypted,latency:s.latency,error:s.error,bytesProcessed:s.bytesProcessed}}createConnection(e){try{this.routingEngine.createConnection(e),this.connectionCount++,this.lastConnectionTime=Date.now(),this.updateMetricsFromStats()}catch(t){throw this.metrics.failedConnections++,t}}updateConnectionStatus(e,t){this.routingEngine.updateConnectionStatus(e,t),this.updateMetricsFromStats()}removeConnection(e){this.routingEngine.removeConnection(e),this.updateMetricsFromStats()}createTunnel(e){this.routingEngine.createTunnel(e),this.updateMetricsFromStats()}updateTunnelStatus(e,t){this.routingEngine.updateTunnelStatus(e,t),this.updateMetricsFromStats()}removeTunnel(e){this.routingEngine.removeTunnel(e),this.updateMetricsFromStats()}getConnections(){return this.routingEngine.getConnections()}getTunnels(){return this.routingEngine.getTunnels()}getConfig(){return this.config?{...this.config}:null}getMetrics(){return{...this.metrics}}getRoutingEngine(){return this.routingEngine}calculateLoad(){const e=Date.now(),t=1e3;let s=0,n=0,i=0;if(this.firstPacketTime&&this.lastPacketTime){const b=(this.lastPacketTime-this.firstPacketTime)/1e3;b>0&&(s=this.packetCount/b,n=this.byteCount/b)}if(this.lastConnectionTime){const b=(e-this.lastConnectionTime)/1e3;b>0&&b<t&&(i=this.connectionCount/b)}s===0&&(s=this.simulatedPacketRate),n===0&&(n=s*1500),i===0&&(i=this.simulatedConnectionRate);const a=this.config?.maxConnections||1e3,o=Math.min(1,this.metrics.activeConnections/a),l=this.metrics.activeTunnels>0?.3:0,d=Math.min(.5,n/(100*1024*1024)),h=Math.min(.2,this.metrics.encryptionOperations/1e4),p=Math.min(.95,.1+o*.4+l+d+h),g=this.metrics.totalConnections+this.metrics.failedConnections,v=g>0?this.metrics.failedConnections/g:0;return{connectionsPerSecond:i,packetsPerSecond:s,bytesPerSecond:n,averageLatency:this.metrics.averageLatency,errorRate:v,utilization:p}}updateMetricsFromStats(){const e=this.routingEngine.getStats();this.metrics={totalConnections:e.totalConnections,activeConnections:e.activeConnections,totalTunnels:e.totalTunnels,activeTunnels:e.activeTunnels,totalBytesIn:e.totalBytesIn,totalBytesOut:e.totalBytesOut,totalPacketsIn:e.totalPacketsIn,totalPacketsOut:e.totalPacketsOut,encryptionOperations:e.encryptionOperations,compressionOperations:e.compressionOperations,failedConnections:e.failedConnections,averageLatency:e.averageLatency}}simulateIncomingTraffic(e,t){this.simulatedPacketRate=e,this.simulatedConnectionRate=t,this.lastSimulationTime=Date.now()}cleanupStaleConnections(){this.routingEngine.cleanupStaleConnections(),this.updateMetricsFromStats()}}class Nk{distributions=new Map;edgeLocations=new Map;cache=new Map;stats;requestHistory=[];MAX_CACHE_SIZE=1e3;MAX_HISTORY_SIZE=1e3;constructor(){this.stats={totalRequests:0,totalCacheHits:0,totalCacheMisses:0,totalBandwidth:0,totalErrors:0,averageLatency:0,averageCacheHitRate:0,requestsPerSecond:0,bandwidthPerSecond:0,errorRate:0,distributions:new Map,edgeLocations:new Map}}initializeConfig(e){const t=e.data.config||{},s=t.distributions||[];this.distributions.clear();for(const i of s)this.distributions.set(i.id,{id:i.id,domain:i.domain,origin:i.origin,status:i.status||"deployed",edgeLocations:i.edgeLocations||0,cachePolicy:i.cachePolicy||t.cachePolicy||"cache-first",defaultTTL:i.defaultTTL||t.defaultTTL||3600,maxTTL:i.maxTTL||t.maxTTL||86400,enableCompression:i.enableCompression??t.enableCompression??!0,compressionType:i.compressionType||t.compressionType||"gzip",enableHTTP2:i.enableHTTP2??t.enableHTTP2??!0,enableHTTP3:i.enableHTTP3??t.enableHTTP3??!1,enableHTTPS:i.enableHTTPS??t.enableHTTPS??!0,enableGeoRouting:i.enableGeoRouting??t.enableGeoRouting??!1,enableDDoSProtection:i.enableDDoSProtection??t.enableDDoSProtection??!0});const n=t.edgeLocations||[];this.edgeLocations.clear();for(const i of n)this.edgeLocations.set(i.id,{id:i.id,region:i.region,city:i.city,status:i.status||"active",capacity:i.capacity||1e4,latency:i.latency||50});for(const i of this.distributions.keys())this.stats.distributions.set(i,{requests:0,cacheHits:0,cacheMisses:0,bandwidth:0,errors:0});for(const i of this.edgeLocations.keys())this.stats.edgeLocations.set(i,{requests:0,cacheHits:0,bandwidth:0,latency:0})}processRequest(e){const t=Date.now();this.stats.totalRequests++;const s=Array.from(this.distributions.values()).find(h=>h.domain===e.domain&&h.status==="deployed");if(!s)return this.stats.totalErrors++,{status:404,headers:{},cacheHit:!1,servedFrom:"origin",latency:Date.now()-t,size:0};const n=this.stats.distributions.get(s.id);n&&n.requests++;const i=this.selectEdgeLocation(e,s);if(i){const h=this.stats.edgeLocations.get(i.id);h&&h.requests++}let a=!1,o;if(e.method==="GET"&&s.cachePolicy!=="bypass"){const h=this.getCacheKey(e,s);if(o=this.cache.get(h),o&&o.expiresAt>Date.now()){if(a=!0,this.stats.totalCacheHits++,o.hitCount++,o.lastAccessed=Date.now(),n&&n.cacheHits++,i){const p=this.stats.edgeLocations.get(i.id);p&&p.cacheHits++}}else this.stats.totalCacheMisses++,n&&n.cacheMisses++}let l=0;a&&o?l=i?.latency?i.latency*.1:5:(l=i?.latency?i.latency*2:100,l+=50+Math.random()*50);let d=o?.size||1024;if(s.enableCompression&&e.method==="GET"){const h=.3+Math.random()*.2;d=Math.floor(d*h)}if(this.stats.totalBandwidth+=d,n&&(n.bandwidth+=d),i){const h=this.stats.edgeLocations.get(i.id);h&&(h.bandwidth+=d)}if(!a&&e.method==="GET"&&s.cachePolicy!=="bypass"){const h=this.getCacheKey(e,s),p=s.defaultTTL||3600;this.cache.set(h,{key:h,data:{status:200,body:"cached"},headers:{"content-type":"application/json"},expiresAt:Date.now()+p*1e3,size:d,hitCount:0,lastAccessed:Date.now()}),this.cache.size>this.MAX_CACHE_SIZE&&this.evictCacheEntries()}return this.requestHistory.push({timestamp:Date.now(),size:d}),this.requestHistory.length>this.MAX_HISTORY_SIZE&&this.requestHistory.shift(),this.updateStats(),{status:200,headers:{"content-type":"application/json","cache-control":`max-age=${s.defaultTTL||3600}`,"x-cache":a?"HIT":"MISS","x-edge-location":i?.city||"unknown"},body:a?o?.data:{status:"ok"},cacheHit:a,servedFrom:a?"cache":"origin",edgeLocation:i?.city,latency:l,size:d}}selectEdgeLocation(e,t){const s=Array.from(this.edgeLocations.values()).filter(n=>n.status==="active");if(s.length!==0){if(t.enableGeoRouting&&e.clientIP){const n=this.hashString(e.clientIP);return s[n%s.length]}return s.reduce((n,i)=>(i.latency||50)<(n.latency||50)?i:n)}}getCacheKey(e,t){const s=e.query?"?"+Object.entries(e.query).sort().map(([n,i])=>`${n}=${i}`).join("&"):"";return`${t.id}:${e.method}:${e.path}${s}`}evictCacheEntries(){const e=Array.from(this.cache.entries());e.sort((s,n)=>s[1].lastAccessed-n[1].lastAccessed);const t=Math.floor(e.length*.1);for(let s=0;s<t;s++)this.cache.delete(e[s][0])}updateStats(){const e=this.stats.totalCacheHits+this.stats.totalCacheMisses;this.stats.averageCacheHitRate=e>0?this.stats.totalCacheHits/e:0,this.stats.averageLatency=50;const s=Date.now()-1e3,n=this.requestHistory.filter(a=>a.timestamp>s);this.stats.requestsPerSecond=n.length;const i=n.reduce((a,o)=>a+o.size,0);this.stats.bandwidthPerSecond=i,this.stats.errorRate=this.stats.totalRequests>0?this.stats.totalErrors/this.stats.totalRequests:0}purgeCache(e,t){let s=0;if(e&&t){const n=`${e}:`;for(const[i,a]of this.cache.entries())i.startsWith(n)&&i.includes(t)&&(this.cache.delete(i),s++)}else if(e){const n=`${e}:`;for(const[i]of this.cache.entries())i.startsWith(n)&&(this.cache.delete(i),s++)}else s=this.cache.size,this.cache.clear();return s}getStats(){return{...this.stats}}getDistributions(){return Array.from(this.distributions.values())}getEdgeLocations(){return Array.from(this.edgeLocations.values())}hashString(e){let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t=t&t}return Math.abs(t)}}class zk{config=null;routingEngine;metrics={totalDistributions:0,activeDistributions:0,totalEdgeLocations:0,activeEdgeLocations:0,totalRequests:0,totalCacheHits:0,totalCacheMisses:0,totalBandwidth:0,averageCacheHitRate:0,averageLatency:0,requestsPerSecond:0,bandwidthPerSecond:0,errorRate:0};simulatedRequestRate=0;lastSimulationTime=Date.now();constructor(){this.routingEngine=new Nk}initializeConfig(e){const t=e.data.config||{};this.config={cdnProvider:t.cdnProvider||"cloudflare",distributions:Array.isArray(t.distributions)?t.distributions:[],edgeLocations:Array.isArray(t.edgeLocations)?t.edgeLocations:[],enableCaching:t.enableCaching??!0,cacheTTL:t.cacheTTL||3600,enableCompression:t.enableCompression??!0,compressionType:t.compressionType||"gzip",enableSSL:t.enableSSL??!0,enableHTTP2:t.enableHTTP2??!0,enableHTTP3:t.enableHTTP3??!1,enablePurge:t.enablePurge??!0,enableGeoRouting:t.enableGeoRouting??!1,enableDDoSProtection:t.enableDDoSProtection??!0,defaultTTL:t.defaultTTL||3600,maxTTL:t.maxTTL||86400,cachePolicy:t.cachePolicy||"cache-first"},this.routingEngine.initializeConfig(e),this.updateMetricsFromStats()}processRequest(e){const t=performance.now(),s={id:`req-${Date.now()}-${Math.random()}`,method:e.method,path:e.path,domain:e.domain,headers:e.headers,query:e.query,body:e.body,clientIP:e.clientIP,userAgent:e.userAgent,timestamp:Date.now()},n=this.routingEngine.processRequest(s);return performance.now()-t,this.updateMetricsFromStats(),{success:n.status<400,cacheHit:n.cacheHit,latency:n.latency,error:n.status>=400?`HTTP ${n.status}`:void 0,size:n.size}}getConfig(){return this.config?{...this.config}:null}getMetrics(){return{...this.metrics}}getRoutingEngine(){return this.routingEngine}calculateLoad(){const e=this.routingEngine.getStats(),t=this.routingEngine.getDistributions(),s=this.routingEngine.getEdgeLocations(),n=e.requestsPerSecond||this.simulatedRequestRate,i=e.bandwidthPerSecond||n*1024,a=e.averageLatency||50,o=e.errorRate||0,l=e.averageCacheHitRate||0,d=t.filter(T=>T.status==="deployed").length,h=t.length||1,p=d/h,g=s.filter(T=>T.status==="active").length,v=s.length||1,b=g/v,M=s.reduce((T,E)=>T+(E.capacity||1e4),0),x=M>0?Math.min(1,n/M):0,S=Math.min(.95,.1+p*.2+b*.2+x*.5);return{requestsPerSecond:n,bandwidthPerSecond:i,averageLatency:a,errorRate:o,utilization:S,cacheHitRate:l}}updateMetricsFromStats(){const e=this.routingEngine.getStats(),t=this.routingEngine.getDistributions(),s=this.routingEngine.getEdgeLocations();this.metrics={totalDistributions:t.length,activeDistributions:t.filter(n=>n.status==="deployed").length,totalEdgeLocations:s.length,activeEdgeLocations:s.filter(n=>n.status==="active").length,totalRequests:e.totalRequests,totalCacheHits:e.totalCacheHits,totalCacheMisses:e.totalCacheMisses,totalBandwidth:e.totalBandwidth,averageCacheHitRate:e.averageCacheHitRate,averageLatency:e.averageLatency,requestsPerSecond:e.requestsPerSecond,bandwidthPerSecond:e.bandwidthPerSecond,errorRate:e.errorRate}}simulateIncomingTraffic(e){if(this.simulatedRequestRate=e,this.lastSimulationTime=Date.now(),e>0){const s=this.routingEngine.getDistributions().filter(n=>n.status==="deployed");if(s.length>0){const n=e/s.length;for(const i of s){const a=Math.floor(n*.8);for(let l=0;l<a;l++)this.routingEngine.processRequest({id:`sim-${Date.now()}-${Math.random()}`,method:"GET",path:`/api/resource/${Math.floor(Math.random()*100)}`,domain:i.domain,timestamp:Date.now(),clientIP:`192.168.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`});const o=Math.floor(n*.2);for(let l=0;l<o;l++)this.routingEngine.processRequest({id:`sim-${Date.now()}-${Math.random()}`,method:"POST",path:"/api/update",domain:i.domain,timestamp:Date.now(),clientIP:`192.168.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`})}}}}purgeCache(e,t){return this.routingEngine.purgeCache(e,t)}getDistributions(){return this.routingEngine.getDistributions()}getEdgeLocations(){return this.routingEngine.getEdgeLocations()}}class jk{config=null;pipelines=new Map;activeBuilds=new Map;nodes=new Map;plugins=new Map;jenkinsMetrics={buildsTotal:0,buildsSuccess:0,buildsFailed:0,buildsRunning:0,buildsPending:0,buildsPerMinute:0,averageBuildDuration:0,executorUtilization:0,executorIdle:0,executorBusy:0,pipelinesTotal:0,pipelinesEnabled:0,nodesTotal:0,nodesOnline:0,pluginsTotal:0,pluginsActive:0,artifactStorageBytes:0,requestsTotal:0,requestsErrors:0};processRequest(e=!0){this.jenkinsMetrics.requestsTotal++,e||this.jenkinsMetrics.requestsErrors++}buildHistory=[];MAX_BUILD_HISTORY=1e3;lastBuildTrigger=new Map;buildTriggerCounter=0;artifacts=new Map;initializeConfig(e){const t=e.data.config||{};this.config={jenkinsUrl:t.jenkinsUrl||"http://jenkins:8080",enableCSRF:t.enableCSRF??!0,executorCount:t.executorCount||2,enablePlugins:t.enablePlugins??!0,plugins:t.plugins||["git","docker","kubernetes"],enablePipeline:t.enablePipeline??!0,enableBlueOcean:t.enableBlueOcean??!1,enableArtifactArchiving:t.enableArtifactArchiving??!0,retentionDays:t.retentionDays||30,pipelines:t.pipelines||[],nodes:t.nodes||[],buildTriggerRate:t.buildTriggerRate||.5,averageBuildDuration:t.averageBuildDuration||12e4,failureRate:t.failureRate||.1},this.initializePipelines(),this.initializeNodes(),this.initializePlugins()}initializePipelines(){if(this.pipelines.clear(),!this.config||!this.config.enablePipeline)return;const e=this.config.pipelines||[];for(const t of e){const s=t.lastBuild||0,n={id:t.id,name:t.name,status:"pending",lastBuild:s,lastSuccessfulBuild:void 0,lastFailedBuild:void 0,duration:void 0,branch:t.branch||"main",enabled:t.enabled!==!1,builds:[],nextBuildNumber:s+1};n.config={triggers:t.triggers||[],parameters:t.parameters||[],environmentVariables:t.environmentVariables||{},postBuildActions:t.postBuildActions||[]},this.pipelines.set(n.id,n)}}calculatePipelineStatus(e){return e.builds.length===0?Array.from(this.activeBuilds.values()).find(n=>n.pipelineId===e.id&&n.status==="running")?"running":"pending":e.builds[e.builds.length-1].status}initializeNodes(){this.nodes.clear();const e={id:"master",name:"master",status:"online",numExecutors:this.config?.executorCount||2,busyExecutors:0,idleExecutors:this.config?.executorCount||2,labels:["master"]};this.nodes.set("master",e);const t=this.config?.nodes||[];for(const s of t){const n={id:s.id,name:s.name,status:"online",numExecutors:s.numExecutors||1,busyExecutors:0,idleExecutors:s.numExecutors||1,labels:s.labels||[]};this.nodes.set(n.id,n)}}initializePlugins(){if(this.plugins.clear(),!this.config||!this.config.enablePlugins)return;const e={git:{version:"4.11.0",description:"Git integration plugin"},docker:{version:"1.2.9",description:"Docker pipeline plugin",dependencies:["workflow-aggregator"]},kubernetes:{version:"1.31.1",description:"Kubernetes plugin for dynamic agent provisioning"},"workflow-aggregator":{version:"2.6",description:"Pipeline plugin aggregator"},"blue-ocean":{version:"1.25.3",description:"Blue Ocean UI for Jenkins",dependencies:["workflow-aggregator"]},credentials:{version:"2.6.1",description:"Credentials management plugin"},"ssh-slaves":{version:"1.32.0",description:"SSH agent plugin"},junit:{version:"1.53",description:"JUnit test result publisher"},"maven-plugin":{version:"3.20",description:"Maven integration plugin"},gradle:{version:"1.36.1",description:"Gradle plugin"}},t=this.config.plugins||[];for(const s of t){let n,i=!0;typeof s=="string"?n=s:(n=s.name||s,i=s.enabled!==!1);const a=e[n]||{version:"1.0.0",description:`${n} plugin`},o={name:n,version:a.version,description:a.description,enabled:i,active:i,dependencies:a.dependencies};this.plugins.set(n,o)}this.updatePluginActiveStatus()}updatePluginActiveStatus(){for(const e of this.plugins.values()){if(!e.enabled){e.active=!1;continue}if(e.dependencies&&e.dependencies.length>0){const t=e.dependencies.every(s=>{const n=this.plugins.get(s);return n&&n.enabled&&n.active});e.active=t}else e.active=e.enabled}}addPlugin(e,t,s){if(this.plugins.has(e))return!1;const n={name:e,version:t||"1.0.0",description:s||`${e} plugin`,enabled:!0,active:!0};return this.plugins.set(e,n),this.updatePluginActiveStatus(),!0}removePlugin(e){if(!this.plugins.get(e))return{success:!1,reason:"Plugin not found"};const s=Array.from(this.plugins.values()).filter(n=>n.dependencies?.includes(e));return s.length>0?{success:!1,reason:`Cannot remove plugin. It is required by: ${s.map(n=>n.name).join(", ")}`}:(this.plugins.delete(e),this.updatePluginActiveStatus(),{success:!0})}setPluginEnabled(e,t){const s=this.plugins.get(e);return s?(s.enabled=t,this.updatePluginActiveStatus(),!0):!1}performUpdate(e){this.config&&(this.updateActiveBuilds(e),this.config.enablePipeline&&this.triggerBuilds(e),this.config.enableArtifactArchiving&&this.cleanupArtifacts(e),this.updateMetrics())}updateActiveBuilds(e){const t=Array.from(this.activeBuilds.entries());for(const[s,n]of t)if(n.status==="running")try{n.startTime&&(e-n.startTime)%5e3<100&&this.updateBuildLogs(n,e);const i=e-n.startTime,a=n.estimatedDuration||this.config?.averageBuildDuration||12e4;if(i<0)continue;if(n.progress=Math.min(100,Math.max(0,Math.floor(i/a*100))),i>=a){const o=Math.random()<(this.config?.failureRate||.1);if(n.status=o?"failed":"success",n.duration=i,n.progress=100,n.logs&&(o?(n.logs.push("[Pipeline] FAILED"),n.logs.push(`Build failed after ${(i/1e3).toFixed(1)}s`)):(n.logs.push("[Pipeline] SUCCESS"),n.logs.push(`Build completed successfully in ${(i/1e3).toFixed(1)}s`)),n.logs.push(`Finished: ${n.status}`)),n.stages)for(const d of n.stages)(d.status==="running"||d.status==="pending")&&(d.status=n.status,d.startTime&&(d.duration=e-d.startTime));this.executePostBuildActions(n,n.status==="success");const l=this.pipelines.get(n.pipelineId);l&&(l.lastBuild=n.number,n.status==="success"?l.lastSuccessfulBuild=n.number:n.status==="failed"&&(l.lastFailedBuild=n.number),l.duration=n.duration,l.builds.push(n),l.builds.length>50&&l.builds.shift(),l.status=this.calculatePipelineStatus(l)),this.freeExecutor(s),this.addBuildToHistory(n),this.activeBuilds.delete(s)}}catch(i){console.error(`Error updating build ${s}:`,i),n.status="failed",this.activeBuilds.delete(s),this.freeExecutor(s)}}triggerBuilds(e){if(!(!this.config||!this.config.enablePipeline))for(const[t,s]of this.pipelines.entries()){if(!s.enabled)continue;const i=(s.config||{}).triggers||[];let a=!1;if(i.length===0){const o=this.config.buildTriggerRate||0;if(o>0){const l=6e4/o,d=this.lastBuildTrigger.get(t)||0;e-d>=l&&(a=!0)}}else for(const o of i)if(o.enabled){if(o.type==="cron"&&o.config?.schedule)a=this.shouldTriggerCron(o.config.schedule,t,e);else if(o.type==="scm"&&o.config?.pollInterval){const l=o.config.pollInterval*60*1e3,d=this.lastBuildTrigger.get(`${t}-scm`)||0;e-d>=l&&(a=!0,this.lastBuildTrigger.set(`${t}-scm`,e))}}a&&this.hasAvailableExecutor()&&(this.startBuild(t,e),this.lastBuildTrigger.set(t,e))}}shouldTriggerCron(e,t,s){const n=this.lastBuildTrigger.get(`${t}-cron`)||0,i=60*1e3;return s-n>=i?(this.lastBuildTrigger.set(`${t}-cron`,s),!0):!1}triggerWebhook(e,t,s){const n=this.pipelines.get(e);if(!n)return{success:!1,reason:"Pipeline not found"};if(!n.enabled)return{success:!1,reason:"Pipeline is disabled"};const a=(n.config||{}).triggers||[],o=a.find(d=>d.type==="webhook"&&d.enabled);if(!o&&a.length>0)return{success:!1,reason:"Webhook trigger not configured or disabled"};if(o?.config?.branches&&t&&!o.config.branches.includes(t))return{success:!1,reason:`Branch ${t} not in allowed branches`};if(!this.hasAvailableExecutor())return{success:!1,reason:"No available executors"};const l=Date.now();return this.startBuild(e,l,{branch:t,commit:s,triggeredBy:"webhook"}),{success:!0}}triggerBuildManually(e){const t=this.pipelines.get(e);if(!t)return{success:!1,reason:"Pipeline not found"};if(!t.enabled)return{success:!1,reason:"Pipeline is disabled"};if(!this.hasAvailableExecutor())return{success:!1,reason:"No available executors"};const s=Date.now();return this.startBuild(e,s),{success:!0,buildId:`${e}-${t.nextBuildNumber-1}`}}startBuild(e,t,s){const n=this.pipelines.get(e);if(!n)return;const i=n.nextBuildNumber++,a=`${e}-${i}`,o=this.config?.averageBuildDuration||12e4,l=o*.3,d=o+(Math.random()*2-1)*l,h=this.generateBuildLogs(i,n.name,n.branch||"main"),p=this.generateArtifacts(n.name,i),g=n.config||{},v=s?.parameters||{},b=g.parameters||[],M={};for(const T of b)T.defaultValue!==void 0&&(M[T.name]=T.defaultValue);Object.assign(M,v);const x={...g.environmentVariables||{},...M},S={id:a,number:i,pipelineId:e,status:"running",startTime:t,estimatedDuration:d,progress:0,branch:s?.branch||n.branch,commit:s?.commit,logs:h,artifacts:p.map(T=>T.name),triggeredBy:s?.triggeredBy||"system",stages:[{name:"Checkout",status:"running",startTime:t},{name:"Build",status:"pending"},{name:"Test",status:"pending"},{name:"Deploy",status:"pending"}]};S.parameters=M,S.environmentVariables=x,S.postBuildActions=g.postBuildActions||[];for(const T of p)this.artifacts.set(`${a}-${T.name}`,{size:T.size,created:t});this.activeBuilds.set(a,S),n.status=this.calculatePipelineStatus(n),this.allocateExecutor(a),this.jenkinsMetrics.buildsTotal++,this.jenkinsMetrics.buildsRunning++}generateBuildLogs(e,t,s){const n=[];return n.push("Started by system"),n.push(`Building on master in workspace /var/jenkins_home/workspace/${t}`),n.push(`[${t}] $ /usr/bin/git rev-parse --is-inside-work-tree`),n.push("true"),n.push(`[${t}] $ /usr/bin/git config remote.origin.url https://github.com/example/${t}.git`),n.push(`[${t}] $ /usr/bin/git --version`),n.push("git version 2.39.0"),n.push(`[${t}] $ /usr/bin/git fetch --tags --force --progress -- https://github.com/example/${t}.git +refs/heads/${s}:refs/remotes/origin/${s}`),n.push(`From https://github.com/example/${t}`),n.push(` * [new branch]      ${s}       -> origin/${s}`),n.push(`[${t}] $ /usr/bin/git rev-parse "refs/remotes/origin/${s}^{commit}"`),n.push("abc123def456789"),n.push(`[${t}] $ /usr/bin/git checkout -f abc123def456789`),n.push(`HEAD is now at abc123def456789 Commit message for build #${e}`),n.push(`[${t}] $ /usr/bin/git clean -fdx`),n.push("Removing .gradle/"),n.push("Removing build/"),n.push("[Pipeline] Start of Pipeline"),n.push("[Pipeline] node"),n.push(`Running on Jenkins in /var/jenkins_home/workspace/${t}`),n.push("[Pipeline] {"),n.push("[Pipeline] stage"),n.push("[Pipeline] { (Checkout)"),n.push("[Pipeline] checkout"),n.push(`Checking out abc123def456789 from ${s}`),n.push("[Pipeline] }"),n.push("[Pipeline] // stage"),n.push("[Pipeline] stage"),n.push("[Pipeline] { (Build)"),n.push("[Pipeline] sh"),n.push('+ echo "Building application..."'),n.push("Building application..."),n.push("[Pipeline] sh"),n.push("+ ./gradlew build -x test"),n.push("> Task :compileJava"),n.push("> Task :processResources"),n.push("> Task :classes"),n.push("> Task :jar"),n.push("BUILD SUCCESSFUL in 45s"),n.push("[Pipeline] }"),n.push("[Pipeline] // stage"),n.push("[Pipeline] stage"),n.push("[Pipeline] { (Test)"),n.push("[Pipeline] sh"),n.push('+ echo "Running tests..."'),n.push("Running tests..."),n.push("[Pipeline] sh"),n.push("+ ./gradlew test"),n.push("> Task :test"),n.push("Test results: 127 passed, 0 failed"),n.push("BUILD SUCCESSFUL in 30s"),n.push("[Pipeline] }"),n.push("[Pipeline] // stage"),n.push("[Pipeline] stage"),n.push("[Pipeline] { (Deploy)"),n.push("[Pipeline] sh"),n.push('+ echo "Deploying to staging..."'),n.push("Deploying to staging..."),n.push("[Pipeline] }"),n.push("[Pipeline] // stage"),n.push("[Pipeline] }"),n.push("[Pipeline] // node"),n.push("[Pipeline] End of Pipeline"),n}generateArtifacts(e,t){const s=[];return s.push({name:`app-${t}.jar`,size:15*1024*1024}),s.push({name:`app-${t}-sources.jar`,size:3*1024*1024}),s.push({name:`test-results-${t}.xml`,size:512*1024}),s.push({name:`coverage-report-${t}.html`,size:2*1024*1024}),s}cancelBuild(e){const t=this.activeBuilds.get(e);if(!t)return{success:!1,reason:"Build not found or already completed"};if(t.status!=="running"&&t.status!=="pending")return{success:!1,reason:"Build is not running"};if(t.status="aborted",t.duration=Date.now()-t.startTime,t.progress=0,t.logs&&(t.logs.push("[Pipeline] Aborted by user"),t.logs.push("[Pipeline] Terminated")),t.stages)for(const n of t.stages)(n.status==="running"||n.status==="pending")&&(n.status="aborted");this.freeExecutor(e);const s=this.pipelines.get(t.pipelineId);return s&&(s.builds.push(t),s.builds.length>50&&s.builds.shift(),s.status=this.calculatePipelineStatus(s),!s.builds.some(i=>i.status==="success")&&s.builds.every(i=>i.status==="aborted"||i.status==="failed")&&(s.status="pending")),this.activeBuilds.delete(e),this.jenkinsMetrics.buildsRunning--,{success:!0}}updateBuildLogs(e,t){if(!e.logs||e.status!=="running")return;const s=t-e.startTime,n=e.estimatedDuration||12e4,i=Math.min(100,Math.floor(s/n*100)),a=[10,30,50,70,90];for(const o of a)i>=o&&!e.logs.some(l=>l.includes(`Progress: ${o}%`))&&e.logs.push(`[Pipeline] Progress: ${o}% completed`);if(e.stages){const o=Math.floor(i/(100/e.stages.length));for(let l=0;l<e.stages.length;l++)(l<o&&e.stages[l].status==="pending"||l===o&&e.stages[l].status==="pending")&&(e.stages[l].status="running",e.stages[l].startTime=t)}}getBuildLogs(e){return this.getBuildById(e)?.logs}getBuildArtifacts(e){const t=this.getBuildById(e);if(!t||!t.artifacts)return[];const s=[];for(const n of t.artifacts){const i=`${e}-${n}`,a=this.artifacts.get(i);a&&s.push({name:n,size:a.size})}return s}executePostBuildActions(e,t){const s=e.postBuildActions||[];for(const n of s)if(n.enabled)switch(n.type){case"email":if(e.logs){const i=n.config?.recipients||["default@example.com"];e.logs.push(`[Post-Build] Sending email notification to: ${i.join(", ")}`),e.logs.push(`[Post-Build] Email subject: Build ${e.status==="success"?"SUCCESS":"FAILED"} - ${e.pipelineId} #${e.number}`)}break;case"archive":if(e.logs){const i=n.config?.archivePattern||"**/*";e.logs.push(`[Post-Build] Archiving artifacts matching pattern: ${i}`),e.artifacts&&e.artifacts.length>0&&e.logs.push(`[Post-Build] Archived ${e.artifacts.length} artifact(s)`)}break;case"publish":if(e.logs){const i=n.config?.publishTarget||"default";e.logs.push(`[Post-Build] Publishing test results to: ${i}`),e.logs.push("[Post-Build] Published build metrics and artifacts")}break;case"deploy":if(t&&n.config?.deployEnv){if(e.logs){const i=n.config.deployEnv;e.logs.push(`[Post-Build] Deploying to environment: ${i}`),e.logs.push(`[Post-Build] Deployment initiated for build #${e.number}`),e.logs.push(`[Post-Build] Deployment to ${i} completed successfully`)}}else t||e.logs&&e.logs.push("[Post-Build] Skipping deployment - build failed");break}}getPipelineConfig(e){const t=this.pipelines.get(e);return t?t.config||{}:null}updatePipelineConfig(e,t){const s=this.pipelines.get(e);return s?(s.config={...s.config||{},...t},!0):!1}hasAvailableExecutor(){for(const e of this.nodes.values())if(e.idleExecutors>0)return!0;return!1}allocateExecutor(e){for(const t of this.nodes.values())if(t.idleExecutors>0){t.idleExecutors--,t.busyExecutors++;return}}freeExecutor(e){for(const t of this.nodes.values())if(t.busyExecutors>0){t.busyExecutors--,t.idleExecutors++;return}}addBuildToHistory(e){e.duration&&(this.buildHistory.push({timestamp:e.startTime,duration:e.duration,status:e.status}),this.buildHistory.length>this.MAX_BUILD_HISTORY&&this.buildHistory.shift(),e.status==="success"?this.jenkinsMetrics.buildsSuccess++:e.status==="failed"&&this.jenkinsMetrics.buildsFailed++,this.jenkinsMetrics.buildsRunning--)}cleanupArtifacts(e){if(!this.config)return;const t=(this.config.retentionDays||30)*24*60*60*1e3;for(const[s,n]of this.artifacts.entries())e-n.created>t&&this.artifacts.delete(s)}updateMetrics(){this.jenkinsMetrics.buildsRunning=this.activeBuilds.size,this.jenkinsMetrics.buildsPending=Array.from(this.activeBuilds.values()).filter(l=>l.status==="pending").length;const e=this.buildHistory.length;this.jenkinsMetrics.buildsTotal=e+this.activeBuilds.size;const t=Date.now()-6e4,s=this.buildHistory.filter(l=>l.timestamp>t);if(this.jenkinsMetrics.buildsPerMinute=s.length,this.buildHistory.length>0){const l=this.buildHistory.slice(-100),d=l.reduce((h,p)=>h+p.duration,0)/l.length;this.jenkinsMetrics.averageBuildDuration=d}let n=0,i=0,a=0;for(const l of this.nodes.values())n+=l.numExecutors,i+=l.busyExecutors,a+=l.idleExecutors;this.jenkinsMetrics.executorBusy=i,this.jenkinsMetrics.executorIdle=a,this.jenkinsMetrics.executorUtilization=n>0?i/n*100:0,this.jenkinsMetrics.pipelinesTotal=this.pipelines.size,this.jenkinsMetrics.pipelinesEnabled=Array.from(this.pipelines.values()).filter(l=>l.enabled).length,this.jenkinsMetrics.nodesTotal=this.nodes.size,this.jenkinsMetrics.nodesOnline=Array.from(this.nodes.values()).filter(l=>l.status==="online").length,this.jenkinsMetrics.pluginsTotal=this.plugins.size,this.jenkinsMetrics.pluginsActive=Array.from(this.plugins.values()).filter(l=>l.active).length;let o=0;for(const l of this.artifacts.values())o+=l.size;this.jenkinsMetrics.artifactStorageBytes=o}getJenkinsMetrics(){return{...this.jenkinsMetrics}}getPipelines(){for(const e of this.pipelines.values())e.status=this.calculatePipelineStatus(e);return Array.from(this.pipelines.values())}getActiveBuilds(){return Array.from(this.activeBuilds.values())}getNodes(){return Array.from(this.nodes.values())}getPlugins(){return Array.from(this.plugins.values())}getPipelineBuilds(e){const t=this.pipelines.get(e);return t?t.builds:[]}getAllBuilds(){const e=[];e.push(...Array.from(this.activeBuilds.values()));for(const t of this.pipelines.values()){const s=t.builds.slice(-50);e.push(...s)}return e.sort((t,s)=>{const n=t.startTime||0;return(s.startTime||0)-n})}getBuildById(e){if(this.activeBuilds.has(e))return this.activeBuilds.get(e);for(const t of this.pipelines.values()){const s=t.builds.find(n=>n.id===e);if(s)return s}}updateConfig(e){const t=this.config,s=new Set(this.pipelines.keys());this.initializeConfig(e);const n=this.config?.executorCount||2;t&&t.executorCount!==n&&this.updateExecutorCount(n);const i=new Set(this.pipelines.keys());for(const d of s)if(!i.has(d)){for(const[h,p]of this.activeBuilds.entries())p.pipelineId===d&&(p.status="aborted",this.freeExecutor(h),this.activeBuilds.delete(h));this.pipelines.delete(d)}const a=this.config?.pipelines||[];for(const d of a){const h=this.pipelines.get(d.id);h&&(h.name=d.name,h.branch=d.branch||"main",h.enabled=d.enabled!==!1,h.config={triggers:d.triggers||[],parameters:d.parameters||[],environmentVariables:d.environmentVariables||{},postBuildActions:d.postBuildActions||[]})}const o=this.config?.nodes||[],l=new Set(this.nodes.keys());for(const d of l)d!=="master"&&!o.find(h=>h.id===d)&&this.nodes.delete(d);for(const d of o){const h=this.nodes.get(d.id);if(h)h.name=d.name,h.numExecutors=d.numExecutors||1,h.labels=d.labels||[],h.idleExecutors=h.numExecutors-h.busyExecutors;else{const p={id:d.id,name:d.name,status:"online",numExecutors:d.numExecutors||1,busyExecutors:0,idleExecutors:d.numExecutors||1,labels:d.labels||[]};this.nodes.set(d.id,p)}}}setPipelineEnabled(e,t){const s=this.pipelines.get(e);return s?(s.enabled=t,!0):!1}updateExecutorCount(e){const t=this.nodes.get("master");return!t||e<t.busyExecutors?!1:(t.numExecutors,t.numExecutors=e,t.idleExecutors=e-t.busyExecutors,!0)}canUpdateExecutorCount(e){const t=this.nodes.get("master");return t?e<1||e>100?{can:!1,reason:"Executor count must be between 1 and 100"}:e<t.busyExecutors?{can:!1,reason:`Cannot reduce executors to ${e}. Currently ${t.busyExecutors} executors are busy.`}:{can:!0}:{can:!1,reason:"Master node not found"}}setPipelineEnabled(e,t){const s=this.pipelines.get(e);return s?(s.enabled=t,!0):!1}calculateComponentMetrics(){const e=this.getJenkinsMetrics(),t=e.buildsPerMinute/60,s=e.averageBuildDuration,n=e.executorUtilization,i=e.buildsSuccess+e.buildsFailed,a=i>0?e.buildsFailed/i*100:0;return{throughput:t,latency:s,utilization:n,errorRate:a}}}class Ok{config=null;pipelines=new Map;activeJobs=new Map;runners=new Map;variables=new Map;environments=new Map;schedules=new Map;artifacts=new Map;cacheEntries=new Map;gitlabMetrics={pipelinesTotal:0,pipelinesSuccess:0,pipelinesFailed:0,pipelinesRunning:0,pipelinesPending:0,pipelinesPerHour:0,averagePipelineDuration:0,jobsTotal:0,jobsSuccess:0,jobsFailed:0,jobsRunning:0,jobsPending:0,averageJobDuration:0,runnersTotal:0,runnersOnline:0,runnersBusy:0,runnersIdle:0,runnerUtilization:0,cacheHits:0,cacheMisses:0,cacheHitRate:0,artifactsTotal:0,artifactsSizeBytes:0,requestsTotal:0,requestsErrors:0};pipelineHistory=[];MAX_PIPELINE_HISTORY=1e3;jobHistory=[];MAX_JOB_HISTORY=5e3;lastPipelineTrigger=new Map;pipelineIidCounter=0;scheduleLastRun=new Map;processRequest(e=!0){this.gitlabMetrics.requestsTotal++,e||this.gitlabMetrics.requestsErrors++}initializeConfig(e){const t=e.data.config||{};let s=t.runners;typeof s=="number"?s=Array.from({length:s},(n,i)=>({id:`runner-${i+1}`,name:`docker-runner-${i+1}`,executor:t.runnerType||"docker",maxJobs:t.concurrentJobs||4,tags:[],isShared:!1})):Array.isArray(s)||(s=[]),this.config={gitlabUrl:t.gitlabUrl||"https://gitlab.com",projectId:t.projectId||"1",projectUrl:t.projectUrl||"https://gitlab.com/archiphoenix/project",enableRunners:t.enableRunners??!0,runnerType:t.runnerType||"docker",concurrentJobs:t.concurrentJobs||4,enableCache:t.enableCache??!0,cacheType:t.cacheType||"s3",enableArtifacts:t.enableArtifacts??!0,artifactsExpiry:t.artifactsExpiry||"7d",enableKubernetes:t.enableKubernetes??!1,k8sNamespace:t.k8sNamespace||"gitlab-runner",pipelines:Array.isArray(t.pipelines)?t.pipelines:[],runners:s,variables:Array.isArray(t.variables)?t.variables:[],environments:Array.isArray(t.environments)?t.environments:[],schedules:Array.isArray(t.schedules)?t.schedules:[],pipelineTriggerRate:t.pipelineTriggerRate||2,averagePipelineDuration:t.averagePipelineDuration||3e5,averageJobDuration:t.averageJobDuration||6e4,failureRate:t.failureRate||.1,cacheHitRate:t.cacheHitRate||.7},this.initializePipelines(),this.initializeRunners(),this.initializeVariables(),this.initializeEnvironments(),this.initializeSchedules()}initializePipelines(){this.pipelines.clear();const e=Array.isArray(this.config?.pipelines)?this.config.pipelines:[];for(const t of e){const s=t.id,i=(Array.isArray(t.stages)?t.stages:[{name:"build",jobs:[{name:"build",stage:"build"}]},{name:"test",jobs:[{name:"test",stage:"test"}]},{name:"deploy",jobs:[{name:"deploy",stage:"deploy"}]}]).map(o=>({name:o.name,status:"pending",jobs:Array.isArray(o.jobs)?o.jobs.map(l=>({id:`${s}-${o.name}-${l.name}`,name:l.name,stage:o.name,status:"created",pipelineId:s,when:l.when||"on_success",allowFailure:l.allowFailure||!1,tags:Array.isArray(l.tags)?l.tags:[],image:l.image,script:Array.isArray(l.script)?l.script:[`echo "Running ${l.name}"`]})):[]})),a={id:s,iid:++this.pipelineIidCounter,status:"created",ref:t.ref||"main",source:t.source||"push",stages:i,createdAt:Date.now(),updatedAt:Date.now(),variables:{}};this.pipelines.set(s,a)}}initializeRunners(){this.runners.clear();const e=Array.isArray(this.config?.runners)?this.config.runners:[];if(e.length===0&&this.config?.enableRunners){const t={id:"default-runner-1",name:"docker-runner-1",status:"online",runnerType:"project_type",executor:this.config.runnerType||"docker",active:!0,isShared:!1,locked:!1,runUntagged:!0,accessLevel:"not_protected",currentJobs:0,maxJobs:this.config.concurrentJobs||4,busy:!1,platform:"linux",architecture:"amd64",contactedAt:Date.now()};this.runners.set(t.id,t);return}for(const t of e){const s={id:t.id,name:t.name,status:"online",runnerType:"project_type",executor:t.executor||this.config?.runnerType||"docker",active:!0,isShared:t.isShared??!1,locked:!1,runUntagged:!0,accessLevel:"not_protected",tagList:t.tags||[],currentJobs:0,maxJobs:t.maxJobs||this.config?.concurrentJobs||4,busy:!1,platform:"linux",architecture:"amd64",contactedAt:Date.now()};this.runners.set(s.id,s)}}initializeVariables(){this.variables.clear();const e=Array.isArray(this.config?.variables)?this.config.variables:[];for(const t of e){const s={key:t.key,value:t.value,variableType:"env_var",protected:t.protected??!1,masked:t.masked??!1,raw:!1,environmentScope:t.environmentScope||"*"};this.variables.set(t.key,s)}}initializeEnvironments(){this.environments.clear();const e=Array.isArray(this.config?.environments)?this.config.environments:[];for(const t of e){const s={id:t.id,name:t.name,slug:t.name.toLowerCase().replace(/[^a-z0-9]+/g,"-"),externalUrl:t.externalUrl,state:"available",deployments:[]};this.environments.set(t.id,s)}}initializeSchedules(){this.schedules.clear();const e=Array.isArray(this.config?.schedules)?this.config.schedules:[];for(const t of e){const s={id:t.id,description:t.description,ref:t.ref,cron:t.cron,active:t.active!==!1,variables:t.variables||{}};s.nextRunAt=this.calculateNextRunTime(s.cron),this.schedules.set(t.id,s)}}calculateNextRunTime(e){const t=Date.now(),s=3600*1e3;return t+s}performUpdate(e){this.config&&(this.updateActiveJobs(e),this.updateActivePipelines(e),this.triggerPipelines(e),this.checkSchedules(e),this.config.enableArtifacts&&this.cleanupArtifacts(e),this.updateMetrics())}updateActiveJobs(e){const t=Array.from(this.activeJobs.entries());for(const[s,n]of t)if(n.status==="running")try{if(!n.startTime){n.startTime=e;continue}const i=e-n.startTime,a=n.estimatedDuration||this.config?.averageJobDuration||6e4;if(i<0)continue;if(n.progress=Math.min(100,Math.max(0,Math.floor(i/a*100))),i%5e3<100&&n.logs&&this.updateJobLogs(n,i,a),i>=a){const o=Math.random()<(this.config?.failureRate||.1);n.status=o?"failed":"success",n.duration=i,n.progress=100,n.logs&&(o?n.logs.push(`Job ${n.name} failed after ${(i/1e3).toFixed(1)}s`):n.logs.push(`Job ${n.name} succeeded in ${(i/1e3).toFixed(1)}s`)),n.status==="success"&&this.config?.enableArtifacts&&this.generateJobArtifacts(n,e),this.freeRunner(n.runnerId),n.runnerId=void 0,this.updatePipelineStage(n),this.addJobToHistory(n),this.activeJobs.delete(s)}}catch(i){console.error(`Error updating job ${s}:`,i),n.status="failed",this.activeJobs.delete(s),this.freeRunner(n.runnerId)}}updateActivePipelines(e){for(const t of this.pipelines.values()){if(t.status!=="running"&&t.status!=="pending")continue;const s=t.stages.every(n=>n.status==="success"||n.status==="failed"||n.status==="canceled");if(s&&t.status==="running"){const n=t.stages.some(i=>i.status==="failed");t.status=n?"failed":"success",t.finishedAt=e,t.startedAt&&(t.duration=e-t.startedAt),t.status==="success"&&(t.coverage=75+Math.random()*20),this.addPipelineToHistory(t),t.status==="success"?this.gitlabMetrics.pipelinesSuccess++:this.gitlabMetrics.pipelinesFailed++,this.gitlabMetrics.pipelinesRunning--}else if(t.status==="pending"&&!s){const n=t.stages.find(i=>i.status==="pending");n&&this.hasAvailableRunner(n.jobs[0]?.tags)&&(t.status="running",t.startedAt=e,this.startStage(n,t.id,e))}else if(t.status==="running")for(let n=0;n<t.stages.length;n++){const i=t.stages[n],a=n>0?t.stages[n-1]:null;if(i.status==="pending"&&(!a||a.status==="success")){this.startStage(i,t.id,e);break}}t.updatedAt=e}}startStage(e,t,s){e.status="running",e.startTime=s;for(const n of e.jobs)if(n.status==="created"||n.status==="pending"){const i=this.findAvailableRunner(n.tags);i?(n.status="running",n.startTime=s,n.runnerId=i.id,n.estimatedDuration=this.config?.averageJobDuration||6e4,n.progress=0,n.logs=this.generateJobLogs(n),i.currentJobs++,i.busy=i.currentJobs>=i.maxJobs,this.activeJobs.set(n.id,n),this.gitlabMetrics.jobsRunning++):(n.status="pending",this.gitlabMetrics.jobsPending++)}}updateJobLogs(e,t,s){if(!e.logs)return;const n=Math.floor(t/s*100),i=[10,30,50,70,90];for(const a of i)n>=a&&!e.logs.some(o=>o.includes(`Progress: ${a}%`))&&e.logs.push(`[${e.name}] Progress: ${a}% completed`)}generateJobLogs(e){const t=[];if(t.push(`Running with ${e.image||"default"} image`),t.push(`$ ${e.script?.[0]||`echo "Running ${e.name}"`}`),e.script)for(const s of e.script)s.startsWith("echo")?t.push(s.replace("echo ","")):(t.push(`$ ${s}`),t.push(`[output from ${s}]`));return t}generateJobArtifacts(e,t){if(!this.config?.enableArtifacts)return;const s=[{name:`${e.name}-output.log`,size:1024*10,fileType:"text/plain"},{name:`${e.name}-results.json`,size:1024*5,fileType:"application/json"}];for(const n of s){const i=`${e.id}-${n.name}`,a={id:i,jobId:e.id,pipelineId:e.pipelineId,name:n.name,size:n.size,fileType:n.fileType,filename:n.name,createdAt:t},o=parseInt(this.config.artifactsExpiry?.replace("d","")||"7");a.expiresAt=t+o*24*60*60*1e3,this.artifacts.set(i,a),e.artifacts||(e.artifacts=[]),e.artifacts.push(n.name)}}updatePipelineStage(e){const t=this.pipelines.get(e.pipelineId);if(!t)return;const s=t.stages.find(a=>a.name===e.stage);if(!s)return;const n=s.jobs.find(a=>a.id===e.id);if(n&&(n.status=e.status,n.duration=e.duration),s.jobs.every(a=>a.status==="success"||a.status==="failed"||a.status==="canceled"||a.status==="skipped")){const a=s.jobs.some(o=>o.status==="failed"&&!o.allowFailure);s.status=a?"failed":"success",s.startTime&&(s.duration=Date.now()-s.startTime)}}triggerPipelines(e){if(!this.config)return;const t=this.config.pipelineTriggerRate||2,s=3600*1e3/t;for(const[n,i]of this.pipelines.entries()){if(i.status==="running"||i.status==="pending")continue;const a=this.lastPipelineTrigger.get(n)||0;e-a>=s&&(this.startPipeline(n,e),this.lastPipelineTrigger.set(n,e))}}checkSchedules(e){for(const[t,s]of this.schedules.entries())if(s.active&&s.nextRunAt&&e>=s.nextRunAt){const n=Array.from(this.pipelines.values()).find(i=>i.ref===s.ref&&(i.status==="created"||i.status==="success"||i.status==="failed"));n&&(this.startPipeline(n.id,e,"schedule",s.variables),s.lastRunPipelineId=n.id),s.nextRunAt=this.calculateNextRunTime(s.cron),this.scheduleLastRun.set(t,e)}}startPipeline(e,t,s="push",n){const i=this.pipelines.get(e);if(!i)return{success:!1,reason:"Pipeline not found"};if(i.status==="running"||i.status==="pending")return{success:!1,reason:"Pipeline already running"};i.status="pending",i.source=s,i.createdAt=t,i.updatedAt=t,i.startedAt=void 0,i.finishedAt=void 0,i.duration=void 0,i.coverage=void 0,n&&(i.variables={...i.variables,...n});for(const a of i.stages){a.status="pending",a.startTime=void 0,a.duration=void 0;for(const o of a.jobs)o.status="created",o.startTime=void 0,o.duration=void 0,o.progress=0,o.logs=void 0,o.artifacts=void 0,o.runnerId=void 0}return this.gitlabMetrics.pipelinesTotal++,this.gitlabMetrics.pipelinesPending++,{success:!0}}triggerWebhook(e,t){const s=Array.from(this.pipelines.values()).find(i=>i.ref===e&&(i.status==="created"||i.status==="success"||i.status==="failed"));if(!s)return{success:!1,reason:`No pipeline found for ref: ${e}`};const n=this.startPipeline(s.id,Date.now(),"trigger",t);return n.success?{success:!0,pipelineId:s.id}:n}cancelPipeline(e){const t=this.pipelines.get(e);if(!t)return{success:!1,reason:"Pipeline not found"};if(t.status!=="running"&&t.status!=="pending")return{success:!1,reason:"Pipeline is not running"};t.status="canceled",t.finishedAt=Date.now(),t.startedAt&&(t.duration=Date.now()-t.startedAt);for(const s of t.stages){s.status="canceled";for(const n of s.jobs)(n.status==="running"||n.status==="pending")&&(n.status="canceled",this.freeRunner(n.runnerId),this.activeJobs.delete(n.id),this.gitlabMetrics.jobsRunning--)}return this.gitlabMetrics.pipelinesRunning--,{success:!0}}hasAvailableRunner(e){for(const t of this.runners.values())if(!(t.status!=="online"||!t.active)&&!(t.currentJobs>=t.maxJobs)&&!(e&&e.length>0&&(!t.runUntagged&&(!t.tagList||t.tagList.length===0)||t.tagList&&t.tagList.length>0&&!e.some(n=>t.tagList?.includes(n))&&!t.runUntagged)))return!0;return!1}findAvailableRunner(e){for(const t of this.runners.values())if(!(t.status!=="online"||!t.active)&&!(t.currentJobs>=t.maxJobs)&&!(e&&e.length>0&&(!t.runUntagged&&(!t.tagList||t.tagList.length===0)||t.tagList&&t.tagList.length>0&&!e.some(n=>t.tagList?.includes(n))&&!t.runUntagged)))return t}freeRunner(e){if(!e)return;const t=this.runners.get(e);t&&t.currentJobs>0&&(t.currentJobs--,t.busy=t.currentJobs>=t.maxJobs)}addPipelineToHistory(e){e.duration&&(this.pipelineHistory.push({timestamp:e.startedAt||e.createdAt,duration:e.duration,status:e.status}),this.pipelineHistory.length>this.MAX_PIPELINE_HISTORY&&this.pipelineHistory.shift())}addJobToHistory(e){e.duration&&(this.jobHistory.push({timestamp:e.startTime||Date.now(),duration:e.duration,status:e.status}),this.jobHistory.length>this.MAX_JOB_HISTORY&&this.jobHistory.shift(),e.status==="success"?this.gitlabMetrics.jobsSuccess++:e.status==="failed"&&this.gitlabMetrics.jobsFailed++,this.gitlabMetrics.jobsRunning--)}cleanupArtifacts(e){if(!this.config)return;const s=parseInt(this.config.artifactsExpiry?.replace("d","")||"7")*24*60*60*1e3;for(const[n,i]of this.artifacts.entries())i.expiresAt&&e>i.expiresAt?this.artifacts.delete(n):e-i.createdAt>s&&this.artifacts.delete(n)}updateMetrics(){this.gitlabMetrics.pipelinesRunning=Array.from(this.pipelines.values()).filter(d=>d.status==="running").length,this.gitlabMetrics.pipelinesPending=Array.from(this.pipelines.values()).filter(d=>d.status==="pending").length;const e=Date.now()-3600*1e3,t=this.pipelineHistory.filter(d=>d.timestamp>e);if(this.gitlabMetrics.pipelinesPerHour=t.length,this.pipelineHistory.length>0){const d=this.pipelineHistory.slice(-100),h=d.reduce((p,g)=>p+g.duration,0)/d.length;this.gitlabMetrics.averagePipelineDuration=h}if(this.gitlabMetrics.jobsRunning=this.activeJobs.size,this.gitlabMetrics.jobsPending=Array.from(this.activeJobs.values()).filter(d=>d.status==="pending").length,this.jobHistory.length>0){const d=this.jobHistory.slice(-500),h=d.reduce((p,g)=>p+g.duration,0)/d.length;this.gitlabMetrics.averageJobDuration=h}this.gitlabMetrics.runnersTotal=this.runners.size,this.gitlabMetrics.runnersOnline=Array.from(this.runners.values()).filter(d=>d.status==="online").length;let s=0,n=0,i=0;for(const d of this.runners.values())d.status==="online"&&(s+=d.currentJobs,n+=d.maxJobs-d.currentJobs,i+=d.maxJobs);this.gitlabMetrics.runnersBusy=s,this.gitlabMetrics.runnersIdle=n,this.gitlabMetrics.runnerUtilization=i>0?s/i*100:0;const a=this.gitlabMetrics.cacheHits+this.gitlabMetrics.cacheMisses;a>0?this.gitlabMetrics.cacheHitRate=this.gitlabMetrics.cacheHits/a:(this.gitlabMetrics.cacheHits=Math.floor(Math.random()*100),this.gitlabMetrics.cacheMisses=Math.floor(this.gitlabMetrics.cacheHits*.3),this.gitlabMetrics.cacheHitRate=this.config?.cacheHitRate||.7),this.gitlabMetrics.artifactsTotal=this.artifacts.size;let o=0;for(const d of this.artifacts.values())o+=d.size;this.gitlabMetrics.artifactsSizeBytes=o;const l=Array.from(this.pipelines.values()).filter(d=>d.status==="success"&&d.coverage!==void 0);if(l.length>0){const d=l.reduce((h,p)=>h+(p.coverage||0),0)/l.length;this.gitlabMetrics.coverage=d}}getGitLabCIMetrics(){return{...this.gitlabMetrics}}getMetrics(){return this.getGitLabCIMetrics()}getPipelines(){return Array.from(this.pipelines.values())}getPipeline(e){return this.pipelines.get(e)}getActiveJobs(){return Array.from(this.activeJobs.values())}getJob(e){if(this.activeJobs.has(e))return this.activeJobs.get(e);for(const t of this.pipelines.values())for(const s of t.stages){const n=s.jobs.find(i=>i.id===e);if(n)return n}}getRunners(){return Array.from(this.runners.values())}getVariables(){return Array.from(this.variables.values())}getEnvironments(){return Array.from(this.environments.values())}getSchedules(){return Array.from(this.schedules.values())}getArtifacts(){return Array.from(this.artifacts.values())}getJobLogs(e){return this.getJob(e)?.logs}updateConfig(e){this.config;const t=new Set(this.pipelines.keys());this.initializeConfig(e);const s=new Set(this.pipelines.keys());for(const o of t)if(!s.has(o)){for(const[l,d]of this.activeJobs.entries())d.pipelineId===o&&(d.status="canceled",this.freeRunner(d.runnerId),this.activeJobs.delete(l));this.pipelines.delete(o)}const n=this.config?.pipelines||[];for(const o of n){const l=this.pipelines.get(o.id);l&&(l.ref=o.ref||l.ref,l.source=o.source||l.source,l.status!=="running"&&l.status)}const i=this.config?.runners||[],a=new Set(this.runners.keys());for(const o of a)if(!i.find(l=>l.id===o)){for(const[l,d]of this.activeJobs.entries())d.runnerId===o&&(d.status="canceled",this.activeJobs.delete(l));this.runners.delete(o)}for(const o of i){const l=this.runners.get(o.id);if(l)l.name=o.name,l.executor=o.executor||l.executor,l.maxJobs=o.maxJobs||l.maxJobs,l.tagList=o.tags||l.tagList,l.isShared=o.isShared??l.isShared;else{const d={id:o.id,name:o.name,status:"online",runnerType:"project_type",executor:o.executor||this.config?.runnerType||"docker",active:!0,isShared:o.isShared??!1,locked:!1,runUntagged:!0,accessLevel:"not_protected",tagList:o.tags||[],currentJobs:0,maxJobs:o.maxJobs||this.config?.concurrentJobs||4,busy:!1,platform:"linux",architecture:"amd64",contactedAt:Date.now()};this.runners.set(o.id,d)}}this.initializeVariables(),this.initializeEnvironments(),this.initializeSchedules()}calculateComponentMetrics(){const e=this.getGitLabCIMetrics(),t=e.pipelinesPerHour/3600,s=e.averagePipelineDuration,n=e.runnerUtilization/100,i=e.pipelinesSuccess+e.pipelinesFailed,a=i>0?e.pipelinesFailed/i:0;return{throughput:t,latency:s,utilization:n,errorRate:a}}}class qk{config=null;applications=new Map;repositories=new Map;projects=new Map;syncOperations=new Map;argoMetrics={applicationsTotal:0,applicationsSynced:0,applicationsOutOfSync:0,applicationsProgressing:0,applicationsDegraded:0,applicationsHealthy:0,syncOperationsTotal:0,syncOperationsSuccess:0,syncOperationsFailed:0,syncOperationsRunning:0,syncRate:0,averageSyncDuration:0,repositoriesTotal:0,repositoriesConnected:0,repositoriesFailed:0,projectsTotal:0,requestsTotal:0,requestsErrors:0};syncHistory=[];MAX_SYNC_HISTORY=1e3;lastSyncTime=new Map;lastHealthCheck=new Map;processRequest(e=!0){this.argoMetrics.requestsTotal++,e||this.argoMetrics.requestsErrors++}initializeConfig(e){const t=e.data.config||{};this.config={serverUrl:t.serverUrl||t.argoUrl||"https://argocd.example.com",enableSSO:t.enableSSO??!1,ssoProvider:t.ssoProvider||"oidc",enableRBAC:t.enableRBAC??!0,enableSyncPolicy:t.enableSyncPolicy??!0,autoSync:t.autoSync??!1,syncPolicy:t.syncPolicy||"manual",enableHealthChecks:t.enableHealthChecks??!0,enableNotifications:t.enableNotifications??!0,notificationChannels:t.notificationChannels||["slack"],applications:t.applications||[],repositories:t.repositories||[],projects:t.projects||[],syncRate:t.syncRate||1,averageSyncDuration:t.averageSyncDuration||3e4,failureRate:t.failureRate||.05,healthCheckInterval:t.healthCheckInterval||3e5},this.initializeApplications(),this.initializeRepositories(),this.initializeProjects()}initializeApplications(){this.applications.clear();const e=this.config?.applications||[];if(e.length===0){const t={name:"web-app",namespace:"production",project:"default",repository:"https://github.com/example/web-app",path:"k8s",targetRevision:"main",destination:{server:"https://kubernetes.default.svc",namespace:"production"},syncPolicy:this.config?.syncPolicy||"manual",status:"synced",health:"healthy",lastSync:Date.now()-12e4,revision:"abc123",sourceRevision:"abc123"};this.applications.set(t.name,t);return}for(const t of e){const s={name:t.name,namespace:t.namespace,project:t.project||"default",repository:t.repository,path:t.path||".",targetRevision:t.targetRevision||"main",destination:t.destination||{server:"https://kubernetes.default.svc",namespace:t.namespace||"default"},syncPolicy:t.syncPolicy||this.config?.syncPolicy||"manual",status:t.status||"synced",health:t.health||"healthy",lastSync:Date.now()-Math.random()*36e5,revision:this.generateRevision(),sourceRevision:this.generateRevision()};this.applications.set(s.name,s)}}initializeRepositories(){this.repositories.clear();const e=this.config?.repositories||[],t=new Set;for(const s of this.applications.values())t.add(s.repository);for(const s of e){const n={name:s.name||s.url,url:s.url,type:s.type||"git",username:s.username,password:s.password,insecure:s.insecure??!1,project:s.project,connectionStatus:"successful",lastVerifiedAt:Date.now()};this.repositories.set(n.name,n)}for(const s of t)if(!this.repositories.has(s)){const n={name:s,url:s,type:"git",connectionStatus:"successful",lastVerifiedAt:Date.now()};this.repositories.set(s,n)}}initializeProjects(){this.projects.clear();const e=this.config?.projects||[];if(e.length===0){const t={name:"default",description:"Default project",sourceRepos:["*"],destinations:[{server:"*",namespace:"*"}]};this.projects.set("default",t);return}for(const t of e){const s={name:t.name,description:t.description,sourceRepos:t.sourceRepos||["*"],destinations:t.destinations||[{server:"*",namespace:"*"}]};this.projects.set(s.name,s)}}generateRevision(){return Math.random().toString(36).substring(2,8)}performUpdate(e){this.config&&(this.updateSyncOperations(e),(this.config.autoSync||this.config.syncPolicy==="automated")&&this.triggerAutoSyncs(e),this.config.enableHealthChecks&&this.performHealthChecks(e),this.checkRepositoryConnections(e),this.updateMetrics())}updateSyncOperations(e){const t=Array.from(this.syncOperations.entries());for(const[s,n]of t){if(n.status!=="running")continue;if(!n.startedAt){n.startedAt=e;continue}const i=e-n.startedAt,a=this.config?.averageSyncDuration||3e4;if(i>=a){const o=Math.random()<(this.config?.failureRate||.05);n.status=o?"failed":"success",n.finishedAt=e,o&&(n.error="Sync failed: resource conflict or validation error");const l=this.applications.get(n.application);l&&(n.status==="success"?(l.status="synced",l.health="healthy",l.lastSync=e,l.lastSyncDuration=i,l.revision=l.sourceRevision=this.generateRevision(),l.history||(l.history=[]),l.history.unshift({id:s,revision:l.revision,deployedAt:e}),l.history.length>10&&l.history.pop()):(l.status="degraded",l.health="degraded")),this.addSyncToHistory(n),n.status==="success"?this.argoMetrics.syncOperationsSuccess++:this.argoMetrics.syncOperationsFailed++,this.argoMetrics.syncOperationsRunning--,this.syncOperations.delete(s)}}}triggerAutoSyncs(e){const s=36e5/(this.config?.syncRate||1);for(const n of this.applications.values()){if(n.syncPolicy!=="automated"&&n.syncPolicy!=="auto")continue;const i=this.lastSyncTime.get(n.name)||n.lastSync||0;e-i>=s&&(n.status==="outofsync"||n.status==="synced")&&(this.startSync(n.name,e),this.lastSyncTime.set(n.name,e))}}performHealthChecks(e){const t=this.config?.healthCheckInterval||3e5;for(const s of this.applications.values()){const n=this.lastHealthCheck.get(s.name)||0;e-n>=t&&(Math.random()<.05&&s.health==="healthy"?(s.health="degraded",s.status="degraded"):s.health==="degraded"&&Math.random()<.3&&(s.health="healthy",s.status==="degraded"&&(s.status="synced")),this.lastHealthCheck.set(s.name,e))}}checkRepositoryConnections(e){for(const s of this.repositories.values()){const n=s.lastVerifiedAt||0;e-n>=6e5&&(Math.random()<.95?(s.connectionStatus="successful",s.lastVerifiedAt=e,s.lastConnectionError=void 0):(s.connectionStatus="failed",s.lastConnectionError="Connection timeout or authentication failed",s.lastVerifiedAt=e))}}startSync(e,t=Date.now()){const s=this.applications.get(e);if(!s||Array.from(this.syncOperations.values()).find(o=>o.application===e&&o.status==="running"))return!1;const i=`sync-${e}-${t}`,a={id:i,application:e,startedAt:t,status:"running",phase:"sync"};return this.syncOperations.set(i,a),this.argoMetrics.syncOperationsRunning++,this.argoMetrics.syncOperationsTotal++,s.status="progressing",s.syncStartedAt=t,!0}updateMetrics(){if(this.argoMetrics.applicationsTotal=this.applications.size,this.argoMetrics.applicationsSynced=Array.from(this.applications.values()).filter(e=>e.status==="synced").length,this.argoMetrics.applicationsOutOfSync=Array.from(this.applications.values()).filter(e=>e.status==="outofsync").length,this.argoMetrics.applicationsProgressing=Array.from(this.applications.values()).filter(e=>e.status==="progressing").length,this.argoMetrics.applicationsDegraded=Array.from(this.applications.values()).filter(e=>e.status==="degraded").length,this.argoMetrics.applicationsHealthy=Array.from(this.applications.values()).filter(e=>e.health==="healthy").length,this.argoMetrics.repositoriesTotal=this.repositories.size,this.argoMetrics.repositoriesConnected=Array.from(this.repositories.values()).filter(e=>e.connectionStatus==="successful").length,this.argoMetrics.repositoriesFailed=Array.from(this.repositories.values()).filter(e=>e.connectionStatus==="failed").length,this.argoMetrics.projectsTotal=this.projects.size,this.syncHistory.length>0){const e=Date.now()-36e5,t=this.syncHistory.filter(n=>n.timestamp>=e).length;this.argoMetrics.syncRate=t;const s=this.syncHistory.filter(n=>n.status==="success");if(s.length>0){const n=s.reduce((i,a)=>i+a.duration,0);this.argoMetrics.averageSyncDuration=n/s.length}}}addSyncToHistory(e){if(!e.finishedAt||!e.startedAt)return;const t=e.finishedAt-e.startedAt,s=e.status==="success"?"success":"failed";this.syncHistory.push({timestamp:e.finishedAt,duration:t,status:s}),this.syncHistory.length>this.MAX_SYNC_HISTORY&&this.syncHistory.shift()}getMetrics(){return{...this.argoMetrics}}getApplications(){return Array.from(this.applications.values())}getApplication(e){return this.applications.get(e)}addApplication(e){this.applications.set(e.name,e)}removeApplication(e){return this.applications.delete(e)}updateApplication(e,t){const s=this.applications.get(e);return s?(this.applications.set(e,{...s,...t}),!0):!1}getRepositories(){return Array.from(this.repositories.values())}getRepository(e){return this.repositories.get(e)}addRepository(e){this.repositories.set(e.name,e)}removeRepository(e){return this.repositories.delete(e)}updateRepository(e,t){const s=this.repositories.get(e);return s?(this.repositories.set(e,{...s,...t}),!0):!1}getProjects(){return Array.from(this.projects.values())}getProject(e){return this.projects.get(e)}addProject(e){this.projects.set(e.name,e)}updateProject(e,t){const s=this.projects.get(e);return s?(this.projects.set(e,{...s,...t}),!0):!1}removeProject(e){return this.projects.delete(e)}getSyncOperations(){return Array.from(this.syncOperations.values())}getStats(){return{metrics:this.getMetrics(),applications:this.getApplications(),repositories:this.getRepositories(),projects:this.getProjects(),activeSyncs:this.getSyncOperations()}}}class Hk{config=null;workspaces=new Map;activeRuns=new Map;runHistory=new Map;MAX_RUN_HISTORY=1e3;states=new Map;terraformMetrics={workspacesTotal:0,runsTotal:0,runsSuccess:0,runsFailed:0,runsRunning:0,runsPending:0,runsPerHour:0,averageRunDuration:0,statesTotal:0,resourcesManaged:0,requestsTotal:0,requestsErrors:0};runHistoryList=[];MAX_RUN_HISTORY_LIST=1e3;lastRunTime=new Map;lastVCSWebhook=new Map;processRequest(e=!0){this.terraformMetrics.requestsTotal++,e||this.terraformMetrics.requestsErrors++}initializeConfig(e){const t=e.data.config||{};this.config={organizationName:t.organizationName||"archiphoenix",enableVCS:t.enableVCS??!0,enableStateLocking:t.enableStateLocking??!0,enableRemoteState:t.enableRemoteState??!0,defaultTerraformVersion:t.defaultTerraformVersion||"1.5.0",workspaces:t.workspaces||[],runs:t.runs||[],states:t.states||[],runTriggerRate:t.runTriggerRate||.5,averagePlanDuration:t.averagePlanDuration||3e4,averageApplyDuration:t.averageApplyDuration||12e4,failureRate:t.failureRate??.05,changeProbability:t.changeProbability??.7,maxResourceAdditions:t.maxResourceAdditions||10,maxResourceChanges:t.maxResourceChanges||5,maxResourceDestructions:t.maxResourceDestructions||3,vcsWebhookProbability:t.vcsWebhookProbability??.3,defaultStateResources:t.defaultStateResources||10,durationVariation:t.durationVariation??.3,resourceTimeMultiplier:t.resourceTimeMultiplier||500},this.initializeWorkspaces(),this.initializeRuns(),this.initializeStates()}updateConfig(e){this.initializeConfig(e)}initializeWorkspaces(){this.workspaces.clear();const e=this.config?.workspaces||[];if(e.length===0){const t={id:"default",name:"production",description:"Production infrastructure",terraformVersion:this.config?.defaultTerraformVersion||"1.5.0",autoApply:!1,queueAllRuns:!0,workingDirectory:"/terraform"};this.workspaces.set("default",t);return}for(const t of e){const s={id:t.id,name:t.name,description:t.description,terraformVersion:t.terraformVersion||this.config?.defaultTerraformVersion||"1.5.0",autoApply:t.autoApply??!1,queueAllRuns:t.queueAllRuns??!0,workingDirectory:t.workingDirectory,vcsRepo:t.vcsRepo,variables:t.variables||[]};this.workspaces.set(s.id,s)}}initializeRuns(){const e=new Set(Array.from(this.activeRuns.keys())),t=new Set((this.config?.runs||[]).map(n=>n.id));for(const[n,i]of this.runHistory.entries())!e.has(n)&&!t.has(n)&&this.runHistory.delete(n);const s=this.config?.runs||[];for(const n of s){const i=this.workspaces.values().next().value;if(!i)continue;const a={id:n.id,workspaceId:i.id,workspaceName:n.workspace||i.name,status:n.status||"applied",createdAt:n.createdAt?new Date(n.createdAt).getTime():Date.now()-36e5,finishedAt:n.createdAt?new Date(n.createdAt).getTime()+(n.duration||12e4):Date.now()-348e4,duration:n.duration||12e4,planOnly:n.planOnly??!1,message:n.message,hasChanges:n.status==="applied"};["pending","planning","applying"].includes(a.status)?this.activeRuns.set(a.id,a):this.runHistory.set(a.id,a)}}initializeStates(){this.states.clear();const e=this.config?.states||[];if(e.length===0){const t=this.config?.defaultStateResources||10;for(const s of this.workspaces.values()){const n={id:`state-${s.id}`,workspaceId:s.id,workspaceName:s.name,version:1,serial:1,resources:t,updatedAt:Date.now()-(36e5+Math.random()*36e5),createdAt:Date.now()-(864e5+Math.random()*864e5)};this.states.set(n.id,n)}return}for(const t of e){const s=Array.from(this.workspaces.values()).find(i=>i.name===t.workspace);if(!s)continue;const n={id:t.id,workspaceId:s.id,workspaceName:t.workspace,version:t.version||1,serial:t.serial||1,resources:t.resources,updatedAt:t.updatedAt?new Date(t.updatedAt).getTime():Date.now(),createdAt:t.updatedAt?new Date(t.updatedAt).getTime()-864e5:Date.now()-864e5};this.states.set(n.id,n)}}performUpdate(e){this.config&&(this.updateActiveRuns(e),this.config.enableVCS&&this.triggerVCSWebhooks(e),this.triggerAutoRuns(e),this.updateMetrics())}updateActiveRuns(e){const t=Array.from(this.activeRuns.entries());for(const[s,n]of t){if(!["pending","planning","applying"].includes(n.status)){if(this.runHistory.set(s,n),this.runHistory.size>this.MAX_RUN_HISTORY){const x=this.runHistory.keys().next().value;x&&this.runHistory.delete(x)}this.activeRuns.delete(s);continue}if(!n.startedAt){n.startedAt=e;continue}const i=e-n.startedAt;let a;const l=this.getStateForWorkspace(n.workspaceId)?.resources||this.config?.defaultStateResources||10,d=this.config?.resourceTimeMultiplier||500,h=this.config?.averagePlanDuration||3e4,p=this.config?.averageApplyDuration||12e4,g=this.config?.durationVariation||.3,v=Math.log10(Math.max(1,l))*d,b=h+v,M=p+v*2;if(n.status==="pending"){n.status="planning";const S=n.estimatedPlanDuration||b,T=S*g*(Math.random()*2-1);a=S+T}else if(n.status==="planning"){const x=b*g*(Math.random()*2-1);if(a=b+x,i>=a){const S=this.config?.changeProbability??.7,T=Math.random()<S;if(n.hasChanges=T,T){const E=this.config?.maxResourceAdditions||10,A=this.config?.maxResourceChanges||5,k=this.config?.maxResourceDestructions||3,D=Math.min(1.5,1+l/100);n.resourceAdditions=Math.floor(Math.random()*E*D)+1,n.resourceChanges=Math.floor(Math.random()*A*D),n.resourceDestructions=Math.floor(Math.random()*k*D)}else n.resourceAdditions=0,n.resourceChanges=0,n.resourceDestructions=0;if(n.planOnly)n.status="planned",n.finishedAt=e,n.duration=i,n.message=T?`Plan completed with ${n.resourceAdditions+n.resourceChanges+n.resourceDestructions} changes`:"No changes detected";else if(this.workspaces.get(n.workspaceId)?.autoApply&&T){n.status="applying";const A=M*g*(Math.random()*2-1);a=M+A}else T?(n.status="planned",n.message=`Plan completed. ${n.resourceAdditions+n.resourceChanges+n.resourceDestructions} changes detected.`):(n.status="applied",n.finishedAt=e,n.duration=i,n.message="No changes detected")}}else if(n.status==="applying"){const x=M*g*(Math.random()*2-1);if(a=M+x,i>=a){const S=this.config?.failureRate??.05,T=Math.random()<S;n.status=T?"errored":"applied",n.finishedAt=e,n.duration=i,T?(n.error="Apply failed: resource provisioning error or validation failure",n.message=n.error):(n.message="Apply completed successfully",this.updateStateAfterApply(n))}}}}updateStateAfterApply(e){const t=Array.from(this.states.values()).find(n=>n.workspaceId===e.workspaceId);if(!t)return;t.version++,t.serial++,t.updatedAt=Date.now(),e.resourceAdditions!==void 0&&(t.resources=(t.resources||0)+e.resourceAdditions,e.resourceDestructions!==void 0&&(t.resources=Math.max(0,t.resources-e.resourceDestructions)));const s=this.workspaces.get(e.workspaceId);s&&(s.lastRun={id:e.id,status:e.status,createdAt:e.finishedAt||Date.now()})}triggerVCSWebhooks(e){for(const s of this.workspaces.values()){if(!s.vcsRepo)continue;const n=this.lastVCSWebhook.get(s.id)||0;if(e-n<36e5)continue;const i=this.config?.vcsWebhookProbability??.3;Math.random()<i&&(this.lastVCSWebhook.set(s.id,e),this.triggerRun(s.id,{source:"vcs"}))}}triggerAutoRuns(e){const s=36e5/(this.config?.runTriggerRate||.5);for(const n of this.workspaces.values()){const i=this.lastRunTime.get(n.id)||0;e-i>=s&&!Array.from(this.activeRuns.values()).some(l=>l.workspaceId===n.id&&["pending","planning","applying"].includes(l.status))&&n.queueAllRuns&&(this.lastRunTime.set(n.id,e),this.triggerRun(n.id,{source:"scheduled"}))}}triggerRun(e,t){const s=this.workspaces.get(e);if(!s)return{success:!1,reason:"Workspace not found"};if(Array.from(this.activeRuns.values()).some(v=>v.workspaceId===e&&["pending","planning","applying"].includes(v.status))&&!s.queueAllRuns)return{success:!1,reason:"Workspace already has an active run"};const i=Date.now(),a=`run-${e}-${i}`,l=this.getStateForWorkspace(e)?.resources||this.config?.defaultStateResources||10,d=this.config?.resourceTimeMultiplier||500,h=this.config?.averagePlanDuration||3e4,p=Math.log10(Math.max(1,l))*d,g={id:a,workspaceId:s.id,workspaceName:s.name,status:"pending",createdAt:i,planOnly:t?.planOnly??!1,source:t?.source||"api",triggeredBy:t?.triggeredBy||"user"};return g.estimatedPlanDuration=h+p,this.activeRuns.set(a,g),this.terraformMetrics.runsTotal++,this.terraformMetrics.runsPending++,s.lastRun={id:a,status:"pending",createdAt:i},{success:!0,runId:a}}cancelRun(e){const t=this.activeRuns.get(e);if(!t)return{success:!1,reason:"Run not found or not active"};if(!["pending","planning","applying"].includes(t.status))return{success:!1,reason:"Run is not in a cancelable state"};if(t.status="canceled",t.finishedAt=Date.now(),t.duration=t.startedAt?Date.now()-t.startedAt:0,t.message="Run canceled by user",this.runHistory.set(e,t),this.runHistory.size>this.MAX_RUN_HISTORY){const s=this.runHistory.keys().next().value;s&&this.runHistory.delete(s)}return this.activeRuns.delete(e),{success:!0}}updateMetrics(){const e=Array.from(this.activeRuns.values()).concat(Array.from(this.runHistory.values()));this.terraformMetrics.workspacesTotal=this.workspaces.size,this.terraformMetrics.statesTotal=this.states.size,this.terraformMetrics.runsRunning=Array.from(this.activeRuns.values()).filter(i=>["planning","applying"].includes(i.status)).length,this.terraformMetrics.runsPending=Array.from(this.activeRuns.values()).filter(i=>i.status==="pending").length,this.terraformMetrics.runsSuccess=e.filter(i=>i.status==="applied").length,this.terraformMetrics.runsFailed=e.filter(i=>i.status==="errored").length,this.terraformMetrics.resourcesManaged=Array.from(this.states.values()).reduce((i,a)=>i+(a.resources||0),0);const t=e.filter(i=>i.duration!==void 0);if(t.length>0){const i=t.reduce((a,o)=>a+(o.duration||0),0);this.terraformMetrics.averageRunDuration=i/t.length}const s=Date.now()-36e5,n=this.runHistoryList.filter(i=>i.timestamp>=s);this.terraformMetrics.runsPerHour=n.length}addRunToHistory(e){e.duration!==void 0&&(this.runHistoryList.push({timestamp:e.finishedAt||Date.now(),duration:e.duration,status:e.status}),this.runHistoryList.length>this.MAX_RUN_HISTORY_LIST&&this.runHistoryList.shift())}getMetrics(){return{...this.terraformMetrics}}getWorkspace(e){return this.workspaces.get(e)}getWorkspaces(){return Array.from(this.workspaces.values())}getRun(e){return this.activeRuns.get(e)||this.runHistory.get(e)}getActiveRuns(){return Array.from(this.activeRuns.values())}getRunsForWorkspace(e,t=100){return Array.from(this.activeRuns.values()).concat(Array.from(this.runHistory.values())).filter(n=>n.workspaceId===e).sort((n,i)=>(i.createdAt||0)-(n.createdAt||0)).slice(0,t)}getStateForWorkspace(e){return Array.from(this.states.values()).find(t=>t.workspaceId===e)}getStates(){return Array.from(this.states.values())}getConfig(){return this.config}}class $k{config=null;activeOperations=new Map;operationHistory=[];MAX_HISTORY_SIZE=1e3;pushLatencyHistory=[];pullLatencyHistory=[];scanLatencyHistory=[];MAX_LATENCY_HISTORY=500;harborMetrics={pushOperationsPerSecond:0,pullOperationsPerSecond:0,scanOperationsPerSecond:0,replicationOperationsPerSecond:0,averagePushLatency:0,averagePullLatency:0,averageScanLatency:0,storageUsed:0,storageTotal:100,totalProjects:0,totalRepositories:0,totalTags:0,totalVulnerabilities:0,scansCompleted:0,scansRunning:0,scansFailed:0,replicationPoliciesEnabled:0,activeReplications:0,gcOperationsTotal:0,gcStorageFreed:0};lastGCRun=0;initializeConfig(e){const t=e.data.config||{};this.config=t,this.updateMetricsFromConfig()}updateConfig(e){const t=e.data.config||{};this.config=t,this.updateMetricsFromConfig()}updateMetricsFromConfig(){if(!this.config)return;this.harborMetrics.totalProjects=this.config.projects?.length||0,this.harborMetrics.totalRepositories=this.config.repositories?.length||0,this.harborMetrics.totalTags=this.config.tags?.length||0;let e=0;this.config.projects&&(e=this.config.projects.reduce((s,n)=>s+(n.storageUsed||0),0)),this.harborMetrics.storageUsed=e;let t=0;this.config.tags&&this.config.tags.forEach(s=>{s.vulnerabilityScan?.totalVulnerabilities&&(t+=s.vulnerabilityScan.totalVulnerabilities)}),this.harborMetrics.totalVulnerabilities=t,this.harborMetrics.replicationPoliciesEnabled=(this.config.replicationPolicies||[]).filter(s=>s.enabled).length,this.harborMetrics.scansRunning=(this.config.tags||[]).filter(s=>s.vulnerabilityScan?.status==="running").length}performUpdate(e,t=!1){this.config&&(t&&this.simulatePushPullOperations(e),(this.config.enableVulnerabilityScanning||this.config.enableImageScanning)&&this.simulateVulnerabilityScans(e),this.config.replicationPolicies&&this.config.replicationPolicies.length>0&&this.simulateReplication(e),this.config.enableGarbageCollection&&this.simulateGarbageCollection(e),this.updateActiveOperations(e),this.updateMetrics(e))}simulatePushPullOperations(e){if(!this.config?.repositories||this.config.repositories.length===0)return;const t=Math.min(2,.1+this.config.repositories.length/10);if(Math.random()<t/10){const s=this.config.repositories[Math.floor(Math.random()*this.config.repositories.length)];Math.random()<.3?this.simulatePush(s,e):this.simulatePull(s,e)}}simulatePush(e,t){const s=`push-${t}-${Math.random()}`,n=50+Math.random()*500,i=500+Math.random()*1500,a=t+i,o={id:s,type:"push",repository:e.name,project:e.project,startTime:t,status:"running",size:n,completionTime:a};this.activeOperations.set(s,o)}simulatePull(e,t){const s=`pull-${t}-${Math.random()}`,n=200+Math.random()*800,i=t+n,a={id:s,type:"pull",repository:e.name,project:e.project,startTime:t,status:"running",completionTime:i};this.activeOperations.set(s,a)}simulateVulnerabilityScans(e){if(!this.config?.tags)return;const t=this.config.tags.filter(s=>{const n=s.vulnerabilityScan;return!n||n.status==="pending"||n.status==="completed"&&this.shouldRescan(s)});if(t.length!==0){if(this.harborMetrics.scansRunning<3&&Math.random()<.1){const s=t[Math.floor(Math.random()*t.length)];this.startVulnerabilityScan(s.id,e)}this.completeVulnerabilityScans(e)}}startVulnerabilityScan(e,t){if(!this.config?.tags)return;const s=this.config.tags.find(d=>d.id===e);if(!s)return;const n=`scan-${e}-${t}`,i=5e3+Math.random()*15e3,a=t+i,o={id:n,type:"scan",repository:s.repository,tag:s.name,startTime:t,status:"running",completionTime:a};this.activeOperations.set(n,o),this.harborMetrics.scansRunning++;const l=this.config.tags.map(d=>d.id===e?{...d,vulnerabilityScan:{status:"running",severity:"none",scannedAt:new Date(t).toISOString()}}:d);this.config.tags=l}completeVulnerabilityScans(e){}shouldRescan(e){if(!e.vulnerabilityScan?.scannedAt)return!0;const t=new Date(e.vulnerabilityScan.scannedAt).getTime(),s=Date.now()-t,n=10080*60*1e3;return s>n}simulateReplication(e){if(!this.config?.replicationPolicies)return;const t=this.config.replicationPolicies.filter(s=>s.enabled);t.length!==0&&t.forEach(s=>{if(s.trigger==="event-based"&&Math.random()<.05)this.simulateReplicationOperation(s,e);else if(s.trigger==="scheduled"){const n=this.getLastReplicationRun(s.id);e-n>36e5&&(this.simulateReplicationOperation(s,e),this.setLastReplicationRun(s.id,e))}})}lastReplicationRuns=new Map;getLastReplicationRun(e){return this.lastReplicationRuns.get(e)||0}setLastReplicationRun(e,t){this.lastReplicationRuns.set(e,t)}simulateReplicationOperation(e,t){const s=`replication-${e.id}-${t}`,n=2e3+Math.random()*5e3,i=t+n,a={id:s,type:"replication",startTime:t,status:"running",completionTime:i};this.activeOperations.set(s,a),this.harborMetrics.activeReplications++}simulateGarbageCollection(e){this.config?.gcSchedule&&e-this.lastGCRun>1440*60*1e3&&(this.runGarbageCollection(e),this.lastGCRun=e)}runGarbageCollection(e){const t=`gc-${e}`,s=3e4+Math.random()*6e4,n=e+s,i=Math.random()*5,a={id:t,type:"gc",startTime:e,status:"running",completionTime:n,size:i*1024};this.activeOperations.set(t,a)}updateActiveOperations(e){const t=[];for(const[n,i]of this.activeOperations.entries())i.completionTime&&e>=i.completionTime&&i.status==="running"&&t.push(i);for(const n of t)this.completeOperation(n,e);const s=e-6e4;for(const[n,i]of this.activeOperations.entries())i.startTime<s&&i.status==="completed"&&this.activeOperations.delete(n)}completeOperation(e,t){const s=e.completionTime?e.completionTime-e.startTime:0;switch(e.status="completed",e.duration=s,this.activeOperations.delete(e.id),this.addOperationToHistory(e),e.type){case"push":this.config&&e.size&&(this.harborMetrics.storageUsed+=e.size/1024),s>0&&(this.pushLatencyHistory.push(s),this.pushLatencyHistory.length>this.MAX_LATENCY_HISTORY&&this.pushLatencyHistory.shift());break;case"pull":s>0&&(this.pullLatencyHistory.push(s),this.pullLatencyHistory.length>this.MAX_LATENCY_HISTORY&&this.pullLatencyHistory.shift());break;case"scan":if(this.config?.tags&&e.id){const n=e.id.match(/^scan-(.+?)-/);if(n){const i=n[1];if(this.config.tags.find(o=>o.id===i)){const o=Math.floor(Math.random()*3),l=Math.floor(Math.random()*5),d=Math.floor(Math.random()*10),h=Math.floor(Math.random()*15),p=o+l+d+h,g=o>0?"critical":l>0?"high":d>0?"medium":h>0?"low":"none",v=this.config.tags.map(b=>b.id===i?{...b,vulnerabilityScan:{status:"completed",severity:g,totalVulnerabilities:p,critical:o,high:l,medium:d,low:h,scannedAt:new Date(t).toISOString(),scanDuration:s}}:b);this.config.tags=v,this.harborMetrics.scansRunning=Math.max(0,this.harborMetrics.scansRunning-1),this.harborMetrics.scansCompleted++,this.scanLatencyHistory.push(s),this.scanLatencyHistory.length>this.MAX_LATENCY_HISTORY&&this.scanLatencyHistory.shift()}}}break;case"replication":this.harborMetrics.activeReplications=Math.max(0,this.harborMetrics.activeReplications-1);break;case"gc":if(e.size){const n=e.size/1024;this.harborMetrics.gcOperationsTotal++,this.harborMetrics.gcStorageFreed+=n,this.harborMetrics.storageUsed=Math.max(0,this.harborMetrics.storageUsed-n)}break}}addOperationToHistory(e){this.operationHistory.push(e),this.operationHistory.length>this.MAX_HISTORY_SIZE&&this.operationHistory.shift()}updateMetrics(e){const t=e-1e4,s=this.operationHistory.filter(n=>n.startTime>t);this.harborMetrics.pushOperationsPerSecond=s.filter(n=>n.type==="push").length/10,this.harborMetrics.pullOperationsPerSecond=s.filter(n=>n.type==="pull").length/10,this.harborMetrics.scanOperationsPerSecond=s.filter(n=>n.type==="scan").length/10,this.harborMetrics.replicationOperationsPerSecond=s.filter(n=>n.type==="replication").length/10,this.pushLatencyHistory.length>0&&(this.harborMetrics.averagePushLatency=this.pushLatencyHistory.reduce((n,i)=>n+i,0)/this.pushLatencyHistory.length),this.pullLatencyHistory.length>0&&(this.harborMetrics.averagePullLatency=this.pullLatencyHistory.reduce((n,i)=>n+i,0)/this.pullLatencyHistory.length),this.scanLatencyHistory.length>0&&(this.harborMetrics.averageScanLatency=this.scanLatencyHistory.reduce((n,i)=>n+i,0)/this.scanLatencyHistory.length),this.updateMetricsFromConfig()}calculateLoad(){const e=this.harborMetrics.pushOperationsPerSecond+this.harborMetrics.pullOperationsPerSecond+this.harborMetrics.scanOperationsPerSecond+this.harborMetrics.replicationOperationsPerSecond,t=(this.harborMetrics.averagePushLatency*this.harborMetrics.pushOperationsPerSecond+this.harborMetrics.averagePullLatency*this.harborMetrics.pullOperationsPerSecond+this.harborMetrics.averageScanLatency*this.harborMetrics.scanOperationsPerSecond)/Math.max(1,this.harborMetrics.pushOperationsPerSecond+this.harborMetrics.pullOperationsPerSecond+this.harborMetrics.scanOperationsPerSecond),s=this.operationHistory.filter(d=>d.status==="failed").length,n=Math.min(1,s/Math.max(1,this.operationHistory.length)),i=Math.min(.95,.1+e/10*.4),a=Math.min(.95,.2+this.harborMetrics.storageUsed/this.harborMetrics.storageTotal*.5),o=this.harborMetrics.storageUsed/this.harborMetrics.storageTotal,l=Math.min(.95,e/20*.6);return{throughput:e,averageLatency:t||0,errorRate:n,cpuUtilization:i,memoryUtilization:a,storageUtilization:o,networkUtilization:l}}getMetrics(){return{...this.harborMetrics}}getConfig(){return this.config?{...this.config}:null}}class Bk{config;connected=!1;eventSubscribers=new Set;eventStream=null;reconnectAttempts=0;MAX_RECONNECT_ATTEMPTS=5;reconnectTimeout=3e3;constructor(e){this.config=e}getBaseUrl(){if(this.config.type==="local")return"/api/docker";{const e=this.config.useTLS?"https":"http",t=this.config.host||"localhost",s=this.config.port||2376;return`${e}://${t}:${s}`}}async request(e,t,s,n){const i=`${this.getBaseUrl()}${t}`,a=n?.timeout||this.config.timeout||3e4,o=new AbortController,l=setTimeout(()=>o.abort(),a);try{const d={"Content-Type":"application/json"};this.config.useTLS&&this.config.clientCert&&this.config.clientKey&&(d["X-Client-Cert"]=this.config.clientCert,d["X-Client-Key"]=this.config.clientKey);const h=await fetch(i,{method:e,headers:d,body:s?JSON.stringify(s):void 0,signal:o.signal});if(clearTimeout(l),!h.ok){const g=await h.text();throw new Error(`Docker API error: ${h.status} ${h.statusText} - ${g}`)}const p=h.headers.get("content-type");return p&&p.includes("application/json")?await h.json():{}}catch(d){throw clearTimeout(l),d.name==="AbortError"?new Error(`Request timeout after ${a}ms`):d}}async connect(){try{return await this.getSystemInfo()?(this.connected=!0,this.reconnectAttempts=0,this.startEventStream(),!0):!1}catch(e){return this.connected=!1,console.error("Failed to connect to Docker daemon:",e),!1}}async disconnect(){this.connected=!1,this.stopEventStream(),this.eventSubscribers.clear()}isConnected(){return this.connected}async testConnection(){try{return{success:!!await this.getSystemInfo()}}catch(e){return{success:!1,error:e.message}}}startEventStream(){if(this.eventSubscribers.size!==0)try{const e=`${this.getBaseUrl()}/events`;this.pollEvents()}catch(e){console.error("Failed to start event stream:",e)}}stopEventStream(){this.eventStream&&(this.eventStream.close(),this.eventStream=null)}async pollEvents(){}async listContainers(){return(await this.request("GET","/containers/json?all=true")).map(this.mapContainerFromAPI)}async getContainer(e){try{const t=await this.request("GET",`/containers/${e}/json`);return this.mapContainerFromAPI(t)}catch(t){if(t.message.includes("404"))return null;throw t}}async createContainer(e){const t=this.mapContainerConfigToAPI(e),s=await this.request("POST","/containers/create",t);return await this.getContainer(s.Id)||this.createContainerFromConfig(e,s.Id)}async startContainer(e){await this.request("POST",`/containers/${e}/start`)}async stopContainer(e){await this.request("POST",`/containers/${e}/stop`)}async pauseContainer(e){await this.request("POST",`/containers/${e}/pause`)}async unpauseContainer(e){await this.request("POST",`/containers/${e}/unpause`)}async restartContainer(e){await this.request("POST",`/containers/${e}/restart`)}async removeContainer(e,t=!1){await this.request("DELETE",`/containers/${e}?force=${t}`)}async listImages(){return(await this.request("GET","/images/json")).map(this.mapImageFromAPI)}async pullImage(e,t="latest"){await this.request("POST",`/images/create?fromImage=${e}&tag=${t}`);const n=(await this.listImages()).find(i=>i.repository===e&&i.tag===t);if(!n)throw new Error(`Failed to find pulled image ${e}:${t}`);return n}async buildImage(e){throw new Error("Build image not fully implemented - requires streaming support")}async removeImage(e,t=!1){await this.request("DELETE",`/images/${e}?force=${t}`)}async listNetworks(){return(await this.request("GET","/networks")).map(this.mapNetworkFromAPI)}async createNetwork(e){const t=this.mapNetworkConfigToAPI(e),s=await this.request("POST","/networks/create",t),i=(await this.listNetworks()).find(a=>a.id===s.Id);if(!i)throw new Error(`Failed to find created network ${s.Id}`);return i}async removeNetwork(e){await this.request("DELETE",`/networks/${e}`)}async listVolumes(){return(await this.request("GET","/volumes")).Volumes.map(this.mapVolumeFromAPI)}async createVolume(e){const t=this.mapVolumeConfigToAPI(e),s=await this.request("POST","/volumes/create",t),i=(await this.listVolumes()).find(a=>a.name===s.Name);if(!i)throw new Error(`Failed to find created volume ${s.Name}`);return i}async removeVolume(e){await this.request("DELETE",`/volumes/${e}`)}async getContainerStats(e){try{const t=await this.request("GET",`/containers/${e}/stats?stream=false`);return this.mapStatsFromAPI(t,e)}catch(t){if(t.message.includes("404"))return null;throw t}}async getSystemInfo(){try{const e=await this.request("GET","/info"),t=await this.request("GET","/version");return this.mapSystemInfoFromAPI(e,t)}catch(e){return console.error("Failed to get system info:",e),null}}subscribeToEvents(e){return this.eventSubscribers.add(e),this.connected&&!this.eventStream&&this.startEventStream(),()=>{this.eventSubscribers.delete(e),this.eventSubscribers.size===0&&this.stopEventStream()}}mapContainerFromAPI(e){const s=(e.Names||[])[0]?.replace(/^\//,"")||e.Id?.substring(0,12)||"unknown";return{id:e.Id||e.ID||"",name:s,image:e.Image||"",imageId:e.ImageID||"",status:this.mapContainerStatus(e.Status||e.State||"unknown"),createdAt:e.Created?new Date(e.Created).getTime():Date.now(),startedAt:e.StartedAt?new Date(e.StartedAt).getTime():void 0,finishedAt:e.FinishedAt?new Date(e.FinishedAt).getTime():void 0,restartCount:e.RestartCount||0,ports:this.mapPortsFromAPI(e.Ports),environment:e.Env?this.parseEnvVars(e.Env):void 0,volumes:e.Mounts?e.Mounts.map(n=>n.Name||n.Source):void 0,networks:e.NetworkSettings?Object.keys(e.NetworkSettings.Networks||{}):void 0,health:this.mapHealthStatus(e.Health)}}mapContainerStatus(e){const t=e.toLowerCase();return t.includes("running")?"running":t.includes("paused")?"paused":t.includes("restarting")?"restarting":t.includes("removing")?"removing":t.includes("exited")||t.includes("stopped")?"exited":t.includes("dead")?"dead":"created"}mapPortsFromAPI(e){if(e)return e.map(t=>({containerPort:t.PrivatePort||t.ContainerPort||0,hostPort:t.PublicPort||t.HostPort,protocol:(t.Type||"tcp").toLowerCase()}))}parseEnvVars(e){const t={};for(const s of e){const[n,...i]=s.split("=");n&&(t[n]=i.join("="))}return t}mapHealthStatus(e){if(!e)return"none";const t=e.Status||e.status||"";return t==="healthy"?"healthy":t==="unhealthy"?"unhealthy":t==="starting"?"starting":"none"}mapImageFromAPI(e){const t=e.RepoTags&&e.RepoTags[0]||"<none>:<none>",[s,n]=t.split(":");return{id:e.Id||e.ID||"",repository:s||"<none>",tag:n||"latest",digest:e.RepoDigests?.[0]?.split("@")[1],size:e.Size||0,createdAt:e.Created?new Date(e.Created*1e3).getTime():Date.now(),layers:e.Layers?.length}}mapNetworkFromAPI(e){return{id:e.Id||e.ID||"",name:e.Name||"",driver:e.Driver||"bridge",scope:e.Scope||"local",subnet:e.IPAM?.Config?.[0]?.Subnet,gateway:e.IPAM?.Config?.[0]?.Gateway,containers:e.Containers?Object.keys(e.Containers):void 0,created:e.Created?new Date(e.Created).getTime():Date.now(),internal:e.Internal||!1,enableIPv6:e.EnableIPv6||!1}}mapVolumeFromAPI(e){return{id:e.Name||e.Driver||"",name:e.Name||"",driver:e.Driver||"local",mountpoint:e.Mountpoint,size:e.UsageData?.Size,usedBy:e.UsageData?.RefCount?[e.UsageData.RefCount]:void 0,created:e.CreatedAt?new Date(e.CreatedAt).getTime():Date.now(),labels:e.Labels}}mapStatsFromAPI(e,t){const s=e.cpu_stats?.cpu_usage?.total_usage-(e.precpu_stats?.cpu_usage?.total_usage||0),n=e.cpu_stats?.system_cpu_usage-(e.precpu_stats?.system_cpu_usage||0),i=e.cpu_stats?.online_cpus||1,a=n>0?s/n*i*100:0,o=e.memory_stats?.usage||0,l=e.memory_stats?.limit||0,d=e.networks?Object.values(e.networks).reduce((p,g)=>p+(g.rx_bytes||0),0):0,h=e.networks?Object.values(e.networks).reduce((p,g)=>p+(g.tx_bytes||0),0):0;return{id:t,name:e.name||"",cpuUsage:Math.min(100,Math.max(0,a)),memoryUsage:o,memoryLimit:l,networkRx:d,networkTx:h,timestamp:Date.now()}}mapSystemInfoFromAPI(e,t){return{version:t.Version||"unknown",apiVersion:t.ApiVersion||"unknown",os:e.OperatingSystem||"unknown",arch:e.Architecture||"unknown",kernelVersion:e.KernelVersion||"unknown",totalMemory:e.MemTotal||0,totalCpus:e.NCPU||0,containers:e.Containers||0,containersRunning:e.ContainersRunning||0,containersPaused:e.ContainersPaused||0,containersStopped:e.ContainersStopped||0,images:e.Images||0,imagesSize:0}}mapContainerConfigToAPI(e){const t={Image:e.image,Cmd:e.command,Env:e.env?Object.entries(e.env).map(([s,n])=>`${s}=${n}`):void 0,HostConfig:{}};if(e.ports){t.ExposedPorts={},t.HostConfig.PortBindings={};for(const s of e.ports){const n=`${s.containerPort}/${s.protocol||"tcp"}`;t.ExposedPorts[n]={},s.hostPort&&(t.HostConfig.PortBindings[n]=[{HostPort:s.hostPort.toString()}])}}if(e.volumes&&(t.Volumes={},t.HostConfig.Binds=e.volumes),e.memoryLimit&&(t.HostConfig.Memory=e.memoryLimit),e.cpuLimit){const s=parseFloat(e.cpuLimit);isNaN(s)||(t.HostConfig.CpuQuota=Math.floor(s*1e5),t.HostConfig.CpuPeriod=1e5)}return e.restartPolicy&&(t.HostConfig.RestartPolicy={Name:e.restartPolicy}),e.healthCheck&&(t.Healthcheck={Test:e.healthCheck.test,Interval:e.healthCheck.interval||3e10,Timeout:e.healthCheck.timeout||5e9,Retries:e.healthCheck.retries||3,StartPeriod:e.healthCheck.startPeriod||0}),t}createContainerFromConfig(e,t){return{id:t,name:e.name||t.substring(0,12),image:e.image,imageId:"",status:"created",createdAt:Date.now(),restartCount:0,ports:e.ports,environment:e.env,volumes:e.volumes,networks:e.networks,health:"none"}}mapNetworkConfigToAPI(e){return{Name:e.name,Driver:e.driver||"bridge",IPAM:e.subnet||e.gateway?{Config:[{Subnet:e.subnet,Gateway:e.gateway}]}:void 0,Internal:e.internal||!1,EnableIPv6:e.enableIPv6||!1,Labels:e.labels}}mapVolumeConfigToAPI(e){return{Name:e.name,Driver:e.driver||"local",Labels:e.labels,DriverOpts:e.options}}}class Uk{containers=new Map;images=new Map;networks=new Map;volumes=new Map;eventSubscribers=new Set;statsCache=new Map;systemInfo=null;constructor(e,t,s,n){if(e&&Array.isArray(e))for(const i of e)this.containers.set(i.id,{...i});if(t&&Array.isArray(t))for(const i of t)this.images.set(i.id,{...i});if(s&&Array.isArray(s))for(const i of s)this.networks.set(i.id,{...i});if(n&&Array.isArray(n))for(const i of n)this.volumes.set(i.id,{...i});this.systemInfo={version:"24.0.0",apiVersion:"1.43",os:"linux",arch:"amd64",kernelVersion:"5.15.0",totalMemory:16*1024*1024*1024,totalCpus:8,containers:this.containers.size,containersRunning:Array.from(this.containers.values()).filter(i=>i.status==="running").length,containersPaused:Array.from(this.containers.values()).filter(i=>i.status==="paused").length,containersStopped:Array.from(this.containers.values()).filter(i=>i.status==="exited"||i.status==="dead").length,images:this.images.size,imagesSize:Array.from(this.images.values()).reduce((i,a)=>i+a.size,0)}}async connect(){return!0}async disconnect(){this.eventSubscribers.clear()}isConnected(){return!0}async testConnection(){return{success:!0}}async listContainers(){return Array.from(this.containers.values())}async getContainer(e){return this.containers.get(e)||null}async createContainer(e){const t=`sim-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,s={id:t,name:e.name||t.substring(0,12),image:e.image,imageId:"",status:"created",createdAt:Date.now(),restartCount:0,ports:e.ports,environment:e.env,volumes:e.volumes,networks:e.networks,health:"none",memoryLimit:e.memoryLimit};return this.containers.set(t,s),this.emitEvent("container","create",t,{}),s}async startContainer(e){const t=this.containers.get(e);if(!t)throw new Error(`Container ${e} not found`);t.status="running",t.startedAt=Date.now(),this.emitEvent("container","start",e,{})}async stopContainer(e){const t=this.containers.get(e);if(!t)throw new Error(`Container ${e} not found`);t.status="exited",t.finishedAt=Date.now(),t.cpuUsage=0,t.memoryUsage=0,this.emitEvent("container","stop",e,{})}async pauseContainer(e){const t=this.containers.get(e);if(!t)throw new Error(`Container ${e} not found`);t.status="paused",this.emitEvent("container","pause",e,{})}async unpauseContainer(e){const t=this.containers.get(e);if(!t)throw new Error(`Container ${e} not found`);t.status="running",this.emitEvent("container","unpause",e,{})}async restartContainer(e){const t=this.containers.get(e);if(!t)throw new Error(`Container ${e} not found`);t.status="running",t.startedAt=Date.now(),t.restartCount=(t.restartCount||0)+1,this.emitEvent("container","restart",e,{})}async removeContainer(e,t=!1){const s=this.containers.get(e);if(!s)throw new Error(`Container ${e} not found`);if(s.status==="running"&&!t)throw new Error("Cannot remove running container without force");this.containers.delete(e),this.statsCache.delete(e),this.emitEvent("container","destroy",e,{})}async listImages(){return Array.from(this.images.values())}async pullImage(e,t="latest"){await new Promise(i=>setTimeout(i,1e3));const s=`img-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={id:s,repository:e,tag:t,size:100*1024*1024+Math.random()*500*1024*1024,createdAt:Date.now(),pulledAt:Date.now()};return this.images.set(s,n),this.emitEvent("image","pull",s,{repository:e,tag:t}),n}async buildImage(e){await new Promise(a=>setTimeout(a,2e3));const t=`img-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,[s,n]=e.tag.split(":"),i={id:t,repository:s||e.tag,tag:n||"latest",size:200*1024*1024+Math.random()*800*1024*1024,createdAt:Date.now(),builtAt:Date.now()};return this.images.set(t,i),this.emitEvent("image","build",t,{tag:e.tag}),i}async removeImage(e,t=!1){if(!this.images.get(e))throw new Error(`Image ${e} not found`);this.images.delete(e),this.emitEvent("image","delete",e,{})}async listNetworks(){return Array.from(this.networks.values())}async createNetwork(e){const t=`net-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,s={id:t,name:e.name,driver:e.driver||"bridge",scope:"local",subnet:e.subnet,gateway:e.gateway,created:Date.now(),internal:e.internal||!1,enableIPv6:e.enableIPv6||!1};return this.networks.set(t,s),this.emitEvent("network","create",t,{name:e.name}),s}async removeNetwork(e){if(!this.networks.get(e))throw new Error(`Network ${e} not found`);this.networks.delete(e),this.emitEvent("network","destroy",e,{})}async listVolumes(){return Array.from(this.volumes.values())}async createVolume(e){const t=`vol-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,s={id:t,name:e.name,driver:e.driver||"local",created:Date.now(),labels:e.labels};return this.volumes.set(t,s),this.emitEvent("volume","create",t,{name:e.name}),s}async removeVolume(e){if(!this.volumes.get(e))throw new Error(`Volume ${e} not found`);this.volumes.delete(e),this.emitEvent("volume","destroy",e,{})}async getContainerStats(e){const t=this.containers.get(e);if(!t||t.status!=="running")return null;let s=this.statsCache.get(e);return s||(s={id:e,name:t.name,cpuUsage:t.cpuUsage||10+Math.random()*70,memoryUsage:t.memoryUsage||(t.memoryLimit||512*1024*1024)*.3,memoryLimit:t.memoryLimit||512*1024*1024,networkRx:t.networkRx||0,networkTx:t.networkTx||0,timestamp:Date.now()},this.statsCache.set(e,s)),s.cpuUsage=t.cpuUsage||s.cpuUsage,s.memoryUsage=t.memoryUsage||s.memoryUsage,s.networkRx=t.networkRx||s.networkRx,s.networkTx=t.networkTx||s.networkTx,s.timestamp=Date.now(),s}async getSystemInfo(){return this.systemInfo?(this.systemInfo.containers=this.containers.size,this.systemInfo.containersRunning=Array.from(this.containers.values()).filter(e=>e.status==="running").length,this.systemInfo.containersPaused=Array.from(this.containers.values()).filter(e=>e.status==="paused").length,this.systemInfo.containersStopped=Array.from(this.containers.values()).filter(e=>e.status==="exited"||e.status==="dead").length,this.systemInfo.images=this.images.size,this.systemInfo.imagesSize=Array.from(this.images.values()).reduce((e,t)=>e+t.size,0),{...this.systemInfo}):null}subscribeToEvents(e){return this.eventSubscribers.add(e),()=>{this.eventSubscribers.delete(e)}}emitEvent(e,t,s,n){const i={id:`evt-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:e,action:t,actor:{id:s,attributes:n},time:Math.floor(Date.now()/1e3),timeNano:Date.now()*1e6};for(const a of this.eventSubscribers)try{a(i)}catch(o){console.error("Error in event callback:",o)}}updateContainerStats(e,t){const s=this.containers.get(e);s&&(t.cpuUsage!==void 0&&(s.cpuUsage=t.cpuUsage),t.memoryUsage!==void 0&&(s.memoryUsage=t.memoryUsage),t.memoryLimit!==void 0&&(s.memoryLimit=t.memoryLimit),t.networkRx!==void 0&&(s.networkRx=t.networkRx),t.networkTx!==void 0&&(s.networkTx=t.networkTx))}}class Fk{config=null;mode="simulation";simulationProvider=null;realProvider=null;currentProvider=null;activeOperations=new Map;operationHistory=[];MAX_HISTORY_SIZE=1e3;operationLatencyHistory=[];MAX_LATENCY_HISTORY=500;containers=new Map;syncInterval=null;syncEnabled=!1;lastSyncTime=0;dockerMetrics={containersTotal:0,containersRunning:0,containersStopped:0,containersPaused:0,imagesTotal:0,imagesSize:0,networksTotal:0,volumesTotal:0,volumesSize:0,operationsPerSecond:0,averageOperationLatency:0,totalCpuUsage:0,totalMemoryUsage:0,totalMemoryLimit:0,totalNetworkRx:0,totalNetworkTx:0,buildOperationsPerSecond:0,pullOperationsPerSecond:0,pushOperationsPerSecond:0};lastUpdateTime=Date.now();initializeConfig(e){const t=e.data.config||{};if(Array.isArray(t.images)||(t.images=[]),Array.isArray(t.networks)||(t.networks=[]),Array.isArray(t.volumes)||(t.volumes=[]),Array.isArray(t.containers)||(t.containers=[]),this.config=t,this.mode=t.mode||"simulation",this.initializeProviders(),t.containers&&Array.isArray(t.containers))for(const s of t.containers)this.containers.set(s.id,{...s});this.updateMetricsFromConfig(),this.mode!=="simulation"&&t.syncSettings?.enabled&&this.startSync()}initializeProviders(){const e=Array.isArray(this.config?.containers)?this.config.containers:void 0,t=Array.isArray(this.config?.images)?this.config.images:void 0,s=Array.isArray(this.config?.networks)?this.config.networks:void 0,n=Array.isArray(this.config?.volumes)?this.config.volumes:void 0;if(this.simulationProvider=new Uk(e,t,s,n),(this.mode==="real"||this.mode==="hybrid")&&this.config?.dockerConnection){const i={type:this.config.dockerConnection.type,url:this.config.dockerConnection.url,host:this.config.dockerConnection.host,port:this.config.dockerConnection.port,useTLS:this.config.dockerConnection.useTLS,caCert:this.config.dockerConnection.caCert,clientCert:this.config.dockerConnection.clientCert,clientKey:this.config.dockerConnection.clientKey};this.realProvider=new Bk(i)}this.currentProvider=this.mode==="simulation"?this.simulationProvider:this.realProvider||this.simulationProvider}setMode(e){this.mode!==e&&(this.mode=e,this.stopSync(),this.initializeProviders(),this.mode!=="simulation"&&this.config?.syncSettings?.enabled&&this.startSync())}getMode(){return this.mode}startSync(){if(this.syncInterval)return;const e=this.config?.syncSettings?.interval||2e3;this.syncEnabled=!0,this.syncFromProvider(),this.syncInterval=setInterval(()=>{this.syncFromProvider()},e),this.config?.syncSettings?.useEvents&&this.currentProvider&&this.currentProvider.subscribeToEvents(t=>{this.handleDockerEvent(t)})}stopSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null),this.syncEnabled=!1}async syncFromProvider(){if(!(!this.currentProvider||!this.currentProvider.isConnected()))try{const e=await this.currentProvider.listContainers();this.syncContainers(e);const t=await this.currentProvider.listImages();this.config&&(this.config.images=Array.isArray(t)?t:[]);const s=await this.currentProvider.listNetworks();this.config&&(this.config.networks=Array.isArray(s)?s:[]);const n=await this.currentProvider.listVolumes();this.config&&(this.config.volumes=Array.isArray(n)?n:[]),this.lastSyncTime=Date.now(),this.updateMetricsFromConfig()}catch(e){console.error("Failed to sync from Docker provider:",e)}}syncContainers(e){for(const s of e){const n=this.containers.get(s.id);n?Object.assign(n,s):this.containers.set(s.id,{...s})}const t=new Set(e.map(s=>s.id));for(const[s]of this.containers.entries())t.has(s)||this.containers.delete(s);this.config&&(this.config.containers=Array.from(this.containers.values()))}handleDockerEvent(e){switch(e.type){case"container":this.handleContainerEvent(e);break;case"image":this.handleImageEvent(e);break;case"network":this.handleNetworkEvent(e);break;case"volume":this.handleVolumeEvent(e);break}}handleContainerEvent(e){const t=e.actor.id;e.action==="destroy"||e.action==="die"?this.containers.delete(t):this.currentProvider&&this.currentProvider.getContainer(t).then(s=>{s&&this.containers.set(t,s)})}handleImageEvent(e){}handleNetworkEvent(e){}handleVolumeEvent(e){}updateConfig(e){const t=e.data.config||{};Array.isArray(t.images)||(t.images=[]),Array.isArray(t.networks)||(t.networks=[]),Array.isArray(t.volumes)||(t.volumes=[]),Array.isArray(t.containers)||(t.containers=[]),this.config;const s=this.mode;this.config=t;const n=t.mode||"simulation";if(n!==s&&this.setMode(n),t.containers&&Array.isArray(t.containers)){const i=new Set(t.containers.map(a=>a.id));for(const[a,o]of this.containers.entries())i.has(a)||this.containers.delete(a);for(const a of t.containers){const o=this.containers.get(a.id);if(o){const l={...o,name:a.name,image:a.image,imageId:a.imageId,ports:a.ports,environment:a.environment,volumes:a.volumes,networks:a.networks,health:a.health,cpuUsage:o.status==="running"?o.cpuUsage:a.cpuUsage,memoryUsage:o.status==="running"?o.memoryUsage:a.memoryUsage,memoryLimit:a.memoryLimit||o.memoryLimit,networkRx:o.status==="running"?o.networkRx:a.networkRx,networkTx:o.status==="running"?o.networkTx:a.networkTx,status:a.status||o.status,createdAt:a.createdAt||o.createdAt,startedAt:a.startedAt||o.startedAt,finishedAt:a.finishedAt||o.finishedAt,restartCount:a.restartCount!==void 0?a.restartCount:o.restartCount,exitCode:a.exitCode!==void 0?a.exitCode:o.exitCode};this.containers.set(a.id,l)}else{const l={id:a.id,name:a.name,image:a.image,imageId:a.imageId,status:a.status||"created",createdAt:a.createdAt||Date.now(),startedAt:a.startedAt,finishedAt:a.finishedAt,restartCount:a.restartCount||0,cpuUsage:a.cpuUsage,memoryUsage:a.memoryUsage,memoryLimit:a.memoryLimit,networkRx:a.networkRx,networkTx:a.networkTx,ports:a.ports,environment:a.environment,volumes:a.volumes,networks:a.networks,health:a.health,exitCode:a.exitCode};this.containers.set(a.id,l)}}}this.updateMetricsFromConfig()}updateMetricsFromConfig(){if(!this.config)return;this.dockerMetrics.containersTotal=this.containers.size,this.dockerMetrics.containersRunning=Array.from(this.containers.values()).filter(n=>n.status==="running").length,this.dockerMetrics.containersStopped=Array.from(this.containers.values()).filter(n=>n.status==="exited"||n.status==="dead").length,this.dockerMetrics.containersPaused=Array.from(this.containers.values()).filter(n=>n.status==="paused").length;const e=Array.isArray(this.config.images)?this.config.images:[];this.dockerMetrics.imagesTotal=e.length,this.dockerMetrics.imagesSize=e.reduce((n,i)=>n+(i.size||0),0);const t=Array.isArray(this.config.networks)?this.config.networks:[];this.dockerMetrics.networksTotal=t.length;const s=Array.isArray(this.config.volumes)?this.config.volumes:[];this.dockerMetrics.volumesTotal=s.length,this.dockerMetrics.volumesSize=s.reduce((n,i)=>n+(i.size||0),0)}performUpdate(e,t=!1){if(!this.config)return;const s=e-this.lastUpdateTime;this.lastUpdateTime=e,this.mode!=="simulation"&&this.currentProvider?.isConnected()&&this.updateContainerStatsFromProvider(),this.mode==="simulation"&&t&&this.simulateContainerOperations(e),this.mode==="simulation"&&this.simulateImageOperations(e,t),this.mode==="simulation"&&this.updateContainerResources(s),this.updateActiveOperations(e),this.updateMetrics(e)}async updateContainerStatsFromProvider(){if(!this.currentProvider)return;const e=Array.from(this.containers.values()).filter(t=>t.status==="running");for(const t of e)try{const s=await this.currentProvider.getContainerStats(t.id);s&&(t.cpuUsage=s.cpuUsage,t.memoryUsage=s.memoryUsage,t.memoryLimit=s.memoryLimit,t.networkRx=s.networkRx,t.networkTx=s.networkTx,this.mode==="hybrid"&&this.simulationProvider&&this.simulationProvider.updateContainerStats(t.id,s))}catch(s){console.error(`Failed to get stats for container ${t.id}:`,s)}}simulateContainerOperations(e){if(this.containers.size===0)return;const t=Math.min(1,.1+this.containers.size/20);if(Math.random()<t/10){const s=Array.from(this.containers.values()),n=s[Math.floor(Math.random()*s.length)];let i;n.status==="running"?i=Math.random()<.1?"stop":Math.random()<.2?"pause":Math.random()<.3?"restart":"create":n.status==="exited"||n.status==="dead"?i=Math.random()<.5?"start":"create":n.status==="paused"?i=Math.random()<.5?"unpause":"stop":i="create",this.simulateContainerOperation(n.id,i,e)}}simulateContainerOperation(e,t,s){if(!this.containers.get(e))return;const i=`${t}-${e}-${s}-${Math.random()}`;let a=100;switch(t){case"create":a=500+Math.random()*1e3;break;case"start":a=200+Math.random()*500;break;case"stop":a=100+Math.random()*300;break;case"pause":a=50+Math.random()*100;break;case"unpause":a=50+Math.random()*100;break;case"restart":a=300+Math.random()*700;break;case"remove":a=200+Math.random()*400;break}const o=s+a,l={id:i,type:t,containerId:e,startTime:s,status:"running",completionTime:o};this.activeOperations.set(i,l)}simulateImageOperations(e,t){if(!this.config?.images||!Array.isArray(this.config.images)||this.config.images.length===0)return;const s=Math.min(.5,.05+this.config.images.length/50);if(t&&Math.random()<s/10){const n=this.config.images[Math.floor(Math.random()*this.config.images.length)],i=Math.random()<.7?"pull":Math.random()<.9?"build":"push";this.simulateImageOperation(n.id,i,e)}}simulateImageOperation(e,t,s){const n=`${t}-${e}-${s}-${Math.random()}`;let i=1e3;switch(t){case"pull":i=2e3+Math.random()*8e3;break;case"push":i=3e3+Math.random()*1e4;break;case"build":i=5e3+Math.random()*15e3;break}const a=s+i,o={id:n,type:t,imageId:e,startTime:s,status:"running",completionTime:a};this.activeOperations.set(n,o)}updateContainerResources(e){const t=Array.from(this.containers.values()).filter(l=>l.status==="running");let s=0,n=0,i=0,a=0,o=0;for(const l of t){const d=10+Math.random()*70,h=(Math.random()-.5)*10;l.cpuUsage=Math.max(0,Math.min(100,d+h));const p=l.memoryLimit||512*1024*1024;if(l.memoryLimit=p,!l.memoryUsage)l.memoryUsage=p*.3;else{const b=1+(Math.random()-.4)*.1;l.memoryUsage=Math.min(p*.95,l.memoryUsage*b)}const v=(1e3+Math.random()*9e3)*e/1e3;l.networkRx=(l.networkRx||0)+v,l.networkTx=(l.networkTx||0)+v*.8,s+=l.cpuUsage,n+=l.memoryUsage,i+=p,a+=l.networkRx||0,o+=l.networkTx||0}this.dockerMetrics.totalCpuUsage=t.length>0?s/t.length:0,this.dockerMetrics.totalMemoryUsage=n,this.dockerMetrics.totalMemoryLimit=i,this.dockerMetrics.totalNetworkRx=a,this.dockerMetrics.totalNetworkTx=o}updateActiveOperations(e){const t=[];for(const[n,i]of this.activeOperations.entries())i.completionTime&&e>=i.completionTime&&i.status==="running"&&t.push(i);for(const n of t)this.completeOperation(n,e);const s=e-6e4;for(const[n,i]of this.activeOperations.entries())i.startTime<s&&i.status==="completed"&&this.activeOperations.delete(n)}completeOperation(e,t){const s=e.completionTime?e.completionTime-e.startTime:0;switch(e.status="completed",e.duration=s,this.activeOperations.delete(e.id),this.addOperationToHistory(e),e.type){case"create":case"start":if(e.containerId){const n=this.containers.get(e.containerId);n&&(n.status="running",n.startedAt=t,n.restartCount=n.restartCount||0)}break;case"stop":if(e.containerId){const n=this.containers.get(e.containerId);n&&(n.status="exited",n.finishedAt=t,n.cpuUsage=0,n.memoryUsage=0)}break;case"pause":if(e.containerId){const n=this.containers.get(e.containerId);n&&(n.status="paused")}break;case"unpause":if(e.containerId){const n=this.containers.get(e.containerId);n&&(n.status="running")}break;case"restart":if(e.containerId){const n=this.containers.get(e.containerId);n&&(n.status="running",n.startedAt=t,n.restartCount=(n.restartCount||0)+1)}break;case"remove":e.containerId&&this.containers.delete(e.containerId);break}s>0&&(this.operationLatencyHistory.push(s),this.operationLatencyHistory.length>this.MAX_LATENCY_HISTORY&&this.operationLatencyHistory.shift())}addOperationToHistory(e){this.operationHistory.push(e),this.operationHistory.length>this.MAX_HISTORY_SIZE&&this.operationHistory.shift()}updateMetrics(e){const t=e-1e4,s=this.operationHistory.filter(n=>n.startTime>t);this.dockerMetrics.operationsPerSecond=s.length/10,this.dockerMetrics.buildOperationsPerSecond=s.filter(n=>n.type==="build").length/10,this.dockerMetrics.pullOperationsPerSecond=s.filter(n=>n.type==="pull").length/10,this.dockerMetrics.pushOperationsPerSecond=s.filter(n=>n.type==="push").length/10,this.operationLatencyHistory.length>0&&(this.dockerMetrics.averageOperationLatency=this.operationLatencyHistory.reduce((n,i)=>n+i,0)/this.operationLatencyHistory.length),this.updateMetricsFromConfig()}calculateLoad(){const e=this.dockerMetrics.operationsPerSecond,t=this.dockerMetrics.averageOperationLatency,s=this.operationHistory.filter(g=>g.status==="failed").length,n=Math.min(1,s/Math.max(1,this.operationHistory.length)),i=Math.min(.95,this.dockerMetrics.totalCpuUsage/100),a=this.dockerMetrics.totalMemoryLimit>0?Math.min(.95,this.dockerMetrics.totalMemoryUsage/this.dockerMetrics.totalMemoryLimit):.1,o=1e3*1024*1024,l=Math.min(.95,(this.dockerMetrics.totalNetworkRx+this.dockerMetrics.totalNetworkTx)/o*8),d=100*1024*1024*1024,h=this.dockerMetrics.imagesSize+this.dockerMetrics.volumesSize,p=Math.min(.95,h/d);return{throughput:e,averageLatency:t||0,errorRate:n,cpuUtilization:i,memoryUtilization:a,networkUtilization:l,diskUtilization:p}}getMetrics(){return{...this.dockerMetrics}}getConfig(){return this.config?{...this.config}:null}getContainers(){return Array.from(this.containers.values())}getContainer(e){return this.containers.get(e)}getImages(){return this.config?.images||[]}getNetworks(){return this.config?.networks||[]}getVolumes(){return this.config?.volumes||[]}getProvider(){return this.currentProvider}async testConnection(){return this.currentProvider?await this.currentProvider.testConnection():{success:!1,error:"No provider available"}}async connect(){if(!this.currentProvider)return!1;const e=await this.currentProvider.connect();return e&&this.config?.syncSettings?.enabled&&this.startSync(),e}async disconnect(){this.stopSync(),this.currentProvider&&await this.currentProvider.disconnect()}isConnected(){return this.currentProvider?.isConnected()||!1}async createContainerViaProvider(e){if(!this.currentProvider)throw new Error("No provider available");const t={name:e.name,image:e.image,command:e.command,env:e.env,ports:e.ports,volumes:e.volumes,networks:e.networks,memoryLimit:e.memoryLimit,cpuLimit:e.cpuLimit},s=await this.currentProvider.createContainer(t);return this.containers.set(s.id,s),this.config&&(this.config.containers=Array.from(this.containers.values())),s}async startContainerViaProvider(e){if(!this.currentProvider)throw new Error("No provider available");await this.currentProvider.startContainer(e);const t=this.containers.get(e);t&&(t.status="running",t.startedAt=Date.now())}async stopContainerViaProvider(e){if(!this.currentProvider)throw new Error("No provider available");await this.currentProvider.stopContainer(e);const t=this.containers.get(e);t&&(t.status="exited",t.finishedAt=Date.now())}async removeContainerViaProvider(e,t=!1){if(!this.currentProvider)throw new Error("No provider available");await this.currentProvider.removeContainer(e,t),this.containers.delete(e),this.config&&(this.config.containers=Array.from(this.containers.values()))}async pullImageViaProvider(e,t="latest"){if(!this.currentProvider)throw new Error("No provider available");const s=await this.currentProvider.pullImage(e,t);if(this.config){Array.isArray(this.config.images)||(this.config.images=[]);const n=this.config.images.findIndex(i=>i.id===s.id);n>=0?this.config.images[n]=s:this.config.images.push(s)}return s}async getSystemInfo(){return this.currentProvider?await this.currentProvider.getSystemInfo():null}}class Qk{config=null;pods=new Map;deployments=new Map;services=new Map;configMaps=new Map;secrets=new Map;namespaces=new Map;nodes=new Map;events=[];persistentVolumeClaims=new Map;kubernetesMetrics={podsTotal:0,podsRunning:0,podsPending:0,podsFailed:0,podsSucceeded:0,deploymentsTotal:0,deploymentsReady:0,deploymentsNotReady:0,servicesTotal:0,servicesClusterIP:0,servicesNodePort:0,servicesLoadBalancer:0,nodesTotal:0,nodesReady:0,nodesNotReady:0,totalCpuRequests:0,totalCpuLimits:0,totalMemoryRequests:0,totalMemoryLimits:0,totalCpuUsage:0,totalMemoryUsage:0,totalMemoryCapacity:0,namespacesTotal:0,configMapsTotal:0,secretsTotal:0};lastUpdateTime=Date.now();updateInterval=1e3;initializeConfig(e){const t=e.data.config||{};this.config=t,this.config.defaultNamespace||(this.config.defaultNamespace="default"),this.config.namespaces||(this.config.namespaces=[]),this.config.namespaces.some(n=>n.name===(this.config?.defaultNamespace||"default"))||this.config.namespaces.push({id:this.generateId(),name:this.config.defaultNamespace,phase:"Active",createdAt:Date.now()}),(!this.config.nodes||this.config.nodes.length===0)&&(this.config.nodes=[{id:this.generateId(),name:"node-1",roles:["worker"],conditions:[{type:"Ready",status:"True",lastTransitionTime:Date.now()}],allocatable:{cpu:"4",memory:"8Gi",pods:"110"},capacity:{cpu:"4",memory:"8Gi",pods:"110"},createdAt:Date.now(),unschedulable:!1,podCount:0}]),this.initializeResources(),this.updateMetricsFromResources()}initializeResources(){if(this.config){if(this.pods.clear(),this.config.pods)for(const e of this.config.pods)this.pods.set(e.id,{...e});if(this.deployments.clear(),this.config.deployments)for(const e of this.config.deployments)this.deployments.set(e.id,{...e});if(this.services.clear(),this.config.services)for(const e of this.config.services)this.services.set(e.id,{...e});if(this.configMaps.clear(),this.config.configMaps)for(const e of this.config.configMaps)this.configMaps.set(e.id,{...e});if(this.secrets.clear(),this.config.secrets)for(const e of this.config.secrets)this.secrets.set(e.id,{...e});if(this.namespaces.clear(),this.config.namespaces)for(const e of this.config.namespaces)this.namespaces.set(e.id,{...e});if(this.nodes.clear(),this.config.nodes)for(const e of this.config.nodes)this.nodes.set(e.id,{...e});if(this.persistentVolumeClaims.clear(),this.config.persistentVolumeClaims)for(const e of this.config.persistentVolumeClaims)this.persistentVolumeClaims.set(e.id,{...e});this.events=this.config.events||[]}}updateConfig(e){const t=e.data.config||{};this.config,this.config=t,this.syncResources(),this.updateMetricsFromResources()}syncResources(){if(this.config){if(this.config.pods){const e=new Set(this.config.pods.map(t=>t.id));for(const[t]of this.pods.entries())e.has(t)||this.pods.delete(t);for(const t of this.config.pods){const s=this.pods.get(t.id);s?this.pods.set(t.id,{...s,...t,totalCpuUsage:s.phase==="Running"?s.totalCpuUsage:t.totalCpuUsage,totalMemoryUsage:s.phase==="Running"?s.totalMemoryUsage:t.totalMemoryUsage,startedAt:t.startedAt||s.startedAt}):this.pods.set(t.id,{...t})}}this.initializeResources()}}updateMetricsFromResources(){this.kubernetesMetrics.podsTotal=this.pods.size,this.kubernetesMetrics.podsRunning=Array.from(this.pods.values()).filter(n=>n.phase==="Running").length,this.kubernetesMetrics.podsPending=Array.from(this.pods.values()).filter(n=>n.phase==="Pending").length,this.kubernetesMetrics.podsFailed=Array.from(this.pods.values()).filter(n=>n.phase==="Failed").length,this.kubernetesMetrics.podsSucceeded=Array.from(this.pods.values()).filter(n=>n.phase==="Succeeded").length,this.kubernetesMetrics.deploymentsTotal=this.deployments.size,this.kubernetesMetrics.deploymentsReady=Array.from(this.deployments.values()).filter(n=>n.readyReplicas===n.replicas&&n.replicas>0).length,this.kubernetesMetrics.deploymentsNotReady=Array.from(this.deployments.values()).filter(n=>n.readyReplicas!==n.replicas||n.replicas===0).length,this.kubernetesMetrics.servicesTotal=this.services.size,this.kubernetesMetrics.servicesClusterIP=Array.from(this.services.values()).filter(n=>n.type==="ClusterIP").length,this.kubernetesMetrics.servicesNodePort=Array.from(this.services.values()).filter(n=>n.type==="NodePort").length,this.kubernetesMetrics.servicesLoadBalancer=Array.from(this.services.values()).filter(n=>n.type==="LoadBalancer").length,this.kubernetesMetrics.nodesTotal=this.nodes.size,this.kubernetesMetrics.nodesReady=Array.from(this.nodes.values()).filter(n=>n.conditions?.some(i=>i.type==="Ready"&&i.status==="True")).length,this.kubernetesMetrics.nodesNotReady=this.kubernetesMetrics.nodesTotal-this.kubernetesMetrics.nodesReady;let e=0,t=0,s=0;for(const n of this.pods.values())n.totalCpuUsage&&(e+=n.totalCpuUsage),n.totalMemoryUsage&&(t+=n.totalMemoryUsage);for(const n of this.nodes.values())n.memoryCapacity&&(s+=n.memoryCapacity);this.kubernetesMetrics.totalCpuUsage=e,this.kubernetesMetrics.totalMemoryUsage=t,this.kubernetesMetrics.totalMemoryCapacity=s,this.kubernetesMetrics.namespacesTotal=this.namespaces.size,this.kubernetesMetrics.configMapsTotal=this.configMaps.size,this.kubernetesMetrics.secretsTotal=this.secrets.size}simulateStep(){const e=Date.now(),t=e-this.lastUpdateTime;this.lastUpdateTime=e,this.simulatePodLifecycle(t),this.simulateDeploymentReconciliation(t),this.simulateNodeMetrics(t),this.updateMetricsFromResources()}simulatePodLifecycle(e){for(const t of this.pods.values())t.phase==="Running"&&(t.totalCpuUsage?t.totalCpuUsage=Math.max(0,Math.min(100,t.totalCpuUsage+(Math.random()-.5)*5)):t.totalCpuUsage=20+Math.random()*60,t.totalMemoryUsage?t.totalMemoryUsage=Math.max(0,t.totalMemoryUsage+(Math.random()-.5)*100*1024*1024):t.totalMemoryUsage=512*1024*1024+Math.random()*(2*1024*1024*1024),t.totalMemoryLimit||(t.totalMemoryLimit=t.totalMemoryUsage*1.5))}simulateDeploymentReconciliation(e){for(const t of this.deployments.values()){const s=Array.from(this.pods.values()).filter(a=>a.namespace!==t.namespace?!1:t.selector?Object.entries(t.selector).every(([o,l])=>a.labels?.[o]===l):!1),n=s.filter(a=>a.phase==="Running"),i=n.filter(a=>a.conditions?.find(l=>l.type==="Ready")?.status==="True");t.readyReplicas=i.length,t.availableReplicas=n.length,t.updatedReplicas=n.length,t.unavailableReplicas=Math.max(0,t.replicas-t.availableReplicas),s.length<t.replicas&&!t.paused&&t.replicas-s.length>0&&Math.random()>.7&&this.createPodForDeployment(t)}}createPodForDeployment(e){const t=`${e.name}-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,s=this.generateId(),n={id:s,name:t,namespace:e.namespace||this.config?.defaultNamespace||"default",labels:e.template?.labels||e.selector,phase:"Pending",status:"Pending",createdAt:Date.now(),restartPolicy:"Always",restartCount:0};this.pods.set(s,n),this.config&&this.config.pods?this.config.pods.push(n):this.config&&(this.config.pods=[n]),setTimeout(()=>{const i=this.pods.get(s);i&&(i.phase="Running",i.status="Running",i.startedAt=Date.now(),i.podIP=`10.244.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`,i.conditions=[{type:"Ready",status:"True",lastTransitionTime:Date.now()},{type:"PodScheduled",status:"True",lastTransitionTime:Date.now()}])},1e3+Math.random()*2e3)}simulateNodeMetrics(e){for(const t of this.nodes.values()){const s=Array.from(this.pods.values()).filter(a=>a.nodeName===t.name);t.podCount=s.length;let n=0,i=0;for(const a of s)a.totalCpuUsage&&(n+=a.totalCpuUsage),a.totalMemoryUsage&&(i+=a.totalMemoryUsage);t.cpuUsage=Math.min(100,n),t.capacity?.memory&&!t.memoryCapacity&&(t.memoryCapacity=this.parseMemoryString(t.capacity.memory)),t.memoryCapacity&&(t.memoryUsage=Math.min(t.memoryCapacity,i))}}parseMemoryString(e){const t=e.match(/^(\d+)([KMGT]?i?)$/);if(!t)return 0;const s=parseInt(t[1],10),n=t[2].toLowerCase(),i={"":1,k:1024,ki:1024,m:1024*1024,mi:1024*1024,g:1024*1024*1024,gi:1024*1024*1024,t:1024*1024*1024*1024,ti:1024*1024*1024*1024};return s*(i[n]||1)}createEvent(e,t,s,n){const i={id:this.generateId(),name:`${n.name}.${Date.now()}`,namespace:n.namespace||this.config?.defaultNamespace||"default",type:e,reason:t,message:s,involvedObject:n,firstTimestamp:Date.now(),lastTimestamp:Date.now(),count:1};this.events.push(i),this.events.length>1e3&&(this.events=this.events.slice(-1e3)),this.config&&(this.config.events=[...this.events])}syncResourcesToConfig(){this.config&&(this.config.pods=Array.from(this.pods.values()),this.config.deployments=Array.from(this.deployments.values()),this.config.services=Array.from(this.services.values()),this.config.configMaps=Array.from(this.configMaps.values()),this.config.secrets=Array.from(this.secrets.values()),this.config.namespaces=Array.from(this.namespaces.values()),this.config.nodes=Array.from(this.nodes.values()),this.config.events=this.events,this.config.persistentVolumeClaims=Array.from(this.persistentVolumeClaims.values()))}createPod(e){if(!this.config)throw new Error("Engine not initialized");const t=this.namespaces.get(e.namespace);if(!t||t.phase!=="Active")throw new Error(`Namespace "${e.namespace}" does not exist or is not active`);const s={...e,id:this.generateId(),createdAt:Date.now(),phase:e.phase||"Pending",status:e.status||"Pending"};return this.pods.set(s.id,s),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Created",`Pod ${s.name} created`,{kind:"Pod",name:s.name,namespace:s.namespace,uid:s.id}),s}updatePod(e,t){const s=this.pods.get(e);if(!s)throw new Error(`Pod with id "${e}" not found`);const n={...s,...t,id:s.id};return this.pods.set(e,n),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Updated",`Pod ${s.name} updated`,{kind:"Pod",name:s.name,namespace:s.namespace,uid:s.id}),n}deletePod(e){const t=this.pods.get(e);if(!t)throw new Error(`Pod with id "${e}" not found`);this.pods.delete(e),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Deleted",`Pod ${t.name} deleted`,{kind:"Pod",name:t.name,namespace:t.namespace,uid:t.id})}createDeployment(e){if(!this.config)throw new Error("Engine not initialized");const t=this.namespaces.get(e.namespace);if(!t||t.phase!=="Active")throw new Error(`Namespace "${e.namespace}" does not exist or is not active`);const s={...e,id:this.generateId(),createdAt:Date.now(),readyReplicas:0,availableReplicas:0,updatedReplicas:0,unavailableReplicas:e.replicas,paused:!1};if(this.deployments.set(s.id,s),this.syncResourcesToConfig(),this.updateMetricsFromResources(),s.replicas>0)for(let n=0;n<s.replicas;n++)this.createPodForDeployment(s);return this.createEvent("Normal","Created",`Deployment ${s.name} created`,{kind:"Deployment",name:s.name,namespace:s.namespace,uid:s.id}),s}updateDeployment(e,t){const s=this.deployments.get(e);if(!s)throw new Error(`Deployment with id "${e}" not found`);const n=s.replicas,i={...s,...t,id:s.id};if(t.replicas!==void 0&&t.replicas!==n){const a=t.replicas-n;if(a>0)for(let o=0;o<a;o++)this.createPodForDeployment(i);else if(a<0){const l=Array.from(this.pods.values()).filter(d=>d.namespace!==s.namespace?!1:s.selector?Object.entries(s.selector).every(([h,p])=>d.labels?.[h]===p):!1).slice(0,Math.abs(a));for(const d of l)this.deletePod(d.id)}}return this.deployments.set(e,i),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Updated",`Deployment ${s.name} updated`,{kind:"Deployment",name:s.name,namespace:s.namespace,uid:s.id}),i}deleteDeployment(e){const t=this.deployments.get(e);if(!t)throw new Error(`Deployment with id "${e}" not found`);const s=Array.from(this.pods.values()).filter(n=>n.namespace!==t.namespace?!1:t.selector?Object.entries(t.selector).every(([i,a])=>n.labels?.[i]===a):!1);for(const n of s)this.deletePod(n.id);this.deployments.delete(e),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Deleted",`Deployment ${t.name} deleted`,{kind:"Deployment",name:t.name,namespace:t.namespace,uid:t.id})}createService(e){if(!this.config)throw new Error("Engine not initialized");const t=this.namespaces.get(e.namespace);if(!t||t.phase!=="Active")throw new Error(`Namespace "${e.namespace}" does not exist or is not active`);const s={...e,id:this.generateId(),createdAt:Date.now(),type:e.type||"ClusterIP",clusterIP:e.clusterIP||`10.96.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`};if(s.selector){const n=Array.from(this.pods.values()).filter(i=>i.namespace!==s.namespace?!1:Object.entries(s.selector).every(([a,o])=>i.labels?.[a]===o));s.endpoints=[{addresses:n.filter(i=>i.podIP).map(i=>i.podIP),ports:s.ports?.map(i=>({port:typeof i.targetPort=="number"?i.targetPort:parseInt(i.targetPort,10),protocol:i.protocol||"TCP"}))}]}return this.services.set(s.id,s),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Created",`Service ${s.name} created`,{kind:"Service",name:s.name,namespace:s.namespace,uid:s.id}),s}updateService(e,t){const s=this.services.get(e);if(!s)throw new Error(`Service with id "${e}" not found`);const n={...s,...t,id:s.id};if(t.selector&&n.selector){const i=Array.from(this.pods.values()).filter(a=>a.namespace!==s.namespace?!1:Object.entries(n.selector).every(([o,l])=>a.labels?.[o]===l));n.endpoints=[{addresses:i.filter(a=>a.podIP).map(a=>a.podIP),ports:n.ports?.map(a=>({port:typeof a.targetPort=="number"?a.targetPort:parseInt(a.targetPort,10),protocol:a.protocol||"TCP"}))}]}return this.services.set(e,n),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Updated",`Service ${s.name} updated`,{kind:"Service",name:s.name,namespace:s.namespace,uid:s.id}),n}deleteService(e){const t=this.services.get(e);if(!t)throw new Error(`Service with id "${e}" not found`);this.services.delete(e),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Deleted",`Service ${t.name} deleted`,{kind:"Service",name:t.name,namespace:t.namespace,uid:t.id})}createConfigMap(e){if(!this.config)throw new Error("Engine not initialized");const t=this.namespaces.get(e.namespace);if(!t||t.phase!=="Active")throw new Error(`Namespace "${e.namespace}" does not exist or is not active`);const s={...e,id:this.generateId(),createdAt:Date.now(),data:e.data||{}};return this.configMaps.set(s.id,s),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Created",`ConfigMap ${s.name} created`,{kind:"ConfigMap",name:s.name,namespace:s.namespace,uid:s.id}),s}updateConfigMap(e,t){const s=this.configMaps.get(e);if(!s)throw new Error(`ConfigMap with id "${e}" not found`);if(s.immutable)throw new Error(`ConfigMap "${s.name}" is immutable`);const n={...s,...t,id:s.id};return this.configMaps.set(e,n),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Updated",`ConfigMap ${s.name} updated`,{kind:"ConfigMap",name:s.name,namespace:s.namespace,uid:s.id}),n}deleteConfigMap(e){const t=this.configMaps.get(e);if(!t)throw new Error(`ConfigMap with id "${e}" not found`);this.configMaps.delete(e),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Deleted",`ConfigMap ${t.name} deleted`,{kind:"ConfigMap",name:t.name,namespace:t.namespace,uid:t.id})}createSecret(e){if(!this.config)throw new Error("Engine not initialized");const t=this.namespaces.get(e.namespace);if(!t||t.phase!=="Active")throw new Error(`Namespace "${e.namespace}" does not exist or is not active`);const s=e.data||{};if(e.stringData)for(const[i,a]of Object.entries(e.stringData))s[i]=btoa(a);const n={...e,id:this.generateId(),createdAt:Date.now(),type:e.type||"Opaque",data:s};return this.secrets.set(n.id,n),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Created",`Secret ${n.name} created`,{kind:"Secret",name:n.name,namespace:n.namespace,uid:n.id}),n}updateSecret(e,t){const s=this.secrets.get(e);if(!s)throw new Error(`Secret with id "${e}" not found`);if(s.immutable)throw new Error(`Secret "${s.name}" is immutable`);const n={...s,...t,id:s.id};if(t.stringData){n.data={...n.data};for(const[i,a]of Object.entries(t.stringData))n.data[i]=btoa(a)}return this.secrets.set(e,n),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Updated",`Secret ${s.name} updated`,{kind:"Secret",name:s.name,namespace:s.namespace,uid:s.id}),n}deleteSecret(e){const t=this.secrets.get(e);if(!t)throw new Error(`Secret with id "${e}" not found`);this.secrets.delete(e),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Deleted",`Secret ${t.name} deleted`,{kind:"Secret",name:t.name,namespace:t.namespace,uid:t.id})}createNamespace(e){if(!this.config)throw new Error("Engine not initialized");if(Array.from(this.namespaces.values()).find(n=>n.name===e.name))throw new Error(`Namespace "${e.name}" already exists`);const s={...e,id:this.generateId(),createdAt:Date.now(),phase:"Active"};return this.namespaces.set(s.id,s),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Created",`Namespace ${s.name} created`,{kind:"Namespace",name:s.name,uid:s.id}),s}deleteNamespace(e){const t=this.namespaces.get(e);if(!t)throw new Error(`Namespace with id "${e}" not found`);if(t.name==="default"||t.name===this.config?.defaultNamespace)throw new Error("Cannot delete default namespace");const s=Array.from(this.pods.values()).some(a=>a.namespace===t.name),n=Array.from(this.deployments.values()).some(a=>a.namespace===t.name),i=Array.from(this.services.values()).some(a=>a.namespace===t.name);if(s||n||i)throw new Error(`Namespace "${t.name}" contains resources and cannot be deleted`);this.namespaces.delete(e),this.syncResourcesToConfig(),this.updateMetricsFromResources(),this.createEvent("Normal","Deleted",`Namespace ${t.name} deleted`,{kind:"Namespace",name:t.name,uid:t.id})}getPods(){return Array.from(this.pods.values())}getPodsByNamespace(e){return Array.from(this.pods.values()).filter(t=>t.namespace===e)}getDeployments(){return Array.from(this.deployments.values())}getDeploymentsByNamespace(e){return Array.from(this.deployments.values()).filter(t=>t.namespace===e)}getServices(){return Array.from(this.services.values())}getServicesByNamespace(e){return Array.from(this.services.values()).filter(t=>t.namespace===e)}getConfigMaps(){return Array.from(this.configMaps.values())}getConfigMapsByNamespace(e){return Array.from(this.configMaps.values()).filter(t=>t.namespace===e)}getSecrets(){return Array.from(this.secrets.values())}getSecretsByNamespace(e){return Array.from(this.secrets.values()).filter(t=>t.namespace===e)}getNamespaces(){return Array.from(this.namespaces.values())}getNodes(){return Array.from(this.nodes.values())}getEvents(){return[...this.events]}getEventsByNamespace(e){return this.events.filter(t=>t.namespace===e)}getPersistentVolumeClaims(){return Array.from(this.persistentVolumeClaims.values())}getMetrics(){return{...this.kubernetesMetrics}}getLoad(){const e=Array.from(this.nodes.values()).reduce((l,d)=>{if(d.capacity?.cpu){const h=parseFloat(d.capacity.cpu);return l+h*1e3}return l},0),t=this.kubernetesMetrics.totalCpuUsage,s=e>0?t/e:0,n=this.kubernetesMetrics.totalMemoryCapacity>0?this.kubernetesMetrics.totalMemoryUsage/this.kubernetesMetrics.totalMemoryCapacity:0,i=Array.from(this.nodes.values()).reduce((l,d)=>d.capacity?.pods?l+parseInt(d.capacity.pods,10):l,0),a=i>0?this.kubernetesMetrics.podsTotal/i:0,o=this.kubernetesMetrics.podsTotal>0?this.kubernetesMetrics.podsFailed/this.kubernetesMetrics.podsTotal:0;return{throughput:this.kubernetesMetrics.podsRunning*10,averageLatency:100+Math.random()*200,errorRate:o,cpuUtilization:Math.min(1,s),memoryUtilization:Math.min(1,n),podUtilization:Math.min(1,a),networkUtilization:.1+Math.random()*.3,diskUtilization:.2+Math.random()*.2}}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getConfig(){return this.config?(this.syncResourcesToConfig(),{...this.config}):null}}class Vk{config=null;inventories=new Map;projects=new Map;credentials=new Map;jobTemplates=new Map;activeJobs=new Map;jobHistory=new Map;MAX_JOB_HISTORY=1e3;schedules=new Map;ansibleMetrics={inventoriesTotal:0,projectsTotal:0,credentialsTotal:0,jobTemplatesTotal:0,jobTemplatesEnabled:0,jobsTotal:0,jobsSuccess:0,jobsFailed:0,jobsRunning:0,jobsPending:0,jobsPerHour:0,averageJobDuration:0,hostsTotal:0,hostsOk:0,hostsChanged:0,hostsFailed:0,hostsUnreachable:0,schedulesTotal:0,schedulesEnabled:0,requestsTotal:0,requestsErrors:0};jobHistoryList=[];MAX_JOB_HISTORY_LIST=1e3;lastJobTime=new Map;scheduleNextRuns=new Map;processRequest(e=!0){this.ansibleMetrics.requestsTotal++,e||this.ansibleMetrics.requestsErrors++}initializeConfig(e){const t=e.data.config||{};this.config={towerUrl:t.towerUrl||"https://tower.example.com",organizationName:t.organizationName||"Default",defaultExecutionEnvironment:t.defaultExecutionEnvironment||"default",inventories:t.inventories||[],projects:t.projects||[],credentials:t.credentials||[],jobTemplates:t.jobTemplates||[],jobs:t.jobs||[],schedules:t.schedules||[],jobTriggerRate:t.jobTriggerRate||.5,averageJobDuration:t.averageJobDuration||12e4,failureRate:t.failureRate??.05,hostFailureRate:t.hostFailureRate??.02,playbookComplexity:t.playbookComplexity??.5,maxForks:t.maxForks||5,defaultTimeout:t.defaultTimeout||3600},this.initializeInventories(),this.initializeProjects(),this.initializeCredentials(),this.initializeJobTemplates(),this.initializeJobs(),this.initializeSchedules()}updateConfig(e){this.initializeConfig(e)}initializeInventories(){this.inventories.clear();const e=this.config?.inventories||[];if(e.length===0){const t={id:"default",name:"Default",description:"Default inventory",type:"static",organization:this.config?.organizationName||"Default",hosts:[],groups:[]};this.inventories.set("default",t);return}for(const t of e){const s={id:t.id,name:t.name,description:t.description,type:t.type||"static",organization:this.config?.organizationName||"Default",hosts:(t.hosts||[]).map((n,i)=>({id:n.id||`host-${t.id}-${i}`,name:n.name,enabled:!0,groups:n.groups||[],variables:n.variables||{}})),groups:(t.groups||[]).map((n,i)=>({id:n.id||`group-${t.id}-${i}`,name:n.name,hosts:n.hosts||[],variables:n.variables||{},children:n.children||[]}))};this.inventories.set(s.id,s)}}initializeProjects(){this.projects.clear();const e=this.config?.projects||[];if(e.length===0){const t={id:"default",name:"Default",description:"Default project",organization:this.config?.organizationName||"Default",scmType:"manual",playbooks:["playbook.yml"]};this.projects.set("default",t);return}for(const t of e){const s={id:t.id,name:t.name,description:t.description,organization:this.config?.organizationName||"Default",scmType:t.scmType||"manual",scmUrl:t.scmUrl,scmBranch:t.scmBranch||"main",playbooks:t.playbooks||["playbook.yml"],status:"successful",lastUpdateTime:Date.now()-Math.random()*864e5};this.projects.set(s.id,s)}}initializeCredentials(){this.credentials.clear();const e=this.config?.credentials||[];for(const t of e){const s={id:t.id,name:t.name,description:t.description,organization:this.config?.organizationName||"Default",credentialType:t.credentialType||"machine",username:t.username,password:t.password,sshKey:t.sshKey,becomeMethod:t.becomeMethod,becomeUsername:t.becomeUsername};this.credentials.set(s.id,s)}}initializeJobTemplates(){this.jobTemplates.clear();const e=this.config?.jobTemplates||[];for(const t of e){const s={id:t.id,name:t.name,description:t.description,organization:this.config?.organizationName||"Default",inventory:t.inventory,project:t.project,playbook:t.playbook,credential:t.credential,enabled:t.enabled!==!1,jobType:t.jobType||"run",becomeEnabled:t.becomeEnabled,becomeUser:t.becomeUser,forks:t.forks||this.config?.maxForks||5,timeout:t.timeout||this.config?.defaultTimeout||3600,verbosity:t.verbosity||0};this.jobTemplates.set(s.id,s)}}initializeJobs(){const e=new Set(Array.from(this.activeJobs.keys())),t=new Set((this.config?.jobs||[]).map(n=>n.id));for(const[n,i]of this.jobHistory.entries())!e.has(n)&&!t.has(n)&&this.jobHistory.delete(n);const s=this.config?.jobs||[];for(const n of s){const i={id:n.id,name:n.name||`Job ${n.id}`,type:n.type||"job",status:n.status||"successful",jobTemplate:n.jobTemplate,created:n.startedAt?new Date(n.startedAt).getTime():Date.now()-36e5,started:n.startedAt?new Date(n.startedAt).getTime():void 0,finished:n.finishedAt?new Date(n.finishedAt).getTime():void 0,elapsed:n.duration,hosts:n.hosts?.map((a,o)=>({id:`host-${n.id}-${o}`,name:a.name,status:a.status,failed:a.status==="failed"||a.status==="unreachable",changed:a.status==="changed",unreachable:a.status==="unreachable",skipped:a.status==="skipped"}))};["new","pending","waiting","running"].includes(i.status)?this.activeJobs.set(i.id,i):this.jobHistory.set(i.id,i)}}initializeSchedules(){this.schedules.clear();const e=this.config?.schedules||[];for(const t of e){const s={id:t.id,name:t.name,unifiedJobTemplate:t.unifiedJobTemplate,enabled:t.enabled!==!1,rrule:t.rrule||`DTSTART:20240101T000000Z
RRULE:FREQ=HOURLY;INTERVAL=1`,nextRun:Date.now()+36e5};this.schedules.set(s.id,s),this.scheduleNextRuns.set(s.id,s.nextRun||Date.now()+36e5)}}performUpdate(e){this.config&&(this.updateActiveJobs(e),this.triggerScheduledJobs(e),this.triggerAutomaticJobs(e),this.updateMetrics())}updateActiveJobs(e){const t=Array.from(this.activeJobs.entries());for(const[s,n]of t){if(!["new","pending","waiting","running"].includes(n.status)){if(this.jobHistory.set(s,n),this.jobHistory.size>this.MAX_JOB_HISTORY){const p=this.jobHistory.keys().next().value;p&&this.jobHistory.delete(p)}this.activeJobs.delete(s);continue}if(!n.started){n.started=e,n.status="running";continue}const i=(e-n.started)/1e3,a=this.config?.averageJobDuration||12e4,o=this.config?.playbookComplexity||.5,h=a*(1+o*.5)*(1+(Math.random()-.5)*.3)/1e3;if(i>=h){if(Math.random()<(this.config?.failureRate||.05)?n.status="failed":n.status="successful",n.finished=e,n.elapsed=i,n.hosts&&n.hosts.length>0){const g=this.config?.hostFailureRate||.02;for(const v of n.hosts)n.status==="failed"?Math.random()<g*2?(v.status=Math.random()<.5?"failed":"unreachable",v.failed=!0):Math.random()<.3?(v.status="changed",v.changed=!0):v.status="ok":Math.random()<g?(v.status="unreachable",v.unreachable=!0):Math.random()<.4?(v.status="changed",v.changed=!0):v.status="ok"}n.hosts&&(n.resultSummary={ok:n.hosts.filter(g=>g.status==="ok").length,changed:n.hosts.filter(g=>g.status==="changed").length,unreachable:n.hosts.filter(g=>g.status==="unreachable").length,failed:n.hosts.filter(g=>g.status==="failed").length,skipped:n.hosts.filter(g=>g.status==="skipped").length}),this.jobHistoryList.push({timestamp:e,duration:i,status:n.status}),this.jobHistoryList.length>this.MAX_JOB_HISTORY_LIST&&this.jobHistoryList.shift()}else if(n.elapsed=i,n.hosts){const p=i/h;for(let g=0;g<n.hosts.length;g++)p+(Math.random()-.5)*.2>=.9&&n.hosts[g].status==="ok"&&Math.random()<.3&&(n.hosts[g].status="changed",n.hosts[g].changed=!0)}}}triggerScheduledJobs(e){for(const[t,s]of this.schedules.entries()){if(!s.enabled)continue;const n=this.scheduleNextRuns.get(t);if(!n||e<n)continue;const i=this.jobTemplates.get(s.unifiedJobTemplate);if(!i||!i.enabled)continue;this.launchJobFromTemplate(i.id,s.extraData||{});const a=e+36e5;this.scheduleNextRuns.set(t,a),s.nextRun=a,s.lastRun=e}}triggerAutomaticJobs(e){if(!this.config)return;const s=36e5/(this.config.jobTriggerRate||.5);for(const[n,i]of this.jobTemplates.entries()){if(!i.enabled)continue;const a=this.lastJobTime.get(n)||0;e-a>=s&&Math.random()<.1&&(this.launchJobFromTemplate(n),this.lastJobTime.set(n,e))}}launchJobFromTemplate(e,t){const s=this.jobTemplates.get(e);if(!s||!s.enabled)return null;const n=this.inventories.get(s.inventory);if(!n)return null;const i=this.projects.get(s.project);if(!i)return null;const a=`job-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,o=n.hosts||[],l={id:a,name:`${s.name} - ${new Date().toISOString()}`,type:"job",status:"pending",jobTemplate:e,jobTemplateName:s.name,inventory:s.inventory,inventoryName:n.name,project:s.project,projectName:i.name,playbook:s.playbook,credential:s.credential,vaultCredential:s.vaultCredential,organization:s.organization,created:Date.now(),jobType:s.jobType,becomeEnabled:s.becomeEnabled,forks:s.forks||this.config?.maxForks||5,limit:s.limit||t?.limit,verbosity:s.verbosity||0,extraVars:s.extraVars||t?.extraVars,jobTags:s.jobTags||t?.jobTags,skipTags:s.skipTags||t?.skipTags,timeout:s.timeout||this.config?.defaultTimeout||3600,hosts:o.map((d,h)=>({id:d.id,name:d.name,status:"ok",failed:!1,changed:!1,unreachable:!1,skipped:!1}))};return this.activeJobs.set(a,l),s.lastJobRun=a,s.lastJobStatus="running",s.lastJobStarted=Date.now(),l}updateMetrics(){this.ansibleMetrics.inventoriesTotal=this.inventories.size,this.ansibleMetrics.projectsTotal=this.projects.size,this.ansibleMetrics.credentialsTotal=this.credentials.size,this.ansibleMetrics.jobTemplatesTotal=this.jobTemplates.size,this.ansibleMetrics.jobTemplatesEnabled=Array.from(this.jobTemplates.values()).filter(d=>d.enabled).length;const e=[...this.activeJobs.values(),...this.jobHistory.values()];this.ansibleMetrics.jobsTotal=e.length,this.ansibleMetrics.jobsSuccess=e.filter(d=>d.status==="successful").length,this.ansibleMetrics.jobsFailed=e.filter(d=>d.status==="failed"||d.status==="error").length,this.ansibleMetrics.jobsRunning=this.activeJobs.size,this.ansibleMetrics.jobsPending=Array.from(this.activeJobs.values()).filter(d=>d.status==="pending"||d.status==="waiting").length;const t=Date.now()-36e5,s=this.jobHistoryList.filter(d=>d.timestamp>=t);if(this.ansibleMetrics.jobsPerHour=s.length,this.jobHistoryList.length>0){const d=this.jobHistoryList.reduce((h,p)=>h+p.duration,0);this.ansibleMetrics.averageJobDuration=d/this.jobHistoryList.length}else this.ansibleMetrics.averageJobDuration=0;let n=0,i=0,a=0,o=0,l=0;for(const d of this.inventories.values())n+=d.hosts?.length||0;for(const d of this.activeJobs.values())if(d.hosts)for(const h of d.hosts)h.status==="ok"&&i++,h.status==="changed"&&a++,h.status==="failed"&&o++,h.status==="unreachable"&&l++;this.ansibleMetrics.hostsTotal=n,this.ansibleMetrics.hostsOk=i,this.ansibleMetrics.hostsChanged=a,this.ansibleMetrics.hostsFailed=o,this.ansibleMetrics.hostsUnreachable=l,this.ansibleMetrics.schedulesTotal=this.schedules.size,this.ansibleMetrics.schedulesEnabled=Array.from(this.schedules.values()).filter(d=>d.enabled).length}getMetrics(){return{...this.ansibleMetrics}}getInventories(){return Array.from(this.inventories.values())}getProjects(){return Array.from(this.projects.values())}getCredentials(){return Array.from(this.credentials.values())}getJobTemplates(){return Array.from(this.jobTemplates.values())}getActiveJobs(){return Array.from(this.activeJobs.values())}getAllJobs(){return[...Array.from(this.activeJobs.values()),...Array.from(this.jobHistory.values())]}getJob(e){return this.activeJobs.get(e)||this.jobHistory.get(e)}getSchedules(){return Array.from(this.schedules.values())}getJobLogs(e){const t=this.getJob(e);if(!t)return[];const s=[];if(s.push(`Starting job ${t.name} (ID: ${t.id})`),s.push(`Job Template: ${t.jobTemplateName||"N/A"}`),s.push(`Inventory: ${t.inventoryName||"N/A"}`),s.push(`Playbook: ${t.playbook||"N/A"}`),t.hosts){s.push(`
Running on ${t.hosts.length} host(s)...`);for(const n of t.hosts)s.push(`
${n.name}:`),n.status==="ok"?s.push("  OK - Task completed successfully"):n.status==="changed"?s.push("  CHANGED - Task made changes to the system"):n.status==="failed"?s.push("  FAILED - Task failed to execute"):n.status==="unreachable"?s.push("  UNREACHABLE - Host is unreachable"):n.status==="skipped"&&s.push("  SKIPPED - Task was skipped")}return t.resultSummary&&(s.push(`
PLAY RECAP`),s.push(`ok: ${t.resultSummary.ok}, changed: ${t.resultSummary.changed}, unreachable: ${t.resultSummary.unreachable}, failed: ${t.resultSummary.failed}, skipped: ${t.resultSummary.skipped}`)),t.status==="successful"?s.push(`
Job completed successfully in ${t.elapsed?.toFixed(2)}s`):t.status==="failed"&&s.push(`
Job failed after ${t.elapsed?.toFixed(2)}s`),s}cancelJob(e){const t=this.activeJobs.get(e);return!t||!["pending","waiting","running"].includes(t.status)?!1:(t.status="canceled",t.canceled=!0,t.canceledBy="user",t.finished=Date.now(),t.started&&(t.elapsed=(Date.now()-t.started)/1e3),this.jobHistory.set(e,t),this.activeJobs.delete(e),!0)}}class Gk{routers=new Map;services=new Map;middlewares=new Map;entryPoints=new Map;globalConfig={};roundRobinCounters=new Map;connectionCounts=new Map;serverHealthStatus=new Map;serverCheckFailures=new Map;serverCheckSuccesses=new Map;healthCheckTimers=new Map;rateLimitTracker=new Map;requestCount=0;responseCount=0;errorCount=0;totalBytesIn=0;totalBytesOut=0;activeConnections=0;totalLatency=0;latencyCount=0;initialize(e){this.routers.clear(),this.services.clear(),this.middlewares.clear(),this.entryPoints.clear(),this.roundRobinCounters.clear(),this.connectionCounts.clear(),this.serverHealthStatus.clear(),this.serverCheckFailures.clear(),this.serverCheckSuccesses.clear(),this.rateLimitTracker.clear(),this.globalConfig=e.globalConfig||{};for(const t of this.healthCheckTimers.values())clearInterval(t);if(this.healthCheckTimers.clear(),e.entryPoints)for(const t of e.entryPoints)this.entryPoints.set(t.name,t);else this.entryPoints.set("web",{name:"web",address:":80"}),this.entryPoints.set("websecure",{name:"websecure",address:":443"});if(e.routers)for(const t of e.routers)this.routers.set(t.name,{...t,priority:t.priority||0,requests:t.requests||0,responses:t.responses||0,errors:t.errors||0,bytesIn:t.bytesIn||0,bytesOut:t.bytesOut||0});if(e.services){for(const t of e.services)if(this.services.set(t.name,t),this.roundRobinCounters.set(t.name,0),t.loadBalancer?.healthCheck?.enabled&&t.loadBalancer.servers)for(const s of t.loadBalancer.servers)this.startHealthCheck(t.name,s.url,t.loadBalancer.healthCheck)}if(e.middlewares)for(const t of e.middlewares)this.middlewares.set(t.name,t);this.requestCount=0,this.responseCount=0,this.errorCount=0,this.totalBytesIn=0,this.totalBytesOut=0,this.activeConnections=0,this.totalLatency=0,this.latencyCount=0}routeRequest(e){const t=Date.now();this.requestCount++;const s=this.globalConfig.maxConnections||1e4;if(this.activeConnections>=s)return this.connectionRejects++,this.errorCount++,{router:null,service:null,response:{status:503,error:"Max connections exceeded",latency:Date.now()-t}};this.activeConnections++;const n=this.findMatchingRouter(e);if(!n)return this.activeConnections--,this.errorCount++,{router:null,service:null,response:{status:404,error:"No matching router found",latency:Date.now()-t}};n.requests=(n.requests||0)+1;let i={...e};const a=[];if(n.middlewares&&n.middlewares.length>0)for(const S of n.middlewares){const T=this.middlewares.get(S);if(T){const E=this.applyMiddleware(T,i);if(E.block)return this.activeConnections--,this.errorCount++,n.errors=(n.errors||0)+1,{router:n,service:null,response:{status:E.status||403,error:E.error||"Middleware blocked request",latency:Date.now()-t,routerMatched:n.name},middlewaresApplied:a};E.request&&(i=E.request),a.push(S)}}const o=this.services.get(n.service);if(!o)return this.activeConnections--,this.errorCount++,n.errors=(n.errors||0)+1,{router:n,service:null,response:{status:503,error:`Service ${n.service} not found`,latency:Date.now()-t,routerMatched:n.name},middlewaresApplied:a};const l=this.selectServer(o,i);if(!l)return this.activeConnections--,this.errorCount++,n.errors=(n.errors||0)+1,{router:n,service:o,response:{status:503,error:"No healthy server available",latency:Date.now()-t,routerMatched:n.name},middlewaresApplied:a};const d=5+Math.random()*95,h=n.tls?.enabled?5+Math.random()*15:0,p=this.globalConfig.responseTimeout||3e4,g=d+h;if(g>p)return this.activeConnections--,this.errorCount++,n.errors=(n.errors||0)+1,{router:n,service:o,response:{status:504,error:"Response timeout",latency:p,serviceTarget:o.name,serverTarget:l,routerMatched:n.name},middlewaresApplied:a};const v={status:200,body:{proxied:!0,service:o.name,server:l},latency:g,serviceTarget:o.name,serverTarget:l,routerMatched:n.name},b=1024,M=2048;n.bytesIn=(n.bytesIn||0)+b,n.bytesOut=(n.bytesOut||0)+M,n.responses=(n.responses||0)+1,n.averageLatency=((n.averageLatency||0)*(n.responses-1)+g)/n.responses,o.totalRequests=(o.totalRequests||0)+1,o.totalResponses=(o.totalResponses||0)+1,this.totalBytesIn+=b,this.totalBytesOut+=M,this.responseCount++,this.activeConnections--,this.totalLatency+=g,this.latencyCount++;const x=this.connectionCounts.get(l)||0;return this.connectionCounts.set(l,x+1),{router:n,service:o,response:v,middlewaresApplied:a}}findMatchingRouter(e){let t=[];for(const s of this.routers.values())e.entryPoint&&!s.entryPoints.includes(e.entryPoint)||this.evaluateRule(s.rule,e)&&t.push(s);return t.sort((s,n)=>(n.priority||0)-(s.priority||0)),t.length>0?t[0]:null}evaluateRule(e,t){try{const s=e.split("&&").map(n=>n.trim());for(const n of s){if(n.startsWith("Host(")){const i=n.match(/Host\(`([^`]+)`\)/);if(i){const a=i[1],o=t.host||t.headers?.Host||"";if(o!==a&&!o.endsWith(`.${a}`))return!1}}if(n.startsWith("PathPrefix(")){const i=n.match(/PathPrefix\(`([^`]+)`\)/);if(i){const a=i[1];if(!t.path.startsWith(a))return!1}}if(n.startsWith("Path(")&&!n.startsWith("PathPrefix(")){const i=n.match(/Path\(`([^`]+)`\)/);if(i){const a=i[1];if(t.path!==a)return!1}}if(n.startsWith("Method(")){const i=n.match(/Method\(`([^`]+)`\)/);if(i){const a=i[1];if(t.method.toUpperCase()!==a.toUpperCase())return!1}}}return!0}catch(s){return console.warn("Failed to parse Traefik rule:",e,s),!0}}applyMiddleware(e,t){switch(e.type){case"rateLimit":return this.applyRateLimit(e,t);case"ipAllowList":case"ipWhiteList":return this.applyIPAllowList(e,t);case"auth":case"basicAuth":case"digestAuth":return this.applyAuth(e,t);case"headers":return this.applyHeaders(e,t);case"redirect":return this.applyRedirect(e,t);case"stripPrefix":return this.applyStripPrefix(e,t);case"addPrefix":return this.applyAddPrefix(e,t);default:return{block:!1,request:t}}}applyRateLimit(e,t){if(!e.config)return{block:!1};const s=e.config.average||100,n=e.config.burst||50,i=this.parsePeriod(e.config.period||"1s"),a=t.clientIP||"0.0.0.0",o=`${e.name}:${a}`,l=Date.now();let d=this.rateLimitTracker.get(o);return(!d||d.resetAt<l)&&(d={count:0,resetAt:l+i,burst:n},this.rateLimitTracker.set(o,d)),d.count>=s+n?{block:!0,status:429,error:"Rate limit exceeded"}:(d.count++,{block:!1})}applyIPAllowList(e,t){if(!e.config?.sourceRange)return{block:!1};const s=t.clientIP||"0.0.0.0";return e.config.sourceRange.some(i=>i.includes("/")?s.startsWith(i.split("/")[0]):s===i)?{block:!1}:{block:!0,status:403,error:"IP not allowed"}}applyAuth(e,t){return e.config?.headerField&&!t.headers?.[e.config.headerField]?{block:!0,status:401,error:"Authentication required"}:{block:!1}}applyHeaders(e,t){const s={...t};return s.headers||(s.headers={}),e.config?.customRequestHeaders&&Object.assign(s.headers,e.config.customRequestHeaders),{block:!1,request:s}}applyRedirect(e,t){return{block:!1}}applyStripPrefix(e,t){if(!e.config?.prefix)return{block:!1,request:t};const s={...t};return s.path.startsWith(e.config.prefix)&&(s.path=s.path.substring(e.config.prefix.length)),{block:!1,request:s}}applyAddPrefix(e,t){if(!e.config?.prefix)return{block:!1,request:t};const s={...t};return s.path=e.config.prefix+s.path,{block:!1,request:s}}selectServer(e,t){const n=(e.loadBalancer?.servers||[]).filter(a=>{const o=this.serverHealthStatus.get(a.url);return o==="healthy"||o===void 0});if(n.length===0)return null;switch(e.loadBalancer?.strategy||"roundRobin"){case"roundRobin":return this.selectRoundRobin(e.name,n);case"wrr":return this.selectWeightedRoundRobin(e.name,n);case"drr":return this.selectDynamicRoundRobin(e.name,n);default:return n[0]?.url||null}}selectRoundRobin(e,t){const s=this.roundRobinCounters.get(e)||0,n=t[s%t.length];return this.roundRobinCounters.set(e,(s+1)%t.length),n.url}selectWeightedRoundRobin(e,t){const s=t.reduce((a,o)=>a+(o.weight||1),0);let n=this.roundRobinCounters.get(e)||0,i=0;for(const a of t)if(i+=a.weight||1,n<i)return this.roundRobinCounters.set(e,(n+1)%s),a.url;return this.roundRobinCounters.set(e,(n+1)%s),t[0]?.url||""}selectDynamicRoundRobin(e,t){let s=1/0,n=t[0];for(const i of t){const o=(this.connectionCounts.get(i.url)||0)/(i.weight||1);o<s&&(s=o,n=i)}return n.url}startHealthCheck(e,t,s){const n=(s.interval||10)*1e3,i=`${e}:${t}`;this.serverHealthStatus.set(t,"checking");const a=async()=>{try{if(Math.random()>.1){this.serverHealthStatus.set(t,"healthy");const h=this.serverCheckSuccesses.get(t)||0;this.serverCheckSuccesses.set(t,h+1),this.serverCheckFailures.set(t,0)}else{const h=(this.serverCheckFailures.get(t)||0)+1;this.serverCheckFailures.set(t,h),h>=3&&this.serverHealthStatus.set(t,"unhealthy")}}catch{const d=(this.serverCheckFailures.get(t)||0)+1;this.serverCheckFailures.set(t,d),d>=3&&this.serverHealthStatus.set(t,"unhealthy")}};a();const o=setInterval(a,n);this.healthCheckTimers.set(i,o)}parsePeriod(e){const t=e.match(/^(\d+)([smh])$/);if(!t)return 1e3;const s=parseInt(t[1],10);switch(t[2]){case"s":return s*1e3;case"m":return s*60*1e3;case"h":return s*60*60*1e3;default:return 1e3}}getStats(){let e=0,t=0;for(const a of this.services.values()){const o=a.loadBalancer?.servers||[];e+=o.length;for(const l of o){const d=this.serverHealthStatus.get(l.url);(d==="healthy"||d===void 0)&&t++}}const s=Array.from(this.routers.values()).filter(a=>(a.requests||0)>0).length,n=this.latencyCount>0?this.totalLatency/this.latencyCount:0,i=this.requestCount>0?this.errorCount/this.requestCount:0;return{routers:this.routers.size,activeRouters:s,services:this.services.size,middlewares:this.middlewares.size,entryPoints:this.entryPoints.size,totalServers:e,healthyServers:t,totalRequests:this.requestCount,totalResponses:this.responseCount,activeConnections:this.activeConnections,totalBytesIn:this.totalBytesIn,totalBytesOut:this.totalBytesOut,errorRate:i,averageLatency:n}}getRouter(e){return this.routers.get(e)}getService(e){return this.services.get(e)}getMiddleware(e){return this.middlewares.get(e)}resetStats(){this.requestCount=0,this.responseCount=0,this.errorCount=0,this.totalBytesIn=0,this.totalBytesOut=0,this.activeConnections=0,this.totalLatency=0,this.latencyCount=0;for(const e of this.routers.values())e.requests=0,e.responses=0,e.errors=0,e.bytesIn=0,e.bytesOut=0,e.averageLatency=0;for(const e of this.services.values())e.totalRequests=0,e.totalResponses=0,e.activeConnections=0}connectionRejects=0}class Wk{config=null;routingEngine;metrics={requestsTotal:0,responsesTotal:0,errorsTotal:0,activeRouters:0,totalRouters:0,totalServices:0,totalMiddlewares:0,totalServers:0,healthyServers:0,activeConnections:0,totalBytesIn:0,totalBytesOut:0,averageLatency:0,errorRate:0};firstRequestTime=null;lastRequestTime=null;latencyHistory=[];MAX_LATENCY_HISTORY=200;simulatedRequestRate=0;lastSimulationTime=Date.now();constructor(){this.routingEngine=new Gk}initializeConfig(e){const t=e.data.config||{},s=Array.isArray(t.routers)?t.routers.map(o=>({id:o.id||o.name,name:o.name,rule:o.rule||`Host(\`${o.name||"example.com"}\`)`,service:o.service,entryPoints:Array.isArray(o.entryPoints)?o.entryPoints:["web"],middlewares:Array.isArray(o.middlewares)?o.middlewares:[],tls:o.tls?{enabled:o.tls===!0||o.tls.enabled===!0}:void 0,priority:o.priority||0,requests:o.requests||0,responses:o.responses||0,errors:o.errors||0})):[],n=Array.isArray(t.services)?t.services.map(o=>({id:o.id||o.name,name:o.name,loadBalancer:{servers:Array.isArray(o.servers)?o.servers.map(l=>({url:l.url||l.address||"http://localhost:8080",weight:l.weight||1})):o.url?[{url:o.url,weight:1}]:[],strategy:o.loadBalancer||"roundRobin",healthCheck:o.healthCheck?.enabled?{enabled:!0,path:o.healthCheck.path||"/health",interval:o.healthCheck.interval||10,timeout:o.healthCheck.timeout||5}:void 0},totalRequests:o.totalRequests||0,totalResponses:o.totalResponses||0})):[],i=Array.isArray(t.middlewares)?t.middlewares.map(o=>({id:o.id||o.name,name:o.name,type:o.type||"headers",config:o.config||{}})):[],a=Array.isArray(t.entryPoints)?t.entryPoints.map(o=>typeof o=="string"?{name:o,address:o.includes(":")?o:`:${o==="web"?"80":o==="websecure"?"443":"80"}`}:o):[{name:"web",address:":80"},{name:"websecure",address:":443"}];this.config={routers:s,services:n,middlewares:i,entryPoints:a,enableDashboard:t.enableDashboard??!0,enableAPI:t.enableAPI??!0,autoDiscoverServices:t.autoDiscoverServices??!0,maxConnections:t.maxConnections||1e4,idleTimeout:t.idleTimeout||18e4,responseTimeout:t.responseTimeout||3e4},this.routingEngine.initialize({routers:s,services:n,middlewares:i,entryPoints:a,globalConfig:{maxConnections:this.config.maxConnections,idleTimeout:this.config.idleTimeout,responseTimeout:this.config.responseTimeout}}),this.updateMetricsFromStats()}processRequest(e){const t=performance.now(),s={path:e.path||"/",method:e.method||"GET",headers:e.headers,query:e.query,body:e.body,clientIP:e.clientIP||this.generateRandomIP(),protocol:e.protocol||"http",host:e.host||e.headers?.Host||"localhost",entryPoint:e.entryPoint||"web"},n=this.routingEngine.routeRequest(s),i=performance.now()-t+(n.response.latency||0);this.recordLatency(i);const a=Date.now();return this.firstRequestTime||(this.firstRequestTime=a),this.lastRequestTime=a,this.updateMetricsFromStats(),{success:n.response.status>=200&&n.response.status<400,latency:i,status:n.response.status,serviceTarget:n.response.serviceTarget,serverTarget:n.response.serverTarget,routerMatched:n.response.routerMatched,error:n.response.error}}updateMetricsFromStats(){const e=this.routingEngine.getStats();this.metrics.requestsTotal=e.totalRequests,this.metrics.responsesTotal=e.totalResponses,this.metrics.activeRouters=e.activeRouters,this.metrics.totalRouters=e.routers,this.metrics.totalServices=e.services,this.metrics.totalMiddlewares=e.middlewares,this.metrics.totalServers=e.totalServers,this.metrics.healthyServers=e.healthyServers,this.metrics.activeConnections=e.activeConnections,this.metrics.totalBytesIn=e.totalBytesIn,this.metrics.totalBytesOut=e.totalBytesOut,this.metrics.averageLatency=e.averageLatency,this.metrics.errorRate=e.errorRate,this.metrics.errorsTotal=Math.floor(e.totalRequests*e.errorRate)}getMetrics(){return{...this.metrics}}getStats(){return this.routingEngine.getStats()}getLoad(){const e=this.getStats(),t=this.config?.maxConnections||1e4;let s=this.simulatedRequestRate;if(this.firstRequestTime&&this.lastRequestTime){const i=(this.lastRequestTime-this.firstRequestTime)/1e3;i>0&&(s=e.totalRequests/i)}s===0&&this.simulatedRequestRate>0&&(s=this.simulatedRequestRate);const n=t>0?Math.min(1,e.activeConnections/t):0;return{requestsPerSecond:s,averageLatency:e.averageLatency||0,errorRate:e.errorRate||0,utilization:n}}simulateRequests(e){this.simulatedRequestRate=e;const t=Date.now(),s=(t-this.lastSimulationTime)/1e3;if(this.lastSimulationTime=t,e<=0||s<=0)return;const n=Math.floor(e*s);for(let i=0;i<n;i++){const a=this.generateRandomPath(),o=["GET","POST","PUT","DELETE"][Math.floor(Math.random()*4)];this.processRequest({path:a,method:o,headers:{Host:"example.com","User-Agent":"Mozilla/5.0"},clientIP:this.generateRandomIP(),protocol:Math.random()>.5?"https":"http",host:"example.com",entryPoint:Math.random()>.5?"websecure":"web"})}}recordLatency(e){this.latencyHistory.push(e),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift()}generateRandomIP(){return`${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`}generateRandomPath(){const e=["/","/api","/api/users","/api/products","/health","/status","/docs"];return e[Math.floor(Math.random()*e.length)]}updateConfig(e){this.initializeConfig(e)}resetStats(){this.routingEngine.resetStats(),this.firstRequestTime=null,this.lastRequestTime=null,this.latencyHistory=[],this.updateMetricsFromStats()}}class Kk{config=null;jobs=new Map;activeJobs=new Map;MAX_JOB_HISTORY=1e3;stages=new Map;activeStages=new Map;MAX_STAGE_HISTORY=5e3;executors=new Map;sqlQueries=new Map;activeSqlQueries=new Map;MAX_SQL_QUERY_HISTORY=1e3;streamingJobs=new Map;activeStreamingJobs=new Map;MAX_STREAMING_JOB_HISTORY=100;lastStreamingCheckpoint=0;CHECKPOINT_INTERVAL=6e4;sparkMetrics={totalJobs:0,activeJobs:0,succeededJobs:0,failedJobs:0,totalStages:0,activeStages:0,totalExecutors:0,aliveExecutors:0,totalCores:0,totalMemory:0,totalMemoryUsed:0,totalInputBytes:0,totalOutputBytes:0,totalShuffleRead:0,totalShuffleWrite:0,totalShuffleNetworkRead:0,totalShuffleNetworkWrite:0,totalShuffleSpillMemory:0,totalShuffleSpillDisk:0,jobsPerHour:0,averageJobDuration:0,throughput:0,requestsTotal:0,requestsErrors:0,gcPauseTime:0,gcFrequency:0,memoryBeforeGC:0,memoryAfterGC:0,totalNetworkIO:0,networkUtilization:0,networkErrors:0,diskIORate:0,diskUtilization:0,diskErrors:0,heapUsage:0,nonHeapUsage:0,threadCount:0};gcHistory=[];MAX_GC_HISTORY=100;lastNetworkUpdate=Date.now();lastDiskUpdate=Date.now();jobHistoryList=[];MAX_JOB_HISTORY_LIST=1e3;lastJobCreation=0;executorHeartbeatInterval=new Map;processRequest(e=!0){this.sparkMetrics.requestsTotal++,e||this.sparkMetrics.requestsErrors++}initializeConfig(e){const t=e.data.config||{};this.config={master:t.master||t.sparkMaster||"local[*]",appName:t.appName||t.sparkAppName||"archiphoenix-spark",driverMemory:t.driverMemory||"2g",executorMemory:t.executorMemory||"4g",executorCores:t.executorCores||2,enableDynamicAllocation:t.enableDynamicAllocation??!0,minExecutors:t.minExecutors||1,maxExecutors:t.maxExecutors||10,enableCheckpointing:t.enableCheckpointing??!0,checkpointDirectory:t.checkpointDirectory||"/checkpoint",enableStreaming:t.enableStreaming??!1,streamingBatchInterval:t.streamingBatchInterval||1e3,jobs:t.jobs||[],stages:t.stages||[],executors:t.executors||[],jobCreationRate:t.jobCreationRate||2,averageJobDuration:t.averageJobDuration||3e5,failureRate:t.failureRate??.05,dataProcessingRate:t.dataProcessingRate||104857600,shuffleIntensity:t.shuffleIntensity??.3,executorFailureRate:t.executorFailureRate??.01,durationVariation:t.durationVariation??.3},this.initializeExecutors(),this.initializeJobs(),this.initializeStages(),this.config.enableStreaming&&this.initializeStreamingJob(Date.now())}updateConfig(e){this.initializeConfig(e)}initializeExecutors(){const e=this.config?.executors||[],t=this.config?.minExecutors||1,s=this.config?.maxExecutors||10,n=this.parseMemory(this.config?.executorMemory||"4g"),i=this.config?.executorCores||2,a=new Set(e.map(o=>o.id));for(const[o,l]of this.executors.entries())!a.has(o)&&l.status==="DEAD"&&this.executors.delete(o);if(e.length===0){const o=Math.max(t,Math.min(3,s));for(let l=0;l<o;l++){const d={id:`executor-${l}`,host:`host-${l}.example.com`,status:"ALIVE",cores:i,memoryUsed:n*.3,memoryMax:n,diskUsed:n*.2,diskMax:n*2,activeTasks:0,totalTasks:0,totalInputBytes:0,totalShuffleRead:0,totalShuffleWrite:0,startTime:Date.now()-Math.random()*36e5,lastHeartbeat:Date.now()};this.executors.set(d.id,d),this.executorHeartbeatInterval.set(d.id,3e3+Math.random()*2e3)}return}for(const o of e){const l=this.executors.get(o.id),d=this.parseMemory(this.config?.executorMemory||"4g"),h={id:o.id,host:o.host||`host-${o.id}.example.com`,status:o.status||l?.status||"ALIVE",cores:o.cores||i,memoryUsed:l?.memoryUsed||d*.3,memoryMax:o.memoryMax||d,diskUsed:l?.diskUsed||d*.2,diskMax:o.diskMax||d*2,activeTasks:l?.activeTasks||0,totalTasks:l?.totalTasks||0,totalInputBytes:l?.totalInputBytes||0,totalShuffleRead:l?.totalShuffleRead||0,totalShuffleWrite:l?.totalShuffleWrite||0,startTime:l?.startTime||Date.now()-Math.random()*36e5,lastHeartbeat:Date.now()};this.executors.set(h.id,h),this.executorHeartbeatInterval.has(h.id)||this.executorHeartbeatInterval.set(h.id,3e3+Math.random()*2e3)}}initializeJobs(){const e=new Set(Array.from(this.activeJobs.keys())),t=new Set((this.config?.jobs||[]).map(n=>n.id));for(const[n,i]of this.jobs.entries())!e.has(n)&&!t.has(n)&&this.jobs.delete(n);const s=this.config?.jobs||[];for(const n of s){const i=this.jobs.get(n.id),a={id:n.id,name:n.name,status:n.status||i?.status||"SUCCEEDED",startTime:n.startTime?new Date(n.startTime).getTime():i?.startTime||Date.now()-36e5,stages:n.stages||i?.stages||3,tasks:n.tasks||i?.tasks||100,executors:i?.executors||this.executors.size,inputBytes:i?.inputBytes||0,outputBytes:i?.outputBytes||0,shuffleRead:i?.shuffleRead||0,shuffleWrite:i?.shuffleWrite||0};a.status==="RUNNING"&&this.activeJobs.set(a.id,a),this.jobs.set(a.id,a)}}initializeStages(){const e=new Set(Array.from(this.activeStages.keys())),t=new Set((this.config?.stages||[]).map(n=>n.id));for(const[n,i]of this.stages.entries())!e.has(n)&&!t.has(n)&&this.stages.delete(n);const s=this.config?.stages||[];for(const n of s){const i=this.stages.get(n.id);if(!this.jobs.get(n.jobId))continue;const o={id:n.id,jobId:n.jobId,name:n.name,status:n.status||i?.status||"COMPLETE",numTasks:n.numTasks||i?.numTasks||10,numActiveTasks:i?.numActiveTasks||0,numCompleteTasks:i?.numCompleteTasks||(n.status==="COMPLETE"?n.numTasks||10:0),numFailedTasks:i?.numFailedTasks||0,inputBytes:i?.inputBytes||0,outputBytes:i?.outputBytes||0,shuffleRead:i?.shuffleRead||0,shuffleWrite:i?.shuffleWrite||0,duration:i?.duration||0};o.status==="ACTIVE"&&this.activeStages.set(o.id,o),this.stages.set(o.id,o)}}performUpdate(e){if(this.config){this.updateActiveJobs(e),this.updateActiveStages(e),this.updateExecutors(e);for(const[t,s]of this.activeSqlQueries.entries())this.updateSQLQuery(t,e);this.config.enableStreaming&&this.updateStreamingJobs(e),this.triggerNewJobs(e),this.updateMetrics()}}updateActiveJobs(e){const t=Array.from(this.activeJobs.entries());for(const[s,n]of t){if(n.status!=="RUNNING"){if(this.jobs.size>this.MAX_JOB_HISTORY){const v=this.jobs.keys().next().value;v&&!this.activeJobs.has(v)&&this.jobs.delete(v)}this.activeJobs.delete(s);continue}if(!n.submissionTime){n.submissionTime=n.startTime;continue}const i=e-n.startTime,a=this.config?.averageJobDuration||3e5,o=this.config?.durationVariation||.3,l=a*o*(Math.random()*2-1),d=a+l,h=this.config?.dataProcessingRate||104857600,p=this.config?.shuffleIntensity||.3;if(n.inputBytes===0){const v=h*(d/1e3)*.5;n.inputBytes=v,n.outputBytes=v*.8,n.shuffleRead=v*p,n.shuffleWrite=v*p}else{const v=Math.min(1,i/d);n.inputBytes=n.inputBytes*(.5+v*.5),n.outputBytes=n.inputBytes*.8*v,n.shuffleRead=n.inputBytes*p*v,n.shuffleWrite=n.inputBytes*p*v}const g=Array.from(this.stages.values()).filter(v=>v.jobId===s);if(n.stages=g.length,n.tasks=g.reduce((v,b)=>v+b.numTasks,0),n.executors=this.executors.size,i>=d){const v=this.config?.failureRate??.05;if(Math.random()<v)n.status="FAILED",n.endTime=e,n.completionTime=e,n.duration=i;else{n.status="SUCCEEDED",n.endTime=e,n.completionTime=e,n.duration=i;const M=h*(d/1e3);n.inputBytes=M,n.outputBytes=M*.8,n.shuffleRead=M*p,n.shuffleWrite=M*p}this.jobHistoryList.push({timestamp:e,duration:i,status:n.status}),this.jobHistoryList.length>this.MAX_JOB_HISTORY_LIST&&this.jobHistoryList.shift()}}}updateActiveStages(e){const t=Array.from(this.activeStages.entries()),s=[];for(const[i,a]of t){if(a.status!=="ACTIVE"){this.activeStages.delete(i);continue}if(!a.submissionTime){a.submissionTime=e;continue}const o=this.jobs.get(a.jobId);if(!o||o.status!=="RUNNING"){a.status="COMPLETE",a.completionTime=e,a.duration=e-(a.submissionTime||e),a.numActiveTasks=0,a.numCompleteTasks=a.numTasks,s.push(i);continue}const l=e-(a.submissionTime||e),d=(this.config?.averageJobDuration||3e5)/(o.stages||3),h=this.config?.durationVariation||.3,p=d*h*(Math.random()*2-1),g=d+p,v=Math.min(1,l/g);a.numCompleteTasks=Math.floor(a.numTasks*v),a.numActiveTasks=Math.max(0,a.numTasks-a.numCompleteTasks-a.numFailedTasks);const b=Math.min(1,l/g);if(this.config?.shuffleIntensity,a.inputBytes=o.inputBytes/(o.stages||3)*b,a.outputBytes=o.outputBytes/(o.stages||3)*b,a.shuffleRead=o.shuffleRead/(o.stages||3)*b,a.shuffleWrite=o.shuffleWrite/(o.stages||3)*b,a.stageType==="shuffle"||a.parentStageIds&&a.parentStageIds.length>0){const M=this.executors.size,x=100*1024*1024;a.shuffleNetworkRead=a.shuffleRead*.7*b,a.shuffleNetworkWrite=a.shuffleWrite*.7*b;const S=Math.min(1,this.sparkMetrics.totalMemoryUsed/this.sparkMetrics.totalMemory||.5),T=.8;if(S>T){const k=(S-T)/(1-T);a.shuffleSpillMemory=a.shuffleWrite*.3*k*b,a.shuffleSpillDisk=a.shuffleRead*.2*k*b}else a.shuffleSpillMemory=0,a.shuffleSpillDisk=0;const E=10,A=Math.min(1,(a.shuffleNetworkRead||0)/(x*M));a.shuffleFetchWaitTime=E+A*50}else a.shuffleNetworkRead=0,a.shuffleNetworkWrite=0,a.shuffleSpillMemory=0,a.shuffleSpillDisk=0,a.shuffleFetchWaitTime=0;if(l>=g||a.numCompleteTasks>=a.numTasks){if(a.status="COMPLETE",a.completionTime=e,a.duration=l,a.numActiveTasks=0,a.numCompleteTasks=a.numTasks,a.inputBytes=o.inputBytes/(o.stages||3),a.outputBytes=o.outputBytes/(o.stages||3),a.shuffleRead=o.shuffleRead/(o.stages||3),a.shuffleWrite=o.shuffleWrite/(o.stages||3),a.stageType==="shuffle"||a.parentStageIds&&a.parentStageIds.length>0){this.executors.size;const M=Math.min(1,this.sparkMetrics.totalMemoryUsed/this.sparkMetrics.totalMemory||.5),x=.8;if(a.shuffleNetworkRead=a.shuffleRead*.7,a.shuffleNetworkWrite=a.shuffleWrite*.7,M>x){const S=(M-x)/(1-x);a.shuffleSpillMemory=a.shuffleWrite*.3*S,a.shuffleSpillDisk=a.shuffleRead*.2*S}else a.shuffleSpillMemory=0,a.shuffleSpillDisk=0}s.push(i)}}for(const i of s){const a=this.stages.get(i);if(!(!a||!a.childStageIds))for(const o of a.childStageIds){const l=this.stages.get(o);if(!l||l.status!=="SKIPPED")continue;(l.parentStageIds||[]).every(p=>{const g=this.stages.get(p);return g&&g.status==="COMPLETE"})&&(l.status="ACTIVE",l.submissionTime=e,l.numActiveTasks=l.numTasks,this.activeStages.set(o,l))}}const n=this.jobs.values().next().value;if(n&&n.rootStageIds)for(const i of n.rootStageIds){const a=this.stages.get(i);a&&a.status==="SKIPPED"&&(a.status="ACTIVE",a.submissionTime=e,a.numActiveTasks=a.numTasks,this.activeStages.set(i,a))}}updateExecutors(e){const t=this.config?.executorFailureRate??.01;for(const[s,n]of this.executors.entries()){if(n.status==="DEAD")continue;const i=this.executorHeartbeatInterval.get(s)||5e3;if(e-n.lastHeartbeat>i*3){n.status="DEAD",n.activeTasks=0;continue}if(Math.random()<t/3600){n.status="DEAD",n.activeTasks=0;continue}e-n.lastHeartbeat>=i&&(n.lastHeartbeat=e);const a=this.activeJobs.size,o=this.executors.size,l=a>0?Math.ceil(100/o):0;n.activeTasks=Math.min(l,n.cores*2),n.totalTasks+=n.activeTasks;const d=.3+n.activeTasks/(n.cores*2)*.5;n.memoryUsed=n.memoryMax*d;const p=.2+(this.config?.shuffleIntensity||.3)*.4;n.diskUsed=n.diskMax*p;const g=Array.from(this.activeJobs.values())[0];g&&(n.totalShuffleRead=g.shuffleRead/o||0,n.totalShuffleWrite=g.shuffleWrite/o||0,n.totalInputBytes=g.inputBytes/o||0)}if(this.config?.enableDynamicAllocation){const s=this.config.minExecutors||1,n=this.config.maxExecutors||10,i=this.activeJobs.size,a=Array.from(this.executors.values()).filter(o=>o.status==="ALIVE").length;if(i>0&&a<n){const o=`executor-${Date.now()}`,l=this.parseMemory(this.config.executorMemory||"4g"),d=this.config.executorCores||2,h={id:o,host:`host-${o}.example.com`,status:"ALIVE",cores:d,memoryUsed:l*.3,memoryMax:l,diskUsed:l*.2,diskMax:l*2,activeTasks:0,totalTasks:0,totalInputBytes:0,totalShuffleRead:0,totalShuffleWrite:0,startTime:e,lastHeartbeat:e};this.executors.set(o,h),this.executorHeartbeatInterval.set(o,3e3+Math.random()*2e3)}else if(i===0&&a>s){const o=Array.from(this.executors.entries()).filter(([l,d])=>d.status==="ALIVE");if(o.length>s){const[l,d]=o[o.length-1];d.status="DEAD"}}}}triggerNewJobs(e){if(!this.config)return;const t=this.config.jobCreationRate||2,s=e-this.lastJobCreation,n=36e5/t;s>=n&&this.activeJobs.size<5&&(this.createNewJob(e),this.lastJobCreation=e)}createNewJob(e){if(!this.config)return;const t=`job-${Date.now()}`,s=`Spark Job ${this.jobs.size+1}`,n=3+Math.floor(Math.random()*5),i=10+Math.floor(Math.random()*90),a=new Map,o=[],l=[];for(let h=0;h<n;h++)l.push(`stage-${t}-${h}`);for(let h=0;h<n;h++){const p=l[h],g=[];if(h===0)o.push(p);else if(h===1)g.push(l[0]);else if(h===2&&n>3)g.push(l[0]);else{const v=Math.max(0,h-1);g.push(l[v])}a.set(p,g)}const d={id:t,name:s,status:"RUNNING",startTime:e,stages:n,tasks:n*i,executors:this.executors.size,inputBytes:0,outputBytes:0,shuffleRead:0,shuffleWrite:0,submissionTime:e,stageDependencies:a,rootStageIds:o};this.jobs.set(t,d),this.activeJobs.set(t,d);for(let h=0;h<n;h++){const p=l[h],g=a.get(p)||[],v=o.includes(p);let b="map";h===0?b="map":h===n-1?b="action":g.length>0?b="shuffle":b="reduce";const M={id:p,jobId:t,name:`Stage ${h+1}`,status:v?"ACTIVE":"SKIPPED",numTasks:i,numActiveTasks:v?i:0,numCompleteTasks:0,numFailedTasks:0,inputBytes:0,outputBytes:0,shuffleRead:0,shuffleWrite:0,duration:0,submissionTime:v?e:void 0,parentStageIds:g,childStageIds:[],stageType:b,shuffleNetworkRead:0,shuffleNetworkWrite:0,shuffleSpillMemory:0,shuffleSpillDisk:0,shuffleFetchWaitTime:0};for(const x of g){const S=this.stages.get(x);S&&(S.childStageIds||(S.childStageIds=[]),S.childStageIds.push(p))}this.stages.set(p,M),M.status==="ACTIVE"&&this.activeStages.set(p,M)}for(let h=0;h<n;h++){const p=l[h],g=this.stages.get(p);if(!(!g||!g.parentStageIds))for(const v of g.parentStageIds){const b=this.stages.get(v);b&&(b.childStageIds||(b.childStageIds=[]),b.childStageIds.push(p))}}}updateMetrics(){const e=Array.from(this.jobs.values()),t=Array.from(this.activeJobs.values()),s=Array.from(this.stages.values()),n=Array.from(this.activeStages.values()),i=Array.from(this.executors.values()),a=i.filter(h=>h.status==="ALIVE");this.sparkMetrics.totalJobs=e.length,this.sparkMetrics.activeJobs=t.length,this.sparkMetrics.succeededJobs=e.filter(h=>h.status==="SUCCEEDED").length,this.sparkMetrics.failedJobs=e.filter(h=>h.status==="FAILED").length,this.sparkMetrics.totalStages=s.length,this.sparkMetrics.activeStages=n.length,this.sparkMetrics.totalExecutors=i.length,this.sparkMetrics.aliveExecutors=a.length,this.sparkMetrics.totalCores=a.reduce((h,p)=>h+p.cores,0),this.sparkMetrics.totalMemory=a.reduce((h,p)=>h+p.memoryMax,0)/1024,this.sparkMetrics.totalMemoryUsed=a.reduce((h,p)=>h+p.memoryUsed,0)/1024,this.sparkMetrics.totalInputBytes=e.reduce((h,p)=>h+p.inputBytes,0),this.sparkMetrics.totalOutputBytes=e.reduce((h,p)=>h+p.outputBytes,0),this.sparkMetrics.totalShuffleRead=e.reduce((h,p)=>h+p.shuffleRead,0),this.sparkMetrics.totalShuffleWrite=e.reduce((h,p)=>h+p.shuffleWrite,0),this.sparkMetrics.totalShuffleNetworkRead=s.reduce((h,p)=>h+(p.shuffleNetworkRead||0),0),this.sparkMetrics.totalShuffleNetworkWrite=s.reduce((h,p)=>h+(p.shuffleNetworkWrite||0),0),this.sparkMetrics.totalShuffleSpillMemory=s.reduce((h,p)=>h+(p.shuffleSpillMemory||0),0),this.sparkMetrics.totalShuffleSpillDisk=s.reduce((h,p)=>h+(p.shuffleSpillDisk||0),0);const o=this.sparkMetrics.totalInputBytes+this.sparkMetrics.totalOutputBytes;this.sparkMetrics.throughput=o/3600;const l=Date.now()-36e5,d=this.jobHistoryList.filter(h=>h.timestamp>=l);if(this.sparkMetrics.jobsPerHour=d.length,this.jobHistoryList.length>0){const h=this.jobHistoryList.reduce((p,g)=>p+g.duration,0);this.sparkMetrics.averageJobDuration=h/this.jobHistoryList.length}else this.sparkMetrics.averageJobDuration=this.config?.averageJobDuration||3e5;this.updateGCMetrics(),this.updateNetworkMetrics(),this.updateDiskMetrics(),this.updateJVMMetrics()}updateGCMetrics(){const e=Date.now(),t=this.sparkMetrics.totalMemoryUsed,s=t/this.sparkMetrics.totalMemory,n=Math.max(0,(s-.7)*.1);if(Math.random()<n&&this.sparkMetrics.totalMemory>0){const o=50+Math.random()*150,l=t,d=t*(.85+Math.random()*.1);this.gcHistory.push({timestamp:e,pauseTime:o,memoryBefore:l,memoryAfter:d}),this.gcHistory.length>this.MAX_GC_HISTORY&&this.gcHistory.shift()}const i=e-36e5,a=this.gcHistory.filter(o=>o.timestamp>=i);if(this.sparkMetrics.gcFrequency=a.length,this.sparkMetrics.gcPauseTime=a.reduce((o,l)=>o+l.pauseTime,0),a.length>0){const o=a[a.length-1];this.sparkMetrics.memoryBeforeGC=o.memoryBefore,this.sparkMetrics.memoryAfterGC=o.memoryAfter}else this.sparkMetrics.memoryBeforeGC=t,this.sparkMetrics.memoryAfterGC=t}updateNetworkMetrics(){const e=Date.now(),t=(e-this.lastNetworkUpdate)/1e3;this.lastNetworkUpdate=e,this.sparkMetrics.totalNetworkIO=this.sparkMetrics.totalShuffleNetworkRead+this.sparkMetrics.totalShuffleNetworkWrite;const s=this.sparkMetrics.aliveExecutors||1,i=100*1024*1024*s,a=this.sparkMetrics.totalNetworkIO/(t||1);this.sparkMetrics.networkUtilization=Math.min(100,a/i*100),this.sparkMetrics.networkUtilization>90&&Math.random()<.01&&(this.sparkMetrics.networkErrors+=1)}updateDiskMetrics(){const e=Date.now(),t=(e-this.lastDiskUpdate)/1e3;this.lastDiskUpdate=e;const s=this.sparkMetrics.totalShuffleSpillMemory+this.sparkMetrics.totalShuffleSpillDisk;this.sparkMetrics.diskIORate=s/(t||1);const n=Array.from(this.executors.values()),i=n.reduce((o,l)=>o+l.diskMax,0),a=n.reduce((o,l)=>o+l.diskUsed,0);i>0?this.sparkMetrics.diskUtilization=a/i*100:this.sparkMetrics.diskUtilization=0,this.sparkMetrics.diskUtilization>95&&Math.random()<.005&&(this.sparkMetrics.diskErrors+=1)}updateJVMMetrics(){this.sparkMetrics.heapUsage=this.sparkMetrics.totalMemoryUsed;const e=.15;this.sparkMetrics.nonHeapUsage=this.sparkMetrics.totalMemory*e;const t=10,s=this.sparkMetrics.aliveExecutors*2,n=this.sparkMetrics.activeJobs*5,i=this.sparkMetrics.activeStages*3;this.sparkMetrics.threadCount=t+s+n+i}parseMemory(e){const t=e.match(/^(\d+)([kmg]?)$/i);if(!t)return 4096;const s=parseInt(t[1],10);switch(t[2].toLowerCase()){case"k":return s/1024;case"m":return s;case"g":return s*1024;default:return s}}getMetrics(){return{...this.sparkMetrics}}getJobs(){return Array.from(this.jobs.values())}getStages(){return Array.from(this.stages.values())}getExecutors(){return Array.from(this.executors.values())}getJob(e){return this.jobs.get(e)}getStagesForJob(e){return Array.from(this.stages.values()).filter(t=>t.jobId===e)}getJobDAG(e){if(!this.jobs.get(e))return{stages:[],edges:[]};const s=this.getStagesForJob(e),n=[];for(const i of s)if(i.parentStageIds)for(const a of i.parentStageIds)n.push({from:a,to:i.id});return{stages:s,edges:n}}addJob(e){this.jobs.set(e.id,e),e.status==="RUNNING"&&this.activeJobs.set(e.id,e)}removeJob(e){this.jobs.delete(e),this.activeJobs.delete(e);const t=Array.from(this.stages.entries()).filter(([s,n])=>n.jobId===e);for(const[s,n]of t)this.stages.delete(s),this.activeStages.delete(s)}addExecutor(e){this.executors.set(e.id,e),this.executorHeartbeatInterval.set(e.id,3e3+Math.random()*2e3)}removeExecutor(e){const t=this.executors.get(e);t&&(t.status="DEAD"),this.executorHeartbeatInterval.delete(e)}executeSQL(e,t=Date.now()){const s=`sql-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n=this.generateLogicalPlan(e),i=this.generatePhysicalPlan(e),a=this.generateExplainPlan(e,n,i),o=this.estimateQueryRows(e),l=this.estimateQueryDuration(e,o),d=`job-${s}`,h={id:d,name:`SQL Query: ${e.substring(0,50)}...`,status:"RUNNING",startTime:t,stages:this.estimateQueryStages(e),tasks:this.estimateQueryTasks(e,o),executors:this.executors.size,inputBytes:o*1024,outputBytes:o*512,shuffleRead:o*256,shuffleWrite:o*256,submissionTime:t};this.jobs.set(d,h),this.activeJobs.set(d,h);const p=[];for(let v=0;v<h.stages;v++){const b=`stage-${d}-${v}`;p.push(b);const M={id:b,jobId:d,name:`SQL Stage ${v+1}`,status:v===0?"ACTIVE":"SKIPPED",numTasks:Math.floor(h.tasks/h.stages),numActiveTasks:v===0?Math.floor(h.tasks/h.stages):0,numCompleteTasks:0,numFailedTasks:0,inputBytes:h.inputBytes/h.stages,outputBytes:h.outputBytes/h.stages,shuffleRead:h.shuffleRead/h.stages,shuffleWrite:h.shuffleWrite/h.stages,duration:0,submissionTime:v===0?t:void 0,parentStageIds:v>0?[p[v-1]]:void 0,childStageIds:v<h.stages-1?[p[v+1]]:void 0,stageType:v===0?"map":v===h.stages-1?"action":"shuffle",shuffleNetworkRead:0,shuffleNetworkWrite:0,shuffleSpillMemory:0,shuffleSpillDisk:0,shuffleFetchWaitTime:0};this.stages.set(b,M),M.status==="ACTIVE"&&this.activeStages.set(b,M)}const g={id:s,query:e,status:"RUNNING",startTime:t,executionTime:l,rowsProcessed:0,explainPlan:a,physicalPlan:i,logicalPlan:n,stages:p,jobId:d};return this.sqlQueries.set(s,g),this.activeSqlQueries.set(s,g),g}generateLogicalPlan(e){const t=e.toUpperCase().trim();return t.startsWith("SELECT")?`== Logical Plan ==
Project [columns]
+- Filter [conditions]
   +- Relation [table]
`:t.startsWith("INSERT")?`== Logical Plan ==
InsertIntoTable [target]
+- Project [columns]
   +- Relation [source]
`:t.startsWith("CREATE TABLE")?`== Logical Plan ==
CreateTable [table]
+- Relation [schema]
`:`== Logical Plan ==
UnresolvedRelation [table]
`}generatePhysicalPlan(e){const t=e.toUpperCase().trim(),s=t.includes("JOIN"),n=t.includes("GROUP BY"),i=t.includes("ORDER BY");let a=`== Physical Plan ==
*Project [columns]
`;return i&&(a+=`+- *Sort [order]
`),n&&(a+=`+- *HashAggregate [grouping]
`),s?a+=`+- *BroadcastHashJoin [join]
   :- *Project [left]
   :  +- *Scan [leftTable]
   +- *Project [right]
      +- *Scan [rightTable]
`:a+=`+- *Scan [table]
`,a}generateExplainPlan(e,t,s){return`${t}
${s}`}estimateQueryRows(e){const t=e.toUpperCase();let s=1e4;return t.includes("WHERE")&&(s*=.5),t.includes("JOIN")&&(s*=2),t.includes("GROUP BY")&&(s*=.3),t.includes("LIMIT")&&(s=Math.min(s,1e3)),Math.floor(s*(.5+Math.random()))}estimateQueryDuration(e,t){const i=1e3+t/1e4*1e3;return Math.floor(i*(.8+Math.random()*.4))}estimateQueryStages(e){const t=e.toUpperCase();let s=2;return t.includes("JOIN")&&(s+=1),t.includes("GROUP BY")&&(s+=1),t.includes("ORDER BY")&&(s+=1),Math.min(s,7)}estimateQueryTasks(e,t){const n=Math.ceil(t/1e4*10);return Math.max(10,Math.min(n,200))}updateSQLQuery(e,t){const s=this.sqlQueries.get(e);if(!s||s.status!=="RUNNING")return;const n=t-(s.startTime||t),i=s.executionTime||5e3;if(n>=i){if(Math.random()<.05?s.status="FAILED":(s.status="SUCCEEDED",s.rowsProcessed=this.estimateQueryRows(s.query)),s.endTime=t,s.executionTime=n,s.jobId){const o=this.jobs.get(s.jobId);o&&(o.status=s.status==="SUCCEEDED"?"SUCCEEDED":"FAILED",o.endTime=t,o.completionTime=t,o.duration=n)}this.activeSqlQueries.delete(e)}else{const a=Math.min(1,n/i);s.rowsProcessed=Math.floor(this.estimateQueryRows(s.query)*a)}}getSQLQueries(){return Array.from(this.sqlQueries.values())}getSQLQuery(e){return this.sqlQueries.get(e)}createStreamingJob(e,t,s=Date.now()){const n=`streaming-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i={id:n,name:e,status:"ACTIVE",batchInterval:t,startTime:s,lastBatchTime:s,nextBatchTime:s+t,totalBatches:0,processedBatches:0,failedBatches:0,totalRecordsProcessed:0,averageProcessingTime:t*.8,checkpointDirectory:this.config?.checkpointDirectory||"/checkpoint",backpressureEnabled:!0,currentBackpressure:0};return this.streamingJobs.set(n,i),this.activeStreamingJobs.set(n,i),i}updateStreamingJobs(e){if(!this.config?.enableStreaming)return;const t=Array.from(this.activeStreamingJobs.entries());for(const[s,n]of t){if(n.status!=="ACTIVE"){this.activeStreamingJobs.delete(s);continue}n.nextBatchTime&&e>=n.nextBatchTime&&this.processStreamingBatch(s,e),this.updateBackpressure(s,e),this.config.enableCheckpointing&&this.performCheckpoint(s,e)}}processStreamingBatch(e,t){const s=this.streamingJobs.get(e);if(!s||s.status!=="ACTIVE")return;if(s.backpressureEnabled&&s.currentBackpressure>.8){s.nextBatchTime=t+s.batchInterval*.5;return}s.totalBatches++,s.lastBatchTime=t;const n=s.batchInterval*(.5+Math.random()*.5),i=Math.floor(1e3+Math.random()*9e3);if(Math.random()<.05)s.failedBatches++,s.status="FAILED",this.activeStreamingJobs.delete(e);else{s.processedBatches++,s.totalRecordsProcessed+=i,s.averageProcessingTime=(s.averageProcessingTime*(s.processedBatches-1)+n)/s.processedBatches;const o=`batch-${e}-${s.totalBatches}`,l={id:o,name:`${s.name} - Batch ${s.totalBatches}`,status:"RUNNING",startTime:t,stages:2+Math.floor(Math.random()*3),tasks:10+Math.floor(Math.random()*40),executors:this.executors.size,inputBytes:i*1024,outputBytes:i*512,shuffleRead:i*256,shuffleWrite:i*256,submissionTime:t};this.jobs.set(o,l),this.activeJobs.set(o,l),s.jobId=o,s.nextBatchTime=t+s.batchInterval}}updateBackpressure(e,t){const s=this.streamingJobs.get(e);if(!s||!s.backpressureEnabled)return;const n=s.averageProcessingTime/s.batchInterval;n>1?s.currentBackpressure=Math.min(1,(n-1)*.5):s.currentBackpressure=Math.max(0,s.currentBackpressure-.1),this.activeJobs.size>=5&&(s.currentBackpressure=Math.min(1,s.currentBackpressure+.2))}performCheckpoint(e,t){const s=this.streamingJobs.get(e);!s||!this.config?.enableCheckpointing||t-this.lastStreamingCheckpoint>=this.CHECKPOINT_INTERVAL&&(this.lastStreamingCheckpoint=t,Math.random()<.01&&(s.status="FAILED",this.activeStreamingJobs.delete(e)))}getStreamingJobs(){return Array.from(this.streamingJobs.values())}getStreamingJob(e){return this.streamingJobs.get(e)}stopStreamingJob(e){const t=this.streamingJobs.get(e);t&&(t.status="STOPPED",this.activeStreamingJobs.delete(e))}initializeStreamingJob(e){if(!this.config?.enableStreaming||Array.from(this.streamingJobs.values()).some(n=>n.status==="ACTIVE"))return;const s=this.config.streamingBatchInterval||1e3;this.createStreamingJob("Spark Streaming Job",s,e)}}class Yk{config=null;models=new Map;predictions=new Map;MAX_PREDICTION_HISTORY=1e4;batchQueues=new Map;metrics={totalModels:0,servingModels:0,loadingModels:0,unavailableModels:0,totalPredictions:0,successfulPredictions:0,failedPredictions:0,averageLatency:0,p50Latency:0,p99Latency:0,requestsPerSecond:0,throughput:0,errorRate:0,batchUtilization:0,memoryUsage:0,cpuUtilization:0,requestsTotal:0,requestsErrors:0,modelMetrics:new Map};latencyHistory=[];MAX_LATENCY_HISTORY=1e3;requestTimestamps=[];MAX_REQUEST_TIMESTAMPS=1e3;lastSecondStart=Date.now();requestsThisSecond=0;lastUpdateTime=Date.now();modelLoadingStates=new Map;pendingPredictions=[];metricsHistory=[];MAX_METRICS_HISTORY=300;initializeConfig(e){const t=e.data.config||{};this.config={enabled:t.enabled!==!1,endpoint:t.endpoint||"localhost:8501",modelBasePath:t.modelBasePath||"/models",enableBatching:t.enableBatching!==!1,batchSize:t.batchSize||32,maxBatchSize:t.maxBatchSize||128,maxBatchWaitTime:t.maxBatchWaitTime||100,enableGPU:t.enableGPU||!1,gpuMemoryFraction:t.gpuMemoryFraction||.5,enableMonitoring:t.enableMonitoring!==!1,monitoringPort:t.monitoringPort||8501,numThreads:t.numThreads||4,interOpParallelismThreads:t.interOpParallelismThreads||2,intraOpParallelismThreads:t.intraOpParallelismThreads||2,errorRate:t.errorRate||0,enableErrorSimulation:t.enableErrorSimulation||!1,timeoutMs:t.timeoutMs||3e4,versioningPolicy:t.versioningPolicy||"latest",enableABTesting:t.enableABTesting||!1,abTestConfig:t.abTestConfig||[],enablePrometheusExport:t.enablePrometheusExport||!1,prometheusPort:t.prometheusPort||8502,enableGRPC:t.enableGRPC||!1,grpcPort:t.grpcPort||8500,...t},this.initializeModels(),this.initializeBatchQueues()}initializeModels(){if(this.config){if(this.models.clear(),this.config.models&&Array.isArray(this.config.models))for(const e of this.config.models){const t=`${e.name}:${e.version}`,s={name:e.name,version:e.version,status:e.status||"serving",platform:e.platform||"tensorflow",inputs:e.inputs||[],outputs:e.outputs||[],requests:0,avgLatency:0,totalPredictions:0,successfulPredictions:0,failedPredictions:0,memoryUsage:this.estimateModelMemory(e),loadTime:this.estimateLoadTime(e),lastUsed:Date.now()};this.models.set(t,s),s.status==="loading"&&this.modelLoadingStates.set(t,{startTime:Date.now(),loadDuration:s.loadTime||5e3})}this.updateModelSpecificMetrics()}}initializeBatchQueues(){if(!(!this.config||!this.config.enableBatching)){this.batchQueues.clear();for(const[e,t]of this.models.entries())t.status==="serving"&&this.batchQueues.set(e,{modelName:t.name,version:t.version,items:[],lastBatchTime:Date.now()})}}estimateModelMemory(e){let t=100;if(e.inputs&&Array.isArray(e.inputs))for(const s of e.inputs){const i=(s.shape||"[1,1]").match(/\d+/g);if(i){const a=i.reduce((o,l)=>parseInt(o)*parseInt(l),1);t+=a*.001}}return Math.max(50,Math.min(5e3,t))}estimateLoadTime(e){let t=2e3;const s=this.estimateModelMemory(e);return t+=s*2,Math.max(1e3,Math.min(3e4,t))}performUpdate(e,t=!1){!this.config||!this.config.enabled||(e-this.lastUpdateTime,this.lastUpdateTime=e,this.updateModelLoadingStates(e),this.processPendingPredictions(e),this.config.enableBatching&&this.processBatchQueues(e),t&&this.pendingPredictions.length===0&&this.simulatePredictions(e),this.updateMetrics(e))}addPendingPrediction(e,t,s){return new Promise((n,i)=>{const a=`pred-${Date.now()}-${Math.random()}`;this.pendingPredictions.push({id:a,modelName:e,version:t,input:s,timestamp:Date.now(),resolve:o=>n(o),reject:o=>i(o)})})}processPendingPredictions(e){if(this.pendingPredictions.length===0)return;const t=[...this.pendingPredictions];this.pendingPredictions=[];for(const s of t){const n=e-s.timestamp;if(this.config?.timeoutMs&&n>this.config.timeoutMs){e-s.timestamp,this.metrics.requestsTotal++,this.metrics.requestsErrors++,s.reject(new Error("Request timeout"));continue}this.processPredictionInternal(s.id,s.modelName,s.version,s.input,e,s.resolve,s.reject)}}processPredictionInternal(e,t,s,n,i,a,o){const l=`${t}:${s}`,d=this.models.get(l);if(!d){this.metrics.requestsTotal++,this.metrics.requestsErrors++,o(new Error(`Model ${t}:${s} not found`));return}if(d.status!=="serving"){this.metrics.requestsTotal++,this.metrics.requestsErrors++,o(new Error(`Model ${t}:${s} is not serving (status: ${d.status})`));return}this.requestTimestamps.push(i),this.requestTimestamps.length>this.MAX_REQUEST_TIMESTAMPS&&(this.requestTimestamps=this.requestTimestamps.slice(-this.MAX_REQUEST_TIMESTAMPS));let h=!1,p="model";if(this.config?.enableErrorSimulation&&this.config.errorRate&&this.config.errorRate>0&&Math.random()<this.config.errorRate){h=!0;const g=Math.random();g<.3?p="timeout":g<.6?p="validation":p="model"}if(h){const g=this.calculateBaseLatency(d),v=p==="timeout"?"Request timeout":p==="validation"?"Input validation failed":"Model inference error",b={id:e,model:t,version:s,input:JSON.stringify(n),status:"error",timestamp:i,latency:Math.floor(g),error:v};this.predictions.set(b.id,b),d.requests=(d.requests||0)+1,d.totalPredictions=(d.totalPredictions||0)+1,d.failedPredictions=(d.failedPredictions||0)+1,this.metrics.requestsTotal++,this.metrics.requestsErrors++,o(new Error(v));return}if(this.config?.enableBatching){const g=this.batchQueues.get(l);if(!g){this.metrics.requestsTotal++,this.metrics.requestsErrors++,o(new Error("Batch queue not found"));return}g.items.push({predictionId:e,input:n,timestamp:i,resolve:a,reject:o})}else{const g=this.calculateBaseLatency(d),v=this.generateMockOutput(d),b={id:e,model:t,version:s,input:JSON.stringify(n),output:JSON.stringify(v),status:"success",timestamp:i,latency:Math.floor(g)};if(this.predictions.set(b.id,b),d.requests=(d.requests||0)+1,d.totalPredictions=(d.totalPredictions||0)+1,d.successfulPredictions=(d.successfulPredictions||0)+1,d.avgLatency=this.updateAverageLatency(d.avgLatency||0,b.latency,d.totalPredictions),d.lastUsed=i,this.predictions.size>this.MAX_PREDICTION_HISTORY){const M=this.predictions.keys().next().value;this.predictions.delete(M)}this.metrics.requestsTotal++,a({success:!0,output:v,latency:b.latency})}}updateModelLoadingStates(e){for(const[t,s]of this.modelLoadingStates.entries())if(e-s.startTime>=s.loadDuration){const i=this.models.get(t);i&&(i.status="serving",i.lastUsed=e),this.modelLoadingStates.delete(t),this.config?.enableBatching&&i&&this.batchQueues.set(t,{modelName:i.name,version:i.version,items:[],lastBatchTime:e})}}processBatchQueues(e){if(this.config)for(const[t,s]of this.batchQueues.entries()){const n=this.models.get(t);if(!n||n.status!=="serving")continue;const i=e-s.lastBatchTime;(s.items.length>=(this.config.batchSize||32)||i>=(this.config.maxBatchWaitTime||100)&&s.items.length>0)&&s.items.length>0&&this.executeBatch(t,s,e)}}executeBatch(e,t,s){const n=this.models.get(e);if(!n){const h=t.items.splice(0,t.items.length);for(const p of h)p.reject(new Error("Model not found"));return}const i=t.items.length,a=t.items.splice(0,i),o=this.calculateBaseLatency(n),l=Math.max(.5,1-(i-1)*.05),d=o*l;for(const h of a){let p=!1,g="model";if(this.config?.enableErrorSimulation&&this.config.errorRate&&this.config.errorRate>0&&Math.random()<this.config.errorRate){p=!0;const M=Math.random();M<.3?g="timeout":M<.6?g="validation":g="model"}if(p){const M=Math.floor(d),x=g==="timeout"?"Request timeout":g==="validation"?"Input validation failed":"Model inference error",S={id:h.predictionId,model:n.name,version:n.version,input:JSON.stringify(h.input),status:"error",timestamp:s,latency:M,batchSize:i,error:x};this.predictions.set(S.id,S),n.requests=(n.requests||0)+1,n.totalPredictions=(n.totalPredictions||0)+1,n.failedPredictions=(n.failedPredictions||0)+1,this.metrics.requestsTotal++,this.metrics.requestsErrors++,h.reject(new Error(x));continue}const v=this.generateMockOutput(n),b={id:h.predictionId,model:n.name,version:n.version,input:JSON.stringify(h.input),output:JSON.stringify(v),status:"success",timestamp:s,latency:Math.floor(d+(Math.random()*10-5)),batchSize:i};this.predictions.set(b.id,b),n.requests=(n.requests||0)+1,n.totalPredictions=(n.totalPredictions||0)+1,n.successfulPredictions=(n.successfulPredictions||0)+1,n.avgLatency=this.updateAverageLatency(n.avgLatency||0,b.latency,n.totalPredictions),n.lastUsed=s,this.metrics.requestsTotal++,h.resolve({success:!0,output:v,latency:b.latency})}if(t.lastBatchTime=s,this.predictions.size>this.MAX_PREDICTION_HISTORY){const h=this.predictions.keys().next().value;this.predictions.delete(h)}}simulatePredictions(e){if(!this.config)return;const t=this.calculateRequestRate(),s=Math.floor(t*.1);for(let n=0;n<s;n++){const i=Array.from(this.models.values()).filter(h=>h.status==="serving");if(i.length===0)continue;const a=i[Math.floor(Math.random()*i.length)],o=`${a.name}:${a.version}`,l=`pred-${e}-${n}`,d=this.generateMockInput(a);if(this.config.enableBatching){const h=this.batchQueues.get(o);h&&h.items.push({predictionId:l,input:d,timestamp:e,resolve:()=>{},reject:()=>{}})}else{const h=this.calculateBaseLatency(a),p={id:l,model:a.name,version:a.version,input:JSON.stringify(d),output:JSON.stringify(this.generateMockOutput(a)),status:"success",timestamp:e,latency:Math.floor(h+(Math.random()*10-5))};this.predictions.set(p.id,p),a.requests=(a.requests||0)+1,a.totalPredictions=(a.totalPredictions||0)+1,a.successfulPredictions=(a.successfulPredictions||0)+1,a.avgLatency=this.updateAverageLatency(a.avgLatency||0,p.latency,a.totalPredictions),a.lastUsed=e}}}calculateBaseLatency(e){let t=20;const s=e.memoryUsage||100;return t+=s*.1,this.config?.enableGPU&&(t*=.3),t+=Math.random()*10-5,Math.max(5,t)}calculateRequestRate(){return Array.from(this.models.values()).filter(t=>t.status==="serving").length*10}generateMockInput(e){const t={};if(e.inputs&&Array.isArray(e.inputs))for(const s of e.inputs){const i=(s.shape||"[1,1]").match(/\d+/g);if(i){const a=i.map(o=>parseInt(o));t[s.name]=this.generateArray(a)}else t[s.name]=[Math.random()]}else t.instances=[[Math.random(),Math.random(),Math.random()]];return t}generateArray(e){if(e.length===1)return Array(e[0]).fill(0).map(()=>Math.random());if(e.length===2)return Array(e[0]).fill(0).map(()=>Array(e[1]).fill(0).map(()=>Math.random()));{const t=e.reduce((s,n)=>s*n,1);return Array(t).fill(0).map(()=>Math.random())}}generateMockOutput(e){if(e.outputs&&e.outputs.length>0){const t={};for(const s of e.outputs){const i=(s.shape||"[1,1]").match(/\d+/g);if(i){const a=i.map(o=>parseInt(o));t[s.name]=this.generateArray(a)}else t[s.name]=[[Math.random()]]}return t}return{predictions:[[Math.random(),Math.random(),Math.random()]]}}updateAverageLatency(e,t,s){return s===1?t:(e*(s-1)+t)/s}updateMetrics(e){let t=0,s=0,n=0;for(const d of this.models.values())switch(d.status){case"serving":t++;break;case"loading":s++;break;case"unavailable":case"error":n++;break}this.metrics.totalModels=this.models.size,this.metrics.servingModels=t,this.metrics.loadingModels=s,this.metrics.unavailableModels=n;const i=Array.from(this.predictions.values()).filter(d=>e-d.timestamp<6e4);if(this.metrics.totalPredictions=this.predictions.size,this.metrics.successfulPredictions=i.filter(d=>d.status==="success").length,this.metrics.failedPredictions=i.filter(d=>d.status==="error").length,i.length>0){const d=i.map(h=>h.latency).sort((h,p)=>h-p);this.metrics.averageLatency=d.reduce((h,p)=>h+p,0)/d.length,this.metrics.p50Latency=this.calculatePercentile(d,50),this.metrics.p99Latency=this.calculatePercentile(d,99),this.latencyHistory.push(...d.slice(-100)),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&(this.latencyHistory=this.latencyHistory.slice(-this.MAX_LATENCY_HISTORY))}const a=e-1e3,o=this.requestTimestamps.filter(d=>d>a);if(this.metrics.requestsPerSecond=o.length,this.metrics.throughput=this.metrics.requestsPerSecond,i.length>0&&(this.metrics.errorRate=this.metrics.failedPredictions/i.length),this.config?.enableBatching){let d=0,h=0;for(const g of this.batchQueues.values())d+=g.items.length,h++;const p=h>0?d/h:0;this.metrics.batchUtilization=Math.min(1,p/(this.config.batchSize||32))}this.config?.enableGPU&&(this.metrics.gpuUtilization=Math.min(1,this.metrics.requestsPerSecond/100));let l=0;for(const d of this.models.values())l+=d.memoryUsage||0;this.metrics.memoryUsage=l,this.metrics.cpuUtilization=Math.min(1,this.metrics.requestsPerSecond/50),this.updateModelSpecificMetrics(),this.metricsHistory.push({timestamp:e,latency:this.metrics.averageLatency,rps:this.metrics.requestsPerSecond,errorRate:this.metrics.errorRate,throughput:this.metrics.throughput,batchUtilization:this.metrics.batchUtilization,gpuUtilization:this.metrics.gpuUtilization,cpuUtilization:this.metrics.cpuUtilization}),this.metricsHistory.length>this.MAX_METRICS_HISTORY&&(this.metricsHistory=this.metricsHistory.slice(-this.MAX_METRICS_HISTORY))}updateModelSpecificMetrics(){this.metrics.modelMetrics.clear();for(const[e,t]of this.models.entries()){const s=Array.from(this.predictions.values()).filter(i=>i.model===t.name&&i.version===t.version),n=`${t.name}:${t.version}`;this.metrics.modelMetrics.set(n,{predictions:s.length,avgLatency:t.avgLatency||0,errorRate:t.failedPredictions&&t.totalPredictions?t.failedPredictions/t.totalPredictions:0,requestsPerSecond:t.requests?t.requests/60:0})}}calculatePercentile(e,t){if(e.length===0)return 0;const s=Math.ceil(t/100*e.length)-1;return e[Math.max(0,Math.min(s,e.length-1))]}async processPrediction(e,t,s){const n=Date.now(),i=`${e}:${t}`,a=this.models.get(i);if(!a){const o=Date.now()-n;return this.metrics.requestsTotal++,this.metrics.requestsErrors++,{success:!1,error:`Model ${e}:${t} not found`,latency:o}}if(a.status!=="serving"){const o=Date.now()-n;return this.metrics.requestsTotal++,this.metrics.requestsErrors++,{success:!1,error:`Model ${e}:${t} is not serving (status: ${a.status})`,latency:o}}if(this.requestTimestamps.push(n),this.requestTimestamps.length>this.MAX_REQUEST_TIMESTAMPS&&(this.requestTimestamps=this.requestTimestamps.slice(-this.MAX_REQUEST_TIMESTAMPS)),this.config?.enableBatching)return new Promise((o,l)=>{const d=this.batchQueues.get(i);if(!d){const p=Date.now()-n;this.metrics.requestsTotal++,this.metrics.requestsErrors++,o({success:!1,error:"Batch queue not found",latency:p});return}const h=`pred-${Date.now()}-${Math.random()}`;d.items.push({predictionId:h,input:s,timestamp:n,resolve:p=>{const g=Date.now()-n;this.metrics.requestsTotal++,o({success:!0,output:p,latency:g})},reject:p=>{const g=Date.now()-n;this.metrics.requestsTotal++,this.metrics.requestsErrors++,o({success:!1,error:p.message,latency:g})}})});{const o=this.calculateBaseLatency(a),l=this.generateMockOutput(a),d={id:`pred-${Date.now()}`,model:e,version:t,input:JSON.stringify(s),output:JSON.stringify(l),status:"success",timestamp:n,latency:Math.floor(o)};if(this.predictions.set(d.id,d),a.requests=(a.requests||0)+1,a.totalPredictions=(a.totalPredictions||0)+1,a.successfulPredictions=(a.successfulPredictions||0)+1,a.avgLatency=this.updateAverageLatency(a.avgLatency||0,d.latency,a.totalPredictions),a.lastUsed=n,this.predictions.size>this.MAX_PREDICTION_HISTORY){const h=this.predictions.keys().next().value;this.predictions.delete(h)}return this.metrics.requestsTotal++,{success:!0,output:l,latency:d.latency}}}getMetrics(){return{...this.metrics}}getModels(){return Array.from(this.models.values())}getRecentPredictions(e=100){return Array.from(this.predictions.values()).sort((t,s)=>s.timestamp-t.timestamp).slice(0,e)}syncModelsFromConfig(){this.config&&(this.initializeModels(),this.initializeBatchQueues())}getMetricsHistory(e){return e?this.metricsHistory.slice(-e):[...this.metricsHistory]}selectModelVersion(e){if(!this.config)return null;if(this.config.enableABTesting&&this.config.abTestConfig){const s=this.config.abTestConfig.find(n=>n.modelName===e);if(s&&s.versions.length>0){const n=Math.random()*100;let i=0;for(const a of s.versions)if(i+=a.trafficPercentage,n<=i){const o=`${e}:${a.version}`;if(this.models.has(o)&&this.models.get(o)?.status==="serving")return a.version}for(const a of s.versions){const o=`${e}:${a.version}`;if(this.models.has(o)&&this.models.get(o)?.status==="serving")return a.version}}}const t=Array.from(this.models.values()).filter(s=>s.name===e&&s.status==="serving").map(s=>({version:s.version,timestamp:s.lastUsed||0})).sort((s,n)=>n.version.localeCompare(s.version));if(t.length===0)return null;switch(this.config.versioningPolicy){case"latest":return t[0].version;case"all":return t[Math.floor(Math.random()*t.length)].version;case"specific":return t[0].version;default:return t[0].version}}getPrometheusMetrics(){const e=[];e.push("# HELP tensorflow_serving_models_total Total number of models"),e.push("# TYPE tensorflow_serving_models_total gauge"),e.push(`tensorflow_serving_models_total ${this.metrics.totalModels}`),e.push("# HELP tensorflow_serving_models_serving Number of serving models"),e.push("# TYPE tensorflow_serving_models_serving gauge"),e.push(`tensorflow_serving_models_serving ${this.metrics.servingModels}`),e.push("# HELP tensorflow_serving_predictions_total Total number of predictions"),e.push("# TYPE tensorflow_serving_predictions_total counter"),e.push(`tensorflow_serving_predictions_total ${this.metrics.totalPredictions}`),e.push("# HELP tensorflow_serving_predictions_successful Successful predictions"),e.push("# TYPE tensorflow_serving_predictions_successful counter"),e.push(`tensorflow_serving_predictions_successful ${this.metrics.successfulPredictions}`),e.push("# HELP tensorflow_serving_predictions_failed Failed predictions"),e.push("# TYPE tensorflow_serving_predictions_failed counter"),e.push(`tensorflow_serving_predictions_failed ${this.metrics.failedPredictions}`),e.push("# HELP tensorflow_serving_latency_ms Average latency in milliseconds"),e.push("# TYPE tensorflow_serving_latency_ms gauge"),e.push(`tensorflow_serving_latency_ms ${this.metrics.averageLatency}`),e.push("# HELP tensorflow_serving_latency_p50_ms P50 latency in milliseconds"),e.push("# TYPE tensorflow_serving_latency_p50_ms gauge"),e.push(`tensorflow_serving_latency_p50_ms ${this.metrics.p50Latency}`),e.push("# HELP tensorflow_serving_latency_p99_ms P99 latency in milliseconds"),e.push("# TYPE tensorflow_serving_latency_p99_ms gauge"),e.push(`tensorflow_serving_latency_p99_ms ${this.metrics.p99Latency}`),e.push("# HELP tensorflow_serving_requests_per_second Requests per second"),e.push("# TYPE tensorflow_serving_requests_per_second gauge"),e.push(`tensorflow_serving_requests_per_second ${this.metrics.requestsPerSecond}`),e.push("# HELP tensorflow_serving_error_rate Error rate (0-1)"),e.push("# TYPE tensorflow_serving_error_rate gauge"),e.push(`tensorflow_serving_error_rate ${this.metrics.errorRate}`),e.push("# HELP tensorflow_serving_batch_utilization Batch utilization (0-1)"),e.push("# TYPE tensorflow_serving_batch_utilization gauge"),e.push(`tensorflow_serving_batch_utilization ${this.metrics.batchUtilization}`),this.metrics.gpuUtilization!==void 0&&(e.push("# HELP tensorflow_serving_gpu_utilization GPU utilization (0-1)"),e.push("# TYPE tensorflow_serving_gpu_utilization gauge"),e.push(`tensorflow_serving_gpu_utilization ${this.metrics.gpuUtilization}`)),e.push("# HELP tensorflow_serving_cpu_utilization CPU utilization (0-1)"),e.push("# TYPE tensorflow_serving_cpu_utilization gauge"),e.push(`tensorflow_serving_cpu_utilization ${this.metrics.cpuUtilization}`),e.push("# HELP tensorflow_serving_memory_usage_mb Memory usage in MB"),e.push("# TYPE tensorflow_serving_memory_usage_mb gauge"),e.push(`tensorflow_serving_memory_usage_mb ${this.metrics.memoryUsage}`);for(const[t,s]of this.metrics.modelMetrics.entries()){const[n,i]=t.split(":");e.push(`# Model-specific metrics for ${n}:${i}`),e.push(`tensorflow_serving_model_predictions_total{model="${n}",version="${i}"} ${s.predictions}`),e.push(`tensorflow_serving_model_latency_ms{model="${n}",version="${i}"} ${s.avgLatency}`),e.push(`tensorflow_serving_model_error_rate{model="${n}",version="${i}"} ${s.errorRate}`),e.push(`tensorflow_serving_model_rps{model="${n}",version="${i}"} ${s.requestsPerSecond}`)}return e.join(`
`)}getModelStatus(e,t){const s=Array.from(this.models.values()).filter(n=>n.name===e&&(!t||n.version===t));return s.length===0?null:{model_version_status:s.map(n=>({version:n.version,state:n.status==="serving"?"AVAILABLE":n.status==="loading"?"LOADING":(n.status==="error","UNAVAILABLE"),status:{error_code:n.status==="error"?1:0,error_message:n.status==="error"?"Model error":""}}))}}async processGRPCPrediction(e,t,s){return this.processPrediction(e,t,s)}getGRPCInfo(){if(!this.config||!this.config.enableGRPC)return null;const e=this.config.endpoint?.split(":")[0]||"localhost",t=this.config.grpcPort||8500;return{enabled:!0,port:t,endpoint:`${e}:${t}`}}}class Xk{config=null;models=new Map;predictions=new Map;MAX_PREDICTION_HISTORY=1e4;batchQueues=new Map;metrics={totalModels:0,servingModels:0,loadingModels:0,unavailableModels:0,totalPredictions:0,successfulPredictions:0,failedPredictions:0,averageLatency:0,p50Latency:0,p99Latency:0,requestsPerSecond:0,throughput:0,errorRate:0,batchUtilization:0,memoryUsage:0,cpuUtilization:0,requestsTotal:0,requestsErrors:0,modelMetrics:new Map};latencyHistory=[];MAX_LATENCY_HISTORY=1e3;requestTimestamps=[];MAX_REQUEST_TIMESTAMPS=1e3;lastSecondStart=Date.now();requestsThisSecond=0;lastUpdateTime=Date.now();modelLoadingStates=new Map;pendingPredictions=[];metricsHistory=[];MAX_METRICS_HISTORY=300;initializeConfig(e){const t=e.data.config||{};this.config={enabled:t.enabled!==!1,endpoint:t.endpoint||"localhost:8080",modelStore:t.modelStore||"/models",enableWorkers:t.enableWorkers!==!1,numWorkers:t.numWorkers||1,enableBatching:t.enableBatching!==!1,batchSize:t.batchSize||1,maxBatchDelay:t.maxBatchDelay||100,enableGPU:t.enableGPU||!1,enableMetrics:t.enableMetrics!==!1,metricsPort:t.metricsPort||8082,errorRate:t.errorRate||0,enableErrorSimulation:t.enableErrorSimulation||!1,timeoutMs:t.timeoutMs||3e4,...t},this.initializeModels(),this.initializeBatchQueues()}initializeModels(){if(this.config){if(this.models.clear(),this.config.models&&Array.isArray(this.config.models))for(const e of this.config.models){const t=`${e.name}:${e.version}`,s={name:e.name,version:e.version,status:e.status||"serving",handler:e.handler||"image_classifier",inputs:e.inputs||[],outputs:e.outputs||[],requests:0,avgLatency:0,totalPredictions:0,successfulPredictions:0,failedPredictions:0,memoryUsage:this.estimateModelMemory(e),loadTime:this.estimateLoadTime(e),lastUsed:Date.now()};this.models.set(t,s),s.status==="loading"&&this.modelLoadingStates.set(t,{startTime:Date.now(),loadDuration:s.loadTime||5e3})}this.updateModelMetrics()}}initializeBatchQueues(){if(!(!this.config||!this.config.enableBatching)){this.batchQueues.clear();for(const[e,t]of this.models.entries())t.status==="serving"&&this.batchQueues.set(e,{modelName:t.name,version:t.version,items:[],lastBatchTime:Date.now()})}}estimateModelMemory(e){let t=100;if(e.inputs&&Array.isArray(e.inputs))for(const s of e.inputs){const i=(s.shape||"[1,1]").match(/\d+/g);if(i){const a=i.reduce((o,l)=>parseInt(o)*parseInt(l),1);t+=a*.001}}return Math.max(50,Math.min(5e3,t))}estimateLoadTime(e){let t=2e3;const s=this.estimateModelMemory(e);return t+=s*2,Math.max(1e3,Math.min(3e4,t))}performUpdate(e,t=!1){!this.config||!this.config.enabled||(e-this.lastUpdateTime,this.lastUpdateTime=e,this.updateModelLoadingStates(e),this.processPendingPredictions(e),this.config.enableBatching&&this.processBatchQueues(e),t&&this.pendingPredictions.length===0&&this.simulatePredictions(e),this.updateMetrics(e))}addPendingPrediction(e,t,s){return new Promise((n,i)=>{const a=`pred-${Date.now()}-${Math.random()}`;this.pendingPredictions.push({id:a,modelName:e,version:t,input:s,timestamp:Date.now(),resolve:o=>n(o),reject:o=>i(o)})})}processPendingPredictions(e){if(this.pendingPredictions.length===0)return;const t=[...this.pendingPredictions];this.pendingPredictions=[];for(const s of t){const n=e-s.timestamp;if(this.config?.timeoutMs&&n>this.config.timeoutMs){e-s.timestamp,this.metrics.requestsTotal++,this.metrics.requestsErrors++,s.reject(new Error("Request timeout"));continue}this.processPredictionInternal(s.id,s.modelName,s.version,s.input,e,s.resolve,s.reject)}}processPredictionInternal(e,t,s,n,i,a,o){const l=`${t}:${s}`,d=this.models.get(l);if(!d){this.metrics.requestsTotal++,this.metrics.requestsErrors++,o(new Error(`Model ${t}:${s} not found`));return}if(d.status!=="serving"){this.metrics.requestsTotal++,this.metrics.requestsErrors++,o(new Error(`Model ${t}:${s} is not serving (status: ${d.status})`));return}this.requestTimestamps.push(i),this.requestTimestamps.length>this.MAX_REQUEST_TIMESTAMPS&&(this.requestTimestamps=this.requestTimestamps.slice(-this.MAX_REQUEST_TIMESTAMPS));let h=!1,p="model";if(this.config?.enableErrorSimulation&&this.config.errorRate&&this.config.errorRate>0&&Math.random()<this.config.errorRate){h=!0;const g=Math.random();g<.3?p="timeout":g<.6?p="validation":p="model"}if(h){const g=this.calculateBaseLatency(d),v=p==="timeout"?"Request timeout":p==="validation"?"Input validation failed":"Model inference error",b={id:e,model:t,version:s,input:JSON.stringify(n),status:"error",timestamp:i,latency:Math.floor(g),error:v};this.predictions.set(b.id,b),d.requests=(d.requests||0)+1,d.totalPredictions=(d.totalPredictions||0)+1,d.failedPredictions=(d.failedPredictions||0)+1,this.metrics.requestsTotal++,this.metrics.requestsErrors++,o(new Error(v));return}if(this.config?.enableBatching){const g=this.batchQueues.get(l);if(!g){this.metrics.requestsTotal++,this.metrics.requestsErrors++,o(new Error("Batch queue not found"));return}g.items.push({predictionId:e,input:n,timestamp:i,resolve:a,reject:o})}else{const g=this.calculateBaseLatency(d),v=this.generateMockOutput(d),b={id:e,model:t,version:s,input:JSON.stringify(n),output:JSON.stringify(v),status:"success",timestamp:i,latency:Math.floor(g)};if(this.predictions.set(b.id,b),d.requests=(d.requests||0)+1,d.totalPredictions=(d.totalPredictions||0)+1,d.successfulPredictions=(d.successfulPredictions||0)+1,d.avgLatency=this.updateAverageLatency(d.avgLatency||0,b.latency,d.totalPredictions),d.lastUsed=i,this.predictions.size>this.MAX_PREDICTION_HISTORY){const M=this.predictions.keys().next().value;this.predictions.delete(M)}this.metrics.requestsTotal++,a({success:!0,output:v,latency:b.latency})}}updateModelLoadingStates(e){for(const[t,s]of this.modelLoadingStates.entries())if(e-s.startTime>=s.loadDuration){const i=this.models.get(t);i&&(i.status="serving",i.lastUsed=e),this.modelLoadingStates.delete(t),this.config?.enableBatching&&i&&this.batchQueues.set(t,{modelName:i.name,version:i.version,items:[],lastBatchTime:e})}}processBatchQueues(e){if(this.config)for(const[t,s]of this.batchQueues.entries()){const n=this.models.get(t);if(!n||n.status!=="serving")continue;const i=e-s.lastBatchTime;(s.items.length>=(this.config.batchSize||1)||i>=(this.config.maxBatchDelay||100)&&s.items.length>0)&&s.items.length>0&&this.executeBatch(t,s,e)}}executeBatch(e,t,s){const n=this.models.get(e);if(!n){const h=t.items.splice(0,t.items.length);for(const p of h)p.reject(new Error("Model not found"));return}const i=t.items.length,a=t.items.splice(0,i),o=this.calculateBaseLatency(n),l=Math.max(.5,1-(i-1)*.05),d=o*l;for(const h of a){let p=!1,g="model";if(this.config?.enableErrorSimulation&&this.config.errorRate&&this.config.errorRate>0&&Math.random()<this.config.errorRate){p=!0;const M=Math.random();M<.3?g="timeout":M<.6?g="validation":g="model"}if(p){const M=Math.floor(d),x=g==="timeout"?"Request timeout":g==="validation"?"Input validation failed":"Model inference error",S={id:h.predictionId,model:n.name,version:n.version,input:JSON.stringify(h.input),status:"error",timestamp:s,latency:M,batchSize:i,error:x};this.predictions.set(S.id,S),n.requests=(n.requests||0)+1,n.totalPredictions=(n.totalPredictions||0)+1,n.failedPredictions=(n.failedPredictions||0)+1,this.metrics.requestsTotal++,this.metrics.requestsErrors++,h.reject(new Error(x));continue}const v=this.generateMockOutput(n),b={id:h.predictionId,model:n.name,version:n.version,input:JSON.stringify(h.input),output:JSON.stringify(v),status:"success",timestamp:s,latency:Math.floor(d+(Math.random()*10-5)),batchSize:i};this.predictions.set(b.id,b),n.requests=(n.requests||0)+1,n.totalPredictions=(n.totalPredictions||0)+1,n.successfulPredictions=(n.successfulPredictions||0)+1,n.avgLatency=this.updateAverageLatency(n.avgLatency||0,b.latency,n.totalPredictions),n.lastUsed=s,this.metrics.requestsTotal++,h.resolve({success:!0,output:v,latency:b.latency})}if(t.lastBatchTime=s,this.predictions.size>this.MAX_PREDICTION_HISTORY){const h=this.predictions.keys().next().value;this.predictions.delete(h)}}simulatePredictions(e){if(!this.config)return;const t=this.calculateRequestRate(),s=Math.floor(t*.1);for(let n=0;n<s;n++){const i=Array.from(this.models.values()).filter(h=>h.status==="serving");if(i.length===0)continue;const a=i[Math.floor(Math.random()*i.length)],o=`${a.name}:${a.version}`,l=`pred-${e}-${n}`,d=this.generateMockInput(a);if(this.config.enableBatching){const h=this.batchQueues.get(o);h&&h.items.push({predictionId:l,input:d,timestamp:e,resolve:()=>{},reject:()=>{}})}else{const h=this.calculateBaseLatency(a),p={id:l,model:a.name,version:a.version,input:JSON.stringify(d),output:JSON.stringify(this.generateMockOutput(a)),status:"success",timestamp:e,latency:Math.floor(h+(Math.random()*10-5))};this.predictions.set(p.id,p),a.requests=(a.requests||0)+1,a.totalPredictions=(a.totalPredictions||0)+1,a.successfulPredictions=(a.successfulPredictions||0)+1,a.avgLatency=this.updateAverageLatency(a.avgLatency||0,p.latency,a.totalPredictions),a.lastUsed=e}}}calculateBaseLatency(e){let t=20;const s=e.memoryUsage||100;return t+=s*.1,this.config?.enableGPU&&(t*=.3),t+=Math.random()*10-5,Math.max(5,t)}calculateRequestRate(){return Array.from(this.models.values()).filter(t=>t.status==="serving").length*10}generateMockInput(e){const t={};if(e.inputs&&Array.isArray(e.inputs))for(const s of e.inputs){const i=(s.shape||"[1,1]").match(/\d+/g);if(i){const a=i.map(o=>parseInt(o));t[s.name]=this.generateArray(a)}else t[s.name]=[Math.random()]}else e.handler==="image_classifier"?t.data=[[Math.random(),Math.random(),Math.random()]]:e.handler==="object_detector"?t.data=[[Math.random(),Math.random(),Math.random()]]:t.data=[[Math.random(),Math.random(),Math.random()]];return t}generateArray(e){if(e.length===1)return Array(e[0]).fill(0).map(()=>Math.random());if(e.length===2)return Array(e[0]).fill(0).map(()=>Array(e[1]).fill(0).map(()=>Math.random()));{const t=e.reduce((s,n)=>s*n,1);return Array(t).fill(0).map(()=>Math.random())}}generateMockOutput(e){if(e.outputs&&e.outputs.length>0){const t={};for(const s of e.outputs){const i=(s.shape||"[1,1]").match(/\d+/g);if(i){const a=i.map(o=>parseInt(o));t[s.name]=this.generateArray(a)}else t[s.name]=[[Math.random()]]}return t}return e.handler==="image_classifier"?{predictions:[[.85,.1,.05]]}:e.handler==="object_detector"?{detections:[{class:"object",confidence:.9,bbox:[10,20,100,150]}]}:{predictions:[[Math.random(),Math.random(),Math.random()]]}}updateAverageLatency(e,t,s){return s===1?t:(e*(s-1)+t)/s}updateMetrics(e){let t=0,s=0,n=0;for(const d of this.models.values())switch(d.status){case"serving":t++;break;case"loading":s++;break;case"unavailable":case"error":n++;break}this.metrics.totalModels=this.models.size,this.metrics.servingModels=t,this.metrics.loadingModels=s,this.metrics.unavailableModels=n;const i=Array.from(this.predictions.values()).filter(d=>e-d.timestamp<6e4);if(this.metrics.totalPredictions=this.predictions.size,this.metrics.successfulPredictions=i.filter(d=>d.status==="success").length,this.metrics.failedPredictions=i.filter(d=>d.status==="error").length,i.length>0){const d=i.map(h=>h.latency).sort((h,p)=>h-p);this.metrics.averageLatency=d.reduce((h,p)=>h+p,0)/d.length,this.metrics.p50Latency=this.calculatePercentile(d,50),this.metrics.p99Latency=this.calculatePercentile(d,99),this.latencyHistory.push(...d.slice(-100)),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&(this.latencyHistory=this.latencyHistory.slice(-this.MAX_LATENCY_HISTORY))}const a=e-1e3,o=this.requestTimestamps.filter(d=>d>a);if(this.metrics.requestsPerSecond=o.length,this.metrics.throughput=this.metrics.requestsPerSecond,i.length>0&&(this.metrics.errorRate=this.metrics.failedPredictions/i.length),this.config?.enableBatching){let d=0,h=0;for(const g of this.batchQueues.values())d+=g.items.length,h++;const p=h>0?d/h:0;this.metrics.batchUtilization=Math.min(1,p/(this.config.batchSize||1))}this.config?.enableGPU&&(this.metrics.gpuUtilization=Math.min(1,this.metrics.requestsPerSecond/100));let l=0;for(const d of this.models.values())l+=d.memoryUsage||0;this.metrics.memoryUsage=l,this.metrics.cpuUtilization=Math.min(1,this.metrics.requestsPerSecond/50),this.updateModelSpecificMetrics(),this.metricsHistory.push({timestamp:e,latency:this.metrics.averageLatency,rps:this.metrics.requestsPerSecond,errorRate:this.metrics.errorRate,throughput:this.metrics.throughput,batchUtilization:this.metrics.batchUtilization,gpuUtilization:this.metrics.gpuUtilization,cpuUtilization:this.metrics.cpuUtilization}),this.metricsHistory.length>this.MAX_METRICS_HISTORY&&(this.metricsHistory=this.metricsHistory.slice(-this.MAX_METRICS_HISTORY))}updateModelSpecificMetrics(){this.metrics.modelMetrics.clear();for(const[e,t]of this.models.entries()){const s=Array.from(this.predictions.values()).filter(i=>i.model===t.name&&i.version===t.version),n=`${t.name}:${t.version}`;this.metrics.modelMetrics.set(n,{predictions:s.length,avgLatency:t.avgLatency||0,errorRate:t.failedPredictions&&t.totalPredictions?t.failedPredictions/t.totalPredictions:0,requestsPerSecond:t.requests?t.requests/60:0})}}updateModelMetrics(){this.metrics.totalModels=this.models.size,this.metrics.servingModels=Array.from(this.models.values()).filter(e=>e.status==="serving").length,this.metrics.loadingModels=Array.from(this.models.values()).filter(e=>e.status==="loading").length,this.metrics.unavailableModels=Array.from(this.models.values()).filter(e=>e.status==="unavailable"||e.status==="error").length}calculatePercentile(e,t){if(e.length===0)return 0;const s=Math.ceil(t/100*e.length)-1;return e[Math.max(0,Math.min(s,e.length-1))]}async processPrediction(e,t,s){const n=Date.now(),i=`${e}:${t}`,a=this.models.get(i);if(!a){const o=Date.now()-n;return this.metrics.requestsTotal++,this.metrics.requestsErrors++,{success:!1,error:`Model ${e}:${t} not found`,latency:o}}if(a.status!=="serving"){const o=Date.now()-n;return this.metrics.requestsTotal++,this.metrics.requestsErrors++,{success:!1,error:`Model ${e}:${t} is not serving (status: ${a.status})`,latency:o}}if(this.requestTimestamps.push(n),this.requestTimestamps.length>this.MAX_REQUEST_TIMESTAMPS&&(this.requestTimestamps=this.requestTimestamps.slice(-this.MAX_REQUEST_TIMESTAMPS)),this.config?.enableBatching)return new Promise((o,l)=>{const d=this.batchQueues.get(i);if(!d){const p=Date.now()-n;this.metrics.requestsTotal++,this.metrics.requestsErrors++,o({success:!1,error:"Batch queue not found",latency:p});return}const h=`pred-${Date.now()}-${Math.random()}`;d.items.push({predictionId:h,input:s,timestamp:n,resolve:p=>{const g=Date.now()-n;this.metrics.requestsTotal++,o({success:!0,output:p,latency:g})},reject:p=>{const g=Date.now()-n;this.metrics.requestsTotal++,this.metrics.requestsErrors++,o({success:!1,error:p.message,latency:g})}})});{const o=this.calculateBaseLatency(a),l=this.generateMockOutput(a),d={id:`pred-${Date.now()}`,model:e,version:t,input:JSON.stringify(s),output:JSON.stringify(l),status:"success",timestamp:n,latency:Math.floor(o)};if(this.predictions.set(d.id,d),a.requests=(a.requests||0)+1,a.totalPredictions=(a.totalPredictions||0)+1,a.successfulPredictions=(a.successfulPredictions||0)+1,a.avgLatency=this.updateAverageLatency(a.avgLatency||0,d.latency,a.totalPredictions),a.lastUsed=n,this.predictions.size>this.MAX_PREDICTION_HISTORY){const h=this.predictions.keys().next().value;this.predictions.delete(h)}return this.metrics.requestsTotal++,{success:!0,output:l,latency:d.latency}}}getMetrics(){return{...this.metrics}}getModels(){return Array.from(this.models.values())}getRecentPredictions(e=100){return Array.from(this.predictions.values()).sort((t,s)=>s.timestamp-t.timestamp).slice(0,e)}syncModelsFromConfig(){this.config&&(this.initializeModels(),this.initializeBatchQueues())}getMetricsHistory(e){return e?this.metricsHistory.slice(-e):[...this.metricsHistory]}}class Jk{config=null;features=new Map;featureSets=new Map;requests=new Map;MAX_REQUEST_HISTORY=1e4;cache=new Map;onlineStore=new Map;offlineStore=new Map;metrics={totalFeatures:0,activeFeatures:0,deprecatedFeatures:0,totalFeatureSets:0,requestsTotal:0,requestsOnline:0,requestsOffline:0,requestsSuccess:0,requestsErrors:0,requestsTimeout:0,averageLatency:0,p50Latency:0,p99Latency:0,requestsPerSecond:0,throughput:0,errorRate:0,cacheHits:0,cacheMisses:0,cacheHitRate:0,onlineStoreUtilization:0,offlineStoreUtilization:0,validationPassed:0,validationFailed:0,driftDetections:0,missingValueDetections:0,outlierDetections:0,totalFeatureUsage:0,topFeatures:[],activeAlerts:0};latencyHistory=[];MAX_LATENCY_HISTORY=1e3;requestTimestamps=[];MAX_REQUEST_TIMESTAMPS=1e3;lastSecondStart=Date.now();requestsThisSecond=0;lastUpdateTime=Date.now();pendingRequests=[];metricsHistory=[];MAX_METRICS_HISTORY=300;featureValueHistory=new Map;MAX_FEATURE_VALUE_HISTORY=1e3;alerts=[];MAX_ALERTS=1e3;initializeConfig(e){const t=e.data.config||{};this.config={enabled:t.enabled!==!1,featureStoreType:t.featureStoreType||"feast",enableOnlineServing:t.enableOnlineServing!==!1,onlineStoreType:t.onlineStoreType||"redis",onlineStoreUrl:t.onlineStoreUrl||"redis://localhost:6379",enableOfflineServing:t.enableOfflineServing!==!1,offlineStoreType:t.offlineStoreType||"snowflake",offlineStoreUrl:t.offlineStoreUrl||"",enableFeatureValidation:t.enableFeatureValidation!==!1,enableFeatureMonitoring:t.enableFeatureMonitoring!==!1,enableTransformations:t.enableTransformations!==!1,ttlDays:t.ttlDays||30,enableCaching:t.enableCaching!==!1,cacheSize:t.cacheSize||100,cacheTtl:t.cacheTtl||3600,maxConcurrentRequests:t.maxConcurrentRequests||100,requestTimeout:t.requestTimeout||3e4,enableDriftDetection:t.enableDriftDetection||!1,driftThreshold:t.driftThreshold||.1,...t},this.initializeFeatures(),this.initializeFeatureSets()}initializeFeatures(){if(this.config&&(this.features.clear(),this.config.features&&Array.isArray(this.config.features))){const e=Date.now();for(const t of this.config.features){const s=`${t.name}:${t.version}`,n={name:t.name,version:t.version,type:t.type||"numerical",description:t.description,dataType:t.dataType||"float64",defaultValue:t.defaultValue,tags:t.tags||[],status:"active",createdAt:e,updatedAt:e,usageCount:0,transformations:t.transformations||[]};this.features.set(s,n)}}}initializeFeatureSets(){if(this.config&&(this.featureSets.clear(),this.config.featureSets&&Array.isArray(this.config.featureSets))){const e=Date.now();for(const t of this.config.featureSets){const s=`${t.name}:${t.version}`,n={name:t.name,version:t.version,features:t.features||[],description:t.description,createdAt:e,updatedAt:e,usageCount:0};this.featureSets.set(s,n)}}}processFeatureRequest(e,t,s="online",n){if(!this.config||!this.config.enabled)return{success:!1,latency:0,error:"Feature Store is not enabled"};const i=Date.now(),a=`req-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;if(s==="online"&&!this.config.enableOnlineServing)return{success:!1,latency:Date.now()-i,error:"Online serving is not enabled"};if(s==="offline"&&!this.config.enableOfflineServing)return{success:!1,latency:Date.now()-i,error:"Offline serving is not enabled"};let o=!1;if(s==="online"&&this.config.enableCaching){const M=this.getCacheKey(e,t),x=this.cache.get(M);if(x&&Date.now()-x.timestamp<x.ttl*1e3){o=!0,this.metrics.cacheHits++;const S=this.getOnlineLatency(!0);return this.updateRequestMetrics(a,s,!0,S,!0),{success:!0,data:x.data,latency:S,cacheHit:!0}}else this.metrics.cacheMisses++}const l=[];for(const M of e)Array.from(this.features.values()).find(S=>S.name===M&&S.status==="active")||l.push(M);if(l.length>0){const M=this.getOnlineLatency(!1);return this.updateRequestMetrics(a,s,!1,M),{success:!1,latency:M,error:`Features not found: ${l.join(", ")}`}}const d=s==="online"?this.getOnlineLatency(!1):this.getOfflineLatency(),h=s==="online"?this.config?.onlineStoreType||"redis":this.config?.offlineStoreType||"snowflake";let p=.001;if(s==="online")switch(h){case"redis":p=5e-4;break;case"dynamodb":p=.001;break;case"cassandra":p=.002;break}else switch(h){case"snowflake":p=.001;break;case"bigquery":p=8e-4;break;case"redshift":p=.002;break}if(Math.random()<p+this.metrics.errorRate*.1){const M=s==="online"?this.getOnlineLatency(!1):this.getOfflineLatency();return this.updateRequestMetrics(a,s,!1,M),{success:!1,latency:M,error:"Feature retrieval failed"}}const v={},b=n||Date.now();if(t&&t.length>1)for(const M of t){const x={};for(const S of e){const T=Array.from(this.features.values()).find(k=>k.name===S);if(!T)continue;let E=null,A=!1;if(s==="online"){const k=this.onlineStore.get(M);if(k){const D=k.get(S);D&&(E=D.value,A=!0)}}else{const k=this.offlineStore.get(S);if(k){const D=k.get(M);if(D&&D.length>0){let L=null;for(let I=D.length-1;I>=0;I--)if(D[I].timestamp<=b){L=D[I].value;break}L!==null&&(E=L,A=!0)}}}A?this.config.enableTransformations&&T.transformations&&T.transformations.length>0&&(E=this.applyTransformations(E,T)):E=this.generateFeatureValue(T),x[S]=E,this.config.enableFeatureMonitoring&&this.monitorFeatureValue(S,E,T)}v[M]=x;for(const S of e){const T=Array.from(this.features.values()).find(E=>E.name===S);T&&(T.usageCount++,T.lastUsed=Date.now())}}else for(const M of e){const x=Array.from(this.features.values()).find(E=>E.name===M);if(!x)continue;let S=null,T=!1;if(s==="online")if(t&&t.length>0)for(const E of t){const A=this.onlineStore.get(E);if(A){const k=A.get(M);if(k){S=k.value,T=!0;break}}}else{const E=this.onlineStore.get("__default__");if(E){const A=E.get(M);A&&(S=A.value,T=!0)}}else if(t&&t.length>0)for(const E of t){const A=this.offlineStore.get(M);if(A){const k=A.get(E);if(k&&k.length>0){let D=null;for(let L=k.length-1;L>=0;L--)if(k[L].timestamp<=b){D=k[L].value;break}if(D!==null){S=D,T=!0;break}}}}else{const E=this.offlineStore.get(M);if(E){const A=E.get("__default__");if(A&&A.length>0){let k=null;for(let D=A.length-1;D>=0;D--)if(A[D].timestamp<=b){k=A[D].value;break}k!==null&&(S=k,T=!0)}}}T?this.config.enableTransformations&&x.transformations&&x.transformations.length>0&&(S=this.applyTransformations(S,x)):S=this.generateFeatureValue(x),v[M]=S,x.usageCount++,x.lastUsed=Date.now(),this.config.enableFeatureMonitoring&&this.monitorFeatureValue(M,S,x)}if(this.config.enableFeatureValidation){const M=this.validateFeatures(e,v);if(!M.valid){const x=s==="online"?this.getOnlineLatency(!1):this.getOfflineLatency();return this.updateRequestMetrics(a,s,!1,x),{success:!1,latency:x,error:`Validation failed: ${M.error}`}}}if(s==="online"&&this.config.enableCaching&&!o){const M=this.getCacheKey(e,t);if(this.cache.set(M,{data:v,timestamp:Date.now(),ttl:this.config.cacheTtl||3600}),this.cache.size>(this.config.cacheSize||100)*1024){const x=this.cache.keys().next().value;this.cache.delete(x)}}return this.updateRequestMetrics(a,s,!0,d,o),{success:!0,data:v,latency:d,cacheHit:!1}}getOnlineLatency(e){if(e)return 1+Math.random()*4;switch(this.config?.onlineStoreType||"redis"){case"redis":return 5+Math.random()*10;case"dynamodb":return 10+Math.random()*20;case"cassandra":return 15+Math.random()*25;default:return 10+Math.random()*20}}getOfflineLatency(){switch(this.config?.offlineStoreType||"snowflake"){case"snowflake":return 500+Math.random()*1e3;case"bigquery":return 400+Math.random()*800;case"redshift":return 600+Math.random()*1200;default:return 500+Math.random()*1e3}}getCacheKey(e,t){const s=[...e].sort().join(","),n=t?[...t].sort().join(","):"";return`features:${s}:${n}`}generateFeatureValue(e){let t;switch(e.type){case"numerical":e.dataType==="int"||e.dataType==="int64"?t=Math.floor(Math.random()*1e3):t=Math.random()*100;break;case"categorical":const s=["A","B","C","D","E"];t=s[Math.floor(Math.random()*s.length)];break;case"embedding":t=Array.from({length:128},()=>Math.random());break;case"timestamp":t=Date.now();break;default:t=e.defaultValue||null}return this.config?.enableTransformations&&e.transformations&&e.transformations.length>0&&(t=this.applyTransformations(t,e)),t}applyTransformations(e,t){if(!t.transformations||t.transformations.length===0)return e;let s=e;for(const n of t.transformations)s=this.applyTransformation(s,n,t);return s}applyTransformation(e,t,s){if(e==null)return e;switch(t.type){case"normalization":case"standardization":return typeof e=="number"&&t.mean!==void 0&&t.std!==void 0?(t.type==="standardization",(e-t.mean)/t.std):e;case"min-max":if(typeof e=="number"&&t.min!==void 0&&t.max!==void 0){const n=t.max-t.min;if(n>0)return(e-t.min)/n}return e;case"one-hot":if(s.type==="categorical"&&t.categories){const n=t.categories.indexOf(String(e));if(n>=0)return t.categories.map((i,a)=>a===n?1:0)}return e;case"label-encoding":if(s.type==="categorical"&&t.categories){const n=t.categories.indexOf(String(e));return n>=0?n:-1}return e;case"aggregation":return e;case"custom":return e;default:return e}}validateFeatures(e,t){for(const s of e){const n=Array.from(this.features.values()).find(o=>o.name===s);if(!n)continue;const i=t[s],a=n.validationRules;if(a){if(a.required&&i==null)return{valid:!1,error:`Feature ${s} is required but missing`};if(n.type==="numerical"&&typeof i=="number"){if(a.min!==void 0&&i<a.min)return{valid:!1,error:`Feature ${s} value ${i} is below minimum ${a.min}`};if(a.max!==void 0&&i>a.max)return{valid:!1,error:`Feature ${s} value ${i} is above maximum ${a.max}`}}if(a.allowedValues&&!a.allowedValues.includes(i))return{valid:!1,error:`Feature ${s} value ${i} is not in allowed values`}}}return{valid:!0}}updateRequestMetrics(e,t,s,n,i){this.metrics.requestsTotal++,t==="online"?this.metrics.requestsOnline++:this.metrics.requestsOffline++,s?this.metrics.requestsSuccess++:this.metrics.requestsErrors++,this.latencyHistory.push(n),this.latencyHistory.length>this.MAX_LATENCY_HISTORY&&this.latencyHistory.shift();const a=Date.now();this.requestTimestamps.push(a),this.requestTimestamps.length>this.MAX_REQUEST_TIMESTAMPS&&this.requestTimestamps.shift();const o={id:e,featureNames:[],requestType:t,timestamp:a,latency:n,status:s?"success":"error",cacheHit:i};if(this.requests.set(e,o),this.requests.size>this.MAX_REQUEST_HISTORY){const l=this.requests.keys().next().value;this.requests.delete(l)}this.config?.enableFeatureValidation&&(s?this.metrics.validationPassed++:this.metrics.validationFailed++)}updateMetrics(){const e=Date.now();(e-this.lastUpdateTime)/1e3;const t=Array.from(this.features.values());if(this.metrics.totalFeatures=t.length,this.metrics.activeFeatures=t.filter(p=>p.status==="active").length,this.metrics.deprecatedFeatures=t.filter(p=>p.status==="deprecated").length,this.metrics.totalFeatureSets=this.featureSets.size,this.latencyHistory.length>0){const p=[...this.latencyHistory].sort((g,v)=>g-v);this.metrics.averageLatency=p.reduce((g,v)=>g+v,0)/p.length,this.metrics.p50Latency=this.calculatePercentile(p,50),this.metrics.p99Latency=this.calculatePercentile(p,99)}const s=Math.floor(e/1e3),n=Math.floor(this.lastSecondStart/1e3);if(s>n){const p=this.requestTimestamps.filter(g=>g>=this.lastSecondStart&&g<s*1e3).length;this.metrics.requestsPerSecond=p,this.metrics.throughput=p,this.lastSecondStart=s*1e3}this.metrics.requestsTotal>0&&(this.metrics.errorRate=this.metrics.requestsErrors/this.metrics.requestsTotal);const i=this.metrics.cacheHits+this.metrics.cacheMisses;i>0&&(this.metrics.cacheHitRate=this.metrics.cacheHits/i);const a=this.config?.onlineStoreType||"redis",o=this.config?.offlineStoreType||"snowflake";let l=100;switch(a){case"redis":l=1e3;break;case"dynamodb":l=500;break;case"cassandra":l=300;break}let d=10;switch(o){case"snowflake":d=20;break;case"bigquery":d=15;break;case"redshift":d=10;break}this.metrics.onlineStoreUtilization=Math.min(1,this.metrics.requestsOnline/(this.config?.maxConcurrentRequests||l)),this.metrics.offlineStoreUtilization=Math.min(1,this.metrics.requestsOffline/d);const h=new Map;for(const p of t)h.set(p.name,(h.get(p.name)||0)+p.usageCount);this.metrics.topFeatures=Array.from(h.entries()).map(([p,g])=>({name:p,usage:g})).sort((p,g)=>g.usage-p.usage).slice(0,10),this.metrics.totalFeatureUsage=t.reduce((p,g)=>p+g.usageCount,0),this.metrics.activeAlerts=this.alerts.filter(p=>!p.resolved).length,this.metricsHistory.push({timestamp:e,latency:this.metrics.averageLatency,rps:this.metrics.requestsPerSecond,errorRate:this.metrics.errorRate,throughput:this.metrics.throughput,cacheHitRate:this.metrics.cacheHitRate}),this.metricsHistory.length>this.MAX_METRICS_HISTORY&&this.metricsHistory.shift(),this.lastUpdateTime=e}calculatePercentile(e,t){if(e.length===0)return 0;const s=t/100*(e.length-1),n=Math.floor(s),i=Math.ceil(s),a=s-n;return n===i?e[n]:e[n]*(1-a)+e[i]*a}getMetrics(){return{...this.metrics}}getFeatures(){return Array.from(this.features.values())}getFeatureSets(){return Array.from(this.featureSets.values())}getFeature(e,t){return this.features.get(`${e}:${t}`)}addFeature(e){const t=`${e.name}:${e.version}`,s=this.features.get(t),n=Date.now(),i={...e,createdAt:s?.createdAt||n,updatedAt:n,usageCount:s?.usageCount||0,lastUsed:s?.lastUsed};this.features.set(t,i)}removeFeature(e,t){this.features.delete(`${e}:${t}`)}addFeatureSet(e){const t=`${e.name}:${e.version}`,s=this.featureSets.get(t),n=Date.now(),i={...e,createdAt:s?.createdAt||n,updatedAt:n,usageCount:s?.usageCount||0,lastUsed:s?.lastUsed};this.featureSets.set(t,i)}removeFeatureSet(e,t){this.featureSets.delete(`${e}:${t}`)}getMetricsHistory(){return[...this.metricsHistory]}getRecentRequests(e=100){return Array.from(this.requests.values()).sort((t,s)=>s.timestamp-t.timestamp).slice(0,e)}monitorFeatureValue(e,t,s){if(!this.config?.enableFeatureMonitoring)return;const n=Date.now(),i=`${e}:${s.version}`;this.featureValueHistory.has(i)||this.featureValueHistory.set(i,[]);const a=this.featureValueHistory.get(i);if(a.push({value:t,timestamp:n}),a.length>this.MAX_FEATURE_VALUE_HISTORY&&a.shift(),t==null){this.metrics.missingValueDetections++,this.createAlert("missing","warning",e,`Feature ${e} has missing value`);return}if(s.type==="numerical"&&typeof t=="number"&&s.statistics){const o=s.statistics;if(o.mean!==void 0&&o.std!==void 0){const l=Math.abs((t-o.mean)/o.std);l>3&&(this.metrics.outlierDetections++,this.createAlert("outlier","warning",e,`Feature ${e} has outlier value: ${t} (z-score: ${l.toFixed(2)})`))}}this.config.enableDriftDetection&&a.length>=100&&this.detectDrift(e,t,s,a)&&(this.metrics.driftDetections++,this.createAlert("drift","critical",e,`Feature ${e} shows data drift`))}detectDrift(e,t,s,n){if(!s.statistics||n.length<100)return!1;const i=s.statistics,a=this.config?.driftThreshold||.1;if(s.type==="numerical"&&typeof t=="number"&&i.mean!==void 0&&i.std!==void 0){const o=n.slice(-50).map(g=>g.value).filter(g=>typeof g=="number");if(o.length<10)return!1;const l=o.reduce((g,v)=>g+v,0)/o.length,d=Math.sqrt(o.reduce((g,v)=>g+Math.pow(v-l,2),0)/o.length),h=Math.abs(l-i.mean)/(i.std||1),p=Math.abs(d-(i.std||0))/(i.std||1);return h>a||p>a}else if(s.type==="categorical"){const o=n.slice(-50).map(p=>String(p.value)),l=i.distinctCount||5,d=new Set(o).size;return Math.abs(d-l)/l>a}return!1}createAlert(e,t,s,n){const i={id:`alert-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:e,severity:t,featureName:s,message:n,timestamp:Date.now(),resolved:!1};this.alerts.push(i),this.alerts.length>this.MAX_ALERTS&&this.alerts.shift(),this.metrics.activeAlerts=this.alerts.filter(a=>!a.resolved).length}getAlerts(e=100){return this.alerts.filter(t=>!t.resolved).sort((t,s)=>{const n={critical:0,warning:1,info:2};return n[t.severity]-n[s.severity]}).slice(0,e)}writeFeatures(e,t,s="online",n){if(!this.config||!this.config.enabled)return{success:!1,written:0,latency:0,error:"Feature Store is not enabled"};const i=Date.now(),a=n||Date.now();let o=0;const l=Object.keys(e),d=[];for(const p of l)Array.from(this.features.values()).find(v=>v.name===p&&v.status==="active")||d.push(p);if(d.length>0)return{success:!1,written:0,latency:Date.now()-i,error:`Features not found: ${d.join(", ")}`};if(this.config.enableFeatureValidation){const p=this.validateFeatures(l,e);if(!p.valid)return{success:!1,written:0,latency:Date.now()-i,error:`Validation failed: ${p.error}`}}if(s==="online"){if(!this.config.enableOnlineServing)return{success:!1,written:0,latency:Date.now()-i,error:"Online serving is not enabled"};if(t&&t.length>0)for(const p of t){this.onlineStore.has(p)||this.onlineStore.set(p,new Map);const g=this.onlineStore.get(p);for(const[v,b]of Object.entries(e))g.set(v,{value:b,timestamp:a}),o++}else{const p="__default__";this.onlineStore.has(p)||this.onlineStore.set(p,new Map);const g=this.onlineStore.get(p);for(const[v,b]of Object.entries(e))g.set(v,{value:b,timestamp:a}),o++}if(this.config.enableCaching)for(const p of this.cache.keys())l.some(g=>p.includes(g))&&this.cache.delete(p)}else{if(!this.config.enableOfflineServing)return{success:!1,written:0,latency:Date.now()-i,error:"Offline serving is not enabled"};if(t&&t.length>0)for(const p of t)for(const[g,v]of Object.entries(e)){this.offlineStore.has(g)||this.offlineStore.set(g,new Map);const b=this.offlineStore.get(g);b.has(p)||b.set(p,[]);const M=b.get(p);M.push({value:v,timestamp:a}),M.length>1e3&&M.shift(),M.sort((x,S)=>x.timestamp-S.timestamp),o++}else{const p="__default__";for(const[g,v]of Object.entries(e)){this.offlineStore.has(g)||this.offlineStore.set(g,new Map);const b=this.offlineStore.get(g);b.has(p)||b.set(p,[]);const M=b.get(p);M.push({value:v,timestamp:a}),M.length>1e3&&M.shift(),M.sort((x,S)=>x.timestamp-S.timestamp),o++}}}const h=s==="online"?this.getOnlineLatency(!1):this.getOfflineLatency();return this.metrics.requestsTotal++,s==="online"?this.metrics.requestsOnline++:this.metrics.requestsOffline++,this.metrics.requestsSuccess++,{success:!0,written:o,latency:h}}performUpdate(e,t=!1){!this.config||!this.config.enabled||(this.processPendingRequests(e),t&&this.pendingRequests.length===0&&this.simulateRequests(e),this.updateMetrics(),this.cleanupCache())}processPendingRequests(e){for(;this.pendingRequests.length>0;){const t=this.pendingRequests.shift();if(!t)break;try{const s=this.processFeatureRequest(t.featureNames,t.entityIds,t.requestType);s.success?t.resolve(s.data):t.reject(new Error(s.error||"Feature request failed"))}catch(s){t.reject(s instanceof Error?s:new Error("Unknown error"))}}}simulateRequests(e){const t=this.getFeatures();if(t.length===0)return;const s=1+Math.floor(Math.random()*4);for(let n=0;n<s;n++){const i=1+Math.floor(Math.random()*3),a=t.filter(l=>l.status==="active").sort(()=>Math.random()-.5).slice(0,i).map(l=>l.name);if(a.length===0)continue;const o=Math.random()<.8?"online":"offline";this.processFeatureRequest(a,void 0,o)}}cleanupCache(){const e=Date.now();for(const[t,s]of this.cache.entries())e-s.timestamp>s.ttl*1e3&&this.cache.delete(t)}materializeFeatures(e,t,s){if(!this.config||!this.config.enabled)return{success:!1,materialized:0,latency:0,error:"Feature Store is not enabled"};if(!this.config.enableOnlineServing||!this.config.enableOfflineServing)return{success:!1,materialized:0,latency:0,error:"Both online and offline serving must be enabled for materialization"};const n=s||36e5,i=Date.now()-n;let a=0;const o=t||["__default__"];for(const d of o)for(const h of e){if(!Array.from(this.features.values()).find(x=>x.name===h))continue;const g=this.offlineStore.get(h);if(!g)continue;const v=g.get(d);if(!v||v.length===0)continue;let b=null,M=0;for(let x=v.length-1;x>=0;x--){const S=v[x];S.timestamp>=i&&S.timestamp>M&&(b=S.value,M=S.timestamp)}if(b!==null){this.onlineStore.has(d)||this.onlineStore.set(d,new Map);const x=this.onlineStore.get(d),S=x.get(h);if((!S||S.timestamp<M)&&(x.set(h,{value:b,timestamp:M}),a++,this.config.enableCaching))for(const T of this.cache.keys())T.includes(h)&&this.cache.delete(T)}}const l=this.getOnlineLatency(!1)*a;return{success:!0,materialized:a,latency:l}}}class Tb{services=new Map;virtualServices=new Map;destinationRules=new Map;gateways=new Map;peerAuthentications=new Map;authorizationPolicies=new Map;serviceEntries=new Map;sidecars=new Map;globalConfig={};roundRobinCounters=new Map;leastConnCounts=new Map;consistentHashRing=new Map;connectionPoolCounts=new Map;circuitBreakerState=new Map;outlierDetectionState=new Map;mtlsConnections=new Map;requestCount=0;responseCount=0;errorCount=0;totalBytesIn=0;totalBytesOut=0;activeConnections=0;totalLatency=0;circuitBreakerTrips=0;retryAttempts=0;timeoutErrors=0;rateLimitBlocks=0;serviceEndpoints=new Map;initialize(e){if(this.services.clear(),this.virtualServices.clear(),this.destinationRules.clear(),this.gateways.clear(),this.peerAuthentications.clear(),this.authorizationPolicies.clear(),this.serviceEntries.clear(),this.sidecars.clear(),this.roundRobinCounters.clear(),this.leastConnCounts.clear(),this.consistentHashRing.clear(),this.circuitBreakerState.clear(),this.outlierDetectionState.clear(),this.mtlsConnections.clear(),this.serviceEndpoints.clear(),this.connectionPoolCounts.clear(),this.globalConfig=e.globalConfig||{},e.services)for(const t of e.services){const s=this.normalizeHost(t.host);if(this.services.set(s,t),t.ports&&t.ports.length>0){const n=t.ports[0].number,i=`${s}:default`;this.serviceEndpoints.set(i,[{address:t.host,port:n,weight:100,healthy:!0,labels:t.labels}])}}if(e.virtualServices)for(const t of e.virtualServices)this.virtualServices.set(t.name,t);if(e.destinationRules){for(const t of e.destinationRules)if(this.destinationRules.set(t.name,t),t.subsets)for(const s of t.subsets){const n=`${t.host}:${s.name}`;this.roundRobinCounters.set(n,0),this.leastConnCounts.set(n,new Map);const i=this.services.get(this.normalizeHost(t.host));if(i&&i.ports&&i.ports.length>0){const a=i.ports[0].number;this.serviceEndpoints.set(n,[{address:i.host,port:a,weight:100,healthy:!0,labels:s.labels}])}}}if(e.gateways)for(const t of e.gateways)this.gateways.set(t.name,t);if(e.peerAuthentications)for(const t of e.peerAuthentications)this.peerAuthentications.set(t.name,t);if(e.authorizationPolicies)for(const t of e.authorizationPolicies)this.authorizationPolicies.set(t.name,t);if(e.serviceEntries){for(const t of e.serviceEntries)if(this.serviceEntries.set(t.name,t),t.endpoints)for(const s of t.hosts){const n=this.normalizeHost(s);if(t.ports&&t.ports.length>0){const i=t.ports[0].number,a=`${n}:default`;this.serviceEndpoints.set(a,t.endpoints.map(o=>({address:o.address,port:o.ports?Object.values(o.ports)[0]:i,weight:o.weight||100,healthy:!0,labels:o.labels})))}}}if(e.sidecars)for(const t of e.sidecars)this.sidecars.set(t.name,t);this.requestCount=0,this.responseCount=0,this.errorCount=0,this.totalBytesIn=0,this.totalBytesOut=0,this.activeConnections=0,this.totalLatency=0,this.circuitBreakerTrips=0,this.retryAttempts=0,this.timeoutErrors=0,this.rateLimitBlocks=0}routeRequest(e,t){const s=Date.now();this.requestCount++,this.activeConnections++;try{if(!this.checkMTLS(e).allowed)return this.activeConnections--,this.errorCount++,{virtualService:null,destinationRule:null,response:{status:403,error:"mTLS authentication failed",latency:Date.now()-s}};const i=this.checkAuthorization(e);if(!i.allowed)return this.activeConnections--,this.errorCount++,{virtualService:null,destinationRule:null,response:{status:403,error:i.reason||"Authorization denied",latency:Date.now()-s}};const a=this.findMatchingVirtualService(e,t);if(!a){const g=this.findServiceByHost(e.host||"");if(!g)return this.activeConnections--,this.errorCount++,{virtualService:null,destinationRule:null,response:{status:404,error:`Service not found: ${e.host}`,latency:Date.now()-s}};const v=this.routeToService(g.host,void 0,e,s);return this.activeConnections--,v}const o=this.matchHTTPRoute(a,e);if(!o)return this.activeConnections--,this.errorCount++,{virtualService:a,destinationRule:null,response:{status:404,error:"No matching route in VirtualService",latency:Date.now()-s}};const l=this.applyFaultInjection(o.fault,e);if(l.abort)return this.activeConnections--,this.errorCount++,{virtualService:a,destinationRule:null,response:{status:l.abort.httpStatus||500,error:"Fault injection: abort",latency:Date.now()-s}};if(l.delay){const g=this.parseDuration(l.delay.fixedDelay||"0s")}let d=null;if(o.route&&o.route.length>0)d=this.selectDestination(o.route,e);else if(o.redirect)return this.activeConnections--,this.responseCount++,{virtualService:a,destinationRule:null,response:{status:o.redirect.redirectCode||301,headers:{Location:o.redirect.uri||o.redirect.authority||""},latency:Date.now()-s}};if(!d)return this.activeConnections--,this.errorCount++,{virtualService:a,destinationRule:null,response:{status:500,error:"No destination configured",latency:Date.now()-s}};const h=this.findDestinationRule(d.host),p=this.routeToService(d.host,d.subset,d.port,e,s,o.retries,o.timeout,h);return p.virtualService=a,p.destinationRule=h,this.activeConnections--,p}catch(n){return this.activeConnections--,this.errorCount++,{virtualService:null,destinationRule:null,response:{status:500,error:n.message||"Internal error",latency:Date.now()-s}}}}checkMTLS(e){const t=this.globalConfig.mtlsMode||(this.globalConfig.enableMTLS?"PERMISSIVE":"DISABLE");if(t==="DISABLE")return{allowed:!0};for(const s of this.peerAuthentications.values())if(s.mtls){if(s.mtls.mode==="STRICT"&&!e.sourcePrincipal)return{allowed:!1,reason:"mTLS required but not provided"};if(s.mtls.mode==="DISABLE")return{allowed:!0}}return t==="STRICT"&&!e.sourcePrincipal?{allowed:!1,reason:"mTLS required in STRICT mode"}:{allowed:!0}}checkAuthorization(e){const t=[];for(const s of this.authorizationPolicies.values())this.matchesAuthorizationPolicy(s,e)&&t.push(s);if(t.length===0)return{allowed:!0};for(const s of t){const n=s.action||"ALLOW";if(n==="DENY")return{allowed:!1,reason:`Denied by policy: ${s.name}`};if(n==="ALLOW"){if(s.rules&&s.rules.length>0){let i=!1;for(const a of s.rules)if(this.matchesAuthorizationRule(a,e)){i=!0;break}if(!i)return{allowed:!1,reason:`No matching rule in policy: ${s.name}`}}return{allowed:!0}}}return{allowed:!0}}matchesAuthorizationPolicy(e,t){return!e.selector||!e.selector.matchLabels,!0}matchesAuthorizationRule(e,t){if(e.from&&e.from.length>0){let s=!1;for(const n of e.from)if(n.source)if(n.source.principals&&t.sourcePrincipal){if(n.source.principals.includes(t.sourcePrincipal)||n.source.principals.includes("*")){s=!0;break}}else s=!0;else s=!0;if(!s)return!1}if(e.to&&e.to.length>0){let s=!1;for(const n of e.to)if(n.operation){if(n.operation.methods&&!n.operation.methods.includes(t.method)||n.operation.paths&&!n.operation.paths.some(i=>t.path.startsWith(i))||n.operation.hosts&&t.host&&!n.operation.hosts.includes(t.host))continue;s=!0;break}else s=!0;if(!s)return!1}return!0}findMatchingVirtualService(e,t){const s=e.host||e.authority||"";for(const n of this.virtualServices.values())if(n.hosts.some(a=>{if(a==="*"||a===s)return!0;if(a.startsWith("*.")){const o=a.substring(2);return s.endsWith("."+o)||s===o}return!1})&&!(t&&n.gateways&&n.gateways.length>0&&!n.gateways.includes(t)))return n;return null}matchHTTPRoute(e,t){if(!e.http||e.http.length===0)return null;for(const s of e.http){if(!s.match||s.match.length===0)return{route:s.route,redirect:s.redirect,rewrite:s.rewrite,timeout:s.timeout,retries:s.retries,fault:s.fault};for(const n of s.match){let i=!0;if(n.uri){if(n.uri.exact&&t.path!==n.uri.exact){i=!1;continue}if(n.uri.prefix&&!t.path.startsWith(n.uri.prefix)){i=!1;continue}if(n.uri.regex&&!new RegExp(n.uri.regex).test(t.path)){i=!1;continue}}if(n.method){if(n.method.exact&&t.method!==n.method.exact){i=!1;continue}if(n.method.regex&&!new RegExp(n.method.regex).test(t.method)){i=!1;continue}}if(n.headers)for(const[a,o]of Object.entries(n.headers)){const l=t.headers?.[a.toLowerCase()];if(!l){i=!1;break}if(o.exact&&l!==o.exact){i=!1;break}if(o.prefix&&!l.startsWith(o.prefix)){i=!1;break}if(o.regex&&!new RegExp(o.regex).test(l)){i=!1;break}}if(i)return{route:s.route,redirect:s.redirect,rewrite:s.rewrite,timeout:s.timeout,retries:s.retries,fault:s.fault}}}return null}applyFaultInjection(e,t){if(!e)return{};const s={};if(e.delay){const n=e.delay.percentage?.value||0;Math.random()*100<n&&(s.delay=e.delay)}if(e.abort){const n=e.abort.percentage?.value||0;Math.random()*100<n&&(s.abort=e.abort)}return s}selectDestination(e,t){if(e.length===0)return null;if(e.length===1)return e[0].destination;const s=e.reduce((a,o)=>a+(o.weight||100),0),n=Math.random()*s;let i=0;for(const a of e)if(i+=a.weight||100,n<=i)return a.destination;return e[0].destination}findDestinationRule(e){const t=this.normalizeHost(e);for(const s of this.destinationRules.values())if(this.normalizeHost(s.host)===t)return s;return null}routeToService(e,t,s,n,i,a,o,l){const d=`${e}:${t||"default"}`,h=this.circuitBreakerState.get(d);if(h?.isOpen&&(!h.openUntil||Date.now()<h.openUntil))return this.circuitBreakerTrips++,this.errorCount++,{virtualService:null,destinationRule:l||null,response:{status:503,error:"Circuit breaker is open",latency:Date.now()-i,circuitBreakerOpen:!0},serviceTarget:e,subsetTarget:t};const p=this.serviceEndpoints.get(d)||[];if(p.length===0)return this.errorCount++,{virtualService:null,destinationRule:l||null,response:{status:503,error:"No endpoints available",latency:Date.now()-i},serviceTarget:e,subsetTarget:t};const g=this.getTrafficPolicy(e,t,l),v=g?.connectionPool?.tcp?.maxConnections;if(v){const E=this.connectionPoolCounts.get(d)||0;if(E>=v)return this.errorCount++,{virtualService:null,destinationRule:l||null,response:{status:503,error:"Connection pool exhausted",latency:Date.now()-i},serviceTarget:e,subsetTarget:t};this.connectionPoolCounts.set(d,E+1)}const b=this.selectEndpoint(p,d,n,g),M=g?.connectionPool?.tcp?.connectTimeout,x=o?this.parseDuration(o):M?this.parseDuration(M):this.globalConfig.defaultTimeout?this.parseDuration(this.globalConfig.defaultTimeout):3e4,S=a?.attempts||this.globalConfig.defaultRetryAttempts||0;let T=null;for(let E=0;E<=S;E++){E>0&&this.retryAttempts++;const A=this.simulateEndpointRequest(b,n,x);if(A.status>=200&&A.status<500){if(this.responseCount++,this.totalLatency+=A.latency||0,v){const k=this.connectionPoolCounts.get(d)||0;k>0&&this.connectionPoolCounts.set(d,k-1)}return h&&(h.consecutiveErrors=0,h.isOpen&&h.halfOpenRequests!==void 0&&(h.halfOpenRequests++,h.halfOpenRequests>=3&&(h.isOpen=!1,h.halfOpenRequests=void 0))),{virtualService:null,destinationRule:l||null,response:{...A,serviceTarget:e,subsetTarget:t,endpointTarget:`${b.address}:${b.port}`,retryAttempts:E}}}if(!(A.status>=500&&(T=A,(a?.retryOn||"5xx,reset,connect-failure").includes("5xx")&&A.status>=500&&E<S))){if(v){const k=this.connectionPoolCounts.get(d)||0;k>0&&this.connectionPoolCounts.set(d,k-1)}if(h){h.consecutiveErrors++;const k=l?.trafficPolicy?.outlierDetection?.consecutiveErrors||5;h.consecutiveErrors>=k&&(h.isOpen=!0,h.openUntil=Date.now()+(this.parseDuration(l?.trafficPolicy?.outlierDetection?.baseEjectionTime||"30s")||3e4),h.halfOpenRequests=0)}this.errorCount++;break}}return{virtualService:null,destinationRule:l||null,response:{...T||{status:500,error:"Request failed after retries",latency:Date.now()-i},serviceTarget:e,subsetTarget:t,endpointTarget:`${b.address}:${b.port}`,retryAttempts:S}}}getTrafficPolicy(e,t,s){if(!s)return null;if(t&&s.subsets){const n=s.subsets.find(i=>i.name===t);if(n?.trafficPolicy)return n.trafficPolicy}return s.trafficPolicy||null}selectEndpoint(e,t,s,n){const i=e.filter(o=>o.healthy!==!1);if(i.length===0)return e[0];switch(n?.loadBalancer?.simple||"ROUND_ROBIN"){case"ROUND_ROBIN":{const o=this.roundRobinCounters.get(t)||0,l=i[o%i.length];return this.roundRobinCounters.set(t,o+1),l}case"LEAST_CONN":{let o=1/0,l=i[0];const d=this.leastConnCounts.get(t)||new Map;for(const p of i){const g=`${p.address}:${p.port}`,v=d.get(g)||0;v<o&&(o=v,l=p)}const h=`${l.address}:${l.port}`;return d.set(h,(d.get(h)||0)+1),this.leastConnCounts.set(t,d),l}case"RANDOM":return i[Math.floor(Math.random()*i.length)];case"PASSTHROUGH":default:return i[0]}}simulateEndpointRequest(e,t,s){const n=10+Math.random()*90,i=Math.random()*50,a=n+i;return Math.random()<.01?{status:500,error:"Internal server error",latency:a}:a>s?(this.timeoutErrors++,{status:504,error:"Gateway timeout",latency:s}):{status:200,latency:a}}findServiceByHost(e){const t=this.normalizeHost(e);return this.services.get(t)||null}normalizeHost(e){return e.toLowerCase().trim()}parseDuration(e){const t=e.match(/^(\d+)(ms|s|m|h)$/);if(!t)return 0;const s=parseInt(t[1],10);switch(t[2]){case"ms":return s;case"s":return s*1e3;case"m":return s*60*1e3;case"h":return s*60*60*1e3;default:return 0}}getStats(){const e=this.responseCount>0?this.totalLatency/this.responseCount:0,t=this.requestCount>0?this.errorCount/this.requestCount:0;return{services:this.services.size,virtualServices:this.virtualServices.size,destinationRules:this.destinationRules.size,gateways:this.gateways.size,totalRequests:this.requestCount,totalResponses:this.responseCount,totalErrors:this.errorCount,activeConnections:this.activeConnections,totalBytesIn:this.totalBytesIn,totalBytesOut:this.totalBytesOut,errorRate:t,averageLatency:e,mtlsConnections:Array.from(this.mtlsConnections.values()).filter(s=>s).length,circuitBreakerTrips:this.circuitBreakerTrips,retryAttempts:this.retryAttempts,timeoutErrors:this.timeoutErrors,rateLimitBlocks:this.rateLimitBlocks}}resetStats(){this.requestCount=0,this.responseCount=0,this.errorCount=0,this.totalBytesIn=0,this.totalBytesOut=0,this.activeConnections=0,this.totalLatency=0,this.circuitBreakerTrips=0,this.retryAttempts=0,this.timeoutErrors=0,this.rateLimitBlocks=0}}class Zk{istioEngine;constructor(){this.istioEngine=new Tb}initialize(e){const t=(e.services||[]).map(s=>({id:s.id||s.name,name:s.name,namespace:s.namespace||"default",host:s.host||`${s.name}.${s.namespace||"default"}.svc.cluster.local`,ports:s.ports||[{number:80,protocol:"HTTP"}],labels:s.labels||{},requests:s.requests||0,errors:s.errors||0,latency:s.latency||0,pods:s.pods||1,healthyPods:s.healthyPods||s.pods||1}));this.istioEngine.initialize({services:t,virtualServices:e.virtualServices||[],destinationRules:e.destinationRules||[],gateways:e.gateways||[],peerAuthentications:e.peerAuthentications||[],authorizationPolicies:e.authorizationPolicies||[],serviceEntries:e.serviceEntries||[],sidecars:e.sidecars||[],globalConfig:e.globalConfig})}updateConfig(e){this.initialize(e)}routeRequest(e){return this.istioEngine.routeRequest(e)}getStats(){return this.istioEngine.getStats()}resetStats(){this.istioEngine.resetStats()}getIstioEngine(){return this.istioEngine}}class eA{errors=[];maxErrors=200;errorCounts=new Map;listeners=[];addError(e,t={}){const s=this.generateErrorId(e,t),n=this.errorCounts.get(s)||0;this.errorCounts.set(s,n+1);const i=this.errors.find(o=>o.id===s);if(i&&i.count!==void 0)return i.count=n+1,i.timestamp=Date.now(),this.notifyListeners(i),s;const a={id:s,timestamp:Date.now(),severity:t.severity||this.determineSeverity(e),source:t.source||"unknown",componentId:t.componentId,componentLabel:t.componentLabel,componentType:t.componentType,message:e instanceof Error?e.message:String(e),errorType:e instanceof Error?e.constructor.name:void 0,stack:e instanceof Error?e.stack:void 0,context:t.context,count:n+1};if(this.errors.unshift(a),this.errors.length>this.maxErrors){const o=this.errors.pop();o&&this.errorCounts.delete(o.id)}return this.notifyListeners(a),s}generateErrorId(e,t){const s=e instanceof Error?e.message:String(e),n=`${t.source||"unknown"}-${t.componentType||"unknown"}-${t.componentId||"global"}-${s}`;let i=0;for(let a=0;a<n.length;a++){const o=n.charCodeAt(a);i=(i<<5)-i+o,i=i&i}return`error-${Math.abs(i)}`}determineSeverity(e){if(e instanceof Error){const t=e.constructor.name,s=e.message.toLowerCase();if(t==="RangeError"||t==="ReferenceError"||s.includes("maximum call stack")||s.includes("cannot read property")||s.includes("is not a function"))return"critical";if(t==="TypeError"||s.includes("undefined")||s.includes("null"))return"warning"}return"info"}getErrors(){return[...this.errors]}getErrorsBySeverity(e){return this.errors.filter(t=>t.severity===e)}getErrorsBySource(e){return this.errors.filter(t=>t.source===e)}getErrorsByComponent(e){return this.errors.filter(t=>t.componentId===e)}getCriticalErrors(){return this.getErrorsBySeverity("critical")}getErrorCount(e){return e?this.getErrorsBySeverity(e).length:this.errors.length}clear(){this.errors=[],this.errorCounts.clear()}clearByFilter(e){this.errors=this.errors.filter(t=>{const s=!e(t);return s||this.errorCounts.delete(t.id),s})}removeError(e){this.errors=this.errors.filter(t=>t.id!==e),this.errorCounts.delete(e)}onError(e){return this.listeners.push(e),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}notifyListeners(e){this.listeners.forEach(t=>{try{t(e)}catch(s){console.error("Error in error listener:",s)}})}getStats(){const e={total:this.errors.length,critical:this.getErrorCount("critical"),warning:this.getErrorCount("warning"),info:this.getErrorCount("info"),bySource:{}};return["emulation-engine","component-engine","alert-system","data-flow","routing-engine","initialization","configuration","unknown"].forEach(s=>{e.bySource[s]=this.getErrorsBySource(s).length}),e}}const qe=new eA;class Yf{config;constructor(e){this.config=e}}class av extends Yf{cache=new Map;rateLimitCounters=new Map;awsConfig;constructor(e){super(e),this.awsConfig=e.providerConfig}authenticate(e,t){if(t.authRequired===!1)return{success:!0};if(!(t.authRequired!==void 0?t.authRequired:this.config.enableAuthentication))return{success:!0};if(this.config.authType==="api-key"&&this.config.keys){const n=this.config.keys.find(i=>i.key===e.apiKey||e.headers?.["x-api-key"]===i.key);return!n||!n.enabled?{success:!1,statusCode:403,error:"Invalid API Key"}:n.apiIds.includes(t.id)?(t.authScopes&&t.authScopes.length>0&&this.config.authType,{success:!0,key:n}):{success:!1,statusCode:403,error:"API Key does not have access to this API"}}return this.awsConfig.authorizers&&this.awsConfig.authorizers.length>0?{success:!0}:{success:!1,statusCode:401,error:"Unauthorized"}}checkRateLimit(e,t,s){if(!this.config.enableRateLimiting)return{allowed:!0};const n=Date.now(),i=s?`key-${s.id}`:`api-${t.id}`,a=s?.rateLimit||t.rateLimit||this.config.defaultRateLimit||1e3,o=60*1e3,l=this.rateLimitCounters.get(i);return!l||l.resetAt<n?(this.rateLimitCounters.set(i,{count:1,resetAt:n+o}),{allowed:!0,remaining:a-1,resetAt:n+o}):l.count>=a?{allowed:!1,remaining:0,resetAt:l.resetAt}:(l.count++,{allowed:!0,remaining:a-l.count,resetAt:l.resetAt})}calculateLatency(e,t){let s=50+Math.random()*50;this.config.enableAuthentication&&(s+=10,this.awsConfig.authorizers&&this.awsConfig.authorizers.length>0&&(s+=20)),this.config.enableRateLimiting&&(s+=5),(t.caching?.enabled!==void 0?t.caching.enabled:this.config.enableCaching)&&(s+=3),this.config.enableRequestLogging&&(s+=2),this.awsConfig.enableXRay&&(s+=5);const i=this.calculateUtilization();return s+=i*30,Math.round(s)}getCachedResponse(e,t){if(!(t.caching?.enabled!==void 0?t.caching.enabled:this.config.enableCaching))return null;const n=this.cache.get(e);return!n||n.expiresAt<Date.now()?(this.cache.delete(e),null):n.response}setCachedResponse(e,t,s){const n=Date.now()+s*1e3;this.cache.set(e,{response:t,expiresAt:n})}generateCacheKey(e,t){const n=(t.caching?.cacheKey||["method","path"]).map(i=>i==="method"?e.method:i==="path"?e.path:i==="query"?JSON.stringify(e.query||{}):e.headers?.[i]||"");return`${t.id}:${n.join(":")}`}getProviderSpecificMetrics(){return{cacheHitRate:this.calculateCacheHitRate(),xRayEnabled:this.awsConfig.enableXRay?1:0,stagesCount:this.awsConfig.stages?.length||0,usagePlansCount:this.awsConfig.usagePlans?.length||0}}calculateUtilization(){const e=Array.from(this.rateLimitCounters.values()).reduce((s,n)=>s+n.count,0),t=(this.config.defaultRateLimit||1e3)*(this.config.apis?.length||1);return Math.min(e/t,1)}calculateCacheHitRate(){return .3}}class ov extends Yf{cache=new Map;rateLimitCounters=new Map;azureConfig;constructor(e){super(e),this.azureConfig=e.providerConfig}authenticate(e,t){if(t.authRequired===!1)return{success:!0};if(!(t.authRequired!==void 0?t.authRequired:this.config.enableAuthentication))return{success:!0};if(this.config.authType==="api-key"){const n=e.headers?.["ocp-apim-subscription-key"]||e.query?.["subscription-key"]||e.apiKey;if(!n)return{success:!1,statusCode:401,error:"Missing subscription key"};const i=this.azureConfig.subscriptions?.find(o=>o.primaryKey===n||o.secondaryKey===n);if(!i||i.state!=="active")return{success:!1,statusCode:401,error:"Invalid subscription key"};const a=this.azureConfig.products?.find(o=>o.apis?.includes(t.id));return a&&a.subscriptionRequired&&i.productId!==a.id?{success:!1,statusCode:403,error:"Subscription does not have access to this API"}:{success:!0}}return{success:!1,statusCode:401,error:"Unauthorized"}}checkRateLimit(e,t,s){if(!this.config.enableRateLimiting)return{allowed:!0};const n=e.headers?.["ocp-apim-subscription-key"]||e.query?.["subscription-key"],i=this.azureConfig.subscriptions?.find(p=>p.primaryKey===n||p.secondaryKey===n),a=Date.now(),o=i?`sub-${i.id}`:`api-${t.id}`,l=t.rateLimit||this.config.defaultRateLimit||1e3,d=60*1e3,h=this.rateLimitCounters.get(o);return!h||h.resetAt<a?(this.rateLimitCounters.set(o,{count:1,resetAt:a+d}),{allowed:!0,remaining:l-1,resetAt:a+d}):h.count>=l?{allowed:!1,remaining:0,resetAt:h.resetAt}:(h.count++,{allowed:!0,remaining:l-h.count,resetAt:h.resetAt})}calculateLatency(e,t){let s=30+Math.random()*50;const n=this.azureConfig.policies?.filter(o=>o.scope==="Global"||o.scope==="API"||o.scope==="Operation"&&o.scopeId===t.id).length||0;s+=n*5,this.config.enableAuthentication&&(s+=8),this.config.enableRateLimiting&&(s+=4),(t.caching?.enabled!==void 0?t.caching.enabled:this.config.enableCaching)&&(s+=2),this.azureConfig.enableApplicationInsights&&(s+=3);const a=this.calculateUtilization();return s+=a*25,Math.round(s)}getCachedResponse(e,t){if(!(t.caching?.enabled!==void 0?t.caching.enabled:this.config.enableCaching))return null;const n=this.cache.get(e);return!n||n.expiresAt<Date.now()?(this.cache.delete(e),null):n.response}setCachedResponse(e,t,s){const n=Date.now()+s*1e3;this.cache.set(e,{response:t,expiresAt:n})}generateCacheKey(e,t){const n=(t.caching?.cacheKey||["method","path"]).map(i=>i==="method"?e.method:i==="path"?e.path:i==="query"?JSON.stringify(e.query||{}):e.headers?.[i]||"");return`${t.id}:${n.join(":")}`}getProviderSpecificMetrics(){return{cacheHitRate:this.calculateCacheHitRate(),productsCount:this.azureConfig.products?.length||0,subscriptionsCount:this.azureConfig.subscriptions?.length||0,policiesCount:this.azureConfig.policies?.length||0,applicationInsightsEnabled:this.azureConfig.enableApplicationInsights?1:0}}calculateUtilization(){const e=Array.from(this.rateLimitCounters.values()).reduce((s,n)=>s+n.count,0),t=(this.config.defaultRateLimit||1e3)*(this.config.apis?.length||1);return Math.min(e/t,1)}calculateCacheHitRate(){return .25}}class rv extends Yf{cache=new Map;rateLimitCounters=new Map;gcpConfig;constructor(e){super(e),this.gcpConfig=e.providerConfig}authenticate(e,t){if(t.authRequired===!1)return{success:!0};if(!(t.authRequired!==void 0?t.authRequired:this.config.enableAuthentication))return{success:!0};if(this.config.authType==="api-key"&&this.config.keys){const n=e.headers?.["x-api-key"]||e.query?.key||e.apiKey;if(!n)return{success:!1,statusCode:401,error:"Missing API key"};const i=this.config.keys.find(o=>o.key===n);if(!i||!i.enabled)return{success:!1,statusCode:403,error:"Invalid API key"};const a=i.providerMetadata?.gcp?.restrictions;if(a){if(a.apiTargets&&!a.apiTargets.some(o=>o.service===this.gcpConfig.serviceName&&(o.methods.includes(t.method)||o.methods.includes("*"))))return{success:!1,statusCode:403,error:"API key does not have access to this endpoint"};if(a.httpReferrers&&e.headers?.referer){const o=e.headers.referer;if(!a.httpReferrers.some(l=>o.includes(l)))return{success:!1,statusCode:403,error:"API key restricted by referer"}}if(a.ipAddresses&&e.headers?.["x-forwarded-for"]){const o=e.headers["x-forwarded-for"].split(",")[0].trim();if(!a.ipAddresses.some(l=>o.startsWith(l)))return{success:!1,statusCode:403,error:"API key restricted by IP address"}}}return i.apiIds.includes(t.id)?{success:!0,key:i}:{success:!1,statusCode:403,error:"API key does not have access to this API"}}return{success:!1,statusCode:401,error:"Unauthorized"}}checkRateLimit(e,t,s){if(!this.config.enableRateLimiting)return{allowed:!0};const n=this.gcpConfig.quotas?.find(h=>h.metric==="requests");if(n){const h=Date.now(),p=`quota-${n.id}`,g=this.rateLimitCounters.get(p);return!g||g.resetAt<h?(this.rateLimitCounters.set(p,{count:1,resetAt:h+6e4}),{allowed:!0,remaining:n.limit-1,resetAt:h+6e4}):g.count>=n.limit?{allowed:!1,remaining:0,resetAt:g.resetAt}:(g.count++,{allowed:!0,remaining:n.limit-g.count,resetAt:g.resetAt})}const i=Date.now(),a=s?`key-${s.id}`:`api-${t.id}`,o=s?.rateLimit||t.rateLimit||this.config.defaultRateLimit||1e3,l=60*1e3,d=this.rateLimitCounters.get(a);return!d||d.resetAt<i?(this.rateLimitCounters.set(a,{count:1,resetAt:i+l}),{allowed:!0,remaining:o-1,resetAt:i+l}):d.count>=o?{allowed:!1,remaining:0,resetAt:d.resetAt}:(d.count++,{allowed:!0,remaining:o-d.count,resetAt:d.resetAt})}calculateLatency(e,t){let s=40+Math.random()*50;this.gcpConfig.openApiSpec&&(s+=15),s+=10,this.config.enableAuthentication&&(s+=12),this.config.enableRateLimiting&&(s+=5),(t.caching?.enabled!==void 0?t.caching.enabled:this.config.enableCaching)&&(s+=3),this.gcpConfig.enableCloudLogging&&(s+=4);const i=this.calculateUtilization();return s+=i*30,Math.round(s)}getCachedResponse(e,t){if(!(t.caching?.enabled!==void 0?t.caching.enabled:this.config.enableCaching))return null;const n=this.cache.get(e);return!n||n.expiresAt<Date.now()?(this.cache.delete(e),null):n.response}setCachedResponse(e,t,s){const n=Date.now()+s*1e3;this.cache.set(e,{response:t,expiresAt:n})}generateCacheKey(e,t){const n=(t.caching?.cacheKey||["method","path"]).map(i=>i==="method"?e.method:i==="path"?e.path:i==="query"?JSON.stringify(e.query||{}):e.headers?.[i]||"");return`${t.id}:${n.join(":")}`}getProviderSpecificMetrics(){return{cacheHitRate:this.calculateCacheHitRate(),quotasCount:this.gcpConfig.quotas?.length||0,serviceAccountsCount:this.gcpConfig.serviceAccounts?.length||0,openApiSpecSize:this.gcpConfig.openApiSpec?.length||0,cloudLoggingEnabled:this.gcpConfig.enableCloudLogging?1:0,cloudMonitoringEnabled:this.gcpConfig.enableCloudMonitoring?1:0}}calculateUtilization(){const e=Array.from(this.rateLimitCounters.values()).reduce((s,n)=>s+n.count,0),t=(this.config.defaultRateLimit||1e3)*(this.config.apis?.length||1);return Math.min(e/t,1)}calculateCacheHitRate(){return .35}}class tA{config;providerEngine;requestCount=0;errorCount=0;totalLatency=0;latencyHistory=[];constructor(e){switch(this.config=e,e.provider){case"aws":this.providerEngine=new av(e);break;case"azure":this.providerEngine=new ov(e);break;case"gcp":this.providerEngine=new rv(e);break;default:throw new Error(`Unsupported provider: ${e.provider}`)}}processRequest(e){const t=this.findRoute(e);if(!t||!t.enabled)return{status:404,latency:5,error:"API not found",metadata:{gatewayProvider:this.config.provider}};const s=this.providerEngine.authenticate(e,t);if(!s.success)return this.errorCount++,{status:s.statusCode||401,latency:this.providerEngine.calculateLatency(e,t),error:s.error,metadata:{gatewayProvider:this.config.provider,apiId:t.id}};const n=this.providerEngine.checkRateLimit(e,t,s.key);if(!n.allowed)return this.errorCount++,{status:429,latency:this.providerEngine.calculateLatency(e,t),error:"Rate limit exceeded",headers:{"X-RateLimit-Limit":String(t.rateLimit||this.config.defaultRateLimit||1e3),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":String(n.resetAt||Date.now()+6e4)},metadata:{gatewayProvider:this.config.provider,apiId:t.id,keyId:s.key?.id}};const i=this.providerEngine.generateCacheKey(e,t),a=this.providerEngine.getCachedResponse(i,t);if(a)return this.requestCount++,{...a,metadata:{...a.metadata,cacheHit:!0}};const o=this.providerEngine.calculateLatency(e,t),d=(t.timeout||this.config.requestTimeout||30)*1e3,h=o+Math.random()*100;if(h>d)return this.errorCount++,{status:504,latency:d,error:"Gateway Timeout",metadata:{gatewayProvider:this.config.provider,apiId:t.id,keyId:s.key?.id}};const p=h/d,g=p>.8?Math.min(h+(p-.8)*200,d-10):h;this.requestCount++,this.totalLatency+=g,this.latencyHistory.push(g),this.latencyHistory.length>100&&this.latencyHistory.shift();const v=t.caching?.enabled!==void 0?t.caching.enabled:this.config.enableCaching,b={status:200,latency:Math.round(g),metadata:{gatewayProvider:this.config.provider,apiId:t.id,keyId:s.key?.id,cacheHit:!1,rateLimitRemaining:n.remaining,rateLimitReset:n.resetAt}};if(v){const M=t.caching?.ttl||this.config.cacheTTL||300;this.providerEngine.setCachedResponse(i,b,M)}return{status:200,latency:Math.round(g),metadata:{gatewayProvider:this.config.provider,apiId:t.id,keyId:s.key?.id,cacheHit:!1,rateLimitRemaining:n.remaining,rateLimitReset:n.resetAt}}}findRoute(e){if(!this.config.apis)return;let t=this.config.apis.find(s=>s.path===e.path&&(s.method===e.method||s.method==="ALL")&&s.enabled);return t||(t=this.config.apis.find(s=>e.path.startsWith(s.path)&&(s.method===e.method||s.method==="ALL")&&s.enabled)),t}calculateMetrics(){const e=this.requestCount/60,t=this.requestCount>0?this.totalLatency/this.requestCount:0,s=[...this.latencyHistory].sort((p,g)=>p-g),n=s.length>0?s[Math.floor(s.length*.5)]:void 0,i=s.length>0?s[Math.floor(s.length*.95)]:void 0,a=s.length>0?s[Math.floor(s.length*.99)]:void 0,o=this.requestCount>0?this.errorCount/this.requestCount:0,l=(this.config.defaultRateLimit||1e3)*(this.config.apis?.length||1),d=Math.min(e/l,1),h=this.providerEngine.getProviderSpecificMetrics();return{throughput:e,latency:t,latencyP50:n,latencyP95:i,latencyP99:a,errorRate:o,utilization:d,customMetrics:{...h,totalRequests:this.requestCount,totalErrors:this.errorCount,apisCount:this.config.apis?.length||0,keysCount:this.config.keys?.length||0}}}resetMetrics(){this.requestCount=0,this.errorCount=0,this.totalLatency=0,this.latencyHistory=[]}updateConfig(e){switch(this.config=e,e.provider){case"aws":this.providerEngine=new av(e);break;case"azure":this.providerEngine=new ov(e);break;case"gcp":this.providerEngine=new rv(e);break}}}class sA{config=null;contacts=new Map;deals=new Map;accounts=new Map;leads=new Map;cases=new Map;activities=new Map;crmMetrics={contactsTotal:0,contactsLeads:0,contactsCustomers:0,contactsPartners:0,dealsTotal:0,dealsActive:0,dealsWon:0,dealsLost:0,pipelineValue:0,wonValue:0,accountsTotal:0,accountsCustomers:0,accountsPartners:0,leadsTotal:0,leadsNew:0,leadsQualified:0,leadsConverted:0,casesTotal:0,casesOpen:0,casesResolved:0,averageResolutionTime:0,activitiesTotal:0,activitiesToday:0,requestsPerSecond:0,averageResponseTime:0,errorRate:0,conversionRate:0,dealWinRate:0,apiUtilization:0,databaseUtilization:0};requestHistory=[];MAX_REQUEST_HISTORY=1e3;lastUpdateTime=Date.now();lastActivityGeneration=0;ACTIVITY_GENERATION_INTERVAL=5e3;initializeConfig(e){const t=e.data.config||{};this.config={crmType:t.crmType||"salesforce",apiEndpoint:t.apiEndpoint||"https://api.crm.example.com",enableContacts:t.enableContacts??!0,enableLeads:t.enableLeads??!0,enableOpportunities:t.enableOpportunities??!0,enableAccounts:t.enableAccounts??!0,enableCases:t.enableCases??!0,enableReports:t.enableReports??!0,enableWorkflows:t.enableWorkflows??!0,enableIntegrations:t.enableIntegrations??!0,contacts:t.contacts||[],deals:t.deals||[],accounts:t.accounts||[],leads:t.leads||[],cases:t.cases||[],activities:t.activities||[],requestsPerSecond:t.requestsPerSecond||10,averageResponseTime:t.averageResponseTime||150,errorRate:t.errorRate||.02,conversionRate:t.conversionRate||.15,dealWinRate:t.dealWinRate||.25,caseResolutionTime:t.caseResolutionTime||24},this.initializeContacts(),this.initializeDeals(),this.initializeAccounts(),this.initializeLeads(),this.initializeCases(),this.initializeActivities()}initializeContacts(){if(this.contacts.clear(),this.config?.contacts)for(const e of this.config.contacts)this.contacts.set(e.id,{...e,createdAt:e.createdAt||Date.now(),lastContact:e.lastContact||Date.now()})}initializeDeals(){if(this.deals.clear(),this.config?.deals)for(const e of this.config.deals)this.deals.set(e.id,{...e,createdAt:e.createdAt||Date.now()})}initializeAccounts(){if(this.accounts.clear(),this.config?.accounts)for(const e of this.config.accounts)this.accounts.set(e.id,{...e,createdAt:e.createdAt||Date.now()})}initializeLeads(){if(this.leads.clear(),this.config?.leads)for(const e of this.config.leads)this.leads.set(e.id,{...e,createdAt:e.createdAt||Date.now()})}initializeCases(){if(this.cases.clear(),this.config?.cases)for(const e of this.config.cases)this.cases.set(e.id,{...e,createdAt:e.createdAt||Date.now()})}initializeActivities(){if(this.activities.clear(),this.config?.activities)for(const e of this.config.activities)this.activities.set(e.id,e)}performUpdate(e,t=!1){this.config&&(e-this.lastUpdateTime,this.lastUpdateTime=e,t&&this.simulateAPIRequests(e),this.simulateLeadConversion(e),this.simulateDealProgression(e),this.simulateCaseResolution(e),e-this.lastActivityGeneration>this.ACTIVITY_GENERATION_INTERVAL&&(this.generateActivities(e),this.lastActivityGeneration=e),this.updateMetrics())}simulateAPIRequests(e){if(!this.config)return;const s=(this.config.requestsPerSecond||10)*.1;for(let n=0;n<s;n++)if(Math.random()<.1){const i=this.config.averageResponseTime||150,a=Math.random()<(this.config.errorRate||.02),o=i+(Math.random()-.5)*i*.5;this.requestHistory.push({timestamp:e,latency:o,success:!a}),this.requestHistory.length>this.MAX_REQUEST_HISTORY&&this.requestHistory.shift()}}simulateLeadConversion(e){if(!this.config?.enableLeads||!this.config?.enableContacts)return;const t=this.config.conversionRate||.15;for(const s of this.leads.values())if(s.status==="qualified"&&Math.random()<t*.001){const n={id:`contact-${s.id}`,name:s.name,email:s.email,phone:s.phone,company:s.company,status:"lead",createdAt:e,lastContact:e};this.contacts.set(n.id,n),s.status="converted",s.convertedToContactId=n.id}}simulateDealProgression(e){if(!this.config?.enableOpportunities)return;const t=this.config.dealWinRate||.25;for(const s of this.deals.values())if(!(s.stage==="closed-won"||s.stage==="closed-lost")&&Math.random()<.001){const n=["prospecting","qualification","proposal","negotiation","closed-won","closed-lost"],i=n.indexOf(s.stage);i<n.length-2&&(i===n.length-3?(s.stage=Math.random()<t?"closed-won":"closed-lost",s.actualClose=e):s.stage=n[i+1])}}simulateCaseResolution(e){if(!this.config?.enableCases)return;const t=(this.config.caseResolutionTime||24)*36e5;for(const s of this.cases.values()){if(s.status==="resolved"||s.status==="closed")continue;const n=e-(s.createdAt||e),i=Math.min(1,n/t);Math.random()<i*.01&&(s.status="resolved",s.resolvedAt=e)}}generateActivities(e){if(!this.config)return;const t=["call","email","meeting","task","note"],s=Math.floor(Math.random()*3);for(let n=0;n<s;n++){const i=t[Math.floor(Math.random()*t.length)],a=this.getRandomRelatedEntity(),o={id:`activity-${e}-${n}`,type:i,subject:`${i.charAt(0).toUpperCase()+i.slice(1)} with ${a.name}`,relatedTo:a.id,relatedType:a.type,timestamp:e,duration:i==="call"||i==="meeting"?Math.floor(Math.random()*60)+15:void 0,status:Math.random()<.7?"completed":"scheduled"};this.activities.set(o.id,o)}}getRandomRelatedEntity(){const e=[];for(const t of this.contacts.values())e.push({id:t.id,name:t.name,type:"contact"});for(const t of this.deals.values())e.push({id:t.id,name:t.name,type:"deal"});for(const t of this.accounts.values())e.push({id:t.id,name:t.name,type:"account"});for(const t of this.cases.values())e.push({id:t.id,name:t.subject,type:"case"});return e.length===0?{id:"default",name:"Unknown",type:"contact"}:e[Math.floor(Math.random()*e.length)]}updateMetrics(){this.crmMetrics.contactsTotal=this.contacts.size,this.crmMetrics.contactsLeads=Array.from(this.contacts.values()).filter(i=>i.status==="lead").length,this.crmMetrics.contactsCustomers=Array.from(this.contacts.values()).filter(i=>i.status==="customer").length,this.crmMetrics.contactsPartners=Array.from(this.contacts.values()).filter(i=>i.status==="partner").length,this.crmMetrics.dealsTotal=this.deals.size,this.crmMetrics.dealsActive=Array.from(this.deals.values()).filter(i=>i.stage!=="closed-won"&&i.stage!=="closed-lost").length,this.crmMetrics.dealsWon=Array.from(this.deals.values()).filter(i=>i.stage==="closed-won").length,this.crmMetrics.dealsLost=Array.from(this.deals.values()).filter(i=>i.stage==="closed-lost").length,this.crmMetrics.pipelineValue=Array.from(this.deals.values()).filter(i=>i.stage!=="closed-won"&&i.stage!=="closed-lost").reduce((i,a)=>i+a.value,0),this.crmMetrics.wonValue=Array.from(this.deals.values()).filter(i=>i.stage==="closed-won").reduce((i,a)=>i+a.value,0),this.crmMetrics.accountsTotal=this.accounts.size,this.crmMetrics.accountsCustomers=Array.from(this.accounts.values()).filter(i=>i.type==="customer").length,this.crmMetrics.accountsPartners=Array.from(this.accounts.values()).filter(i=>i.type==="partner").length,this.crmMetrics.leadsTotal=this.leads.size,this.crmMetrics.leadsNew=Array.from(this.leads.values()).filter(i=>i.status==="new").length,this.crmMetrics.leadsQualified=Array.from(this.leads.values()).filter(i=>i.status==="qualified").length,this.crmMetrics.leadsConverted=Array.from(this.leads.values()).filter(i=>i.status==="converted").length,this.crmMetrics.casesTotal=this.cases.size,this.crmMetrics.casesOpen=Array.from(this.cases.values()).filter(i=>i.status!=="resolved"&&i.status!=="closed").length,this.crmMetrics.casesResolved=Array.from(this.cases.values()).filter(i=>i.status==="resolved").length;const e=Array.from(this.cases.values()).filter(i=>i.resolvedAt&&i.createdAt);if(e.length>0){const i=e.reduce((a,o)=>a+((o.resolvedAt||0)-(o.createdAt||0)),0);this.crmMetrics.averageResolutionTime=i/e.length/36e5}this.crmMetrics.activitiesTotal=this.activities.size;const t=Date.now(),s=new Date(t).setHours(0,0,0,0);if(this.crmMetrics.activitiesToday=Array.from(this.activities.values()).filter(i=>i.timestamp>=s).length,this.requestHistory.length>0){const i=this.requestHistory.slice(-100),a=1e4,o=Date.now()-a,l=i.filter(d=>d.timestamp>=o);this.crmMetrics.requestsPerSecond=l.length/(a/1e3),this.crmMetrics.averageResponseTime=i.reduce((d,h)=>d+h.latency,0)/i.length,this.crmMetrics.errorRate=i.filter(d=>!d.success).length/i.length}this.leads.size>0&&(this.crmMetrics.conversionRate=this.crmMetrics.leadsConverted/this.leads.size),this.deals.size>0&&(this.crmMetrics.dealWinRate=this.crmMetrics.dealsWon/(this.crmMetrics.dealsWon+this.crmMetrics.dealsLost||1));const n=this.config?.requestsPerSecond||10;this.crmMetrics.apiUtilization=Math.min(1,this.crmMetrics.requestsPerSecond/n),this.crmMetrics.databaseUtilization=Math.min(1,(this.contacts.size+this.deals.size+this.accounts.size)/1e4)}getMetrics(){return{...this.crmMetrics}}getContacts(){return Array.from(this.contacts.values())}getDeals(){return Array.from(this.deals.values())}getAccounts(){return Array.from(this.accounts.values())}getLeads(){return Array.from(this.leads.values())}getCases(){return Array.from(this.cases.values())}getActivities(){return Array.from(this.activities.values())}addContact(e){this.contacts.set(e.id,e),this.updateMetrics()}updateContact(e,t){const s=this.contacts.get(e);s&&(this.contacts.set(e,{...s,...t}),this.updateMetrics())}removeContact(e){this.contacts.delete(e),this.updateMetrics()}addDeal(e){this.deals.set(e.id,e),this.updateMetrics()}updateDeal(e,t){const s=this.deals.get(e);s&&(this.deals.set(e,{...s,...t}),this.updateMetrics())}removeDeal(e){this.deals.delete(e),this.updateMetrics()}addAccount(e){this.accounts.set(e.id,e),this.updateMetrics()}updateAccount(e,t){const s=this.accounts.get(e);s&&(this.accounts.set(e,{...s,...t}),this.updateMetrics())}removeAccount(e){this.accounts.delete(e),this.updateMetrics()}addLead(e){this.leads.set(e.id,e),this.updateMetrics()}updateLead(e,t){const s=this.leads.get(e);s&&(this.leads.set(e,{...s,...t}),this.updateMetrics())}removeLead(e){this.leads.delete(e),this.updateMetrics()}addCase(e){this.cases.set(e.id,e),this.updateMetrics()}updateCase(e,t){const s=this.cases.get(e);s&&(this.cases.set(e,{...s,...t}),this.updateMetrics())}removeCase(e){this.cases.delete(e),this.updateMetrics()}syncToConfig(){return{...this.config,contacts:this.getContacts(),deals:this.getDeals(),accounts:this.getAccounts(),leads:this.getLeads(),cases:this.getCases(),activities:this.getActivities()}}}class nA{config=null;orders=new Map;inventory=new Map;transactions=new Map;employees=new Map;manufacturingOrders=new Map;supplyItems=new Map;erpMetrics={ordersTotal:0,ordersPending:0,ordersProcessing:0,ordersShipped:0,ordersDelivered:0,ordersValue:0,inventoryItemsTotal:0,inventoryValue:0,inventoryLowStock:0,inventoryOutOfStock:0,inventoryTurnover:0,transactionsTotal:0,revenue:0,expenses:0,profit:0,accountsReceivable:0,accountsPayable:0,employeesTotal:0,employeesActive:0,employeesOnLeave:0,totalPayroll:0,manufacturingOrdersTotal:0,manufacturingOrdersInProgress:0,manufacturingOrdersCompleted:0,manufacturingCapacity:0,supplyItemsTotal:0,supplyItemsInTransit:0,supplyItemsDelayed:0,supplyValue:0,requestsPerSecond:0,averageResponseTime:0,errorRate:0,apiUtilization:0,databaseUtilization:0,systemUtilization:0};requestHistory=[];MAX_REQUEST_HISTORY=1e3;lastUpdateTime=Date.now();monthlyRevenue=0;monthlyExpenses=0;lastMonthReset=Date.now();initializeConfig(e){const t=e.data.config||{};this.config={erpType:t.erpType||"sap",apiEndpoint:t.apiEndpoint||"https://sap.example.com",enableFinance:t.enableFinance??!0,enableHR:t.enableHR??!0,enableSupplyChain:t.enableSupplyChain??!0,enableManufacturing:t.enableManufacturing??!0,enableSales:t.enableSales??!0,enableInventory:t.enableInventory??!0,enableReporting:t.enableReporting??!0,orders:t.orders||[],inventory:t.inventory||[],transactions:t.transactions||[],employees:t.employees||[],manufacturingOrders:t.manufacturingOrders||[],supplyItems:t.supplyItems||[],requestsPerSecond:t.requestsPerSecond||50,averageResponseTime:t.averageResponseTime||200,errorRate:t.errorRate||.01,orderProcessingTime:t.orderProcessingTime||24,inventoryReplenishmentTime:t.inventoryReplenishmentTime||48,manufacturingCycleTime:t.manufacturingCycleTime||72},this.initializeOrders(),this.initializeInventory(),this.initializeTransactions(),this.initializeEmployees(),this.initializeManufacturingOrders(),this.initializeSupplyItems()}initializeOrders(){if(this.orders.clear(),this.config?.orders)for(const e of this.config.orders)this.orders.set(e.id,{...e,orderDate:e.orderDate||Date.now()})}initializeInventory(){if(this.inventory.clear(),this.config?.inventory)for(const e of this.config.inventory)this.inventory.set(e.id,{...e,lastRestocked:e.lastRestocked||Date.now()})}initializeTransactions(){if(this.transactions.clear(),this.config?.transactions)for(const e of this.config.transactions)this.transactions.set(e.id,{...e,date:e.date||Date.now()})}initializeEmployees(){if(this.employees.clear(),this.config?.employees)for(const e of this.config.employees)this.employees.set(e.id,{...e,hireDate:e.hireDate||Date.now()})}initializeManufacturingOrders(){if(this.manufacturingOrders.clear(),this.config?.manufacturingOrders)for(const e of this.config.manufacturingOrders)this.manufacturingOrders.set(e.id,e)}initializeSupplyItems(){if(this.supplyItems.clear(),this.config?.supplyItems)for(const e of this.config.supplyItems)this.supplyItems.set(e.id,{...e,orderDate:e.orderDate||Date.now()})}performUpdate(e,t=!1){this.config&&(e-this.lastUpdateTime,this.lastUpdateTime=e,e-this.lastMonthReset>720*36e5&&(this.monthlyRevenue=0,this.monthlyExpenses=0,this.lastMonthReset=e),t&&this.simulateAPIRequests(e),this.config.enableSales&&this.simulateOrderProcessing(e),this.config.enableInventory&&this.simulateInventoryReplenishment(e),this.config.enableManufacturing&&this.simulateManufacturing(e),this.config.enableSupplyChain&&this.simulateSupplyChain(e),this.config.enableFinance&&this.simulateFinancialTransactions(e),this.updateMetrics())}simulateAPIRequests(e){if(!this.config)return;const s=(this.config.requestsPerSecond||50)*.1;for(let n=0;n<s;n++)if(Math.random()<.2){const i=this.config.averageResponseTime||200,a=Math.random()<(this.config.errorRate||.01),o=i+(Math.random()-.5)*i*.4;this.requestHistory.push({timestamp:e,latency:o,success:!a}),this.requestHistory.length>this.MAX_REQUEST_HISTORY&&this.requestHistory.shift()}}simulateOrderProcessing(e){if(!this.config)return;const t=(this.config.orderProcessingTime||24)*36e5;for(const s of this.orders.values()){if(s.status==="delivered"||s.status==="cancelled")continue;const n=e-s.orderDate,i=Math.min(1,n/t);s.status==="pending"&&Math.random()<i*.01?s.status="processing":s.status==="processing"&&Math.random()<i*.01?(s.status="shipped",s.expectedDelivery=e+24*36e5):s.status==="shipped"&&s.expectedDelivery&&e>=s.expectedDelivery&&(s.status="delivered",s.actualDelivery=e,this.config.enableFinance&&this.createRevenueTransaction(s),this.config.enableInventory&&this.updateInventoryFromOrder(s))}}createRevenueTransaction(e){const t={id:`txn-${e.id}-${Date.now()}`,transactionNumber:`TXN-${Date.now()}`,type:"revenue",amount:e.total,currency:"USD",account:"Sales Revenue",description:`Revenue from order ${e.orderNumber}`,date:Date.now(),reference:e.id,status:"posted",category:"Sales"};this.transactions.set(t.id,t),this.monthlyRevenue+=e.total}updateInventoryFromOrder(e){for(const t of e.items){const s=Array.from(this.inventory.values()).find(n=>n.sku===t.sku);s&&(s.quantity=Math.max(0,s.quantity-t.quantity),s.lastSold=Date.now(),s.quantity===0?s.status="out-of-stock":s.quantity<=s.reorderLevel&&(s.status="low-stock"))}}simulateInventoryReplenishment(e){if(!this.config)return;const t=(this.config.inventoryReplenishmentTime||48)*36e5;for(const s of this.inventory.values()){(s.status==="low-stock"||s.status==="out-of-stock")&&(this.hasActiveSupplyOrder(s.id)||s.quantity<=s.reorderLevel&&this.config.enableSupplyChain&&this.createSupplyOrder(s,e));const n=Array.from(this.supplyItems.values()).find(i=>i.itemId===s.id&&i.status==="received");n&&s.lastRestocked&&e-s.lastRestocked>=t&&(s.quantity+=n.quantity,s.lastRestocked=e,s.quantity>s.reorderLevel&&(s.status="in-stock"))}}hasActiveSupplyOrder(e){return Array.from(this.supplyItems.values()).some(t=>t.itemId===e&&(t.status==="ordered"||t.status==="in-transit"))}createSupplyOrder(e,t){const s={id:`supply-${e.id}-${t}`,purchaseOrderNumber:`PO-${Date.now()}`,supplier:e.supplier||"Default Supplier",item:e.name,itemId:e.id,quantity:e.reorderQuantity||e.reorderLevel*2,unitPrice:e.unitCost||e.unitPrice*.7,total:(e.reorderQuantity||e.reorderLevel*2)*(e.unitCost||e.unitPrice*.7),status:"ordered",orderDate:t,expectedDelivery:t+1728e5};this.supplyItems.set(s.id,s)}simulateManufacturing(e){if(!this.config)return;const t=(this.config.manufacturingCycleTime||72)*36e5;for(const s of this.manufacturingOrders.values())s.status==="completed"||s.status==="cancelled"||(s.status==="planned"&&Math.random()<.001?(s.status="released",s.startDate=e):s.status==="released"&&Math.random()<.001?s.status="in-progress":s.status==="in-progress"&&s.startDate&&((e-s.startDate)/t>=1||Math.random()<.001)&&(s.status="completed",s.completionDate=e,this.config.enableInventory&&this.addManufacturedItemToInventory(s)))}addManufacturedItemToInventory(e){let t=Array.from(this.inventory.values()).find(s=>s.id===e.productId);t||(t={id:e.productId,sku:`SKU-${e.productId}`,name:e.productName,category:"Manufactured",quantity:0,reservedQuantity:0,reorderLevel:e.quantity*.2,reorderQuantity:e.quantity,unitPrice:(e.totalCost||0)/e.quantity*1.3,unitCost:(e.totalCost||0)/e.quantity,status:"in-stock",lastRestocked:Date.now()}),t.quantity+=e.quantity,t.lastRestocked=Date.now(),t.quantity>t.reorderLevel&&(t.status="in-stock"),this.inventory.set(t.id,t)}simulateSupplyChain(e){for(const t of this.supplyItems.values())t.status==="received"||t.status==="cancelled"||(t.status==="ordered"&&Math.random()<.001?t.status="in-transit":t.status==="in-transit"&&t.expectedDelivery?e>=t.expectedDelivery&&(Math.random()<.9?(t.status="received",t.actualDelivery=e):(t.status="delayed",t.expectedDelivery=e+24*36e5)):t.status==="delayed"&&t.expectedDelivery&&e>=t.expectedDelivery&&(t.status="received",t.actualDelivery=e))}simulateFinancialTransactions(e){if(Math.random()<.001){const t=Array.from(this.supplyItems.values()).filter(s=>s.status==="received"&&!this.hasTransactionForSupply(s.id));if(t.length>0){const s=t[0],n={id:`txn-supply-${s.id}`,transactionNumber:`TXN-${Date.now()}`,type:"expense",amount:s.total,currency:"USD",account:"Cost of Goods Sold",description:`Purchase from ${s.supplier}`,date:e,reference:s.id,status:"posted",category:"Purchasing"};this.transactions.set(n.id,n),this.monthlyExpenses+=s.total}}}hasTransactionForSupply(e){return Array.from(this.transactions.values()).some(t=>t.reference===e)}updateMetrics(){this.erpMetrics.ordersTotal=this.orders.size,this.erpMetrics.ordersPending=Array.from(this.orders.values()).filter(n=>n.status==="pending").length,this.erpMetrics.ordersProcessing=Array.from(this.orders.values()).filter(n=>n.status==="processing").length,this.erpMetrics.ordersShipped=Array.from(this.orders.values()).filter(n=>n.status==="shipped").length,this.erpMetrics.ordersDelivered=Array.from(this.orders.values()).filter(n=>n.status==="delivered").length,this.erpMetrics.ordersValue=Array.from(this.orders.values()).filter(n=>n.status!=="cancelled").reduce((n,i)=>n+i.total,0),this.erpMetrics.inventoryItemsTotal=this.inventory.size,this.erpMetrics.inventoryValue=Array.from(this.inventory.values()).reduce((n,i)=>n+i.quantity*i.unitPrice,0),this.erpMetrics.inventoryLowStock=Array.from(this.inventory.values()).filter(n=>n.status==="low-stock").length,this.erpMetrics.inventoryOutOfStock=Array.from(this.inventory.values()).filter(n=>n.status==="out-of-stock").length;const e=Array.from(this.inventory.values()).reduce((n,i)=>n+i.quantity*i.unitCost,0),t=this.monthlyRevenue;if(this.erpMetrics.inventoryTurnover=e>0?t/e*12:0,this.erpMetrics.transactionsTotal=this.transactions.size,this.erpMetrics.revenue=this.monthlyRevenue,this.erpMetrics.expenses=this.monthlyExpenses,this.erpMetrics.profit=this.monthlyRevenue-this.monthlyExpenses,this.erpMetrics.accountsReceivable=Array.from(this.orders.values()).filter(n=>n.status!=="delivered"&&n.status!=="cancelled").reduce((n,i)=>n+i.total,0),this.erpMetrics.accountsPayable=Array.from(this.supplyItems.values()).filter(n=>n.status==="received"&&!this.hasTransactionForSupply(n.id)).reduce((n,i)=>n+i.total,0),this.erpMetrics.employeesTotal=this.employees.size,this.erpMetrics.employeesActive=Array.from(this.employees.values()).filter(n=>n.status==="active").length,this.erpMetrics.employeesOnLeave=Array.from(this.employees.values()).filter(n=>n.status==="on-leave").length,this.erpMetrics.totalPayroll=Array.from(this.employees.values()).filter(n=>n.status==="active"&&n.salary).reduce((n,i)=>n+(i.salary||0),0),this.erpMetrics.manufacturingOrdersTotal=this.manufacturingOrders.size,this.erpMetrics.manufacturingOrdersInProgress=Array.from(this.manufacturingOrders.values()).filter(n=>n.status==="in-progress").length,this.erpMetrics.manufacturingOrdersCompleted=Array.from(this.manufacturingOrders.values()).filter(n=>n.status==="completed").length,this.erpMetrics.manufacturingCapacity=Math.min(1,this.erpMetrics.manufacturingOrdersInProgress/Math.max(1,this.erpMetrics.manufacturingOrdersTotal*.5)),this.erpMetrics.supplyItemsTotal=this.supplyItems.size,this.erpMetrics.supplyItemsInTransit=Array.from(this.supplyItems.values()).filter(n=>n.status==="in-transit").length,this.erpMetrics.supplyItemsDelayed=Array.from(this.supplyItems.values()).filter(n=>n.status==="delayed").length,this.erpMetrics.supplyValue=Array.from(this.supplyItems.values()).filter(n=>n.status!=="cancelled").reduce((n,i)=>n+i.total,0),this.requestHistory.length>0){const n=this.requestHistory.slice(-100),i=1e4,a=Date.now()-i,o=n.filter(l=>l.timestamp>=a);this.erpMetrics.requestsPerSecond=o.length/(i/1e3),this.erpMetrics.averageResponseTime=n.reduce((l,d)=>l+d.latency,0)/n.length,this.erpMetrics.errorRate=n.filter(l=>!l.success).length/n.length}const s=this.config?.requestsPerSecond||50;this.erpMetrics.apiUtilization=Math.min(1,this.erpMetrics.requestsPerSecond/s),this.erpMetrics.databaseUtilization=Math.min(1,(this.orders.size+this.inventory.size+this.transactions.size+this.employees.size)/5e4),this.erpMetrics.systemUtilization=Math.max(this.erpMetrics.apiUtilization,this.erpMetrics.databaseUtilization,this.erpMetrics.manufacturingCapacity)}getMetrics(){return{...this.erpMetrics}}getOrders(){return Array.from(this.orders.values())}getInventory(){return Array.from(this.inventory.values())}getTransactions(){return Array.from(this.transactions.values())}getEmployees(){return Array.from(this.employees.values())}getManufacturingOrders(){return Array.from(this.manufacturingOrders.values())}getSupplyItems(){return Array.from(this.supplyItems.values())}addOrder(e){this.orders.set(e.id,e),this.updateMetrics()}updateOrder(e,t){const s=this.orders.get(e);s&&(this.orders.set(e,{...s,...t}),this.updateMetrics())}removeOrder(e){this.orders.delete(e),this.updateMetrics()}addInventoryItem(e){this.inventory.set(e.id,e),this.updateMetrics()}updateInventoryItem(e,t){const s=this.inventory.get(e);s&&(this.inventory.set(e,{...s,...t}),this.updateMetrics())}removeInventoryItem(e){this.inventory.delete(e),this.updateMetrics()}addTransaction(e){this.transactions.set(e.id,e),e.type==="revenue"?this.monthlyRevenue+=e.amount:e.type==="expense"&&(this.monthlyExpenses+=e.amount),this.updateMetrics()}updateTransaction(e,t){const s=this.transactions.get(e);s&&(t.amount!==void 0&&(s.type==="revenue"?this.monthlyRevenue=this.monthlyRevenue-s.amount+t.amount:s.type==="expense"&&(this.monthlyExpenses=this.monthlyExpenses-s.amount+t.amount)),this.transactions.set(e,{...s,...t}),this.updateMetrics())}removeTransaction(e){const t=this.transactions.get(e);t&&(t.type==="revenue"?this.monthlyRevenue-=t.amount:t.type==="expense"&&(this.monthlyExpenses-=t.amount),this.transactions.delete(e),this.updateMetrics())}addEmployee(e){this.employees.set(e.id,e),this.updateMetrics()}updateEmployee(e,t){const s=this.employees.get(e);s&&(this.employees.set(e,{...s,...t}),this.updateMetrics())}removeEmployee(e){this.employees.delete(e),this.updateMetrics()}addManufacturingOrder(e){this.manufacturingOrders.set(e.id,e),this.updateMetrics()}updateManufacturingOrder(e,t){const s=this.manufacturingOrders.get(e);s&&(this.manufacturingOrders.set(e,{...s,...t}),this.updateMetrics())}removeManufacturingOrder(e){this.manufacturingOrders.delete(e),this.updateMetrics()}addSupplyItem(e){this.supplyItems.set(e.id,e),this.updateMetrics()}updateSupplyItem(e,t){const s=this.supplyItems.get(e);s&&(this.supplyItems.set(e,{...s,...t}),this.updateMetrics())}removeSupplyItem(e){this.supplyItems.delete(e),this.updateMetrics()}syncToConfig(){return{...this.config,orders:this.getOrders(),inventory:this.getInventory(),transactions:this.getTransactions(),employees:this.getEmployees(),manufacturingOrders:this.getManufacturingOrders(),supplyItems:this.getSupplyItems()}}}class iA{config=null;transactions=new Map;webhooks=new Map;pgMetrics={transactionsTotal:0,transactionsSucceeded:0,transactionsPending:0,transactionsFailed:0,transactionsRefunded:0,totalAmount:0,totalAmountSucceeded:0,totalAmountRefunded:0,averageAmount:0,successRate:0,failureRate:0,refundRate:0,fraudDetected:0,requestsPerSecond:0,averageResponseTime:0,errorRate:0,apiUtilization:0,processingUtilization:0,webhooksTotal:0,webhooksEnabled:0,webhooksTriggered:0,webhooksFailed:0,conversionFunnel:{pending:0,processing:0,succeeded:0,failed:0,refunded:0},chargebackRate:0,disputeRate:0,averageProcessingTime:0};processingTimes=[];MAX_PROCESSING_TIMES=1e3;metricsByPaymentMethod=new Map;metricsByCurrency=new Map;requestHistory=[];MAX_REQUEST_HISTORY=1e3;lastUpdateTime=Date.now();lastTransactionGeneration=0;TRANSACTION_GENERATION_INTERVAL=2e3;pendingTransactions=new Set;customerInfoCache=new Map;transactionLimits;sentTransactionIds=new Set;statusChangedTransactions=new Set;lastDataSyncTime=Date.now();getGatewayProfile(e){const t={stripe:{latency:150,successRate:.97,feePercentage:.029,feeFixed:.3},paypal:{latency:300,successRate:.94,feePercentage:.029,feeFixed:.3},square:{latency:120,successRate:.96,feePercentage:.026,feeFixed:.1},adyen:{latency:100,successRate:.98,feePercentage:.025,feeFixed:.2}};return t[e]||t.stripe}generateRealisticAmount(e){const t=Math.random();let s;return t<.7?s=Math.random()*50:t<.9?s=50+Math.random()*150:t<.98?s=200+Math.random()*300:s=500+Math.random()*5e3,e==="ach"?s<100&&(s=100+Math.random()*400):e==="cryptocurrency"?Math.random()<.5&&(s=200+Math.random()*3e3):e==="card"||e==="apple_pay"||e==="google_pay"||e==="bank_transfer"&&s<50&&(s=50+Math.random()*150),Math.floor(s*100)/100}getTimeBasedLoadMultiplier(e){const t=new Date(e),s=t.getHours(),n=t.getDay(),i=n===0||n===6,a=s>=9&&s<12,o=s>=18&&s<21;if(a||o)return 1.5+Math.random()*.5;if(s>=12&&s<18)return 1;const l=.3,d=Math.random()*.2;let h=l+d;return i&&(h*=.7),Math.random()<.01&&(h*=2.5),h}getPaymentMethodProfile(e){const t={card:{latency:200,successRate:.95,processingTimeMin:1e3,processingTimeMax:3e3},bank_transfer:{latency:3e3,successRate:.98,processingTimeMin:2e3,processingTimeMax:5e3},paypal:{latency:300,successRate:.94,processingTimeMin:2e3,processingTimeMax:4e3},apple_pay:{latency:150,successRate:.96,processingTimeMin:500,processingTimeMax:2e3},google_pay:{latency:150,successRate:.96,processingTimeMin:500,processingTimeMax:2e3},ach:{latency:1728e5,successRate:.99,processingTimeMin:864e5,processingTimeMax:2592e5},cryptocurrency:{latency:9e5,successRate:.9,processingTimeMin:3e5,processingTimeMax:18e5}};return t[e]||t.card}initializeConfig(e){const t=e.data.config||{};this.config={gatewayType:t.gatewayType||"stripe",apiKey:t.apiKey||"",secretKey:t.secretKey||"",enableCreditCards:t.enableCreditCards??!0,enableDebitCards:t.enableDebitCards??!0,enableACH:t.enableACH??!1,enableCryptocurrency:t.enableCryptocurrency??!1,enable3DSecure:t.enable3DSecure??!0,enableFraudDetection:t.enableFraudDetection??!0,enableRefunds:t.enableRefunds??!0,enableRecurringPayments:t.enableRecurringPayments??!0,supportedCurrencies:t.supportedCurrencies||["USD","EUR","GBP","JPY"],supportedMethods:t.supportedMethods||["card","bank_transfer","paypal","apple_pay"],webhooks:t.webhooks||[],transactions:t.transactions||[],requestsPerSecond:t.requestsPerSecond||50,averageResponseTime:t.averageResponseTime||200,errorRate:t.errorRate||.01,successRate:t.successRate||.95,fraudDetectionRate:t.fraudDetectionRate||.02,refundRate:t.refundRate||.05,connectionThroughputMultiplier:t.connectionThroughputMultiplier??.2,baseTransactionCount:t.baseTransactionCount??2,highLoadLatencyMultiplier:t.highLoadLatencyMultiplier??[{threshold:.95,multiplierMin:1.5,multiplierMax:2},{threshold:.8,multiplierMin:1.2,multiplierMax:1.5}],highLoadErrorRateMultiplier:t.highLoadErrorRateMultiplier??[{threshold:.95,multiplier:2},{threshold:.8,multiplier:1.5}],fraudDetectionMultipliers:t.fraudDetectionMultipliers??{largeAmount:2.5,newCustomer:1.8,unusualMethod:1.5,suspiciousIP:2},falsePositiveRate:t.falsePositiveRate??.075,immediateSuccessRate:t.immediateSuccessRate??{with3DSecure:.6,without3DSecure:.7},processingTimeMultipliers:t.processingTimeMultipliers??{largeAmount:1.3,nightWeekend:1.3},refundChanceMultiplier:t.refundChanceMultiplier??1e-4,refundAmountRange:t.refundAmountRange??{min:.5,max:1},webhookDelay:t.webhookDelay??{min:50,max:200},webhookRetry:t.webhookRetry??{maxRetries:3,initialBackoff:100,maxBackoff:5e3,backoffMultiplier:2},refundPatterns:t.refundPatterns??{largeAmountMultiplier:2,methodMultipliers:{paypal:1.5,card:1,bank_transfer:1,apple_pay:1,google_pay:1,ach:1,cryptocurrency:1},holidayMultiplier:1.5,holidayDays:7}},this.initializeTransactions(),this.initializeWebhooks()}initializeTransactions(){if(this.transactions.clear(),this.config?.transactions)for(const e of this.config.transactions)this.transactions.set(e.id,{...e,timestamp:e.timestamp||Date.now()}),(e.status==="pending"||e.status==="processing")&&this.pendingTransactions.add(e.id)}initializeWebhooks(){if(this.webhooks.clear(),this.config?.webhooks)for(const e of this.config.webhooks)this.webhooks.set(e.id,{...e,successCount:e.successCount||0,failureCount:e.failureCount||0,pendingRetries:e.pendingRetries||new Map})}performUpdate(e,t=!1,s=0){if(!this.config)return;e-this.lastUpdateTime;const n=this.lastUpdateTime;this.lastUpdateTime=e,t&&this.simulateAPIRequests(e,s),e-this.lastTransactionGeneration>this.TRANSACTION_GENERATION_INTERVAL&&(this.generateTransactions(e,s),this.lastTransactionGeneration=e),this.trackStatusChanges(n),this.processPendingTransactions(e),this.config.enableRefunds&&this.simulateRefunds(e),this.triggerWebhooks(e),this.updateMetrics()}trackStatusChanges(e){}simulateAPIRequests(e,t=0){if(!this.config)return;const s=this.getTimeBasedLoadMultiplier(e),n=this.config.requestsPerSecond||50,i=this.config.connectionThroughputMultiplier??.2,a=1+t*i,l=n*s*a*.1;let h=this.getGatewayProfile(this.config.gatewayType).latency;this.config.enable3DSecure&&(h+=50);const p=this.pgMetrics.apiUtilization||0,g=this.config.highLoadLatencyMultiplier??[{threshold:.95,multiplierMin:1.5,multiplierMax:2},{threshold:.8,multiplierMin:1.2,multiplierMax:1.5}];for(const v of g)if(p>v.threshold){const b=v.multiplierMin+Math.random()*(v.multiplierMax-v.multiplierMin);h*=b;break}for(let v=0;v<l;v++)if(Math.random()<.2){const b=this.config.averageResponseTime||h,M=this.config.errorRate||.01,x=this.config.highLoadErrorRateMultiplier??[{threshold:.95,multiplier:2},{threshold:.8,multiplier:1.5}];let S=M;for(const A of x)if(p>A.threshold){S=M*A.multiplier;break}const T=Math.random()<S,E=b+(Math.random()-.5)*b*.4;this.requestHistory.push({timestamp:e,latency:E,success:!T}),this.requestHistory.length>this.MAX_REQUEST_HISTORY&&this.requestHistory.shift()}}generateTransactions(e,t=0){if(!this.config)return;const s=this.getTimeBasedLoadMultiplier(e),n=this.config.baseTransactionCount??2,i=this.config.connectionThroughputMultiplier??.2,a=1+t*i,o=Math.floor(Math.random()*(n*s*a*2)),l=this.getGatewayProfile(this.config.gatewayType),d=l.successRate;for(let h=0;h<o;h++){const p=this.config.supportedMethods[Math.floor(Math.random()*this.config.supportedMethods.length)],g=this.generateRealisticAmount(p),v=this.config.supportedCurrencies[Math.floor(Math.random()*this.config.supportedCurrencies.length)];if(p==="card"&&!this.config.enableCreditCards&&!this.config.enableDebitCards||p==="ach"&&!this.config.enableACH||p==="cryptocurrency"&&!this.config.enableCryptocurrency)continue;let M=this.getPaymentMethodProfile(p).successRate,x=Math.min(d,M);this.config.enable3DSecure&&(x=Math.min(1,x+.02));const S=this.config.successRate!==void 0?Math.min(this.config.successRate,M):x;let T=this.config.fraudDetectionRate||.02;const E=this.config.fraudDetectionMultipliers??{largeAmount:2.5,newCustomer:1.8,unusualMethod:1.5,suspiciousIP:2};g>500&&(T*=E.largeAmount);let A,k;if(Math.random()<.7){const me=Array.from(this.customerInfoCache.keys());me.length>0&&Math.random()<.8?(A=me[Math.floor(Math.random()*me.length)],k=this.customerInfoCache.get(A)):A=`customer-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const D=!k||!k.hasPaymentHistory;if(D?T*=E.newCustomer:(k.hasPaymentHistory&&(T*=.6),k.isVipCustomer&&(T*=.5)),this.transactionLimits&&g>this.transactionLimits.maxTransactionAmount){Y="failed";continue}["cryptocurrency","ach"].includes(p)&&(T*=E.unusualMethod),Math.random()<.1&&(T*=E.suspiciousIP);const U=Math.random()<Math.min(T,.5),Q=this.config.falsePositiveRate??.075,se=!U&&Math.random()<Q,F=U||se&&this.config.enableFraudDetection;let Y="pending";const ae=Math.random()<S;let de=0;if(this.config.enableFraudDetection&&(F||Math.random()<.3)&&(de=100+Math.random()*100),F&&this.config.enableFraudDetection)Y="failed";else if(ae){const me=this.config.immediateSuccessRate??{with3DSecure:.6,without3DSecure:.7},N=this.config.enable3DSecure?me.with3DSecure:me.without3DSecure;Y=Math.random()<N?"succeeded":"processing"}else Y="failed";const z=g*l.feePercentage+l.feeFixed,q={source:"api",ip:`${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`,fraudCheckLatency:de,isNewCustomer:D};F&&this.config.enableFraudDetection&&(q.fraudDetected=!0,q.fraudReason=se?"false_positive":"suspicious_activity");const ee={id:`txn_${e}_${h}_${Math.random().toString(36).substr(2,9)}`,amount:g,currency:v,status:Y,paymentMethod:p,customerId:A||`cust_${Math.random().toString(36).substr(2,9)}`,timestamp:e,description:`Payment for order #${Math.floor(Math.random()*1e4)}`,fee:z,metadata:q};this.transactions.set(ee.id,ee),(Y==="pending"||Y==="processing")&&this.pendingTransactions.add(ee.id)}}processPendingTransactions(e){if(this.config)for(const t of Array.from(this.pendingTransactions)){const s=this.transactions.get(t);if(!s){this.pendingTransactions.delete(t);continue}const n=e-s.timestamp,i=this.getPaymentMethodProfile(s.paymentMethod),a=i.processingTimeMin+Math.random()*(i.processingTimeMax-i.processingTimeMin),o=s.amount>500,l=this.config.processingTimeMultipliers??{largeAmount:1.3,nightWeekend:1.3},d=o?l.largeAmount:1,h=a*d,p=new Date(e),g=p.getHours(),v=p.getDay(),b=v===0||v===6,M=g<9||g>21,x=b||M?l.nightWeekend:1,S=h*x;if(n>S&&(s.status==="pending"||s.status==="processing")){const E=this.getGatewayProfile(this.config.gatewayType).successRate,A=i.successRate,k=Math.min(E,A),D=this.config.successRate!==void 0?Math.min(this.config.successRate,A):k,L=s.status,I=Math.random()<D;s.status=I?"succeeded":"failed";const U=e-s.timestamp;this.processingTimes.push(U),this.processingTimes.length>this.MAX_PROCESSING_TIMES&&this.processingTimes.shift(),L!==s.status&&this.statusChangedTransactions.add(t),this.pendingTransactions.delete(t)}}}simulateRefunds(e){if(!this.config)return;const t=this.config.refundRate||.05,s=this.config.refundChanceMultiplier??1e-4,n=this.config.refundAmountRange??{min:.5,max:1},i=this.config.refundPatterns??{largeAmountMultiplier:2,methodMultipliers:{paypal:1.5,card:1,bank_transfer:1,apple_pay:1,google_pay:1,ach:1,cryptocurrency:1},holidayMultiplier:1.5,holidayDays:7};for(const a of this.transactions.values())if(a.status==="succeeded"&&!a.refundedAmount){let o=t*s;a.amount>500&&(o*=i.largeAmountMultiplier??2);const l=i.methodMultipliers?.[a.paymentMethod]??1;o*=l;const h=(e-a.timestamp)/(1e3*60*60*24);if(Math.random()<.1&&h<=(i.holidayDays??7)&&(o*=i.holidayMultiplier??1.5),Math.random()<o){const g=n.min+Math.random()*(n.max-n.min),v=a.amount*g;a.status="refunded",a.refundedAmount=v}}}triggerWebhooks(e){if(!this.config)return;const t=this.config.webhookDelay??{min:50,max:200},s=this.config.webhookRetry??{maxRetries:3,initialBackoff:100,maxBackoff:5e3,backoffMultiplier:2},n=e-5e3,i=Array.from(this.transactions.values()).filter(a=>a.timestamp>=n&&(a.status==="succeeded"||a.status==="failed"||a.status==="refunded"));for(const a of this.webhooks.values()){if(!a.enabled)continue;a.pendingRetries||(a.pendingRetries=new Map);for(const[l,d]of Array.from(a.pendingRetries.entries()))if(e>=d.nextRetryTime){if(!this.transactions.get(l)){a.pendingRetries.delete(l);continue}if(Math.random()>.05)a.successCount=(a.successCount||0)+1,a.pendingRetries.delete(l),this.pgMetrics.webhooksTriggered++;else if(d.retryCount<s.maxRetries){const g=Math.min(s.initialBackoff*Math.pow(s.backoffMultiplier,d.retryCount),s.maxBackoff);d.retryCount++,d.nextRetryTime=e+g,d.lastAttemptTime=e}else a.failureCount=(a.failureCount||0)+1,a.pendingRetries.delete(l),this.pgMetrics.webhooksFailed++}const o=new Set;for(const l of i){if(a.pendingRetries.has(l.id)||o.has(l.id))continue;const d=`payment.${l.status}`;if(a.events.includes(d)||a.events.includes("payment.*")){const h=t.min+Math.random()*(t.max-t.min);if(Math.random()>.05)a.successCount=(a.successCount||0)+1,a.lastTriggered=e,this.pgMetrics.webhooksTriggered++,o.add(l.id);else{const g=s.initialBackoff;a.pendingRetries.set(l.id,{retryCount:0,nextRetryTime:e+g+h,lastAttemptTime:e}),this.pgMetrics.webhooksFailed++,o.add(l.id)}}}}}updateMetrics(){this.pgMetrics.transactionsTotal=this.transactions.size,this.pgMetrics.transactionsSucceeded=Array.from(this.transactions.values()).filter(d=>d.status==="succeeded").length,this.pgMetrics.transactionsPending=Array.from(this.transactions.values()).filter(d=>d.status==="pending"||d.status==="processing").length,this.pgMetrics.transactionsFailed=Array.from(this.transactions.values()).filter(d=>d.status==="failed").length,this.pgMetrics.transactionsRefunded=Array.from(this.transactions.values()).filter(d=>d.status==="refunded").length;const e=Array.from(this.transactions.values());if(this.pgMetrics.totalAmount=e.reduce((d,h)=>d+h.amount,0),this.pgMetrics.totalAmountSucceeded=e.filter(d=>d.status==="succeeded").reduce((d,h)=>d+h.amount,0),this.pgMetrics.totalAmountRefunded=e.filter(d=>d.refundedAmount).reduce((d,h)=>d+(h.refundedAmount||0),0),this.pgMetrics.transactionsTotal>0&&(this.pgMetrics.averageAmount=this.pgMetrics.totalAmount/this.pgMetrics.transactionsTotal),this.pgMetrics.transactionsTotal>0&&(this.pgMetrics.successRate=this.pgMetrics.transactionsSucceeded/this.pgMetrics.transactionsTotal,this.pgMetrics.failureRate=this.pgMetrics.transactionsFailed/this.pgMetrics.transactionsTotal,this.pgMetrics.refundRate=this.pgMetrics.transactionsRefunded/this.pgMetrics.transactionsSucceeded||0),this.pgMetrics.fraudDetected=Array.from(this.transactions.values()).filter(d=>d.status==="failed"&&d.metadata?.fraudDetected).length,this.requestHistory.length>0){const d=this.requestHistory.slice(-100),h=1e4,p=Date.now()-h,g=d.filter(v=>v.timestamp>=p);this.pgMetrics.requestsPerSecond=g.length/(h/1e3),this.pgMetrics.averageResponseTime=d.reduce((v,b)=>v+b.latency,0)/d.length,this.pgMetrics.errorRate=d.filter(v=>!v.success).length/d.length}const t=this.config?.requestsPerSecond||50;this.pgMetrics.apiUtilization=Math.min(1,this.pgMetrics.requestsPerSecond/t);const s=1e3;this.pgMetrics.processingUtilization=Math.min(1,this.pgMetrics.transactionsPending/s),this.pgMetrics.webhooksTotal=this.webhooks.size,this.pgMetrics.webhooksEnabled=Array.from(this.webhooks.values()).filter(d=>d.enabled).length,this.metricsByPaymentMethod.clear();const n=new Map;for(const d of e){const h=d.paymentMethod;n.has(h)||n.set(h,{count:0,successCount:0,failedCount:0,totalAmount:0});const p=n.get(h);p.count++,p.totalAmount+=d.amount,d.status==="succeeded"?p.successCount++:d.status==="failed"&&p.failedCount++}for(const[d,h]of n.entries())this.metricsByPaymentMethod.set(d,{count:h.count,successCount:h.successCount,failedCount:h.failedCount,successRate:h.count>0?h.successCount/h.count:0,avgAmount:h.count>0?h.totalAmount/h.count:0,totalAmount:h.totalAmount});this.metricsByCurrency.clear();const i=new Map;for(const d of e){const h=d.currency;i.has(h)||i.set(h,{count:0,totalAmount:0});const p=i.get(h);p.count++,p.totalAmount+=d.amount}for(const[d,h]of i.entries())this.metricsByCurrency.set(d,{count:h.count,totalAmount:h.totalAmount,avgAmount:h.count>0?h.totalAmount/h.count:0});this.pgMetrics.conversionFunnel={pending:Array.from(this.transactions.values()).filter(d=>d.status==="pending").length,processing:Array.from(this.transactions.values()).filter(d=>d.status==="processing").length,succeeded:this.pgMetrics.transactionsSucceeded,failed:this.pgMetrics.transactionsFailed,refunded:this.pgMetrics.transactionsRefunded};const a=Array.from(this.transactions.values()).filter(d=>d.status==="succeeded"),o=a.filter(d=>d.metadata?.chargeback||d.metadata?.disputeType==="chargeback").length;this.pgMetrics.chargebackRate=a.length>0?o/a.length:0;const l=Array.from(this.transactions.values()).filter(d=>d.metadata?.dispute||d.metadata?.disputeType).length;this.pgMetrics.disputeRate=this.pgMetrics.transactionsTotal>0?l/this.pgMetrics.transactionsTotal:0,this.processingTimes.length>0?this.pgMetrics.averageProcessingTime=this.processingTimes.reduce((d,h)=>d+h,0)/this.processingTimes.length:this.pgMetrics.averageProcessingTime=0}getMetrics(){return{...this.pgMetrics}}getMetricsByPaymentMethod(){return new Map(this.metricsByPaymentMethod)}getMetricsByCurrency(){return new Map(this.metricsByCurrency)}getTransactions(){return Array.from(this.transactions.values())}getWebhooks(){return Array.from(this.webhooks.values())}addTransaction(e){this.transactions.set(e.id,e),(e.status==="pending"||e.status==="processing")&&this.pendingTransactions.add(e.id),this.updateMetrics()}updateTransaction(e,t){const s=this.transactions.get(e);if(s){const n=s.status;this.transactions.set(e,{...s,...t}),(n==="pending"||n==="processing")&&this.pendingTransactions.delete(e),(t.status==="pending"||t.status==="processing")&&this.pendingTransactions.add(e),this.updateMetrics()}}removeTransaction(e){this.transactions.delete(e),this.pendingTransactions.delete(e),this.updateMetrics()}addWebhook(e){this.webhooks.set(e.id,{...e,successCount:e.successCount||0,failureCount:e.failureCount||0,pendingRetries:e.pendingRetries||new Map}),this.updateMetrics()}updateWebhook(e,t){const s=this.webhooks.get(e);s&&(this.webhooks.set(e,{...s,...t}),this.updateMetrics())}removeWebhook(e){this.webhooks.delete(e),this.updateMetrics()}getConfig(){return this.config}updateConfig(e){this.config&&(this.config={...this.config,...e},e.transactions!==void 0&&this.initializeTransactions(),e.webhooks!==void 0&&this.initializeWebhooks())}getNewTransactionsForDataFlow(){const e=[];for(const t of this.transactions.values())this.sentTransactionIds.has(t.id)||(e.push(t),this.sentTransactionIds.add(t.id));return e}getStatusChangedTransactions(){const e=[];for(const t of Array.from(this.statusChangedTransactions)){const s=this.transactions.get(t);s&&e.push(s)}return this.statusChangedTransactions.clear(),e}resetDataFlowTracking(){this.sentTransactionIds.clear(),this.statusChangedTransactions.clear(),this.lastDataSyncTime=Date.now()}processIncomingData(e){if(!this.config)return{processed:!1,error:"Configuration not initialized"};try{const t=e.payload,s=e.metadata?.sourceType||e.source;let n=!1,i=!1,a=!1;if(s==="crm"||t?.type==="contact"||t?.operation==="update"){const o=t?.data||t,l=o?.customerId||o?.id;if(l){a=!0;const d=o?.totalSpent>0||o?.paymentCount>0,h=o?.status==="vip"||o?.value>1e4;this.customerInfoCache||(this.customerInfoCache=new Map),this.customerInfoCache.set(l,{hasPaymentHistory:d,isVipCustomer:h,totalSpent:o?.totalSpent||0,lastUpdated:Date.now()})}}if(s==="erp"||t?.type==="financial_transaction"||t?.operation==="create"){const o=t?.data||t,l=o?.transactionLimit,d=o?.dailyLimit;(l!==void 0||d!==void 0)&&(this.transactionLimits?(l!==void 0&&(this.transactionLimits.maxTransactionAmount=l),d!==void 0&&(this.transactionLimits.dailyLimit=d),this.transactionLimits.lastUpdated=Date.now()):this.transactionLimits={maxTransactionAmount:l||1e4,dailyLimit:d||5e4,lastUpdated:Date.now()},i=!0)}if(s==="fraud-detection"||t?.type==="fraud_check"||t?.event==="fraud.detected"){const o=t?.data||t,l=o?.transactionId||o?.id,d=o?.fraudScore,h=o?.isFraud||o?.fraudulent;if(l&&this.transactions.has(l)){const p=this.transactions.get(l);p.metadata||(p.metadata={}),p.metadata.fraudCheck={score:d,isFraud:h,checkedAt:Date.now(),source:"external"},h&&p.status==="pending"&&(p.status="failed",p.metadata.failureReason="fraud_detected",this.pgMetrics.fraudDetected++,this.pgMetrics.transactionsFailed++,this.pgMetrics.transactionsPending--),n=!0}}return{processed:!0,fraudScoreUpdated:n,transactionLimitUpdated:i,customerInfoUpdated:a}}catch(t){return{processed:!1,error:t instanceof Error?t.message:"Unknown error"}}}formatTransactionForTarget(e,t){if(["postgres","mongodb","cassandra","clickhouse","snowflake","elasticsearch","redis"].includes(t))return{operation:"insert",collection:"transactions",table:t==="postgres"?"transactions":void 0,document:{id:e.id,amount:e.amount,currency:e.currency,status:e.status,paymentMethod:e.paymentMethod,customerId:e.customerId,timestamp:new Date(e.timestamp).toISOString(),description:e.description,fee:e.fee,refundedAmount:e.refundedAmount,metadata:e.metadata}};if(t==="crm")return{operation:"update",type:"contact",data:{customerId:e.customerId,paymentInfo:{transactionId:e.id,amount:e.amount,currency:e.currency,status:e.status,paymentMethod:e.paymentMethod,timestamp:new Date(e.timestamp).toISOString()},lastPaymentDate:new Date(e.timestamp).toISOString(),totalSpent:e.amount}};if(t==="erp")return{operation:"create",type:"financial_transaction",data:{transactionId:e.id,amount:e.amount,currency:e.currency,status:e.status,paymentMethod:e.paymentMethod,customerId:e.customerId,timestamp:new Date(e.timestamp).toISOString(),fee:e.fee,netAmount:e.amount-(e.fee||0),refundedAmount:e.refundedAmount,description:e.description}};if(["kafka","rabbitmq","redis-streams"].includes(t)){const a=`payment.${e.status}`;return{event:a,eventType:a,data:{id:e.id,amount:e.amount,currency:e.currency,status:e.status,paymentMethod:e.paymentMethod,customerId:e.customerId,timestamp:new Date(e.timestamp).toISOString(),description:e.description,fee:e.fee,refundedAmount:e.refundedAmount,metadata:e.metadata},timestamp:new Date(e.timestamp).toISOString()}}return["bigquery","redshift"].includes(t)?{operation:"insert",dataset:"payments",table:"transactions",data:{transaction_id:e.id,amount:e.amount,currency:e.currency,status:e.status,payment_method:e.paymentMethod,customer_id:e.customerId,timestamp:new Date(e.timestamp).toISOString(),description:e.description,fee:e.fee,refunded_amount:e.refundedAmount}}:{operation:"process",type:"transaction",data:{id:e.id,amount:e.amount,currency:e.currency,status:e.status,paymentMethod:e.paymentMethod,customerId:e.customerId,timestamp:new Date(e.timestamp).toISOString(),description:e.description,fee:e.fee,refundedAmount:e.refundedAmount,metadata:e.metadata}}}}class aA{nodes=[];connections=[];metrics=new Map;connectionMetrics=new Map;isRunning=!1;simulationTime=0;baseTime=Date.now();pausedTime=0;updateInterval=100;intervalId=null;latencyHistory=new Map;connectionLatencyHistory=new Map;HISTORY_SIZE=500;protocolTransformer=new Rb;rabbitMQRoutingEngines=new Map;lastRabbitMQUpdate=new Map;activeMQRoutingEngines=new Map;lastActiveMQUpdate=new Map;sqsRoutingEngines=new Map;lastSQSUpdate=new Map;azureServiceBusRoutingEngines=new Map;lastAzureServiceBusUpdate=new Map;azureServiceBusConfigHash=new Map;pubSubRoutingEngines=new Map;lastPubSubUpdate=new Map;kafkaRoutingEngines=new Map;lastKafkaUpdate=new Map;kongRoutingEngines=new Map;cloudAPIGatewayEngines=new Map;nginxRoutingEngines=new Map;haproxyRoutingEngines=new Map;envoyRoutingEngines=new Map;istioRoutingEngines=new Map;serviceMeshRoutingEngines=new Map;apigeeRoutingEngines=new Map;mulesoftRoutingEngines=new Map;graphQLGatewayRoutingEngines=new Map;lastGraphQLGatewayUpdate=new Map;graphQLGatewayStats=new Map;bffRoutingEngines=new Map;restApiRoutingEngines=new Map;grpcRoutingEngines=new Map;webhookRelayRoutingEngines=new Map;webhookEngines=new Map;redisRoutingEngines=new Map;cassandraRoutingEngines=new Map;clickHouseRoutingEngines=new Map;snowflakeRoutingEngines=new Map;elasticsearchRoutingEngines=new Map;s3RoutingEngines=new Map;postgresConnectionPools=new Map;prometheusEngines=new Map;grafanaEngines=new Map;graphQLEngines=new Map;soapEngines=new Map;websocketEngines=new Map;lokiEngines=new Map;jaegerEngines=new Map;otelCollectorEngines=new Map;pagerDutyEngines=new Map;keycloakEngines=new Map;vaultEngines=new Map;wafEngines=new Map;firewallEngines=new Map;vpnEngines=new Map;cdnEngines=new Map;idsIpsEngines=new Map;jenkinsEngines=new Map;gitlabCIEngines=new Map;argoCDEngines=new Map;terraformEngines=new Map;harborEngines=new Map;dockerEngines=new Map;kubernetesEngines=new Map;ansibleEngines=new Map;traefikEngines=new Map;sparkEngines=new Map;tensorFlowServingEngines=new Map;pytorchServeEngines=new Map;featureStoreEngines=new Map;crmEngines=new Map;erpEngines=new Map;paymentGatewayEngines=new Map;constructor(){this.initializeMetrics()}recordGraphQLGatewayRequest(e,t,s){const n=this.graphQLGatewayStats.get(e)||{requestsTotal:0,errorsTotal:0,rateLimitedTotal:0,complexityRejectedTotal:0,federatedRequestCount:0,latencies:[],cacheHitCount:0,cacheMissCount:0,cacheSize:0};n.requestsTotal+=1,t.status>=400&&(n.errorsTotal+=1),t.rateLimited&&(n.rateLimitedTotal+=1),t.complexityRejected&&(n.complexityRejectedTotal+=1),t.federated&&(n.federatedRequestCount+=1),n.latencies.push(t.latency),n.latencies.length>this.HISTORY_SIZE&&n.latencies.shift(),s&&(n.cacheHitCount=s.cacheHitCount,n.cacheMissCount=s.cacheMissCount,n.cacheSize=s.cacheSize),this.graphQLGatewayStats.set(e,n)}calculatePercentile(e,t){if(e.length===0)return 0;const s=t/100*(e.length-1),n=Math.floor(s),i=Math.ceil(s),a=s-n;return n===i?e[n]:e[n]*(1-a)+e[i]*a}updateLatencyPercentiles(e,t,s){let n=this.latencyHistory.get(e);if(n||(n=[],this.latencyHistory.set(e,n)),n.push(t),n.length>this.HISTORY_SIZE&&n.shift(),n.length>0){const i=[...n].sort((a,o)=>a-o);s.latencyP50=this.calculatePercentile(i,50),s.latencyP99=this.calculatePercentile(i,99)}}updateConnectionLatencyPercentiles(e,t,s){let n=this.connectionLatencyHistory.get(e);if(n||(n=[],this.connectionLatencyHistory.set(e,n)),n.push(t),n.length>this.HISTORY_SIZE&&n.shift(),n.length>0){const i=[...n].sort((a,o)=>a-o);s.latencyP50=this.calculatePercentile(i,50),s.latencyP99=this.calculatePercentile(i,99)}}simulateGraphQLGateway(e,t,s,n){const i=this.graphQLGatewayStats.get(e.id),a=this.graphQLGatewayRoutingEngines.get(e.id);if(!a||!n||!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0,s.customMetrics={gatewayRequestsTotal:0,gatewayErrorsTotal:0,gatewayRateLimitedTotal:0,gatewayComplexityRejectedTotal:0,gatewayFederatedRequests:0,gatewayCacheHitCount:0,gatewayCacheMissCount:0,gatewayCacheSize:0};return}const o=i.requestsTotal,l=i.errorsTotal,d=i.latencies.length>0?i.latencies.reduce((g,v)=>g+v,0)/i.latencies.length:0,h=o/10;s.throughput=h,s.latency=d,s.errorRate=o>0?l/o:0,s.utilization=Math.min(h/1e3,1);const p=a.getCacheManager().getMetrics();s.customMetrics={...s.customMetrics||{},gatewayRequestsTotal:o,gatewayErrorsTotal:l,gatewayRateLimitedTotal:i.rateLimitedTotal,gatewayComplexityRejectedTotal:i.complexityRejectedTotal,gatewayFederatedRequests:i.federatedRequestCount,gatewayCacheHitCount:p.cacheHitCount,gatewayCacheMissCount:p.cacheMissCount,gatewayCacheSize:p.cacheSize}}initialize(e,t){this.nodes=e,this.connections=t,this.initializeMetrics(),this.graphQLGatewayStats.clear();for(const s of e){if(s.type==="rabbitmq"&&this.initializeRabbitMQRoutingEngine(s),s.type==="activemq"&&this.initializeActiveMQRoutingEngine(s),s.type==="aws-sqs"&&this.initializeSQSRoutingEngine(s),s.type==="azure-service-bus"&&this.initializeAzureServiceBusRoutingEngine(s),s.type==="gcp-pubsub"&&this.initializePubSubRoutingEngine(s),s.type==="kafka"&&this.initializeKafkaRoutingEngine(s),s.type==="kong"&&this.initializeKongRoutingEngine(s),s.type==="api-gateway"&&this.initializeCloudAPIGatewayEngine(s),s.type==="nginx"&&this.initializeNginxRoutingEngine(s),s.type==="haproxy"&&this.initializeHAProxyRoutingEngine(s),s.type==="envoy"&&this.initializeEnvoyRoutingEngine(s),s.type==="istio"&&this.initializeIstioRoutingEngine(s),s.type==="apigee"&&this.initializeApigeeRoutingEngine(s),s.type==="mulesoft"&&this.initializeMuleSoftRoutingEngine(s),s.type==="graphql-gateway")try{this.initializeGraphQLGatewayRoutingEngine(s)}catch(n){qe.addError(n,{severity:"critical",source:"initialization",componentId:s.id,componentLabel:s.data.label,componentType:s.type,context:{operation:"initializeGraphQLGatewayRoutingEngine"}})}if(s.type==="bff-service"&&this.initializeBFFRoutingEngine(s),s.type==="rest"&&this.initializeRestApiRoutingEngine(s),s.type==="grpc"&&this.initializeGRPCRoutingEngine(s),s.type==="webhook-relay"&&this.initializeWebhookRelayRoutingEngine(s),s.type==="postgres"&&this.initializePostgreSQLConnectionPool(s),s.type==="redis"&&this.initializeRedisRoutingEngine(s),s.type==="cassandra"&&this.initializeCassandraRoutingEngine(s),s.type==="clickhouse"&&this.initializeClickHouseRoutingEngine(s),s.type==="snowflake"&&this.initializeSnowflakeRoutingEngine(s),s.type==="elasticsearch"&&this.initializeElasticsearchRoutingEngine(s),s.type==="s3-datalake"&&this.initializeS3RoutingEngine(s),s.type==="prometheus"&&this.initializePrometheusEngine(s),s.type==="grafana"&&this.initializeGrafanaEngine(s),s.type==="graphql"&&this.initializeGraphQLEngine(s),s.type==="jaeger"&&this.initializeJaegerEngine(s),s.type==="otel-collector"&&this.initializeOpenTelemetryCollectorEngine(s),s.type==="pagerduty"&&this.initializePagerDutyEngine(s),s.type==="keycloak")try{this.initializeKeycloakEngine(s)}catch(n){qe.addError(n,{severity:"critical",source:"initialization",componentId:s.id,componentLabel:s.data.label,componentType:s.type,context:{operation:"initializeKeycloakEngine"}})}if(s.type==="secrets-vault")try{this.initializeVaultEngine(s)}catch(n){qe.addError(n,{severity:"critical",source:"initialization",componentId:s.id,componentLabel:s.data.label,componentType:s.type,context:{operation:"initializeVaultEngine"}})}if(s.type==="waf")try{this.initializeWAFEngine(s)}catch(n){qe.addError(n,{severity:"critical",source:"initialization",componentId:s.id,componentLabel:s.data.label,componentType:s.type,context:{operation:"initializeWAFEngine"}})}if(s.type==="firewall")try{this.initializeFirewallEngine(s)}catch(n){qe.addError(n,{severity:"critical",source:"initialization",componentId:s.id,componentLabel:s.data.label,componentType:s.type,context:{operation:"initializeFirewallEngine"}})}if(s.type==="ids-ips")try{this.initializeIDSIPSEngine(s)}catch(n){qe.addError(n,{severity:"critical",source:"initialization",componentId:s.id,componentLabel:s.data.label,componentType:s.type,context:{operation:"initializeIDSIPSEngine"}})}s.type==="jenkins"&&this.initializeJenkinsEngine(s),s.type==="gitlab-ci"&&this.initializeGitLabCIEngine(s),s.type==="argo-cd"&&this.initializeArgoCDEngine(s),s.type==="terraform"&&this.initializeTerraformEngine(s),s.type==="ansible"&&(this.ansibleEngines.has(s.id)?this.ansibleEngines.get(s.id).updateConfig(s):this.initializeAnsibleEngine(s)),s.type==="spark"&&this.initializeSparkEngine(s),s.type==="harbor"&&(this.harborEngines.has(s.id)?this.harborEngines.get(s.id).updateConfig(s):this.initializeHarborEngine(s)),s.type==="docker"&&(this.dockerEngines.has(s.id)?this.dockerEngines.get(s.id).updateConfig(s):this.initializeDockerEngine(s)),s.type==="kubernetes"&&(this.kubernetesEngines.has(s.id)?this.kubernetesEngines.get(s.id).updateConfig(s):this.initializeKubernetesEngine(s))}for(const s of e)if(s.type==="postgres"){const n=this.postgresConnectionPools.get(s.id);if(n){const i=s.data.config;n.updateConfig({maxConnections:i.maxConnections||100,minConnections:i.minConnections||0,idleTimeout:i.idleTimeout||3e5,maxLifetime:i.maxLifetime||36e5,connectionTimeout:i.connectionTimeout||5e3})}}rs.initialize(e,t)}updateNodesAndConnections(e,t){this.nodes=e,this.connections=t;for(const i of e){if(this.metrics.has(i.id)||this.metrics.set(i.id,this.createDefaultMetrics(i.id,i.type)),i.type==="rabbitmq"&&this.initializeRabbitMQRoutingEngine(i),i.type==="activemq"&&this.initializeActiveMQRoutingEngine(i),i.type==="aws-sqs"&&this.initializeSQSRoutingEngine(i),i.type==="azure-service-bus"&&this.initializeAzureServiceBusRoutingEngine(i),i.type==="kafka"&&this.initializeKafkaRoutingEngine(i),i.type==="gcp-pubsub"&&this.initializePubSubRoutingEngine(i),i.type==="kong"&&this.initializeKongRoutingEngine(i),i.type==="nginx"&&this.initializeNginxRoutingEngine(i),i.type==="haproxy"&&this.initializeHAProxyRoutingEngine(i),i.type==="envoy"&&this.initializeEnvoyRoutingEngine(i),i.type==="istio"&&this.initializeIstioRoutingEngine(i),i.type==="apigee"&&this.initializeApigeeRoutingEngine(i),i.type==="mulesoft"&&this.initializeMuleSoftRoutingEngine(i),i.type==="graphql-gateway")try{this.initializeGraphQLGatewayRoutingEngine(i)}catch(a){qe.addError(a,{severity:"critical",source:"initialization",componentId:i.id,componentLabel:i.data.label,componentType:i.type,context:{operation:"initializeGraphQLGatewayRoutingEngine"}})}if(i.type==="bff-service"&&this.initializeBFFRoutingEngine(i),i.type==="rest"&&this.initializeRestApiRoutingEngine(i),i.type==="grpc"&&this.initializeGRPCRoutingEngine(i),i.type==="graphql"&&(this.graphQLEngines.has(i.id)?this.graphQLEngines.get(i.id).updateConfig(i.data.config||{}):this.initializeGraphQLEngine(i)),i.type==="soap"&&(this.soapEngines.has(i.id)?this.soapEngines.get(i.id).updateConfig(i.data.config||{}):this.initializeSOAPEngine(i)),i.type==="websocket"&&(this.websocketEngines.has(i.id)?this.websocketEngines.get(i.id).updateConfig(i.data.config||{}):this.initializeWebSocketEngine(i)),i.type==="webhook-relay"&&this.initializeWebhookRelayRoutingEngine(i),i.type==="webhook"&&(this.webhookEngines.has(i.id)?this.webhookEngines.get(i.id).updateConfig(i.data.config||{}):this.initializeWebhookEngine(i)),i.type==="clickhouse"&&this.initializeClickHouseRoutingEngine(i),i.type==="snowflake"&&this.initializeSnowflakeRoutingEngine(i),i.type==="waf")try{this.wafEngines.has(i.id)?this.wafEngines.get(i.id).initializeConfig(i):this.initializeWAFEngine(i)}catch(a){qe.addError(a,{severity:"critical",source:"initialization",componentId:i.id,componentLabel:i.data.label,componentType:i.type,context:{operation:"initializeWAFEngine"}})}if(i.type==="firewall")try{this.firewallEngines.has(i.id)?this.firewallEngines.get(i.id).initializeConfig(i):this.initializeFirewallEngine(i)}catch(a){qe.addError(a,{severity:"critical",source:"initialization",componentId:i.id,componentLabel:i.data.label,componentType:i.type,context:{operation:"initializeFirewallEngine"}})}if(i.type==="vpn")try{this.vpnEngines.has(i.id)?this.vpnEngines.get(i.id).initializeConfig(i):this.initializeVPNEngine(i)}catch(a){qe.addError(a,{severity:"critical",source:"initialization",componentId:i.id,componentLabel:i.data.label,componentType:i.type,context:{operation:"initializeVPNEngine"}})}if(i.type==="ids-ips")try{this.idsIpsEngines.has(i.id)?this.idsIpsEngines.get(i.id).initializeConfig(i):this.initializeIDSIPSEngine(i)}catch(a){qe.addError(a,{severity:"critical",source:"initialization",componentId:i.id,componentLabel:i.data.label,componentType:i.type,context:{operation:"initializeIDSIPSEngine"}})}if(i.type==="jenkins"&&(this.jenkinsEngines.has(i.id)?this.jenkinsEngines.get(i.id).updateConfig(i):this.initializeJenkinsEngine(i)),i.type==="gitlab-ci"&&(this.gitlabCIEngines.has(i.id)?this.gitlabCIEngines.get(i.id).updateConfig(i):this.initializeGitLabCIEngine(i)),i.type==="argo-cd"&&(this.argoCDEngines.has(i.id)?this.argoCDEngines.get(i.id).initializeConfig(i):this.initializeArgoCDEngine(i)),i.type==="terraform"&&(this.terraformEngines.has(i.id)?this.terraformEngines.get(i.id).updateConfig(i):this.initializeTerraformEngine(i)),i.type==="ansible"&&(this.ansibleEngines.has(i.id)?this.ansibleEngines.get(i.id).updateConfig(i):this.initializeAnsibleEngine(i)),i.type==="spark"&&(this.sparkEngines.has(i.id)?this.sparkEngines.get(i.id).updateConfig(i):this.initializeSparkEngine(i)),i.type==="crm"&&(this.crmEngines.has(i.id)?this.crmEngines.get(i.id).initializeConfig(i):this.initializeCRMEngine(i)),i.type==="erp"&&(this.erpEngines.has(i.id)?this.erpEngines.get(i.id).initializeConfig(i):this.initializeERPEngine(i)),i.type==="payment-gateway"&&(this.paymentGatewayEngines.has(i.id)?this.paymentGatewayEngines.get(i.id).initializeConfig(i):this.initializePaymentGatewayEngine(i)),i.type==="tensorflow-serving"&&(this.tensorFlowServingEngines.has(i.id)?this.tensorFlowServingEngines.get(i.id).initializeConfig(i):this.initializeTensorFlowServingEngine(i)),i.type==="pytorch-serve"&&(this.pytorchServeEngines.has(i.id)?this.pytorchServeEngines.get(i.id).initializeConfig(i):this.initializePyTorchServeEngine(i)),i.type==="feature-store"&&(this.featureStoreEngines.has(i.id)?this.featureStoreEngines.get(i.id).initializeConfig(i):this.initializeFeatureStoreEngine(i)),i.type==="traefik"&&(this.traefikEngines.has(i.id)?this.traefikEngines.get(i.id).updateConfig(i):this.initializeTraefikEngine(i)),i.type==="cdn")try{this.cdnEngines.has(i.id)?this.cdnEngines.get(i.id).initializeConfig(i):this.initializeCDNEngine(i)}catch(a){qe.addError(a,{severity:"critical",source:"initialization",componentId:i.id,componentLabel:i.data.label,componentType:i.type,context:{operation:"initializeCDNEngine"}})}}const s=new Set(e.map(i=>i.id));for(const[i]of this.metrics.entries())s.has(i)||(this.metrics.delete(i),this.rabbitMQRoutingEngines.delete(i),this.activeMQRoutingEngines.delete(i),this.sqsRoutingEngines.delete(i),this.azureServiceBusRoutingEngines.delete(i),this.kafkaRoutingEngines.delete(i),this.pubSubRoutingEngines.delete(i),this.kongRoutingEngines.delete(i),this.nginxRoutingEngines.delete(i),this.haproxyRoutingEngines.delete(i),this.envoyRoutingEngines.delete(i),this.istioRoutingEngines.delete(i),this.apigeeRoutingEngines.delete(i),this.mulesoftRoutingEngines.delete(i),this.graphQLGatewayRoutingEngines.delete(i),this.bffRoutingEngines.delete(i),this.restApiRoutingEngines.delete(i),this.grpcRoutingEngines.delete(i),this.webhookRelayRoutingEngines.delete(i),this.redisRoutingEngines.delete(i),this.cassandraRoutingEngines.delete(i),this.clickHouseRoutingEngines.delete(i),this.snowflakeRoutingEngines.delete(i),this.elasticsearchRoutingEngines.delete(i),this.s3RoutingEngines.delete(i),this.graphQLGatewayRoutingEngines.delete(i),this.keycloakEngines.delete(i),this.vaultEngines.delete(i),this.wafEngines.delete(i),this.firewallEngines.delete(i),this.vpnEngines.delete(i),this.cdnEngines.delete(i),this.idsIpsEngines.delete(i),this.jenkinsEngines.delete(i),this.gitlabCIEngines.delete(i),this.argoCDEngines.delete(i),this.terraformEngines.delete(i),this.ansibleEngines.delete(i),this.traefikEngines.delete(i),this.sparkEngines.delete(i),this.tensorFlowServingEngines.delete(i),this.pytorchServeEngines.delete(i),this.featureStoreEngines.delete(i),this.crmEngines.delete(i),this.erpEngines.delete(i),this.paymentGatewayEngines.delete(i),this.harborEngines.delete(i),this.prometheusEngines.delete(i),this.grafanaEngines.delete(i),this.graphQLEngines.delete(i),this.soapEngines.delete(i),this.websocketEngines.delete(i),this.lokiEngines.delete(i),this.jaegerEngines.delete(i),this.lastRabbitMQUpdate.delete(i),this.lastActiveMQUpdate.delete(i),this.lastSQSUpdate.delete(i),this.lastAzureServiceBusUpdate.delete(i),this.lastPubSubUpdate.delete(i),this.lastGraphQLGatewayUpdate.delete(i));for(const i of t)this.connectionMetrics.has(i.id)||this.connectionMetrics.set(i.id,this.createDefaultConnectionMetrics(i));const n=new Set(t.map(i=>i.id));for(const[i]of this.connectionMetrics.entries())n.has(i)||this.connectionMetrics.delete(i);rs.updateNodesAndConnections(e,t)}start(){if(console.log("EmulationEngine.start() called",{isRunning:this.isRunning,hasInterval:!!this.intervalId}),this.isRunning&&!this.intervalId&&(console.log("Inconsistent state detected: isRunning=true but no interval, stopping first..."),this.stop()),this.isRunning){console.log("Already running, returning early");return}console.log("Setting isRunning to true and creating interval..."),this.isRunning=!0,this.baseTime=Date.now()-this.pausedTime,console.log("Starting data flow engine..."),rs.start(),console.log("Creating simulation interval..."),this.intervalId=setInterval(()=>{try{this.simulate()}catch(e){console.error("Error in simulation step:",e),qe.addError(e,{severity:"critical",source:"emulation-engine",context:{simulationTime:this.simulationTime}})}},this.updateInterval),console.log("EmulationEngine.start() complete",{intervalId:!!this.intervalId})}stop(){this.isRunning&&(this.isRunning=!1,this.pausedTime=this.simulationTime,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),rs.stop())}resetSimulation(){this.stop(),this.simulationTime=0,this.pausedTime=0,this.baseTime=Date.now(),this.initializeMetrics()}simulate(){this.simulationTime=Date.now()-this.baseTime;const e=Date.now();for(const[s,n]of this.rabbitMQRoutingEngines.entries()){const i=this.lastRabbitMQUpdate.get(s)||e,a=e-i;a>0&&(n.processConsumption(a),this.lastRabbitMQUpdate.set(s,e))}for(const[s,n]of this.activeMQRoutingEngines.entries()){const i=this.lastActiveMQUpdate.get(s)||e,a=e-i;a>0&&(n.processConsumption(a),this.lastActiveMQUpdate.set(s,e))}for(const[s,n]of this.sqsRoutingEngines.entries()){const i=this.lastSQSUpdate.get(s)||e,a=e-i;a>0&&(n.processConsumption(a),this.lastSQSUpdate.set(s,e))}for(const[s,n]of this.azureServiceBusRoutingEngines.entries()){const i=this.lastAzureServiceBusUpdate.get(s)||e,a=e-i;a>0&&(n.processConsumption(a),this.lastAzureServiceBusUpdate.set(s,e))}for(const[s,n]of this.pubSubRoutingEngines.entries()){const i=this.lastPubSubUpdate.get(s)||e,a=e-i;a>0&&(n.processConsumption(a),this.lastPubSubUpdate.set(s,e))}for(const s of this.nodes)this.updateComponentMetrics(s);try{ga.analyze(this.nodes,this.metrics,this.connectionMetrics,[])}catch(s){qe.addError(s,{severity:"critical",source:"alert-system",context:{operation:"analyze"}})}const t=ga.getAlerts();for(const[s,n]of this.pagerDutyEngines.entries())n.processAlerts(e,t),n.advanceTime(e);for(const[s,n]of this.prometheusEngines.entries())n.performScraping(e,this.nodes,this.metrics);for(const[s,n]of this.grafanaEngines.entries()){const i=this.nodes.find(a=>a.id===s);if(i){const a=this.isPrometheusAvailableForGrafana(i),o=this.createLokiQueryExecutor(i);n.performUpdate(e,a,o)}}for(const[s,n]of this.lokiEngines.entries())n.performRetention(e);for(const[s,n]of this.jaegerEngines.entries())n.performCleanup(e);for(const[s,n]of this.jenkinsEngines.entries())try{const i=this.nodes.find(l=>l.id===s);n.performUpdate(e);const a=n.calculateComponentMetrics(),o=this.metrics.get(s);o&&a&&(o.throughput=a.throughput||o.throughput,o.latency=a.latency||o.latency,o.utilization=(a.utilization||0)/100,o.errorRate=(a.errorRate||0)/100,o.timestamp=e)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"jenkins",operation:"performUpdate"}})}for(const[s,n]of this.gitlabCIEngines.entries())try{const i=this.nodes.find(l=>l.id===s);n.performUpdate(e);const a=n.getMetrics(),o=this.metrics.get(s);if(o&&a){o.throughput=a.pipelinesPerHour/3600,o.latency=a.averagePipelineDuration||0;const l=a.pipelinesSuccess+a.pipelinesFailed;o.errorRate=l>0?a.pipelinesFailed/l:0,o.utilization=a.pipelinesTotal>0?a.pipelinesRunning/a.pipelinesTotal:0,o.customMetrics={pipelinesTotal:a.pipelinesTotal,pipelinesRunning:a.pipelinesRunning,jobsRunning:a.jobsRunning,runnersOnline:a.runnersOnline}}}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"gitlab-ci",operation:"performUpdate"}})}for(const[s,n]of this.argoCDEngines.entries())try{const i=this.nodes.find(l=>l.id===s);n.performUpdate(e);const a=n.getMetrics(),o=this.metrics.get(s);if(o&&a){o.throughput=a.syncRate/3600,o.latency=a.averageSyncDuration||0;const l=a.syncOperationsSuccess+a.syncOperationsFailed;o.errorRate=l>0?a.syncOperationsFailed/l:0,o.utilization=a.applicationsTotal>0?a.syncOperationsRunning/a.applicationsTotal:0,o.customMetrics={applicationsTotal:a.applicationsTotal,applicationsSynced:a.applicationsSynced,applicationsOutOfSync:a.applicationsOutOfSync,syncOperationsRunning:a.syncOperationsRunning,repositoriesConnected:a.repositoriesConnected}}}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"argo-cd",operation:"performUpdate"}})}for(const[s,n]of this.harborEngines.entries())try{if(!this.nodes.find(o=>o.id===s))continue;const a=this.connections.some(o=>o.target===s);n.performUpdate(e,a)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"harbor",operation:"performUpdate"}})}for(const[s,n]of this.dockerEngines.entries())try{if(!this.nodes.find(o=>o.id===s))continue;const a=this.connections.some(o=>o.target===s);n.performUpdate(e,a)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"docker",operation:"performUpdate"}})}for(const[s,n]of this.kubernetesEngines.entries())try{if(!this.nodes.find(a=>a.id===s))continue;n.simulateStep()}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"kubernetes",operation:"simulateStep"}})}for(const[s,n]of this.ansibleEngines.entries())try{if(!this.nodes.find(l=>l.id===s))continue;n.performUpdate(e);const a=n.getMetrics(),o=this.metrics.get(s);o&&a&&(o.throughput=a.jobsPerHour/3600,o.latency=a.averageJobDuration*1e3)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"ansible",operation:"performUpdate"}})}for(const[s,n]of this.sparkEngines.entries())try{if(!this.nodes.find(a=>a.id===s))continue;n.performUpdate(e)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"spark",operation:"performUpdate"}})}for(const[s,n]of this.tensorFlowServingEngines.entries())try{if(!this.nodes.find(o=>o.id===s))continue;const a=this.connections.some(o=>o.target===s);n.performUpdate(e,a)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"tensorflow-serving",operation:"performUpdate"}})}for(const[s,n]of this.pytorchServeEngines.entries())try{if(!this.nodes.find(o=>o.id===s))continue;const a=this.connections.some(o=>o.target===s);n.performUpdate(e,a)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"pytorch-serve",operation:"performUpdate"}})}for(const[s,n]of this.featureStoreEngines.entries())try{if(!this.nodes.find(o=>o.id===s))continue;const a=this.connections.some(o=>o.target===s);n.performUpdate(e,a)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"feature-store",operation:"performUpdate"}})}for(const[s,n]of this.crmEngines.entries())try{if(!this.nodes.find(o=>o.id===s))continue;const a=this.connections.some(o=>o.target===s);n.performUpdate(e,a)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"crm",operation:"performUpdate"}})}for(const[s,n]of this.erpEngines.entries())try{if(!this.nodes.find(o=>o.id===s))continue;const a=this.connections.some(o=>o.target===s);n.performUpdate(e,a)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"erp",operation:"performUpdate"}})}for(const[s,n]of this.paymentGatewayEngines.entries())try{if(!this.nodes.find(l=>l.id===s))continue;const a=this.connections.some(l=>l.target===s),o=this.connections.filter(l=>l.target===s).length;n.performUpdate(e,a,o)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"payment-gateway",operation:"performUpdate"}})}for(const[s,n]of this.otelCollectorEngines.entries())try{const i=this.nodes.find(a=>a.id===s)}catch(i){const a=this.nodes.find(o=>o.id===s);qe.addError(i,{severity:"warning",source:"component-engine",componentId:s,componentLabel:a?.data.label,componentType:a?.type,context:{engine:"opentelemetry",operation:"processBatchFlush"}})}for(const s of this.connections)try{this.updateConnectionMetrics(s)}catch(n){qe.addError(n,{severity:"warning",source:"emulation-engine",context:{operation:"updateConnectionMetrics",connectionId:s.id}})}}updateComponentMetrics(e){const t=e.data.config||{},s=this.metrics.get(e.id)||this.createDefaultMetrics(e.id,e.type),n=this.connections.some(l=>l.target===e.id),i=this.connections.some(l=>l.source===e.id);if(!(n||i))s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0,s.customMetrics={};else switch(e.type){case"kafka":this.simulateKafka(e,t,s,n);break;case"rabbitmq":this.simulateRabbitMQ(e,t,s,n);break;case"activemq":this.simulateActiveMQ(e,t,s,n);break;case"aws-sqs":this.simulateSQS(e,t,s,n);break;case"azure-service-bus":this.simulateAzureServiceBus(e,t,s,n);break;case"gcp-pubsub":this.simulatePubSub(e,t,s,n);break;case"postgres":case"mongodb":case"redis":case"cassandra":this.simulateDatabase(e,t,s,n);break;case"nginx":this.simulateNginx(e,t,s,n);break;case"haproxy":this.simulateHAProxy(e,t,s,n);break;case"traefik":this.simulateTraefik(e,t,s,n);break;case"envoy":this.simulateEnvoy(e,t,s,n);break;case"istio":this.simulateIstio(e,t,s,n);break;case"service-mesh":this.simulateServiceMesh(e,t,s,n);break;case"docker":this.simulateDocker(e,t,s,n);break;case"kubernetes":this.simulateKubernetes(e,t,s,n);break;case"kong":this.simulateKong(e,t,s,n);break;case"api-gateway":this.simulateAPIGateway(e,t,s,n);break;case"apigee":this.simulateApigee(e,t,s,n);break;case"mulesoft":this.simulateMuleSoft(e,t,s,n);break;case"bff-service":this.simulateBFF(e,t,s,n);break;case"prometheus":this.simulatePrometheus(e,t,s,n);break;case"grafana":this.simulateGrafana(e,t,s,n);break;case"loki":this.simulateLoki(e,t,s,n);break;case"keycloak":this.simulateKeycloak(e,t,s,n);break;case"secrets-vault":this.simulateVault(e,t,s,n);break;case"pagerduty":this.simulatePagerDuty(e,t,s,n);break;case"waf":this.simulateWAF(e,t,s,n);break;case"firewall":this.simulateFirewall(e,t,s,n);break;case"vpn":this.simulateVPN(e,t,s,n);break;case"cdn":this.simulateCDN(e,t,s,n);break;case"ids-ips":this.simulateIDSIPS(e,t,s,n);break;case"argo-cd":this.simulateArgoCD(e,t,s,n);break;case"terraform":this.simulateTerraform(e,t,s,n);break;case"ansible":this.simulateAnsible(e,t,s,n);break;case"harbor":this.simulateHarbor(e,t,s,n);break;case"docker":this.simulateDocker(e,t,s,n);break;case"spark":this.simulateSpark(e,t,s,n);break;case"tensorflow-serving":this.simulateTensorFlowServing(e,t,s,n);break;case"pytorch-serve":this.simulatePyTorchServe(e,t,s,n);break;case"feature-store":this.simulateFeatureStore(e,t,s,n);break;case"crm":this.simulateCRM(e,t,s,n);break;case"erp":this.simulateERP(e,t,s,n);break;case"payment-gateway":this.simulatePaymentGateway(e,t,s,n);break;case"graphql-gateway":this.simulateGraphQLGateway(e,t,s,n);break}this.applyCascadeEffects(e,s);const o=wo.applyStateEffects(e.id,{throughput:s.throughput,latency:s.latency,errorRate:s.errorRate,utilization:s.utilization});s.throughput=o.throughput,s.latency=o.latency,s.errorRate=o.errorRate,s.utilization=o.utilization,this.updateLatencyPercentiles(e.id,s.latency,s),s.timestamp=Date.now(),this.metrics.set(e.id,s)}applyCascadeEffects(e,t){const s=this.connections.filter(h=>h.target===e.id);if(s.length===0)return;let n=0,i=0,a=0;const o=t.latency;for(const h of s){const p=this.metrics.get(h.source),g=this.connectionMetrics.get(h.id);if(!p||!g)continue;const v=g.throughputDependency||.5;a+=v;const b=p.errorRate*v*.3;n+=b*v;const x=Math.min(p.latency,500)*v*.2;i+=x*v,(p.errorRate>.5||p.utilization>.95)&&(n+=.1*v,i+=100*v)}a>0&&(n/=a,i/=a),i=Math.min(i,500),t.errorRate=Math.min(1,t.errorRate+n),t.latency=o+i;const d=1e4;t.latency=Math.min(t.latency,d),i>50&&(t.utilization=Math.min(1,t.utilization+.1)),n>.1&&(t.throughput=t.throughput*(1-n*.5))}updateConnectionMetrics(e){const t=this.metrics.get(e.source),s=this.metrics.get(e.target);if(!t||!s)return;const n=this.connectionMetrics.get(e.id)||{id:e.id,source:e.source,target:e.target,traffic:0,latency:0,errorRate:0,utilization:0,timestamp:Date.now(),throughputDependency:0,backpressure:0,bottleneck:!1,effectiveThroughput:0,congestion:0},i=this.nodes.find(l=>l.id===e.source),a=this.nodes.find(l=>l.id===e.target),o=i?.data.config?.avgPayloadSize||1024;n.traffic=t.throughput*o/1024,n.latency=this.calculateConnectionLatency(e,t,s),n.errorRate=t.errorRate*.1,this.calculateInteractionMetrics(e,n,t,s,i,a),this.updateConnectionLatencyPercentiles(e.id,n.latency,n),n.timestamp=Date.now(),this.connectionMetrics.set(e.id,n)}calculateInteractionMetrics(e,t,s,n,i,a){const o=e.data||{},d=(o.bandwidthMbps||1e3)*1024*1024/8;this.getComponentCapacity(i);const h=this.getComponentCapacity(a),p=s.throughput,g=i?.data.config?.avgPayloadSize||1024,v=p*g,b=Math.min(v,d),M=h*g,x=Math.min(b,M);t.effectiveThroughput=x/g;const T=this.connections.filter(F=>F.target===e.target).reduce((F,Y)=>{const ae=this.metrics.get(Y.source);return F+(ae?.throughput||0)},0);t.throughputDependency=T>0?p/T:0;const E=n.utilization,A=v/d,k=p/h,D=(o.packetLossPercent||0)/100;t.backpressure=Math.min(1,E*.4+A*.3+k*.2+D*.1);const L=v>d*.8,I=p>h*.8,U=t.backpressure>.7;t.bottleneck=L||I||U;const Q=this.getBaseLatency(e.type),se=Math.max(0,t.latency-Q)/Q;t.congestion=Math.min(1,A*.4+se*.3+D*.3),t.utilization=Math.min(1,t.effectiveThroughput/h)}getComponentCapacity(e){if(!e)return 1e3;const t=e.data.config||{};switch(e.type){case"kafka":case"rabbitmq":case"activemq":return t.throughputMsgs||1e3;case"postgres":case"mongodb":case"redis":return t.maxConnections?t.maxConnections*10:1e3;case"nginx":case"haproxy":case"rest":case"grpc":case"websocket":return t.requestsPerSecond||1e3;case"docker":case"kubernetes":return(t.workerThreads||1)*500;default:return 1e3}}getBaseLatency(e){return{sync:5,async:2,http:10,grpc:5,websocket:3}[e]||10}simulateKafka(e,t,s,n){this.kafkaRoutingEngines.has(e.id)||this.initializeKafkaRoutingEngine(e);const i=this.kafkaRoutingEngines.get(e.id),a=e.data.config,o=a?.brokers||["localhost:9092"],l=a?.topics||[],d=a?.consumerGroups||[],h=l.length||t.topicCount||5,p=l.reduce((j,ue)=>j+(ue.partitions||3),0)||t.partitions||3,g=l.length>0?l.reduce((j,ue)=>j+(ue.replication||1),0)/l.length:t.replicationFactor||1,v=Date.now(),b=this.lastKafkaUpdate.get(e.id)||v,M=v-b;if(M>=1e3){i.processRetentionAndCompaction(M),i.checkRebalancing();const ue=e.data.config?.brokers||["localhost:9092"],fe=new Map,ge=s.errorRate||0,pe=s.utilization||0;for(let we=0;we<ue.length;we++){const Re=ge<.3&&pe<.95;fe.set(we,Re)}i.updateBrokerHealth(fe),this.lastKafkaUpdate.set(e.id,v)}const x=this.connections.filter(j=>j.target===e.id);let S=0;for(const j of x){const ue=this.metrics.get(j.source);ue&&(S+=ue.throughput||0)}const T=t.throughputMsgs||Math.max(1e3,S);if(!n&&T<=0){if(s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0,l.length>0)for(const j of l)j.messages=j.messages||0,j.size=j.size||0;for(const j of d)j.lag=0;s.customMetrics={topics:h,partitions:p,replication:Math.round(g*10)/10,brokers:o.length,consumer_groups:d.length,total_lag:0};return}const E=.2*Math.sin(this.simulationTime/1e3);s.throughput=T*(1+E);const A=a?.replicaFetchWaitMaxMs||500,k=a?.replicaSocketTimeoutMs||3e4,D=a?.requestTimeoutMs||3e4,L=3,I=Math.min(p/10,10),U=Math.max(1,(g-1)*(A/250)),Q=Math.max(0,(g-1)*1),se=this.calculateCompressionOverhead(l);if(s.latency=L+I+U+Q+se,o.length>1){const j=Math.min(1,k/3e4),ue=Math.min(5,o.length*.5*j);s.latency+=ue}const F=D>3e4?(D-3e4)/1e4:0;s.latency+=F;const Y=this.calculateUnderReplicatedPartitions(l,o.length),ae=g>1?(g-1)*5e-4:0,de=Y>0?Y*.001:0,z=a?.acls||[];let $=0,q=0;for(const j of x){const ue=this.nodes.find(Re=>Re.id===j.source);if(!ue)continue;const fe=ue.data.config||{},ge=fe.messaging?.producerId||fe.clientId||`User:${ue.id.slice(0,8)}`,pe=fe.messaging?.topic||l[0]?.name||"default-topic";if(!this.checkACLPermission(z,ge,"Topic",pe,"Write")){const Re=this.metrics.get(j.source);Re&&(q+=Re.throughput*.9,$+=.45)}}q>0&&(s.throughput=Math.max(0,s.throughput-q)),s.errorRate=Math.max(0,Math.min(.1,ae+de+$+1e-4));const ee=a?.numNetworkThreads||3,me=a?.numIoThreads||8,N=a?.socketSendBufferBytes||100*1024,J=a?.socketReceiveBufferBytes||100*1024,K=Math.min(2,(N+J)/(200*1024)),ie=Math.round(ee*me*1e3*K),Z=Math.min(1,s.throughput/ie),re=Math.min(1,p/200);s.utilization=Math.min(1,Z*.7+re*.3);for(const j of l){const ue=i.getTopicMetrics(j.name);if(ue)j.messages=ue.messages,j.size=ue.size;else{const fe=t.avgPayloadSize||1024,ge=this.updateInterval/1e3,we=s.throughput/h*ge;j.messages=(j.messages||0)+we;const Re=this.getCompressionRatio(j.config?.compressionType),tt=we*fe*Re;j.size=(j.size||0)+tt}if(j.config?.retentionMs&&j.config.retentionMs>0){const fe=j.config.retentionMs/1e3,pe=topicThroughput*fe;if(j.messages>pe){const we=j.messages-pe;j.messages=pe,j.size=Math.max(0,j.size-we*avgMessageSize*compressionRatio)}}if(j.config?.retentionBytes&&j.config.retentionBytes>0&&j.size>j.config.retentionBytes){const fe=1-j.config.retentionBytes/j.size;j.size=j.config.retentionBytes,j.messages=Math.max(0,j.messages*(1-fe))}if((j.config?.cleanupPolicy==="compact"||j.config?.cleanupPolicy==="delete,compact")&&this.simulationTime%3e5<this.updateInterval){const pe=Math.round(j.messages*.85),we=j.messages-pe;j.messages=pe,j.size=Math.max(0,j.size-we*avgMessageSize*compressionRatio)}if(j.config?.minInsyncReplicas){const fe=j.config.minInsyncReplicas,ge=this.getAverageISRCount(j,o.length);if(ge<fe){const pe=fe-ge;s.errorRate+=pe*.01}}if(j.config?.maxMessageBytes&&avgMessageSize>j.config.maxMessageBytes){const fe=Math.min(.1,(avgMessageSize-j.config.maxMessageBytes)/j.config.maxMessageBytes);s.errorRate+=fe*.5}}let V=0;for(const j of d){const ue=i.getConsumerGroupLag(j.id,j.topic);j.lag=ue,V+=ue;const fe=j.members||1,ge=i.consumerGroups.get(j.id);if(ge&&ge.members!==fe){const pe=l.find(we=>we.name===j.topic);pe&&(i.assignPartitionsToConsumers(j.id,fe,pe.partitions),ge.members=fe)}}s.customMetrics={topics:h,partitions:p,replication:Math.round(g*10)/10,brokers:o.length,consumer_groups:d.length,total_lag:Math.round(V),avg_topic_messages:h>0?Math.round(l.reduce((j,ue)=>j+(ue.messages||0),0)/h):0,total_topic_size_mb:Math.round(l.reduce((j,ue)=>j+(ue.size||0),0)/1024/1024*100)/100,under_replicated_partitions:i.getUnderReplicatedPartitions()}}calculateCompressionOverhead(e){if(e.length===0)return 0;const t={uncompressed:0,gzip:2,snappy:.5,lz4:.3,zstd:1};let s=0,n=0;for(const i of e){const a=i.config?.compressionType||"gzip",o=t[a]||0;o>0&&(s+=o,n++)}return n>0?s/n:0}getCompressionRatio(e){return{uncompressed:1,gzip:.3,snappy:.5,lz4:.4,zstd:.25}[e||"gzip"]||.3}calculateUnderReplicatedPartitions(e,t){let s=0;for(const n of e){const i=n.replication||1,a=n.partitions||1;if(n.partitionInfo&&Array.isArray(n.partitionInfo))for(const o of n.partitionInfo){const l=i;(o.isr?.length||o.replicas?.length||1)<l&&s++}else i>t&&(s+=a*Math.max(0,1-t/i)),Math.random()<.05&&i>1&&(s+=a*.1)}return Math.round(s)}assignPartitionsToConsumers(e,t){if(e===0||t===0)return[];const s=[],n=Math.floor(t/e),i=t%e;let a=0;for(let o=0;o<e;o++){const l=[],d=n+(o<i?1:0);for(let h=0;h<d;h++)a<t&&(l.push(a),a++);s.push({consumerId:o,partitions:l})}return s}consumerGroupMemberCounts=new Map;rebalancingGroups=new Map;isRebalancing(e,t){const s=`${e}:${t}`,n=this.rebalancingGroups.get(s);if(n&&Date.now()<n)return!0;const i=this.getCurrentGroupMembers(e,t),a=this.consumerGroupMemberCounts.get(s);return a!==void 0&&i!==a?(this.rebalancingGroups.set(s,Date.now()+2e3),this.consumerGroupMemberCounts.set(s,i),!0):((a===void 0||i!==a)&&this.consumerGroupMemberCounts.set(s,i),!1)}getCurrentGroupMembers(e,t){const s=this.nodes.find(o=>o.id===e);return s&&(s.data.config?.consumerGroups||[]).find(o=>o.id===t)?.members||0}getAverageISRCount(e,t){if(!e.partitionInfo||!Array.isArray(e.partitionInfo)||e.partitionInfo.length===0){const i=e.replication||1;return Math.min(i,t)*.95}let s=0,n=0;for(const i of e.partitionInfo){const a=i.isr?.length||i.replicas?.length||1;s+=a,n++}return n>0?s/n:1}checkACLPermission(e,t,s,n,i,a){if(!e||e.length===0)return!0;const o=t.includes(":")?t:`User:${t}`,l=e.filter(p=>{const g=p.principal||"";if(g!==o&&g!=="*"&&!o.includes(g)||p.resourceType!==s)return!1;const v=p.resourcePatternType||"Literal",b=p.resourceName||"";let M=!1;switch(v){case"Literal":M=b===n||b==="*";break;case"Prefixed":if(b==="*")M=!0;else if(b.endsWith("*")){const x=b.slice(0,-1);M=n.startsWith(x)}else M=n.startsWith(b);break;case"Match":if(b==="*")M=!0;else{const x=b.replace(/\./g,"\\.").replace(/\*/g,".*");M=new RegExp(`^${x}$`).test(n)}break;default:M=b===n||b==="*"}return!(!M||p.operation!==i&&p.operation!=="All"||p.host&&p.host!=="*"&&a&&p.host!==a)});return l.length===0||l.filter(p=>p.permission==="Deny").length>0?!1:l.filter(p=>p.permission==="Allow").length>0}simulateRabbitMQ(e,t,s,n){this.rabbitMQRoutingEngines.has(e.id)||this.initializeRabbitMQRoutingEngine(e);const i=this.rabbitMQRoutingEngines.get(e.id);if(e.data.config,!n){s.throughput=0,s.latency=2,s.errorRate=0;const E=i.getTotalQueueDepth();s.utilization=Math.min(1,E/1e5);const A=i.getAllQueueMetrics(),k=i.getActiveConnections();s.customMetrics={queue_depth:E,connections:k,replication:t.replicationFactor||1},this.updateQueueMetricsInConfig(e,A);return}const a=this.connections.filter(E=>E.target===e.id);let o=0;for(const E of a){const A=this.connectionMetrics.get(E.id);if(A){const D=A.traffic/1024;o+=D}}const l=t.throughputMsgs||o||1e3,d=t.replicationFactor||1,h=(Math.random()-.5)*.1;s.throughput=l*(1+h);const p=i.getTotalQueueDepth(),g=2,v=Math.min(50,p/1e3);s.latency=g+d*5+v+Math.random()*5;const b=5e-4,M=Math.min(.01,p/1e6);s.errorRate=b+M,s.utilization=Math.min(1,p/1e5);const x=i.getAllQueueMetrics(),S=i.getActiveConnections();let T=0;for(const E of x.values())T+=E.consumers;s.customMetrics={queue_depth:p,connections:S,replication:d,queues:x.size,consumers:T},this.updateQueueMetricsInConfig(e,x)}initializeRabbitMQRoutingEngine(e){const t=e.data.config||{},s=new _E;s.initialize({queues:t.queues||[],exchanges:t.exchanges||[{name:"amq.direct",type:"direct",durable:!0,autoDelete:!1,internal:!1},{name:"amq.topic",type:"topic",durable:!0,autoDelete:!1,internal:!1},{name:"amq.fanout",type:"fanout",durable:!0,autoDelete:!1,internal:!1}],bindings:t.bindings||[],consumptionRate:t.consumptionRate??10,processingTime:t.processingTime??100}),this.rabbitMQRoutingEngines.set(e.id,s),this.lastRabbitMQUpdate.set(e.id,Date.now())}updateQueueMetricsInConfig(e,t){const s=e.data.config||{},n=s.queues||[];for(let i=0;i<n.length;i++){const a=n[i],o=t.get(a.name);o&&(n[i]={...a,messages:o.messages,ready:o.ready,unacked:o.unacked,consumers:o.consumers})}s.queues=n}simulateActiveMQ(e,t,s,n){this.activeMQRoutingEngines.has(e.id)||this.initializeActiveMQRoutingEngine(e);const i=this.activeMQRoutingEngines.get(e.id),a=e.data.config||{},o=a.protocol||"openwire",l=a.persistenceEnabled??!0,d=a.maxConnections||1e3,h=a.memoryLimit||1024;a.avgMessageSize;const p=a.memoryPressureThreshold??.8,g=a.queueLatencyBase||0,v=a.queueLatencyFactor||1,b=i.getStoreUsage(l),M=i.getTempUsage(l);a.storeUsage=b,a.tempUsage=M;const x=a.connections||[];if(!n){s.throughput=0,s.latency=this.getProtocolBaseLatency(o,a.protocolLatencies),s.errorRate=0;const j=i.getTotalQueueDepth(),ue=i.getTotalTopicMessages(),fe=j+ue;s.utilization=Math.min(1,fe/1e5);const ge=i.getAllQueueMetrics(),pe=i.getAllTopicMetrics(),we=i.getActiveConnections();let Re=0;for(const ze of ge.values())Re+=ze.consumerCount;let tt=0;for(const ze of pe.values())tt+=ze.subscriberCount;s.customMetrics={queue_depth:j,topic_messages:ue,connections:we,queues:ge.size,topics:pe.size,consumers:Re,subscribers:tt,memory_usage:b+M,memory_percent:h>0?(b+M)/h*100:0},this.updateActiveMQMetricsInConfig(e,ge,pe);return}const S=this.connections.filter(j=>j.target===e.id);let T=0;for(const j of S){const ue=this.connectionMetrics.get(j.id);if(ue){const ge=ue.traffic/1024;T+=ge}}const E=t.throughputMsgs||T||1e3,A=(Math.random()-.5)*.1;s.throughput=E*(1+A);const k=i.getTotalQueueDepth(),D=i.getTotalTopicMessages(),L=k+D,I=this.getProtocolBaseLatency(o,a.protocolLatencies),U=l?5:0,Q=Math.min(50,g+L/1e3*v),se=h>0&&b+M>h*p?10:0;s.latency=I+U+Q+se+Math.random()*5;const F=a.acls||[];let Y=0,ae=0;for(const j of S){const ue=this.nodes.find(we=>we.id===j.source);if(!ue)continue;const fe=ue.data.config,ge=fe?.messaging||{},pe=fe?.username||fe?.clientId||a.username||`user-${j.source.slice(0,8)}`;if(ge.queue&&!this.checkActiveMQACLPermission(F,pe,`queue://${ge.queue}`,"write")){const Re=this.metrics.get(j.source);Re&&(ae+=Re.throughput*.9,Y+=.45)}if(ge.topic&&!this.checkActiveMQACLPermission(F,pe,`topic://${ge.topic}`,"write")){const Re=this.metrics.get(j.source);Re&&(ae+=Re.throughput*.9,Y+=.45)}}const de=a.queues||[];for(const j of de)j.consumerCount&&j.consumerCount>0&&(this.checkActiveMQACLPermission(F,a.username||"admin",`queue://${j.name}`,"read")||(Y+=.1));const z=5e-4,$=Math.min(.01,L/1e6),q=h>0&&b+M>h?.01:0,ee=x.length>=d?.005:0;ae>0&&(s.throughput=Math.max(0,s.throughput-ae)),s.errorRate=Math.min(1,z+$+q+ee+Y);const me=Math.min(1,L/1e5),N=h>0?Math.min(1,(b+M)/h):0,J=Math.min(1,x.length/d);s.utilization=Math.max(me,N,J);const K=i.getAllQueueMetrics(),ie=i.getAllTopicMetrics(),Z=i.getActiveConnections();let re=0;for(const j of K.values())re+=j.consumerCount;let V=0;for(const j of ie.values())V+=j.subscriberCount;s.customMetrics={queue_depth:k,topic_messages:D,connections:Z,queues:K.size,topics:ie.size,consumers:re,subscribers:V,memory_usage:b+M,memory_percent:h>0?(b+M)/h*100:0,protocol:o},this.updateActiveMQMetricsInConfig(e,K,ie)}checkActiveMQACLPermission(e,t,s,n){if(!e||e.length===0)return!0;const i=e.filter(l=>{const d=l.principal||"";if(d!==t&&d!=="*"&&!t.includes(d))return!1;const h=l.resource||"";let p=!1;if(h==="*"||h===s)p=!0;else if(h.endsWith("*")){const b=h.slice(0,-1);p=s.startsWith(b)}else h.includes("://")?p=h===s:p=s.includes(h);if(!p)return!1;const g=(l.operation||"").toLowerCase(),v=n.toLowerCase();return!(g!==v&&g!=="all"&&g!=="*")});return i.length===0?!0:i.filter(l=>l.permission==="deny").length>0?!1:(i.filter(l=>l.permission==="allow").length>0,!0)}getProtocolBaseLatency(e,t){return t&&t[e]!==void 0?t[e]:{openwire:2,amqp:5,mqtt:8,stomp:10,ws:12}[e]||5}initializeActiveMQRoutingEngine(e){const t=e.data.config||{},s=new IE;s.initialize({queues:t.queues||[],topics:t.topics||[],subscriptions:t.subscriptions||[],consumptionRate:t.consumptionRate??10,deadLetterQueue:t.deadLetterQueue||"DLQ"}),this.activeMQRoutingEngines.set(e.id,s),this.lastActiveMQUpdate.set(e.id,Date.now())}updateActiveMQMetricsInConfig(e,t,s){const n=e.data.config||{},i=n,a=this.activeMQRoutingEngines.get(e.id),o=this.connections.filter(x=>x.target===e.id),l=this.connections.filter(x=>x.source===e.id),d=new Map;for(const x of l){const S=this.nodes.find(A=>A.id===x.target);if(!S)continue;const E=S.data.config?.messaging||{};if(E.queue){const A=d.get(E.queue)||0;d.set(E.queue,A+1)}}const h=new Map,p=new Map;for(const x of l){const S=this.nodes.find(A=>A.id===x.target);if(!S)continue;const T=S.data.config,E=T?.messaging||{};if(E.topic){const A=h.get(E.topic)||0;h.set(E.topic,A+1),p.has(E.topic)||p.set(E.topic,[]);const k=p.get(E.topic),D=T?.clientId||T?.username||`client-${x.target.slice(0,8)}`,L=E.selector;if(!k.find(U=>U.clientId===D&&U.destination===E.topic)){const U=s.get(E.topic);k.push({id:`sub-${x.id}-${E.topic}`,destination:E.topic,clientId:D,selector:L,pendingQueueSize:0,dispatchedQueueSize:0,dispatchedCounter:U?.enqueueCount||0,enqueueCounter:U?.enqueueCount||0,dequeueCounter:U?.dequeueCount||0})}}}const g=n.queues||[];for(let x=0;x<g.length;x++){const S=g[x],T=t.get(S.name),E=d.get(S.name)||0;a&&a.updateQueue(S.name,{consumerCount:E}),T?g[x]={...S,queueSize:T.queueSize,consumerCount:E,enqueueCount:T.enqueueCount,dequeueCount:T.dequeueCount}:g[x]={...S,consumerCount:E}}n.queues=g;const v=n.topics||[];for(let x=0;x<v.length;x++){const S=v[x],T=s.get(S.name),E=h.get(S.name)||0;a&&a.updateTopic(S.name,{subscriberCount:E}),T?v[x]={...S,subscriberCount:E,enqueueCount:T.enqueueCount,dequeueCount:T.dequeueCount}:v[x]={...S,subscriberCount:E}}n.topics=v;const b=[];for(const x of o){const S=this.nodes.find(L=>L.id===x.source);if(!S)continue;const E=S.data.config?.messaging||{},A=i.protocol||"openwire",k=this.connectionMetrics.get(x.id),D=k?Math.floor(k.traffic/1024):0;b.push({id:x.id,remoteAddress:`${S.data.label||S.id}`,clientId:`client-${x.source.slice(0,8)}`,userName:i.username||"admin",connectedSince:new Date().toISOString(),messageCount:D,protocol:A==="openwire"?"OpenWire":A==="amqp"?"AMQP":A==="mqtt"?"MQTT":A==="stomp"?"STOMP":A==="ws"?"WebSocket":"OpenWire",role:(E.queue||E.topic,"producer")})}for(const x of l){const S=this.nodes.find(I=>I.id===x.target);if(!S)continue;const T=S.data.config,E=T?.messaging||{},A=i.protocol||"openwire",k=this.connectionMetrics.get(x.id),D=k?Math.floor(k.traffic/1024):0,L=E.queue?"consumer":E.topic?"subscriber":"consumer";b.push({id:x.id,remoteAddress:`${S.data.label||S.id}`,clientId:T?.clientId||T?.username||`client-${x.target.slice(0,8)}`,userName:i.username||"admin",connectedSince:new Date().toISOString(),messageCount:D,protocol:A==="openwire"?"OpenWire":A==="amqp"?"AMQP":A==="mqtt"?"MQTT":A==="stomp"?"STOMP":A==="ws"?"WebSocket":"OpenWire",role:L})}n.connections=b;const M=[];for(const[x,S]of p.entries())M.push(...S);for(const x of v)for(const S of o){const T=this.nodes.find(k=>k.id===S.source);if(!T)continue;const A=T.data.config?.messaging||{};if(A.topic===x.name&&!A.queue&&!M.find(D=>D.destination===x.name&&D.clientId===`client-${S.source.slice(0,8)}`)){const D=s.get(x.name);M.push({id:`sub-${S.id}-${x.name}`,destination:x.name,clientId:`client-${S.source.slice(0,8)}`,pendingQueueSize:0,dispatchedQueueSize:0,dispatchedCounter:D?.enqueueCount||0,enqueueCounter:D?.enqueueCount||0,dequeueCounter:D?.dequeueCount||0})}}n.subscriptions=M}simulateAzureServiceBus(e,t,s,n){const i=e.data.config||{},a=JSON.stringify({queues:i.queues||[],topics:i.topics||[],pricingTier:i.pricingTier,messagingUnits:i.messagingUnits,consumptionRate:i.consumptionRate}),o=this.azureServiceBusConfigHash.get(e.id);(!this.azureServiceBusRoutingEngines.has(e.id)||o!==a)&&(this.initializeAzureServiceBusRoutingEngine(e),this.azureServiceBusConfigHash.set(e.id,a));const l=this.azureServiceBusRoutingEngines.get(e.id);if(!n){s.throughput=0,s.latency=5,s.errorRate=0;const K=l.getTotalQueueDepth(),ie=l.getTotalSubscriptionMessages(),Z=K+ie;s.utilization=Math.min(1,Z/1e5);const re=l.getAllQueueMetrics(),V=l.getAllSubscriptionMetrics(),j=l.getActiveConnections();s.customMetrics={queue_depth:K,subscription_messages:ie,connections:j,queues:i.queues?.length||0,topics:i.topics?.length||0},this.updateAzureServiceBusMetricsInConfig(e,re,V);return}const d=this.connections.filter(K=>K.target===e.id);let h=0;for(const K of d){const ie=this.connectionMetrics.get(K.id);if(ie){const re=ie.traffic/1024;h+=re}}const p=i.pricingTier||"standard",g=i.messagingUnits||1;let v=1e4;p==="basic"?v=1e3:p==="premium"&&(v=1e5*g);const b=t.throughputMsgs||h||1e3,M=Math.min(b,v),x=(Math.random()-.5)*.1;s.throughput=Math.min(M*(1+x),v);const S=l.getTotalQueueDepth(),T=l.getTotalSubscriptionMessages(),E=S+T;let A=5;p==="basic"?A=10:p==="premium"&&(A=2);const k=Math.min(50,E/1e3),D=2;s.latency=A+k+D+Math.random()*5;const L=l.getAllQueueMetrics(),I=l.getAllSubscriptionMetrics(),U=l.getActiveConnections(),Q=5e-4,se=Math.min(.01,E/1e6),Y=b>v?Math.min(.1,(b-v)/v):0;let ae=0,de=0,z=0,$=0;for(const K of L.values())ae+=K.deadLetterMessageCount||0,de+=K.duplicateMessagesDetected||0,z+=K.forwardedMessages||0;for(const K of I.values())ae+=K.deadLetterMessageCount||0,z+=K.forwardedMessages||0,$+=K.filteredMessages||0;const q=ae>0?Math.min(.05,ae/1e4):0;s.errorRate=Math.min(1,Q+se+Y+q);let ee=1e5;p==="basic"?ee=1e4:p==="premium"&&(ee=1e6*g),s.utilization=Math.min(1,E/ee);let me=0;const N=i.topics||[];for(const K of N)me+=(K.subscriptions||[]).length;s.customMetrics={queue_depth:S,subscription_messages:T,dead_letter_messages:ae,duplicate_messages_detected:de,forwarded_messages:z,filtered_messages:$,connections:U,queues:i.queues?.length||0,topics:i.topics?.length||0,subscriptions:me},this.updateAzureServiceBusMetricsInConfig(e,L,I);const J=this.connections.filter(K=>K.source===e.id);if(J.length>0){const K=(i.consumptionRate||10)*1e3,ie=Date.now(),Z=`_lastAzureServiceBusConsume_${e.id}`,re=e[Z]||ie,V=ie-re;if(V>0){const j=Math.floor(K*V/1e3),ue=Math.min(.1,s.errorRate||.01),fe=i.queues||[];for(const pe of fe)for(let we=0;we<j&&we<J.length;we++){const Re=l.receiveFromQueue(pe.name);if(Re){const ze=fe.find(he=>he.name===pe.name)?.maxDeliveryCount||10;if(Math.random()<ue&&Re.deliveryCount<ze)Re.lockToken&&l.abandonMessage(pe.name,Re.lockToken);else{const he=`_azureServiceBusConsumedMessages_${e.id}`;e[he]||(e[he]=[]),e[he].push({message:Re,queueName:pe.name,timestamp:ie}),Re.lockToken&&l.completeMessage(pe.name,Re.lockToken)}}}const ge=i.topics||[];for(const pe of ge){const we=pe.subscriptions||[];for(const Re of we)for(let tt=0;tt<j&&tt<J.length;tt++){const ze=l.receiveFromSubscription(pe.name,Re.name);if(ze){const Ct=`${pe.name}/subscriptions/${Re.name}`,he=Re.maxDeliveryCount||10;if(Math.random()<ue&&ze.deliveryCount<he)ze.lockToken&&l.abandonMessage(Ct,ze.lockToken);else{const Ue=`_azureServiceBusConsumedMessages_${e.id}`;e[Ue]||(e[Ue]=[]),e[Ue].push({message:ze,topicName:pe.name,subscriptionName:Re.name,timestamp:ie}),ze.lockToken&&l.completeMessage(Ct,ze.lockToken)}}}}e[Z]=ie}}}initializeAzureServiceBusRoutingEngine(e){const t=e.data.config||{},s=new zE,n=(t.queues||[]).map(a=>({name:a.name,namespace:a.namespace||t.namespace||"archiphoenix.servicebus.windows.net",maxSizeInMegabytes:a.maxSizeInMegabytes||1024,defaultMessageTimeToLive:a.defaultMessageTimeToLive||2592e3,lockDuration:a.lockDuration||30,maxDeliveryCount:a.maxDeliveryCount||10,enablePartitioning:a.enablePartitioning||!1,enableDeadLetteringOnMessageExpiration:a.enableDeadLetteringOnMessageExpiration!==void 0?a.enableDeadLetteringOnMessageExpiration:!0,enableSessions:a.enableSessions||!1,enableDuplicateDetection:a.enableDuplicateDetection||!1,duplicateDetectionHistoryTimeWindow:a.duplicateDetectionHistoryTimeWindow||600,forwardTo:a.forwardTo||void 0,enableBatchedOperations:a.enableBatchedOperations||!1,activeMessageCount:a.activeMessageCount||0,deadLetterMessageCount:a.deadLetterMessageCount||0,scheduledMessageCount:a.scheduledMessageCount||0})),i=(t.topics||[]).map(a=>({name:a.name,namespace:a.namespace||t.namespace||"archiphoenix.servicebus.windows.net",maxSizeInMegabytes:a.maxSizeInMegabytes||1024,defaultMessageTimeToLive:a.defaultMessageTimeToLive||2592e3,enablePartitioning:a.enablePartitioning||!1,enableDuplicateDetection:a.enableDuplicateDetection||!1,duplicateDetectionHistoryTimeWindow:a.duplicateDetectionHistoryTimeWindow||600,forwardTo:a.forwardTo||void 0,enableBatchedOperations:a.enableBatchedOperations||!1,subscriptions:(a.subscriptions||[]).map(o=>({name:o.name,maxDeliveryCount:o.maxDeliveryCount||10,lockDuration:o.lockDuration||30,enableDeadLetteringOnMessageExpiration:o.enableDeadLetteringOnMessageExpiration!==void 0?o.enableDeadLetteringOnMessageExpiration:!0,requiresSession:o.requiresSession||!1,forwardTo:o.forwardTo||void 0,enableBatchedOperations:o.enableBatchedOperations||!1,rules:o.rules||[],activeMessageCount:o.activeMessageCount||0}))}));s.initialize({queues:n,topics:i}),this.azureServiceBusRoutingEngines.set(e.id,s),this.lastAzureServiceBusUpdate.set(e.id,Date.now())}updateAzureServiceBusMetricsInConfig(e,t,s){const n=e.data.config||{},i=n.queues||[];for(let o=0;o<i.length;o++){const l=i[o],d=t.get(l.name);d&&(i[o]={...l,activeMessageCount:d.activeMessageCount,deadLetterMessageCount:d.deadLetterMessageCount,scheduledMessageCount:d.scheduledMessageCount})}n.queues=i;const a=n.topics||[];for(let o=0;o<a.length;o++){const l=a[o],d=l.subscriptions||[];for(let h=0;h<d.length;h++){const p=d[h],g=`${l.name}/subscriptions/${p.name}`,v=s.get(g);v&&(d[h]={...p,activeMessageCount:v.activeMessageCount})}a[o]={...l,subscriptions:d}}n.topics=a}simulatePubSub(e,t,s,n){this.pubSubRoutingEngines.has(e.id)||this.initializePubSubRoutingEngine(e);const i=this.pubSubRoutingEngines.get(e.id),a=e.data.config||{},o=a.topics||[],l=a.subscriptions||[];if(!n){s.throughput=0,s.latency=3,s.errorRate=0;const z=i.getTotalTopicMessages(),$=i.getTotalUnackedMessages(),q=z+$;s.utilization=Math.min(1,q/1e5);const ee=i.getAllTopicMetrics(),me=i.getAllSubscriptionMetrics(),N=i.getActiveConnections();s.customMetrics={topic_messages:z,unacked_messages:$,connections:N,topics:o.length,subscriptions:l.length},this.updatePubSubMetricsInConfig(e,ee,me);return}const d=this.connections.filter(z=>z.target===e.id);let h=0;for(const z of d){const $=this.connectionMetrics.get(z.id);if($){const ee=$.traffic/1024;h+=ee}}const p=t.throughputMsgs||h||1e3,g=(Math.random()-.5)*.1;s.throughput=p*(1+g);const v=i.getTotalTopicMessages(),b=i.getTotalUnackedMessages(),M=v+b,x=3,S=Math.min(15,M/1e4),T=l.filter(z=>z.pushEndpoint).length,E=T>0?2:0,A=b>0?.5:0;s.latency=x+S+E+A+Math.random()*2;const k=i.getAllTopicMetrics(),D=i.getAllSubscriptionMetrics(),L=i.getActiveConnections(),I=1e-4,U=Math.min(.001,M/5e6),Q=T>0&&b>0?Math.min(.002,b/1e5):0,se=l.length>0?l.reduce((z,$)=>z+($.ackDeadlineSeconds||10),0)/l.length:10,F=b>0&&se<60?Math.min(.005,b/1e5):0;s.errorRate=Math.min(1,I+U+Q+F);const Y=Math.min(1,s.throughput/1e5),ae=Math.min(.3,M/5e5);s.utilization=Math.min(1,Y*.7+ae*.3);const de=l.length-T;s.customMetrics={topic_messages:v,unacked_messages:b,connections:L,topics:o.length,subscriptions:l.length,push_subscriptions:T,pull_subscriptions:de,total_bytes:Array.from(k.values()).reduce((z,$)=>z+$.byteCount,0)},this.updatePubSubMetricsInConfig(e,k,D)}initializePubSubRoutingEngine(e){const t=e.data.config||{},s=new jE,n=(t.topics||[]).map(a=>({name:a.name,projectId:a.projectId||t.projectId||"archiphoenix-lab",messageRetentionDuration:a.messageRetentionDuration||604800,labels:a.labels||{},messageCount:a.messageCount||0,byteCount:a.byteCount||0,schema:a.schema||void 0})),i=(t.subscriptions||[]).map(a=>({name:a.name,topic:a.topic,projectId:a.projectId||t.projectId||"archiphoenix-lab",ackDeadlineSeconds:a.ackDeadlineSeconds||10,messageRetentionDuration:a.messageRetentionDuration,enableMessageOrdering:a.enableMessageOrdering||!1,pushEndpoint:a.pushEndpoint,pushAttributes:a.pushAttributes||{},payloadFormat:a.payloadFormat||"WRAPPED",messageCount:a.messageCount||0,unackedMessageCount:a.unackedMessageCount||0,deadLetterTopic:a.deadLetterTopic,maxDeliveryAttempts:a.maxDeliveryAttempts||5,retryPolicy:a.retryPolicy||{minimumBackoff:10,maximumBackoff:600},enableExactlyOnceDelivery:a.enableExactlyOnceDelivery||!1,expirationPolicy:a.expirationPolicy||void 0,flowControl:a.flowControl||void 0}));s.initialize({topics:n,subscriptions:i}),this.pubSubRoutingEngines.set(e.id,s),this.lastPubSubUpdate.set(e.id,Date.now())}initializeKafkaRoutingEngine(e){const t=e.data.config||{},s=new OE,n=(t.topics||[]).map(a=>({name:a.name,partitions:a.partitions||1,replication:a.replication||1,config:a.config||{},partitionInfo:a.partitionInfo||[]})),i=(t.consumerGroups||[]).map(a=>({id:a.id,topic:a.topic,members:a.members||1,offsetStrategy:a.offsetStrategy||"latest",autoCommit:a.autoCommit!==!1}));s.initialize({brokers:t.brokers||["localhost:9092"],topics:n,consumerGroups:i}),this.kafkaRoutingEngines.set(e.id,s),this.lastKafkaUpdate.set(e.id,Date.now())}updatePubSubMetricsInConfig(e,t,s){const n=e.data.config||{},i=n.topics||[];for(let o=0;o<i.length;o++){const l=i[o],d=t.get(l.name);d&&(i[o]={...l,messageCount:d.messageCount,byteCount:d.byteCount})}n.topics=i;const a=n.subscriptions||[];for(let o=0;o<a.length;o++){const l=a[o],d=s.get(l.name);d&&(a[o]={...l,messageCount:d.messageCount,unackedMessageCount:d.unackedMessageCount,deliveredCount:d.deliveredCount,acknowledgedCount:d.acknowledgedCount,nackedCount:d.nackedCount,deadLetterCount:d.deadLetterCount,pushDeliverySuccessRate:d.pushDeliverySuccessRate,expiredAckDeadlines:d.expiredAckDeadlines,avgDeliveryAttempts:d.avgDeliveryAttempts})}n.subscriptions=a}updateWebSocketMetricsInConfig(e,t){const s=e.data.config||{},n=t.getActiveConnections();s.connections=n,s.totalConnections=t.getWebSocketMetrics().connectionsTotal,s.activeConnections=t.getWebSocketMetrics().connectionsActive;const i=t.getRooms();s.rooms=i;const a=t.getSubscriptions();s.subscriptions=a;const o=t.getMessageHistory(100);s.messages=o,s.totalMessages=t.getWebSocketMetrics().messagesTotal}simulateSQS(e,t,s,n){this.sqsRoutingEngines.has(e.id)||this.initializeSQSRoutingEngine(e);const i=this.sqsRoutingEngines.get(e.id);if(e.data.config,!n){s.throughput=0,s.latency=5,s.errorRate=0;const S=i.getTotalQueueDepth();s.utilization=Math.min(1,S/1e5);const T=i.getAllQueueMetrics(),E=i.getActiveConnections();s.customMetrics={queue_depth:S,connections:E,queues:T.size},this.updateSQSQueueMetricsInConfig(e,T);return}const a=this.connections.filter(S=>S.target===e.id);let o=0;for(const S of a){const T=this.connectionMetrics.get(S.id);if(T){const A=T.traffic/1024;o+=A}}const l=t.throughputMsgs||o||1e3,d=(Math.random()-.5)*.1;s.throughput=l*(1+d);const h=i.getTotalQueueDepth(),p=5,g=Math.min(50,h/1e3);s.latency=p+g+Math.random()*5;const v=5e-4,b=Math.min(.01,h/1e6);s.errorRate=v+b,s.utilization=Math.min(1,h/1e5);const M=i.getAllQueueMetrics(),x=i.getActiveConnections();s.customMetrics={queue_depth:h,connections:x,queues:M.size},this.updateSQSQueueMetricsInConfig(e,M)}initializeSQSRoutingEngine(e){const t=e.data.config||{},s=new NE,n=(t.queues||[]).map(i=>({name:i.name,type:i.type||"standard",region:i.region||t.defaultRegion||"us-east-1",visibilityTimeout:i.visibilityTimeout||30,messageRetention:i.messageRetention||4,delaySeconds:i.delaySeconds||0,maxReceiveCount:i.maxReceiveCount,deadLetterQueue:i.deadLetterQueue,contentBasedDedup:i.contentBasedDedup,fifoThroughputLimit:i.fifoThroughputLimit||"perQueue"}));s.initialize({queues:n}),this.sqsRoutingEngines.set(e.id,s),this.lastSQSUpdate.set(e.id,Date.now())}updateSQSQueueMetricsInConfig(e,t){const s=e.data.config||{},n=s.queues||[];for(let i=0;i<n.length;i++){const a=n[i],o=t.get(a.name);o&&(n[i]={...a,approximateMessages:o.approximateMessages,approximateMessagesNotVisible:o.approximateMessagesNotVisible,approximateMessagesDelayed:o.approximateMessagesDelayed})}s.queues=n}simulateDatabase(e,t,s,n){if(!n){if(s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0,s.customMetrics={},e.type==="postgres"){const g=this.postgresConnectionPools.get(e.id);g&&g.reset()}return}const i=t.maxConnections||100,a=t.queryLatency||10;if(e.type==="postgres"){const g=this.postgresConnectionPools.get(e.id);if(g){const b=this.connections.filter(D=>D.target===e.id).reduce((D,L)=>{const I=this.metrics.get(L.source);return D+(I?.throughput||0)},0),x=Math.min(b,i*10)*this.updateInterval/1e3;for(let D=0;D<Math.floor(x);D++){const L=g.acquireConnection("SELECT");if(L){const I=a+Math.random()*20;setTimeout(()=>{g.releaseConnection(L,I)},I)}}const S=g.getMetrics();s.throughput=S.queriesPerSecond,s.latency=S.averageQueryTime||a,s.utilization=S.utilization,s.errorRate=S.waitingConnections>0?.01:.001;const E=e.data.config.tables||[];let A=0;for(const D of E)A+=(D.indexes||[]).length;A===0&&(A=5);const k=this.calculateCacheHitRatio(e,S.queriesPerSecond);s.customMetrics={active_connections:S.activeConnections,idle_connections:S.idleConnections,waiting_connections:S.waitingConnections,total_connections:S.totalConnections,max_connections:i,indexes:A,cache_hit_ratio:k,connection_wait_time:S.connectionWaitTime};return}}if(e.type==="redis"){this.redisRoutingEngines.has(e.id)||this.initializeRedisRoutingEngine(e);const g=this.redisRoutingEngines.get(e.id),v=e.data.config;v?.keys&&Array.isArray(v.keys)&&g.syncKeysFromConfig(v.keys);const b=g.getMetrics(),x=this.connections.filter(A=>A.target===e.id).reduce((A,k)=>{const D=this.metrics.get(k.source);return A+(D?.throughput||0)},0);s.throughput=Math.max(b.operationsPerSecond,x);const S=.5,T=b.memoryUsagePercent/100,E=Math.min(1,b.totalKeys/1e5);s.latency=S+T*2+E*1,s.errorRate=T>.95?.01:.001,s.utilization=b.memoryUsagePercent/100,s.customMetrics={total_keys:b.totalKeys,keys_string:b.keysByType.string,keys_hash:b.keysByType.hash,keys_list:b.keysByType.list,keys_set:b.keysByType.set,keys_zset:b.keysByType.zset,keys_stream:b.keysByType.stream,memory_usage:b.memoryUsage,memory_usage_percent:b.memoryUsagePercent,operations_per_second:b.operationsPerSecond,hit_count:b.hitCount,miss_count:b.missCount,hit_rate:b.hitRate,expired_keys:b.expiredKeys,evicted_keys:b.evictedKeys,connected_clients:b.connectedClients};return}if(e.type==="cassandra"){this.cassandraRoutingEngines.has(e.id)||this.initializeCassandraRoutingEngine(e);const g=this.cassandraRoutingEngines.get(e.id),v=e.data.config;v&&g.syncFromConfig({clusterName:v.clusterName,nodes:v.nodes,keyspaces:v.keyspaces,tables:v.tables,defaultConsistencyLevel:v.consistencyLevel,defaultReplicationFactor:v.replicationFactor});const b=g.getMetrics(),x=this.connections.filter(k=>k.target===e.id).reduce((k,D)=>{const L=this.metrics.get(D.source);return k+(L?.throughput||0)},0);s.throughput=Math.max(b.readOperationsPerSecond+b.writeOperationsPerSecond,x);const S=b.readOperationsPerSecond+b.writeOperationsPerSecond;if(S>0){const k=b.readOperationsPerSecond/S,D=b.writeOperationsPerSecond/S;s.latency=b.readLatency*k+b.writeLatency*D}else s.latency=(b.readLatency+b.writeLatency)/2;const T=b.readConsistencyViolations+b.writeConsistencyViolations;s.errorRate=Math.min(.1,T/Math.max(1,S))||.001;const E=b.totalNodes>0?(b.totalNodes-b.healthyNodes)/b.totalNodes:0,A=Math.min(1,b.pendingCompactions/100);s.utilization=Math.min(1,E*.7+A*.3),s.customMetrics={total_nodes:b.totalNodes,healthy_nodes:b.healthyNodes,total_keyspaces:b.totalKeyspaces,total_tables:b.totalTables,total_rows:b.totalRows,total_size_gb:b.totalSize/(1024*1024*1024),read_latency_ms:b.readLatency,write_latency_ms:b.writeLatency,read_ops_per_sec:b.readOperationsPerSecond,write_ops_per_sec:b.writeOperationsPerSecond,pending_compactions:b.pendingCompactions,read_consistency_violations:b.readConsistencyViolations,write_consistency_violations:b.writeConsistencyViolations,hinted_handoffs:b.hintedHandoffs};return}if(e.type==="clickhouse"){this.clickHouseRoutingEngines.has(e.id)||this.initializeClickHouseRoutingEngine(e);const g=this.clickHouseRoutingEngines.get(e.id),v=e.data.config;v&&g.syncFromConfig({cluster:v.cluster,replication:v.replication,tables:v.tables?.map(A=>({name:A.name,database:v.database||"default",engine:A.engine||"MergeTree",rows:A.rows||0,size:A.size||0,partitions:A.partitions||0,columns:A.columns||[]})),maxMemoryUsage:v.maxMemoryUsage,compression:v.compression});const b=g.getMetrics(),x=this.connections.filter(A=>A.target===e.id).reduce((A,k)=>{const D=this.metrics.get(k.source);return A+(D?.throughput||0)},0);s.throughput=Math.max(b.queriesPerSecond,x),s.latency=b.avgQueryTime;const S=b.memoryUsagePercent/100;s.errorRate=S>.95?.01:.001;const T=Math.min(1,b.activeQueries/10),E=S;s.utilization=Math.max(T,E),s.customMetrics={total_tables:b.totalTables,total_rows:b.totalRows,total_size_gb:b.totalSize/(1024*1024*1024),queries_per_sec:b.queriesPerSecond,read_rows_per_sec:b.readRowsPerSecond,written_rows_per_sec:b.writtenRowsPerSecond,avg_query_time_ms:b.avgQueryTime,active_queries:b.activeQueries,memory_usage_bytes:b.memoryUsage,memory_usage_percent:b.memoryUsagePercent,parts_count:b.partsCount,pending_merges:b.pendingMerges,compression_ratio:b.compressionRatio,cluster_nodes:b.clusterNodes,healthy_nodes:b.healthyNodes};return}if(e.type==="snowflake"){this.snowflakeRoutingEngines.has(e.id)||this.initializeSnowflakeRoutingEngine(e);const g=this.snowflakeRoutingEngines.get(e.id),v=e.data.config;v&&g.syncFromConfig({account:v.account,region:v.region,warehouses:v.warehouses,databases:v.databases,role:v.role,enableAutoSuspend:v.enableAutoSuspend,autoSuspendSeconds:v.autoSuspendSeconds,enableAutoResume:v.enableAutoResume});const b=g.getMetrics(),x=this.connections.filter(S=>S.target===e.id).reduce((S,T)=>{const E=this.metrics.get(T.source);return S+(E?.throughput||0)},0);s.throughput=Math.max(b.queriesPerSecond,x),s.latency=b.avgQueryTime,s.errorRate=.001,s.utilization=b.warehouseUtilization,s.customMetrics={total_warehouses:b.totalWarehouses,running_warehouses:b.runningWarehouses,suspended_warehouses:b.suspendedWarehouses,total_queries:b.totalQueries,running_queries:b.runningQueries,queued_queries:b.queuedQueries,queries_per_sec:b.queriesPerSecond,avg_query_time_ms:b.avgQueryTime,total_compute_time_sec:b.totalComputeTime,total_data_read:b.totalDataRead,total_data_written:b.totalDataWritten,cache_hit_rate:b.cacheHitRate,warehouse_utilization:b.warehouseUtilization,total_cost_credits:b.totalCost};return}if(e.type==="elasticsearch"){this.elasticsearchRoutingEngines.has(e.id)||this.initializeElasticsearchRoutingEngine(e);const g=this.elasticsearchRoutingEngines.get(e.id),v=e.data.config;v&&g.syncFromConfig({clusterName:v.clusterName,nodes:v.nodes,indices:v.indices,defaultShards:v.shards,defaultReplicas:v.replicas,refreshInterval:v.refreshInterval});const b=g.getMetrics(),x=this.connections.filter(k=>k.target===e.id).reduce((k,D)=>{const L=this.metrics.get(D.source);return k+(L?.throughput||0)},0);s.throughput=Math.max(b.indexOperationsPerSecond+b.searchOperationsPerSecond,x);const S=b.indexOperationsPerSecond+b.searchOperationsPerSecond;if(S>0){const k=b.indexOperationsPerSecond/S,D=b.searchOperationsPerSecond/S;s.latency=b.averageIndexLatency*k+b.averageSearchLatency*D}else s.latency=b.averageSearchLatency||10;const T=b.clusterHealth==="red"?.01:b.clusterHealth==="yellow"?.002:.001;s.errorRate=T;const E=b.unassignedShards>0?1:b.relocatingShards>0?.7:b.initializingShards>0?.5:.3,A=b.healthyNodes/b.totalNodes;s.utilization=Math.max(E,1-A),this.updateElasticsearchMetricsInConfig(e,b),s.customMetrics={cluster_health:b.clusterHealth==="green"?1:b.clusterHealth==="yellow"?.5:0,total_nodes:b.totalNodes,healthy_nodes:b.healthyNodes,total_indices:b.totalIndices,total_docs:b.totalDocs,total_size_gb:b.totalSize/(1024*1024*1024),active_shards:b.activeShards,relocating_shards:b.relocatingShards,initializing_shards:b.initializingShards,unassigned_shards:b.unassignedShards,index_ops_per_sec:b.indexOperationsPerSecond,search_ops_per_sec:b.searchOperationsPerSecond,avg_index_latency_ms:b.averageIndexLatency,avg_search_latency_ms:b.averageSearchLatency,avg_get_latency_ms:b.averageGetLatency};return}if(e.type==="s3-datalake"){this.s3RoutingEngines.has(e.id)||this.initializeS3RoutingEngine(e);const g=this.s3RoutingEngines.get(e.id);if(g.processLifecycleTransitions(),!n){s.throughput=0,s.latency=50,s.errorRate=0;const F=g.getAllBucketMetrics(),Y=g.getTotalStorageSize(),ae=g.getTotalObjectCount(),de=1024*1024*1024*1024,z=F.size,$=de*z;s.utilization=$>0?Math.min(1,Y/$):0,s.customMetrics={buckets:z,total_objects:ae,total_size:Y,total_size_mb:Math.round(Y/(1024*1024)*100)/100},this.updateS3BucketMetricsInConfig(e,F);return}const v=this.connections.filter(F=>F.target===e.id);let b=0,M=0;for(const F of v){const Y=this.connectionMetrics.get(F.id);Y&&(b+=Y.traffic/1024,M+=Y.traffic)}const x=1024*1024,S=M>0?M/x:0;s.throughput=Math.max(0,S),s.latency=50+(S>100?(S-100)*.1:0),s.errorRate=.001;const T=g.getAllBucketMetrics(),E=g.getTotalStorageSize(),A=g.getTotalObjectCount(),k=T.size,L=1024*1024*1024*1024*k,I=L>0?Math.min(1,E/L):0,Q=3500*k,se=Q>0?Math.min(1,S/Q):0;s.utilization=Math.max(I,se),s.customMetrics={buckets:k,total_objects:A,total_size:E,total_size_mb:Math.round(E/(1024*1024)*100)/100,total_size_gb:Math.round(E/(1024*1024*1024)*100)/100,estimated_ops_per_sec:Math.round(S*100)/100,storage_utilization:Math.round(I*1e3)/10,ops_utilization:Math.round(se*1e3)/10},this.updateS3BucketMetricsInConfig(e,T);return}let o=t.indexCount||5;e.type==="mongodb"&&(o=(e.data.config?.collections||[]).reduce((b,M)=>b+(M.indexes?.length||0),0),o===0&&(o=1));const d=this.connections.filter(g=>g.target===e.id).reduce((g,v)=>{const b=this.metrics.get(v.source);return g+(b?.throughput||0)},0),h=Math.min(i,Math.floor(d/10)||Math.floor(i*.3));s.throughput=h*(1e3/(a+Math.random()*20));const p=Math.min(.3,o*.02);if(s.latency=a+h/i*50*(1-p),s.errorRate=.001,s.utilization=h/i,s.customMetrics={active_connections:h,max_connections:i,indexes:o,cache_hit_ratio:Math.random()*.8+.2},e.type==="mongodb"){const g=e.data.config,v=g?.collections||[],b=v.filter(E=>E.validation&&E.validation.validationLevel!=="off").length;if(b>0){const E=Math.min(.05,b*.01);s.errorRate=Math.max(s.errorRate,E)}const M=g?.enableReplicaSet||!1,x=g?.replicaSetMembers||[];if(M&&x.length>1){const E=x.length,A=Math.min(.3,(E-1)*.1);s.errorRate=Math.max(0,s.errorRate*(1-A)),s.latency=s.latency*(1+.05*(E-1))}const S=g?.enableSharding||!1,T=g?.shardConfig;if(S&&T?.shards){const E=T.shards.length,A=1+(E-1)*.3;s.throughput=s.throughput*A,s.latency=s.latency*(1+.02*(E-1))}s.customMetrics={...s.customMetrics,collections:v.length,collections_with_validation:b,total_documents:v.reduce((E,A)=>E+(A.documentCount||0),0),replica_set_enabled:M,replica_members:M?x.length:0,sharding_enabled:S,shard_count:S&&T?.shards?.length||0}}}simulateNginx(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.nginxRoutingEngines.get(e.id);if(!i){const S=t.workerThreads||t.maxWorkers||4,T=t.requestsPerSecond||1e4,E=.5*Math.sin(this.simulationTime/2e3)+.5;s.throughput=T*E,s.latency=1+(1-E)*4,s.errorRate=1e-5,s.utilization=Math.min(1,s.throughput/T*(S/4)),s.customMetrics={worker_threads:S,active_connections:Math.floor(s.throughput*.1)};return}const a=t||{},o=a.maxWorkers||4,l=a.requestsPerSecond||1e4;a.enableCache;const d=a.enableGzip??!0,h=i.getStats(),p=.5*Math.sin(this.simulationTime/2e3)+.5;let g=l*p;if(h.rateLimitBlocks>0){const S=Math.min(.1,h.rateLimitBlocks/Math.max(1,h.requests));g=g*(1-S)}s.throughput=g;const v=1+(1-p)*4,b=10+Math.random()*90;s.latency=v+b*.3;const M=h.rateLimitBlocks>0?Math.min(.05,h.rateLimitBlocks/Math.max(1,h.requests)):0;s.errorRate=1e-5+M;const x=Math.min(1,s.throughput/l*(o/4));s.utilization=x,s.customMetrics={worker_threads:o,active_connections:Math.floor(s.throughput*.1),cache_hits:h.cacheHits,cache_misses:h.cacheMisses,cache_hit_rate:Math.round(h.cacheHitRate*100)/100,rate_limit_blocks:h.rateLimitBlocks,locations:h.locations,upstreams:h.upstreams,ssl_enabled:a.enableSSL?1:0,gzip_enabled:d?1:0}}simulateHAProxy(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.haproxyRoutingEngines.get(e.id);if(!i){const x=t.maxConnections||4096,S=t.requestsPerSecond||1e4,T=.5*Math.sin(this.simulationTime/2e3)+.5;s.throughput=S*T,s.latency=1+(1-T)*4,s.errorRate=1e-5,s.utilization=Math.min(1,s.throughput/S*(x/4096)),s.customMetrics={max_connections:x,active_connections:Math.floor(s.throughput*.1)};return}const a=t||{},o=a.maxConnections||4096,l=a.requestsPerSecond||1e4,d=i.getStats(),h=.5*Math.sin(this.simulationTime/2e3)+.5;let p=l*h;const g=d.totalServers>0?d.upServers/d.totalServers:1;p=p*g,s.throughput=p;const v=1+(1-h)*4,b=10+Math.random()*90;s.latency=v+b*.3,s.errorRate=d.errorRate||1e-5;const M=Math.min(1,d.activeConnections/o);s.utilization=M,s.customMetrics={max_connections:o,active_connections:d.activeConnections,frontends:d.frontends,backends:d.backends,total_servers:d.totalServers,up_servers:d.upServers,down_servers:d.downServers,total_requests:d.totalRequests,total_responses:d.totalResponses,total_bytes_in:d.totalBytesIn,total_bytes_out:d.totalBytesOut}}simulateEnvoy(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.envoyRoutingEngines.get(e.id);if(!i){const x=t.maxConnections||1024,S=t.requestsPerSecond||1e4,T=.5*Math.sin(this.simulationTime/2e3)+.5;s.throughput=S*T,s.latency=1+(1-T)*4,s.errorRate=1e-5,s.utilization=Math.min(1,s.throughput/S*(x/1024)),s.customMetrics={max_connections:x,active_connections:Math.floor(s.throughput*.1)};return}const a=t||{},o=a.maxConnections||1024,l=a.requestsPerSecond||1e4,d=i.getStats(),h=.5*Math.sin(this.simulationTime/2e3)+.5;let p=l*h;const g=d.totalEndpoints>0?d.healthyEndpoints/d.totalEndpoints:1;p=p*g,s.throughput=p;const v=1+(1-h)*4,b=10+Math.random()*90;s.latency=v+b*.2,s.errorRate=d.errorRate||1e-5;const M=Math.min(1,d.activeConnections/o);s.utilization=M,s.customMetrics={max_connections:o,active_connections:d.activeConnections,clusters:d.clusters,listeners:d.listeners,routes:d.routes,total_endpoints:d.totalEndpoints,healthy_endpoints:d.healthyEndpoints,unhealthy_endpoints:d.unhealthyEndpoints,total_requests:d.totalRequests,total_responses:d.totalResponses,total_bytes_in:d.totalBytesIn,total_bytes_out:d.totalBytesOut,rate_limit_blocks:d.rateLimitBlocks||0,timeout_errors:d.timeoutErrors||0,circuit_breaker_trips:d.circuitBreakerTrips||0}}simulateServiceMesh(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.serviceMeshRoutingEngines.get(e.id);if(!i){const T=t.maxConnections||1e4,E=t.requestsPerSecond||5e3,A=.5*Math.sin(this.simulationTime/2e3)+.5;s.throughput=E*A,s.latency=5+(1-A)*10,s.errorRate=1e-4,s.utilization=Math.min(1,s.throughput/E*(T/1e4)),s.customMetrics={max_connections:T,active_connections:Math.floor(s.throughput*.1),services:t.services?.length||0};return}const a=t||{},o=a.maxConnections||1e4,l=a.requestsPerSecond||5e3,d=i.getStats(),h=.5*Math.sin(this.simulationTime/2e3)+.5;let p=l*h;const g=d.services,v=g>0?Math.min(1,g/Math.max(1,a.services?.length||g)):1;p=p*v,s.throughput=p;const b=5+(1-h)*10,M=10+Math.random()*90,x=a.enableMTLS?2:0;s.latency=b+M*.15+x,s.errorRate=d.errorRate||1e-4;const S=Math.min(1,d.activeConnections/o);s.utilization=S,s.customMetrics={max_connections:o,active_connections:d.activeConnections,services:d.services,virtual_services:d.virtualServices,destination_rules:d.destinationRules,gateways:d.gateways,total_requests:d.totalRequests,total_responses:d.totalResponses,total_errors:d.totalErrors,total_bytes_in:d.totalBytesIn,total_bytes_out:d.totalBytesOut,mtls_connections:d.mtlsConnections,circuit_breaker_trips:d.circuitBreakerTrips,retry_attempts:d.retryAttempts,timeout_errors:d.timeoutErrors,rate_limit_blocks:d.rateLimitBlocks,average_latency:Math.round(d.averageLatency)}}simulateIstio(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.istioRoutingEngines.get(e.id);if(!i){const T=t.maxConnections||1e4,E=t.requestsPerSecond||5e3,A=.5*Math.sin(this.simulationTime/2e3)+.5;s.throughput=E*A,s.latency=5+(1-A)*10,s.errorRate=1e-4,s.utilization=Math.min(1,s.throughput/E*(T/1e4)),s.customMetrics={max_connections:T,active_connections:Math.floor(s.throughput*.1),services:t.services?.length||0};return}const a=t||{},o=a.maxConnections||1e4,l=a.requestsPerSecond||5e3,d=i.getStats(),h=.5*Math.sin(this.simulationTime/2e3)+.5;let p=l*h;const g=d.services,v=g>0?Math.min(1,g/Math.max(1,a.services?.length||g)):1;p=p*v,s.throughput=p;const b=5+(1-h)*10,M=10+Math.random()*90,x=a.enableMTLS?2:0;s.latency=b+M*.15+x,s.errorRate=d.errorRate||1e-4;const S=Math.min(1,d.activeConnections/o);s.utilization=S,s.customMetrics={max_connections:o,active_connections:d.activeConnections,services:d.services,virtual_services:d.virtualServices,destination_rules:d.destinationRules,gateways:d.gateways,total_requests:d.totalRequests,total_responses:d.totalResponses,total_errors:d.totalErrors,total_bytes_in:d.totalBytesIn,total_bytes_out:d.totalBytesOut,mtls_connections:d.mtlsConnections,circuit_breaker_trips:d.circuitBreakerTrips,retry_attempts:d.retryAttempts,timeout_errors:d.timeoutErrors,rate_limit_blocks:d.rateLimitBlocks,average_latency:Math.round(d.averageLatency)}}simulateInfrastructure(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=t.workerThreads||1;s.throughput=100*i+Math.random()*50,s.latency=50+Math.random()*100,s.errorRate=1e-4,s.utilization=Math.random()*.8,s.customMetrics={replicas:i,cpu_percent:Math.random()*80,memory_percent:Math.random()*70}}simulateAPI(e,t,s,n){if(!n){if(s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0,e.type==="rest"){const l=this.restApiRoutingEngines.get(e.id);l&&l.getStats()}return}if(e.type==="rest"){const l=this.restApiRoutingEngines.get(e.id);if(l){const d=l.getStats(),h=l.getAllEndpointStats(),p=d.totalRequests,g=d.totalErrors,v=d.averageLatency,b=t.requestsPerSecond||100,M=Math.sin(this.simulationTime/1500)*.1+1;s.throughput=b*M,s.latency=v>0?v:(t.responseLatency||50)+Math.random()*30,p>0?s.errorRate=g/p:s.errorRate=.005,s.utilization=Math.min(1,s.throughput/b);const x=d.enabledEndpoints,S={};for(const[T,E]of Object.entries(h))E&&(S[`endpoint_${T}_requests`]=E.requestCount,S[`endpoint_${T}_errors`]=E.errorCount,S[`endpoint_${T}_latency`]=E.averageLatency);s.customMetrics={rps:s.throughput,total_requests:p,total_errors:g,p50_latency:Math.round(s.latency*.5),p99_latency:Math.round(s.latency*2),errors:Math.round(s.throughput*s.errorRate),endpoints:d.totalEndpoints,enabled_endpoints:x,...S};return}}if(e.type==="grpc"){const l=this.grpcRoutingEngines.get(e.id);if(l){const d=l.getStats(),h=l.getAllMethodStats(),p=l.getConnectionState(),g=d.totalRequests,v=d.totalErrors,b=d.averageLatency,M=t.requestsPerSecond||100,x=Math.sin(this.simulationTime/1500)*.1+1;s.throughput=M*x,s.latency=b>0?b:(t.responseLatency||20)+Math.random()*15,g>0?s.errorRate=v/g:s.errorRate=.002;const S=p.totalConnections||100,T=Math.min(1,(p.activeConnections+p.idleConnections)/S);s.utilization=Math.min(1,s.throughput/M*.7+T*.3);const E={};for(const[A,k]of Object.entries(h))k&&(E[`method_${A}_requests`]=k.requestCount,E[`method_${A}_errors`]=k.errorCount,E[`method_${A}_latency`]=k.averageLatency,k.streamingConnections&&(E[`method_${A}_streaming_connections`]=k.streamingConnections));s.customMetrics={rps:s.throughput,total_requests:g,total_errors:v,p50_latency:Math.round(s.latency*.5),p99_latency:Math.round(s.latency*1.8),errors:Math.round(s.throughput*s.errorRate),services:d.totalServices,enabled_services:d.enabledServices,methods:d.totalMethods,enabled_methods:d.enabledMethods,active_connections:p.activeConnections,idle_connections:p.idleConnections,total_connections:p.totalConnections,...E};return}}if(e.type==="graphql"){const l=this.graphQLEngines.get(e.id);if(l){l.getLoad();const d=l.getGraphQLMetrics();if(!n){const g=t.requestsPerSecond||100;l.simulateRequests(g,this.nodes,this.connections)}l.processSubscriptions(this.nodes,this.connections);const h=l.getLoad();s.throughput=h.queriesPerSecond+h.mutationsPerSecond,s.latency=h.averageLatency,s.errorRate=h.errorRate,s.utilization=(h.cpuUtilization+h.memoryUtilization)/2,s.customMetrics={queries_per_second:d.queriesPerSecond,mutations_per_second:d.mutationsPerSecond,subscriptions_active:d.subscriptionsActive,total_queries:d.totalQueries,total_mutations:d.totalMutations,total_errors:d.totalErrors,average_response_time:d.averageResponseTime,average_complexity:d.averageComplexity,average_depth:d.averageDepth,cache_hit_rate:d.cacheHitRate,error_rate:d.errorRate,cpu_utilization:h.cpuUtilization,memory_utilization:h.memoryUtilization};const p=l.getSubscriptionMetrics();s.customMetrics={...s.customMetrics,subscription_events_total:p.totalEvents,subscription_events_per_second:p.eventsPerSecond,subscription_avg_delivery_latency:p.averageDeliveryLatency,subscription_delivery_errors:p.totalDeliveryErrors,subscription_delivery_error_rate:p.deliveryErrorRate};return}}if(e.type==="soap"){const l=this.soapEngines.get(e.id);if(l){const d=l.getSOAPMetrics();s.throughput=d.requestsPerSecond,s.latency=d.averageLatency,s.errorRate=d.errorRate/100,s.utilization=Math.min(1,s.throughput/(t.requestsPerSecond||100));const h=t;if(s.customMetrics={requests_per_second:d.requestsPerSecond,total_requests:d.totalRequests,total_errors:d.totalErrors,average_response_time:d.averageResponseTime,average_latency:d.averageLatency,error_rate:d.errorRate,success_rate:d.successRate,services_count:h?.services?.length||0,operations_count:h?.services?.reduce((p,g)=>p+(g.operations?.length||0),0)||0},d.operationMetrics)for(const p of d.operationMetrics)s.customMetrics[`operation_${p.operationName}_calls`]=p.totalCalls,s.customMetrics[`operation_${p.operationName}_latency`]=p.averageLatency,s.customMetrics[`operation_${p.operationName}_errors`]=p.totalErrors;if(d.serviceMetrics)for(const p of d.serviceMetrics)s.customMetrics[`service_${p.serviceName}_requests`]=p.totalRequests,s.customMetrics[`service_${p.serviceName}_latency`]=p.averageLatency,s.customMetrics[`service_${p.serviceName}_errors`]=p.totalErrors;d.rateLimitMetrics&&(s.customMetrics.rate_limit_blocked=d.rateLimitMetrics.totalBlockedRequests,s.customMetrics.rate_limit_hits_per_sec=d.rateLimitMetrics.rateLimitHitsPerSecond),d.timeoutMetrics&&(s.customMetrics.timeouts_total=d.timeoutMetrics.totalTimeouts,s.customMetrics.timeouts_per_sec=d.timeoutMetrics.timeoutsPerSecond);return}}if(e.type==="websocket"){const l=this.websocketEngines.get(e.id);if(l){l.updateMetrics(n,this.simulationTime);const d=l.getWebSocketMetrics();s.throughput=d.messagesPerSecond,s.latency=d.averageLatency,s.latencyP50=d.latencyP50,s.latencyP99=d.latencyP99,s.errorRate=d.errorRate,s.utilization=d.utilization,s.customMetrics={connections_total:d.connectionsTotal,connections_active:d.connectionsActive,connections_per_second:d.connectionsPerSecond,messages_per_second:d.messagesPerSecond,messages_total:d.messagesTotal,messages_sent:d.messagesSent,messages_received:d.messagesReceived,bytes_sent:d.bytesSent,bytes_received:d.bytesReceived,average_latency:d.averageLatency,latency_p50:d.latencyP50||0,latency_p95:d.latencyP95||0,latency_p99:d.latencyP99||0,error_rate:d.errorRate,connection_error_rate:d.connectionErrorRate,ping_pong_success_rate:d.pingPongSuccessRate,compression_ratio:d.compressionRatio,rooms_count:d.roomsCount,subscriptions_count:d.subscriptionsCount,avg_connections_per_room:d.averageConnectionsPerRoom,avg_subscriptions_per_connection:d.averageSubscriptionsPerConnection},this.updateWebSocketMetricsInConfig(e,l);return}}const i=t.requestsPerSecond||100,a=t.responseLatency||50,o=Math.sin(this.simulationTime/1500)*.1+1;s.throughput=i*o,s.latency=a+Math.random()*30,s.errorRate=.005,s.utilization=s.throughput/i*Math.random(),s.customMetrics={rps:i,p50_latency:Math.round(a*.5),p99_latency:Math.round(a*2),errors:Math.round(s.throughput*s.errorRate)}}simulateWebhook(e,t,s,n){const i=this.webhookEngines.get(e.id);if(!i){this.simulateAPI(e,t,s,n);return}const a=i.getMetrics();if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}s.throughput=a.requestsPerSecond,s.latency=a.averageLatency||50,s.errorRate=a.errorRate/100,s.utilization=a.utilization/100,s.customMetrics={rps:a.requestsPerSecond,endpoints_total:a.endpointsTotal,endpoints_enabled:a.endpointsEnabled,deliveries_total:a.deliveriesTotal,deliveries_success:a.deliveriesSuccess,deliveries_failed:a.deliveriesFailed,deliveries_pending:a.deliveriesPending,success_rate:a.successRate,retries_total:a.retriesTotal,p50_latency:Math.round(s.latency*.5),p99_latency:Math.round(s.latency*2),errors:Math.round(s.throughput*s.errorRate)}}simulateKong(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.kongRoutingEngines.get(e.id);if(!i){this.simulateAPI(e,t,s,n);return}const a=t||{},o=a.requestsPerSecond||t.requestsPerSecond||450,l=i.getStats(),d=.5*Math.sin(this.simulationTime/2e3)+.5;let h=o*d;const p=(a.plugins||[]).filter(S=>S.name==="rate-limiting"&&S.enabled);if(p.length>0){const S=Math.min(...p.map(T=>T.config?.minute||1e3));h=Math.min(h,S*d)}s.throughput=h;const g=2+Math.random()*3,v=l.plugins*.5,b=10+Math.random()*40;s.latency=g+v+b;const M=.001,x=l.consumers>0?.02:0;s.errorRate=Math.min(1,M+x),s.utilization=Math.min(1,s.throughput/o),s.customMetrics={services:l.services,routes:l.routes,upstreams:l.upstreams,consumers:l.consumers,plugins:l.plugins,requests_per_second:o,gateway_latency:g+v,upstream_latency:b}}simulateAPIGateway(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;const d=this.cloudAPIGatewayEngines.get(e.id);d&&d.resetMetrics();return}const i=this.cloudAPIGatewayEngines.get(e.id);if(!i){this.simulateAPI(e,t,s,n);return}const a=e.data.config||{},o=a.apis||[],l=i.calculateMetrics();s.throughput=l.throughput,s.latency=l.latency,s.latencyP50=l.latencyP50,s.latencyP99=l.latencyP99,s.errorRate=l.errorRate,s.utilization=l.utilization,s.customMetrics={...l.customMetrics,apis_count:o.length,keys_count:a.keys?.length||0,provider:a.provider==="aws"?1:a.provider==="azure"?2:3,auth_enabled:a.enableAuthentication?1:0,rate_limiting_enabled:a.enableRateLimiting?1:0,caching_enabled:a.enableCaching?1:0}}simulateApigee(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.apigeeRoutingEngines.get(e.id);if(!i){this.simulateAPI(e,t,s,n);return}const a=t||{},o=a.proxies||[],l=a.requestsPerSecond||t.requestsPerSecond||500,d=i.getStats(),h=.5*Math.sin(this.simulationTime/2e3)+.5;let p=l*h;const g=o.filter(E=>E.status!=="undeployed");if(g.length>0){const E=g.filter(k=>k.quota&&k.quotaInterval).map(k=>k.quota/k.quotaInterval*h);if(E.length>0){const k=Math.min(...E);p=Math.min(p,k)}const A=g.filter(k=>k.spikeArrest&&k.spikeArrest>0).map(k=>k.spikeArrest);if(A.length>0){const k=Math.min(...A);p=Math.min(p,k*h)}}s.throughput=p;const v=3+Math.random()*2,b=d.policies*.8,M=15+Math.random()*35;s.latency=v+b+M;const x=.001,S=d.policies>0?.015:0,T=d.totalErrors>0?d.totalErrors/Math.max(d.totalRequests,1)*.1:0;s.errorRate=Math.min(1,x+S+T),s.utilization=Math.min(1,s.throughput/l),s.customMetrics={proxies:d.proxies,policies:d.policies,total_requests:d.totalRequests,total_errors:d.totalErrors,avg_latency:Math.round(d.avgLatency),requests_per_second:l,gateway_latency:v+b,upstream_latency:M}}simulateMuleSoft(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.mulesoftRoutingEngines.get(e.id);if(!i){this.simulateAPI(e,t,s,n);return}const o=(t||{}).applications||[],l=i.getStats(),d=.5*Math.sin(this.simulationTime/2e3)+.5;let h=0,p=0;for(const k of o)if(k.status==="running"){const D=k.workerCount||2;p+=D,h+=D*75}h===0&&(h=100);let g=h*d;s.throughput=g;const v=5+Math.random()*10,b=l.enabledConnectors*2,M=3+Math.random()*5,x=15+Math.random()*25;s.latency=v+b+M+x;const S=.002,T=l.totalErrors>0?l.totalErrors/Math.max(l.totalRequests,1)*.15:0,E=l.runningApplications>0?.005:.01;s.errorRate=Math.min(1,S+T+E);const A=p>0?Math.min(1,s.throughput/(p*75)):.5;s.utilization=Math.min(1,A),s.customMetrics={applications:l.applications,running_applications:l.runningApplications,connectors:l.connectors,enabled_connectors:l.enabledConnectors,total_requests:l.totalRequests,total_errors:l.totalErrors,avg_latency:Math.round(l.avgLatency),total_workers:p,runtime_latency:v,connector_latency:x,transformation_latency:M}}simulateGrafana(e,t,s,n){const i=this.grafanaEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.getGrafanaMetrics(),o=i.calculateLoad();s.throughput=o.queriesPerSecond+o.alertEvaluationsPerSecond,s.latency=o.averageQueryLatency+o.averageRenderingLatency,s.errorRate=o.errorRate,s.utilization=(o.cpuUtilization+o.memoryUtilization)/2,s.customMetrics={queries_per_second:o.queriesPerSecond,dashboard_refreshes_per_second:o.dashboardRefreshesPerSecond,alert_evaluations_per_second:o.alertEvaluationsPerSecond,average_query_latency:o.averageQueryLatency,average_rendering_latency:o.averageRenderingLatency,datasource_errors:a.datasourceErrors,active_dashboards:a.activeDashboards,active_panels:a.activePanels,total_queries:a.totalQueries,cpu_utilization:o.cpuUtilization,memory_utilization:o.memoryUtilization}}simulateKeycloak(e,t,s,n){const i=this.keycloakEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics(),l=i.getConfig();s.throughput=a.requestsPerSecond,s.latency=a.averageLatency,s.errorRate=a.errorRate;const d=Math.min(.6,(a.activeSessions||0)/500),h=Math.min(.3,a.requestsPerSecond/200),p=l?.passwordPolicy?this.estimateKeycloakPolicyComplexity(l.passwordPolicy):0,g=Math.min(.2,p/100);s.utilization=Math.min(.95,.1+d+h+g),s.customMetrics={...s.customMetrics||{},keycloak_login_requests_total:o.loginRequestsTotal,keycloak_login_errors_total:o.loginErrorsTotal,keycloak_token_refresh_total:o.tokenRefreshTotal,keycloak_introspection_requests_total:o.introspectionRequestsTotal,keycloak_userinfo_requests_total:o.userInfoRequestsTotal,keycloak_sessions_active:o.activeSessions,keycloak_sessions_created_total:o.sessionsCreatedTotal,keycloak_sessions_expired_total:o.sessionsExpiredTotal,keycloak_auth_success_rate:a.authSuccessRate,keycloak_clients_configured:l?.clients.length??0,keycloak_users_configured:l?.users.length??0}}simulateVault(e,t,s,n){const i=this.vaultEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();i.getConfig(),s.throughput=a.requestsPerSecond,s.latency=a.averageLatency,s.errorRate=a.errorRate;const l=Math.min(.4,(a.secretsCount||0)/1e3),d=Math.min(.3,(a.activeTokens||0)/500),h=Math.min(.2,a.requestsPerSecond/300),p=Math.min(.1,(a.enginesEnabled||0)/10);s.utilization=Math.min(.95,.1+l+d+h+p),s.customMetrics={...s.customMetrics||{},vault_read_requests_total:o.readRequestsTotal,vault_write_requests_total:o.writeRequestsTotal,vault_delete_requests_total:o.deleteRequestsTotal,vault_list_requests_total:o.listRequestsTotal,vault_auth_requests_total:o.authRequestsTotal,vault_auth_errors_total:o.authErrorsTotal,vault_token_issued_total:o.tokenIssuedTotal,vault_token_renewed_total:o.tokenRenewedTotal,vault_token_revoked_total:o.tokenRevokedTotal,vault_tokens_active:o.activeTokens,vault_secrets_total:o.secretsTotal,vault_encryption_operations_total:o.encryptionOperationsTotal,vault_decryption_operations_total:o.decryptionOperationsTotal,vault_engines_enabled:a.enginesEnabled}}estimateKeycloakPolicyComplexity(e){if(!e)return 0;let t=0;const s=e.toLowerCase();s.includes("length(")&&(t+=20),s.includes("digits(")&&(t+=25),s.includes("special(")&&(t+=30),s.includes("uppercase(")&&(t+=15),s.includes("lowercase(")&&(t+=10);const n=(e.match(/\)/g)||[]).length;return t+=n*5,t}simulatePrometheus(e,t,s,n){const i=this.prometheusEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.getPrometheusMetrics(),o=i.calculateLoad();s.throughput=o.scrapeRequestsPerSecond,s.latency=o.averageScrapeDuration,s.errorRate=o.errorRate;const l=i.getTargetStatuses().length,d=Math.min(.95,.1+l/100*.5+o.scrapeRequestsPerSecond/10*.2);s.utilization=d,s.customMetrics={scrape_requests_total:a.scrapeRequestsTotal,scrape_errors_total:a.scrapeErrorsTotal,targets_up:a.targetsUp,targets_down:a.targetsDown,samples_scraped:a.samplesScraped,scrape_requests_per_second:o.scrapeRequestsPerSecond,samples_per_second:o.samplesPerSecond}}simulateWAF(e,t,s,n){const i=this.wafEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();i.getStats(),s.throughput=a.requestsPerSecond,s.latency=a.averageLatency;const l=i.getConfig();l?.mode==="prevention"?s.errorRate=a.blockRate:s.errorRate=0;const d=Math.min(.4,(o.activeRules||0)/50),h=Math.min(.3,a.requestsPerSecond/1e3),p=l?.enableOWASP?.15:0,g=l?.enableRateLimiting?.1:0,v=l?.enableGeoBlocking?.05:0;if(s.utilization=Math.min(.95,.1+d+h+p+g+v),s.customMetrics={...s.customMetrics||{},waf_requests_total:o.requestsTotal,waf_requests_allowed:o.requestsAllowed,waf_requests_blocked:o.requestsBlocked,waf_threats_detected:o.threatsDetected,waf_threats_blocked:o.threatsBlocked,waf_rate_limit_hits:o.rateLimitHits,waf_geo_block_hits:o.geoBlockHits,waf_ip_block_hits:o.ipBlockHits,waf_owasp_hits:o.owaspHits,waf_custom_rule_hits:o.customRuleHits,waf_active_rules:o.activeRules,waf_block_rate:a.blockRate,waf_threat_detection_rate:a.threatDetectionRate,waf_average_latency:a.averageLatency},n){const b=this.connections.filter(x=>x.target===e.id);let M=0;for(const x of b){const S=this.metrics.get(x.source);S&&(M+=S.throughput||0)}M>0&&(i.setSimulatedRequestRate(M),i.simulateRequests(M))}}simulateFirewall(e,t,s,n){const i=this.firewallEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();i.getStats(),s.throughput=a.packetsPerSecond,s.latency=a.averageLatency,s.errorRate=a.blockRate+a.rejectionRate;const l=Math.min(.3,(o.activeRules||0)/100),d=Math.min(.3,a.packetsPerSecond/1e4),h=i.getConfig()?.enableStatefulInspection?.2:0,p=i.getConfig()?.enableIntrusionDetection?.2:0;if(s.utilization=Math.min(.95,.1+l+d+h+p),s.customMetrics={...s.customMetrics||{},firewall_packets_total:o.packetsTotal,firewall_packets_allowed:o.packetsAllowed,firewall_packets_blocked:o.packetsBlocked,firewall_packets_rejected:o.packetsRejected,firewall_active_rules:o.activeRules,firewall_total_connections:o.totalConnections,firewall_active_connections:o.activeConnections,firewall_block_rate:a.blockRate,firewall_rejection_rate:a.rejectionRate,firewall_average_latency:a.averageLatency},n){const g=this.connections.filter(b=>b.target===e.id);let v=0;for(const b of g){const M=this.metrics.get(b.source);M&&(v+=M.throughput||0)}v>0&&(i.setSimulatedPacketRate(v),i.simulatePackets(v))}i.cleanup()}simulateVPN(e,t,s,n){const i=this.vpnEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();i.getConfig(),s.throughput=a.packetsPerSecond,s.latency=a.averageLatency,s.errorRate=a.errorRate;const l=Math.min(.3,a.utilization*.5),d=Math.min(.2,(o.activeTunnels||0)/10),h=Math.min(.3,a.bytesPerSecond/(100*1024*1024)),p=Math.min(.2,(o.encryptionOperations||0)/1e4);if(s.utilization=Math.min(.95,.1+l+d+h+p),s.customMetrics={...s.customMetrics||{},vpn_total_connections:o.totalConnections,vpn_active_connections:o.activeConnections,vpn_total_tunnels:o.totalTunnels,vpn_active_tunnels:o.activeTunnels,vpn_bytes_in:o.totalBytesIn,vpn_bytes_out:o.totalBytesOut,vpn_packets_in:o.totalPacketsIn,vpn_packets_out:o.totalPacketsOut,vpn_encryption_operations:o.encryptionOperations,vpn_compression_operations:o.compressionOperations,vpn_failed_connections:o.failedConnections,vpn_average_latency:a.averageLatency,vpn_connections_per_second:a.connectionsPerSecond,vpn_bytes_per_second:a.bytesPerSecond},n){const g=this.connections.filter(M=>M.target===e.id);let v=0,b=0;for(const M of g){const x=this.metrics.get(M.source);x&&(v+=x.throughput||0,b+=(x.throughput||0)*1500)}v>0&&i.simulateIncomingTraffic(v,a.connectionsPerSecond)}i.cleanupStaleConnections()}simulateCDN(e,t,s,n){const i=this.cdnEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();i.getConfig(),s.throughput=a.requestsPerSecond,s.latency=a.averageLatency,s.errorRate=a.errorRate;const l=Math.min(.2,o.activeDistributions/Math.max(1,o.totalDistributions)),d=Math.min(.2,o.activeEdgeLocations/Math.max(1,o.totalEdgeLocations)),h=Math.min(.5,a.utilization*.5),p=a.cacheHitRate>.8?.1:0;if(s.utilization=Math.min(.95,.1+l+d+h-p),s.customMetrics={...s.customMetrics||{},cdn_total_distributions:o.totalDistributions,cdn_active_distributions:o.activeDistributions,cdn_total_edge_locations:o.totalEdgeLocations,cdn_active_edge_locations:o.activeEdgeLocations,cdn_total_requests:o.totalRequests,cdn_total_cache_hits:o.totalCacheHits,cdn_total_cache_misses:o.totalCacheMisses,cdn_total_bandwidth:o.totalBandwidth,cdn_average_cache_hit_rate:o.averageCacheHitRate,cdn_average_latency:a.averageLatency,cdn_requests_per_second:a.requestsPerSecond,cdn_bandwidth_per_second:a.bandwidthPerSecond,cdn_error_rate:a.errorRate,cdn_cache_hit_rate:a.cacheHitRate},n){const g=this.connections.filter(b=>b.target===e.id);let v=0;for(const b of g){const M=this.metrics.get(b.source);M&&(v+=M.throughput||0)}v>0&&i.simulateIncomingTraffic(v)}}simulateArgoCD(e,t,s,n){const i=this.argoCDEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.syncRate/3600,s.latency=a.averageSyncDuration||0;const o=a.syncOperationsSuccess+a.syncOperationsFailed;s.errorRate=o>0?a.syncOperationsFailed/o:0,s.utilization=a.applicationsTotal>0?a.syncOperationsRunning/a.applicationsTotal:0,s.customMetrics={applicationsTotal:a.applicationsTotal,applicationsSynced:a.applicationsSynced,applicationsOutOfSync:a.applicationsOutOfSync,syncOperationsRunning:a.syncOperationsRunning,repositoriesConnected:a.repositoriesConnected}}simulateTerraform(e,t,s,n){const i=this.terraformEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.runsPerHour/3600,s.latency=a.averageRunDuration||0;const o=a.runsSuccess+a.runsFailed;s.errorRate=o>0?a.runsFailed/o:0,s.utilization=a.workspacesTotal>0?Math.min(1,a.runsRunning/a.workspacesTotal):0,s.customMetrics={workspacesTotal:a.workspacesTotal,runsTotal:a.runsTotal,runsRunning:a.runsRunning,runsPending:a.runsPending,runsSuccess:a.runsSuccess,runsFailed:a.runsFailed,statesTotal:a.statesTotal,resourcesManaged:a.resourcesManaged,runsPerHour:a.runsPerHour,averageRunDuration:a.averageRunDuration}}simulateSpark(e,t,s,n){const i=this.sparkEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics(),o=1024;s.throughput=a.throughput/o,s.latency=a.averageJobDuration||0;const l=a.succeededJobs+a.failedJobs;s.errorRate=l>0?a.failedJobs/l:0;const d=5;if(s.utilization=Math.min(1,a.activeJobs/d),a.totalExecutors>0){const h=a.aliveExecutors/a.totalExecutors;s.utilization=Math.max(s.utilization,h*.7)}s.customMetrics={totalJobs:a.totalJobs,activeJobs:a.activeJobs,succeededJobs:a.succeededJobs,failedJobs:a.failedJobs,totalStages:a.totalStages,activeStages:a.activeStages,totalExecutors:a.totalExecutors,aliveExecutors:a.aliveExecutors,totalCores:a.totalCores,totalMemory:a.totalMemory,totalMemoryUsed:a.totalMemoryUsed,totalInputBytes:a.totalInputBytes,totalOutputBytes:a.totalOutputBytes,totalShuffleRead:a.totalShuffleRead,totalShuffleWrite:a.totalShuffleWrite,jobsPerHour:a.jobsPerHour,averageJobDuration:a.averageJobDuration,throughput:a.throughput}}simulateCRM(e,t,s,n){const i=this.crmEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.requestsPerSecond,s.latency=a.averageResponseTime,s.errorRate=a.errorRate,s.utilization=(a.apiUtilization+a.databaseUtilization)/2,s.customMetrics={contactsTotal:a.contactsTotal,contactsLeads:a.contactsLeads,contactsCustomers:a.contactsCustomers,dealsTotal:a.dealsTotal,dealsActive:a.dealsActive,dealsWon:a.dealsWon,dealsLost:a.dealsLost,pipelineValue:a.pipelineValue,wonValue:a.wonValue,accountsTotal:a.accountsTotal,leadsTotal:a.leadsTotal,leadsConverted:a.leadsConverted,casesTotal:a.casesTotal,casesOpen:a.casesOpen,casesResolved:a.casesResolved,averageResolutionTime:a.averageResolutionTime,activitiesTotal:a.activitiesTotal,activitiesToday:a.activitiesToday,conversionRate:a.conversionRate,dealWinRate:a.dealWinRate,apiUtilization:a.apiUtilization,databaseUtilization:a.databaseUtilization}}simulateERP(e,t,s,n){const i=this.erpEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.requestsPerSecond,s.latency=a.averageResponseTime,s.errorRate=a.errorRate,s.utilization=a.systemUtilization,s.customMetrics={ordersTotal:a.ordersTotal,ordersPending:a.ordersPending,ordersProcessing:a.ordersProcessing,ordersShipped:a.ordersShipped,ordersDelivered:a.ordersDelivered,ordersValue:a.ordersValue,inventoryItemsTotal:a.inventoryItemsTotal,inventoryValue:a.inventoryValue,inventoryLowStock:a.inventoryLowStock,inventoryOutOfStock:a.inventoryOutOfStock,inventoryTurnover:a.inventoryTurnover,transactionsTotal:a.transactionsTotal,revenue:a.revenue,expenses:a.expenses,profit:a.profit,accountsReceivable:a.accountsReceivable,accountsPayable:a.accountsPayable,employeesTotal:a.employeesTotal,employeesActive:a.employeesActive,employeesOnLeave:a.employeesOnLeave,totalPayroll:a.totalPayroll,manufacturingOrdersTotal:a.manufacturingOrdersTotal,manufacturingOrdersInProgress:a.manufacturingOrdersInProgress,manufacturingOrdersCompleted:a.manufacturingOrdersCompleted,manufacturingCapacity:a.manufacturingCapacity,supplyItemsTotal:a.supplyItemsTotal,supplyItemsInTransit:a.supplyItemsInTransit,supplyItemsDelayed:a.supplyItemsDelayed,supplyValue:a.supplyValue}}simulatePaymentGateway(e,t,s,n){const i=this.paymentGatewayEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.requestsPerSecond,s.latency=a.averageResponseTime,s.errorRate=a.errorRate,s.utilization=(a.apiUtilization+a.processingUtilization)/2;const o=i.getMetricsByPaymentMethod(),l=i.getMetricsByCurrency(),d={transactionsTotal:a.transactionsTotal,transactionsSucceeded:a.transactionsSucceeded,transactionsPending:a.transactionsPending,transactionsFailed:a.transactionsFailed,transactionsRefunded:a.transactionsRefunded,totalAmount:a.totalAmount,totalAmountSucceeded:a.totalAmountSucceeded,totalAmountRefunded:a.totalAmountRefunded,averageAmount:a.averageAmount,successRate:a.successRate,failureRate:a.failureRate,refundRate:a.refundRate,fraudDetected:a.fraudDetected,webhooksTotal:a.webhooksTotal,webhooksEnabled:a.webhooksEnabled,webhooksTriggered:a.webhooksTriggered,webhooksFailed:a.webhooksFailed,apiUtilization:a.apiUtilization,processingUtilization:a.processingUtilization};for(const[h,p]of o.entries())d[`paymentMethod_${h}_count`]=p.count,d[`paymentMethod_${h}_successRate`]=p.successRate,d[`paymentMethod_${h}_avgAmount`]=p.avgAmount,d[`paymentMethod_${h}_totalAmount`]=p.totalAmount;for(const[h,p]of l.entries())d[`currency_${h}_count`]=p.count,d[`currency_${h}_totalAmount`]=p.totalAmount,d[`currency_${h}_avgAmount`]=p.avgAmount;s.customMetrics=d}simulateTensorFlowServing(e,t,s,n){const i=this.tensorFlowServingEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.throughput,s.latency=a.averageLatency,s.errorRate=a.errorRate;let o=a.batchUtilization;a.gpuUtilization!==void 0&&(o=Math.max(o,a.gpuUtilization)),o=Math.max(o,a.cpuUtilization),s.utilization=Math.min(1,o),s.customMetrics={totalModels:a.totalModels,servingModels:a.servingModels,loadingModels:a.loadingModels,unavailableModels:a.unavailableModels,totalPredictions:a.totalPredictions,successfulPredictions:a.successfulPredictions,failedPredictions:a.failedPredictions,averageLatency:a.averageLatency,p50Latency:a.p50Latency,p99Latency:a.p99Latency,requestsPerSecond:a.requestsPerSecond,throughput:a.throughput,errorRate:a.errorRate,batchUtilization:a.batchUtilization,gpuUtilization:a.gpuUtilization||0,memoryUsage:a.memoryUsage,cpuUtilization:a.cpuUtilization}}simulatePyTorchServe(e,t,s,n){const i=this.pytorchServeEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.throughput,s.latency=a.averageLatency,s.errorRate=a.errorRate;let o=a.batchUtilization;a.gpuUtilization!==void 0&&(o=Math.max(o,a.gpuUtilization)),o=Math.max(o,a.cpuUtilization),s.utilization=Math.min(1,o),s.customMetrics={totalModels:a.totalModels,servingModels:a.servingModels,loadingModels:a.loadingModels,unavailableModels:a.unavailableModels,totalPredictions:a.totalPredictions,successfulPredictions:a.successfulPredictions,failedPredictions:a.failedPredictions,averageLatency:a.averageLatency,p50Latency:a.p50Latency,p99Latency:a.p99Latency,requestsPerSecond:a.requestsPerSecond,throughput:a.throughput,errorRate:a.errorRate,batchUtilization:a.batchUtilization,gpuUtilization:a.gpuUtilization||0,memoryUsage:a.memoryUsage,cpuUtilization:a.cpuUtilization}}simulateFeatureStore(e,t,s,n){const i=this.featureStoreEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.throughput,s.latency=a.averageLatency,s.errorRate=a.errorRate;const o=Math.max(a.onlineStoreUtilization,a.offlineStoreUtilization);s.utilization=Math.min(1,o),s.customMetrics={totalFeatures:a.totalFeatures,activeFeatures:a.activeFeatures,deprecatedFeatures:a.deprecatedFeatures,totalFeatureSets:a.totalFeatureSets,requestsTotal:a.requestsTotal,requestsOnline:a.requestsOnline,requestsOffline:a.requestsOffline,requestsSuccess:a.requestsSuccess,requestsErrors:a.requestsErrors,averageLatency:a.averageLatency,p50Latency:a.p50Latency,p99Latency:a.p99Latency,requestsPerSecond:a.requestsPerSecond,throughput:a.throughput,errorRate:a.errorRate,cacheHits:a.cacheHits,cacheMisses:a.cacheMisses,cacheHitRate:a.cacheHitRate,onlineStoreUtilization:a.onlineStoreUtilization,offlineStoreUtilization:a.offlineStoreUtilization,validationPassed:a.validationPassed,validationFailed:a.validationFailed,totalFeatureUsage:a.totalFeatureUsage}}simulateTraefik(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.traefikEngines.get(e.id);if(!i){const l=t.maxConnections||1e4,d=t.requestsPerSecond||1e4,h=.5*Math.sin(this.simulationTime/2e3)+.5;s.throughput=d*h,s.latency=1+(1-h)*4,s.errorRate=1e-5,s.utilization=Math.min(1,s.throughput/d*(l/1e4)),s.customMetrics={max_connections:l,active_connections:Math.floor(s.throughput*.1)};return}const a=i.getStats(),o=i.getLoad();if(n&&a.totalRequests===0){const d=(t||{}).requestsPerSecond||100;i.simulateRequests(d)}s.throughput=o.requestsPerSecond,s.latency=o.averageLatency,s.errorRate=o.errorRate,s.utilization=o.utilization,s.customMetrics={routers:a.routers,active_routers:a.activeRouters,services:a.services,middlewares:a.middlewares,entry_points:a.entryPoints,total_servers:a.totalServers,healthy_servers:a.healthyServers,total_requests:a.totalRequests,total_responses:a.totalResponses,active_connections:a.activeConnections,total_bytes_in:a.totalBytesIn,total_bytes_out:a.totalBytesOut,error_rate:a.errorRate,average_latency:a.averageLatency}}simulateAnsible(e,t,s,n){const i=this.ansibleEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const a=i.getMetrics();s.throughput=a.jobsPerHour/3600,s.latency=a.averageJobDuration*1e3;const o=a.jobsSuccess+a.jobsFailed;s.errorRate=o>0?a.jobsFailed/o:0;const l=a.jobTemplatesEnabled||a.jobTemplatesTotal||1;s.utilization=Math.min(1,a.jobsRunning/l),s.customMetrics={inventoriesTotal:a.inventoriesTotal,projectsTotal:a.projectsTotal,credentialsTotal:a.credentialsTotal,jobTemplatesTotal:a.jobTemplatesTotal,jobTemplatesEnabled:a.jobTemplatesEnabled,jobsTotal:a.jobsTotal,jobsSuccess:a.jobsSuccess,jobsFailed:a.jobsFailed,jobsRunning:a.jobsRunning,jobsPending:a.jobsPending,jobsPerHour:a.jobsPerHour,averageJobDuration:a.averageJobDuration,hostsTotal:a.hostsTotal,hostsOk:a.hostsOk,hostsChanged:a.hostsChanged,hostsFailed:a.hostsFailed,hostsUnreachable:a.hostsUnreachable,schedulesTotal:a.schedulesTotal,schedulesEnabled:a.schedulesEnabled,requestsTotal:a.requestsTotal,requestsErrors:a.requestsErrors}}simulateHarbor(e,t,s,n){const i=this.harborEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();s.throughput=a.throughput,s.latency=a.averageLatency,s.errorRate=a.errorRate,s.utilization=(a.cpuUtilization+a.memoryUtilization+a.storageUtilization+a.networkUtilization)/4,s.customMetrics={...s.customMetrics||{},harbor_push_ops_per_sec:o.pushOperationsPerSecond,harbor_pull_ops_per_sec:o.pullOperationsPerSecond,harbor_scan_ops_per_sec:o.scanOperationsPerSecond,harbor_replication_ops_per_sec:o.replicationOperationsPerSecond,harbor_avg_push_latency:o.averagePushLatency,harbor_avg_pull_latency:o.averagePullLatency,harbor_avg_scan_latency:o.averageScanLatency,harbor_storage_used:o.storageUsed,harbor_storage_total:o.storageTotal,harbor_projects_total:o.totalProjects,harbor_repositories_total:o.totalRepositories,harbor_tags_total:o.totalTags,harbor_vulnerabilities_total:o.totalVulnerabilities,harbor_scans_completed:o.scansCompleted,harbor_scans_running:o.scansRunning,harbor_scans_failed:o.scansFailed,harbor_replication_policies_enabled:o.replicationPoliciesEnabled,harbor_active_replications:o.activeReplications,harbor_gc_operations_total:o.gcOperationsTotal,harbor_gc_storage_freed:o.gcStorageFreed,harbor_cpu_utilization:a.cpuUtilization,harbor_memory_utilization:a.memoryUtilization,harbor_storage_utilization:a.storageUtilization,harbor_network_utilization:a.networkUtilization}}simulateDocker(e,t,s,n){const i=this.dockerEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();s.throughput=a.throughput,s.latency=a.averageLatency,s.errorRate=a.errorRate,s.utilization=(a.cpuUtilization+a.memoryUtilization+a.networkUtilization+a.diskUtilization)/4,s.customMetrics={...s.customMetrics||{},docker_containers_total:o.containersTotal,docker_containers_running:o.containersRunning,docker_containers_stopped:o.containersStopped,docker_containers_paused:o.containersPaused,docker_images_total:o.imagesTotal,docker_images_size:o.imagesSize,docker_networks_total:o.networksTotal,docker_volumes_total:o.volumesTotal,docker_volumes_size:o.volumesSize,docker_ops_per_sec:o.operationsPerSecond,docker_avg_operation_latency:o.averageOperationLatency,docker_total_cpu_usage:o.totalCpuUsage,docker_total_memory_usage:o.totalMemoryUsage,docker_total_memory_limit:o.totalMemoryLimit,docker_total_network_rx:o.totalNetworkRx,docker_total_network_tx:o.totalNetworkTx,docker_build_ops_per_sec:o.buildOperationsPerSecond,docker_pull_ops_per_sec:o.pullOperationsPerSecond,docker_push_ops_per_sec:o.pushOperationsPerSecond,docker_cpu_utilization:a.cpuUtilization,docker_memory_utilization:a.memoryUtilization,docker_network_utilization:a.networkUtilization,docker_disk_utilization:a.diskUtilization}}simulateKubernetes(e,t,s,n){const i=this.kubernetesEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.getLoad(),o=i.getMetrics();s.throughput=a.throughput,s.latency=a.averageLatency,s.errorRate=a.errorRate,s.utilization=(a.cpuUtilization+a.memoryUtilization+a.podUtilization+a.networkUtilization+a.diskUtilization)/5,s.customMetrics={...s.customMetrics||{},k8s_pods_total:o.podsTotal,k8s_pods_running:o.podsRunning,k8s_pods_pending:o.podsPending,k8s_pods_failed:o.podsFailed,k8s_pods_succeeded:o.podsSucceeded,k8s_deployments_total:o.deploymentsTotal,k8s_deployments_ready:o.deploymentsReady,k8s_deployments_not_ready:o.deploymentsNotReady,k8s_services_total:o.servicesTotal,k8s_services_clusterip:o.servicesClusterIP,k8s_services_nodeport:o.servicesNodePort,k8s_services_loadbalancer:o.servicesLoadBalancer,k8s_nodes_total:o.nodesTotal,k8s_nodes_ready:o.nodesReady,k8s_nodes_not_ready:o.nodesNotReady,k8s_namespaces_total:o.namespacesTotal,k8s_configmaps_total:o.configMapsTotal,k8s_secrets_total:o.secretsTotal,k8s_total_cpu_usage:o.totalCpuUsage,k8s_total_memory_usage:o.totalMemoryUsage,k8s_total_memory_capacity:o.totalMemoryCapacity,k8s_cpu_utilization:a.cpuUtilization,k8s_memory_utilization:a.memoryUtilization,k8s_pod_utilization:a.podUtilization,k8s_network_utilization:a.networkUtilization,k8s_disk_utilization:a.diskUtilization}}simulateIDSIPS(e,t,s,n){const i=this.idsIpsEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();i.getStats(),s.throughput=a.packetsPerSecond,s.latency=a.averageLatency;const l=i.getConfig();l?.mode==="ips"?s.errorRate=a.blockRate:s.errorRate=0;const d=Math.min(.3,(o.activeSignatures||0)/100),h=Math.min(.3,a.packetsPerSecond/1e4),p=l?.enableSignatureDetection?.15:0,g=l?.enableAnomalyDetection?.15:0,v=l?.enableBehavioralAnalysis?.1:0;if(s.utilization=Math.min(.95,.1+d+h+p+g+v),s.customMetrics={...s.customMetrics||{},idsips_packets_total:o.packetsTotal,idsips_packets_analyzed:o.packetsAnalyzed,idsips_alerts_generated:o.alertsGenerated,idsips_alerts_blocked:o.alertsBlocked,idsips_signature_matches:o.signatureMatches,idsips_anomaly_detections:o.anomalyDetections,idsips_behavioral_detections:o.behavioralDetections,idsips_active_signatures:o.activeSignatures,idsips_blocked_ips:o.blockedIPs,idsips_alert_rate:a.alertRate,idsips_block_rate:a.blockRate},this.updateLatencyPercentiles(e.id,s.latency,s),!n){const b=this.connections.filter(x=>x.target===e.id);let M=0;for(const x of b){const S=this.metrics.get(x.source);S&&(M+=S.throughput||0)}M>0&&(i.setSimulatedPacketRate(M),i.simulatePackets(M))}}simulatePagerDuty(e,t,s,n){const i=this.pagerDutyEngines.get(e.id);if(!i){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=.1;return}const a=i.calculateLoad(),o=i.getMetrics();s.throughput=a.throughput,s.latency=a.latency,s.errorRate=a.errorRate,s.utilization=a.utilization,s.customMetrics={incidents_total:o.incidentsTotal,incidents_active:o.incidentsActive,incidents_resolved:o.incidentsResolved,notifications_sent:o.notificationsSent,escalations_triggered:o.escalationsTriggered,acknowledgements:o.acknowledgements,average_ack_latency_ms:o.averageAckLatency,average_resolve_latency_ms:o.averageResolveLatency,api_requests_per_second:o.apiRequestsPerSecond,webhooks_per_second:o.webhooksPerSecond,cpu_utilization:o.cpuUtilization,memory_utilization:o.memoryUtilization}}simulateLoki(e,t,s,n){if(!this.lokiEngines.has(e.id)){const p=new mk;p.initializeConfig(e),this.lokiEngines.set(e.id,p)}const i=this.lokiEngines.get(e.id);n&&this.processLokiIngestion(e,i);const a=i.getLokiMetrics(),o=i.calculateLoad();s.throughput=o.ingestionLinesPerSecond+o.queriesPerSecond;const l=o.ingestionLinesPerSecond/(o.ingestionLinesPerSecond+o.queriesPerSecond||1),d=1-l;s.latency=o.averageIngestionLatency*l+o.averageQueryLatency*d,s.errorRate=o.ingestionErrorRate*l+o.queryErrorRate*d;const h=Math.min(1,o.streamCount/(t.maxStreams||1e4));s.utilization=Math.max(o.storageUtilization,h),s.customMetrics={ingestion_lines_per_second:o.ingestionLinesPerSecond,ingestion_bytes_per_second:o.ingestionBytesPerSecond,ingestion_requests_total:a.ingestionRequestsTotal,ingestion_errors_total:a.ingestionErrorsTotal,ingestion_lines_total:a.ingestionLinesTotal,ingestion_bytes_total:a.ingestionBytesTotal,queries_per_second:o.queriesPerSecond,query_requests_total:a.queryRequestsTotal,query_errors_total:a.queryErrorsTotal,average_query_latency:o.averageQueryLatency,average_ingestion_latency:o.averageIngestionLatency,active_streams:o.streamCount,total_storage_size:a.totalStorageSize,storage_utilization:o.storageUtilization,retention_deletions:a.retentionDeletions}}processLokiIngestion(e,t){const s=this.connections.filter(n=>n.target===e.id);for(const n of s){const i=this.nodes.find(h=>h.id===n.source);if(!i)continue;const a=this.connectionMetrics.get(n.id);if(!a||a.traffic===0)continue;const l=a.traffic/200,d=this.generateLogsFromComponent(i,l);d.length>0&&t.processIngestion(d,i.id)}}generateLogsFromComponent(e,t){const s=[],n=e.type,i=e.data.label||e.id,a={app:i.toLowerCase().replace(/\s+/g,"-"),component:n,source:e.id.slice(0,8)},o=this.metrics.get(e.id),l=Math.ceil(t/100),d=Math.floor(t/l)||1;for(let h=0;h<l&&h<10;h++){const p=[];for(let g=0;g<d;g++){const v=Date.now()*1e6+g,b=this.getLogLevel(o),M=this.generateLogMessage(n,i,b,o);p.push([v.toString(),M])}p.length>0&&s.push({stream:{...a,level:this.getLogLevel(o)},values:p})}return s}getLogLevel(e){return e?e.errorRate>.1?"error":e.errorRate>.05||e.utilization>.9?"warn":"info":"info"}generateLogMessage(e,t,s,n){const i=new Date().toISOString();return s==="error"&&n?`[${i}] ERROR ${e}: Request failed, error rate: ${(n.errorRate*100).toFixed(2)}%`:s==="warn"&&n?`[${i}] WARN ${e}: High utilization: ${(n.utilization*100).toFixed(2)}%`:`[${i}] INFO ${e}: ${t} processing requests, throughput: ${n?.throughput.toFixed(2)||0}/s`}simulateBFF(e,t,s,n){if(!n){s.throughput=0,s.latency=0,s.errorRate=0,s.utilization=0;return}const i=this.bffRoutingEngines.get(e.id);if(!i){this.simulateAPI(e,t,s,n);return}const a=t||{},o=a.endpoints||[],l=a.backends||[],d=this.connections.filter(U=>U.target===e.id);let h=0;for(const U of d){const Q=this.connectionMetrics.get(U.id);if(Q){const F=Q.traffic/2048;h+=F}}const p=t.requestsPerSecond||h||100,g=i.getStats(),v=.3*Math.sin(this.simulationTime/2e3)+.7;s.throughput=p*v;let b=g.averageLatency||100;const M=5+Math.random()*10,x=g.cacheHitRate||0,S=x*.8,T=b*(1-S)+M;s.latency=T+Math.random()*20;const E=g.totalRequests>0?g.totalErrors/g.totalRequests:.005,A=.001;s.errorRate=Math.min(1,E+A);const k=a.maxConcurrentRequests||100,D=s.throughput*(s.latency/1e3);s.utilization=Math.min(1,D/k);const L=o.reduce((U,Q)=>U+(Q.requests||0),0),I=l.filter(U=>U.status==="connected").length;s.customMetrics={endpoints:o.length,backends:l.length,connected_backends:I,total_requests:g.totalRequests,total_errors:g.totalErrors,avg_latency:Math.round(g.averageLatency),cache_hit_rate:Math.round(x*100)/100,endpoint_requests:L,aggregation_overhead:Math.round(M),concurrent_requests:Math.round(D)}}initializeKongRoutingEngine(e){const t=e.data.config||{},s=new qE;s.initialize({services:t.services||[],routes:t.routes||[],upstreams:t.upstreams||[],consumers:t.consumers||[],plugins:t.plugins||[]}),this.kongRoutingEngines.set(e.id,s)}updateKongRoutingEngine(e){const t=this.nodes.find(i=>i.id===e);if(!t||t.type!=="kong")return;const s=this.kongRoutingEngines.get(e);if(!s){this.initializeKongRoutingEngine(t);return}const n=t.data.config||{};s.updateConfig({services:n.services||[],routes:n.routes||[],upstreams:n.upstreams||[],consumers:n.consumers||[],plugins:n.plugins||[]})}initializeCloudAPIGatewayEngine(e){const t=e.data.config||{};t.provider||(t.provider="aws");const s=new tA(t);this.cloudAPIGatewayEngines.set(e.id,s)}initializeNginxRoutingEngine(e){const t=e.data.config||{},s=new BE;s.initialize({locations:t.locations||[],upstreams:t.upstreams||[],rateLimitZones:t.rateLimitZones||[],sslCertificates:t.sslCertificates||[],enableSSL:t.enableSSL,sslPort:t.sslPort,enableGzip:t.enableGzip,enableCache:t.enableCache,maxWorkers:t.maxWorkers}),this.nginxRoutingEngines.set(e.id,s)}initializeHAProxyRoutingEngine(e){const t=e.data.config||{},s=new UE,n=(t.frontends||[]).map(a=>({id:a.id,name:a.name,bind:a.bind,mode:a.mode,defaultBackend:a.backends&&a.backends.length>0?a.backends[0]:void 0,backends:a.backends,ssl:a.ssl,requests:a.requests||0,responses:a.responses||0,bytesIn:a.bytesIn||0,bytesOut:a.bytesOut||0})),i=(t.backends||[]).map(a=>({id:a.id,name:a.name,mode:a.mode,balance:a.balance,servers:a.servers||[],healthCheck:a.healthCheck,stickTable:a.stickTable}));s.initialize({frontends:n,backends:i}),this.haproxyRoutingEngines.set(e.id,s)}initializeEnvoyRoutingEngine(e){const t=e.data.config||{},s=new FE,n=(t.clusters||[]).map(o=>({name:o.name,type:o.type||"STRICT_DNS",endpoints:(o.hosts||[]).map(l=>({address:l.address,port:l.port,weight:l.weight||1,healthStatus:l.healthStatus||"unknown"})),connectTimeout:o.connectTimeout||5e3,healthCheck:o.healthChecks?{enabled:!0,interval:o.healthCheckInterval||1e4,timeout:o.healthCheckTimeout||5e3,path:o.healthCheckPath||"/health",healthyThreshold:o.healthCheckHealthyThreshold||1,unhealthyThreshold:o.healthCheckUnhealthyThreshold||2}:void 0,circuitBreaker:o.circuitBreaker?{enabled:!0,maxConnections:o.circuitBreakerMaxConnections,maxRequests:o.circuitBreakerMaxRequests,maxRetries:o.circuitBreakerMaxRetries,consecutiveErrors:o.circuitBreakerConsecutiveErrors||5}:void 0,loadBalancingPolicy:o.loadBalancingPolicy||"ROUND_ROBIN",outlierDetection:o.outlierDetection?{enabled:!0,consecutiveErrors:o.outlierDetectionConsecutiveErrors||5,interval:o.outlierDetectionInterval||1e4,baseEjectionTime:o.outlierDetectionBaseEjectionTime||3e4,maxEjectionPercent:o.outlierDetectionMaxEjectionPercent||50}:void 0})),i=(t.listeners||[]).map(o=>({name:o.name,address:o.address||"0.0.0.0",port:o.port,protocol:o.protocol||"HTTP",filters:(o.filters||[]).map(l=>typeof l=="string"?{name:l,type:l}:l)})),a=(t.routes||[]).map(o=>({name:o.name,match:{prefix:o.match?.startsWith("/")?o.match:void 0,path:o.match&&!o.match.includes("*")&&!o.match.startsWith("/")?o.match:void 0,regex:o.match?.includes("*")?o.match.replace(/\*/g,".*"):void 0},cluster:o.cluster,priority:o.priority||0,timeout:o.timeout,retryPolicy:o.retryPolicy}));s.initialize({clusters:n,listeners:i,routes:a,globalConfig:{maxConnections:t.maxConnections||1024,connectTimeout:t.connectTimeout||5e3,requestTimeout:t.requestTimeout||15e3,drainTime:t.drainTime||600,rateLimit:t.enableRateLimiting?{enabled:!0,rate:t.rateLimitPerSecond||100,burst:t.rateLimitBurst||10}:void 0,tracing:t.enableTracing?{enabled:!0,provider:t.tracingProvider||"jaeger"}:void 0}}),this.envoyRoutingEngines.set(e.id,s)}initializeServiceMeshRoutingEngine(e){const t=e.data.config||{},s=new Zk;s.initialize({services:t.services||[],virtualServices:t.virtualServices||[],destinationRules:t.destinationRules||[],gateways:t.gateways||[],peerAuthentications:t.peerAuthentications||[],authorizationPolicies:t.authorizationPolicies||[],serviceEntries:t.serviceEntries||[],sidecars:t.sidecars||[],globalConfig:{enableMTLS:t.enableMTLS,mtlsMode:t.mtlsMode,enableTracing:t.enableTracing,tracingProvider:t.tracingProvider,enableMetrics:t.enableMetrics,metricsProvider:t.metricsProvider,enableAccessLog:t.enableAccessLog,maxConnections:t.maxConnections,defaultTimeout:t.defaultTimeout,defaultRetryAttempts:t.defaultRetryAttempts,defaultLoadBalancer:t.defaultLoadBalancer}}),this.serviceMeshRoutingEngines.set(e.id,s)}initializeIstioRoutingEngine(e){const t=e.data.config||{},s=new Tb,n=(t.services||[]).map(g=>({id:g.id||g.name,name:g.name,namespace:g.namespace||"default",host:g.host||`${g.name}.${g.namespace||"default"}.svc.cluster.local`,ports:g.ports||[{number:80,protocol:"HTTP"}],labels:g.labels||{},requests:g.requests||0,errors:g.errors||0,latency:g.latency||0,pods:g.pods||1,healthyPods:g.healthyPods||g.pods||1})),i=(t.virtualServices||[]).map(g=>({id:g.id||g.name,name:g.name,namespace:g.namespace||"default",hosts:g.hosts||[],gateways:g.gateways||[],http:g.http||[],tcp:g.tcp||[],tls:g.tls||[]})),a=(t.destinationRules||[]).map(g=>({id:g.id||g.name,name:g.name,namespace:g.namespace||"default",host:g.host,subsets:g.subsets||[],trafficPolicy:g.trafficPolicy||{}})),o=(t.gateways||[]).map(g=>({id:g.id||g.name,name:g.name,namespace:g.namespace||"default",selector:g.selector||{},servers:g.servers||[]})),l=(t.peerAuthentications||[]).map(g=>({id:g.id||g.name,name:g.name,namespace:g.namespace||"default",selector:g.selector||{},mtls:g.mtls||{mode:"PERMISSIVE"},portLevelMtls:g.portLevelMtls||{}})),d=(t.authorizationPolicies||[]).map(g=>({id:g.id||g.name,name:g.name,namespace:g.namespace||"default",selector:g.selector||{},action:g.action||"ALLOW",rules:g.rules||[]})),h=(t.serviceEntries||[]).map(g=>({id:g.id||g.name,name:g.name,namespace:g.namespace||"default",hosts:g.hosts||[],addresses:g.addresses||[],ports:g.ports||[],location:g.location||"MESH_EXTERNAL",resolution:g.resolution||"DNS",endpoints:g.endpoints||[]})),p=(t.sidecars||[]).map(g=>({id:g.id||g.name,name:g.name,namespace:g.namespace||"default",workloadSelector:g.workloadSelector||{},egress:g.egress||[],ingress:g.ingress||[]}));s.initialize({services:n,virtualServices:i,destinationRules:a,gateways:o,peerAuthentications:l,authorizationPolicies:d,serviceEntries:h,sidecars:p,globalConfig:{enableMTLS:t.enableMTLS??!0,mtlsMode:t.mtlsMode||"PERMISSIVE",enableTracing:t.enableTracing??!0,tracingProvider:t.tracingProvider||"jaeger",enableMetrics:t.enableMetrics??!0,metricsProvider:t.metricsProvider||"prometheus",enableAccessLog:t.enableAccessLog??!0,maxConnections:t.maxConnections||1e4,defaultTimeout:t.defaultTimeout||"30s",defaultRetryAttempts:t.defaultRetryAttempts||3}}),this.istioRoutingEngines.set(e.id,s)}initializeApigeeRoutingEngine(e){const t=e.data.config||{},s=new HE;s.initialize({organization:t.organization,environment:t.environment,proxies:t.proxies||[],policies:t.policies||[],products:t.products||[],developerApps:t.developerApps||[],apiKeys:t.apiKeys||[],oauthTokens:t.oauthTokens||[],jwtConfigs:t.jwtConfigs||[]}),this.apigeeRoutingEngines.set(e.id,s)}initializeMuleSoftRoutingEngine(e){const t=e.data.config||{},s=new $E,n=(t.applications||[]).map(a=>({name:a.name,runtimeVersion:a.runtimeVersion||"4.6.0",workerCount:a.workerCount||2,status:a.status||"stopped",connectors:a.connectors||[],errorStrategy:a.errorStrategy||"continue",reconnectionStrategy:a.reconnectionStrategy||"exponential",auditLogging:a.auditLogging||!1,flows:(a.flows||[]).map(o=>({id:o.id||o.name||`flow-${Date.now()}`,name:o.name||"unnamed-flow",source:o.source,processors:o.processors||[],target:o.target,errorHandlers:o.errorHandlers||[],async:o.async||!1}))})),i=(t.connectors||[]).map(a=>({name:a.name,type:a.type||"api",enabled:a.enabled!==!1,config:a.config||{},targetComponentType:a.targetComponentType,targetComponentId:a.targetComponentId}));s.initialize({organization:t.organization,environment:t.environment,applications:n,connectors:i}),this.mulesoftRoutingEngines.set(e.id,s)}initializeGraphQLGatewayRoutingEngine(e){const s=e?.data?.config||{},n=new ek,i=Array.isArray(s.services)?s.services:[],a=s.federation&&typeof s.federation=="object"?s.federation:void 0,o=i.map(l=>{const d=l.status||"disconnected",h=this.connections.some(g=>{if(g.source!==e.id)return!1;const v=this.nodes.find(T=>T.id===g.target);if(!v||v.type!=="graphql")return!1;const b=v.data?.label||v.type,M=l.name===b||l.name===v.id,x=l.endpoint,S=x&&v.id?x.includes(v.id)||l.name===b:!1;return M||S});let p=d;return l.status==="error"?p="error":h?p="connected":p="disconnected",{...l,status:p}});n.initialize({services:o,federation:a,cacheTtl:typeof s.cacheTtl=="number"?s.cacheTtl:void 0,persistQueries:typeof s.persistQueries=="boolean"?s.persistQueries:void 0,subscriptions:typeof s.subscriptions=="boolean"?s.subscriptions:void 0,enableIntrospection:typeof s.enableIntrospection=="boolean"?s.enableIntrospection:void 0,enableQueryComplexityAnalysis:typeof s.enableQueryComplexityAnalysis=="boolean"?s.enableQueryComplexityAnalysis:void 0,enableRateLimiting:typeof s.enableRateLimiting=="boolean"?s.enableRateLimiting:void 0,maxQueryDepth:typeof s.maxQueryDepth=="number"?s.maxQueryDepth:void 0,maxQueryComplexity:typeof s.maxQueryComplexity=="number"?s.maxQueryComplexity:void 0,endpoint:typeof s.endpoint=="string"?s.endpoint:void 0,globalRateLimitPerMinute:typeof s.globalRateLimitPerMinute=="number"?s.globalRateLimitPerMinute:void 0,variability:s.variability&&typeof s.variability=="object"?s.variability:void 0}),this.graphQLGatewayRoutingEngines.set(e.id,n),this.lastGraphQLGatewayUpdate.set(e.id,Date.now())}initializeBFFRoutingEngine(e){const t=e.data.config||{},s=new tk;let n=null,i="";if(t.cacheMode==="redis"){const a=this.connections.find(o=>(o.source===e.id||o.target===e.id)&&this.nodes.find(l=>l.id===(o.source===e.id?o.target:o.source))?.type==="redis");if(a){const o=this.nodes.find(l=>l.id===(a.source===e.id?a.target:a.source));o&&o.type==="redis"&&(this.redisRoutingEngines.has(o.id)||this.initializeRedisRoutingEngine(o),n=this.redisRoutingEngines.get(o.id),i=o.id)}}s.initialize({backends:t.backends||[],endpoints:t.endpoints||[],enableCaching:t.enableCaching??!0,enableRequestBatching:t.enableRequestBatching??!1,enableResponseCompression:t.enableResponseCompression??!0,defaultTimeout:t.defaultTimeout||5e3,maxConcurrentRequests:t.maxConcurrentRequests||100,cacheMode:t.cacheMode||"memory",cacheTtl:t.cacheTtl||5,fallbackEnabled:t.fallbackEnabled??!0,fallbackComponent:t.fallbackComponent,redisEngine:n||void 0,redisNodeId:i||void 0}),this.bffRoutingEngines.set(e.id,s)}initializeRestApiRoutingEngine(e){const t=e.data.config||{},s=new sk;s.initialize({baseUrl:t.baseUrl||"https://api.example.com",version:t.version||"v1",title:t.title||"REST API",description:t.description||"RESTful API service",endpoints:(t.endpoints||[]).map(n=>({id:n.id||`${n.method}:${n.path}`,path:n.path,method:n.method,description:n.description,summary:n.summary,tags:n.tags,parameters:n.parameters,requestBody:n.requestBody,responseExample:n.responseExample,targetService:n.targetService,enabled:n.enabled!==!1,timeout:n.timeout,rateLimit:n.rateLimit})),authentication:t.authentication||{type:"none"},rateLimit:t.rateLimit,cors:t.cors}),this.restApiRoutingEngines.set(e.id,s)}initializeGRPCRoutingEngine(e){const t=e.data.config||{},s=new nk;s.initialize({endpoint:t.endpoint||"localhost:50051",services:(t.services||[]).map(n=>({name:n.name,methods:(n.methods||[]).map(i=>({name:i.name,inputType:i.inputType||"google.protobuf.Empty",outputType:i.outputType||"google.protobuf.Empty",streaming:i.streaming||"unary",enabled:i.enabled!==!1,timeout:i.timeout,rateLimit:i.rateLimit,retryPolicy:i.retryPolicy})),enabled:n.enabled!==!1})),reflectionEnabled:t.reflectionEnabled??!0,enableTLS:t.enableTLS??!1,enableCompression:t.enableCompression??!0,maxMessageSize:t.maxMessageSize||4,keepAliveTime:t.keepAliveTime||30,keepAliveTimeout:t.keepAliveTimeout||5,maxConnectionIdle:t.maxConnectionIdle||300,maxConnectionAge:t.maxConnectionAge||3600,maxConnectionAgeGrace:t.maxConnectionAgeGrace||5,authentication:t.authentication||{type:"none"},rateLimit:t.rateLimit,loadBalancing:t.loadBalancing}),this.grpcRoutingEngines.set(e.id,s)}initializeWebhookRelayRoutingEngine(e){const t=e.data.config||{},s=new ik;s.initialize({relays:t.relays||[],enableRetryOnFailure:t.enableRetryOnFailure??!0,enableSignatureVerification:t.enableSignatureVerification??!0,enableRequestLogging:t.enableRequestLogging??!0,maxRetryAttempts:t.maxRetryAttempts||3,retryDelay:t.retryDelay||5,timeout:t.timeout||30}),this.webhookRelayRoutingEngines.set(e.id,s)}initializeWebhookEngine(e){const t=new ak;t.initializeConfig(e),this.webhookEngines.set(e.id,t)}initializeRedisRoutingEngine(e){const t=e.data.config||{},s=new ok;s.initialize({host:t.host||"localhost",port:t.port||6379,password:t.password||"",database:t.database||0,maxMemory:t.maxMemory||"256mb",maxMemoryPolicy:t.maxMemoryPolicy||"noeviction",enablePersistence:t.enablePersistence??!0,persistenceType:t.persistenceType||"rdb",enableCluster:t.enableCluster??!1,clusterNodes:t.clusterNodes||[],keys:Array.isArray(t.keys)?t.keys:[]}),this.redisRoutingEngines.set(e.id,s)}initializeCassandraRoutingEngine(e){const t=e.data.config||{},s=new rk;s.initialize({clusterName:t.clusterName||"archiphoenix-cluster",nodes:t.nodes||[],keyspaces:t.keyspaces||[],tables:t.tables||[],defaultConsistencyLevel:t.consistencyLevel||"QUORUM",defaultReplicationFactor:t.replicationFactor||3,datacenter:t.datacenter||"dc1"}),this.cassandraRoutingEngines.set(e.id,s)}initializeClickHouseRoutingEngine(e){const t=e.data.config||{},s=new ck;s.initialize({cluster:t.cluster||"archiphoenix-cluster",replication:t.replication||!1,tables:t.tables?.map(n=>({name:n.name,database:t.database||"default",engine:n.engine||"MergeTree",rows:n.rows||0,size:n.size||0,partitions:n.partitions||0,columns:n.columns||[]}))||[],maxMemoryUsage:t.maxMemoryUsage||10*1024*1024*1024,compression:t.compression||"LZ4"}),this.clickHouseRoutingEngines.set(e.id,s)}initializeSnowflakeRoutingEngine(e){const t=e.data.config||{},s=new lk;s.initialize({account:t.account||"archiphoenix",region:t.region||"us-east-1",warehouses:t.warehouses?.map(n=>({name:n.name,size:n.size||"Small",status:n.status||"suspended",autoSuspend:n.autoSuspend||(t.enableAutoSuspend?t.autoSuspendSeconds:void 0),autoResume:n.autoResume!==void 0?n.autoResume:t.enableAutoResume!==!1,minClusterCount:n.minClusterCount||1,maxClusterCount:n.maxClusterCount||1,currentClusterCount:n.minClusterCount||1,runningQueries:0,queuedQueries:0,totalQueriesExecuted:0,totalComputeTime:0}))||[],databases:t.databases?.map(n=>({name:n.name,comment:n.comment,retentionTime:n.retentionTime,size:n.size,schemas:n.schemas?.map(i=>({name:i.name,tables:i.tables||[],views:i.views||0,functions:i.functions||0}))||[]}))||[],role:t.role||"ACCOUNTADMIN",enableAutoSuspend:t.enableAutoSuspend,autoSuspendSeconds:t.autoSuspendSeconds,enableAutoResume:t.enableAutoResume}),this.snowflakeRoutingEngines.set(e.id,s)}initializeElasticsearchRoutingEngine(e){const t=e.data.config||{},s=new uk;s.initialize({clusterName:t.clusterName||"archiphoenix-cluster",nodes:t.nodes||["localhost:9200"],indices:t.indices||[],defaultShards:t.shards||5,defaultReplicas:t.replicas||1,refreshInterval:t.refreshInterval||"1s",enableSSL:t.enableSSL??!1,enableAuth:t.enableAuth??!1,username:t.username||"elastic",password:t.password||""}),this.elasticsearchRoutingEngines.set(e.id,s)}initializeS3RoutingEngine(e){const t=e.data.config||{},s=new dk,n=(t.buckets||[]).map(i=>({name:i.name,region:i.region||t.defaultRegion||"us-east-1",versioning:i.versioning||!1,encryption:i.encryption||"AES256",lifecycleEnabled:i.lifecycleEnabled||!1,lifecycleDays:i.lifecycleDays,glacierEnabled:i.glacierEnabled||!1,glacierDays:i.glacierDays,publicAccess:i.publicAccess||!1,lifecycleRules:t.lifecycleRules||[]}));s.initialize({buckets:n,defaultRegion:t.defaultRegion||"us-east-1"}),this.s3RoutingEngines.set(e.id,s)}initializePrometheusEngine(e){const t=new pk;t.initializeConfig(e),this.prometheusEngines.set(e.id,t)}initializeGrafanaEngine(e){const t=new gk;t.initializeConfig(e),this.grafanaEngines.set(e.id,t)}initializeGraphQLEngine(e){const t=new bk;t.initializeConfig(e),this.graphQLEngines.set(e.id,t)}initializeSOAPEngine(e){const t=new Mk;t.initializeConfig(e),this.soapEngines.set(e.id,t)}initializeWebSocketEngine(e){const t=new wk;t.initialize(e,async(s,n,i)=>await rs.sendMessage(s,n,i)),this.websocketEngines.set(e.id,t)}initializeJaegerEngine(e){const t=new yk;t.initializeConfig(e),this.jaegerEngines.set(e.id,t)}initializeOpenTelemetryCollectorEngine(e){if(this.otelCollectorEngines.has(e.id))this.otelCollectorEngines.get(e.id).initializeConfig(e);else{const t=new Sk;t.initializeConfig(e),this.otelCollectorEngines.set(e.id,t)}}initializePagerDutyEngine(e){const t=new xk;t.initializeFromNode(e),this.pagerDutyEngines.set(e.id,t)}initializeKeycloakEngine(e){const t=new Rk;t.initializeConfig(e),this.keycloakEngines.set(e.id,t)}initializeVaultEngine(e){const t=new Lk;t.initializeConfig(e),this.vaultEngines.set(e.id,t)}initializeWAFEngine(e){const t=new Ek;t.initializeConfig(e),this.wafEngines.set(e.id,t)}initializeFirewallEngine(e){const t=new Ak;t.initializeConfig(e),this.firewallEngines.set(e.id,t)}initializeVPNEngine(e){const t=new Ik;t.initializeConfig(e),this.vpnEngines.set(e.id,t)}initializeCDNEngine(e){const t=new zk;t.initializeConfig(e),this.cdnEngines.set(e.id,t)}initializeIDSIPSEngine(e){const t=new Pk;t.initializeConfig(e),this.idsIpsEngines.set(e.id,t)}initializeJenkinsEngine(e){const t=new jk;t.initializeConfig(e),this.jenkinsEngines.set(e.id,t)}initializeGitLabCIEngine(e){const t=new Ok;t.initializeConfig(e),this.gitlabCIEngines.set(e.id,t)}initializeArgoCDEngine(e){const t=new qk;t.initializeConfig(e),this.argoCDEngines.set(e.id,t)}initializeTerraformEngine(e){const t=new Hk;t.initializeConfig(e),this.terraformEngines.set(e.id,t)}initializeAnsibleEngine(e){const t=new Vk;t.initializeConfig(e),this.ansibleEngines.set(e.id,t)}initializeSparkEngine(e){const t=new Kk;t.initializeConfig(e),this.sparkEngines.set(e.id,t)}initializeTensorFlowServingEngine(e){const t=new Yk;t.initializeConfig(e),this.tensorFlowServingEngines.set(e.id,t)}initializePyTorchServeEngine(e){const t=new Xk;t.initializeConfig(e),this.pytorchServeEngines.set(e.id,t)}initializeFeatureStoreEngine(e){const t=new Jk;t.initializeConfig(e),this.featureStoreEngines.set(e.id,t)}initializeCRMEngine(e){const t=new sA;t.initializeConfig(e),this.crmEngines.set(e.id,t)}initializeERPEngine(e){const t=new nA;t.initializeConfig(e),this.erpEngines.set(e.id,t)}initializePaymentGatewayEngine(e){const t=new iA;t.initializeConfig(e),this.paymentGatewayEngines.set(e.id,t)}initializeTraefikEngine(e){const t=new Wk;t.initializeConfig(e),this.traefikEngines.set(e.id,t)}initializeHarborEngine(e){const t=new $k;t.initializeConfig(e),this.harborEngines.set(e.id,t)}initializeDockerEngine(e){const t=new Fk;t.initializeConfig(e),this.dockerEngines.set(e.id,t)}initializeKubernetesEngine(e){const t=new Qk;t.initializeConfig(e),this.kubernetesEngines.set(e.id,t)}createLokiQueryExecutor(e){const n=((e.data.config||{}).datasources||[]).find(l=>typeof l=="string"?!1:l.type==="loki");if(!n||typeof n=="string")return;const i=n.url||"",a=this.nodes.find(l=>l.type!=="loki"?!1:((l.data.config||{}).serverUrl||"http://loki:3100")===i||i.includes(l.id)||i.includes(l.data.label||""));if(!a)return;const o=this.lokiEngines.get(a.id);if(o)return(l,d,h,p)=>{const g=o.executeQuery(l,d,h,p);return{success:g.success,latency:g.latency,resultsCount:g.resultsCount,error:g.error}}}isPrometheusAvailableForGrafana(e){const t=this.connections.find(a=>a.source===e.id&&this.nodes.find(o=>o.id===a.target)?.type==="prometheus");if(!t)return!1;const s=this.nodes.find(a=>a.id===t.target);if(!s||!this.prometheusEngines.get(s.id))return!1;const i=this.metrics.get(s.id);return!(i&&i.errorRate>.5)}initializePostgreSQLConnectionPool(e){const t=e.data.config||{},s={maxConnections:t.maxConnections||100,minConnections:t.minConnections||0,idleTimeout:t.idleTimeout||3e5,maxLifetime:t.maxLifetime||36e5,connectionTimeout:t.connectionTimeout||5e3},n=new hk(s);this.postgresConnectionPools.set(e.id,n)}updateElasticsearchMetricsInConfig(e,t){const s=e.data.config||{};s.clusterHealth=t.clusterHealth,s.activeShards=t.activeShards,s.relocatingShards=t.relocatingShards,s.initializingShards=t.initializingShards;const n=s.indices||[],i=this.elasticsearchRoutingEngines.get(e.id)?.getIndices()||[];for(let a=0;a<n.length;a++){const o=n[a],l=i.find(d=>d.name===o.name);l&&(n[a]={...o,docs:l.docs,size:l.size,health:l.health})}s.indices=n,s.totalDocs=t.totalDocs,s.totalSize=t.totalSize}updateS3BucketMetricsInConfig(e,t){const s=e.data.config||{},n=s.buckets||[];for(let i=0;i<n.length;i++){const a=n[i],o=t.get(a.name);o&&(n[i]={...a,objectCount:o.objectCount,totalSize:o.totalSize})}s.buckets=n}calculateConnectionLatency(e,t,s){const n=this.getConnectionProtocol(e),i={sync:5,async:2,http:10,grpc:5,websocket:3};let a=10;n?a={rest:10,graphql:12,soap:15,grpc:5,websocket:3,webhook:10}[n]||10:a=i[e.type]||10;const o=t.latency||0,l=s.latency||0,d=e.data||{},h=d.latencyMs||0,p=(d.jitterMs||0)*(Math.random()-.5),g=2+Math.random()*8+h+p;let v=1;return n&&(v=this.protocolTransformer.calculateProtocolLatencyMultiplier(n)),(a+(o+l)/2+g)*v}getConnectionProtocol(e){return e.type&&["rest","graphql","soap","grpc","websocket","webhook"].includes(e.type)?e.type:e.data?.protocol?e.data.protocol:e.type==="http"?"rest":null}calculateCacheHitRatio(e,t){let s=.95;t>0&&t<100?s=.9+Math.random()*.05:t>=100&&t<1e3?s=.95+Math.random()*.04:t>=1e3&&(s=.92+Math.random()*.05);const n=Math.sin(this.simulationTime/1e4)*.02;return Math.max(.85,Math.min(.99,s+n))}createDefaultMetrics(e,t){return{id:e,type:t,throughput:0,latency:0,errorRate:0,utilization:0,timestamp:Date.now()}}createDefaultConnectionMetrics(e){return{id:e.id,source:e.source,target:e.target,traffic:0,latency:0,errorRate:0,utilization:0,timestamp:Date.now(),throughputDependency:0,backpressure:0,bottleneck:!1,effectiveThroughput:0,congestion:0}}initializeMetrics(){this.metrics.clear(),this.connectionMetrics.clear(),this.latencyHistory.clear(),this.connectionLatencyHistory.clear();for(const e of this.nodes)this.metrics.set(e.id,this.createDefaultMetrics(e.id,e.type))}getComponentMetrics(e){return this.metrics.get(e)}updateComponentCustomMetrics(e,t){const s=this.metrics.get(e);if(s){if(t.throughput!==void 0&&(s.throughput+=t.throughput),t.latency!==void 0){const n=s.latency||0,i=t.latency;s.latency=n*.9+i*.1}if(t.utilization!==void 0){const n=s.utilization||0,i=t.utilization;s.utilization=Math.min(1,n*.9+i*.1)}t.customMetrics&&(s.customMetrics={...s.customMetrics,...t.customMetrics}),s.timestamp=Date.now(),this.metrics.set(e,s)}}getRabbitMQRoutingEngine(e){return this.rabbitMQRoutingEngines.get(e)}getActiveMQRoutingEngine(e){return this.activeMQRoutingEngines.get(e)}getSQSRoutingEngine(e){return this.sqsRoutingEngines.get(e)}getAzureServiceBusRoutingEngine(e){return this.azureServiceBusRoutingEngines.get(e)}getPubSubRoutingEngine(e){return this.pubSubRoutingEngines.get(e)}getKafkaRoutingEngine(e){return this.kafkaRoutingEngines.get(e)}getRedisRoutingEngine(e){return this.redisRoutingEngines.get(e)}getCassandraRoutingEngine(e){return this.cassandraRoutingEngines.get(e)}getClickHouseRoutingEngine(e){return this.clickHouseRoutingEngines.get(e)}getSnowflakeRoutingEngine(e){return this.snowflakeRoutingEngines.get(e)}getElasticsearchRoutingEngine(e){return this.elasticsearchRoutingEngines.get(e)}getKongRoutingEngine(e){return this.kongRoutingEngines.get(e)}getCloudAPIGatewayEngine(e){return this.cloudAPIGatewayEngines.get(e)}getNginxRoutingEngine(e){return this.nginxRoutingEngines.get(e)}getHAProxyRoutingEngine(e){return this.haproxyRoutingEngines.get(e)}getTraefikEmulationEngine(e){return this.traefikEngines.get(e)}getEnvoyRoutingEngine(e){return this.envoyRoutingEngines.get(e)}getIstioRoutingEngine(e){return this.istioRoutingEngines.get(e)}getServiceMeshRoutingEngine(e){return this.serviceMeshRoutingEngines.get(e)}getApigeeRoutingEngine(e){return this.apigeeRoutingEngines.get(e)}updateApigeeRoutingEngine(e){const t=this.nodes.find(i=>i.id===e);if(!t||t.type!=="apigee")return;const s=this.apigeeRoutingEngines.get(e);if(!s){try{this.initializeApigeeRoutingEngine(t)}catch(i){this.errorCollector.addError(i,{severity:"critical",source:"apigee-update",componentId:e,componentType:"apigee"})}return}const n=t.data.config||{};try{s.updateConfig({organization:n.organization,environment:n.environment,proxies:n.proxies||[],policies:n.policies||[],products:n.products||[],developerApps:n.developerApps||[],apiKeys:n.apiKeys||[],oauthTokens:n.oauthTokens||[],jwtConfigs:n.jwtConfigs||[]})}catch(i){this.errorCollector.addError(i,{severity:"critical",source:"apigee-update",componentId:e,componentType:"apigee"})}}getMuleSoftRoutingEngine(e){return this.mulesoftRoutingEngines.get(e)}updateMuleSoftRoutingEngine(e){const t=this.nodes.find(n=>n.id===e);if(!t||t.type!=="mulesoft")return;const s=this.mulesoftRoutingEngines.get(e);if(!s){try{this.initializeMuleSoftRoutingEngine(t)}catch(n){qe.addError(n,{severity:"critical",source:"mulesoft-update",componentId:e,componentType:"mulesoft"})}return}try{const n=t.data.config||{},i=(n.applications||[]).map(o=>({name:o.name,runtimeVersion:o.runtimeVersion||"4.6.0",workerCount:o.workerCount||2,status:o.status||"stopped",connectors:o.connectors||[],errorStrategy:o.errorStrategy||"continue",reconnectionStrategy:o.reconnectionStrategy||"exponential",auditLogging:o.auditLogging||!1,flows:(o.flows||[]).map(l=>({id:l.id||l.name||`flow-${Date.now()}`,name:l.name||"unnamed-flow",source:l.source,processors:l.processors||[],target:l.target,errorHandlers:l.errorHandlers||[],async:l.async||!1}))})),a=(n.connectors||[]).map(o=>({name:o.name,type:o.type||"api",enabled:o.enabled!==!1,config:o.config||{},targetComponentType:o.targetComponentType,targetComponentId:o.targetComponentId}));s.initialize({organization:n.organization,environment:n.environment,applications:i,connectors:a})}catch(n){qe.addError(n,{severity:"critical",source:"mulesoft-update",componentId:e,componentType:"mulesoft"})}}getGraphQLGatewayRoutingEngine(e){return this.graphQLGatewayRoutingEngines.get(e)}getBFFRoutingEngine(e){return this.bffRoutingEngines.get(e)}getRestApiRoutingEngine(e){return this.restApiRoutingEngines.get(e)}getGRPCRoutingEngine(e){return this.grpcRoutingEngines.get(e)}getWebhookRelayRoutingEngine(e){return this.webhookRelayRoutingEngines.get(e)}getWebhookEmulationEngine(e){return this.webhookEngines.get(e)}getLokiEmulationEngine(e){return this.lokiEngines.get(e)}getKeycloakEmulationEngine(e){return this.keycloakEngines.get(e)}getJenkinsEmulationEngine(e){return this.jenkinsEngines.get(e)}getGitLabCIEmulationEngine(e){return this.gitlabCIEngines.get(e)}getArgoCDEmulationEngine(e){return this.argoCDEngines.get(e)}getTerraformEmulationEngine(e){return this.terraformEngines.get(e)}getAnsibleEmulationEngine(e){return this.ansibleEngines.get(e)}getHarborEmulationEngine(e){return this.harborEngines.get(e)}getDockerEmulationEngine(e){return this.dockerEngines.get(e)}getSparkEmulationEngine(e){return this.sparkEngines.get(e)}getTensorFlowServingEmulationEngine(e){return this.tensorFlowServingEngines.get(e)}getPyTorchServeEmulationEngine(e){return this.pytorchServeEngines.get(e)}getFeatureStoreEmulationEngine(e){return this.featureStoreEngines.get(e)}getCRMEmulationEngine(e){return this.crmEngines.get(e)}getERPEmulationEngine(e){return this.erpEngines.get(e)}getPaymentGatewayEmulationEngine(e){return this.paymentGatewayEngines.get(e)}getKubernetesEmulationEngine(e){return this.kubernetesEngines.get(e)}getVaultEmulationEngine(e){return this.vaultEngines.get(e)}getWAFEmulationEngine(e){return this.wafEngines.get(e)}getFirewallEmulationEngine(e){return this.firewallEngines.get(e)}getVPNEmulationEngine(e){return this.vpnEngines.get(e)}getCDNEmulationEngine(e){return this.cdnEngines.get(e)}getIDSIPSEmulationEngine(e){return this.idsIpsEngines.get(e)}getGraphQLEmulationEngine(e){return this.graphQLEngines.get(e)}getSOAPEmulationEngine(e){return this.soapEngines.get(e)}getWebSocketEmulationEngine(e){return this.websocketEngines.get(e)}getJaegerEmulationEngine(e){return this.jaegerEngines.get(e)}getAllJaegerEngines(){return new Map(this.jaegerEngines)}getOpenTelemetryCollectorRoutingEngine(e){return this.otelCollectorEngines.get(e)}checkSQSIAMPolicy(e,t,s,n){if(!e||e.length===0)return!0;const i=e.filter(l=>{const d=l.principal||"";if(d!==t&&d!=="*"&&!t.includes(d))return!1;const h=l.resource||"";let p=!1;if(h==="*"||h===s)p=!0;else if(h.endsWith("*")){const v=h.slice(0,-1);p=s.startsWith(v.replace(/.*:/,""))}else if(h.includes("sqs:")||h.includes("arn:aws:sqs")){const v=h.split(":").pop()||h.split("/").pop()||"";p=v===s||v==="*"||s.includes(v)}else p=s.includes(h)||h==="*";if(!p)return!1;const g=l.action||"";return!(g!==n&&g!=="*"&&!g.includes(n))});return i.length===0?!0:i.filter(l=>l.effect==="Deny").length>0?!1:(i.filter(l=>l.effect==="Allow").length>0,!0)}checkActiveMQACLPermissionPublic(e,t,s,n){return this.checkActiveMQACLPermission(e,t,s,n)}getConnectionMetrics(e){return this.connectionMetrics.get(e)}getAllComponentMetrics(){return Array.from(this.metrics.values())}getAllConnectionMetrics(){return Array.from(this.connectionMetrics.values())}getPagerDutyIncidents(e){const t=this.pagerDutyEngines.get(e);return t?t.getIncidents():[]}getPagerDutyMetrics(e){const t=this.pagerDutyEngines.get(e);return t?t.getMetrics():null}acknowledgePagerDutyIncident(e,t){const s=this.pagerDutyEngines.get(e);s&&s.acknowledgeIncident(Date.now(),t)}resolvePagerDutyIncident(e,t){const s=this.pagerDutyEngines.get(e);s&&s.resolveIncidentManually(Date.now(),t)}getIsRunning(){return this.isRunning}getSimulationTime(){return this.simulationTime}}const ve=new aA;function oA(c,e){let t=null;return function(...n){const i=()=>{t=null,c(...n)};t!==null&&clearTimeout(t),t=setTimeout(i,e)}}class rA{logLevel;logs=[];maxLogs=100;constructor(){this.logLevel=2}debug(e,t){this.log(0,e,void 0,t)}info(e,t){this.log(1,e,void 0,t)}warn(e,t,s){this.log(2,e,t,s)}error(e,t,s){this.log(3,e,t,s)}log(e,t,s,n){if(e<this.logLevel)return;const i={level:e,message:t,error:s,timestamp:Date.now(),context:n};this.logs.push(i),this.logs.length>this.maxLogs&&this.logs.shift();const a=`[${this.getLevelName(e)}] ${t}`,o=n?{...n,error:s}:s;switch(e){case 0:console.debug(a,o||"");break;case 1:console.info(a,o||"");break;case 2:console.warn(a,o||"");break;case 3:console.error(a,o||"");break}}getLevelName(e){switch(e){case 0:return"DEBUG";case 1:return"INFO";case 2:return"WARN";case 3:return"ERROR";default:return"UNKNOWN"}}getRecentLogs(e,t=50){let s=this.logs;return e!==void 0&&(s=this.logs.filter(n=>n.level>=e)),s.slice(-t)}clearLogs(){this.logs=[]}setLogLevel(e){this.logLevel=e}}const Xf=new rA,Nr=(c,e)=>Xf.info(c,e),Or=(c,e,t)=>Xf.warn(c,e,t),bs=(c,e,t)=>Xf.error(c,e,t),Eb=["rest","grpc","graphql","soap","websocket","webhook"];function cA(c){const e={success:!0,migratedNodes:0,migratedConnections:0,errors:[]};try{const{nodes:t,connections:s}=c,n=t.filter(v=>Eb.includes(v.type));if(n.length===0)return Nr("No protocol nodes found, migration not needed"),{state:c,result:e};Nr(`Found ${n.length} protocol nodes to migrate`);const i=new Map(t.map(v=>[v.id,v])),a=new Map(s.map(v=>[v.id,v])),o=new Set,l=new Set,d=[];for(const v of n){const b=v.type;try{const M=s.filter(S=>S.target===v.id),x=s.filter(S=>S.source===v.id);for(const S of M){const T=i.get(S.source);if(!T){e.errors.push(`Source node ${S.source} not found for connection ${S.id}`);continue}if(x.length>0)for(const E of x){const A=i.get(E.target);if(!A){e.errors.push(`Target node ${E.target} not found for connection ${E.id}`);continue}if(T.id===A.id)continue;const k=s.find(D=>D.source===T.id&&D.target===A.id);if(k){const D={...k,type:b,data:{...k.data,protocol:b,protocolConfig:{...k.data?.protocolConfig,...v.data?.config&&{...v.data.config}}}};d.push(D),l.add(k.id)}else{const D={id:`conn-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,source:T.id,target:A.id,type:b,label:`${T.data.label}  ${A.data.label} (${b})`,data:{protocol:b,latencyMs:S.data?.latencyMs,bandwidthMbps:S.data?.bandwidthMbps,packetLossPercent:S.data?.packetLossPercent,jitterMs:S.data?.jitterMs,priorityLevel:S.data?.priorityLevel,retryCount:S.data?.retryCount,timeoutMs:S.data?.timeoutMs,enableMonitoring:S.data?.enableMonitoring,protocolConfig:v.data?.config?{...v.data.config}:void 0},sourcePort:S.sourcePort,targetPort:E.targetPort};d.push(D)}l.add(S.id),l.add(E.id)}else l.add(S.id),e.errors.push(`Protocol node ${v.id} has no outgoing connections`)}M.length===0&&x.length>0&&(e.errors.push(`Protocol node ${v.id} has outgoing but no incoming connections`),x.forEach(S=>l.add(S.id))),o.add(v.id),e.migratedNodes++}catch(M){const x=`Error migrating protocol node ${v.id}: ${M instanceof Error?M.message:String(M)}`;e.errors.push(x),bs(x,M instanceof Error?M:new Error(String(M)))}}const h=t.filter(v=>!o.has(v.id)),p=[...s.filter(v=>!l.has(v.id)),...d],g=Array.from(new Map(p.map(v=>[v.id,v])).values());return e.migratedConnections=d.length,Nr(`Migration complete: removed ${e.migratedNodes} protocol nodes, created/updated ${e.migratedConnections} connections`),e.errors.length>0&&Or(`Migration completed with ${e.errors.length} errors`),{state:{...c,nodes:h,connections:g},result:e}}catch(t){e.success=!1;const s=`Migration failed: ${t instanceof Error?t.message:String(t)}`;return e.errors.push(s),bs(s,t instanceof Error?t:new Error(String(t))),{state:c,result:e}}}function lA(c){return c.nodes.some(e=>Eb.includes(e.type))}const So="archiphoenix_diagram",ya=2,uA=500;function kb(c){try{let e=c;if(c.version<2)if(Nr(`Migrating diagram from version ${c.version} to ${ya}`),lA(e)){const{state:t,result:s}=cA(e);if(s.success)e={...t,version:ya,name:e.name,createdAt:e.createdAt,updatedAt:new Date().toISOString()},Nr(`Migration successful: ${s.migratedNodes} nodes, ${s.migratedConnections} connections`),s.errors.length>0&&Or(`Migration warnings: ${s.errors.join("; ")}`);else return bs("Migration failed",new Error(s.errors.join("; "))),null}else e={...e,version:ya,updatedAt:new Date().toISOString()};return e}catch(e){return bs("Failed to apply migrations",e instanceof Error?e:new Error(String(e))),null}}const dA=()=>{try{const c=localStorage.getItem(So);if(!c)return null;const e=JSON.parse(c);if(!e.nodes||!e.connections)return Or("Invalid diagram structure"),null;if(e.groups||(e.groups=[]),e.version!==ya){const t=kb(e);if(t){try{localStorage.setItem(So,JSON.stringify(t)),localStorage.setItem(`${So}_createdAt`,t.createdAt)}catch(s){Or("Failed to save migrated diagram",s instanceof Error?s:new Error(String(s)))}return t}return null}return e}catch(c){return bs("Failed to load diagram from storage",c instanceof Error?c:new Error(String(c))),null}},hA=(c,e="My Diagram")=>{try{const t={...c,version:ya,name:e,createdAt:localStorage.getItem(`${So}_createdAt`)||new Date().toISOString(),updatedAt:new Date().toISOString()};localStorage.setItem(So,JSON.stringify(t)),localStorage.setItem(`${So}_createdAt`,t.createdAt)}catch(t){bs("Failed to save diagram to storage",t instanceof Error?t:new Error(String(t)))}},mt=oA(hA,uA),fA=(c,e="diagram.json")=>{try{const t={...c,version:ya,name:e.replace(".json",""),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},s=JSON.stringify(t,null,2),n=new Blob([s],{type:"application/json"}),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}catch(t){bs("Failed to export diagram",t instanceof Error?t:new Error(String(t)))}},pA=c=>new Promise(e=>{try{const t=new FileReader;t.onload=s=>{try{const n=s.target?.result,i=JSON.parse(n);if(!i.nodes||!i.connections||typeof i.zoom!="number"||!i.pan)throw new Error("Invalid diagram format");if(i.groups||(i.groups=[]),i.version||(i.version=1),i.version!==ya){const a=kb(i);a?e(a):(bs("Migration failed during import",new Error("Migration returned null")),e(null))}else e(i)}catch(n){bs("Failed to parse diagram file",n instanceof Error?n:new Error(String(n))),e(null)}},t.readAsText(c)}catch(t){bs("Failed to import diagram",t instanceof Error?t:new Error(String(t))),e(null)}}),gA=50,zr=hn((c,e)=>({past:[],future:[],canUndo:!1,canRedo:!1,pushState:t=>{c(s=>{const n=[...s.past,t];return n.length>gA&&n.shift(),{past:n,future:[],canUndo:!0,canRedo:!1}})},undo:()=>{const{past:t,future:s}=e();if(t.length===0)return null;const n=t[t.length-1],i=t.slice(0,-1);return c({past:i,future:[n,...s],canUndo:i.length>0,canRedo:!0}),n},redo:()=>{const{past:t,future:s}=e();if(s.length===0)return null;const n=s[0],i=s.slice(1);return c({past:[...t,n],future:i,canUndo:!0,canRedo:i.length>0}),n},clearHistory:()=>{c({past:[],future:[],canUndo:!1,canRedo:!1})}}));class mA{rules=new Map;allRules=[];register(e){const t=e.sourceType;this.rules.has(t)||this.rules.set(t,[]);const s=this.rules.get(t);s&&(s.push(e),this.allRules.push(e),s.sort((n,i)=>(i.priority||0)-(n.priority||0)))}registerMany(e){e.forEach(t=>this.register(t))}findRules(e,t){const s=[],n=this.rules.get(e)||[];for(const a of n)(a.targetTypes==="*"||Array.isArray(a.targetTypes)&&a.targetTypes.includes(t))&&s.push(a);const i=this.rules.get("*")||[];for(const a of i)(a.targetTypes==="*"||Array.isArray(a.targetTypes)&&a.targetTypes.includes(t))&&s.push(a);return s.sort((a,o)=>(o.priority||0)-(a.priority||0))}getAllRules(){return[...this.allRules]}getRulesForSource(e){return this.rules.get(e)||[]}clear(){this.rules.clear(),this.allRules=[]}}const yA={postgres:5432,mongodb:27017,redis:6379,cassandra:9042,clickhouse:8123,elasticsearch:9200,rest:8080,grpc:50051,graphql:4e3,websocket:8080,webhook:8080,soap:8080,nginx:80,envoy:80,haproxy:80,traefik:80,docker:2375,kubernetes:6443,kafka:9092,rabbitmq:5672,activemq:61616,"aws-sqs":9324,prometheus:9090,grafana:3e3,loki:3100,jaeger:16686,keycloak:8080,"secrets-vault":8200,crm:8080,erp:8080,"payment-gateway":443},vA={"api-gateway":9100,postgres:9187,redis:9121,"service-mesh":15014,istio:15014,envoy:9901,cdn:9101,"aws-sqs":9102};class Ab{getHost(e){return e.data.label?e.data.label.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""):e.id.slice(0,8)}getPort(e,t){const s=e.data.config||{};switch(t){case"main":return s.port||s.host?.split(":")[1]||yA[e.type];case"metrics":return s.metricsPort||s.metrics?.port||vA[e.type];case"admin":return s.adminPort||s.admin?.port}}getEndpoint(e,t="main"){const s=this.getHost(e),n=this.getPort(e,t);if(!n)throw new Error(`Port not found for ${e.type}:${t}`);return`${s}:${n}`}getURL(e,t="main",s="http"){const n=this.getEndpoint(e,t);return`${s}://${n}`}getConnectionMetadata(e,t,s){const n=this.getHost(e),i=this.getHost(t),a=this.getPort(e,"main"),o=this.getPort(t,"main");let l="http";const d=s.type||s.data?.protocol;return d&&(["rest","graphql","soap","grpc","websocket","webhook","http"].includes(d)?l=d:d==="async"?l="async":d==="sync"&&(l="sync")),(!d||l==="http")&&(t.type==="kafka"?l="kafka":(t.type==="rabbitmq"||t.type==="activemq")&&(l="rabbitmq")),{protocol:l,sourceHost:n,targetHost:i,sourcePort:a,targetPort:o,endpoint:o?`${i}:${o}`:void 0}}getCapabilities(e){return{defaultPort:this.getPort(e,"main"),metricsPort:this.getPort(e,"metrics"),adminPort:this.getPort(e,"admin"),getHost:t=>this.getHost(t),getPort:(t,s)=>this.getPort(t,s)}}}class bA{registry;discovery;constructor(){this.registry=new mA,this.discovery=new Ab}initialize(e){this.registry.registerMany(e)}handleConnectionCreated(e,t,s,n){const i=this.registry.findRules(e.type,t.type);if(i.length===0)return{sourceUpdated:!1,targetUpdated:!1};let a=!1,o=!1;const l=this.discovery.getConnectionMetadata(e,t,s);for(const d of i)try{const h=d.updateSourceConfig(e,t,s,l);if(h&&Object.keys(h).length>0&&(n(e.id,{data:{...e.data,config:{...e.data.config,...h}}}),a=!0),d.updateTargetConfig){const p=d.updateTargetConfig(e,t,s,l);p&&Object.keys(p).length>0&&(n(t.id,{data:{...t.data,config:{...t.data.config,...p}}}),o=!0)}}catch(h){bs(`Error applying rule for ${e.type} -> ${t.type}`,h instanceof Error?h:new Error(String(h)),{sourceType:e.type,targetType:t.type})}return{sourceUpdated:a,targetUpdated:o}}handleConnectionDeleted(e,t,s,n){const i=this.registry.findRules(e.type,t.type);if(i.length===0)return{sourceUpdated:!1,targetUpdated:!1};let a=!1,o=!1;const l=this.discovery.getConnectionMetadata(e,t,s);for(const d of i)try{if(d.cleanupSourceConfig){const h=d.cleanupSourceConfig(e,t,s,l);h&&Object.keys(h).length>0&&(n(e.id,{data:{...e.data,config:{...e.data.config,...h}}}),a=!0)}if(d.cleanupTargetConfig){const h=d.cleanupTargetConfig(e,t,s,l);h&&Object.keys(h).length>0&&(n(t.id,{data:{...t.data,config:{...t.data.config,...h}}}),o=!0)}}catch(h){bs(`Error cleaning up rule for ${e.type} -> ${t.type}`,h instanceof Error?h:new Error(String(h)),{sourceType:e.type,targetType:t.type})}return{sourceUpdated:a,targetUpdated:o}}getDiscovery(){return this.discovery}getRegistry(){return this.registry}}function MA(c){return{sourceType:"envoy",targetTypes:["rest","grpc","graphql","websocket","soap","webhook","postgres","mongodb","redis","cassandra","clickhouse","crm","erp","payment-gateway"],priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const a=(e.data.config||{}).clusters||[],o=a.find(p=>!p.hosts||!Array.isArray(p.hosts)?!1:p.hosts.some(g=>g.address===n.targetHost&&g.port===n.targetPort));if(o)return o.hosts.some(g=>g.address===n.targetHost&&g.port===n.targetPort)?null:{clusters:a.map(g=>g===o?{...g,hosts:[...g.hosts||[],{address:n.targetHost,port:n.targetPort}]}:g)};t.data.label||t.type;const l=`${t.type}-${t.id.slice(0,8)}-cluster`;let d="STRICT_DNS";n.protocol==="grpc"?d="STRICT_DNS":(t.type==="postgres"||t.type==="mongodb"||t.type==="redis")&&(d="STATIC_DNS");const h={name:l,type:d,hosts:[{address:n.targetHost,port:n.targetPort}],healthChecks:!0,connectTimeout:5e3,requests:0,errors:0};return{clusters:[...a,h],totalClusters:a.length+1}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function wA(c){return{sourceType:"api-gateway",targetTypes:"*",priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const a=(e.data.config||{}).apis||[],o=s.type||s.data?.protocol||n.protocol||"http",d=`http://${n.targetHost}:${n.targetPort}`,h=`https://${n.targetHost}:${n.targetPort}`;if(a.find(S=>S.backendUrl===d||S.backendUrl===h||S.backend===d||S.backend===h))return null;const v=`${t.data.label||t.type}-api`,b=`/api/${t.type}`;let M="GET";o==="grpc"||o==="gRPC"?M="POST":(o==="websocket"||o==="WebSocket")&&(M="GET");const x={id:`api-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:v,path:b,method:M,backendUrl:d,enabled:!0,requests:0,errors:0,providerMetadata:{}};return{apis:[...a,x]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function SA(c){return{sourceType:"kong",targetTypes:"*",priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const i=e.data.config||{},a=i.services||[],o=i.routes||[],l=s.type||s.data?.protocol||n.protocol||"http",h=`http://${n.targetHost}:${n.targetPort}`,g=`${t.data.label||t.type}-service`;let v=a.find(T=>T.name===g||T.url===h);v||(v={id:String(a.length+1),name:g,url:h,routes:0,enabled:!0},a.push(v));const b=`/api/${t.type}`;if(o.find(T=>T.service===v.name&&T.path===b))return null;let x="GET";l==="grpc"||l==="gRPC"?x="POST":(l==="websocket"||l==="WebSocket"||l==="rest"||l==="graphql"||l==="http")&&(x="GET");const S={id:String(o.length+1),path:b,method:x,service:v.name,stripPath:!0,protocols:["http","https"]};return v.routes=(v.routes||0)+1,{services:a,routes:[...o,S]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function xA(c){return{sourceType:"service-mesh",targetTypes:"*",priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const a=(e.data.config||{}).services||[];if(a.find(g=>g.host===n.targetHost&&g.port===n.targetPort))return null;const d=(t.data.label||t.type).toLowerCase().replace(/\s+/g,"-");let h="http";n.protocol==="grpc"?h="grpc":(t.type==="postgres"||t.type==="mongodb"||t.type==="redis")&&(h="tcp");const p={name:d,namespace:"default",host:n.targetHost,port:n.targetPort,protocol:h,enabled:!0};return{services:[...a,p]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function CA(c){return{sourceType:"istio",targetTypes:"*",priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const a=(e.data.config||{}).services||[];if(a.find(g=>g.host===n.targetHost&&g.port===n.targetPort))return null;const d=(t.data.label||t.type).toLowerCase().replace(/\s+/g,"-");let h="http";n.protocol==="grpc"?h="grpc":(t.type==="postgres"||t.type==="mongodb"||t.type==="redis")&&(h="tcp");const p={name:d,namespace:"default",host:n.targetHost,port:n.targetPort,protocol:h,enabled:!0};return{services:[...a,p]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function RA(c){return{sourceType:"nginx",targetTypes:["rest","grpc","graphql","websocket","postgres","mongodb","redis","crm","erp","payment-gateway"],priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const a=(e.data.config||{}).upstreams||[],o=`${t.type}-upstream`;let l=a.find(h=>h.name===o);if(l)return l.servers?.some(p=>(p.host===n.targetHost||p.address===`${n.targetHost}:${n.targetPort}`)&&(p.port===n.targetPort||p.address?.includes(`:${n.targetPort}`)))?null:{upstreams:a.map(p=>p.name===o?{...p,servers:[...p.servers||[],{host:n.targetHost,port:n.targetPort}]}:p)};const d={name:o,servers:[{host:n.targetHost,port:n.targetPort}],loadBalancing:"round-robin"};return{upstreams:[...a,d]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function TA(c){return{sourceType:"haproxy",targetTypes:["rest","grpc","graphql","websocket","postgres","mongodb","redis","crm","erp","payment-gateway"],priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const a=(e.data.config||{}).backends||[],o=`${t.type}-backend`;let l=a.find(h=>h.name===o);if(l)return l.servers?.some(p=>(p.host===n.targetHost||p.address===`${n.targetHost}:${n.targetPort}`)&&(p.port===n.targetPort||p.address?.includes(`:${n.targetPort}`)))?null:{backends:a.map(p=>p.name===o?{...p,servers:[...p.servers||[],{host:n.targetHost,port:n.targetPort}]}:p)};const d={name:o,servers:[{host:n.targetHost,port:n.targetPort}],balance:"roundrobin"};return{backends:[...a,d]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function EA(c){return{sourceType:"traefik",targetTypes:["rest","grpc","graphql","websocket","postgres","mongodb","redis","crm","erp","payment-gateway"],priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const i=e.data.config||{},a=i.services||{},o=i.routers||{},l=`${t.type}-service`,d=`${t.type}-router`;if(a[l])return a[l].servers?.some(v=>v.url===`http://${n.targetHost}:${n.targetPort}`)?null:{services:{...a,[l]:{...a[l],servers:[...a[l].servers||[],{url:`http://${n.targetHost}:${n.targetPort}`}]}}};const p=`Host(\`${(t.data.label||t.type).toLowerCase()}.local\`)`;return{services:{...a,[l]:{loadBalancer:{servers:[{url:`http://${n.targetHost}:${n.targetPort}`}]}}},routers:{...o,[d]:{rule:p,service:l}}}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function kA(c){return{sourceType:"*",targetTypes:["postgres","mongodb","redis","cassandra","clickhouse","elasticsearch"],priority:5,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const i=e.data.config||{},a=t.type;let o={};switch(a){case"postgres":o={database:{host:n.targetHost,port:n.targetPort,database:i.database?.database||"postgres",username:i.database?.username||"postgres",password:i.database?.password||""}};break;case"mongodb":o={database:{connectionString:`mongodb://${n.targetHost}:${n.targetPort}`,database:i.database?.database||"admin"}};break;case"redis":o={database:{host:n.targetHost,port:n.targetPort,password:i.database?.password||""}};break;case"cassandra":o={database:{hosts:[`${n.targetHost}:${n.targetPort}`],keyspace:i.database?.keyspace||"system"}};break;case"clickhouse":o={database:{host:n.targetHost,port:n.targetPort,database:i.database?.database||"default"}};break;case"elasticsearch":o={database:{hosts:[`http://${n.targetHost}:${n.targetPort}`]}};break;default:return null}return o},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function AA(c){return{sourceType:"*",targetTypes:["kafka","rabbitmq","activemq","aws-sqs","azure-service-bus","gcp-pubsub"],priority:5,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const i=e.data.config||{},a=t.type;let o={};switch(a){case"kafka":o={messaging:{broker:`${n.targetHost}:${n.targetPort}`,topic:i.messaging?.topic||t.data.config?.defaultTopic||"default-topic",producerId:i.messaging?.producerId||e.id.slice(0,8)}};break;case"rabbitmq":o={messaging:{broker:`${n.targetHost}:${n.targetPort}`,exchange:i.messaging?.exchange||t.data.config?.defaultExchange||"amq.topic",routingKey:i.messaging?.routingKey||"default"}};break;case"activemq":const l=t.data.config?.queues||[],d=l.length>0&&typeof l[0]=="object"?l[0].name:l.length>0?l[0]:null;o={messaging:{broker:`${n.targetHost}:${n.targetPort}`,queue:i.messaging?.queue||d||"default-queue"}};break;case"aws-sqs":{const h=t.data.config?.queues||[],p=h.length>0&&typeof h[0]=="object"?h[0].name:h.length>0?h[0]:null,g=h.length>0&&typeof h[0]=="object"?h[0].region:t.data.config?.defaultRegion||"us-east-1";o={messaging:{queueUrl:`https://sqs.${g}.amazonaws.com/account/${p||"default-queue"}`,queueName:p||"default-queue",region:i.messaging?.region||g}};break}case"azure-service-bus":{const h=t.data.config||{},p=h.namespace||"archiphoenix.servicebus.windows.net";h.connectionString||`${p}`;const g=i.messaging?.entityType||h.entityType||"queue",v=i.messaging?.entityName||i.messaging?.queue||i.messaging?.topic||h.entityName||(g==="queue"?"events":"events-topic"),b=i.messaging?.subscriptionName||h.subscriptionName;o={messaging:{connectionString:h.connectionString||`Endpoint=sb://${p}/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=...`,namespace:p,entityType:g,queue:g==="queue"?v:void 0,topic:g==="topic"?v:void 0,subscriptionName:g==="topic"&&b?b:void 0}};break}case"gcp-pubsub":o={messaging:{projectId:i.messaging?.projectId||"default-project",topic:i.messaging?.topic||t.data.config?.defaultTopic||"default-topic"}};break;default:return null}return o},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function DA(c,e){const t=c.data.config||{};return t.metrics?.port?t.metrics.port:t.metricsPort?t.metricsPort:(c.type==="service-mesh"||c.type==="istio")&&t.metrics?.controlPlanePort?t.metrics.controlPlanePort:e.getPort(c,"metrics")}function PA(c){const e=c.data.config||{};return e.metrics?.path?e.metrics.path:e.metricsPath?e.metricsPath:c.type==="envoy"?e.metrics?.prometheusPath||"/stats/prometheus":"/metrics"}function cv(c){return c.data.label?c.data.label.toLowerCase().replace(/\s+/g,"-"):`${c.type}-${c.id.slice(0,8)}`}function lv(c,e){const t=e.getHost(c),s=DA(c,e);if(!s){const n=e.getPort(c,"main");return n?`${t}:${n}`:null}return`${t}:${s}`}function LA(c){return{sourceType:"*",targetTypes:["prometheus"],priority:5,updateTargetConfig:(e,t,s,n)=>{const i=t.data.config||{},a=i.scrape_configs||[],o=i.scrapeInterval||"15s",l=PA(e),d=lv(e,c);if(!d)return null;const h=cv(e),p={component:e.type,componentId:e.id},g=a.findIndex(b=>b.job_name===h);if(g>=0){const b=a[g];let M=!1;for(const x of b.static_configs||[]){if(x.targets&&x.targets.includes(d)){M=!0;break}if(x.labels?.componentId===e.id){x.targets.includes(d)||x.targets.push(d),M=!0;break}}if(!M){const x=[...a],S=[...b.static_configs||[]];return S.push({targets:[d],labels:p}),x[g]={...b,static_configs:S},{scrape_configs:x}}return null}const v={job_name:h,scrape_interval:o!=="15s"?o:void 0,metrics_path:l!=="/metrics"?l:void 0,static_configs:[{targets:[d],labels:p}]};return{scrape_configs:[...a,v]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s),cleanupTargetConfig:(e,t,s,n)=>{const a=(t.data.config||{}).scrape_configs||[];if(!a||a.length===0)return null;const o=lv(e,c),l=cv(e),d=e.id;let h=!1;const p=a.map(g=>{if(g.job_name!==l)return g;const v=(g.static_configs||[]).map(b=>{if(b.labels?.componentId===d)return h=!0,null;if(o&&b.targets&&b.targets.includes(o)){const M=b.targets.filter(x=>x!==o);return M.length===0?(h=!0,null):(h=!0,{...b,targets:M})}return b}).filter(b=>b!==null);return v.length===0?(h=!0,null):{...g,static_configs:v}}).filter(g=>g!==null);return h?{scrape_configs:p}:null}}}function _A(c){return{sourceType:"grafana",targetTypes:["prometheus"],priority:10,updateSourceConfig:(e,t,s,n)=>{let a=(e.data.config||{}).datasources||[];a.length>0&&typeof a[0]=="string"&&(a=a.map(g=>({name:g,type:"prometheus",url:"http://localhost:9090",access:"proxy",isDefault:g===a[0]})));const o=c.getURL(t,"main"),l=n.targetHost||c.getHost(t),d=n.targetPort||c.getPort(t,"main")||9090,h=d===9090?`http://${l}:${d}`:o,p=a.findIndex(g=>g&&typeof g=="object"&&(g.type==="prometheus"||g.name?.toLowerCase().includes("prometheus")));if(p>=0){const g=[...a];return g[p]={...g[p],url:h,type:"prometheus",isDefault:g[p].isDefault??!0},{datasources:g}}else{const g={name:"Prometheus",type:"prometheus",url:h,access:"proxy",isDefault:a.length===0};return{datasources:[...a,g]}}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s),cleanupSourceConfig:(e,t,s,n)=>{let a=(e.data.config||{}).datasources||[];if(a.length>0&&typeof a[0]=="string")return null;const o=c.getURL(t,"main"),l=n.targetHost||c.getHost(t),d=n.targetPort||c.getPort(t,"main")||9090,h=d===9090?`http://${l}:${d}`:o,p=a.filter(g=>!(g&&typeof g=="object"&&g.url===h&&g.type==="prometheus"));return p.length!==a.length?{datasources:p}:null}}}function Db(c){const e=["postgres","mongodb","redis","cassandra","clickhouse","snowflake","elasticsearch"],t=["rest","grpc","graphql","soap","websocket","webhook"],s=["kafka","rabbitmq","activemq","aws-sqs","azure-service-bus","gcp-pubsub"],n=["s3-datalake"],i=["crm","erp","payment-gateway"];return e.includes(c)?"database":t.includes(c)?"api":s.includes(c)?"messaging":n.includes(c)?"file":i.includes(c)?"api":"custom"}function $l(c,e,t){const s=t?c.label||c.type:e.label||e.type,n=t?c.id.slice(0,8):e.id.slice(0,8);return`${s}-${n}`.toLowerCase().replace(/\s+/g,"-")}function IA(c){return{sourceType:"*",targetTypes:["mulesoft"],priority:5,updateTargetConfig:(e,t,s,n)=>{const a=(t.data.config||{}).connectors||[];if(a.find(p=>p.targetComponentId===e.id||p.name===$l(e,t,!0)))return null;const l=Db(e.type),h={name:$l(e,t,!0),type:l,enabled:!0,config:{},targetComponentType:e.type,targetComponentId:e.id};return l==="database"&&n.targetHost&&n.targetPort?h.config={host:n.targetHost,port:n.targetPort}:l==="api"&&n.targetHost&&n.targetPort?h.config={baseUrl:`http://${n.targetHost}:${n.targetPort}`}:l==="messaging"&&(h.config={broker:n.targetHost&&n.targetPort?`${n.targetHost}:${n.targetPort}`:void 0}),{connectors:[...a,h]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function NA(c){return{sourceType:"mulesoft",targetTypes:"*",priority:5,updateSourceConfig:(e,t,s,n)=>{const a=(e.data.config||{}).connectors||[];if(a.find(p=>p.targetComponentId===t.id||p.name===$l(e,t,!1)))return null;const l=Db(t.type),h={name:$l(e,t,!1),type:l,enabled:!0,config:{},targetComponentType:t.type,targetComponentId:t.id};return l==="database"&&n.targetHost&&n.targetPort?h.config={host:n.targetHost,port:n.targetPort}:l==="api"&&n.targetHost&&n.targetPort?h.config={baseUrl:`http://${n.targetHost}:${n.targetPort}`}:l==="messaging"&&n.targetHost&&n.targetPort&&(h.config={broker:`${n.targetHost}:${n.targetPort}`}),{connectors:[...a,h]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function zA(c){return{sourceType:"graphql-gateway",targetTypes:["graphql"],priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const a=(e.data.config||{}).services||[],o=`http://${n.targetHost}:${n.targetPort}/graphql`;if(a.find(p=>p.endpoint===o||p.name===t.data.label))return null;const d=t.data.label||t.type,h={id:`svc-${a.length+1}`,name:d,endpoint:o,status:"connected",requests:0,errors:0};return{services:[...a,h]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function jA(c){return{sourceType:"bff-service",targetTypes:"*",priority:10,updateSourceConfig:(e,t,s,n)=>{if(!n.targetHost||!n.targetPort)return null;const a=(e.data.config||{}).backends||[],o=t.data.label||t.type;if(a.find(g=>g.name===o||g.endpoint===`http://${n.targetHost}:${n.targetPort}`||g.id===t.id))return null;let d="http";const h=s.type||s.data?.protocol||n.protocol;h==="grpc"||h==="gRPC"?d="grpc":h==="graphql"||h==="GraphQL"?d="graphql":(h==="rest"||h==="http")&&(d="http");const p={id:t.id||`backend-${Date.now()}`,name:o,endpoint:`http://${n.targetHost}:${n.targetPort}`,protocol:d,status:"connected",timeout:5e3,retries:3,retryBackoff:"exponential",circuitBreaker:{enabled:!0,failureThreshold:5,successThreshold:2,timeout:6e4}};return{backends:[...a,p]}},extractMetadata:(e,t,s)=>c.getConnectionMetadata(e,t,s)}}function OA(c){return[MA(c),RA(c),TA(c),EA(c),wA(c),SA(c),zA(c),jA(c),xA(c),CA(c),kA(c),AA(c),LA(c),_A(c),IA(c),NA(c)]}let tf=null;function uv(){if(!tf){const c=new Ab,e=new bA,t=OA(c);e.initialize(t),tf=e}return tf}const Ws=2e3,dv=140,hv=200,Ml=(c,e)=>({x:Math.floor(c/Ws),y:Math.floor(e/Ws)}),qA=(c,e,t,s,n,i)=>{const a=n*Ws,o=(n+1)*Ws,l=i*Ws,d=(i+1)*Ws,h=c,p=c+t,g=e,v=e+s;return!(p<a||h>o||v<l||g>d)},sf=c=>{const e=new Set,t=dv+hv,s=dv+hv,n=c.position.x,i=n+t,a=c.position.y,o=a+s,l=Ml(n,a).x,d=Ml(i,o).x,h=Ml(n,a).y,p=Ml(i,o).y;for(let g=l;g<=d;g++)for(let v=h;v<=p;v++)qA(n,a,t,s,g,v)&&e.add(`${g},${v}`);return e},Qs=(c,e=[])=>{if(c.length===0)return[];const t=new Set,s=new Map(c.map(n=>[n.id,n]));return c.forEach(n=>{sf(n).forEach(a=>t.add(a))}),e.forEach(n=>{const i=s.get(n.source),a=s.get(n.target);i&&sf(i).forEach(l=>t.add(l)),a&&sf(a).forEach(l=>t.add(l))}),Array.from(t).map(n=>{const[i,a]=n.split(",").map(Number);return{x:i,y:a}})},Vs=c=>{if(c.length===0)return{minX:0,minY:0,maxX:Ws,maxY:Ws};const e=c.map(o=>o.x),t=c.map(o=>o.y),s=Math.min(...e),n=Math.min(...t),i=Math.max(...e),a=Math.max(...t);return{minX:s*Ws,minY:n*Ws,maxX:(i+1)*Ws,maxY:(a+1)*Ws}},nf={nodes:[],connections:[],groups:[],zoom:1,pan:{x:0,y:0}},ke=hn((c,e)=>{const t=dA(),s=t?{...nf,...t,groups:t.groups||[]}:nf;let n=!1,i=!1;const a=()=>{const h=e();return{nodes:h.nodes,connections:h.connections,groups:h.groups||[],zoom:h.zoom,pan:h.pan}},o=()=>{zr.getState().pushState(a())},l=Qs(s.nodes,s.connections||[]),d=Vs(l);return{...s,selectedNodeId:null,selectedConnectionId:null,diagramName:t?.name||"Untitled Diagram",viewportWidth:0,viewportHeight:0,canvasBounds:d,canvasChunks:l,getDiagramState:a,updateCanvasBounds:()=>c(h=>{const p=Qs(h.nodes,h.connections);return{canvasChunks:p,canvasBounds:Vs(p)}}),addNode:h=>c(p=>{o();const g=[...p.nodes,h],v=Qs(g,p.connections),b={nodes:g,canvasChunks:v,canvasBounds:Vs(v)};return mt({...p,...b},p.diagramName),b}),updateNode:(h,p,g=!1)=>c(v=>{!g&&!n&&o();const b=v.nodes.map(S=>S.id===h?{...S,...p}:S),M=Qs(b,v.connections),x={nodes:b,canvasChunks:M,canvasBounds:Vs(M)};return(!n||!g)&&mt({...v,...x},v.diagramName),x}),updateNodes:(h,p=!1)=>c(g=>{!p&&!n&&!i&&o();const v=new Map(h.map(S=>[S.id,S.updates])),b=g.nodes.map(S=>{const T=v.get(S.id);return T?{...S,...T}:S}),M=Qs(b,g.connections),x={nodes:b,canvasChunks:M,canvasBounds:Vs(M)};return(!i||!p)&&mt({...g,...x},g.diagramName),x}),deleteNode:h=>c(p=>{o();const g=p.nodes.filter(x=>x.id!==h),v=p.connections.filter(x=>x.source!==h&&x.target!==h),b=Qs(g,v),M={nodes:g,connections:v,selectedNodeId:p.selectedNodeId===h?null:p.selectedNodeId,canvasChunks:b,canvasBounds:Vs(b)};return mt({...p,...M},p.diagramName),M}),selectNode:(h,p=!1)=>c(g=>p&&h&&g.nodes.find(b=>b.id===h)?{selectedNodeId:h,nodes:g.nodes.map(b=>({...b,selected:b.id===h?!b.selected:b.selected||!1}))}:{selectedNodeId:h,nodes:g.nodes.map(v=>({...v,selected:v.id===h}))}),selectNodesByIds:h=>c(p=>({selectedNodeId:h.length>0?h[0]:null,nodes:p.nodes.map(g=>({...g,selected:h.includes(g.id)}))})),addConnection:h=>c(p=>{o();const g={...h,type:h.type||"async"},v=p.nodes.find(E=>E.id===g.source),b=p.nodes.find(E=>E.id===g.target);let M=[...p.nodes];if(v&&b){const E=uv(),A=(k,D)=>{const L=M.findIndex(I=>I.id===k);L!==-1&&(M[L]={...M[L],...D})};E.handleConnectionCreated(v,b,g,A)}const x=[...p.connections,g],S=Qs(M,x),T={nodes:M,connections:x,canvasChunks:S,canvasBounds:Vs(S)};return mt({...p,...T},p.diagramName),T}),updateConnection:(h,p)=>c(g=>{o();const v={connections:g.connections.map(b=>b.id===h?{...b,...p}:b)};return mt({...g,...v},g.diagramName),v}),deleteConnection:h=>c(p=>{o();const g=p.connections.find(S=>S.id===h);let v=[...p.nodes];if(g){const S=p.nodes.find(E=>E.id===g.source),T=p.nodes.find(E=>E.id===g.target);if(S&&T){const E=uv(),A=(k,D)=>{const L=v.findIndex(I=>I.id===k);L!==-1&&(v[L]={...v[L],...D})};E.handleConnectionDeleted(S,T,g,A)}}const b=p.connections.filter(S=>S.id!==h),M=Qs(v,b),x={nodes:v,connections:b,selectedConnectionId:p.selectedConnectionId===h?null:p.selectedConnectionId,canvasChunks:M,canvasBounds:Vs(M)};return mt({...p,...x},p.diagramName),x}),selectConnection:h=>c(p=>({selectedConnectionId:h,selectedNodeId:null,selectedGroupId:null,connections:p.connections.map(g=>({...g,selected:g.id===h}))})),addGroup:h=>c(p=>{o();const g={groups:[...p.groups,h]};return mt({...p,...g},p.diagramName),g}),updateGroup:(h,p)=>c(g=>{o();const v={groups:g.groups.map(b=>b.id===h?{...b,...p}:b)};return mt({...g,...v},g.diagramName),v}),deleteGroup:h=>c(p=>{o();const g={groups:p.groups.filter(v=>v.id!==h)};return mt({...p,...g},p.diagramName),g}),addNodeToGroup:(h,p)=>c(g=>{o();const v={groups:g.groups.map(b=>b.id===h&&!b.nodeIds.includes(p)?{...b,nodeIds:[...b.nodeIds,p]}:b)};return mt({...g,...v},g.diagramName),v}),removeNodeFromGroup:(h,p)=>c(g=>{o();const v={groups:g.groups.map(b=>b.id===h?{...b,nodeIds:b.nodeIds.filter(M=>M!==p)}:b)};return mt({...g,...v},g.diagramName),v}),selectGroup:h=>c(p=>({selectedGroupId:h,selectedNodeId:null,selectedConnectionId:null})),createGroupFromSelection:h=>c(p=>{o();const g=p.nodes.filter(M=>M.selected||M.id===p.selectedNodeId).map(M=>M.id);if(g.length===0)return p;const v={id:`group-${Date.now()}`,name:h,nodeIds:g,color:`hsl(${Math.random()*360}, 70%, 50%)`},b={groups:[...p.groups,v],nodes:p.nodes.map(M=>({...M,selected:!1})),selectedNodeId:null};return mt({...p,...b},p.diagramName),b}),autoGroupByConnections:()=>c(h=>{o();const p=new Set;h.groups.forEach(E=>{E.nodeIds.forEach(A=>p.add(A))});const g=new Map,v=E=>{g.has(E)||g.set(E,E);const A=g.get(E);if(A!==void 0&&A!==E){const k=v(A);return g.set(E,k),k}return A??E},b=(E,A)=>{const k=v(E),D=v(A);k!==D&&g.set(k,D)};h.connections.forEach(E=>{!p.has(E.source)&&!p.has(E.target)&&b(E.source,E.target)});const M=new Map;h.nodes.forEach(E=>{if(!p.has(E.id)){const A=v(E.id);M.has(A)||M.set(A,[]);const k=M.get(A);k&&k.push(E.id)}});const x=[];let S=h.groups.length+1;M.forEach((E,A)=>{E.length>=2&&x.push({id:`group-${Date.now()}-${x.length}`,name:`Group ${S++}`,nodeIds:E,color:`hsl(${Math.random()*360}, 70%, 50%)`})});const T={groups:[...h.groups,...x]};return mt({...h,...T},h.diagramName),T}),setZoom:h=>c(p=>(mt({...p,zoom:h},p.diagramName),{zoom:h})),setPan:h=>c(p=>(mt({...p,pan:h},p.diagramName),{pan:h})),setViewportSize:h=>c(()=>({viewportWidth:h.width,viewportHeight:h.height})),setDiagramName:h=>c(p=>(mt(p,h),{diagramName:h})),loadDiagramState:(h,p=!1)=>c(()=>{p||o();const g=Qs(h.nodes||[],h.connections||[]),v={...h,canvasChunks:g,canvasBounds:Vs(g)};return mt(v,e().diagramName),v}),saveDiagram:()=>{const h=e();mt(h,h.diagramName)},resetCanvas:()=>{o();const h=Qs([],[]);c({...nf,canvasChunks:h,canvasBounds:Vs(h)})},undo:()=>{const h=zr.getState().undo();h&&c(()=>{const p=Qs(h.nodes||[],h.connections||[]),g={...h,canvasChunks:p,canvasBounds:Vs(p)};return mt(g,e().diagramName),g})},redo:()=>{const h=zr.getState().redo();h&&c(()=>{const p=Qs(h.nodes||[],h.connections||[]),g={...h,canvasChunks:p,canvasBounds:Vs(p)};return mt(g,e().diagramName),g})},startDragOperation:h=>{const p=e();n=!0,p.nodes.find(g=>g.id===h),o()},endDragOperation:()=>{n=!1;const h=e();mt(h,h.diagramName)},setGroupDragging:h=>{i=h},getIsGroupDragging:()=>i,bringToFront:h=>c(p=>{o();const g=p.nodes.findIndex(x=>x.id===h);if(g===-1)return p;const v=[...p.nodes],[b]=v.splice(g,1);v.push(b);const M={nodes:v};return mt({...p,...M},p.diagramName),M}),sendToBack:h=>c(p=>{o();const g=p.nodes.findIndex(x=>x.id===h);if(g===-1)return p;const v=[...p.nodes],[b]=v.splice(g,1);v.unshift(b);const M={nodes:v};return mt({...p,...M},p.diagramName),M}),bringForward:h=>c(p=>{o();const g=p.nodes.findIndex(M=>M.id===h);if(g===-1||g===p.nodes.length-1)return p;const v=[...p.nodes];[v[g],v[g+1]]=[v[g+1],v[g]];const b={nodes:v};return mt({...p,...b},p.diagramName),b}),sendBackward:h=>c(p=>{o();const g=p.nodes.findIndex(M=>M.id===h);if(g===-1||g===0)return p;const v=[...p.nodes];[v[g],v[g-1]]=[v[g-1],v[g]];const b={nodes:v};return mt({...p,...b},p.diagramName),b})}}),zi=hn((c,e)=>({isRunning:!1,messages:new Map,messageHistory:[],initialize:(t,s)=>{rs.initialize(t,s),e().updateMessages(t,s)},start:()=>{rs.start(),c({isRunning:!0});const t=setInterval(()=>{const{nodes:s,connections:n}=ke.getState();e().updateMessages(s,n)},200);rs._pollInterval=t},stop:()=>{rs.stop();const t=rs._pollInterval;t&&clearInterval(t),c({isRunning:!1})},updateMessages:(t,s)=>{rs.updateNodesAndConnections(t,s);const n=new Map;for(const a of s)n.set(a.id,rs.getConnectionMessages(a.id));const i=rs.getMessageHistory(100);c({messages:n,messageHistory:i})},getConnectionMessages:t=>rs.getConnectionMessages(t),getComponentMessages:t=>rs.getComponentMessages(t),getMessageHistory:t=>rs.getMessageHistory(t)}));class HA{nodes=[];connections=[];componentMetrics=new Map;connectionMetrics=new Map;dependencyGraph=new Map;componentStatuses=new Map;update(e,t,s,n){this.nodes=e,this.connections=t,this.componentMetrics=s,this.connectionMetrics=n,this.buildDependencyGraph(),this.analyzeComponentHealth(),this.identifyCriticalPaths(),this.calculateImpactScores()}buildDependencyGraph(){this.dependencyGraph.clear();for(const e of this.nodes){const t=[],s=this.connections.filter(n=>n.target===e.id);for(const n of s){const i=this.connectionMetrics.get(n.id),a=this.componentMetrics.get(n.source);if(!i||!a)continue;const o=Math.max(i.throughputDependency,i.utilization,i.backpressure);let l="direct";i.bottleneck?l="critical":o>.7&&(l="indirect"),t.push({sourceId:n.source,targetId:e.id,connectionId:n.id,type:l,strength:o,impact:this.calculateDependencyImpact(n,a)})}this.dependencyGraph.set(e.id,t)}}calculateDependencyImpact(e,t){const s=this.connectionMetrics.get(e.id);if(!s)return 0;const n=t.errorRate,i=Math.min(1,s.latency/1e3),a=s.backpressure,o=t.utilization>.8?.5:0;return Math.min(1,n*.4+i*.2+a*.3+o*.1)}analyzeComponentHealth(){this.componentStatuses.clear();for(const e of this.nodes){const t=this.componentMetrics.get(e.id),s=this.dependencyGraph.get(e.id)||[];if(!t){this.componentStatuses.set(e.id,{nodeId:e.id,health:"down",dependencies:s,dependents:[],criticalPath:!1,impactScore:0,failureRisk:1});continue}let n="healthy",i=0;t.errorRate>.1?(n="critical",i+=.4):t.errorRate>.05&&(n="degraded",i+=.2),t.utilization>.9?(n==="healthy"&&(n="degraded"),i+=.3):t.utilization>.8&&(i+=.15),t.latency>1e3?(n==="healthy"&&(n="degraded"),i+=.2):t.latency>500&&(i+=.1);for(const o of s){const l=this.componentStatuses.get(o.sourceId);l&&(l.health==="critical"||l.health==="down"?(n==="healthy"&&(n="degraded"),i+=o.impact*.3):l.health==="degraded"&&(i+=o.impact*.15))}i=Math.min(1,i);const a=[];for(const o of this.connections)if(o.source===e.id){const l=this.connectionMetrics.get(o.id);l&&a.push({sourceId:e.id,targetId:o.target,connectionId:o.id,type:l.bottleneck?"critical":"direct",strength:l.throughputDependency,impact:this.calculateDependencyImpact(o,t)})}this.componentStatuses.set(e.id,{nodeId:e.id,health:n,dependencies:s,dependents:a,criticalPath:!1,impactScore:0,failureRisk:i})}}identifyCriticalPaths(){const e=this.nodes.filter(s=>!this.connections.some(n=>n.target===s.id)),t=this.nodes.filter(s=>!this.connections.some(n=>n.source===s.id));for(const s of e)for(const n of t){const i=this.findPath(s.id,n.id);i&&i.length>1&&i.some(o=>{const l=this.componentStatuses.get(o),d=this.connections.find(h=>i.includes(h.source)&&i.includes(h.target)&&i.indexOf(h.source)<i.indexOf(h.target));if(d){const h=this.connectionMetrics.get(d.id);return h?.bottleneck||(h?.backpressure||0)>.7}return l?.health==="critical"||l?.health==="down"})&&i.forEach(o=>{const l=this.componentStatuses.get(o);l&&(l.criticalPath=!0)})}}findPath(e,t){if(e===t)return[e];const s=[{nodeId:e,path:[e]}],n=new Set([e]);for(;s.length>0;){const{nodeId:i,path:a}=s.shift(),o=this.connections.filter(l=>l.source===i);for(const l of o){if(l.target===t)return[...a,t];n.has(l.target)||(n.add(l.target),s.push({nodeId:l.target,path:[...a,l.target]}))}}return null}calculateImpactScores(){for(const[e,t]of this.componentStatuses.entries()){let s=0;s+=Math.min(1,t.dependents.length/5)*.3,t.health==="critical"||t.health==="down"?s+=.4:t.health==="degraded"&&(s+=.2),t.criticalPath&&(s+=.2),s+=t.failureRisk*.1,t.impactScore=Math.min(1,s),this.componentStatuses.set(e,t)}}analyzeSystem(){const e=[],t=[],s=[],n=[];for(const[l,d]of this.componentStatuses.entries())if(d.criticalPath){const h=this.findPathToSink(l);h&&!e.some(p=>JSON.stringify(p)===JSON.stringify(h))&&e.push(h)}for(const[l,d]of this.connectionMetrics.entries())if(d.bottleneck){const h=this.connections.find(p=>p.id===l);h&&(t.includes(h.source)||t.push(h.source),t.includes(h.target)||t.push(h.target))}for(const[l,d]of this.componentStatuses.entries())(d.failureRisk>.6||d.health==="critical"||d.health==="down")&&s.push(l);this.generateRecommendations(n);const i=Array.from(this.componentStatuses.values()).map(l=>{switch(l.health){case"down":return 0;case"critical":return .25;case"degraded":return .5;case"healthy":return 1}}),a=i.length>0?i.reduce((l,d)=>l+d,0)/i.length:1;let o="healthy";return a<.25?o="down":a<.5?o="critical":a<.75&&(o="degraded"),{criticalPaths:e,bottlenecks:t,riskComponents:s,recommendations:n,overallHealth:o}}findPathToSink(e){const t=this.nodes.filter(s=>!this.connections.some(n=>n.source===s.id));for(const s of t){const n=this.findPath(e,s.id);if(n)return n}return null}generateRecommendations(e){for(const[s,n]of this.componentStatuses.entries()){const i=this.nodes.find(o=>o.id===s),a=this.componentMetrics.get(s);!i||!a||(a.utilization>.85&&e.push({type:"scaling",priority:a.utilization>.95?"critical":"high",componentId:s,message:`${i.data.label} is highly utilized (${(a.utilization*100).toFixed(0)}%)`,impact:"May cause performance degradation and increased latency",suggestion:`Consider scaling ${i.data.label} horizontally or vertically`}),a.errorRate>.05&&e.push({type:"monitoring",priority:a.errorRate>.1?"critical":"high",componentId:s,message:`${i.data.label} has high error rate (${(a.errorRate*100).toFixed(1)}%)`,impact:"Affects system reliability and user experience",suggestion:`Investigate error logs and implement error handling for ${i.data.label}`}),a.latency>500&&e.push({type:"optimization",priority:a.latency>1e3?"high":"medium",componentId:s,message:`${i.data.label} has high latency (${a.latency.toFixed(0)}ms)`,impact:"Affects end-to-end response time",suggestion:`Optimize ${i.data.label} performance or add caching`}),n.criticalPath&&n.failureRisk>.5&&e.push({type:"redundancy",priority:"high",componentId:s,message:`${i.data.label} is on a critical path and at risk`,impact:"Failure would significantly impact system",suggestion:`Add redundancy or failover for ${i.data.label}`}))}for(const[s,n]of this.connectionMetrics.entries()){const i=this.connections.find(l=>l.id===s);if(!i)continue;const a=this.nodes.find(l=>l.id===i.source),o=this.nodes.find(l=>l.id===i.target);n.bottleneck&&e.push({type:"optimization",priority:"critical",connectionId:s,message:`Connection between ${a?.data.label||"source"} and ${o?.data.label||"target"} is a bottleneck`,impact:"Limiting overall system throughput",suggestion:"Increase bandwidth or optimize data transfer between these components"}),n.backpressure>.7&&e.push({type:"optimization",priority:"high",connectionId:s,message:`High backpressure (${(n.backpressure*100).toFixed(0)}%) on connection`,impact:"Target component cannot process data fast enough",suggestion:"Scale target component or implement buffering/queuing"})}const t={critical:0,high:1,medium:2,low:3};e.sort((s,n)=>t[s.priority]-t[n.priority])}getComponentStatus(e){return this.componentStatuses.get(e)}getAllComponentStatuses(){return Array.from(this.componentStatuses.values())}getDependencies(e){return this.dependencyGraph.get(e)||[]}}const af=new HA,Ma=hn((c,e)=>({componentStatuses:new Map,systemAnalysis:null,updateAnalysis:()=>{const{nodes:t,connections:s}=ke.getState(),{componentMetrics:n,connectionMetrics:i}=_t.getState();af.update(t,s,n,i);const a=af.analyzeSystem(),o=new Map(af.getAllComponentStatuses().map(l=>[l.nodeId,l]));c({componentStatuses:o,systemAnalysis:a})},getComponentStatus:t=>e().componentStatuses.get(t),getAllComponentStatuses:()=>Array.from(e().componentStatuses.values()),getSystemAnalysis:()=>e().systemAnalysis})),Jf=hn((c,e)=>({alerts:[],updateAlerts:()=>{try{const{nodes:t,connections:s}=ke.getState(),{componentMetrics:n,connectionMetrics:i}=_t.getState(),a=Ma.getState().getAllComponentStatuses();ga.analyze(t,n,i,a);const o=ga.getAlerts();c({alerts:o})}catch(t){console.error("Error in updateAlerts:",t)}},acknowledgeAlert:t=>{ga.acknowledge(t);const s=ga.getAlerts();c({alerts:s})},clearAlerts:()=>{ga.clear(),c({alerts:[]})},getCriticalAlerts:()=>e().alerts.filter(t=>t.type==="critical"),getWarningAlerts:()=>e().alerts.filter(t=>t.type==="warning")})),Pb=hn((c,e)=>(qe.onError(()=>{e().updateErrors()}),{errors:[],updateErrors:()=>{const t=qe.getErrors();c({errors:t})},clearErrors:()=>{qe.clear(),c({errors:[]})},clearErrorsByFilter:t=>{qe.clearByFilter(t),e().updateErrors()},removeError:t=>{qe.removeError(t),e().updateErrors()},getErrorsBySeverity:t=>qe.getErrorsBySeverity(t),getErrorsBySource:t=>qe.getErrorsBySource(t),getErrorsByComponent:t=>qe.getErrorsByComponent(t),getCriticalErrors:()=>qe.getCriticalErrors(),getErrorCount:t=>qe.getErrorCount(t),getStats:()=>qe.getStats()})),_t=hn((c,e)=>({isRunning:!1,simulationTime:0,updateInterval:100,componentMetrics:new Map,connectionMetrics:new Map,initialize:(t,s)=>{ve.initialize(t,s),c({componentMetrics:new Map(ve.getAllComponentMetrics().map(n=>[n.id,n])),connectionMetrics:new Map(ve.getAllConnectionMetrics().map(n=>[n.id,n]))}),zi.getState().initialize(t,s)},start:()=>{console.log("useEmulationStore.start() called");try{const t=ve.getIsRunning();console.log("Engine running state:",t),t&&(console.log("Stopping engine first..."),ve.stop()),console.log("Calling emulationEngine.start()..."),ve.start(),console.log("Engine started, setting store isRunning to true"),c({isRunning:!0}),console.log("Starting data flow..."),zi.getState().start(),console.log("Setting up polling interval...");const s=setInterval(()=>{e().updateMetrics()},e().updateInterval);ve._pollInterval=s,console.log("Start complete, polling interval set")}catch(t){throw console.error("Error in useEmulationStore.start():",t),t}},stop:()=>{ve.stop();const t=ve._pollInterval;t&&clearInterval(t),zi.getState().stop(),c({isRunning:!1})},reset:()=>{ve.resetSimulation();const t=ve._pollInterval;t&&clearInterval(t),zi.getState().stop(),c({isRunning:!1,simulationTime:0,componentMetrics:new Map,connectionMetrics:new Map})},setUpdateInterval:t=>{c({updateInterval:t})},updateMetrics:()=>{const{nodes:t,connections:s}=ke.getState();ve.updateNodesAndConnections(t,s),c(n=>({simulationTime:ve.getSimulationTime(),componentMetrics:new Map(ve.getAllComponentMetrics().map(i=>[i.id,i])),connectionMetrics:new Map(ve.getAllConnectionMetrics().map(i=>[i.id,i]))})),zi.getState().updateMessages(t,s),Ma.getState().updateAnalysis(),Jf.getState().updateAlerts(),Pb.getState().updateErrors()},getComponentMetrics:t=>e().componentMetrics.get(t),getConnectionMetrics:t=>e().connectionMetrics.get(t),updateKongRoutingEngine:t=>{ve.updateKongRoutingEngine(t)}}));const $A=c=>c.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),BA=c=>c.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,s)=>s?s.toUpperCase():t.toLowerCase()),fv=c=>{const e=BA(c);return e.charAt(0).toUpperCase()+e.slice(1)},Lb=(...c)=>c.filter((e,t,s)=>!!e&&e.trim()!==""&&s.indexOf(e)===t).join(" ").trim(),UA=c=>{for(const e in c)if(e.startsWith("aria-")||e==="role"||e==="title")return!0};var FA={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};const QA=R.forwardRef(({color:c="currentColor",size:e=24,strokeWidth:t=2,absoluteStrokeWidth:s,className:n="",children:i,iconNode:a,...o},l)=>R.createElement("svg",{ref:l,...FA,width:e,height:e,stroke:c,strokeWidth:s?Number(t)*24/Number(e):t,className:Lb("lucide",n),...!i&&!UA(o)&&{"aria-hidden":"true"},...o},[...a.map(([d,h])=>R.createElement(d,h)),...Array.isArray(i)?i:[i]]));const _e=(c,e)=>{const t=R.forwardRef(({className:s,...n},i)=>R.createElement(QA,{ref:i,iconNode:e,className:Lb(`lucide-${$A(fv(c))}`,`lucide-${c}`,s),...n}));return t.displayName=fv(c),t};const VA=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],wa=_e("activity",VA);const GA=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],WA=_e("arrow-down",GA);const KA=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],YA=_e("arrow-right",KA);const XA=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],JA=_e("arrow-up",XA);const ZA=[["path",{d:"M4.929 4.929 19.07 19.071",key:"196cmz"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],eD=_e("ban",ZA);const tD=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],Zf=_e("check",tD);const sD=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],tu=_e("chevron-down",sD);const nD=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],ep=_e("chevron-right",nD);const iD=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],_b=_e("chevron-up",iD);const aD=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],Sa=_e("circle-alert",aD);const oD=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],tp=_e("circle-check",oD);const rD=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]],cD=_e("circle-question-mark",rD);const lD=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],va=_e("circle-x",lD);const uD=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],dD=_e("circle",uD);const hD=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Ib=_e("copy",hD);const fD=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],pD=_e("download",fD);const gD=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],mD=_e("eye",gD);const yD=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],pv=_e("file-text",yD);const vD=[["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],bD=_e("folder-minus",vD);const MD=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],xf=_e("folder-plus",MD);const wD=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],Nb=_e("funnel",wD);const SD=[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]],xD=_e("grip-vertical",SD);const CD=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],zb=_e("info",CD);const RD=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],jb=_e("layers",RD);const TD=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],ED=_e("map",TD);const kD=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],AD=_e("maximize-2",kD);const DD=[["rect",{x:"16",y:"16",width:"6",height:"6",rx:"1",key:"4q2zg0"}],["rect",{x:"2",y:"16",width:"6",height:"6",rx:"1",key:"8cvhb9"}],["rect",{x:"9",y:"2",width:"6",height:"6",rx:"1",key:"1egb70"}],["path",{d:"M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3",key:"1jsf9p"}],["path",{d:"M12 12V8",key:"2874zd"}]],PD=_e("network",DD);const LD=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]],_D=_e("pause",LD);const ID=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],ND=_e("play",ID);const zD=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],Bl=_e("plus",zD);const jD=[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],Ll=_e("power-off",jD);const OD=[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]],of=_e("power",OD);const qD=[["path",{d:"m15 14 5-5-5-5",key:"12vg1m"}],["path",{d:"M20 9H9.5A5.5 5.5 0 0 0 4 14.5A5.5 5.5 0 0 0 9.5 20H13",key:"6uklza"}]],HD=_e("redo-2",qD);const $D=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],BD=_e("refresh-cw",$D);const UD=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Ob=_e("rotate-ccw",UD);const FD=[["path",{d:"M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z",key:"icamh8"}],["path",{d:"m14.5 12.5 2-2",key:"inckbg"}],["path",{d:"m11.5 9.5 2-2",key:"fmmyf7"}],["path",{d:"m8.5 6.5 2-2",key:"vc6u1g"}],["path",{d:"m17.5 15.5 2-2",key:"wo5hmg"}]],QD=_e("ruler",FD);const VD=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],GD=_e("save",VD);const WD=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],Gr=_e("search",WD);const KD=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],rf=_e("settings-2",KD);const YD=[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],XD=_e("settings",YD);const JD=[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z",key:"1s2grr"}],["path",{d:"M20 2v4",key:"1rf3ol"}],["path",{d:"M22 4h-4",key:"gwowj6"}],["circle",{cx:"4",cy:"20",r:"2",key:"6kqj1y"}]],ZD=_e("sparkles",JD);const eP=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],tP=_e("square-pen",eP);const sP=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],nP=_e("star",sP);const iP=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],su=_e("trash-2",iP);const aP=[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]],qb=_e("trending-down",aP);const oP=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],rn=_e("triangle-alert",oP);const rP=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],cP=_e("undo-2",rP);const lP=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],uP=_e("upload",lP);const dP=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],cn=_e("x",dP);const hP=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],Hb=_e("zap",hP);const fP=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],pP=_e("zoom-in",fP);const gP=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],mP=_e("zoom-out",gP);function yP(){const{isRunning:c,simulationTime:e,initialize:t,start:s,stop:n,reset:i}=_t(),{nodes:a,connections:o}=ke();R.useEffect(()=>{const g=ve.getIsRunning();console.log("EmulationPanel mounted/updated",{storeIsRunning:c,engineIsRunning:g,simulationTime:e,nodesCount:a.length,connectionsCount:o.length}),c!==g&&(console.warn("State mismatch detected!",{storeIsRunning:c,engineIsRunning:g}),c&&!g?(console.log("Fixing: stopping store"),n()):!c&&g&&(console.log("Fixing: stopping engine"),ve.stop()))},[c,e,a.length,o.length,n]);const l=()=>{console.log("handleStart called",{isRunning:c,simulationTime:e,nodesCount:a.length,connectionsCount:o.length});try{e===0&&(console.log("Initializing emulation..."),t(a,o),console.log("Initialization complete")),console.log("Starting emulation..."),s(),console.log("Start called, isRunning should be true now")}catch(g){console.error("Error starting emulation:",g)}},d=()=>{n()},h=()=>{i()},p=g=>{const v=Math.floor(g/1e3),b=Math.floor(v/60),M=v%60;return`${b}:${M.toString().padStart(2,"0")}`};return y.jsxs("div",{className:"flex items-center gap-2",children:[y.jsx("div",{className:"text-sm text-muted-foreground w-12",children:p(e)}),y.jsx(De,{size:"sm",variant:c?"default":"outline",onClick:g=>{console.log("Button clicked!",{isRunning:c,simulationTime:e,disabled:c}),g.preventDefault(),g.stopPropagation(),c?console.warn("Button clicked but isRunning is true, button should be disabled"):l()},disabled:c,title:"Start emulation",style:{pointerEvents:c?"none":"auto"},children:y.jsx(ND,{className:"w-4 h-4"})}),y.jsx(De,{size:"sm",variant:c?"default":"outline",onClick:d,disabled:!c,title:"Stop emulation",children:y.jsx(_D,{className:"w-4 h-4"})}),y.jsx(De,{size:"sm",variant:"outline",onClick:h,title:"Reset simulation",children:y.jsx(Ob,{className:"w-4 h-4"})})]})}const ct=R.forwardRef(({className:c,type:e,...t},s)=>y.jsx("input",{type:e,className:Ae("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",c),ref:s,...t}));ct.displayName="Input";function vP(c){const e=bP(c),t=R.forwardRef((s,n)=>{const{children:i,...a}=s,o=R.Children.toArray(i),l=o.find(wP);if(l){const d=l.props.children,h=o.map(p=>p===l?R.Children.count(d)>1?R.Children.only(null):R.isValidElement(d)?d.props.children:null:p);return y.jsx(e,{...a,ref:n,children:R.isValidElement(d)?R.cloneElement(d,void 0,h):null})}return y.jsx(e,{...a,ref:n,children:i})});return t.displayName=`${c}.Slot`,t}function bP(c){const e=R.forwardRef((t,s)=>{const{children:n,...i}=t;if(R.isValidElement(n)){const a=xP(n),o=SP(i,n.props);return n.type!==R.Fragment&&(o.ref=s?An(s,a):a),R.cloneElement(n,o)}return R.Children.count(n)>1?R.Children.only(null):null});return e.displayName=`${c}.SlotClone`,e}var MP=Symbol("radix.slottable");function wP(c){return R.isValidElement(c)&&typeof c.type=="function"&&"__radixId"in c.type&&c.type.__radixId===MP}function SP(c,e){const t={...e};for(const s in e){const n=c[s],i=e[s];/^on[A-Z]/.test(s)?n&&i?t[s]=(...o)=>{const l=i(...o);return n(...o),l}:n&&(t[s]=n):s==="style"?t[s]={...n,...i}:s==="className"&&(t[s]=[n,i].filter(Boolean).join(" "))}return{...c,...t}}function xP(c){let e=Object.getOwnPropertyDescriptor(c.props,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning;return t?c.ref:(e=Object.getOwnPropertyDescriptor(c,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning,t?c.props.ref:c.props.ref||c.ref)}var CP=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],Le=CP.reduce((c,e)=>{const t=vP(`Primitive.${e}`),s=R.forwardRef((n,i)=>{const{asChild:a,...o}=n,l=a?t:e;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),y.jsx(l,{...o,ref:i})});return s.displayName=`Primitive.${e}`,{...c,[e]:s}},{});function $b(c,e){c&&Vr.flushSync(()=>c.dispatchEvent(e))}var as=globalThis?.document?R.useLayoutEffect:()=>{};function RP(c,e){return R.useReducer((t,s)=>e[t][s]??t,c)}var cs=c=>{const{present:e,children:t}=c,s=TP(e),n=typeof t=="function"?t({present:s.isPresent}):R.Children.only(t),i=Ne(s.ref,EP(n));return typeof t=="function"||s.isPresent?R.cloneElement(n,{ref:i}):null};cs.displayName="Presence";function TP(c){const[e,t]=R.useState(),s=R.useRef(null),n=R.useRef(c),i=R.useRef("none"),a=c?"mounted":"unmounted",[o,l]=RP(a,{mounted:{UNMOUNT:"unmounted",ANIMATION_OUT:"unmountSuspended"},unmountSuspended:{MOUNT:"mounted",ANIMATION_END:"unmounted"},unmounted:{MOUNT:"mounted"}});return R.useEffect(()=>{const d=wl(s.current);i.current=o==="mounted"?d:"none"},[o]),as(()=>{const d=s.current,h=n.current;if(h!==c){const g=i.current,v=wl(d);c?l("MOUNT"):v==="none"||d?.display==="none"?l("UNMOUNT"):l(h&&g!==v?"ANIMATION_OUT":"UNMOUNT"),n.current=c}},[c,l]),as(()=>{if(e){let d;const h=e.ownerDocument.defaultView??window,p=v=>{const M=wl(s.current).includes(CSS.escape(v.animationName));if(v.target===e&&M&&(l("ANIMATION_END"),!n.current)){const x=e.style.animationFillMode;e.style.animationFillMode="forwards",d=h.setTimeout(()=>{e.style.animationFillMode==="forwards"&&(e.style.animationFillMode=x)})}},g=v=>{v.target===e&&(i.current=wl(s.current))};return e.addEventListener("animationstart",g),e.addEventListener("animationcancel",p),e.addEventListener("animationend",p),()=>{h.clearTimeout(d),e.removeEventListener("animationstart",g),e.removeEventListener("animationcancel",p),e.removeEventListener("animationend",p)}}else l("ANIMATION_END")},[e,l]),{isPresent:["mounted","unmountSuspended"].includes(o),ref:R.useCallback(d=>{s.current=d?getComputedStyle(d):null,t(d)},[])}}function wl(c){return c?.animationName||"none"}function EP(c){let e=Object.getOwnPropertyDescriptor(c.props,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning;return t?c.ref:(e=Object.getOwnPropertyDescriptor(c,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning,t?c.props.ref:c.props.ref||c.ref)}function kP(c,e){const t=R.createContext(e),s=i=>{const{children:a,...o}=i,l=R.useMemo(()=>o,Object.values(o));return y.jsx(t.Provider,{value:l,children:a})};s.displayName=c+"Provider";function n(i){const a=R.useContext(t);if(a)return a;if(e!==void 0)return e;throw new Error(`\`${i}\` must be used within \`${c}\``)}return[s,n]}function ws(c,e=[]){let t=[];function s(i,a){const o=R.createContext(a),l=t.length;t=[...t,a];const d=p=>{const{scope:g,children:v,...b}=p,M=g?.[c]?.[l]||o,x=R.useMemo(()=>b,Object.values(b));return y.jsx(M.Provider,{value:x,children:v})};d.displayName=i+"Provider";function h(p,g){const v=g?.[c]?.[l]||o,b=R.useContext(v);if(b)return b;if(a!==void 0)return a;throw new Error(`\`${p}\` must be used within \`${i}\``)}return[d,h]}const n=()=>{const i=t.map(a=>R.createContext(a));return function(o){const l=o?.[c]||i;return R.useMemo(()=>({[`__scope${c}`]:{...o,[c]:l}}),[o,l])}};return n.scopeName=c,[s,AP(n,...e)]}function AP(...c){const e=c[0];if(c.length===1)return e;const t=()=>{const s=c.map(n=>({useScope:n(),scopeName:n.scopeName}));return function(i){const a=s.reduce((o,{useScope:l,scopeName:d})=>{const p=l(i)[`__scope${d}`];return{...o,...p}},{});return R.useMemo(()=>({[`__scope${e.scopeName}`]:a}),[a])}};return t.scopeName=e.scopeName,t}function is(c){const e=R.useRef(c);return R.useEffect(()=>{e.current=c}),R.useMemo(()=>(...t)=>e.current?.(...t),[])}var DP=R.createContext(void 0);function Lo(c){const e=R.useContext(DP);return c||e||"ltr"}function qr(c,[e,t]){return Math.min(t,Math.max(e,c))}function be(c,e,{checkForDefaultPrevented:t=!0}={}){return function(n){if(c?.(n),t===!1||!n.defaultPrevented)return e?.(n)}}function PP(c,e){return R.useReducer((t,s)=>e[t][s]??t,c)}var sp="ScrollArea",[Bb]=ws(sp),[LP,Ys]=Bb(sp),Ub=R.forwardRef((c,e)=>{const{__scopeScrollArea:t,type:s="hover",dir:n,scrollHideDelay:i=600,...a}=c,[o,l]=R.useState(null),[d,h]=R.useState(null),[p,g]=R.useState(null),[v,b]=R.useState(null),[M,x]=R.useState(null),[S,T]=R.useState(0),[E,A]=R.useState(0),[k,D]=R.useState(!1),[L,I]=R.useState(!1),U=Ne(e,se=>l(se)),Q=Lo(n);return y.jsx(LP,{scope:t,type:s,dir:Q,scrollHideDelay:i,scrollArea:o,viewport:d,onViewportChange:h,content:p,onContentChange:g,scrollbarX:v,onScrollbarXChange:b,scrollbarXEnabled:k,onScrollbarXEnabledChange:D,scrollbarY:M,onScrollbarYChange:x,scrollbarYEnabled:L,onScrollbarYEnabledChange:I,onCornerWidthChange:T,onCornerHeightChange:A,children:y.jsx(Le.div,{dir:Q,...a,ref:U,style:{position:"relative","--radix-scroll-area-corner-width":S+"px","--radix-scroll-area-corner-height":E+"px",...c.style}})})});Ub.displayName=sp;var Fb="ScrollAreaViewport",Qb=R.forwardRef((c,e)=>{const{__scopeScrollArea:t,children:s,nonce:n,...i}=c,a=Ys(Fb,t),o=R.useRef(null),l=Ne(e,o,a.onViewportChange);return y.jsxs(y.Fragment,{children:[y.jsx("style",{dangerouslySetInnerHTML:{__html:"[data-radix-scroll-area-viewport]{scrollbar-width:none;-ms-overflow-style:none;-webkit-overflow-scrolling:touch;}[data-radix-scroll-area-viewport]::-webkit-scrollbar{display:none}"},nonce:n}),y.jsx(Le.div,{"data-radix-scroll-area-viewport":"",...i,ref:l,style:{overflowX:a.scrollbarXEnabled?"scroll":"hidden",overflowY:a.scrollbarYEnabled?"scroll":"hidden",...c.style},children:y.jsx("div",{ref:a.onContentChange,style:{minWidth:"100%",display:"table"},children:s})})]})});Qb.displayName=Fb;var Dn="ScrollAreaScrollbar",np=R.forwardRef((c,e)=>{const{forceMount:t,...s}=c,n=Ys(Dn,c.__scopeScrollArea),{onScrollbarXEnabledChange:i,onScrollbarYEnabledChange:a}=n,o=c.orientation==="horizontal";return R.useEffect(()=>(o?i(!0):a(!0),()=>{o?i(!1):a(!1)}),[o,i,a]),n.type==="hover"?y.jsx(_P,{...s,ref:e,forceMount:t}):n.type==="scroll"?y.jsx(IP,{...s,ref:e,forceMount:t}):n.type==="auto"?y.jsx(Vb,{...s,ref:e,forceMount:t}):n.type==="always"?y.jsx(ip,{...s,ref:e}):null});np.displayName=Dn;var _P=R.forwardRef((c,e)=>{const{forceMount:t,...s}=c,n=Ys(Dn,c.__scopeScrollArea),[i,a]=R.useState(!1);return R.useEffect(()=>{const o=n.scrollArea;let l=0;if(o){const d=()=>{window.clearTimeout(l),a(!0)},h=()=>{l=window.setTimeout(()=>a(!1),n.scrollHideDelay)};return o.addEventListener("pointerenter",d),o.addEventListener("pointerleave",h),()=>{window.clearTimeout(l),o.removeEventListener("pointerenter",d),o.removeEventListener("pointerleave",h)}}},[n.scrollArea,n.scrollHideDelay]),y.jsx(cs,{present:t||i,children:y.jsx(Vb,{"data-state":i?"visible":"hidden",...s,ref:e})})}),IP=R.forwardRef((c,e)=>{const{forceMount:t,...s}=c,n=Ys(Dn,c.__scopeScrollArea),i=c.orientation==="horizontal",a=iu(()=>l("SCROLL_END"),100),[o,l]=PP("hidden",{hidden:{SCROLL:"scrolling"},scrolling:{SCROLL_END:"idle",POINTER_ENTER:"interacting"},interacting:{SCROLL:"interacting",POINTER_LEAVE:"idle"},idle:{HIDE:"hidden",SCROLL:"scrolling",POINTER_ENTER:"interacting"}});return R.useEffect(()=>{if(o==="idle"){const d=window.setTimeout(()=>l("HIDE"),n.scrollHideDelay);return()=>window.clearTimeout(d)}},[o,n.scrollHideDelay,l]),R.useEffect(()=>{const d=n.viewport,h=i?"scrollLeft":"scrollTop";if(d){let p=d[h];const g=()=>{const v=d[h];p!==v&&(l("SCROLL"),a()),p=v};return d.addEventListener("scroll",g),()=>d.removeEventListener("scroll",g)}},[n.viewport,i,l,a]),y.jsx(cs,{present:t||o!=="hidden",children:y.jsx(ip,{"data-state":o==="hidden"?"hidden":"visible",...s,ref:e,onPointerEnter:be(c.onPointerEnter,()=>l("POINTER_ENTER")),onPointerLeave:be(c.onPointerLeave,()=>l("POINTER_LEAVE"))})})}),Vb=R.forwardRef((c,e)=>{const t=Ys(Dn,c.__scopeScrollArea),{forceMount:s,...n}=c,[i,a]=R.useState(!1),o=c.orientation==="horizontal",l=iu(()=>{if(t.viewport){const d=t.viewport.offsetWidth<t.viewport.scrollWidth,h=t.viewport.offsetHeight<t.viewport.scrollHeight;a(o?d:h)}},10);return To(t.viewport,l),To(t.content,l),y.jsx(cs,{present:s||i,children:y.jsx(ip,{"data-state":i?"visible":"hidden",...n,ref:e})})}),ip=R.forwardRef((c,e)=>{const{orientation:t="vertical",...s}=c,n=Ys(Dn,c.__scopeScrollArea),i=R.useRef(null),a=R.useRef(0),[o,l]=R.useState({content:0,viewport:0,scrollbar:{size:0,paddingStart:0,paddingEnd:0}}),d=Xb(o.viewport,o.content),h={...s,sizes:o,onSizesChange:l,hasThumb:d>0&&d<1,onThumbChange:g=>i.current=g,onThumbPointerUp:()=>a.current=0,onThumbPointerDown:g=>a.current=g};function p(g,v){return HP(g,a.current,o,v)}return t==="horizontal"?y.jsx(NP,{...h,ref:e,onThumbPositionChange:()=>{if(n.viewport&&i.current){const g=n.viewport.scrollLeft,v=gv(g,o,n.dir);i.current.style.transform=`translate3d(${v}px, 0, 0)`}},onWheelScroll:g=>{n.viewport&&(n.viewport.scrollLeft=g)},onDragScroll:g=>{n.viewport&&(n.viewport.scrollLeft=p(g,n.dir))}}):t==="vertical"?y.jsx(zP,{...h,ref:e,onThumbPositionChange:()=>{if(n.viewport&&i.current){const g=n.viewport.scrollTop,v=gv(g,o);i.current.style.transform=`translate3d(0, ${v}px, 0)`}},onWheelScroll:g=>{n.viewport&&(n.viewport.scrollTop=g)},onDragScroll:g=>{n.viewport&&(n.viewport.scrollTop=p(g))}}):null}),NP=R.forwardRef((c,e)=>{const{sizes:t,onSizesChange:s,...n}=c,i=Ys(Dn,c.__scopeScrollArea),[a,o]=R.useState(),l=R.useRef(null),d=Ne(e,l,i.onScrollbarXChange);return R.useEffect(()=>{l.current&&o(getComputedStyle(l.current))},[l]),y.jsx(Wb,{"data-orientation":"horizontal",...n,ref:d,sizes:t,style:{bottom:0,left:i.dir==="rtl"?"var(--radix-scroll-area-corner-width)":0,right:i.dir==="ltr"?"var(--radix-scroll-area-corner-width)":0,"--radix-scroll-area-thumb-width":nu(t)+"px",...c.style},onThumbPointerDown:h=>c.onThumbPointerDown(h.x),onDragScroll:h=>c.onDragScroll(h.x),onWheelScroll:(h,p)=>{if(i.viewport){const g=i.viewport.scrollLeft+h.deltaX;c.onWheelScroll(g),Zb(g,p)&&h.preventDefault()}},onResize:()=>{l.current&&i.viewport&&a&&s({content:i.viewport.scrollWidth,viewport:i.viewport.offsetWidth,scrollbar:{size:l.current.clientWidth,paddingStart:Fl(a.paddingLeft),paddingEnd:Fl(a.paddingRight)}})}})}),zP=R.forwardRef((c,e)=>{const{sizes:t,onSizesChange:s,...n}=c,i=Ys(Dn,c.__scopeScrollArea),[a,o]=R.useState(),l=R.useRef(null),d=Ne(e,l,i.onScrollbarYChange);return R.useEffect(()=>{l.current&&o(getComputedStyle(l.current))},[l]),y.jsx(Wb,{"data-orientation":"vertical",...n,ref:d,sizes:t,style:{top:0,right:i.dir==="ltr"?0:void 0,left:i.dir==="rtl"?0:void 0,bottom:"var(--radix-scroll-area-corner-height)","--radix-scroll-area-thumb-height":nu(t)+"px",...c.style},onThumbPointerDown:h=>c.onThumbPointerDown(h.y),onDragScroll:h=>c.onDragScroll(h.y),onWheelScroll:(h,p)=>{if(i.viewport){const g=i.viewport.scrollTop+h.deltaY;c.onWheelScroll(g),Zb(g,p)&&h.preventDefault()}},onResize:()=>{l.current&&i.viewport&&a&&s({content:i.viewport.scrollHeight,viewport:i.viewport.offsetHeight,scrollbar:{size:l.current.clientHeight,paddingStart:Fl(a.paddingTop),paddingEnd:Fl(a.paddingBottom)}})}})}),[jP,Gb]=Bb(Dn),Wb=R.forwardRef((c,e)=>{const{__scopeScrollArea:t,sizes:s,hasThumb:n,onThumbChange:i,onThumbPointerUp:a,onThumbPointerDown:o,onThumbPositionChange:l,onDragScroll:d,onWheelScroll:h,onResize:p,...g}=c,v=Ys(Dn,t),[b,M]=R.useState(null),x=Ne(e,U=>M(U)),S=R.useRef(null),T=R.useRef(""),E=v.viewport,A=s.content-s.viewport,k=is(h),D=is(l),L=iu(p,10);function I(U){if(S.current){const Q=U.clientX-S.current.left,se=U.clientY-S.current.top;d({x:Q,y:se})}}return R.useEffect(()=>{const U=Q=>{const se=Q.target;b?.contains(se)&&k(Q,A)};return document.addEventListener("wheel",U,{passive:!1}),()=>document.removeEventListener("wheel",U,{passive:!1})},[E,b,A,k]),R.useEffect(D,[s,D]),To(b,L),To(v.content,L),y.jsx(jP,{scope:t,scrollbar:b,hasThumb:n,onThumbChange:is(i),onThumbPointerUp:is(a),onThumbPositionChange:D,onThumbPointerDown:is(o),children:y.jsx(Le.div,{...g,ref:x,style:{position:"absolute",...g.style},onPointerDown:be(c.onPointerDown,U=>{U.button===0&&(U.target.setPointerCapture(U.pointerId),S.current=b.getBoundingClientRect(),T.current=document.body.style.webkitUserSelect,document.body.style.webkitUserSelect="none",v.viewport&&(v.viewport.style.scrollBehavior="auto"),I(U))}),onPointerMove:be(c.onPointerMove,I),onPointerUp:be(c.onPointerUp,U=>{const Q=U.target;Q.hasPointerCapture(U.pointerId)&&Q.releasePointerCapture(U.pointerId),document.body.style.webkitUserSelect=T.current,v.viewport&&(v.viewport.style.scrollBehavior=""),S.current=null})})})}),Ul="ScrollAreaThumb",Kb=R.forwardRef((c,e)=>{const{forceMount:t,...s}=c,n=Gb(Ul,c.__scopeScrollArea);return y.jsx(cs,{present:t||n.hasThumb,children:y.jsx(OP,{ref:e,...s})})}),OP=R.forwardRef((c,e)=>{const{__scopeScrollArea:t,style:s,...n}=c,i=Ys(Ul,t),a=Gb(Ul,t),{onThumbPositionChange:o}=a,l=Ne(e,p=>a.onThumbChange(p)),d=R.useRef(void 0),h=iu(()=>{d.current&&(d.current(),d.current=void 0)},100);return R.useEffect(()=>{const p=i.viewport;if(p){const g=()=>{if(h(),!d.current){const v=$P(p,o);d.current=v,o()}};return o(),p.addEventListener("scroll",g),()=>p.removeEventListener("scroll",g)}},[i.viewport,h,o]),y.jsx(Le.div,{"data-state":a.hasThumb?"visible":"hidden",...n,ref:l,style:{width:"var(--radix-scroll-area-thumb-width)",height:"var(--radix-scroll-area-thumb-height)",...s},onPointerDownCapture:be(c.onPointerDownCapture,p=>{const v=p.target.getBoundingClientRect(),b=p.clientX-v.left,M=p.clientY-v.top;a.onThumbPointerDown({x:b,y:M})}),onPointerUp:be(c.onPointerUp,a.onThumbPointerUp)})});Kb.displayName=Ul;var ap="ScrollAreaCorner",Yb=R.forwardRef((c,e)=>{const t=Ys(ap,c.__scopeScrollArea),s=!!(t.scrollbarX&&t.scrollbarY);return t.type!=="scroll"&&s?y.jsx(qP,{...c,ref:e}):null});Yb.displayName=ap;var qP=R.forwardRef((c,e)=>{const{__scopeScrollArea:t,...s}=c,n=Ys(ap,t),[i,a]=R.useState(0),[o,l]=R.useState(0),d=!!(i&&o);return To(n.scrollbarX,()=>{const h=n.scrollbarX?.offsetHeight||0;n.onCornerHeightChange(h),l(h)}),To(n.scrollbarY,()=>{const h=n.scrollbarY?.offsetWidth||0;n.onCornerWidthChange(h),a(h)}),d?y.jsx(Le.div,{...s,ref:e,style:{width:i,height:o,position:"absolute",right:n.dir==="ltr"?0:void 0,left:n.dir==="rtl"?0:void 0,bottom:0,...c.style}}):null});function Fl(c){return c?parseInt(c,10):0}function Xb(c,e){const t=c/e;return isNaN(t)?0:t}function nu(c){const e=Xb(c.viewport,c.content),t=c.scrollbar.paddingStart+c.scrollbar.paddingEnd,s=(c.scrollbar.size-t)*e;return Math.max(s,18)}function HP(c,e,t,s="ltr"){const n=nu(t),i=n/2,a=e||i,o=n-a,l=t.scrollbar.paddingStart+a,d=t.scrollbar.size-t.scrollbar.paddingEnd-o,h=t.content-t.viewport,p=s==="ltr"?[0,h]:[h*-1,0];return Jb([l,d],p)(c)}function gv(c,e,t="ltr"){const s=nu(e),n=e.scrollbar.paddingStart+e.scrollbar.paddingEnd,i=e.scrollbar.size-n,a=e.content-e.viewport,o=i-s,l=t==="ltr"?[0,a]:[a*-1,0],d=qr(c,l);return Jb([0,a],[0,o])(d)}function Jb(c,e){return t=>{if(c[0]===c[1]||e[0]===e[1])return e[0];const s=(e[1]-e[0])/(c[1]-c[0]);return e[0]+s*(t-c[0])}}function Zb(c,e){return c>0&&c<e}var $P=(c,e=()=>{})=>{let t={left:c.scrollLeft,top:c.scrollTop},s=0;return(function n(){const i={left:c.scrollLeft,top:c.scrollTop},a=t.left!==i.left,o=t.top!==i.top;(a||o)&&e(),t=i,s=window.requestAnimationFrame(n)})(),()=>window.cancelAnimationFrame(s)};function iu(c,e){const t=is(c),s=R.useRef(0);return R.useEffect(()=>()=>window.clearTimeout(s.current),[]),R.useCallback(()=>{window.clearTimeout(s.current),s.current=window.setTimeout(t,e)},[t,e])}function To(c,e){const t=is(e);as(()=>{let s=0;if(c){const n=new ResizeObserver(()=>{cancelAnimationFrame(s),s=window.requestAnimationFrame(t)});return n.observe(c),()=>{window.cancelAnimationFrame(s),n.unobserve(c)}}},[c,t])}var eM=Ub,BP=Qb,UP=Yb;const ns=R.forwardRef(({className:c,children:e,...t},s)=>y.jsxs(eM,{ref:s,className:Ae("relative overflow-hidden",c),scrollHideDelay:0,...t,children:[y.jsx(BP,{className:"h-full w-full rounded-[inherit]",children:e}),y.jsx(au,{}),y.jsx(UP,{})]}));ns.displayName=eM.displayName;const au=R.forwardRef(({className:c,orientation:e="vertical",...t},s)=>y.jsx(np,{ref:s,orientation:e,className:Ae("flex touch-none select-none",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]","data-[state=visible]:bg-accent/20 data-[state=visible]:hover:bg-accent/30","[&[data-state=hidden]]:opacity-0 [&[data-state=visible]]:opacity-100",c),style:{transition:"none !important",transitionDelay:"0ms !important",transitionDuration:"0ms !important"},...t,children:y.jsx(Kb,{className:"relative flex-1 rounded-full bg-accent/80 hover:bg-accent",style:{transition:"none !important"}})}));au.displayName=np.displayName;const Wr=hn(c=>({showMinimap:!0,setShowMinimap:e=>c({showMinimap:e}),toggleMinimap:()=>c(e=>({showMinimap:!e.showMinimap})),showHeatMapLegend:!0,setShowHeatMapLegend:e=>c({showHeatMapLegend:e}),toggleHeatMapLegend:()=>c(e=>({showHeatMapLegend:!e.showHeatMapLegend})),showRuler:!1,setShowRuler:e=>c({showRuler:e}),toggleRuler:()=>c(e=>({showRuler:!e.showRuler})),autoCenterOnSelect:!0,setAutoCenterOnSelect:e=>c({autoCenterOnSelect:e}),searchQuery:"",setSearchQuery:e=>c({searchQuery:e}),highlightedNodeId:null,setHighlightedNodeId:e=>c({highlightedNodeId:e})})),Hr=[{id:"kafka",type:"kafka",label:"Apache Kafka",icon:"",color:"#000000",category:"messaging"},{id:"rabbitmq",type:"rabbitmq",label:"RabbitMQ",icon:"",color:"#FF6600",category:"messaging"},{id:"activemq",type:"activemq",label:"ActiveMQ",icon:"",color:"#A1005A",category:"messaging"},{id:"aws-sqs",type:"aws-sqs",label:"AWS SQS",icon:"",color:"#FF9900",category:"messaging"},{id:"azure-service-bus",type:"azure-service-bus",label:"Azure Service Bus",icon:"",color:"#0078D7",category:"messaging"},{id:"gcp-pubsub",type:"gcp-pubsub",label:"Google Pub/Sub",icon:"",color:"#4285F4",category:"messaging"},{id:"kong",type:"kong",label:"Kong Gateway",icon:"",color:"#003459",category:"integration"},{id:"apigee",type:"apigee",label:"Apigee",icon:"",color:"#F26522",category:"integration"},{id:"mulesoft",type:"mulesoft",label:"MuleSoft",icon:"",color:"#00A0DF",category:"integration"},{id:"graphql-gateway",type:"graphql-gateway",label:"GraphQL Gateway",icon:"",color:"#E10098",category:"integration"},{id:"bff-service",type:"bff-service",label:"BFF Service",icon:"",color:"#6C5CE7",category:"integration"},{id:"webhook-relay",type:"webhook-relay",label:"Webhook Relay",icon:"",color:"#1ABC9C",category:"integration"},{id:"postgres",type:"postgres",label:"PostgreSQL",icon:"",color:"#336791",category:"data"},{id:"mongodb",type:"mongodb",label:"MongoDB",icon:"",color:"#47A248",category:"data"},{id:"redis",type:"redis",label:"Redis",icon:"",color:"#DC382D",category:"data"},{id:"cassandra",type:"cassandra",label:"Apache Cassandra",icon:"",color:"#1287B1",category:"data"},{id:"clickhouse",type:"clickhouse",label:"ClickHouse",icon:"",color:"#FFCC00",category:"data"},{id:"snowflake",type:"snowflake",label:"Snowflake",icon:"",color:"#29B5E8",category:"data"},{id:"elasticsearch",type:"elasticsearch",label:"Elasticsearch",icon:"",color:"#00A79D",category:"data"},{id:"s3-datalake",type:"s3-datalake",label:"S3 Data Lake",icon:"",color:"#FF9900",category:"data"},{id:"prometheus",type:"prometheus",label:"Prometheus",icon:"",color:"#E6522C",category:"observability"},{id:"grafana",type:"grafana",label:"Grafana",icon:"",color:"#F56815",category:"observability"},{id:"loki",type:"loki",label:"Loki",icon:"",color:"#7CBA3C",category:"observability"},{id:"jaeger",type:"jaeger",label:"Jaeger",icon:"",color:"#65D6AD",category:"observability"},{id:"otel-collector",type:"otel-collector",label:"OpenTelemetry Collector",icon:"",color:"#6E56CF",category:"observability"},{id:"pagerduty",type:"pagerduty",label:"PagerDuty",icon:"",color:"#06AC38",category:"observability"},{id:"keycloak",type:"keycloak",label:"Keycloak",icon:"",color:"#5C6BC0",category:"security"},{id:"waf",type:"waf",label:"WAF / API Shield",icon:"",color:"#F44336",category:"security"},{id:"firewall",type:"firewall",label:"Firewall",icon:"",color:"#FF7043",category:"security"},{id:"secrets-vault",type:"secrets-vault",label:"Secrets Vault",icon:"",color:"#009688",category:"security"},{id:"ids-ips",type:"ids-ips",label:"IDS / IPS",icon:"",color:"#512DA8",category:"security"},{id:"jenkins",type:"jenkins",label:"Jenkins",icon:"",color:"#D24939",category:"devops"},{id:"gitlab-ci",type:"gitlab-ci",label:"GitLab CI",icon:"",color:"#FC6D26",category:"devops"},{id:"argo-cd",type:"argo-cd",label:"Argo CD",icon:"",color:"#EF7B45",category:"devops"},{id:"terraform",type:"terraform",label:"Terraform",icon:"",color:"#7B42BC",category:"devops"},{id:"ansible",type:"ansible",label:"Ansible",icon:"",color:"#000000",category:"devops"},{id:"harbor",type:"harbor",label:"Harbor Registry",icon:"",color:"#3BC1C4",category:"devops"},{id:"nginx",type:"nginx",label:"NGINX",icon:"",color:"#009639",category:"infrastructure"},{id:"docker",type:"docker",label:"Docker",icon:"",color:"#2496ED",category:"infrastructure"},{id:"kubernetes",type:"kubernetes",label:"Kubernetes",icon:"",color:"#326CE5",category:"infrastructure"},{id:"haproxy",type:"haproxy",label:"HAProxy",icon:"",color:"#009FDF",category:"infrastructure"},{id:"envoy",type:"envoy",label:"Envoy Proxy",icon:"",color:"#D63384",category:"infrastructure"},{id:"traefik",type:"traefik",label:"Traefik",icon:"",color:"#24A1DE",category:"infrastructure"},{id:"istio",type:"istio",label:"Istio Mesh",icon:"",color:"#466BB0",category:"edge"},{id:"service-mesh",type:"service-mesh",label:"Service Mesh",icon:"",color:"#5E81AC",category:"edge"},{id:"api-gateway",type:"api-gateway",label:"Cloud API Gateway",icon:"",color:"#FFB300",category:"edge"},{id:"vpn",type:"vpn",label:"VPN Concentrator",icon:"",color:"#2D9CDB",category:"edge"},{id:"cdn",type:"cdn",label:"CDN Edge",icon:"",color:"#FF5A5F",category:"edge"},{id:"spark",type:"spark",label:"Apache Spark",icon:"",color:"#E25A1C",category:"ml"},{id:"tensorflow-serving",type:"tensorflow-serving",label:"TensorFlow Serving",icon:"",color:"#FF6F00",category:"ml"},{id:"pytorch-serve",type:"pytorch-serve",label:"PyTorch Serve",icon:"",color:"#EE4C2C",category:"ml"},{id:"feature-store",type:"feature-store",label:"Feature Store",icon:"",color:"#8E44AD",category:"ml"},{id:"crm",type:"crm",label:"CRM System",icon:"",color:"#F39C12",category:"business"},{id:"erp",type:"erp",label:"ERP / SAP",icon:"",color:"#1B75BC",category:"business"},{id:"payment-gateway",type:"payment-gateway",label:"Payment Gateway",icon:"",color:"#4CAF50",category:"business"}],Dr=[{id:"messaging",label:"Messaging & Event Bus",icon:""},{id:"integration",label:"Integration & API",icon:""},{id:"data",label:"Data & Storage",icon:""},{id:"observability",label:"Observability",icon:""},{id:"security",label:"Security & IAM",icon:""},{id:"devops",label:"DevOps & Platform",icon:""},{id:"infrastructure",label:"Runtime & Infra",icon:""},{id:"edge",label:"Edge & Networking",icon:""},{id:"ml",label:"ML & Analytics",icon:""},{id:"business",label:"Business Systems",icon:""}];function FP(){const{nodes:c,selectNode:e,zoom:t,pan:s,setPan:n,setZoom:i}=ke(),{searchQuery:a,setSearchQuery:o,highlightedNodeId:l,setHighlightedNodeId:d}=Wr(),[h,p]=R.useState(!1),g=R.useRef(null);R.useEffect(()=>{const M=x=>{g.current&&!g.current.contains(x.target)&&p(!1)};return document.addEventListener("mousedown",M),()=>{document.removeEventListener("mousedown",M)}},[]);const v=R.useMemo(()=>{if(!a.trim())return[];const M=a.toLowerCase();return c.filter(x=>{const S=Hr.find(k=>k.type===x.type),T=x.data?.label||"",E=x.type||"",A=S?.category||"";return T.toLowerCase().includes(M)||E.toLowerCase().includes(M)||A.toLowerCase().includes(M)})},[c,a]),b=M=>{e(M),d(M);const x=c.find(S=>S.id===M);if(x&&h){const S=window.innerWidth/2,T=window.innerHeight/2,E=x.position.x+70,A=x.position.y+70,k=S-E*t,D=T-A*t;n({x:k,y:D}),t<.8&&i(1)}setTimeout(()=>d(null),2e3)};return y.jsxs("div",{className:"relative",ref:g,children:[y.jsxs("div",{className:"relative",children:[y.jsx(Gr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),y.jsx(ct,{type:"text",placeholder:"Search components...",value:a,onChange:M=>{o(M.target.value),p(!0)},onFocus:()=>p(!0),className:"pl-8 pr-8 w-64"}),a&&y.jsx(De,{variant:"ghost",size:"icon",className:"absolute right-0 top-1/2 transform -translate-y-1/2 h-6 w-6",onClick:()=>{o(""),p(!1),d(null)},children:y.jsx(cn,{className:"h-3 w-3"})})]}),h&&a&&y.jsx("div",{className:"absolute top-full left-0 mt-1 w-64 bg-card border border-border rounded-md shadow-lg z-50 max-h-80 overflow-hidden",children:v.length>0?y.jsx(ns,{className:"max-h-80",children:y.jsx("div",{className:"p-1",children:v.map(M=>{const x=Hr.find(T=>T.type===M.type),S=l===M.id;return y.jsxs("button",{onClick:()=>b(M.id),className:Ae("w-full text-left px-3 py-2 rounded-sm hover:bg-accent transition-colors flex items-center justify-between",S&&"bg-accent"),children:[y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsx("div",{className:"text-sm font-medium truncate",children:M.data?.label||M.type}),y.jsxs("div",{className:"text-xs text-muted-foreground truncate",children:[x?.category||"Unknown","  ",M.type]})]}),y.jsx(ep,{className:"h-4 w-4 text-muted-foreground flex-shrink-0 ml-2"})]},M.id)})})}):y.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No components found"})})]})}function QP(c){if(typeof document>"u")return;let e=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style");t.type="text/css",e.appendChild(t),t.styleSheet?t.styleSheet.cssText=c:t.appendChild(document.createTextNode(c))}Array(12).fill(0);let Cf=1;class VP{constructor(){this.subscribe=e=>(this.subscribers.push(e),()=>{const t=this.subscribers.indexOf(e);this.subscribers.splice(t,1)}),this.publish=e=>{this.subscribers.forEach(t=>t(e))},this.addToast=e=>{this.publish(e),this.toasts=[...this.toasts,e]},this.create=e=>{var t;const{message:s,...n}=e,i=typeof e?.id=="number"||((t=e.id)==null?void 0:t.length)>0?e.id:Cf++,a=this.toasts.find(l=>l.id===i),o=e.dismissible===void 0?!0:e.dismissible;return this.dismissedToasts.has(i)&&this.dismissedToasts.delete(i),a?this.toasts=this.toasts.map(l=>l.id===i?(this.publish({...l,...e,id:i,title:s}),{...l,...e,id:i,dismissible:o,title:s}):l):this.addToast({title:s,...n,dismissible:o,id:i}),i},this.dismiss=e=>(e?(this.dismissedToasts.add(e),requestAnimationFrame(()=>this.subscribers.forEach(t=>t({id:e,dismiss:!0})))):this.toasts.forEach(t=>{this.subscribers.forEach(s=>s({id:t.id,dismiss:!0}))}),e),this.message=(e,t)=>this.create({...t,message:e}),this.error=(e,t)=>this.create({...t,message:e,type:"error"}),this.success=(e,t)=>this.create({...t,type:"success",message:e}),this.info=(e,t)=>this.create({...t,type:"info",message:e}),this.warning=(e,t)=>this.create({...t,type:"warning",message:e}),this.loading=(e,t)=>this.create({...t,type:"loading",message:e}),this.promise=(e,t)=>{if(!t)return;let s;t.loading!==void 0&&(s=this.create({...t,promise:e,type:"loading",message:t.loading,description:typeof t.description!="function"?t.description:void 0}));const n=Promise.resolve(e instanceof Function?e():e);let i=s!==void 0,a;const o=n.then(async d=>{if(a=["resolve",d],Dt.isValidElement(d))i=!1,this.create({id:s,type:"default",message:d});else if(WP(d)&&!d.ok){i=!1;const p=typeof t.error=="function"?await t.error(`HTTP error! status: ${d.status}`):t.error,g=typeof t.description=="function"?await t.description(`HTTP error! status: ${d.status}`):t.description,b=typeof p=="object"&&!Dt.isValidElement(p)?p:{message:p};this.create({id:s,type:"error",description:g,...b})}else if(d instanceof Error){i=!1;const p=typeof t.error=="function"?await t.error(d):t.error,g=typeof t.description=="function"?await t.description(d):t.description,b=typeof p=="object"&&!Dt.isValidElement(p)?p:{message:p};this.create({id:s,type:"error",description:g,...b})}else if(t.success!==void 0){i=!1;const p=typeof t.success=="function"?await t.success(d):t.success,g=typeof t.description=="function"?await t.description(d):t.description,b=typeof p=="object"&&!Dt.isValidElement(p)?p:{message:p};this.create({id:s,type:"success",description:g,...b})}}).catch(async d=>{if(a=["reject",d],t.error!==void 0){i=!1;const h=typeof t.error=="function"?await t.error(d):t.error,p=typeof t.description=="function"?await t.description(d):t.description,v=typeof h=="object"&&!Dt.isValidElement(h)?h:{message:h};this.create({id:s,type:"error",description:p,...v})}}).finally(()=>{i&&(this.dismiss(s),s=void 0),t.finally==null||t.finally.call(t)}),l=()=>new Promise((d,h)=>o.then(()=>a[0]==="reject"?h(a[1]):d(a[1])).catch(h));return typeof s!="string"&&typeof s!="number"?{unwrap:l}:Object.assign(s,{unwrap:l})},this.custom=(e,t)=>{const s=t?.id||Cf++;return this.create({jsx:e(s),id:s,...t}),s},this.getActiveToasts=()=>this.toasts.filter(e=>!this.dismissedToasts.has(e.id)),this.subscribers=[],this.toasts=[],this.dismissedToasts=new Set}}const Gs=new VP,GP=(c,e)=>{const t=e?.id||Cf++;return Gs.addToast({title:c,...e,id:t}),t},WP=c=>c&&typeof c=="object"&&"ok"in c&&typeof c.ok=="boolean"&&"status"in c&&typeof c.status=="number",KP=GP,YP=()=>Gs.toasts,XP=()=>Gs.getActiveToasts(),Ze=Object.assign(KP,{success:Gs.success,info:Gs.info,warning:Gs.warning,error:Gs.error,custom:Gs.custom,message:Gs.message,promise:Gs.promise,dismiss:Gs.dismiss,loading:Gs.loading},{getHistory:YP,getToasts:XP});QP("[data-sonner-toaster][dir=ltr],html[dir=ltr]{--toast-icon-margin-start:-3px;--toast-icon-margin-end:4px;--toast-svg-margin-start:-1px;--toast-svg-margin-end:0px;--toast-button-margin-start:auto;--toast-button-margin-end:0;--toast-close-button-start:0;--toast-close-button-end:unset;--toast-close-button-transform:translate(-35%, -35%)}[data-sonner-toaster][dir=rtl],html[dir=rtl]{--toast-icon-margin-start:4px;--toast-icon-margin-end:-3px;--toast-svg-margin-start:0px;--toast-svg-margin-end:-1px;--toast-button-margin-start:0;--toast-button-margin-end:auto;--toast-close-button-start:unset;--toast-close-button-end:0;--toast-close-button-transform:translate(35%, -35%)}[data-sonner-toaster]{position:fixed;width:var(--width);font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;--gray1:hsl(0, 0%, 99%);--gray2:hsl(0, 0%, 97.3%);--gray3:hsl(0, 0%, 95.1%);--gray4:hsl(0, 0%, 93%);--gray5:hsl(0, 0%, 90.9%);--gray6:hsl(0, 0%, 88.7%);--gray7:hsl(0, 0%, 85.8%);--gray8:hsl(0, 0%, 78%);--gray9:hsl(0, 0%, 56.1%);--gray10:hsl(0, 0%, 52.3%);--gray11:hsl(0, 0%, 43.5%);--gray12:hsl(0, 0%, 9%);--border-radius:8px;box-sizing:border-box;padding:0;margin:0;list-style:none;outline:0;z-index:999999999;transition:transform .4s ease}@media (hover:none) and (pointer:coarse){[data-sonner-toaster][data-lifted=true]{transform:none}}[data-sonner-toaster][data-x-position=right]{right:var(--offset-right)}[data-sonner-toaster][data-x-position=left]{left:var(--offset-left)}[data-sonner-toaster][data-x-position=center]{left:50%;transform:translateX(-50%)}[data-sonner-toaster][data-y-position=top]{top:var(--offset-top)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--offset-bottom)}[data-sonner-toast]{--y:translateY(100%);--lift-amount:calc(var(--lift) * var(--gap));z-index:var(--z-index);position:absolute;opacity:0;transform:var(--y);touch-action:none;transition:transform .4s,opacity .4s,height .4s,box-shadow .2s;box-sizing:border-box;outline:0;overflow-wrap:anywhere}[data-sonner-toast][data-styled=true]{padding:16px;background:var(--normal-bg);border:1px solid var(--normal-border);color:var(--normal-text);border-radius:var(--border-radius);box-shadow:0 4px 12px rgba(0,0,0,.1);width:var(--width);font-size:13px;display:flex;align-items:center;gap:6px}[data-sonner-toast]:focus-visible{box-shadow:0 4px 12px rgba(0,0,0,.1),0 0 0 2px rgba(0,0,0,.2)}[data-sonner-toast][data-y-position=top]{top:0;--y:translateY(-100%);--lift:1;--lift-amount:calc(1 * var(--gap))}[data-sonner-toast][data-y-position=bottom]{bottom:0;--y:translateY(100%);--lift:-1;--lift-amount:calc(var(--lift) * var(--gap))}[data-sonner-toast][data-styled=true] [data-description]{font-weight:400;line-height:1.4;color:#3f3f3f}[data-rich-colors=true][data-sonner-toast][data-styled=true] [data-description]{color:inherit}[data-sonner-toaster][data-sonner-theme=dark] [data-description]{color:#e8e8e8}[data-sonner-toast][data-styled=true] [data-title]{font-weight:500;line-height:1.5;color:inherit}[data-sonner-toast][data-styled=true] [data-icon]{display:flex;height:16px;width:16px;position:relative;justify-content:flex-start;align-items:center;flex-shrink:0;margin-left:var(--toast-icon-margin-start);margin-right:var(--toast-icon-margin-end)}[data-sonner-toast][data-promise=true] [data-icon]>svg{opacity:0;transform:scale(.8);transform-origin:center;animation:sonner-fade-in .3s ease forwards}[data-sonner-toast][data-styled=true] [data-icon]>*{flex-shrink:0}[data-sonner-toast][data-styled=true] [data-icon] svg{margin-left:var(--toast-svg-margin-start);margin-right:var(--toast-svg-margin-end)}[data-sonner-toast][data-styled=true] [data-content]{display:flex;flex-direction:column;gap:2px}[data-sonner-toast][data-styled=true] [data-button]{border-radius:4px;padding-left:8px;padding-right:8px;height:24px;font-size:12px;color:var(--normal-bg);background:var(--normal-text);margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end);border:none;font-weight:500;cursor:pointer;outline:0;display:flex;align-items:center;flex-shrink:0;transition:opacity .4s,box-shadow .2s}[data-sonner-toast][data-styled=true] [data-button]:focus-visible{box-shadow:0 0 0 2px rgba(0,0,0,.4)}[data-sonner-toast][data-styled=true] [data-button]:first-of-type{margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end)}[data-sonner-toast][data-styled=true] [data-cancel]{color:var(--normal-text);background:rgba(0,0,0,.08)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast][data-styled=true] [data-cancel]{background:rgba(255,255,255,.3)}[data-sonner-toast][data-styled=true] [data-close-button]{position:absolute;left:var(--toast-close-button-start);right:var(--toast-close-button-end);top:0;height:20px;width:20px;display:flex;justify-content:center;align-items:center;padding:0;color:var(--gray12);background:var(--normal-bg);border:1px solid var(--gray4);transform:var(--toast-close-button-transform);border-radius:50%;cursor:pointer;z-index:1;transition:opacity .1s,background .2s,border-color .2s}[data-sonner-toast][data-styled=true] [data-close-button]:focus-visible{box-shadow:0 4px 12px rgba(0,0,0,.1),0 0 0 2px rgba(0,0,0,.2)}[data-sonner-toast][data-styled=true] [data-disabled=true]{cursor:not-allowed}[data-sonner-toast][data-styled=true]:hover [data-close-button]:hover{background:var(--gray2);border-color:var(--gray5)}[data-sonner-toast][data-swiping=true]::before{content:'';position:absolute;left:-100%;right:-100%;height:100%;z-index:-1}[data-sonner-toast][data-y-position=top][data-swiping=true]::before{bottom:50%;transform:scaleY(3) translateY(50%)}[data-sonner-toast][data-y-position=bottom][data-swiping=true]::before{top:50%;transform:scaleY(3) translateY(-50%)}[data-sonner-toast][data-swiping=false][data-removed=true]::before{content:'';position:absolute;inset:0;transform:scaleY(2)}[data-sonner-toast][data-expanded=true]::after{content:'';position:absolute;left:0;height:calc(var(--gap) + 1px);bottom:100%;width:100%}[data-sonner-toast][data-mounted=true]{--y:translateY(0);opacity:1}[data-sonner-toast][data-expanded=false][data-front=false]{--scale:var(--toasts-before) * 0.05 + 1;--y:translateY(calc(var(--lift-amount) * var(--toasts-before))) scale(calc(-1 * var(--scale)));height:var(--front-toast-height)}[data-sonner-toast]>*{transition:opacity .4s}[data-sonner-toast][data-x-position=right]{right:0}[data-sonner-toast][data-x-position=left]{left:0}[data-sonner-toast][data-expanded=false][data-front=false][data-styled=true]>*{opacity:0}[data-sonner-toast][data-visible=false]{opacity:0;pointer-events:none}[data-sonner-toast][data-mounted=true][data-expanded=true]{--y:translateY(calc(var(--lift) * var(--offset)));height:var(--initial-height)}[data-sonner-toast][data-removed=true][data-front=true][data-swipe-out=false]{--y:translateY(calc(var(--lift) * -100%));opacity:0}[data-sonner-toast][data-removed=true][data-front=false][data-swipe-out=false][data-expanded=true]{--y:translateY(calc(var(--lift) * var(--offset) + var(--lift) * -100%));opacity:0}[data-sonner-toast][data-removed=true][data-front=false][data-swipe-out=false][data-expanded=false]{--y:translateY(40%);opacity:0;transition:transform .5s,opacity .2s}[data-sonner-toast][data-removed=true][data-front=false]::before{height:calc(var(--initial-height) + 20%)}[data-sonner-toast][data-swiping=true]{transform:var(--y) translateY(var(--swipe-amount-y,0)) translateX(var(--swipe-amount-x,0));transition:none}[data-sonner-toast][data-swiped=true]{user-select:none}[data-sonner-toast][data-swipe-out=true][data-y-position=bottom],[data-sonner-toast][data-swipe-out=true][data-y-position=top]{animation-duration:.2s;animation-timing-function:ease-out;animation-fill-mode:forwards}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=left]{animation-name:swipe-out-left}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=right]{animation-name:swipe-out-right}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=up]{animation-name:swipe-out-up}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=down]{animation-name:swipe-out-down}@keyframes swipe-out-left{from{transform:var(--y) translateX(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translateX(calc(var(--swipe-amount-x) - 100%));opacity:0}}@keyframes swipe-out-right{from{transform:var(--y) translateX(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translateX(calc(var(--swipe-amount-x) + 100%));opacity:0}}@keyframes swipe-out-up{from{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) - 100%));opacity:0}}@keyframes swipe-out-down{from{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) + 100%));opacity:0}}@media (max-width:600px){[data-sonner-toaster]{position:fixed;right:var(--mobile-offset-right);left:var(--mobile-offset-left);width:100%}[data-sonner-toaster][dir=rtl]{left:calc(var(--mobile-offset-left) * -1)}[data-sonner-toaster] [data-sonner-toast]{left:0;right:0;width:calc(100% - var(--mobile-offset-left) * 2)}[data-sonner-toaster][data-x-position=left]{left:var(--mobile-offset-left)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--mobile-offset-bottom)}[data-sonner-toaster][data-y-position=top]{top:var(--mobile-offset-top)}[data-sonner-toaster][data-x-position=center]{left:var(--mobile-offset-left);right:var(--mobile-offset-right);transform:none}}[data-sonner-toaster][data-sonner-theme=light]{--normal-bg:#fff;--normal-border:var(--gray4);--normal-text:var(--gray12);--success-bg:hsl(143, 85%, 96%);--success-border:hsl(145, 92%, 87%);--success-text:hsl(140, 100%, 27%);--info-bg:hsl(208, 100%, 97%);--info-border:hsl(221, 91%, 93%);--info-text:hsl(210, 92%, 45%);--warning-bg:hsl(49, 100%, 97%);--warning-border:hsl(49, 91%, 84%);--warning-text:hsl(31, 92%, 45%);--error-bg:hsl(359, 100%, 97%);--error-border:hsl(359, 100%, 94%);--error-text:hsl(360, 100%, 45%)}[data-sonner-toaster][data-sonner-theme=light] [data-sonner-toast][data-invert=true]{--normal-bg:#000;--normal-border:hsl(0, 0%, 20%);--normal-text:var(--gray1)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast][data-invert=true]{--normal-bg:#fff;--normal-border:var(--gray3);--normal-text:var(--gray12)}[data-sonner-toaster][data-sonner-theme=dark]{--normal-bg:#000;--normal-bg-hover:hsl(0, 0%, 12%);--normal-border:hsl(0, 0%, 20%);--normal-border-hover:hsl(0, 0%, 25%);--normal-text:var(--gray1);--success-bg:hsl(150, 100%, 6%);--success-border:hsl(147, 100%, 12%);--success-text:hsl(150, 86%, 65%);--info-bg:hsl(215, 100%, 6%);--info-border:hsl(223, 43%, 17%);--info-text:hsl(216, 87%, 65%);--warning-bg:hsl(64, 100%, 6%);--warning-border:hsl(60, 100%, 9%);--warning-text:hsl(46, 87%, 65%);--error-bg:hsl(358, 76%, 10%);--error-border:hsl(357, 89%, 16%);--error-text:hsl(358, 100%, 81%)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast] [data-close-button]{background:var(--normal-bg);border-color:var(--normal-border);color:var(--normal-text)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast] [data-close-button]:hover{background:var(--normal-bg-hover);border-color:var(--normal-border-hover)}[data-rich-colors=true][data-sonner-toast][data-type=success]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=success] [data-close-button]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=info]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=info] [data-close-button]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning] [data-close-button]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=error]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}[data-rich-colors=true][data-sonner-toast][data-type=error] [data-close-button]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}.sonner-loading-wrapper{--size:16px;height:var(--size);width:var(--size);position:absolute;inset:0;z-index:10}.sonner-loading-wrapper[data-visible=false]{transform-origin:center;animation:sonner-fade-out .2s ease forwards}.sonner-spinner{position:relative;top:50%;left:50%;height:var(--size);width:var(--size)}.sonner-loading-bar{animation:sonner-spin 1.2s linear infinite;background:var(--gray11);border-radius:6px;height:8%;left:-10%;position:absolute;top:-3.9%;width:24%}.sonner-loading-bar:first-child{animation-delay:-1.2s;transform:rotate(.0001deg) translate(146%)}.sonner-loading-bar:nth-child(2){animation-delay:-1.1s;transform:rotate(30deg) translate(146%)}.sonner-loading-bar:nth-child(3){animation-delay:-1s;transform:rotate(60deg) translate(146%)}.sonner-loading-bar:nth-child(4){animation-delay:-.9s;transform:rotate(90deg) translate(146%)}.sonner-loading-bar:nth-child(5){animation-delay:-.8s;transform:rotate(120deg) translate(146%)}.sonner-loading-bar:nth-child(6){animation-delay:-.7s;transform:rotate(150deg) translate(146%)}.sonner-loading-bar:nth-child(7){animation-delay:-.6s;transform:rotate(180deg) translate(146%)}.sonner-loading-bar:nth-child(8){animation-delay:-.5s;transform:rotate(210deg) translate(146%)}.sonner-loading-bar:nth-child(9){animation-delay:-.4s;transform:rotate(240deg) translate(146%)}.sonner-loading-bar:nth-child(10){animation-delay:-.3s;transform:rotate(270deg) translate(146%)}.sonner-loading-bar:nth-child(11){animation-delay:-.2s;transform:rotate(300deg) translate(146%)}.sonner-loading-bar:nth-child(12){animation-delay:-.1s;transform:rotate(330deg) translate(146%)}@keyframes sonner-fade-in{0%{opacity:0;transform:scale(.8)}100%{opacity:1;transform:scale(1)}}@keyframes sonner-fade-out{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(.8)}}@keyframes sonner-spin{0%{opacity:1}100%{opacity:.15}}@media (prefers-reduced-motion){.sonner-loading-bar,[data-sonner-toast],[data-sonner-toast]>*{transition:none!important;animation:none!important}}.sonner-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transform-origin:center;transition:opacity .2s,transform .2s}.sonner-loader[data-visible=false]{opacity:0;transform:scale(.8) translate(-50%,-50%)}");var JP=Ff[" useId ".trim().toString()]||(()=>{}),ZP=0;function ln(c){const[e,t]=R.useState(JP());return as(()=>{t(s=>s??String(ZP++))},[c]),e?`radix-${e}`:""}var eL=Ff[" useInsertionEffect ".trim().toString()]||as;function En({prop:c,defaultProp:e,onChange:t=()=>{},caller:s}){const[n,i,a]=tL({defaultProp:e,onChange:t}),o=c!==void 0,l=o?c:n;{const h=R.useRef(c!==void 0);R.useEffect(()=>{const p=h.current;p!==o&&console.warn(`${s} is changing from ${p?"controlled":"uncontrolled"} to ${o?"controlled":"uncontrolled"}. Components should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled value for the lifetime of the component.`),h.current=o},[o,s])}const d=R.useCallback(h=>{if(o){const p=sL(h)?h(c):h;p!==c&&a.current?.(p)}else i(h)},[o,c,i,a]);return[l,d]}function tL({defaultProp:c,onChange:e}){const[t,s]=R.useState(c),n=R.useRef(t),i=R.useRef(e);return eL(()=>{i.current=e},[e]),R.useEffect(()=>{n.current!==t&&(i.current?.(t),n.current=t)},[t,n]),[t,s,i]}function sL(c){return typeof c=="function"}function nL(c,e=globalThis?.document){const t=is(c);R.useEffect(()=>{const s=n=>{n.key==="Escape"&&t(n)};return e.addEventListener("keydown",s,{capture:!0}),()=>e.removeEventListener("keydown",s,{capture:!0})},[t,e])}var iL="DismissableLayer",Rf="dismissableLayer.update",aL="dismissableLayer.pointerDownOutside",oL="dismissableLayer.focusOutside",mv,tM=R.createContext({layers:new Set,layersWithOutsidePointerEventsDisabled:new Set,branches:new Set}),Kr=R.forwardRef((c,e)=>{const{disableOutsidePointerEvents:t=!1,onEscapeKeyDown:s,onPointerDownOutside:n,onFocusOutside:i,onInteractOutside:a,onDismiss:o,...l}=c,d=R.useContext(tM),[h,p]=R.useState(null),g=h?.ownerDocument??globalThis?.document,[,v]=R.useState({}),b=Ne(e,L=>p(L)),M=Array.from(d.layers),[x]=[...d.layersWithOutsidePointerEventsDisabled].slice(-1),S=M.indexOf(x),T=h?M.indexOf(h):-1,E=d.layersWithOutsidePointerEventsDisabled.size>0,A=T>=S,k=lL(L=>{const I=L.target,U=[...d.branches].some(Q=>Q.contains(I));!A||U||(n?.(L),a?.(L),L.defaultPrevented||o?.())},g),D=uL(L=>{const I=L.target;[...d.branches].some(Q=>Q.contains(I))||(i?.(L),a?.(L),L.defaultPrevented||o?.())},g);return nL(L=>{T===d.layers.size-1&&(s?.(L),!L.defaultPrevented&&o&&(L.preventDefault(),o()))},g),R.useEffect(()=>{if(h)return t&&(d.layersWithOutsidePointerEventsDisabled.size===0&&(mv=g.body.style.pointerEvents,g.body.style.pointerEvents="none"),d.layersWithOutsidePointerEventsDisabled.add(h)),d.layers.add(h),yv(),()=>{t&&d.layersWithOutsidePointerEventsDisabled.size===1&&(g.body.style.pointerEvents=mv)}},[h,g,t,d]),R.useEffect(()=>()=>{h&&(d.layers.delete(h),d.layersWithOutsidePointerEventsDisabled.delete(h),yv())},[h,d]),R.useEffect(()=>{const L=()=>v({});return document.addEventListener(Rf,L),()=>document.removeEventListener(Rf,L)},[]),y.jsx(Le.div,{...l,ref:b,style:{pointerEvents:E?A?"auto":"none":void 0,...c.style},onFocusCapture:be(c.onFocusCapture,D.onFocusCapture),onBlurCapture:be(c.onBlurCapture,D.onBlurCapture),onPointerDownCapture:be(c.onPointerDownCapture,k.onPointerDownCapture)})});Kr.displayName=iL;var rL="DismissableLayerBranch",cL=R.forwardRef((c,e)=>{const t=R.useContext(tM),s=R.useRef(null),n=Ne(e,s);return R.useEffect(()=>{const i=s.current;if(i)return t.branches.add(i),()=>{t.branches.delete(i)}},[t.branches]),y.jsx(Le.div,{...c,ref:n})});cL.displayName=rL;function lL(c,e=globalThis?.document){const t=is(c),s=R.useRef(!1),n=R.useRef(()=>{});return R.useEffect(()=>{const i=o=>{if(o.target&&!s.current){let l=function(){sM(aL,t,d,{discrete:!0})};const d={originalEvent:o};o.pointerType==="touch"?(e.removeEventListener("click",n.current),n.current=l,e.addEventListener("click",n.current,{once:!0})):l()}else e.removeEventListener("click",n.current);s.current=!1},a=window.setTimeout(()=>{e.addEventListener("pointerdown",i)},0);return()=>{window.clearTimeout(a),e.removeEventListener("pointerdown",i),e.removeEventListener("click",n.current)}},[e,t]),{onPointerDownCapture:()=>s.current=!0}}function uL(c,e=globalThis?.document){const t=is(c),s=R.useRef(!1);return R.useEffect(()=>{const n=i=>{i.target&&!s.current&&sM(oL,t,{originalEvent:i},{discrete:!1})};return e.addEventListener("focusin",n),()=>e.removeEventListener("focusin",n)},[e,t]),{onFocusCapture:()=>s.current=!0,onBlurCapture:()=>s.current=!1}}function yv(){const c=new CustomEvent(Rf);document.dispatchEvent(c)}function sM(c,e,t,{discrete:s}){const n=t.originalEvent.target,i=new CustomEvent(c,{bubbles:!1,cancelable:!0,detail:t});e&&n.addEventListener(c,e,{once:!0}),s?$b(n,i):n.dispatchEvent(i)}var cf="focusScope.autoFocusOnMount",lf="focusScope.autoFocusOnUnmount",vv={bubbles:!1,cancelable:!0},dL="FocusScope",Yr=R.forwardRef((c,e)=>{const{loop:t=!1,trapped:s=!1,onMountAutoFocus:n,onUnmountAutoFocus:i,...a}=c,[o,l]=R.useState(null),d=is(n),h=is(i),p=R.useRef(null),g=Ne(e,M=>l(M)),v=R.useRef({paused:!1,pause(){this.paused=!0},resume(){this.paused=!1}}).current;R.useEffect(()=>{if(s){let M=function(E){if(v.paused||!o)return;const A=E.target;o.contains(A)?p.current=A:Ii(p.current,{select:!0})},x=function(E){if(v.paused||!o)return;const A=E.relatedTarget;A!==null&&(o.contains(A)||Ii(p.current,{select:!0}))},S=function(E){if(document.activeElement===document.body)for(const k of E)k.removedNodes.length>0&&Ii(o)};document.addEventListener("focusin",M),document.addEventListener("focusout",x);const T=new MutationObserver(S);return o&&T.observe(o,{childList:!0,subtree:!0}),()=>{document.removeEventListener("focusin",M),document.removeEventListener("focusout",x),T.disconnect()}}},[s,o,v.paused]),R.useEffect(()=>{if(o){Mv.add(v);const M=document.activeElement;if(!o.contains(M)){const S=new CustomEvent(cf,vv);o.addEventListener(cf,d),o.dispatchEvent(S),S.defaultPrevented||(hL(yL(nM(o)),{select:!0}),document.activeElement===M&&Ii(o))}return()=>{o.removeEventListener(cf,d),setTimeout(()=>{const S=new CustomEvent(lf,vv);o.addEventListener(lf,h),o.dispatchEvent(S),S.defaultPrevented||Ii(M??document.body,{select:!0}),o.removeEventListener(lf,h),Mv.remove(v)},0)}}},[o,d,h,v]);const b=R.useCallback(M=>{if(!t&&!s||v.paused)return;const x=M.key==="Tab"&&!M.altKey&&!M.ctrlKey&&!M.metaKey,S=document.activeElement;if(x&&S){const T=M.currentTarget,[E,A]=fL(T);E&&A?!M.shiftKey&&S===A?(M.preventDefault(),t&&Ii(E,{select:!0})):M.shiftKey&&S===E&&(M.preventDefault(),t&&Ii(A,{select:!0})):S===T&&M.preventDefault()}},[t,s,v.paused]);return y.jsx(Le.div,{tabIndex:-1,...a,ref:g,onKeyDown:b})});Yr.displayName=dL;function hL(c,{select:e=!1}={}){const t=document.activeElement;for(const s of c)if(Ii(s,{select:e}),document.activeElement!==t)return}function fL(c){const e=nM(c),t=bv(e,c),s=bv(e.reverse(),c);return[t,s]}function nM(c){const e=[],t=document.createTreeWalker(c,NodeFilter.SHOW_ELEMENT,{acceptNode:s=>{const n=s.tagName==="INPUT"&&s.type==="hidden";return s.disabled||s.hidden||n?NodeFilter.FILTER_SKIP:s.tabIndex>=0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;t.nextNode();)e.push(t.currentNode);return e}function bv(c,e){for(const t of c)if(!pL(t,{upTo:e}))return t}function pL(c,{upTo:e}){if(getComputedStyle(c).visibility==="hidden")return!0;for(;c;){if(e!==void 0&&c===e)return!1;if(getComputedStyle(c).display==="none")return!0;c=c.parentElement}return!1}function gL(c){return c instanceof HTMLInputElement&&"select"in c}function Ii(c,{select:e=!1}={}){if(c&&c.focus){const t=document.activeElement;c.focus({preventScroll:!0}),c!==t&&gL(c)&&e&&c.select()}}var Mv=mL();function mL(){let c=[];return{add(e){const t=c[0];e!==t&&t?.pause(),c=wv(c,e),c.unshift(e)},remove(e){c=wv(c,e),c[0]?.resume()}}}function wv(c,e){const t=[...c],s=t.indexOf(e);return s!==-1&&t.splice(s,1),t}function yL(c){return c.filter(e=>e.tagName!=="A")}var vL="Portal",Xr=R.forwardRef((c,e)=>{const{container:t,...s}=c,[n,i]=R.useState(!1);as(()=>i(!0),[]);const a=t||n&&globalThis?.document?.body;return a?SE.createPortal(y.jsx(Le.div,{...s,ref:e}),a):null});Xr.displayName=vL;var uf=0;function ou(){R.useEffect(()=>{const c=document.querySelectorAll("[data-radix-focus-guard]");return document.body.insertAdjacentElement("afterbegin",c[0]??Sv()),document.body.insertAdjacentElement("beforeend",c[1]??Sv()),uf++,()=>{uf===1&&document.querySelectorAll("[data-radix-focus-guard]").forEach(e=>e.remove()),uf--}},[])}function Sv(){const c=document.createElement("span");return c.setAttribute("data-radix-focus-guard",""),c.tabIndex=0,c.style.outline="none",c.style.opacity="0",c.style.position="fixed",c.style.pointerEvents="none",c}var Mn=function(){return Mn=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++){t=arguments[s];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},Mn.apply(this,arguments)};function iM(c,e){var t={};for(var s in c)Object.prototype.hasOwnProperty.call(c,s)&&e.indexOf(s)<0&&(t[s]=c[s]);if(c!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(c);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(c,s[n])&&(t[s[n]]=c[s[n]]);return t}function bL(c,e,t){if(t||arguments.length===2)for(var s=0,n=e.length,i;s<n;s++)(i||!(s in e))&&(i||(i=Array.prototype.slice.call(e,0,s)),i[s]=e[s]);return c.concat(i||Array.prototype.slice.call(e))}var _l="right-scroll-bar-position",Il="width-before-scroll-bar",ML="with-scroll-bars-hidden",wL="--removed-body-scroll-bar-size";function df(c,e){return typeof c=="function"?c(e):c&&(c.current=e),c}function SL(c,e){var t=R.useState(function(){return{value:c,callback:e,facade:{get current(){return t.value},set current(s){var n=t.value;n!==s&&(t.value=s,t.callback(s,n))}}}})[0];return t.callback=e,t.facade}var xL=typeof window<"u"?R.useLayoutEffect:R.useEffect,xv=new WeakMap;function CL(c,e){var t=SL(null,function(s){return c.forEach(function(n){return df(n,s)})});return xL(function(){var s=xv.get(t);if(s){var n=new Set(s),i=new Set(c),a=t.current;n.forEach(function(o){i.has(o)||df(o,null)}),i.forEach(function(o){n.has(o)||df(o,a)})}xv.set(t,c)},[c]),t}function RL(c){return c}function TL(c,e){e===void 0&&(e=RL);var t=[],s=!1,n={read:function(){if(s)throw new Error("Sidecar: could not `read` from an `assigned` medium. `read` could be used only with `useMedium`.");return t.length?t[t.length-1]:c},useMedium:function(i){var a=e(i,s);return t.push(a),function(){t=t.filter(function(o){return o!==a})}},assignSyncMedium:function(i){for(s=!0;t.length;){var a=t;t=[],a.forEach(i)}t={push:function(o){return i(o)},filter:function(){return t}}},assignMedium:function(i){s=!0;var a=[];if(t.length){var o=t;t=[],o.forEach(i),a=t}var l=function(){var h=a;a=[],h.forEach(i)},d=function(){return Promise.resolve().then(l)};d(),t={push:function(h){a.push(h),d()},filter:function(h){return a=a.filter(h),t}}}};return n}function EL(c){c===void 0&&(c={});var e=TL(null);return e.options=Mn({async:!0,ssr:!1},c),e}var aM=function(c){var e=c.sideCar,t=iM(c,["sideCar"]);if(!e)throw new Error("Sidecar: please provide `sideCar` property to import the right car");var s=e.read();if(!s)throw new Error("Sidecar medium not found");return R.createElement(s,Mn({},t))};aM.isSideCarExport=!0;function kL(c,e){return c.useMedium(e),aM}var oM=EL(),hf=function(){},ru=R.forwardRef(function(c,e){var t=R.useRef(null),s=R.useState({onScrollCapture:hf,onWheelCapture:hf,onTouchMoveCapture:hf}),n=s[0],i=s[1],a=c.forwardProps,o=c.children,l=c.className,d=c.removeScrollBar,h=c.enabled,p=c.shards,g=c.sideCar,v=c.noRelative,b=c.noIsolation,M=c.inert,x=c.allowPinchZoom,S=c.as,T=S===void 0?"div":S,E=c.gapMode,A=iM(c,["forwardProps","children","className","removeScrollBar","enabled","shards","sideCar","noRelative","noIsolation","inert","allowPinchZoom","as","gapMode"]),k=g,D=CL([t,e]),L=Mn(Mn({},A),n);return R.createElement(R.Fragment,null,h&&R.createElement(k,{sideCar:oM,removeScrollBar:d,shards:p,noRelative:v,noIsolation:b,inert:M,setCallbacks:i,allowPinchZoom:!!x,lockRef:t,gapMode:E}),a?R.cloneElement(R.Children.only(o),Mn(Mn({},L),{ref:D})):R.createElement(T,Mn({},L,{className:l,ref:D}),o))});ru.defaultProps={enabled:!0,removeScrollBar:!0,inert:!1};ru.classNames={fullWidth:Il,zeroRight:_l};var AL=function(){if(typeof __webpack_nonce__<"u")return __webpack_nonce__};function DL(){if(!document)return null;var c=document.createElement("style");c.type="text/css";var e=AL();return e&&c.setAttribute("nonce",e),c}function PL(c,e){c.styleSheet?c.styleSheet.cssText=e:c.appendChild(document.createTextNode(e))}function LL(c){var e=document.head||document.getElementsByTagName("head")[0];e.appendChild(c)}var _L=function(){var c=0,e=null;return{add:function(t){c==0&&(e=DL())&&(PL(e,t),LL(e)),c++},remove:function(){c--,!c&&e&&(e.parentNode&&e.parentNode.removeChild(e),e=null)}}},IL=function(){var c=_L();return function(e,t){R.useEffect(function(){return c.add(e),function(){c.remove()}},[e&&t])}},rM=function(){var c=IL(),e=function(t){var s=t.styles,n=t.dynamic;return c(s,n),null};return e},NL={left:0,top:0,right:0,gap:0},ff=function(c){return parseInt(c||"",10)||0},zL=function(c){var e=window.getComputedStyle(document.body),t=e[c==="padding"?"paddingLeft":"marginLeft"],s=e[c==="padding"?"paddingTop":"marginTop"],n=e[c==="padding"?"paddingRight":"marginRight"];return[ff(t),ff(s),ff(n)]},jL=function(c){if(c===void 0&&(c="margin"),typeof window>"u")return NL;var e=zL(c),t=document.documentElement.clientWidth,s=window.innerWidth;return{left:e[0],top:e[1],right:e[2],gap:Math.max(0,s-t+e[2]-e[0])}},OL=rM(),xo="data-scroll-locked",qL=function(c,e,t,s){var n=c.left,i=c.top,a=c.right,o=c.gap;return t===void 0&&(t="margin"),`
  .`.concat(ML,` {
   overflow: hidden `).concat(s,`;
   padding-right: `).concat(o,"px ").concat(s,`;
  }
  body[`).concat(xo,`] {
    overflow: hidden `).concat(s,`;
    overscroll-behavior: contain;
    `).concat([e&&"position: relative ".concat(s,";"),t==="margin"&&`
    padding-left: `.concat(n,`px;
    padding-top: `).concat(i,`px;
    padding-right: `).concat(a,`px;
    margin-left:0;
    margin-top:0;
    margin-right: `).concat(o,"px ").concat(s,`;
    `),t==="padding"&&"padding-right: ".concat(o,"px ").concat(s,";")].filter(Boolean).join(""),`
  }
  
  .`).concat(_l,` {
    right: `).concat(o,"px ").concat(s,`;
  }
  
  .`).concat(Il,` {
    margin-right: `).concat(o,"px ").concat(s,`;
  }
  
  .`).concat(_l," .").concat(_l,` {
    right: 0 `).concat(s,`;
  }
  
  .`).concat(Il," .").concat(Il,` {
    margin-right: 0 `).concat(s,`;
  }
  
  body[`).concat(xo,`] {
    `).concat(wL,": ").concat(o,`px;
  }
`)},Cv=function(){var c=parseInt(document.body.getAttribute(xo)||"0",10);return isFinite(c)?c:0},HL=function(){R.useEffect(function(){return document.body.setAttribute(xo,(Cv()+1).toString()),function(){var c=Cv()-1;c<=0?document.body.removeAttribute(xo):document.body.setAttribute(xo,c.toString())}},[])},$L=function(c){var e=c.noRelative,t=c.noImportant,s=c.gapMode,n=s===void 0?"margin":s;HL();var i=R.useMemo(function(){return jL(n)},[n]);return R.createElement(OL,{styles:qL(i,!e,n,t?"":"!important")})},Tf=!1;if(typeof window<"u")try{var Sl=Object.defineProperty({},"passive",{get:function(){return Tf=!0,!0}});window.addEventListener("test",Sl,Sl),window.removeEventListener("test",Sl,Sl)}catch{Tf=!1}var yo=Tf?{passive:!1}:!1,BL=function(c){return c.tagName==="TEXTAREA"},cM=function(c,e){if(!(c instanceof Element))return!1;var t=window.getComputedStyle(c);return t[e]!=="hidden"&&!(t.overflowY===t.overflowX&&!BL(c)&&t[e]==="visible")},UL=function(c){return cM(c,"overflowY")},FL=function(c){return cM(c,"overflowX")},Rv=function(c,e){var t=e.ownerDocument,s=e;do{typeof ShadowRoot<"u"&&s instanceof ShadowRoot&&(s=s.host);var n=lM(c,s);if(n){var i=uM(c,s),a=i[1],o=i[2];if(a>o)return!0}s=s.parentNode}while(s&&s!==t.body);return!1},QL=function(c){var e=c.scrollTop,t=c.scrollHeight,s=c.clientHeight;return[e,t,s]},VL=function(c){var e=c.scrollLeft,t=c.scrollWidth,s=c.clientWidth;return[e,t,s]},lM=function(c,e){return c==="v"?UL(e):FL(e)},uM=function(c,e){return c==="v"?QL(e):VL(e)},GL=function(c,e){return c==="h"&&e==="rtl"?-1:1},WL=function(c,e,t,s,n){var i=GL(c,window.getComputedStyle(e).direction),a=i*s,o=t.target,l=e.contains(o),d=!1,h=a>0,p=0,g=0;do{if(!o)break;var v=uM(c,o),b=v[0],M=v[1],x=v[2],S=M-x-i*b;(b||S)&&lM(c,o)&&(p+=S,g+=b);var T=o.parentNode;o=T&&T.nodeType===Node.DOCUMENT_FRAGMENT_NODE?T.host:T}while(!l&&o!==document.body||l&&(e.contains(o)||e===o));return(h&&Math.abs(p)<1||!h&&Math.abs(g)<1)&&(d=!0),d},xl=function(c){return"changedTouches"in c?[c.changedTouches[0].clientX,c.changedTouches[0].clientY]:[0,0]},Tv=function(c){return[c.deltaX,c.deltaY]},Ev=function(c){return c&&"current"in c?c.current:c},KL=function(c,e){return c[0]===e[0]&&c[1]===e[1]},YL=function(c){return`
  .block-interactivity-`.concat(c,` {pointer-events: none;}
  .allow-interactivity-`).concat(c,` {pointer-events: all;}
`)},XL=0,vo=[];function JL(c){var e=R.useRef([]),t=R.useRef([0,0]),s=R.useRef(),n=R.useState(XL++)[0],i=R.useState(rM)[0],a=R.useRef(c);R.useEffect(function(){a.current=c},[c]),R.useEffect(function(){if(c.inert){document.body.classList.add("block-interactivity-".concat(n));var M=bL([c.lockRef.current],(c.shards||[]).map(Ev),!0).filter(Boolean);return M.forEach(function(x){return x.classList.add("allow-interactivity-".concat(n))}),function(){document.body.classList.remove("block-interactivity-".concat(n)),M.forEach(function(x){return x.classList.remove("allow-interactivity-".concat(n))})}}},[c.inert,c.lockRef.current,c.shards]);var o=R.useCallback(function(M,x){if("touches"in M&&M.touches.length===2||M.type==="wheel"&&M.ctrlKey)return!a.current.allowPinchZoom;var S=xl(M),T=t.current,E="deltaX"in M?M.deltaX:T[0]-S[0],A="deltaY"in M?M.deltaY:T[1]-S[1],k,D=M.target,L=Math.abs(E)>Math.abs(A)?"h":"v";if("touches"in M&&L==="h"&&D.type==="range")return!1;var I=Rv(L,D);if(!I)return!0;if(I?k=L:(k=L==="v"?"h":"v",I=Rv(L,D)),!I)return!1;if(!s.current&&"changedTouches"in M&&(E||A)&&(s.current=k),!k)return!0;var U=s.current||k;return WL(U,x,M,U==="h"?E:A)},[]),l=R.useCallback(function(M){var x=M;if(!(!vo.length||vo[vo.length-1]!==i)){var S="deltaY"in x?Tv(x):xl(x),T=e.current.filter(function(k){return k.name===x.type&&(k.target===x.target||x.target===k.shadowParent)&&KL(k.delta,S)})[0];if(T&&T.should){x.cancelable&&x.preventDefault();return}if(!T){var E=(a.current.shards||[]).map(Ev).filter(Boolean).filter(function(k){return k.contains(x.target)}),A=E.length>0?o(x,E[0]):!a.current.noIsolation;A&&x.cancelable&&x.preventDefault()}}},[]),d=R.useCallback(function(M,x,S,T){var E={name:M,delta:x,target:S,should:T,shadowParent:ZL(S)};e.current.push(E),setTimeout(function(){e.current=e.current.filter(function(A){return A!==E})},1)},[]),h=R.useCallback(function(M){t.current=xl(M),s.current=void 0},[]),p=R.useCallback(function(M){d(M.type,Tv(M),M.target,o(M,c.lockRef.current))},[]),g=R.useCallback(function(M){d(M.type,xl(M),M.target,o(M,c.lockRef.current))},[]);R.useEffect(function(){return vo.push(i),c.setCallbacks({onScrollCapture:p,onWheelCapture:p,onTouchMoveCapture:g}),document.addEventListener("wheel",l,yo),document.addEventListener("touchmove",l,yo),document.addEventListener("touchstart",h,yo),function(){vo=vo.filter(function(M){return M!==i}),document.removeEventListener("wheel",l,yo),document.removeEventListener("touchmove",l,yo),document.removeEventListener("touchstart",h,yo)}},[]);var v=c.removeScrollBar,b=c.inert;return R.createElement(R.Fragment,null,b?R.createElement(i,{styles:YL(n)}):null,v?R.createElement($L,{noRelative:c.noRelative,gapMode:c.gapMode}):null)}function ZL(c){for(var e=null;c!==null;)c instanceof ShadowRoot&&(e=c.host,c=c.host),c=c.parentNode;return e}const e_=kL(oM,JL);var Jr=R.forwardRef(function(c,e){return R.createElement(ru,Mn({},c,{ref:e,sideCar:e_}))});Jr.classNames=ru.classNames;var t_=function(c){if(typeof document>"u")return null;var e=Array.isArray(c)?c[0]:c;return e.ownerDocument.body},bo=new WeakMap,Cl=new WeakMap,Rl={},pf=0,dM=function(c){return c&&(c.host||dM(c.parentNode))},s_=function(c,e){return e.map(function(t){if(c.contains(t))return t;var s=dM(t);return s&&c.contains(s)?s:(console.error("aria-hidden",t,"in not contained inside",c,". Doing nothing"),null)}).filter(function(t){return!!t})},n_=function(c,e,t,s){var n=s_(e,Array.isArray(c)?c:[c]);Rl[t]||(Rl[t]=new WeakMap);var i=Rl[t],a=[],o=new Set,l=new Set(n),d=function(p){!p||o.has(p)||(o.add(p),d(p.parentNode))};n.forEach(d);var h=function(p){!p||l.has(p)||Array.prototype.forEach.call(p.children,function(g){if(o.has(g))h(g);else try{var v=g.getAttribute(s),b=v!==null&&v!=="false",M=(bo.get(g)||0)+1,x=(i.get(g)||0)+1;bo.set(g,M),i.set(g,x),a.push(g),M===1&&b&&Cl.set(g,!0),x===1&&g.setAttribute(t,"true"),b||g.setAttribute(s,"true")}catch(S){console.error("aria-hidden: cannot operate on ",g,S)}})};return h(e),o.clear(),pf++,function(){a.forEach(function(p){var g=bo.get(p)-1,v=i.get(p)-1;bo.set(p,g),i.set(p,v),g||(Cl.has(p)||p.removeAttribute(s),Cl.delete(p)),v||p.removeAttribute(t)}),pf--,pf||(bo=new WeakMap,bo=new WeakMap,Cl=new WeakMap,Rl={})}},cu=function(c,e,t){t===void 0&&(t="data-aria-hidden");var s=Array.from(Array.isArray(c)?c:[c]),n=t_(c);return n?(s.push.apply(s,Array.from(n.querySelectorAll("[aria-live], script"))),n_(s,n,t,"aria-hidden")):function(){return null}};function i_(c){const e=a_(c),t=R.forwardRef((s,n)=>{const{children:i,...a}=s,o=R.Children.toArray(i),l=o.find(r_);if(l){const d=l.props.children,h=o.map(p=>p===l?R.Children.count(d)>1?R.Children.only(null):R.isValidElement(d)?d.props.children:null:p);return y.jsx(e,{...a,ref:n,children:R.isValidElement(d)?R.cloneElement(d,void 0,h):null})}return y.jsx(e,{...a,ref:n,children:i})});return t.displayName=`${c}.Slot`,t}function a_(c){const e=R.forwardRef((t,s)=>{const{children:n,...i}=t;if(R.isValidElement(n)){const a=l_(n),o=c_(i,n.props);return n.type!==R.Fragment&&(o.ref=s?An(s,a):a),R.cloneElement(n,o)}return R.Children.count(n)>1?R.Children.only(null):null});return e.displayName=`${c}.SlotClone`,e}var o_=Symbol("radix.slottable");function r_(c){return R.isValidElement(c)&&typeof c.type=="function"&&"__radixId"in c.type&&c.type.__radixId===o_}function c_(c,e){const t={...e};for(const s in e){const n=c[s],i=e[s];/^on[A-Z]/.test(s)?n&&i?t[s]=(...o)=>{const l=i(...o);return n(...o),l}:n&&(t[s]=n):s==="style"?t[s]={...n,...i}:s==="className"&&(t[s]=[n,i].filter(Boolean).join(" "))}return{...c,...t}}function l_(c){let e=Object.getOwnPropertyDescriptor(c.props,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning;return t?c.ref:(e=Object.getOwnPropertyDescriptor(c,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning,t?c.props.ref:c.props.ref||c.ref)}var lu="Dialog",[hM,fM]=ws(lu),[u_,fn]=hM(lu),pM=c=>{const{__scopeDialog:e,children:t,open:s,defaultOpen:n,onOpenChange:i,modal:a=!0}=c,o=R.useRef(null),l=R.useRef(null),[d,h]=En({prop:s,defaultProp:n??!1,onChange:i,caller:lu});return y.jsx(u_,{scope:e,triggerRef:o,contentRef:l,contentId:ln(),titleId:ln(),descriptionId:ln(),open:d,onOpenChange:h,onOpenToggle:R.useCallback(()=>h(p=>!p),[h]),modal:a,children:t})};pM.displayName=lu;var gM="DialogTrigger",mM=R.forwardRef((c,e)=>{const{__scopeDialog:t,...s}=c,n=fn(gM,t),i=Ne(e,n.triggerRef);return y.jsx(Le.button,{type:"button","aria-haspopup":"dialog","aria-expanded":n.open,"aria-controls":n.contentId,"data-state":cp(n.open),...s,ref:i,onClick:be(c.onClick,n.onOpenToggle)})});mM.displayName=gM;var op="DialogPortal",[d_,yM]=hM(op,{forceMount:void 0}),vM=c=>{const{__scopeDialog:e,forceMount:t,children:s,container:n}=c,i=fn(op,e);return y.jsx(d_,{scope:e,forceMount:t,children:R.Children.map(s,a=>y.jsx(cs,{present:t||i.open,children:y.jsx(Xr,{asChild:!0,container:n,children:a})}))})};vM.displayName=op;var Ql="DialogOverlay",bM=R.forwardRef((c,e)=>{const t=yM(Ql,c.__scopeDialog),{forceMount:s=t.forceMount,...n}=c,i=fn(Ql,c.__scopeDialog);return i.modal?y.jsx(cs,{present:s||i.open,children:y.jsx(f_,{...n,ref:e})}):null});bM.displayName=Ql;var h_=i_("DialogOverlay.RemoveScroll"),f_=R.forwardRef((c,e)=>{const{__scopeDialog:t,...s}=c,n=fn(Ql,t);return y.jsx(Jr,{as:h_,allowPinchZoom:!0,shards:[n.contentRef],children:y.jsx(Le.div,{"data-state":cp(n.open),...s,ref:e,style:{pointerEvents:"auto",...s.style}})})}),xa="DialogContent",MM=R.forwardRef((c,e)=>{const t=yM(xa,c.__scopeDialog),{forceMount:s=t.forceMount,...n}=c,i=fn(xa,c.__scopeDialog);return y.jsx(cs,{present:s||i.open,children:i.modal?y.jsx(p_,{...n,ref:e}):y.jsx(g_,{...n,ref:e})})});MM.displayName=xa;var p_=R.forwardRef((c,e)=>{const t=fn(xa,c.__scopeDialog),s=R.useRef(null),n=Ne(e,t.contentRef,s);return R.useEffect(()=>{const i=s.current;if(i)return cu(i)},[]),y.jsx(wM,{...c,ref:n,trapFocus:t.open,disableOutsidePointerEvents:!0,onCloseAutoFocus:be(c.onCloseAutoFocus,i=>{i.preventDefault(),t.triggerRef.current?.focus()}),onPointerDownOutside:be(c.onPointerDownOutside,i=>{const a=i.detail.originalEvent,o=a.button===0&&a.ctrlKey===!0;(a.button===2||o)&&i.preventDefault()}),onFocusOutside:be(c.onFocusOutside,i=>i.preventDefault())})}),g_=R.forwardRef((c,e)=>{const t=fn(xa,c.__scopeDialog),s=R.useRef(!1),n=R.useRef(!1);return y.jsx(wM,{...c,ref:e,trapFocus:!1,disableOutsidePointerEvents:!1,onCloseAutoFocus:i=>{c.onCloseAutoFocus?.(i),i.defaultPrevented||(s.current||t.triggerRef.current?.focus(),i.preventDefault()),s.current=!1,n.current=!1},onInteractOutside:i=>{c.onInteractOutside?.(i),i.defaultPrevented||(s.current=!0,i.detail.originalEvent.type==="pointerdown"&&(n.current=!0));const a=i.target;t.triggerRef.current?.contains(a)&&i.preventDefault(),i.detail.originalEvent.type==="focusin"&&n.current&&i.preventDefault()}})}),wM=R.forwardRef((c,e)=>{const{__scopeDialog:t,trapFocus:s,onOpenAutoFocus:n,onCloseAutoFocus:i,...a}=c,o=fn(xa,t),l=R.useRef(null),d=Ne(e,l);return ou(),y.jsxs(y.Fragment,{children:[y.jsx(Yr,{asChild:!0,loop:!0,trapped:s,onMountAutoFocus:n,onUnmountAutoFocus:i,children:y.jsx(Kr,{role:"dialog",id:o.contentId,"aria-describedby":o.descriptionId,"aria-labelledby":o.titleId,"data-state":cp(o.open),...a,ref:d,onDismiss:()=>o.onOpenChange(!1)})}),y.jsxs(y.Fragment,{children:[y.jsx(y_,{titleId:o.titleId}),y.jsx(b_,{contentRef:l,descriptionId:o.descriptionId})]})]})}),rp="DialogTitle",SM=R.forwardRef((c,e)=>{const{__scopeDialog:t,...s}=c,n=fn(rp,t);return y.jsx(Le.h2,{id:n.titleId,...s,ref:e})});SM.displayName=rp;var xM="DialogDescription",CM=R.forwardRef((c,e)=>{const{__scopeDialog:t,...s}=c,n=fn(xM,t);return y.jsx(Le.p,{id:n.descriptionId,...s,ref:e})});CM.displayName=xM;var RM="DialogClose",TM=R.forwardRef((c,e)=>{const{__scopeDialog:t,...s}=c,n=fn(RM,t);return y.jsx(Le.button,{type:"button",...s,ref:e,onClick:be(c.onClick,()=>n.onOpenChange(!1))})});TM.displayName=RM;function cp(c){return c?"open":"closed"}var EM="DialogTitleWarning",[m_,kM]=kP(EM,{contentName:xa,titleName:rp,docsSlug:"dialog"}),y_=({titleId:c})=>{const e=kM(EM),t=`\`${e.contentName}\` requires a \`${e.titleName}\` for the component to be accessible for screen reader users.

If you want to hide the \`${e.titleName}\`, you can wrap it with our VisuallyHidden component.

For more information, see https://radix-ui.com/primitives/docs/components/${e.docsSlug}`;return R.useEffect(()=>{c&&(document.getElementById(c)||console.error(t))},[t,c]),null},v_="DialogDescriptionWarning",b_=({contentRef:c,descriptionId:e})=>{const s=`Warning: Missing \`Description\` or \`aria-describedby={undefined}\` for {${kM(v_).contentName}}.`;return R.useEffect(()=>{const n=c.current?.getAttribute("aria-describedby");e&&n&&(document.getElementById(e)||console.warn(s))},[s,c,e]),null},AM=pM,DM=mM,PM=vM,lp=bM,up=MM,dp=SM,hp=CM,fp=TM,M_=Symbol("radix.slottable");function w_(c){const e=({children:t})=>y.jsx(y.Fragment,{children:t});return e.displayName=`${c}.Slottable`,e.__radixId=M_,e}var LM="AlertDialog",[S_]=ws(LM,[fM]),ci=fM(),_M=c=>{const{__scopeAlertDialog:e,...t}=c,s=ci(e);return y.jsx(AM,{...s,...t,modal:!0})};_M.displayName=LM;var x_="AlertDialogTrigger",IM=R.forwardRef((c,e)=>{const{__scopeAlertDialog:t,...s}=c,n=ci(t);return y.jsx(DM,{...n,...s,ref:e})});IM.displayName=x_;var C_="AlertDialogPortal",NM=c=>{const{__scopeAlertDialog:e,...t}=c,s=ci(e);return y.jsx(PM,{...s,...t})};NM.displayName=C_;var R_="AlertDialogOverlay",zM=R.forwardRef((c,e)=>{const{__scopeAlertDialog:t,...s}=c,n=ci(t);return y.jsx(lp,{...n,...s,ref:e})});zM.displayName=R_;var Co="AlertDialogContent",[T_,E_]=S_(Co),k_=w_("AlertDialogContent"),jM=R.forwardRef((c,e)=>{const{__scopeAlertDialog:t,children:s,...n}=c,i=ci(t),a=R.useRef(null),o=Ne(e,a),l=R.useRef(null);return y.jsx(m_,{contentName:Co,titleName:OM,docsSlug:"alert-dialog",children:y.jsx(T_,{scope:t,cancelRef:l,children:y.jsxs(up,{role:"alertdialog",...i,...n,ref:o,onOpenAutoFocus:be(n.onOpenAutoFocus,d=>{d.preventDefault(),l.current?.focus({preventScroll:!0})}),onPointerDownOutside:d=>d.preventDefault(),onInteractOutside:d=>d.preventDefault(),children:[y.jsx(k_,{children:s}),y.jsx(D_,{contentRef:a})]})})})});jM.displayName=Co;var OM="AlertDialogTitle",qM=R.forwardRef((c,e)=>{const{__scopeAlertDialog:t,...s}=c,n=ci(t);return y.jsx(dp,{...n,...s,ref:e})});qM.displayName=OM;var HM="AlertDialogDescription",$M=R.forwardRef((c,e)=>{const{__scopeAlertDialog:t,...s}=c,n=ci(t);return y.jsx(hp,{...n,...s,ref:e})});$M.displayName=HM;var A_="AlertDialogAction",BM=R.forwardRef((c,e)=>{const{__scopeAlertDialog:t,...s}=c,n=ci(t);return y.jsx(fp,{...n,...s,ref:e})});BM.displayName=A_;var UM="AlertDialogCancel",FM=R.forwardRef((c,e)=>{const{__scopeAlertDialog:t,...s}=c,{cancelRef:n}=E_(UM,t),i=ci(t),a=Ne(e,n);return y.jsx(fp,{...i,...s,ref:a})});FM.displayName=UM;var D_=({contentRef:c})=>{const e=`\`${Co}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Co}\` by passing a \`${HM}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Co}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return R.useEffect(()=>{document.getElementById(c.current?.getAttribute("aria-describedby"))||console.warn(e)},[e,c]),null},P_=_M,L_=IM,__=NM,QM=zM,VM=jM,GM=BM,WM=FM,KM=qM,YM=$M;const XM=P_,S3=L_,I_=__,JM=R.forwardRef(({className:c,...e},t)=>y.jsx(QM,{className:Ae("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",c),...e,ref:t}));JM.displayName=QM.displayName;const pp=R.forwardRef(({className:c,...e},t)=>y.jsxs(I_,{children:[y.jsx(JM,{}),y.jsx(VM,{ref:t,className:Ae("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",c),...e})]}));pp.displayName=VM.displayName;const ZM=({className:c,...e})=>y.jsx("div",{className:Ae("flex flex-col space-y-2 text-center sm:text-left",c),...e});ZM.displayName="AlertDialogHeader";const ew=({className:c,...e})=>y.jsx("div",{className:Ae("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",c),...e});ew.displayName="AlertDialogFooter";const gp=R.forwardRef(({className:c,...e},t)=>y.jsx(KM,{ref:t,className:Ae("text-lg font-semibold",c),...e}));gp.displayName=KM.displayName;const mp=R.forwardRef(({className:c,...e},t)=>y.jsx(YM,{ref:t,className:Ae("text-sm text-muted-foreground",c),...e}));mp.displayName=YM.displayName;const yp=R.forwardRef(({className:c,...e},t)=>y.jsx(GM,{ref:t,className:Ae(Kf(),c),...e}));yp.displayName=GM.displayName;const vp=R.forwardRef(({className:c,...e},t)=>y.jsx(WM,{ref:t,className:Ae(Kf({variant:"outline"}),"mt-2 sm:mt-0",c),...e}));vp.displayName=WM.displayName;const bp=AM,x3=DM,N_=PM,tw=R.forwardRef(({className:c,...e},t)=>y.jsx(lp,{ref:t,className:Ae("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",c),...e}));tw.displayName=lp.displayName;const uu=R.forwardRef(({className:c,children:e,...t},s)=>y.jsxs(N_,{children:[y.jsx(tw,{}),y.jsxs(up,{ref:s,className:Ae("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",c),...t,children:[e,y.jsxs(fp,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[y.jsx(cn,{className:"h-4 w-4"}),y.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));uu.displayName=up.displayName;const du=({className:c,...e})=>y.jsx("div",{className:Ae("flex flex-col space-y-1.5 text-center sm:text-left",c),...e});du.displayName="DialogHeader";const hu=({className:c,...e})=>y.jsx("div",{className:Ae("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",c),...e});hu.displayName="DialogFooter";const fu=R.forwardRef(({className:c,...e},t)=>y.jsx(dp,{ref:t,className:Ae("text-lg font-semibold leading-none tracking-tight",c),...e}));fu.displayName=dp.displayName;const pu=R.forwardRef(({className:c,...e},t)=>y.jsx(hp,{ref:t,className:Ae("text-sm text-muted-foreground",c),...e}));pu.displayName=hp.displayName;var z_=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],j_=z_.reduce((c,e)=>{const t=Vf(`Primitive.${e}`),s=R.forwardRef((n,i)=>{const{asChild:a,...o}=n,l=a?t:e;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),y.jsx(l,{...o,ref:i})});return s.displayName=`Primitive.${e}`,{...c,[e]:s}},{}),O_="Label",sw=R.forwardRef((c,e)=>y.jsx(j_.label,{...c,ref:e,onMouseDown:t=>{t.target.closest("button, input, select, textarea")||(c.onMouseDown?.(t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}}));sw.displayName=O_;var nw=sw;const q_=Gf("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),He=R.forwardRef(({className:c,...e},t)=>y.jsx(nw,{ref:t,className:Ae(q_(),c),...e}));He.displayName=nw.displayName;function Mp({open:c,initialName:e="",onConfirm:t,onCancel:s}){const[n,i]=R.useState(e);R.useEffect(()=>{c&&i(e)},[c,e]);const a=()=>{n.trim()&&t(n.trim())};return y.jsx(bp,{open:c,onOpenChange:o=>!o&&s(),children:y.jsxs(uu,{children:[y.jsxs(du,{children:[y.jsx(fu,{children:e?"Rename Group":"Create Group"}),y.jsx(pu,{children:e?"Enter a new name for the group":"Enter a name for the new group"})]}),y.jsxs("div",{className:"py-4",children:[y.jsx(He,{htmlFor:"group-name",children:"Group Name"}),y.jsx(ct,{id:"group-name",value:n,onChange:o=>i(o.target.value),onKeyDown:o=>{o.key==="Enter"&&a()},className:"mt-2",autoFocus:!0})]}),y.jsxs(hu,{children:[y.jsx(De,{variant:"outline",onClick:s,children:"Cancel"}),y.jsx(De,{onClick:a,disabled:!n.trim(),children:e?"Save":"Create"})]})]})})}function H_(){const{zoom:c,setZoom:e,diagramName:t,setDiagramName:s,saveDiagram:n,loadDiagramState:i,undo:a,redo:o,selectedNodeId:l,createGroupFromSelection:d,autoGroupByConnections:h,nodes:p,pan:g,setPan:v,viewportWidth:b,viewportHeight:M}=ke(),{canUndo:x,canRedo:S}=zr(),T=R.useRef(null),[E,A]=R.useState(!1),[k,D]=R.useState(t),[L,I]=R.useState(!1),{showMinimap:U,toggleMinimap:Q,showHeatMapLegend:se,toggleHeatMapLegend:F,showRuler:Y,toggleRuler:ae}=Wr(),de=()=>e(Math.min(c+.1,2)),z=()=>e(c-.1),$=()=>{const re=p;if(!re.length){e(1),v({x:0,y:0});return}const V=100,j=re.map(Vt=>Vt.position.x),ue=re.map(Vt=>Vt.position.y),fe=re.map(Vt=>Vt.position.x+140),ge=re.map(Vt=>Vt.position.y+140),pe=Math.min(...j)-V,we=Math.min(...ue)-V,Re=Math.max(...fe)+V,tt=Math.max(...ge)+V,ze=Re-pe,Ct=tt-we,he=b||window.innerWidth,Qe=M||window.innerHeight-56,Ue=he/ze,Mt=Qe/Ct;let yt=Math.min(Ue,Mt);yt=Math.min(Math.max(yt,.2),2.5);const Ht=pe+ze/2,nt=we+Ct/2,It=he/2,wt=Qe/2,vt=It-Ht*yt,Xt=wt-nt*yt;e(yt),v({x:vt,y:Xt})},q=()=>{n(),Ze.success("Diagram saved to browser storage")},ee=()=>{const re=`${t.replace(/\s+/g,"_")}_${Date.now()}.json`;fA(ke.getState(),re),Ze.success("Diagram exported as JSON")},me=()=>{T.current?.click()},N=async re=>{const V=re.target.files?.[0];if(V){try{const j=await pA(V);if(!j){Ze.error("Failed to import diagram: Invalid file format");return}i({nodes:j.nodes||[],connections:j.connections||[],groups:j.groups||[],zoom:j.zoom||1,pan:j.pan||{x:0,y:0}}),s(j.name),Ze.success(`Diagram "${j.name}" imported successfully`)}catch(j){Ze.error("Failed to import diagram"),bs("Failed to import diagram",j instanceof Error?j:new Error(String(j)))}T.current&&(T.current.value="")}},J=()=>{k.trim()&&(s(k.trim()),Ze.success("Diagram renamed")),A(!1)},K=()=>{const{nodes:re}=ke.getState();if(re.filter(j=>j.selected||j.id===l).length===0){Ze.error("Select at least one component to create a group");return}I(!0)},ie=re=>{d(re),Ze.success(`Group "${re}" created`),I(!1)},Z=()=>{h(),Ze.success("Groups created automatically from connections")};return y.jsxs(y.Fragment,{children:[y.jsx(Mp,{open:L,onConfirm:ie,onCancel:()=>I(!1)}),y.jsxs("div",{className:"h-14 bg-toolbar-bg border-b border-border flex items-center justify-between px-4",children:[y.jsxs("div",{className:"flex items-center gap-2",children:[y.jsxs("button",{onClick:()=>A(!0),className:"text-lg font-semibold text-foreground hover:text-primary transition-colors cursor-pointer",title:"Click to rename diagram",children:[y.jsx("span",{className:"text-primary",children:"Archi"}),"Phoenix",y.jsxs("span",{className:"text-xs text-secondary-foreground ml-2",children:[" ",t]})]}),y.jsx(vs,{orientation:"vertical",className:"h-6 mx-2"}),y.jsxs("div",{className:"flex items-center gap-1",children:[y.jsx(De,{variant:"ghost",size:"icon",className:"h-9 w-9",onClick:a,disabled:!x,title:"Undo (Ctrl/Cmd+Z)",children:y.jsx(cP,{className:"h-4 w-4"})}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-9 w-9",onClick:o,disabled:!S,title:"Redo (Ctrl/Cmd+Shift+Z or Ctrl/Cmd+Y)",children:y.jsx(HD,{className:"h-4 w-4"})})]}),y.jsx(vs,{orientation:"vertical",className:"h-6 mx-2"}),y.jsx(FP,{})]}),y.jsxs("div",{className:"flex items-center gap-2",children:[y.jsxs("div",{className:"flex items-center gap-1 bg-secondary/50 rounded-md p-1",children:[y.jsx(De,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:de,title:"Zoom In",children:y.jsx(pP,{className:"h-4 w-4"})}),y.jsxs("span",{className:"text-sm font-mono px-2 min-w-[60px] text-center",children:[Math.round(c*100),"%"]}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:z,title:"Zoom Out",children:y.jsx(mP,{className:"h-4 w-4"})}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:$,title:"Fit to View",children:y.jsx(AD,{className:"h-4 w-4"})})]}),y.jsx(vs,{orientation:"vertical",className:"h-6"}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-9 w-9",onClick:q,title:"Save diagram to browser storage (auto-saves on changes)",children:y.jsx(GD,{className:"h-4 w-4"})}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-9 w-9",onClick:ee,title:"Export diagram as JSON file",children:y.jsx(pD,{className:"h-4 w-4"})}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-9 w-9",onClick:me,title:"Import diagram from JSON file",children:y.jsx(uP,{className:"h-4 w-4"})}),y.jsx(vs,{orientation:"vertical",className:"h-6"}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-9 w-9",title:"Create group from selection",onClick:K,disabled:!l,children:y.jsx(jb,{className:"h-4 w-4"})}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-9 w-9",title:"Auto-group by connections",onClick:Z,children:y.jsx(ZD,{className:"h-4 w-4"})}),y.jsx(vs,{orientation:"vertical",className:"h-6"}),y.jsx(yP,{}),y.jsx(De,{variant:U?"default":"ghost",size:"icon",className:"h-9 w-9",title:U?"Hide minimap":"Show minimap",onClick:Q,children:y.jsx(ED,{className:"h-4 w-4"})}),y.jsx(De,{variant:se?"default":"ghost",size:"icon",className:"h-9 w-9",title:se?"Hide heat map legend":"Show heat map legend",onClick:F,children:y.jsx(wa,{className:"h-4 w-4"})}),y.jsx(De,{variant:Y?"default":"ghost",size:"icon",className:"h-9 w-9",title:Y?"Hide ruler":"Show ruler",onClick:ae,children:y.jsx(QD,{className:"h-4 w-4"})}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-9 w-9",title:"Settings",children:y.jsx(XD,{className:"h-4 w-4"})})]})]}),y.jsx("input",{ref:T,type:"file",accept:".json",onChange:N,className:"hidden","aria-label":"Import diagram from file"}),y.jsx(XM,{open:E,onOpenChange:A,children:y.jsxs(pp,{children:[y.jsx(gp,{children:"Rename Diagram"}),y.jsx(mp,{children:"Enter a new name for your diagram"}),y.jsx("div",{className:"py-4",children:y.jsx(ct,{value:k,onChange:re=>D(re.target.value),placeholder:"Diagram name",onKeyDown:re=>{re.key==="Enter"&&J()},autoFocus:!0})}),y.jsxs("div",{className:"flex gap-2 justify-end",children:[y.jsx(vp,{children:"Cancel"}),y.jsx(yp,{onClick:J,children:"Save"})]})]})})]})}function kv(c){const e=$_(c),t=R.forwardRef((s,n)=>{const{children:i,...a}=s,o=R.Children.toArray(i),l=o.find(U_);if(l){const d=l.props.children,h=o.map(p=>p===l?R.Children.count(d)>1?R.Children.only(null):R.isValidElement(d)?d.props.children:null:p);return y.jsx(e,{...a,ref:n,children:R.isValidElement(d)?R.cloneElement(d,void 0,h):null})}return y.jsx(e,{...a,ref:n,children:i})});return t.displayName=`${c}.Slot`,t}function $_(c){const e=R.forwardRef((t,s)=>{const{children:n,...i}=t;if(R.isValidElement(n)){const a=Q_(n),o=F_(i,n.props);return n.type!==R.Fragment&&(o.ref=s?An(s,a):a),R.cloneElement(n,o)}return R.Children.count(n)>1?R.Children.only(null):null});return e.displayName=`${c}.SlotClone`,e}var B_=Symbol("radix.slottable");function U_(c){return R.isValidElement(c)&&typeof c.type=="function"&&"__radixId"in c.type&&c.type.__radixId===B_}function F_(c,e){const t={...e};for(const s in e){const n=c[s],i=e[s];/^on[A-Z]/.test(s)?n&&i?t[s]=(...o)=>{const l=i(...o);return n(...o),l}:n&&(t[s]=n):s==="style"?t[s]={...n,...i}:s==="className"&&(t[s]=[n,i].filter(Boolean).join(" "))}return{...c,...t}}function Q_(c){let e=Object.getOwnPropertyDescriptor(c.props,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning;return t?c.ref:(e=Object.getOwnPropertyDescriptor(c,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning,t?c.props.ref:c.props.ref||c.ref)}function gu(c){const e=c+"CollectionProvider",[t,s]=ws(e),[n,i]=t(e,{collectionRef:{current:null},itemMap:new Map}),a=M=>{const{scope:x,children:S}=M,T=Dt.useRef(null),E=Dt.useRef(new Map).current;return y.jsx(n,{scope:x,itemMap:E,collectionRef:T,children:S})};a.displayName=e;const o=c+"CollectionSlot",l=kv(o),d=Dt.forwardRef((M,x)=>{const{scope:S,children:T}=M,E=i(o,S),A=Ne(x,E.collectionRef);return y.jsx(l,{ref:A,children:T})});d.displayName=o;const h=c+"CollectionItemSlot",p="data-radix-collection-item",g=kv(h),v=Dt.forwardRef((M,x)=>{const{scope:S,children:T,...E}=M,A=Dt.useRef(null),k=Ne(x,A),D=i(h,S);return Dt.useEffect(()=>(D.itemMap.set(A,{ref:A,...E}),()=>void D.itemMap.delete(A))),y.jsx(g,{[p]:"",ref:k,children:T})});v.displayName=h;function b(M){const x=i(c+"CollectionConsumer",M);return Dt.useCallback(()=>{const T=x.collectionRef.current;if(!T)return[];const E=Array.from(T.querySelectorAll(`[${p}]`));return Array.from(x.itemMap.values()).sort((D,L)=>E.indexOf(D.ref.current)-E.indexOf(L.ref.current))},[x.collectionRef,x.itemMap])}return[{Provider:a,Slot:d,ItemSlot:v},b,s]}var gf="rovingFocusGroup.onEntryFocus",V_={bubbles:!1,cancelable:!0},Zr="RovingFocusGroup",[Ef,iw,G_]=gu(Zr),[W_,mu]=ws(Zr,[G_]),[K_,Y_]=W_(Zr),aw=R.forwardRef((c,e)=>y.jsx(Ef.Provider,{scope:c.__scopeRovingFocusGroup,children:y.jsx(Ef.Slot,{scope:c.__scopeRovingFocusGroup,children:y.jsx(X_,{...c,ref:e})})}));aw.displayName=Zr;var X_=R.forwardRef((c,e)=>{const{__scopeRovingFocusGroup:t,orientation:s,loop:n=!1,dir:i,currentTabStopId:a,defaultCurrentTabStopId:o,onCurrentTabStopIdChange:l,onEntryFocus:d,preventScrollOnEntryFocus:h=!1,...p}=c,g=R.useRef(null),v=Ne(e,g),b=Lo(i),[M,x]=En({prop:a,defaultProp:o??null,onChange:l,caller:Zr}),[S,T]=R.useState(!1),E=is(d),A=iw(t),k=R.useRef(!1),[D,L]=R.useState(0);return R.useEffect(()=>{const I=g.current;if(I)return I.addEventListener(gf,E),()=>I.removeEventListener(gf,E)},[E]),y.jsx(K_,{scope:t,orientation:s,dir:b,loop:n,currentTabStopId:M,onItemFocus:R.useCallback(I=>x(I),[x]),onItemShiftTab:R.useCallback(()=>T(!0),[]),onFocusableItemAdd:R.useCallback(()=>L(I=>I+1),[]),onFocusableItemRemove:R.useCallback(()=>L(I=>I-1),[]),children:y.jsx(Le.div,{tabIndex:S||D===0?-1:0,"data-orientation":s,...p,ref:v,style:{outline:"none",...c.style},onMouseDown:be(c.onMouseDown,()=>{k.current=!0}),onFocus:be(c.onFocus,I=>{const U=!k.current;if(I.target===I.currentTarget&&U&&!S){const Q=new CustomEvent(gf,V_);if(I.currentTarget.dispatchEvent(Q),!Q.defaultPrevented){const se=A().filter(z=>z.focusable),F=se.find(z=>z.active),Y=se.find(z=>z.id===M),de=[F,Y,...se].filter(Boolean).map(z=>z.ref.current);cw(de,h)}}k.current=!1}),onBlur:be(c.onBlur,()=>T(!1))})})}),ow="RovingFocusGroupItem",rw=R.forwardRef((c,e)=>{const{__scopeRovingFocusGroup:t,focusable:s=!0,active:n=!1,tabStopId:i,children:a,...o}=c,l=ln(),d=i||l,h=Y_(ow,t),p=h.currentTabStopId===d,g=iw(t),{onFocusableItemAdd:v,onFocusableItemRemove:b,currentTabStopId:M}=h;return R.useEffect(()=>{if(s)return v(),()=>b()},[s,v,b]),y.jsx(Ef.ItemSlot,{scope:t,id:d,focusable:s,active:n,children:y.jsx(Le.span,{tabIndex:p?0:-1,"data-orientation":h.orientation,...o,ref:e,onMouseDown:be(c.onMouseDown,x=>{s?h.onItemFocus(d):x.preventDefault()}),onFocus:be(c.onFocus,()=>h.onItemFocus(d)),onKeyDown:be(c.onKeyDown,x=>{if(x.key==="Tab"&&x.shiftKey){h.onItemShiftTab();return}if(x.target!==x.currentTarget)return;const S=eI(x,h.orientation,h.dir);if(S!==void 0){if(x.metaKey||x.ctrlKey||x.altKey||x.shiftKey)return;x.preventDefault();let E=g().filter(A=>A.focusable).map(A=>A.ref.current);if(S==="last")E.reverse();else if(S==="prev"||S==="next"){S==="prev"&&E.reverse();const A=E.indexOf(x.currentTarget);E=h.loop?tI(E,A+1):E.slice(A+1)}setTimeout(()=>cw(E))}}),children:typeof a=="function"?a({isCurrentTabStop:p,hasTabStop:M!=null}):a})})});rw.displayName=ow;var J_={ArrowLeft:"prev",ArrowUp:"prev",ArrowRight:"next",ArrowDown:"next",PageUp:"first",Home:"first",PageDown:"last",End:"last"};function Z_(c,e){return e!=="rtl"?c:c==="ArrowLeft"?"ArrowRight":c==="ArrowRight"?"ArrowLeft":c}function eI(c,e,t){const s=Z_(c.key,t);if(!(e==="vertical"&&["ArrowLeft","ArrowRight"].includes(s))&&!(e==="horizontal"&&["ArrowUp","ArrowDown"].includes(s)))return J_[s]}function cw(c,e=!1){const t=document.activeElement;for(const s of c)if(s===t||(s.focus({preventScroll:e}),document.activeElement!==t))return}function tI(c,e){return c.map((t,s)=>c[(e+s)%c.length])}var lw=aw,uw=rw,yu="Tabs",[sI]=ws(yu,[mu]),dw=mu(),[nI,wp]=sI(yu),hw=R.forwardRef((c,e)=>{const{__scopeTabs:t,value:s,onValueChange:n,defaultValue:i,orientation:a="horizontal",dir:o,activationMode:l="automatic",...d}=c,h=Lo(o),[p,g]=En({prop:s,onChange:n,defaultProp:i??"",caller:yu});return y.jsx(nI,{scope:t,baseId:ln(),value:p,onValueChange:g,orientation:a,dir:h,activationMode:l,children:y.jsx(Le.div,{dir:h,"data-orientation":a,...d,ref:e})})});hw.displayName=yu;var fw="TabsList",pw=R.forwardRef((c,e)=>{const{__scopeTabs:t,loop:s=!0,...n}=c,i=wp(fw,t),a=dw(t);return y.jsx(lw,{asChild:!0,...a,orientation:i.orientation,dir:i.dir,loop:s,children:y.jsx(Le.div,{role:"tablist","aria-orientation":i.orientation,...n,ref:e})})});pw.displayName=fw;var gw="TabsTrigger",mw=R.forwardRef((c,e)=>{const{__scopeTabs:t,value:s,disabled:n=!1,...i}=c,a=wp(gw,t),o=dw(t),l=bw(a.baseId,s),d=Mw(a.baseId,s),h=s===a.value;return y.jsx(uw,{asChild:!0,...o,focusable:!n,active:h,children:y.jsx(Le.button,{type:"button",role:"tab","aria-selected":h,"aria-controls":d,"data-state":h?"active":"inactive","data-disabled":n?"":void 0,disabled:n,id:l,...i,ref:e,onMouseDown:be(c.onMouseDown,p=>{!n&&p.button===0&&p.ctrlKey===!1?a.onValueChange(s):p.preventDefault()}),onKeyDown:be(c.onKeyDown,p=>{[" ","Enter"].includes(p.key)&&a.onValueChange(s)}),onFocus:be(c.onFocus,()=>{const p=a.activationMode!=="manual";!h&&!n&&p&&a.onValueChange(s)})})})});mw.displayName=gw;var yw="TabsContent",vw=R.forwardRef((c,e)=>{const{__scopeTabs:t,value:s,forceMount:n,children:i,...a}=c,o=wp(yw,t),l=bw(o.baseId,s),d=Mw(o.baseId,s),h=s===o.value,p=R.useRef(h);return R.useEffect(()=>{const g=requestAnimationFrame(()=>p.current=!1);return()=>cancelAnimationFrame(g)},[]),y.jsx(cs,{present:n||h,children:({present:g})=>y.jsx(Le.div,{"data-state":h?"active":"inactive","data-orientation":o.orientation,role:"tabpanel","aria-labelledby":l,hidden:!g,id:d,tabIndex:0,...a,ref:e,style:{...c.style,animationDuration:p.current?"0s":void 0},children:g&&i})})});vw.displayName=yw;function bw(c,e){return`${c}-trigger-${e}`}function Mw(c,e){return`${c}-content-${e}`}var iI=hw,ww=pw,Sw=mw,xw=vw;const Sp=iI,vu=R.forwardRef(({className:c,...e},t)=>y.jsx(ww,{ref:t,className:Ae("inline-flex items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground","flex-wrap gap-1",c),...e}));vu.displayName=ww.displayName;const nn=R.forwardRef(({className:c,...e},t)=>y.jsx(Sw,{ref:t,className:Ae("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",c),...e}));nn.displayName=Sw.displayName;const si=R.forwardRef(({className:c,...e},t)=>y.jsx(xw,{ref:t,className:Ae("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",c),...e}));si.displayName=xw.displayName;const aI=["top","right","bottom","left"],Hi=Math.min,Ps=Math.max,Vl=Math.round,Tl=Math.floor,xn=c=>({x:c,y:c}),oI={left:"right",right:"left",bottom:"top",top:"bottom"},rI={start:"end",end:"start"};function kf(c,e,t){return Ps(c,Hi(e,t))}function oi(c,e){return typeof c=="function"?c(e):c}function ri(c){return c.split("-")[0]}function _o(c){return c.split("-")[1]}function xp(c){return c==="x"?"y":"x"}function Cp(c){return c==="y"?"height":"width"}const cI=new Set(["top","bottom"]);function Sn(c){return cI.has(ri(c))?"y":"x"}function Rp(c){return xp(Sn(c))}function lI(c,e,t){t===void 0&&(t=!1);const s=_o(c),n=Rp(c),i=Cp(n);let a=n==="x"?s===(t?"end":"start")?"right":"left":s==="start"?"bottom":"top";return e.reference[i]>e.floating[i]&&(a=Gl(a)),[a,Gl(a)]}function uI(c){const e=Gl(c);return[Af(c),e,Af(e)]}function Af(c){return c.replace(/start|end/g,e=>rI[e])}const Av=["left","right"],Dv=["right","left"],dI=["top","bottom"],hI=["bottom","top"];function fI(c,e,t){switch(c){case"top":case"bottom":return t?e?Dv:Av:e?Av:Dv;case"left":case"right":return e?dI:hI;default:return[]}}function pI(c,e,t,s){const n=_o(c);let i=fI(ri(c),t==="start",s);return n&&(i=i.map(a=>a+"-"+n),e&&(i=i.concat(i.map(Af)))),i}function Gl(c){return c.replace(/left|right|bottom|top/g,e=>oI[e])}function gI(c){return{top:0,right:0,bottom:0,left:0,...c}}function Cw(c){return typeof c!="number"?gI(c):{top:c,right:c,bottom:c,left:c}}function Wl(c){const{x:e,y:t,width:s,height:n}=c;return{width:s,height:n,top:t,left:e,right:e+s,bottom:t+n,x:e,y:t}}function Pv(c,e,t){let{reference:s,floating:n}=c;const i=Sn(e),a=Rp(e),o=Cp(a),l=ri(e),d=i==="y",h=s.x+s.width/2-n.width/2,p=s.y+s.height/2-n.height/2,g=s[o]/2-n[o]/2;let v;switch(l){case"top":v={x:h,y:s.y-n.height};break;case"bottom":v={x:h,y:s.y+s.height};break;case"right":v={x:s.x+s.width,y:p};break;case"left":v={x:s.x-n.width,y:p};break;default:v={x:s.x,y:s.y}}switch(_o(e)){case"start":v[a]-=g*(t&&d?-1:1);break;case"end":v[a]+=g*(t&&d?-1:1);break}return v}const mI=async(c,e,t)=>{const{placement:s="bottom",strategy:n="absolute",middleware:i=[],platform:a}=t,o=i.filter(Boolean),l=await(a.isRTL==null?void 0:a.isRTL(e));let d=await a.getElementRects({reference:c,floating:e,strategy:n}),{x:h,y:p}=Pv(d,s,l),g=s,v={},b=0;for(let M=0;M<o.length;M++){const{name:x,fn:S}=o[M],{x:T,y:E,data:A,reset:k}=await S({x:h,y:p,initialPlacement:s,placement:g,strategy:n,middlewareData:v,rects:d,platform:a,elements:{reference:c,floating:e}});h=T??h,p=E??p,v={...v,[x]:{...v[x],...A}},k&&b<=50&&(b++,typeof k=="object"&&(k.placement&&(g=k.placement),k.rects&&(d=k.rects===!0?await a.getElementRects({reference:c,floating:e,strategy:n}):k.rects),{x:h,y:p}=Pv(d,g,l)),M=-1)}return{x:h,y:p,placement:g,strategy:n,middlewareData:v}};async function $r(c,e){var t;e===void 0&&(e={});const{x:s,y:n,platform:i,rects:a,elements:o,strategy:l}=c,{boundary:d="clippingAncestors",rootBoundary:h="viewport",elementContext:p="floating",altBoundary:g=!1,padding:v=0}=oi(e,c),b=Cw(v),x=o[g?p==="floating"?"reference":"floating":p],S=Wl(await i.getClippingRect({element:(t=await(i.isElement==null?void 0:i.isElement(x)))==null||t?x:x.contextElement||await(i.getDocumentElement==null?void 0:i.getDocumentElement(o.floating)),boundary:d,rootBoundary:h,strategy:l})),T=p==="floating"?{x:s,y:n,width:a.floating.width,height:a.floating.height}:a.reference,E=await(i.getOffsetParent==null?void 0:i.getOffsetParent(o.floating)),A=await(i.isElement==null?void 0:i.isElement(E))?await(i.getScale==null?void 0:i.getScale(E))||{x:1,y:1}:{x:1,y:1},k=Wl(i.convertOffsetParentRelativeRectToViewportRelativeRect?await i.convertOffsetParentRelativeRectToViewportRelativeRect({elements:o,rect:T,offsetParent:E,strategy:l}):T);return{top:(S.top-k.top+b.top)/A.y,bottom:(k.bottom-S.bottom+b.bottom)/A.y,left:(S.left-k.left+b.left)/A.x,right:(k.right-S.right+b.right)/A.x}}const yI=c=>({name:"arrow",options:c,async fn(e){const{x:t,y:s,placement:n,rects:i,platform:a,elements:o,middlewareData:l}=e,{element:d,padding:h=0}=oi(c,e)||{};if(d==null)return{};const p=Cw(h),g={x:t,y:s},v=Rp(n),b=Cp(v),M=await a.getDimensions(d),x=v==="y",S=x?"top":"left",T=x?"bottom":"right",E=x?"clientHeight":"clientWidth",A=i.reference[b]+i.reference[v]-g[v]-i.floating[b],k=g[v]-i.reference[v],D=await(a.getOffsetParent==null?void 0:a.getOffsetParent(d));let L=D?D[E]:0;(!L||!await(a.isElement==null?void 0:a.isElement(D)))&&(L=o.floating[E]||i.floating[b]);const I=A/2-k/2,U=L/2-M[b]/2-1,Q=Hi(p[S],U),se=Hi(p[T],U),F=Q,Y=L-M[b]-se,ae=L/2-M[b]/2+I,de=kf(F,ae,Y),z=!l.arrow&&_o(n)!=null&&ae!==de&&i.reference[b]/2-(ae<F?Q:se)-M[b]/2<0,$=z?ae<F?ae-F:ae-Y:0;return{[v]:g[v]+$,data:{[v]:de,centerOffset:ae-de-$,...z&&{alignmentOffset:$}},reset:z}}}),vI=function(c){return c===void 0&&(c={}),{name:"flip",options:c,async fn(e){var t,s;const{placement:n,middlewareData:i,rects:a,initialPlacement:o,platform:l,elements:d}=e,{mainAxis:h=!0,crossAxis:p=!0,fallbackPlacements:g,fallbackStrategy:v="bestFit",fallbackAxisSideDirection:b="none",flipAlignment:M=!0,...x}=oi(c,e);if((t=i.arrow)!=null&&t.alignmentOffset)return{};const S=ri(n),T=Sn(o),E=ri(o)===o,A=await(l.isRTL==null?void 0:l.isRTL(d.floating)),k=g||(E||!M?[Gl(o)]:uI(o)),D=b!=="none";!g&&D&&k.push(...pI(o,M,b,A));const L=[o,...k],I=await $r(e,x),U=[];let Q=((s=i.flip)==null?void 0:s.overflows)||[];if(h&&U.push(I[S]),p){const ae=lI(n,a,A);U.push(I[ae[0]],I[ae[1]])}if(Q=[...Q,{placement:n,overflows:U}],!U.every(ae=>ae<=0)){var se,F;const ae=(((se=i.flip)==null?void 0:se.index)||0)+1,de=L[ae];if(de&&(!(p==="alignment"?T!==Sn(de):!1)||Q.every(q=>Sn(q.placement)===T?q.overflows[0]>0:!0)))return{data:{index:ae,overflows:Q},reset:{placement:de}};let z=(F=Q.filter($=>$.overflows[0]<=0).sort(($,q)=>$.overflows[1]-q.overflows[1])[0])==null?void 0:F.placement;if(!z)switch(v){case"bestFit":{var Y;const $=(Y=Q.filter(q=>{if(D){const ee=Sn(q.placement);return ee===T||ee==="y"}return!0}).map(q=>[q.placement,q.overflows.filter(ee=>ee>0).reduce((ee,me)=>ee+me,0)]).sort((q,ee)=>q[1]-ee[1])[0])==null?void 0:Y[0];$&&(z=$);break}case"initialPlacement":z=o;break}if(n!==z)return{reset:{placement:z}}}return{}}}};function Lv(c,e){return{top:c.top-e.height,right:c.right-e.width,bottom:c.bottom-e.height,left:c.left-e.width}}function _v(c){return aI.some(e=>c[e]>=0)}const bI=function(c){return c===void 0&&(c={}),{name:"hide",options:c,async fn(e){const{rects:t}=e,{strategy:s="referenceHidden",...n}=oi(c,e);switch(s){case"referenceHidden":{const i=await $r(e,{...n,elementContext:"reference"}),a=Lv(i,t.reference);return{data:{referenceHiddenOffsets:a,referenceHidden:_v(a)}}}case"escaped":{const i=await $r(e,{...n,altBoundary:!0}),a=Lv(i,t.floating);return{data:{escapedOffsets:a,escaped:_v(a)}}}default:return{}}}}},Rw=new Set(["left","top"]);async function MI(c,e){const{placement:t,platform:s,elements:n}=c,i=await(s.isRTL==null?void 0:s.isRTL(n.floating)),a=ri(t),o=_o(t),l=Sn(t)==="y",d=Rw.has(a)?-1:1,h=i&&l?-1:1,p=oi(e,c);let{mainAxis:g,crossAxis:v,alignmentAxis:b}=typeof p=="number"?{mainAxis:p,crossAxis:0,alignmentAxis:null}:{mainAxis:p.mainAxis||0,crossAxis:p.crossAxis||0,alignmentAxis:p.alignmentAxis};return o&&typeof b=="number"&&(v=o==="end"?b*-1:b),l?{x:v*h,y:g*d}:{x:g*d,y:v*h}}const wI=function(c){return c===void 0&&(c=0),{name:"offset",options:c,async fn(e){var t,s;const{x:n,y:i,placement:a,middlewareData:o}=e,l=await MI(e,c);return a===((t=o.offset)==null?void 0:t.placement)&&(s=o.arrow)!=null&&s.alignmentOffset?{}:{x:n+l.x,y:i+l.y,data:{...l,placement:a}}}}},SI=function(c){return c===void 0&&(c={}),{name:"shift",options:c,async fn(e){const{x:t,y:s,placement:n}=e,{mainAxis:i=!0,crossAxis:a=!1,limiter:o={fn:x=>{let{x:S,y:T}=x;return{x:S,y:T}}},...l}=oi(c,e),d={x:t,y:s},h=await $r(e,l),p=Sn(ri(n)),g=xp(p);let v=d[g],b=d[p];if(i){const x=g==="y"?"top":"left",S=g==="y"?"bottom":"right",T=v+h[x],E=v-h[S];v=kf(T,v,E)}if(a){const x=p==="y"?"top":"left",S=p==="y"?"bottom":"right",T=b+h[x],E=b-h[S];b=kf(T,b,E)}const M=o.fn({...e,[g]:v,[p]:b});return{...M,data:{x:M.x-t,y:M.y-s,enabled:{[g]:i,[p]:a}}}}}},xI=function(c){return c===void 0&&(c={}),{options:c,fn(e){const{x:t,y:s,placement:n,rects:i,middlewareData:a}=e,{offset:o=0,mainAxis:l=!0,crossAxis:d=!0}=oi(c,e),h={x:t,y:s},p=Sn(n),g=xp(p);let v=h[g],b=h[p];const M=oi(o,e),x=typeof M=="number"?{mainAxis:M,crossAxis:0}:{mainAxis:0,crossAxis:0,...M};if(l){const E=g==="y"?"height":"width",A=i.reference[g]-i.floating[E]+x.mainAxis,k=i.reference[g]+i.reference[E]-x.mainAxis;v<A?v=A:v>k&&(v=k)}if(d){var S,T;const E=g==="y"?"width":"height",A=Rw.has(ri(n)),k=i.reference[p]-i.floating[E]+(A&&((S=a.offset)==null?void 0:S[p])||0)+(A?0:x.crossAxis),D=i.reference[p]+i.reference[E]+(A?0:((T=a.offset)==null?void 0:T[p])||0)-(A?x.crossAxis:0);b<k?b=k:b>D&&(b=D)}return{[g]:v,[p]:b}}}},CI=function(c){return c===void 0&&(c={}),{name:"size",options:c,async fn(e){var t,s;const{placement:n,rects:i,platform:a,elements:o}=e,{apply:l=()=>{},...d}=oi(c,e),h=await $r(e,d),p=ri(n),g=_o(n),v=Sn(n)==="y",{width:b,height:M}=i.floating;let x,S;p==="top"||p==="bottom"?(x=p,S=g===(await(a.isRTL==null?void 0:a.isRTL(o.floating))?"start":"end")?"left":"right"):(S=p,x=g==="end"?"top":"bottom");const T=M-h.top-h.bottom,E=b-h.left-h.right,A=Hi(M-h[x],T),k=Hi(b-h[S],E),D=!e.middlewareData.shift;let L=A,I=k;if((t=e.middlewareData.shift)!=null&&t.enabled.x&&(I=E),(s=e.middlewareData.shift)!=null&&s.enabled.y&&(L=T),D&&!g){const Q=Ps(h.left,0),se=Ps(h.right,0),F=Ps(h.top,0),Y=Ps(h.bottom,0);v?I=b-2*(Q!==0||se!==0?Q+se:Ps(h.left,h.right)):L=M-2*(F!==0||Y!==0?F+Y:Ps(h.top,h.bottom))}await l({...e,availableWidth:I,availableHeight:L});const U=await a.getDimensions(o.floating);return b!==U.width||M!==U.height?{reset:{rects:!0}}:{}}}};function bu(){return typeof window<"u"}function Io(c){return Tw(c)?(c.nodeName||"").toLowerCase():"#document"}function Ls(c){var e;return(c==null||(e=c.ownerDocument)==null?void 0:e.defaultView)||window}function Pn(c){var e;return(e=(Tw(c)?c.ownerDocument:c.document)||window.document)==null?void 0:e.documentElement}function Tw(c){return bu()?c instanceof Node||c instanceof Ls(c).Node:!1}function un(c){return bu()?c instanceof Element||c instanceof Ls(c).Element:!1}function kn(c){return bu()?c instanceof HTMLElement||c instanceof Ls(c).HTMLElement:!1}function Iv(c){return!bu()||typeof ShadowRoot>"u"?!1:c instanceof ShadowRoot||c instanceof Ls(c).ShadowRoot}const RI=new Set(["inline","contents"]);function ec(c){const{overflow:e,overflowX:t,overflowY:s,display:n}=dn(c);return/auto|scroll|overlay|hidden|clip/.test(e+s+t)&&!RI.has(n)}const TI=new Set(["table","td","th"]);function EI(c){return TI.has(Io(c))}const kI=[":popover-open",":modal"];function Mu(c){return kI.some(e=>{try{return c.matches(e)}catch{return!1}})}const AI=["transform","translate","scale","rotate","perspective"],DI=["transform","translate","scale","rotate","perspective","filter"],PI=["paint","layout","strict","content"];function Tp(c){const e=Ep(),t=un(c)?dn(c):c;return AI.some(s=>t[s]?t[s]!=="none":!1)||(t.containerType?t.containerType!=="normal":!1)||!e&&(t.backdropFilter?t.backdropFilter!=="none":!1)||!e&&(t.filter?t.filter!=="none":!1)||DI.some(s=>(t.willChange||"").includes(s))||PI.some(s=>(t.contain||"").includes(s))}function LI(c){let e=$i(c);for(;kn(e)&&!Eo(e);){if(Tp(e))return e;if(Mu(e))return null;e=$i(e)}return null}function Ep(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}const _I=new Set(["html","body","#document"]);function Eo(c){return _I.has(Io(c))}function dn(c){return Ls(c).getComputedStyle(c)}function wu(c){return un(c)?{scrollLeft:c.scrollLeft,scrollTop:c.scrollTop}:{scrollLeft:c.scrollX,scrollTop:c.scrollY}}function $i(c){if(Io(c)==="html")return c;const e=c.assignedSlot||c.parentNode||Iv(c)&&c.host||Pn(c);return Iv(e)?e.host:e}function Ew(c){const e=$i(c);return Eo(e)?c.ownerDocument?c.ownerDocument.body:c.body:kn(e)&&ec(e)?e:Ew(e)}function Br(c,e,t){var s;e===void 0&&(e=[]),t===void 0&&(t=!0);const n=Ew(c),i=n===((s=c.ownerDocument)==null?void 0:s.body),a=Ls(n);if(i){const o=Df(a);return e.concat(a,a.visualViewport||[],ec(n)?n:[],o&&t?Br(o):[])}return e.concat(n,Br(n,[],t))}function Df(c){return c.parent&&Object.getPrototypeOf(c.parent)?c.frameElement:null}function kw(c){const e=dn(c);let t=parseFloat(e.width)||0,s=parseFloat(e.height)||0;const n=kn(c),i=n?c.offsetWidth:t,a=n?c.offsetHeight:s,o=Vl(t)!==i||Vl(s)!==a;return o&&(t=i,s=a),{width:t,height:s,$:o}}function kp(c){return un(c)?c:c.contextElement}function Ro(c){const e=kp(c);if(!kn(e))return xn(1);const t=e.getBoundingClientRect(),{width:s,height:n,$:i}=kw(e);let a=(i?Vl(t.width):t.width)/s,o=(i?Vl(t.height):t.height)/n;return(!a||!Number.isFinite(a))&&(a=1),(!o||!Number.isFinite(o))&&(o=1),{x:a,y:o}}const II=xn(0);function Aw(c){const e=Ls(c);return!Ep()||!e.visualViewport?II:{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}}function NI(c,e,t){return e===void 0&&(e=!1),!t||e&&t!==Ls(c)?!1:e}function Ca(c,e,t,s){e===void 0&&(e=!1),t===void 0&&(t=!1);const n=c.getBoundingClientRect(),i=kp(c);let a=xn(1);e&&(s?un(s)&&(a=Ro(s)):a=Ro(c));const o=NI(i,t,s)?Aw(i):xn(0);let l=(n.left+o.x)/a.x,d=(n.top+o.y)/a.y,h=n.width/a.x,p=n.height/a.y;if(i){const g=Ls(i),v=s&&un(s)?Ls(s):s;let b=g,M=Df(b);for(;M&&s&&v!==b;){const x=Ro(M),S=M.getBoundingClientRect(),T=dn(M),E=S.left+(M.clientLeft+parseFloat(T.paddingLeft))*x.x,A=S.top+(M.clientTop+parseFloat(T.paddingTop))*x.y;l*=x.x,d*=x.y,h*=x.x,p*=x.y,l+=E,d+=A,b=Ls(M),M=Df(b)}}return Wl({width:h,height:p,x:l,y:d})}function Su(c,e){const t=wu(c).scrollLeft;return e?e.left+t:Ca(Pn(c)).left+t}function Dw(c,e){const t=c.getBoundingClientRect(),s=t.left+e.scrollLeft-Su(c,t),n=t.top+e.scrollTop;return{x:s,y:n}}function zI(c){let{elements:e,rect:t,offsetParent:s,strategy:n}=c;const i=n==="fixed",a=Pn(s),o=e?Mu(e.floating):!1;if(s===a||o&&i)return t;let l={scrollLeft:0,scrollTop:0},d=xn(1);const h=xn(0),p=kn(s);if((p||!p&&!i)&&((Io(s)!=="body"||ec(a))&&(l=wu(s)),kn(s))){const v=Ca(s);d=Ro(s),h.x=v.x+s.clientLeft,h.y=v.y+s.clientTop}const g=a&&!p&&!i?Dw(a,l):xn(0);return{width:t.width*d.x,height:t.height*d.y,x:t.x*d.x-l.scrollLeft*d.x+h.x+g.x,y:t.y*d.y-l.scrollTop*d.y+h.y+g.y}}function jI(c){return Array.from(c.getClientRects())}function OI(c){const e=Pn(c),t=wu(c),s=c.ownerDocument.body,n=Ps(e.scrollWidth,e.clientWidth,s.scrollWidth,s.clientWidth),i=Ps(e.scrollHeight,e.clientHeight,s.scrollHeight,s.clientHeight);let a=-t.scrollLeft+Su(c);const o=-t.scrollTop;return dn(s).direction==="rtl"&&(a+=Ps(e.clientWidth,s.clientWidth)-n),{width:n,height:i,x:a,y:o}}const Nv=25;function qI(c,e){const t=Ls(c),s=Pn(c),n=t.visualViewport;let i=s.clientWidth,a=s.clientHeight,o=0,l=0;if(n){i=n.width,a=n.height;const h=Ep();(!h||h&&e==="fixed")&&(o=n.offsetLeft,l=n.offsetTop)}const d=Su(s);if(d<=0){const h=s.ownerDocument,p=h.body,g=getComputedStyle(p),v=h.compatMode==="CSS1Compat"&&parseFloat(g.marginLeft)+parseFloat(g.marginRight)||0,b=Math.abs(s.clientWidth-p.clientWidth-v);b<=Nv&&(i-=b)}else d<=Nv&&(i+=d);return{width:i,height:a,x:o,y:l}}const HI=new Set(["absolute","fixed"]);function $I(c,e){const t=Ca(c,!0,e==="fixed"),s=t.top+c.clientTop,n=t.left+c.clientLeft,i=kn(c)?Ro(c):xn(1),a=c.clientWidth*i.x,o=c.clientHeight*i.y,l=n*i.x,d=s*i.y;return{width:a,height:o,x:l,y:d}}function zv(c,e,t){let s;if(e==="viewport")s=qI(c,t);else if(e==="document")s=OI(Pn(c));else if(un(e))s=$I(e,t);else{const n=Aw(c);s={x:e.x-n.x,y:e.y-n.y,width:e.width,height:e.height}}return Wl(s)}function Pw(c,e){const t=$i(c);return t===e||!un(t)||Eo(t)?!1:dn(t).position==="fixed"||Pw(t,e)}function BI(c,e){const t=e.get(c);if(t)return t;let s=Br(c,[],!1).filter(o=>un(o)&&Io(o)!=="body"),n=null;const i=dn(c).position==="fixed";let a=i?$i(c):c;for(;un(a)&&!Eo(a);){const o=dn(a),l=Tp(a);!l&&o.position==="fixed"&&(n=null),(i?!l&&!n:!l&&o.position==="static"&&!!n&&HI.has(n.position)||ec(a)&&!l&&Pw(c,a))?s=s.filter(h=>h!==a):n=o,a=$i(a)}return e.set(c,s),s}function UI(c){let{element:e,boundary:t,rootBoundary:s,strategy:n}=c;const a=[...t==="clippingAncestors"?Mu(e)?[]:BI(e,this._c):[].concat(t),s],o=a[0],l=a.reduce((d,h)=>{const p=zv(e,h,n);return d.top=Ps(p.top,d.top),d.right=Hi(p.right,d.right),d.bottom=Hi(p.bottom,d.bottom),d.left=Ps(p.left,d.left),d},zv(e,o,n));return{width:l.right-l.left,height:l.bottom-l.top,x:l.left,y:l.top}}function FI(c){const{width:e,height:t}=kw(c);return{width:e,height:t}}function QI(c,e,t){const s=kn(e),n=Pn(e),i=t==="fixed",a=Ca(c,!0,i,e);let o={scrollLeft:0,scrollTop:0};const l=xn(0);function d(){l.x=Su(n)}if(s||!s&&!i)if((Io(e)!=="body"||ec(n))&&(o=wu(e)),s){const v=Ca(e,!0,i,e);l.x=v.x+e.clientLeft,l.y=v.y+e.clientTop}else n&&d();i&&!s&&n&&d();const h=n&&!s&&!i?Dw(n,o):xn(0),p=a.left+o.scrollLeft-l.x-h.x,g=a.top+o.scrollTop-l.y-h.y;return{x:p,y:g,width:a.width,height:a.height}}function mf(c){return dn(c).position==="static"}function jv(c,e){if(!kn(c)||dn(c).position==="fixed")return null;if(e)return e(c);let t=c.offsetParent;return Pn(c)===t&&(t=t.ownerDocument.body),t}function Lw(c,e){const t=Ls(c);if(Mu(c))return t;if(!kn(c)){let n=$i(c);for(;n&&!Eo(n);){if(un(n)&&!mf(n))return n;n=$i(n)}return t}let s=jv(c,e);for(;s&&EI(s)&&mf(s);)s=jv(s,e);return s&&Eo(s)&&mf(s)&&!Tp(s)?t:s||LI(c)||t}const VI=async function(c){const e=this.getOffsetParent||Lw,t=this.getDimensions,s=await t(c.floating);return{reference:QI(c.reference,await e(c.floating),c.strategy),floating:{x:0,y:0,width:s.width,height:s.height}}};function GI(c){return dn(c).direction==="rtl"}const WI={convertOffsetParentRelativeRectToViewportRelativeRect:zI,getDocumentElement:Pn,getClippingRect:UI,getOffsetParent:Lw,getElementRects:VI,getClientRects:jI,getDimensions:FI,getScale:Ro,isElement:un,isRTL:GI};function _w(c,e){return c.x===e.x&&c.y===e.y&&c.width===e.width&&c.height===e.height}function KI(c,e){let t=null,s;const n=Pn(c);function i(){var o;clearTimeout(s),(o=t)==null||o.disconnect(),t=null}function a(o,l){o===void 0&&(o=!1),l===void 0&&(l=1),i();const d=c.getBoundingClientRect(),{left:h,top:p,width:g,height:v}=d;if(o||e(),!g||!v)return;const b=Tl(p),M=Tl(n.clientWidth-(h+g)),x=Tl(n.clientHeight-(p+v)),S=Tl(h),E={rootMargin:-b+"px "+-M+"px "+-x+"px "+-S+"px",threshold:Ps(0,Hi(1,l))||1};let A=!0;function k(D){const L=D[0].intersectionRatio;if(L!==l){if(!A)return a();L?a(!1,L):s=setTimeout(()=>{a(!1,1e-7)},1e3)}L===1&&!_w(d,c.getBoundingClientRect())&&a(),A=!1}try{t=new IntersectionObserver(k,{...E,root:n.ownerDocument})}catch{t=new IntersectionObserver(k,E)}t.observe(c)}return a(!0),i}function YI(c,e,t,s){s===void 0&&(s={});const{ancestorScroll:n=!0,ancestorResize:i=!0,elementResize:a=typeof ResizeObserver=="function",layoutShift:o=typeof IntersectionObserver=="function",animationFrame:l=!1}=s,d=kp(c),h=n||i?[...d?Br(d):[],...Br(e)]:[];h.forEach(S=>{n&&S.addEventListener("scroll",t,{passive:!0}),i&&S.addEventListener("resize",t)});const p=d&&o?KI(d,t):null;let g=-1,v=null;a&&(v=new ResizeObserver(S=>{let[T]=S;T&&T.target===d&&v&&(v.unobserve(e),cancelAnimationFrame(g),g=requestAnimationFrame(()=>{var E;(E=v)==null||E.observe(e)})),t()}),d&&!l&&v.observe(d),v.observe(e));let b,M=l?Ca(c):null;l&&x();function x(){const S=Ca(c);M&&!_w(M,S)&&t(),M=S,b=requestAnimationFrame(x)}return t(),()=>{var S;h.forEach(T=>{n&&T.removeEventListener("scroll",t),i&&T.removeEventListener("resize",t)}),p?.(),(S=v)==null||S.disconnect(),v=null,l&&cancelAnimationFrame(b)}}const XI=wI,JI=SI,ZI=vI,e2=CI,t2=bI,Ov=yI,s2=xI,n2=(c,e,t)=>{const s=new Map,n={platform:WI,...t},i={...n.platform,_c:s};return mI(c,e,{...n,platform:i})};var i2=typeof document<"u",a2=function(){},Nl=i2?R.useLayoutEffect:a2;function Kl(c,e){if(c===e)return!0;if(typeof c!=typeof e)return!1;if(typeof c=="function"&&c.toString()===e.toString())return!0;let t,s,n;if(c&&e&&typeof c=="object"){if(Array.isArray(c)){if(t=c.length,t!==e.length)return!1;for(s=t;s--!==0;)if(!Kl(c[s],e[s]))return!1;return!0}if(n=Object.keys(c),t=n.length,t!==Object.keys(e).length)return!1;for(s=t;s--!==0;)if(!{}.hasOwnProperty.call(e,n[s]))return!1;for(s=t;s--!==0;){const i=n[s];if(!(i==="_owner"&&c.$$typeof)&&!Kl(c[i],e[i]))return!1}return!0}return c!==c&&e!==e}function Iw(c){return typeof window>"u"?1:(c.ownerDocument.defaultView||window).devicePixelRatio||1}function qv(c,e){const t=Iw(c);return Math.round(e*t)/t}function yf(c){const e=R.useRef(c);return Nl(()=>{e.current=c}),e}function o2(c){c===void 0&&(c={});const{placement:e="bottom",strategy:t="absolute",middleware:s=[],platform:n,elements:{reference:i,floating:a}={},transform:o=!0,whileElementsMounted:l,open:d}=c,[h,p]=R.useState({x:0,y:0,strategy:t,placement:e,middlewareData:{},isPositioned:!1}),[g,v]=R.useState(s);Kl(g,s)||v(s);const[b,M]=R.useState(null),[x,S]=R.useState(null),T=R.useCallback(q=>{q!==D.current&&(D.current=q,M(q))},[]),E=R.useCallback(q=>{q!==L.current&&(L.current=q,S(q))},[]),A=i||b,k=a||x,D=R.useRef(null),L=R.useRef(null),I=R.useRef(h),U=l!=null,Q=yf(l),se=yf(n),F=yf(d),Y=R.useCallback(()=>{if(!D.current||!L.current)return;const q={placement:e,strategy:t,middleware:g};se.current&&(q.platform=se.current),n2(D.current,L.current,q).then(ee=>{const me={...ee,isPositioned:F.current!==!1};ae.current&&!Kl(I.current,me)&&(I.current=me,Vr.flushSync(()=>{p(me)}))})},[g,e,t,se,F]);Nl(()=>{d===!1&&I.current.isPositioned&&(I.current.isPositioned=!1,p(q=>({...q,isPositioned:!1})))},[d]);const ae=R.useRef(!1);Nl(()=>(ae.current=!0,()=>{ae.current=!1}),[]),Nl(()=>{if(A&&(D.current=A),k&&(L.current=k),A&&k){if(Q.current)return Q.current(A,k,Y);Y()}},[A,k,Y,Q,U]);const de=R.useMemo(()=>({reference:D,floating:L,setReference:T,setFloating:E}),[T,E]),z=R.useMemo(()=>({reference:A,floating:k}),[A,k]),$=R.useMemo(()=>{const q={position:t,left:0,top:0};if(!z.floating)return q;const ee=qv(z.floating,h.x),me=qv(z.floating,h.y);return o?{...q,transform:"translate("+ee+"px, "+me+"px)",...Iw(z.floating)>=1.5&&{willChange:"transform"}}:{position:t,left:ee,top:me}},[t,o,z.floating,h.x,h.y]);return R.useMemo(()=>({...h,update:Y,refs:de,elements:z,floatingStyles:$}),[h,Y,de,z,$])}const r2=c=>{function e(t){return{}.hasOwnProperty.call(t,"current")}return{name:"arrow",options:c,fn(t){const{element:s,padding:n}=typeof c=="function"?c(t):c;return s&&e(s)?s.current!=null?Ov({element:s.current,padding:n}).fn(t):{}:s?Ov({element:s,padding:n}).fn(t):{}}}},c2=(c,e)=>({...XI(c),options:[c,e]}),l2=(c,e)=>({...JI(c),options:[c,e]}),u2=(c,e)=>({...s2(c),options:[c,e]}),d2=(c,e)=>({...ZI(c),options:[c,e]}),h2=(c,e)=>({...e2(c),options:[c,e]}),f2=(c,e)=>({...t2(c),options:[c,e]}),p2=(c,e)=>({...r2(c),options:[c,e]});var g2="Arrow",Nw=R.forwardRef((c,e)=>{const{children:t,width:s=10,height:n=5,...i}=c;return y.jsx(Le.svg,{...i,ref:e,width:s,height:n,viewBox:"0 0 30 10",preserveAspectRatio:"none",children:c.asChild?t:y.jsx("polygon",{points:"0,0 30,0 15,10"})})});Nw.displayName=g2;var m2=Nw;function xu(c){const[e,t]=R.useState(void 0);return as(()=>{if(c){t({width:c.offsetWidth,height:c.offsetHeight});const s=new ResizeObserver(n=>{if(!Array.isArray(n)||!n.length)return;const i=n[0];let a,o;if("borderBoxSize"in i){const l=i.borderBoxSize,d=Array.isArray(l)?l[0]:l;a=d.inlineSize,o=d.blockSize}else a=c.offsetWidth,o=c.offsetHeight;t({width:a,height:o})});return s.observe(c,{box:"border-box"}),()=>s.unobserve(c)}else t(void 0)},[c]),e}var Ap="Popper",[zw,No]=ws(Ap),[y2,jw]=zw(Ap),Ow=c=>{const{__scopePopper:e,children:t}=c,[s,n]=R.useState(null);return y.jsx(y2,{scope:e,anchor:s,onAnchorChange:n,children:t})};Ow.displayName=Ap;var qw="PopperAnchor",Hw=R.forwardRef((c,e)=>{const{__scopePopper:t,virtualRef:s,...n}=c,i=jw(qw,t),a=R.useRef(null),o=Ne(e,a),l=R.useRef(null);return R.useEffect(()=>{const d=l.current;l.current=s?.current||a.current,d!==l.current&&i.onAnchorChange(l.current)}),s?null:y.jsx(Le.div,{...n,ref:o})});Hw.displayName=qw;var Dp="PopperContent",[v2,b2]=zw(Dp),$w=R.forwardRef((c,e)=>{const{__scopePopper:t,side:s="bottom",sideOffset:n=0,align:i="center",alignOffset:a=0,arrowPadding:o=0,avoidCollisions:l=!0,collisionBoundary:d=[],collisionPadding:h=0,sticky:p="partial",hideWhenDetached:g=!1,updatePositionStrategy:v="optimized",onPlaced:b,...M}=c,x=jw(Dp,t),[S,T]=R.useState(null),E=Ne(e,V=>T(V)),[A,k]=R.useState(null),D=xu(A),L=D?.width??0,I=D?.height??0,U=s+(i!=="center"?"-"+i:""),Q=typeof h=="number"?h:{top:0,right:0,bottom:0,left:0,...h},se=Array.isArray(d)?d:[d],F=se.length>0,Y={padding:Q,boundary:se.filter(w2),altBoundary:F},{refs:ae,floatingStyles:de,placement:z,isPositioned:$,middlewareData:q}=o2({strategy:"fixed",placement:U,whileElementsMounted:(...V)=>YI(...V,{animationFrame:v==="always"}),elements:{reference:x.anchor},middleware:[c2({mainAxis:n+I,alignmentAxis:a}),l&&l2({mainAxis:!0,crossAxis:!1,limiter:p==="partial"?u2():void 0,...Y}),l&&d2({...Y}),h2({...Y,apply:({elements:V,rects:j,availableWidth:ue,availableHeight:fe})=>{const{width:ge,height:pe}=j.reference,we=V.floating.style;we.setProperty("--radix-popper-available-width",`${ue}px`),we.setProperty("--radix-popper-available-height",`${fe}px`),we.setProperty("--radix-popper-anchor-width",`${ge}px`),we.setProperty("--radix-popper-anchor-height",`${pe}px`)}}),A&&p2({element:A,padding:o}),S2({arrowWidth:L,arrowHeight:I}),g&&f2({strategy:"referenceHidden",...Y})]}),[ee,me]=Fw(z),N=is(b);as(()=>{$&&N?.()},[$,N]);const J=q.arrow?.x,K=q.arrow?.y,ie=q.arrow?.centerOffset!==0,[Z,re]=R.useState();return as(()=>{S&&re(window.getComputedStyle(S).zIndex)},[S]),y.jsx("div",{ref:ae.setFloating,"data-radix-popper-content-wrapper":"",style:{...de,transform:$?de.transform:"translate(0, -200%)",minWidth:"max-content",zIndex:Z,"--radix-popper-transform-origin":[q.transformOrigin?.x,q.transformOrigin?.y].join(" "),...q.hide?.referenceHidden&&{visibility:"hidden",pointerEvents:"none"}},dir:c.dir,children:y.jsx(v2,{scope:t,placedSide:ee,onArrowChange:k,arrowX:J,arrowY:K,shouldHideArrow:ie,children:y.jsx(Le.div,{"data-side":ee,"data-align":me,...M,ref:E,style:{...M.style,animation:$?void 0:"none"}})})})});$w.displayName=Dp;var Bw="PopperArrow",M2={top:"bottom",right:"left",bottom:"top",left:"right"},Uw=R.forwardRef(function(e,t){const{__scopePopper:s,...n}=e,i=b2(Bw,s),a=M2[i.placedSide];return y.jsx("span",{ref:i.onArrowChange,style:{position:"absolute",left:i.arrowX,top:i.arrowY,[a]:0,transformOrigin:{top:"",right:"0 0",bottom:"center 0",left:"100% 0"}[i.placedSide],transform:{top:"translateY(100%)",right:"translateY(50%) rotate(90deg) translateX(-50%)",bottom:"rotate(180deg)",left:"translateY(50%) rotate(-90deg) translateX(50%)"}[i.placedSide],visibility:i.shouldHideArrow?"hidden":void 0},children:y.jsx(m2,{...n,ref:t,style:{...n.style,display:"block"}})})});Uw.displayName=Bw;function w2(c){return c!==null}var S2=c=>({name:"transformOrigin",options:c,fn(e){const{placement:t,rects:s,middlewareData:n}=e,a=n.arrow?.centerOffset!==0,o=a?0:c.arrowWidth,l=a?0:c.arrowHeight,[d,h]=Fw(t),p={start:"0%",center:"50%",end:"100%"}[h],g=(n.arrow?.x??0)+o/2,v=(n.arrow?.y??0)+l/2;let b="",M="";return d==="bottom"?(b=a?p:`${g}px`,M=`${-l}px`):d==="top"?(b=a?p:`${g}px`,M=`${s.floating.height+l}px`):d==="right"?(b=`${-l}px`,M=a?p:`${v}px`):d==="left"&&(b=`${s.floating.width+l}px`,M=a?p:`${v}px`),{data:{x:b,y:M}}}});function Fw(c){const[e,t="center"]=c.split("-");return[e,t]}var Pp=Ow,Cu=Hw,Lp=$w,_p=Uw;function x2(c){const e=C2(c),t=R.forwardRef((s,n)=>{const{children:i,...a}=s,o=R.Children.toArray(i),l=o.find(T2);if(l){const d=l.props.children,h=o.map(p=>p===l?R.Children.count(d)>1?R.Children.only(null):R.isValidElement(d)?d.props.children:null:p);return y.jsx(e,{...a,ref:n,children:R.isValidElement(d)?R.cloneElement(d,void 0,h):null})}return y.jsx(e,{...a,ref:n,children:i})});return t.displayName=`${c}.Slot`,t}function C2(c){const e=R.forwardRef((t,s)=>{const{children:n,...i}=t;if(R.isValidElement(n)){const a=k2(n),o=E2(i,n.props);return n.type!==R.Fragment&&(o.ref=s?An(s,a):a),R.cloneElement(n,o)}return R.Children.count(n)>1?R.Children.only(null):null});return e.displayName=`${c}.SlotClone`,e}var R2=Symbol("radix.slottable");function T2(c){return R.isValidElement(c)&&typeof c.type=="function"&&"__radixId"in c.type&&c.type.__radixId===R2}function E2(c,e){const t={...e};for(const s in e){const n=c[s],i=e[s];/^on[A-Z]/.test(s)?n&&i?t[s]=(...o)=>{const l=i(...o);return n(...o),l}:n&&(t[s]=n):s==="style"?t[s]={...n,...i}:s==="className"&&(t[s]=[n,i].filter(Boolean).join(" "))}return{...c,...t}}function k2(c){let e=Object.getOwnPropertyDescriptor(c.props,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning;return t?c.ref:(e=Object.getOwnPropertyDescriptor(c,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning,t?c.props.ref:c.props.ref||c.ref)}var Pf=["Enter"," "],A2=["ArrowDown","PageUp","Home"],Qw=["ArrowUp","PageDown","End"],D2=[...A2,...Qw],P2={ltr:[...Pf,"ArrowRight"],rtl:[...Pf,"ArrowLeft"]},L2={ltr:["ArrowLeft"],rtl:["ArrowRight"]},tc="Menu",[Ur,_2,I2]=gu(tc),[Ea,Vw]=ws(tc,[I2,No,mu]),Ru=No(),Gw=mu(),[N2,ka]=Ea(tc),[z2,sc]=Ea(tc),Ww=c=>{const{__scopeMenu:e,open:t=!1,children:s,dir:n,onOpenChange:i,modal:a=!0}=c,o=Ru(e),[l,d]=R.useState(null),h=R.useRef(!1),p=is(i),g=Lo(n);return R.useEffect(()=>{const v=()=>{h.current=!0,document.addEventListener("pointerdown",b,{capture:!0,once:!0}),document.addEventListener("pointermove",b,{capture:!0,once:!0})},b=()=>h.current=!1;return document.addEventListener("keydown",v,{capture:!0}),()=>{document.removeEventListener("keydown",v,{capture:!0}),document.removeEventListener("pointerdown",b,{capture:!0}),document.removeEventListener("pointermove",b,{capture:!0})}},[]),y.jsx(Pp,{...o,children:y.jsx(N2,{scope:e,open:t,onOpenChange:p,content:l,onContentChange:d,children:y.jsx(z2,{scope:e,onClose:R.useCallback(()=>p(!1),[p]),isUsingKeyboardRef:h,dir:g,modal:a,children:s})})})};Ww.displayName=tc;var j2="MenuAnchor",Ip=R.forwardRef((c,e)=>{const{__scopeMenu:t,...s}=c,n=Ru(t);return y.jsx(Cu,{...n,...s,ref:e})});Ip.displayName=j2;var Np="MenuPortal",[O2,Kw]=Ea(Np,{forceMount:void 0}),Yw=c=>{const{__scopeMenu:e,forceMount:t,children:s,container:n}=c,i=ka(Np,e);return y.jsx(O2,{scope:e,forceMount:t,children:y.jsx(cs,{present:t||i.open,children:y.jsx(Xr,{asChild:!0,container:n,children:s})})})};Yw.displayName=Np;var Ks="MenuContent",[q2,zp]=Ea(Ks),Xw=R.forwardRef((c,e)=>{const t=Kw(Ks,c.__scopeMenu),{forceMount:s=t.forceMount,...n}=c,i=ka(Ks,c.__scopeMenu),a=sc(Ks,c.__scopeMenu);return y.jsx(Ur.Provider,{scope:c.__scopeMenu,children:y.jsx(cs,{present:s||i.open,children:y.jsx(Ur.Slot,{scope:c.__scopeMenu,children:a.modal?y.jsx(H2,{...n,ref:e}):y.jsx($2,{...n,ref:e})})})})}),H2=R.forwardRef((c,e)=>{const t=ka(Ks,c.__scopeMenu),s=R.useRef(null),n=Ne(e,s);return R.useEffect(()=>{const i=s.current;if(i)return cu(i)},[]),y.jsx(jp,{...c,ref:n,trapFocus:t.open,disableOutsidePointerEvents:t.open,disableOutsideScroll:!0,onFocusOutside:be(c.onFocusOutside,i=>i.preventDefault(),{checkForDefaultPrevented:!1}),onDismiss:()=>t.onOpenChange(!1)})}),$2=R.forwardRef((c,e)=>{const t=ka(Ks,c.__scopeMenu);return y.jsx(jp,{...c,ref:e,trapFocus:!1,disableOutsidePointerEvents:!1,disableOutsideScroll:!1,onDismiss:()=>t.onOpenChange(!1)})}),B2=x2("MenuContent.ScrollLock"),jp=R.forwardRef((c,e)=>{const{__scopeMenu:t,loop:s=!1,trapFocus:n,onOpenAutoFocus:i,onCloseAutoFocus:a,disableOutsidePointerEvents:o,onEntryFocus:l,onEscapeKeyDown:d,onPointerDownOutside:h,onFocusOutside:p,onInteractOutside:g,onDismiss:v,disableOutsideScroll:b,...M}=c,x=ka(Ks,t),S=sc(Ks,t),T=Ru(t),E=Gw(t),A=_2(t),[k,D]=R.useState(null),L=R.useRef(null),I=Ne(e,L,x.onContentChange),U=R.useRef(0),Q=R.useRef(""),se=R.useRef(0),F=R.useRef(null),Y=R.useRef("right"),ae=R.useRef(0),de=b?Jr:R.Fragment,z=b?{as:B2,allowPinchZoom:!0}:void 0,$=ee=>{const me=Q.current+ee,N=A().filter(V=>!V.disabled),J=document.activeElement,K=N.find(V=>V.ref.current===J)?.textValue,ie=N.map(V=>V.textValue),Z=eN(ie,me,K),re=N.find(V=>V.textValue===Z)?.ref.current;(function V(j){Q.current=j,window.clearTimeout(U.current),j!==""&&(U.current=window.setTimeout(()=>V(""),1e3))})(me),re&&setTimeout(()=>re.focus())};R.useEffect(()=>()=>window.clearTimeout(U.current),[]),ou();const q=R.useCallback(ee=>Y.current===F.current?.side&&sN(ee,F.current?.area),[]);return y.jsx(q2,{scope:t,searchRef:Q,onItemEnter:R.useCallback(ee=>{q(ee)&&ee.preventDefault()},[q]),onItemLeave:R.useCallback(ee=>{q(ee)||(L.current?.focus(),D(null))},[q]),onTriggerLeave:R.useCallback(ee=>{q(ee)&&ee.preventDefault()},[q]),pointerGraceTimerRef:se,onPointerGraceIntentChange:R.useCallback(ee=>{F.current=ee},[]),children:y.jsx(de,{...z,children:y.jsx(Yr,{asChild:!0,trapped:n,onMountAutoFocus:be(i,ee=>{ee.preventDefault(),L.current?.focus({preventScroll:!0})}),onUnmountAutoFocus:a,children:y.jsx(Kr,{asChild:!0,disableOutsidePointerEvents:o,onEscapeKeyDown:d,onPointerDownOutside:h,onFocusOutside:p,onInteractOutside:g,onDismiss:v,children:y.jsx(lw,{asChild:!0,...E,dir:S.dir,orientation:"vertical",loop:s,currentTabStopId:k,onCurrentTabStopIdChange:D,onEntryFocus:be(l,ee=>{S.isUsingKeyboardRef.current||ee.preventDefault()}),preventScrollOnEntryFocus:!0,children:y.jsx(Lp,{role:"menu","aria-orientation":"vertical","data-state":fS(x.open),"data-radix-menu-content":"",dir:S.dir,...T,...M,ref:I,style:{outline:"none",...M.style},onKeyDown:be(M.onKeyDown,ee=>{const N=ee.target.closest("[data-radix-menu-content]")===ee.currentTarget,J=ee.ctrlKey||ee.altKey||ee.metaKey,K=ee.key.length===1;N&&(ee.key==="Tab"&&ee.preventDefault(),!J&&K&&$(ee.key));const ie=L.current;if(ee.target!==ie||!D2.includes(ee.key))return;ee.preventDefault();const re=A().filter(V=>!V.disabled).map(V=>V.ref.current);Qw.includes(ee.key)&&re.reverse(),J2(re)}),onBlur:be(c.onBlur,ee=>{ee.currentTarget.contains(ee.target)||(window.clearTimeout(U.current),Q.current="")}),onPointerMove:be(c.onPointerMove,Fr(ee=>{const me=ee.target,N=ae.current!==ee.clientX;if(ee.currentTarget.contains(me)&&N){const J=ee.clientX>ae.current?"right":"left";Y.current=J,ae.current=ee.clientX}}))})})})})})})});Xw.displayName=Ks;var U2="MenuGroup",Op=R.forwardRef((c,e)=>{const{__scopeMenu:t,...s}=c;return y.jsx(Le.div,{role:"group",...s,ref:e})});Op.displayName=U2;var F2="MenuLabel",Jw=R.forwardRef((c,e)=>{const{__scopeMenu:t,...s}=c;return y.jsx(Le.div,{...s,ref:e})});Jw.displayName=F2;var Yl="MenuItem",Hv="menu.itemSelect",Tu=R.forwardRef((c,e)=>{const{disabled:t=!1,onSelect:s,...n}=c,i=R.useRef(null),a=sc(Yl,c.__scopeMenu),o=zp(Yl,c.__scopeMenu),l=Ne(e,i),d=R.useRef(!1),h=()=>{const p=i.current;if(!t&&p){const g=new CustomEvent(Hv,{bubbles:!0,cancelable:!0});p.addEventListener(Hv,v=>s?.(v),{once:!0}),$b(p,g),g.defaultPrevented?d.current=!1:a.onClose()}};return y.jsx(Zw,{...n,ref:l,disabled:t,onClick:be(c.onClick,h),onPointerDown:p=>{c.onPointerDown?.(p),d.current=!0},onPointerUp:be(c.onPointerUp,p=>{d.current||p.currentTarget?.click()}),onKeyDown:be(c.onKeyDown,p=>{const g=o.searchRef.current!=="";t||g&&p.key===" "||Pf.includes(p.key)&&(p.currentTarget.click(),p.preventDefault())})})});Tu.displayName=Yl;var Zw=R.forwardRef((c,e)=>{const{__scopeMenu:t,disabled:s=!1,textValue:n,...i}=c,a=zp(Yl,t),o=Gw(t),l=R.useRef(null),d=Ne(e,l),[h,p]=R.useState(!1),[g,v]=R.useState("");return R.useEffect(()=>{const b=l.current;b&&v((b.textContent??"").trim())},[i.children]),y.jsx(Ur.ItemSlot,{scope:t,disabled:s,textValue:n??g,children:y.jsx(uw,{asChild:!0,...o,focusable:!s,children:y.jsx(Le.div,{role:"menuitem","data-highlighted":h?"":void 0,"aria-disabled":s||void 0,"data-disabled":s?"":void 0,...i,ref:d,onPointerMove:be(c.onPointerMove,Fr(b=>{s?a.onItemLeave(b):(a.onItemEnter(b),b.defaultPrevented||b.currentTarget.focus({preventScroll:!0}))})),onPointerLeave:be(c.onPointerLeave,Fr(b=>a.onItemLeave(b))),onFocus:be(c.onFocus,()=>p(!0)),onBlur:be(c.onBlur,()=>p(!1))})})})}),Q2="MenuCheckboxItem",eS=R.forwardRef((c,e)=>{const{checked:t=!1,onCheckedChange:s,...n}=c;return y.jsx(aS,{scope:c.__scopeMenu,checked:t,children:y.jsx(Tu,{role:"menuitemcheckbox","aria-checked":Xl(t)?"mixed":t,...n,ref:e,"data-state":Hp(t),onSelect:be(n.onSelect,()=>s?.(Xl(t)?!0:!t),{checkForDefaultPrevented:!1})})})});eS.displayName=Q2;var tS="MenuRadioGroup",[V2,G2]=Ea(tS,{value:void 0,onValueChange:()=>{}}),sS=R.forwardRef((c,e)=>{const{value:t,onValueChange:s,...n}=c,i=is(s);return y.jsx(V2,{scope:c.__scopeMenu,value:t,onValueChange:i,children:y.jsx(Op,{...n,ref:e})})});sS.displayName=tS;var nS="MenuRadioItem",iS=R.forwardRef((c,e)=>{const{value:t,...s}=c,n=G2(nS,c.__scopeMenu),i=t===n.value;return y.jsx(aS,{scope:c.__scopeMenu,checked:i,children:y.jsx(Tu,{role:"menuitemradio","aria-checked":i,...s,ref:e,"data-state":Hp(i),onSelect:be(s.onSelect,()=>n.onValueChange?.(t),{checkForDefaultPrevented:!1})})})});iS.displayName=nS;var qp="MenuItemIndicator",[aS,W2]=Ea(qp,{checked:!1}),oS=R.forwardRef((c,e)=>{const{__scopeMenu:t,forceMount:s,...n}=c,i=W2(qp,t);return y.jsx(cs,{present:s||Xl(i.checked)||i.checked===!0,children:y.jsx(Le.span,{...n,ref:e,"data-state":Hp(i.checked)})})});oS.displayName=qp;var K2="MenuSeparator",rS=R.forwardRef((c,e)=>{const{__scopeMenu:t,...s}=c;return y.jsx(Le.div,{role:"separator","aria-orientation":"horizontal",...s,ref:e})});rS.displayName=K2;var Y2="MenuArrow",cS=R.forwardRef((c,e)=>{const{__scopeMenu:t,...s}=c,n=Ru(t);return y.jsx(_p,{...n,...s,ref:e})});cS.displayName=Y2;var X2="MenuSub",[C3,lS]=Ea(X2),_r="MenuSubTrigger",uS=R.forwardRef((c,e)=>{const t=ka(_r,c.__scopeMenu),s=sc(_r,c.__scopeMenu),n=lS(_r,c.__scopeMenu),i=zp(_r,c.__scopeMenu),a=R.useRef(null),{pointerGraceTimerRef:o,onPointerGraceIntentChange:l}=i,d={__scopeMenu:c.__scopeMenu},h=R.useCallback(()=>{a.current&&window.clearTimeout(a.current),a.current=null},[]);return R.useEffect(()=>h,[h]),R.useEffect(()=>{const p=o.current;return()=>{window.clearTimeout(p),l(null)}},[o,l]),y.jsx(Ip,{asChild:!0,...d,children:y.jsx(Zw,{id:n.triggerId,"aria-haspopup":"menu","aria-expanded":t.open,"aria-controls":n.contentId,"data-state":fS(t.open),...c,ref:An(e,n.onTriggerChange),onClick:p=>{c.onClick?.(p),!(c.disabled||p.defaultPrevented)&&(p.currentTarget.focus(),t.open||t.onOpenChange(!0))},onPointerMove:be(c.onPointerMove,Fr(p=>{i.onItemEnter(p),!p.defaultPrevented&&!c.disabled&&!t.open&&!a.current&&(i.onPointerGraceIntentChange(null),a.current=window.setTimeout(()=>{t.onOpenChange(!0),h()},100))})),onPointerLeave:be(c.onPointerLeave,Fr(p=>{h();const g=t.content?.getBoundingClientRect();if(g){const v=t.content?.dataset.side,b=v==="right",M=b?-5:5,x=g[b?"left":"right"],S=g[b?"right":"left"];i.onPointerGraceIntentChange({area:[{x:p.clientX+M,y:p.clientY},{x,y:g.top},{x:S,y:g.top},{x:S,y:g.bottom},{x,y:g.bottom}],side:v}),window.clearTimeout(o.current),o.current=window.setTimeout(()=>i.onPointerGraceIntentChange(null),300)}else{if(i.onTriggerLeave(p),p.defaultPrevented)return;i.onPointerGraceIntentChange(null)}})),onKeyDown:be(c.onKeyDown,p=>{const g=i.searchRef.current!=="";c.disabled||g&&p.key===" "||P2[s.dir].includes(p.key)&&(t.onOpenChange(!0),t.content?.focus(),p.preventDefault())})})})});uS.displayName=_r;var dS="MenuSubContent",hS=R.forwardRef((c,e)=>{const t=Kw(Ks,c.__scopeMenu),{forceMount:s=t.forceMount,...n}=c,i=ka(Ks,c.__scopeMenu),a=sc(Ks,c.__scopeMenu),o=lS(dS,c.__scopeMenu),l=R.useRef(null),d=Ne(e,l);return y.jsx(Ur.Provider,{scope:c.__scopeMenu,children:y.jsx(cs,{present:s||i.open,children:y.jsx(Ur.Slot,{scope:c.__scopeMenu,children:y.jsx(jp,{id:o.contentId,"aria-labelledby":o.triggerId,...n,ref:d,align:"start",side:a.dir==="rtl"?"left":"right",disableOutsidePointerEvents:!1,disableOutsideScroll:!1,trapFocus:!1,onOpenAutoFocus:h=>{a.isUsingKeyboardRef.current&&l.current?.focus(),h.preventDefault()},onCloseAutoFocus:h=>h.preventDefault(),onFocusOutside:be(c.onFocusOutside,h=>{h.target!==o.trigger&&i.onOpenChange(!1)}),onEscapeKeyDown:be(c.onEscapeKeyDown,h=>{a.onClose(),h.preventDefault()}),onKeyDown:be(c.onKeyDown,h=>{const p=h.currentTarget.contains(h.target),g=L2[a.dir].includes(h.key);p&&g&&(i.onOpenChange(!1),o.trigger?.focus(),h.preventDefault())})})})})})});hS.displayName=dS;function fS(c){return c?"open":"closed"}function Xl(c){return c==="indeterminate"}function Hp(c){return Xl(c)?"indeterminate":c?"checked":"unchecked"}function J2(c){const e=document.activeElement;for(const t of c)if(t===e||(t.focus(),document.activeElement!==e))return}function Z2(c,e){return c.map((t,s)=>c[(e+s)%c.length])}function eN(c,e,t){const n=e.length>1&&Array.from(e).every(d=>d===e[0])?e[0]:e,i=t?c.indexOf(t):-1;let a=Z2(c,Math.max(i,0));n.length===1&&(a=a.filter(d=>d!==t));const l=a.find(d=>d.toLowerCase().startsWith(n.toLowerCase()));return l!==t?l:void 0}function tN(c,e){const{x:t,y:s}=c;let n=!1;for(let i=0,a=e.length-1;i<e.length;a=i++){const o=e[i],l=e[a],d=o.x,h=o.y,p=l.x,g=l.y;h>s!=g>s&&t<(p-d)*(s-h)/(g-h)+d&&(n=!n)}return n}function sN(c,e){if(!e)return!1;const t={x:c.clientX,y:c.clientY};return tN(t,e)}function Fr(c){return e=>e.pointerType==="mouse"?c(e):void 0}var nN=Ww,iN=Ip,aN=Yw,oN=Xw,rN=Op,cN=Jw,lN=Tu,uN=eS,dN=sS,hN=iS,fN=oS,pN=rS,gN=cS,mN=uS,yN=hS,Eu="DropdownMenu",[vN]=ws(Eu,[Vw]),ds=Vw(),[bN,pS]=vN(Eu),gS=c=>{const{__scopeDropdownMenu:e,children:t,dir:s,open:n,defaultOpen:i,onOpenChange:a,modal:o=!0}=c,l=ds(e),d=R.useRef(null),[h,p]=En({prop:n,defaultProp:i??!1,onChange:a,caller:Eu});return y.jsx(bN,{scope:e,triggerId:ln(),triggerRef:d,contentId:ln(),open:h,onOpenChange:p,onOpenToggle:R.useCallback(()=>p(g=>!g),[p]),modal:o,children:y.jsx(nN,{...l,open:h,onOpenChange:p,dir:s,modal:o,children:t})})};gS.displayName=Eu;var mS="DropdownMenuTrigger",yS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,disabled:s=!1,...n}=c,i=pS(mS,t),a=ds(t);return y.jsx(iN,{asChild:!0,...a,children:y.jsx(Le.button,{type:"button",id:i.triggerId,"aria-haspopup":"menu","aria-expanded":i.open,"aria-controls":i.open?i.contentId:void 0,"data-state":i.open?"open":"closed","data-disabled":s?"":void 0,disabled:s,...n,ref:An(e,i.triggerRef),onPointerDown:be(c.onPointerDown,o=>{!s&&o.button===0&&o.ctrlKey===!1&&(i.onOpenToggle(),i.open||o.preventDefault())}),onKeyDown:be(c.onKeyDown,o=>{s||(["Enter"," "].includes(o.key)&&i.onOpenToggle(),o.key==="ArrowDown"&&i.onOpenChange(!0),["Enter"," ","ArrowDown"].includes(o.key)&&o.preventDefault())})})})});yS.displayName=mS;var MN="DropdownMenuPortal",vS=c=>{const{__scopeDropdownMenu:e,...t}=c,s=ds(e);return y.jsx(aN,{...s,...t})};vS.displayName=MN;var bS="DropdownMenuContent",MS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=pS(bS,t),i=ds(t),a=R.useRef(!1);return y.jsx(oN,{id:n.contentId,"aria-labelledby":n.triggerId,...i,...s,ref:e,onCloseAutoFocus:be(c.onCloseAutoFocus,o=>{a.current||n.triggerRef.current?.focus(),a.current=!1,o.preventDefault()}),onInteractOutside:be(c.onInteractOutside,o=>{const l=o.detail.originalEvent,d=l.button===0&&l.ctrlKey===!0,h=l.button===2||d;(!n.modal||h)&&(a.current=!0)}),style:{...c.style,"--radix-dropdown-menu-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-dropdown-menu-content-available-width":"var(--radix-popper-available-width)","--radix-dropdown-menu-content-available-height":"var(--radix-popper-available-height)","--radix-dropdown-menu-trigger-width":"var(--radix-popper-anchor-width)","--radix-dropdown-menu-trigger-height":"var(--radix-popper-anchor-height)"}})});MS.displayName=bS;var wN="DropdownMenuGroup",SN=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(rN,{...n,...s,ref:e})});SN.displayName=wN;var xN="DropdownMenuLabel",wS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(cN,{...n,...s,ref:e})});wS.displayName=xN;var CN="DropdownMenuItem",SS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(lN,{...n,...s,ref:e})});SS.displayName=CN;var RN="DropdownMenuCheckboxItem",xS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(uN,{...n,...s,ref:e})});xS.displayName=RN;var TN="DropdownMenuRadioGroup",EN=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(dN,{...n,...s,ref:e})});EN.displayName=TN;var kN="DropdownMenuRadioItem",CS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(hN,{...n,...s,ref:e})});CS.displayName=kN;var AN="DropdownMenuItemIndicator",RS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(fN,{...n,...s,ref:e})});RS.displayName=AN;var DN="DropdownMenuSeparator",TS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(pN,{...n,...s,ref:e})});TS.displayName=DN;var PN="DropdownMenuArrow",LN=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(gN,{...n,...s,ref:e})});LN.displayName=PN;var _N="DropdownMenuSubTrigger",ES=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(mN,{...n,...s,ref:e})});ES.displayName=_N;var IN="DropdownMenuSubContent",kS=R.forwardRef((c,e)=>{const{__scopeDropdownMenu:t,...s}=c,n=ds(t);return y.jsx(yN,{...n,...s,ref:e,style:{...c.style,"--radix-dropdown-menu-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-dropdown-menu-content-available-width":"var(--radix-popper-available-width)","--radix-dropdown-menu-content-available-height":"var(--radix-popper-available-height)","--radix-dropdown-menu-trigger-width":"var(--radix-popper-anchor-width)","--radix-dropdown-menu-trigger-height":"var(--radix-popper-anchor-height)"}})});kS.displayName=IN;var NN=gS,zN=yS,jN=vS,AS=MS,DS=wS,PS=SS,LS=xS,_S=CS,IS=RS,NS=TS,zS=ES,jS=kS;const ON=NN,qN=zN,HN=R.forwardRef(({className:c,inset:e,children:t,...s},n)=>y.jsxs(zS,{ref:n,className:Ae("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",c),...s,children:[t,y.jsx(ep,{className:"ml-auto"})]}));HN.displayName=zS.displayName;const $N=R.forwardRef(({className:c,...e},t)=>y.jsx(jS,{ref:t,className:Ae("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",c),...e}));$N.displayName=jS.displayName;const OS=R.forwardRef(({className:c,sideOffset:e=4,...t},s)=>y.jsx(jN,{children:y.jsx(AS,{ref:s,sideOffset:e,className:Ae("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",c),...t})}));OS.displayName=AS.displayName;const zl=R.forwardRef(({className:c,inset:e,...t},s)=>y.jsx(PS,{ref:s,className:Ae("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",e&&"pl-8",c),...t}));zl.displayName=PS.displayName;const BN=R.forwardRef(({className:c,children:e,checked:t,...s},n)=>y.jsxs(LS,{ref:n,className:Ae("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",c),checked:t,...s,children:[y.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:y.jsx(IS,{children:y.jsx(Zf,{className:"h-4 w-4"})})}),e]}));BN.displayName=LS.displayName;const UN=R.forwardRef(({className:c,children:e,...t},s)=>y.jsxs(_S,{ref:s,className:Ae("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",c),...t,children:[y.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:y.jsx(IS,{children:y.jsx(dD,{className:"h-2 w-2 fill-current"})})}),e]}));UN.displayName=_S.displayName;const Lf=R.forwardRef(({className:c,inset:e,...t},s)=>y.jsx(DS,{ref:s,className:Ae("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",c),...t}));Lf.displayName=DS.displayName;const qS=R.forwardRef(({className:c,...e},t)=>y.jsx(NS,{ref:t,className:Ae("-mx-1 my-1 h-px bg-muted",c),...e}));qS.displayName=NS.displayName;const HS="archiphoenix_component_library",$v=()=>{if(typeof window>"u")return{favorites:[],collections:[]};try{const c=window.localStorage.getItem(HS);if(!c)return{favorites:[],collections:[]};const e=JSON.parse(c);return{favorites:Array.isArray(e.favorites)?e.favorites:[],collections:Array.isArray(e.collections)?e.collections:[]}}catch(c){return Or("Failed to load component library state",c instanceof Error?c:new Error(String(c))),{favorites:[],collections:[]}}},Mo=c=>{typeof window>"u"||window.localStorage.setItem(HS,JSON.stringify(c))},FN=hn((c,e)=>({favorites:$v().favorites,collections:$v().collections,toggleFavorite:t=>{c(s=>{const i=s.favorites.includes(t)?s.favorites.filter(a=>a!==t):[...s.favorites,t];return Mo({favorites:i,collections:s.collections}),{favorites:i}})},createCollection:t=>{const s=t.trim();if(!s)return null;const n={id:`collection-${Date.now()}`,name:s,componentIds:[]};return c(i=>{const a=[...i.collections,n];return Mo({favorites:i.favorites,collections:a}),{collections:a}}),n.id},renameCollection:(t,s)=>{c(n=>{const i=n.collections.map(a=>a.id===t?{...a,name:s}:a);return Mo({favorites:n.favorites,collections:i}),{collections:i}})},deleteCollection:t=>{c(s=>{const n=s.collections.filter(i=>i.id!==t);return Mo({favorites:s.favorites,collections:n}),{collections:n}})},addComponentToCollection:(t,s)=>{c(n=>{const i=n.collections.map(a=>a.id!==t||a.componentIds.includes(s)?a:{...a,componentIds:[...a.componentIds,s]});return Mo({favorites:n.favorites,collections:i}),{collections:i}})},removeComponentFromCollection:(t,s)=>{c(n=>{const i=n.collections.map(a=>a.id!==t?a:{...a,componentIds:a.componentIds.filter(o=>o!==s)});return Mo({favorites:n.favorites,collections:i}),{collections:i}})}}));function Bv({open:c,initialName:e="",onConfirm:t,onCancel:s}){const[n,i]=R.useState(e);R.useEffect(()=>{c&&i(e)},[c,e]);const a=()=>{n.trim()&&t(n.trim())};return y.jsx(bp,{open:c,onOpenChange:o=>!o&&s(),children:y.jsxs(uu,{children:[y.jsxs(du,{children:[y.jsx(fu,{children:e?"Rename Collection":"Create Collection"}),y.jsx(pu,{children:e?"Enter a new name for the collection":"Enter a name for the new collection"})]}),y.jsxs("div",{className:"py-4",children:[y.jsx(He,{htmlFor:"collection-name",children:"Collection Name"}),y.jsx(ct,{id:"collection-name",value:n,onChange:o=>i(o.target.value),onKeyDown:o=>{o.key==="Enter"&&a()},className:"mt-2",autoFocus:!0})]}),y.jsxs(hu,{children:[y.jsx(De,{variant:"outline",onClick:s,children:"Cancel"}),y.jsx(De,{onClick:a,disabled:!n.trim(),children:e?"Save":"Create"})]})]})})}function QN(){const[c,e]=R.useState(""),[t,s]=R.useState("all"),[n,i]=R.useState(!1),[a,o]=R.useState(!1),[l,d]=R.useState(null),[h,p]=R.useState(null),[g,v]=R.useState(180),[b,M]=R.useState(!1),x=R.useRef(null),[S,T]=R.useState(()=>{const Z=localStorage.getItem("sidebar-expanded-categories");if(Z)try{const re=JSON.parse(Z);return Dr.reduce((V,j)=>(V[j.id]=re[j.id]!==void 0?re[j.id]:!0,V),{})}catch{}return Dr.reduce((re,V)=>(re[V.id]=!0,re),{})}),{favorites:E,collections:A,toggleFavorite:k,createCollection:D,renameCollection:L,deleteCollection:I,addComponentToCollection:U,removeComponentFromCollection:Q}=FN(),se=Z=>{T(re=>({...re,[Z]:!re[Z]}))},F=c.toLowerCase(),Y=R.useMemo(()=>Hr.filter(Z=>Z.label.toLowerCase().includes(F)),[F]),ae=R.useMemo(()=>Y.filter(Z=>E.includes(Z.id)),[E,Y]),de=(Z,re)=>{Z.dataTransfer.setData("application/json",JSON.stringify(re)),Z.dataTransfer.effectAllowed="copy"},z=()=>{d(null),i(!0)},$=Z=>{if(l)L(l.id,Z),d(null);else{if(A.some(j=>j.name.toLowerCase()===Z.toLowerCase())){alert("A collection with this name already exists");return}D(Z)||alert("Failed to create collection")}i(!1)},q=()=>{i(!1),d(null)},ee=Z=>{p(Z),d(null),o(!0)},me=Z=>{if(!h)return;if(A.some(j=>j.name.toLowerCase()===Z.toLowerCase())){alert("A collection with this name already exists");return}const V=D(Z);V?U(V,h):alert("Failed to create collection"),o(!1),p(null)},N=()=>{o(!1),p(null)},J=Z=>{d(Z),i(!0)};R.useEffect(()=>{localStorage.setItem("sidebar-expanded-categories",JSON.stringify(S))},[S]),R.useEffect(()=>{if(!b)return;const Z=V=>{if(!x.current)return;const j=x.current.closest(".h-full");if(!j)return;const ue=j.getBoundingClientRect();x.current.getBoundingClientRect();const fe=ue.bottom-V.clientY,ge=70,pe=ue.height*.8;v(Math.max(ge,Math.min(pe,fe)))},re=()=>{M(!1)};return document.addEventListener("mousemove",Z),document.addEventListener("mouseup",re),()=>{document.removeEventListener("mousemove",Z),document.removeEventListener("mouseup",re)}},[b]);const K=(Z,re)=>{const V=E.includes(Z.id);return y.jsxs("div",{draggable:!0,onDragStart:j=>de(j,Z),className:`flex items-center gap-1 px-1 ${re?.compact?"py-0.5 text-[10px]":"py-1 text-xs"} rounded-md bg-secondary/50 hover:bg-secondary cursor-move transition-colors border border-border/50`,children:[y.jsxs("div",{className:"flex items-center gap-0.5 flex-1 min-w-0",children:[y.jsx("span",{className:"text-sm flex-shrink-0",children:Z.icon}),y.jsx("span",{className:"text-foreground truncate min-w-0",children:Z.label})]}),y.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[y.jsx("button",{type:"button",onClick:j=>{j.preventDefault(),j.stopPropagation(),k(Z.id)},onMouseDown:j=>j.stopPropagation(),className:"p-1 rounded-md hover:bg-muted transition-colors",title:V?"Remove from favorites":"Add to favorites",children:y.jsx(nP,{className:`h-4 w-4 ${V?"text-yellow-400":"text-muted-foreground"}`,fill:V?"currentColor":"none"})}),y.jsxs(ON,{children:[y.jsx(qN,{asChild:!0,children:y.jsx("button",{type:"button",onMouseDown:j=>j.stopPropagation(),className:"p-1 rounded-md hover:bg-muted transition-colors",title:"Add to collection",children:y.jsx(Bl,{className:"h-4 w-4 text-muted-foreground"})})}),y.jsxs(OS,{align:"end",className:"w-48",children:[A.length===0&&y.jsxs(y.Fragment,{children:[y.jsx(Lf,{children:"No collections"}),y.jsxs(zl,{onSelect:j=>{j.preventDefault(),ee(Z.id)},children:[y.jsx(xf,{className:"h-4 w-4 mr-2"}),"Create and add"]})]}),A.length>0&&y.jsxs(y.Fragment,{children:[y.jsx(Lf,{children:"Add to collection"}),A.map(j=>y.jsx(zl,{onSelect:ue=>{ue.preventDefault(),U(j.id,Z.id)},children:j.name},j.id)),y.jsx(qS,{}),y.jsxs(zl,{onSelect:j=>{j.preventDefault(),ee(Z.id)},children:[y.jsx(xf,{className:"h-4 w-4 mr-2"}),"New collection"]})]})]})]}),re?.onRemove&&y.jsx("button",{type:"button",onClick:j=>{j.preventDefault(),j.stopPropagation(),re.onRemove?.()},onMouseDown:j=>j.stopPropagation(),className:"p-1 rounded-md hover:bg-muted transition-colors",title:"Remove from collection",children:y.jsx(cn,{className:"h-4 w-4 text-muted-foreground"})})]})]},`${Z.id}-${re?.compact?"compact":"default"}`)},ie=t==="all"?Dr:Dr.filter(Z=>Z.id===t);return y.jsxs("div",{className:"w-60 h-full bg-sidebar-bg border-r border-border flex flex-col",children:[y.jsxs("div",{className:"p-3 border-b border-border",children:[y.jsx("h2",{className:"text-xs font-semibold text-foreground mb-2",children:"Components"}),y.jsxs("div",{className:"relative",children:[y.jsx(Gr,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),y.jsx(ct,{type:"text",placeholder:"Search...",value:c,onChange:Z=>e(Z.target.value),className:"pl-7 h-8 text-xs"})]})]}),y.jsx("div",{className:"px-3 py-1.5 border-b border-border pb-2",children:y.jsx(Sp,{value:t,onValueChange:s,children:y.jsxs(ns,{orientation:"horizontal",className:"w-full",children:[y.jsxs(vu,{className:"flex w-max gap-0.5",children:[y.jsx(nn,{value:"all",className:"text-xs px-2 py-1",children:"All"}),Dr.map(Z=>y.jsx(nn,{value:Z.id,className:"text-xs px-2 py-1",children:Z.icon},Z.id))]}),y.jsx(au,{orientation:"horizontal",className:"data-[state=visible]:bg-accent/20 data-[state=visible]:hover:bg-accent/30 [&>[data-radix-scroll-area-thumb]]:bg-accent/80 hover:[&>[data-radix-scroll-area-thumb]]:bg-accent rounded-full",style:{transition:"none"}})]})})}),ae.length>0&&y.jsxs("div",{className:"px-3 py-2 border-b border-border",children:[y.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[y.jsx("span",{className:"text-[10px] font-semibold uppercase text-muted-foreground",children:"Favorites"}),y.jsx("span",{className:"text-[10px] text-muted-foreground",children:ae.length})]}),y.jsx("div",{className:"space-y-1",children:ae.map(Z=>K(Z,{compact:!0}))})]}),y.jsx(ns,{className:"flex-1",children:y.jsx("div",{className:"pl-3 pr-6 py-2",children:ie.map(Z=>{const re=Y.filter(V=>V.category===Z.id);return re.length===0&&c?null:y.jsxs("div",{className:"mb-1.5",children:[y.jsxs(De,{variant:"ghost",className:"w-full justify-start px-1 h-7 text-xs",onClick:()=>se(Z.id),children:[S[Z.id]?y.jsx(tu,{className:"h-3.5 w-3.5 mr-0.5"}):y.jsx(ep,{className:"h-3.5 w-3.5 mr-0.5"}),y.jsx("span",{className:"mr-1",children:Z.icon}),y.jsx("span",{className:"flex-1 text-left truncate min-w-0 mr-1",children:Z.label}),y.jsx("span",{className:"text-[10px] text-muted-foreground flex-shrink-0",children:re.length})]}),S[Z.id]&&y.jsx("div",{className:"ml-1.5 mt-1 space-y-1",children:re.map(V=>K(V,{compact:!0}))})]},Z.id)})})}),y.jsx("div",{ref:x,className:"h-2 border-t border-border cursor-row-resize hover:bg-accent/50 transition-colors relative group flex items-center justify-center",onMouseDown:Z=>{Z.preventDefault(),M(!0)},style:{userSelect:"none"},children:y.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:y.jsx(xD,{className:"h-3 w-3 text-muted-foreground"})})}),y.jsxs("div",{className:"border-t border-border overflow-hidden flex flex-col",style:{height:`${g}px`},children:[y.jsx("div",{className:"p-2 pb-1.5 flex-shrink-0",children:y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsx("span",{className:"text-[10px] uppercase font-semibold text-muted-foreground",children:"Collections"}),y.jsxs(De,{size:"xs",variant:"outline",className:"h-6 text-[10px] px-2",onClick:Z=>{Z.preventDefault(),Z.stopPropagation(),z()},type:"button",children:[y.jsx(Bl,{className:"h-3 w-3 mr-0.5"}),"New"]})]})}),y.jsx(ns,{className:"flex-1",children:y.jsx("div",{className:"pl-1.5 pr-4 pb-2 space-y-1.5",children:A.length===0?y.jsx("p",{className:"text-[10px] text-muted-foreground px-0.5",children:"Create collections to quickly build typical architectures."}):A.map(Z=>{const re=Z.componentIds.map(V=>Hr.find(j=>j.id===V)).filter(V=>!!V).filter(V=>V.label.toLowerCase().includes(F));return y.jsxs("div",{className:"rounded-md border border-border/60 p-1.5",children:[y.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsx("p",{className:"text-xs font-medium text-foreground truncate",children:Z.name}),y.jsxs("p",{className:"text-[10px] text-muted-foreground",children:[re.length," items"]})]}),y.jsxs("div",{className:"flex items-center gap-1",children:[y.jsx(De,{size:"icon",variant:"ghost",className:"h-7 w-7",title:"Rename",onClick:()=>J(Z),children:""}),y.jsx(De,{size:"icon",variant:"ghost",className:"h-7 w-7",title:"Delete collection",onClick:()=>I(Z.id),children:y.jsx(cn,{className:"h-4 w-4"})})]})]}),re.length===0?y.jsx("p",{className:"text-[10px] text-muted-foreground",children:'Add components via "+" menu.'}):y.jsx("div",{className:"space-y-1",children:re.map(V=>K(V,{compact:!0,onRemove:()=>Q(Z.id,V.id)}))})]},Z.id)})})})]}),y.jsx(Bv,{open:n,initialName:l?.name||"",onConfirm:$,onCancel:q}),y.jsx(Bv,{open:a,initialName:"",onConfirm:me,onCancel:N})]})}const ku=hn(c=>({tabs:[{id:"diagram-1",title:"Untitled Diagram",type:"diagram",active:!0}],addTab:e=>c(t=>{if(e.componentId){const n=t.tabs.find(i=>i.componentId===e.componentId);if(n)return{tabs:t.tabs.map(i=>({...i,active:i.id===n.id}))}}const s={...e,id:`${e.type}-${Date.now()}`,active:!0};return{tabs:[...t.tabs.map(n=>({...n,active:!1})),s]}}),closeTab:e=>c(t=>{const s=t.tabs.filter(a=>a.id!==e);if(s.length===0)return{tabs:[{id:"diagram-1",title:"Untitled Diagram",type:"diagram",active:!0}]};const n=t.tabs.findIndex(a=>a.id===e);if(t.tabs[n]?.active&&s.length>0){const a=Math.min(n,s.length-1);s[a].active=!0}return{tabs:s}}),setActiveTab:e=>c(t=>({tabs:t.tabs.map(s=>({...s,active:s.id===e}))})),updateTab:(e,t)=>c(s=>({tabs:s.tabs.map(n=>n.id===e?{...n,...t}:n)}))}));function VN(c){const e=GN(c),t=R.forwardRef((s,n)=>{const{children:i,...a}=s,o=R.Children.toArray(i),l=o.find(KN);if(l){const d=l.props.children,h=o.map(p=>p===l?R.Children.count(d)>1?R.Children.only(null):R.isValidElement(d)?d.props.children:null:p);return y.jsx(e,{...a,ref:n,children:R.isValidElement(d)?R.cloneElement(d,void 0,h):null})}return y.jsx(e,{...a,ref:n,children:i})});return t.displayName=`${c}.Slot`,t}function GN(c){const e=R.forwardRef((t,s)=>{const{children:n,...i}=t;if(R.isValidElement(n)){const a=XN(n),o=YN(i,n.props);return n.type!==R.Fragment&&(o.ref=s?An(s,a):a),R.cloneElement(n,o)}return R.Children.count(n)>1?R.Children.only(null):null});return e.displayName=`${c}.SlotClone`,e}var WN=Symbol("radix.slottable");function KN(c){return R.isValidElement(c)&&typeof c.type=="function"&&"__radixId"in c.type&&c.type.__radixId===WN}function YN(c,e){const t={...e};for(const s in e){const n=c[s],i=e[s];/^on[A-Z]/.test(s)?n&&i?t[s]=(...o)=>{const l=i(...o);return n(...o),l}:n&&(t[s]=n):s==="style"?t[s]={...n,...i}:s==="className"&&(t[s]=[n,i].filter(Boolean).join(" "))}return{...c,...t}}function XN(c){let e=Object.getOwnPropertyDescriptor(c.props,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning;return t?c.ref:(e=Object.getOwnPropertyDescriptor(c,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning,t?c.props.ref:c.props.ref||c.ref)}function Au(c){const e=R.useRef({value:c,previous:c});return R.useMemo(()=>(e.current.value!==c&&(e.current.previous=e.current.value,e.current.value=c),e.current.previous),[c])}var $S=Object.freeze({position:"absolute",border:0,width:1,height:1,padding:0,margin:-1,overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",wordWrap:"normal"}),JN="VisuallyHidden",BS=R.forwardRef((c,e)=>y.jsx(Le.span,{...c,ref:e,style:{...$S,...c.style}}));BS.displayName=JN;var R3=BS,ZN=[" ","Enter","ArrowUp","ArrowDown"],ez=[" ","Enter"],Ra="Select",[Du,Pu,tz]=gu(Ra),[zo]=ws(Ra,[tz,No]),Lu=No(),[sz,Fi]=zo(Ra),[nz,iz]=zo(Ra),US=c=>{const{__scopeSelect:e,children:t,open:s,defaultOpen:n,onOpenChange:i,value:a,defaultValue:o,onValueChange:l,dir:d,name:h,autoComplete:p,disabled:g,required:v,form:b}=c,M=Lu(e),[x,S]=R.useState(null),[T,E]=R.useState(null),[A,k]=R.useState(!1),D=Lo(d),[L,I]=En({prop:s,defaultProp:n??!1,onChange:i,caller:Ra}),[U,Q]=En({prop:a,defaultProp:o,onChange:l,caller:Ra}),se=R.useRef(null),F=x?b||!!x.closest("form"):!0,[Y,ae]=R.useState(new Set),de=Array.from(Y).map(z=>z.props.value).join(";");return y.jsx(Pp,{...M,children:y.jsxs(sz,{required:v,scope:e,trigger:x,onTriggerChange:S,valueNode:T,onValueNodeChange:E,valueNodeHasChildren:A,onValueNodeHasChildrenChange:k,contentId:ln(),value:U,onValueChange:Q,open:L,onOpenChange:I,dir:D,triggerPointerDownPosRef:se,disabled:g,children:[y.jsx(Du.Provider,{scope:e,children:y.jsx(nz,{scope:c.__scopeSelect,onNativeOptionAdd:R.useCallback(z=>{ae($=>new Set($).add(z))},[]),onNativeOptionRemove:R.useCallback(z=>{ae($=>{const q=new Set($);return q.delete(z),q})},[]),children:t})}),F?y.jsxs(fx,{"aria-hidden":!0,required:v,tabIndex:-1,name:h,autoComplete:p,value:U,onChange:z=>Q(z.target.value),disabled:g,form:b,children:[U===void 0?y.jsx("option",{value:""}):null,Array.from(Y)]},de):null]})})};US.displayName=Ra;var FS="SelectTrigger",QS=R.forwardRef((c,e)=>{const{__scopeSelect:t,disabled:s=!1,...n}=c,i=Lu(t),a=Fi(FS,t),o=a.disabled||s,l=Ne(e,a.onTriggerChange),d=Pu(t),h=R.useRef("touch"),[p,g,v]=gx(M=>{const x=d().filter(E=>!E.disabled),S=x.find(E=>E.value===a.value),T=mx(x,M,S);T!==void 0&&a.onValueChange(T.value)}),b=M=>{o||(a.onOpenChange(!0),v()),M&&(a.triggerPointerDownPosRef.current={x:Math.round(M.pageX),y:Math.round(M.pageY)})};return y.jsx(Cu,{asChild:!0,...i,children:y.jsx(Le.button,{type:"button",role:"combobox","aria-controls":a.contentId,"aria-expanded":a.open,"aria-required":a.required,"aria-autocomplete":"none",dir:a.dir,"data-state":a.open?"open":"closed",disabled:o,"data-disabled":o?"":void 0,"data-placeholder":px(a.value)?"":void 0,...n,ref:l,onClick:be(n.onClick,M=>{M.currentTarget.focus(),h.current!=="mouse"&&b(M)}),onPointerDown:be(n.onPointerDown,M=>{h.current=M.pointerType;const x=M.target;x.hasPointerCapture(M.pointerId)&&x.releasePointerCapture(M.pointerId),M.button===0&&M.ctrlKey===!1&&M.pointerType==="mouse"&&(b(M),M.preventDefault())}),onKeyDown:be(n.onKeyDown,M=>{const x=p.current!=="";!(M.ctrlKey||M.altKey||M.metaKey)&&M.key.length===1&&g(M.key),!(x&&M.key===" ")&&ZN.includes(M.key)&&(b(),M.preventDefault())})})})});QS.displayName=FS;var VS="SelectValue",GS=R.forwardRef((c,e)=>{const{__scopeSelect:t,className:s,style:n,children:i,placeholder:a="",...o}=c,l=Fi(VS,t),{onValueNodeHasChildrenChange:d}=l,h=i!==void 0,p=Ne(e,l.onValueNodeChange);return as(()=>{d(h)},[d,h]),y.jsx(Le.span,{...o,ref:p,style:{pointerEvents:"none"},children:px(l.value)?y.jsx(y.Fragment,{children:a}):i})});GS.displayName=VS;var az="SelectIcon",WS=R.forwardRef((c,e)=>{const{__scopeSelect:t,children:s,...n}=c;return y.jsx(Le.span,{"aria-hidden":!0,...n,ref:e,children:s||""})});WS.displayName=az;var oz="SelectPortal",KS=c=>y.jsx(Xr,{asChild:!0,...c});KS.displayName=oz;var Ta="SelectContent",YS=R.forwardRef((c,e)=>{const t=Fi(Ta,c.__scopeSelect),[s,n]=R.useState();if(as(()=>{n(new DocumentFragment)},[]),!t.open){const i=s;return i?Vr.createPortal(y.jsx(XS,{scope:c.__scopeSelect,children:y.jsx(Du.Slot,{scope:c.__scopeSelect,children:y.jsx("div",{children:c.children})})}),i):null}return y.jsx(JS,{...c,ref:e})});YS.displayName=Ta;var sn=10,[XS,Qi]=zo(Ta),rz="SelectContentImpl",cz=VN("SelectContent.RemoveScroll"),JS=R.forwardRef((c,e)=>{const{__scopeSelect:t,position:s="item-aligned",onCloseAutoFocus:n,onEscapeKeyDown:i,onPointerDownOutside:a,side:o,sideOffset:l,align:d,alignOffset:h,arrowPadding:p,collisionBoundary:g,collisionPadding:v,sticky:b,hideWhenDetached:M,avoidCollisions:x,...S}=c,T=Fi(Ta,t),[E,A]=R.useState(null),[k,D]=R.useState(null),L=Ne(e,V=>A(V)),[I,U]=R.useState(null),[Q,se]=R.useState(null),F=Pu(t),[Y,ae]=R.useState(!1),de=R.useRef(!1);R.useEffect(()=>{if(E)return cu(E)},[E]),ou();const z=R.useCallback(V=>{const[j,...ue]=F().map(pe=>pe.ref.current),[fe]=ue.slice(-1),ge=document.activeElement;for(const pe of V)if(pe===ge||(pe?.scrollIntoView({block:"nearest"}),pe===j&&k&&(k.scrollTop=0),pe===fe&&k&&(k.scrollTop=k.scrollHeight),pe?.focus(),document.activeElement!==ge))return},[F,k]),$=R.useCallback(()=>z([I,E]),[z,I,E]);R.useEffect(()=>{Y&&$()},[Y,$]);const{onOpenChange:q,triggerPointerDownPosRef:ee}=T;R.useEffect(()=>{if(E){let V={x:0,y:0};const j=fe=>{V={x:Math.abs(Math.round(fe.pageX)-(ee.current?.x??0)),y:Math.abs(Math.round(fe.pageY)-(ee.current?.y??0))}},ue=fe=>{V.x<=10&&V.y<=10?fe.preventDefault():E.contains(fe.target)||q(!1),document.removeEventListener("pointermove",j),ee.current=null};return ee.current!==null&&(document.addEventListener("pointermove",j),document.addEventListener("pointerup",ue,{capture:!0,once:!0})),()=>{document.removeEventListener("pointermove",j),document.removeEventListener("pointerup",ue,{capture:!0})}}},[E,q,ee]),R.useEffect(()=>{const V=()=>q(!1);return window.addEventListener("blur",V),window.addEventListener("resize",V),()=>{window.removeEventListener("blur",V),window.removeEventListener("resize",V)}},[q]);const[me,N]=gx(V=>{const j=F().filter(ge=>!ge.disabled),ue=j.find(ge=>ge.ref.current===document.activeElement),fe=mx(j,V,ue);fe&&setTimeout(()=>fe.ref.current.focus())}),J=R.useCallback((V,j,ue)=>{const fe=!de.current&&!ue;(T.value!==void 0&&T.value===j||fe)&&(U(V),fe&&(de.current=!0))},[T.value]),K=R.useCallback(()=>E?.focus(),[E]),ie=R.useCallback((V,j,ue)=>{const fe=!de.current&&!ue;(T.value!==void 0&&T.value===j||fe)&&se(V)},[T.value]),Z=s==="popper"?_f:ZS,re=Z===_f?{side:o,sideOffset:l,align:d,alignOffset:h,arrowPadding:p,collisionBoundary:g,collisionPadding:v,sticky:b,hideWhenDetached:M,avoidCollisions:x}:{};return y.jsx(XS,{scope:t,content:E,viewport:k,onViewportChange:D,itemRefCallback:J,selectedItem:I,onItemLeave:K,itemTextRefCallback:ie,focusSelectedItem:$,selectedItemText:Q,position:s,isPositioned:Y,searchRef:me,children:y.jsx(Jr,{as:cz,allowPinchZoom:!0,children:y.jsx(Yr,{asChild:!0,trapped:T.open,onMountAutoFocus:V=>{V.preventDefault()},onUnmountAutoFocus:be(n,V=>{T.trigger?.focus({preventScroll:!0}),V.preventDefault()}),children:y.jsx(Kr,{asChild:!0,disableOutsidePointerEvents:!0,onEscapeKeyDown:i,onPointerDownOutside:a,onFocusOutside:V=>V.preventDefault(),onDismiss:()=>T.onOpenChange(!1),children:y.jsx(Z,{role:"listbox",id:T.contentId,"data-state":T.open?"open":"closed",dir:T.dir,onContextMenu:V=>V.preventDefault(),...S,...re,onPlaced:()=>ae(!0),ref:L,style:{display:"flex",flexDirection:"column",outline:"none",...S.style},onKeyDown:be(S.onKeyDown,V=>{const j=V.ctrlKey||V.altKey||V.metaKey;if(V.key==="Tab"&&V.preventDefault(),!j&&V.key.length===1&&N(V.key),["ArrowUp","ArrowDown","Home","End"].includes(V.key)){let fe=F().filter(ge=>!ge.disabled).map(ge=>ge.ref.current);if(["ArrowUp","End"].includes(V.key)&&(fe=fe.slice().reverse()),["ArrowUp","ArrowDown"].includes(V.key)){const ge=V.target,pe=fe.indexOf(ge);fe=fe.slice(pe+1)}setTimeout(()=>z(fe)),V.preventDefault()}})})})})})})});JS.displayName=rz;var lz="SelectItemAlignedPosition",ZS=R.forwardRef((c,e)=>{const{__scopeSelect:t,onPlaced:s,...n}=c,i=Fi(Ta,t),a=Qi(Ta,t),[o,l]=R.useState(null),[d,h]=R.useState(null),p=Ne(e,L=>h(L)),g=Pu(t),v=R.useRef(!1),b=R.useRef(!0),{viewport:M,selectedItem:x,selectedItemText:S,focusSelectedItem:T}=a,E=R.useCallback(()=>{if(i.trigger&&i.valueNode&&o&&d&&M&&x&&S){const L=i.trigger.getBoundingClientRect(),I=d.getBoundingClientRect(),U=i.valueNode.getBoundingClientRect(),Q=S.getBoundingClientRect();if(i.dir!=="rtl"){const ge=Q.left-I.left,pe=U.left-ge,we=L.left-pe,Re=L.width+we,tt=Math.max(Re,I.width),ze=window.innerWidth-sn,Ct=qr(pe,[sn,Math.max(sn,ze-tt)]);o.style.minWidth=Re+"px",o.style.left=Ct+"px"}else{const ge=I.right-Q.right,pe=window.innerWidth-U.right-ge,we=window.innerWidth-L.right-pe,Re=L.width+we,tt=Math.max(Re,I.width),ze=window.innerWidth-sn,Ct=qr(pe,[sn,Math.max(sn,ze-tt)]);o.style.minWidth=Re+"px",o.style.right=Ct+"px"}const se=g(),F=window.innerHeight-sn*2,Y=M.scrollHeight,ae=window.getComputedStyle(d),de=parseInt(ae.borderTopWidth,10),z=parseInt(ae.paddingTop,10),$=parseInt(ae.borderBottomWidth,10),q=parseInt(ae.paddingBottom,10),ee=de+z+Y+q+$,me=Math.min(x.offsetHeight*5,ee),N=window.getComputedStyle(M),J=parseInt(N.paddingTop,10),K=parseInt(N.paddingBottom,10),ie=L.top+L.height/2-sn,Z=F-ie,re=x.offsetHeight/2,V=x.offsetTop+re,j=de+z+V,ue=ee-j;if(j<=ie){const ge=se.length>0&&x===se[se.length-1].ref.current;o.style.bottom="0px";const pe=d.clientHeight-M.offsetTop-M.offsetHeight,we=Math.max(Z,re+(ge?K:0)+pe+$),Re=j+we;o.style.height=Re+"px"}else{const ge=se.length>0&&x===se[0].ref.current;o.style.top="0px";const we=Math.max(ie,de+M.offsetTop+(ge?J:0)+re)+ue;o.style.height=we+"px",M.scrollTop=j-ie+M.offsetTop}o.style.margin=`${sn}px 0`,o.style.minHeight=me+"px",o.style.maxHeight=F+"px",s?.(),requestAnimationFrame(()=>v.current=!0)}},[g,i.trigger,i.valueNode,o,d,M,x,S,i.dir,s]);as(()=>E(),[E]);const[A,k]=R.useState();as(()=>{d&&k(window.getComputedStyle(d).zIndex)},[d]);const D=R.useCallback(L=>{L&&b.current===!0&&(E(),T?.(),b.current=!1)},[E,T]);return y.jsx(dz,{scope:t,contentWrapper:o,shouldExpandOnScrollRef:v,onScrollButtonChange:D,children:y.jsx("div",{ref:l,style:{display:"flex",flexDirection:"column",position:"fixed",zIndex:A},children:y.jsx(Le.div,{...n,ref:p,style:{boxSizing:"border-box",maxHeight:"100%",...n.style}})})})});ZS.displayName=lz;var uz="SelectPopperPosition",_f=R.forwardRef((c,e)=>{const{__scopeSelect:t,align:s="start",collisionPadding:n=sn,...i}=c,a=Lu(t);return y.jsx(Lp,{...a,...i,ref:e,align:s,collisionPadding:n,style:{boxSizing:"border-box",...i.style,"--radix-select-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-select-content-available-width":"var(--radix-popper-available-width)","--radix-select-content-available-height":"var(--radix-popper-available-height)","--radix-select-trigger-width":"var(--radix-popper-anchor-width)","--radix-select-trigger-height":"var(--radix-popper-anchor-height)"}})});_f.displayName=uz;var[dz,$p]=zo(Ta,{}),If="SelectViewport",ex=R.forwardRef((c,e)=>{const{__scopeSelect:t,nonce:s,...n}=c,i=Qi(If,t),a=$p(If,t),o=Ne(e,i.onViewportChange),l=R.useRef(0);return y.jsxs(y.Fragment,{children:[y.jsx("style",{dangerouslySetInnerHTML:{__html:"[data-radix-select-viewport]{scrollbar-width:none;-ms-overflow-style:none;-webkit-overflow-scrolling:touch;}[data-radix-select-viewport]::-webkit-scrollbar{display:none}"},nonce:s}),y.jsx(Du.Slot,{scope:t,children:y.jsx(Le.div,{"data-radix-select-viewport":"",role:"presentation",...n,ref:o,style:{position:"relative",flex:1,overflow:"hidden auto",...n.style},onScroll:be(n.onScroll,d=>{const h=d.currentTarget,{contentWrapper:p,shouldExpandOnScrollRef:g}=a;if(g?.current&&p){const v=Math.abs(l.current-h.scrollTop);if(v>0){const b=window.innerHeight-sn*2,M=parseFloat(p.style.minHeight),x=parseFloat(p.style.height),S=Math.max(M,x);if(S<b){const T=S+v,E=Math.min(b,T),A=T-E;p.style.height=E+"px",p.style.bottom==="0px"&&(h.scrollTop=A>0?A:0,p.style.justifyContent="flex-end")}}}l.current=h.scrollTop})})})]})});ex.displayName=If;var tx="SelectGroup",[hz,fz]=zo(tx),pz=R.forwardRef((c,e)=>{const{__scopeSelect:t,...s}=c,n=ln();return y.jsx(hz,{scope:t,id:n,children:y.jsx(Le.div,{role:"group","aria-labelledby":n,...s,ref:e})})});pz.displayName=tx;var sx="SelectLabel",nx=R.forwardRef((c,e)=>{const{__scopeSelect:t,...s}=c,n=fz(sx,t);return y.jsx(Le.div,{id:n.id,...s,ref:e})});nx.displayName=sx;var Jl="SelectItem",[gz,ix]=zo(Jl),ax=R.forwardRef((c,e)=>{const{__scopeSelect:t,value:s,disabled:n=!1,textValue:i,...a}=c,o=Fi(Jl,t),l=Qi(Jl,t),d=o.value===s,[h,p]=R.useState(i??""),[g,v]=R.useState(!1),b=Ne(e,T=>l.itemRefCallback?.(T,s,n)),M=ln(),x=R.useRef("touch"),S=()=>{n||(o.onValueChange(s),o.onOpenChange(!1))};if(s==="")throw new Error("A <Select.Item /> must have a value prop that is not an empty string. This is because the Select value can be set to an empty string to clear the selection and show the placeholder.");return y.jsx(gz,{scope:t,value:s,disabled:n,textId:M,isSelected:d,onItemTextChange:R.useCallback(T=>{p(E=>E||(T?.textContent??"").trim())},[]),children:y.jsx(Du.ItemSlot,{scope:t,value:s,disabled:n,textValue:h,children:y.jsx(Le.div,{role:"option","aria-labelledby":M,"data-highlighted":g?"":void 0,"aria-selected":d&&g,"data-state":d?"checked":"unchecked","aria-disabled":n||void 0,"data-disabled":n?"":void 0,tabIndex:n?void 0:-1,...a,ref:b,onFocus:be(a.onFocus,()=>v(!0)),onBlur:be(a.onBlur,()=>v(!1)),onClick:be(a.onClick,()=>{x.current!=="mouse"&&S()}),onPointerUp:be(a.onPointerUp,()=>{x.current==="mouse"&&S()}),onPointerDown:be(a.onPointerDown,T=>{x.current=T.pointerType}),onPointerMove:be(a.onPointerMove,T=>{x.current=T.pointerType,n?l.onItemLeave?.():x.current==="mouse"&&T.currentTarget.focus({preventScroll:!0})}),onPointerLeave:be(a.onPointerLeave,T=>{T.currentTarget===document.activeElement&&l.onItemLeave?.()}),onKeyDown:be(a.onKeyDown,T=>{l.searchRef?.current!==""&&T.key===" "||(ez.includes(T.key)&&S(),T.key===" "&&T.preventDefault())})})})})});ax.displayName=Jl;var Ir="SelectItemText",ox=R.forwardRef((c,e)=>{const{__scopeSelect:t,className:s,style:n,...i}=c,a=Fi(Ir,t),o=Qi(Ir,t),l=ix(Ir,t),d=iz(Ir,t),[h,p]=R.useState(null),g=Ne(e,S=>p(S),l.onItemTextChange,S=>o.itemTextRefCallback?.(S,l.value,l.disabled)),v=h?.textContent,b=R.useMemo(()=>y.jsx("option",{value:l.value,disabled:l.disabled,children:v},l.value),[l.disabled,l.value,v]),{onNativeOptionAdd:M,onNativeOptionRemove:x}=d;return as(()=>(M(b),()=>x(b)),[M,x,b]),y.jsxs(y.Fragment,{children:[y.jsx(Le.span,{id:l.textId,...i,ref:g}),l.isSelected&&a.valueNode&&!a.valueNodeHasChildren?Vr.createPortal(i.children,a.valueNode):null]})});ox.displayName=Ir;var rx="SelectItemIndicator",cx=R.forwardRef((c,e)=>{const{__scopeSelect:t,...s}=c;return ix(rx,t).isSelected?y.jsx(Le.span,{"aria-hidden":!0,...s,ref:e}):null});cx.displayName=rx;var Nf="SelectScrollUpButton",lx=R.forwardRef((c,e)=>{const t=Qi(Nf,c.__scopeSelect),s=$p(Nf,c.__scopeSelect),[n,i]=R.useState(!1),a=Ne(e,s.onScrollButtonChange);return as(()=>{if(t.viewport&&t.isPositioned){let o=function(){const d=l.scrollTop>0;i(d)};const l=t.viewport;return o(),l.addEventListener("scroll",o),()=>l.removeEventListener("scroll",o)}},[t.viewport,t.isPositioned]),n?y.jsx(dx,{...c,ref:a,onAutoScroll:()=>{const{viewport:o,selectedItem:l}=t;o&&l&&(o.scrollTop=o.scrollTop-l.offsetHeight)}}):null});lx.displayName=Nf;var zf="SelectScrollDownButton",ux=R.forwardRef((c,e)=>{const t=Qi(zf,c.__scopeSelect),s=$p(zf,c.__scopeSelect),[n,i]=R.useState(!1),a=Ne(e,s.onScrollButtonChange);return as(()=>{if(t.viewport&&t.isPositioned){let o=function(){const d=l.scrollHeight-l.clientHeight,h=Math.ceil(l.scrollTop)<d;i(h)};const l=t.viewport;return o(),l.addEventListener("scroll",o),()=>l.removeEventListener("scroll",o)}},[t.viewport,t.isPositioned]),n?y.jsx(dx,{...c,ref:a,onAutoScroll:()=>{const{viewport:o,selectedItem:l}=t;o&&l&&(o.scrollTop=o.scrollTop+l.offsetHeight)}}):null});ux.displayName=zf;var dx=R.forwardRef((c,e)=>{const{__scopeSelect:t,onAutoScroll:s,...n}=c,i=Qi("SelectScrollButton",t),a=R.useRef(null),o=Pu(t),l=R.useCallback(()=>{a.current!==null&&(window.clearInterval(a.current),a.current=null)},[]);return R.useEffect(()=>()=>l(),[l]),as(()=>{o().find(h=>h.ref.current===document.activeElement)?.ref.current?.scrollIntoView({block:"nearest"})},[o]),y.jsx(Le.div,{"aria-hidden":!0,...n,ref:e,style:{flexShrink:0,...n.style},onPointerDown:be(n.onPointerDown,()=>{a.current===null&&(a.current=window.setInterval(s,50))}),onPointerMove:be(n.onPointerMove,()=>{i.onItemLeave?.(),a.current===null&&(a.current=window.setInterval(s,50))}),onPointerLeave:be(n.onPointerLeave,()=>{l()})})}),mz="SelectSeparator",hx=R.forwardRef((c,e)=>{const{__scopeSelect:t,...s}=c;return y.jsx(Le.div,{"aria-hidden":!0,...s,ref:e})});hx.displayName=mz;var jf="SelectArrow",yz=R.forwardRef((c,e)=>{const{__scopeSelect:t,...s}=c,n=Lu(t),i=Fi(jf,t),a=Qi(jf,t);return i.open&&a.position==="popper"?y.jsx(_p,{...n,...s,ref:e}):null});yz.displayName=jf;var vz="SelectBubbleInput",fx=R.forwardRef(({__scopeSelect:c,value:e,...t},s)=>{const n=R.useRef(null),i=Ne(s,n),a=Au(e);return R.useEffect(()=>{const o=n.current;if(!o)return;const l=window.HTMLSelectElement.prototype,h=Object.getOwnPropertyDescriptor(l,"value").set;if(a!==e&&h){const p=new Event("change",{bubbles:!0});h.call(o,e),o.dispatchEvent(p)}},[a,e]),y.jsx(Le.select,{...t,style:{...$S,...t.style},ref:i,defaultValue:e})});fx.displayName=vz;function px(c){return c===""||c===void 0}function gx(c){const e=is(c),t=R.useRef(""),s=R.useRef(0),n=R.useCallback(a=>{const o=t.current+a;e(o),(function l(d){t.current=d,window.clearTimeout(s.current),d!==""&&(s.current=window.setTimeout(()=>l(""),1e3))})(o)},[e]),i=R.useCallback(()=>{t.current="",window.clearTimeout(s.current)},[]);return R.useEffect(()=>()=>window.clearTimeout(s.current),[]),[t,n,i]}function mx(c,e,t){const n=e.length>1&&Array.from(e).every(d=>d===e[0])?e[0]:e,i=t?c.indexOf(t):-1;let a=bz(c,Math.max(i,0));n.length===1&&(a=a.filter(d=>d!==t));const l=a.find(d=>d.textValue.toLowerCase().startsWith(n.toLowerCase()));return l!==t?l:void 0}function bz(c,e){return c.map((t,s)=>c[(e+s)%c.length])}var Mz=US,yx=QS,wz=GS,Sz=WS,xz=KS,vx=YS,Cz=ex,bx=nx,Mx=ax,Rz=ox,Tz=cx,wx=lx,Sx=ux,xx=hx;const ji=Mz,Oi=wz,ni=R.forwardRef(({className:c,children:e,...t},s)=>y.jsxs(yx,{ref:s,className:Ae("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",c),...t,children:[e,y.jsx(Sz,{asChild:!0,children:y.jsx(tu,{className:"h-4 w-4 opacity-50"})})]}));ni.displayName=yx.displayName;const Cx=R.forwardRef(({className:c,...e},t)=>y.jsx(wx,{ref:t,className:Ae("flex cursor-default items-center justify-center py-1",c),...e,children:y.jsx(_b,{className:"h-4 w-4"})}));Cx.displayName=wx.displayName;const Rx=R.forwardRef(({className:c,...e},t)=>y.jsx(Sx,{ref:t,className:Ae("flex cursor-default items-center justify-center py-1",c),...e,children:y.jsx(tu,{className:"h-4 w-4"})}));Rx.displayName=Sx.displayName;const ii=R.forwardRef(({className:c,children:e,position:t="popper",...s},n)=>y.jsx(xz,{children:y.jsxs(vx,{ref:n,className:Ae("relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",c),position:t,...s,children:[y.jsx(Cx,{}),y.jsx(Cz,{className:Ae("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),y.jsx(Rx,{})]})}));ii.displayName=vx.displayName;const Ez=R.forwardRef(({className:c,...e},t)=>y.jsx(bx,{ref:t,className:Ae("px-2 py-1.5 text-sm font-semibold",c),...e}));Ez.displayName=bx.displayName;const Ge=R.forwardRef(({className:c,children:e,...t},s)=>y.jsxs(Mx,{ref:s,className:Ae("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",c),...t,children:[y.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center",children:y.jsx(Tz,{children:y.jsx(Zf,{className:"h-4 w-4"})})}),y.jsx(Rz,{children:e})]}));Ge.displayName=Mx.displayName;const kz=R.forwardRef(({className:c,...e},t)=>y.jsx(xx,{ref:t,className:Ae("-mx-1 my-1 h-px bg-muted",c),...e}));kz.displayName=xx.displayName;var Tx=["PageUp","PageDown"],Ex=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],kx={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},jo="Slider",[Of,Az,Dz]=gu(jo),[Ax]=ws(jo,[Dz]),[Pz,_u]=Ax(jo),Dx=R.forwardRef((c,e)=>{const{name:t,min:s=0,max:n=100,step:i=1,orientation:a="horizontal",disabled:o=!1,minStepsBetweenThumbs:l=0,defaultValue:d=[s],value:h,onValueChange:p=()=>{},onValueCommit:g=()=>{},inverted:v=!1,form:b,...M}=c,x=R.useRef(new Set),S=R.useRef(0),E=a==="horizontal"?Lz:_z,[A=[],k]=En({prop:h,defaultProp:d,onChange:se=>{[...x.current][S.current]?.focus(),p(se)}}),D=R.useRef(A);function L(se){const F=Oz(A,se);Q(se,F)}function I(se){Q(se,S.current)}function U(){const se=D.current[S.current];A[S.current]!==se&&g(A)}function Q(se,F,{commit:Y}={commit:!1}){const ae=Bz(i),de=Uz(Math.round((se-s)/i)*i+s,ae),z=qr(de,[s,n]);k(($=[])=>{const q=zz($,z,F);if($z(q,l*i)){S.current=q.indexOf(z);const ee=String(q)!==String($);return ee&&Y&&g(q),ee?q:$}else return $})}return y.jsx(Pz,{scope:c.__scopeSlider,name:t,disabled:o,min:s,max:n,valueIndexToChangeRef:S,thumbs:x.current,values:A,orientation:a,form:b,children:y.jsx(Of.Provider,{scope:c.__scopeSlider,children:y.jsx(Of.Slot,{scope:c.__scopeSlider,children:y.jsx(E,{"aria-disabled":o,"data-disabled":o?"":void 0,...M,ref:e,onPointerDown:be(M.onPointerDown,()=>{o||(D.current=A)}),min:s,max:n,inverted:v,onSlideStart:o?void 0:L,onSlideMove:o?void 0:I,onSlideEnd:o?void 0:U,onHomeKeyDown:()=>!o&&Q(s,0,{commit:!0}),onEndKeyDown:()=>!o&&Q(n,A.length-1,{commit:!0}),onStepKeyDown:({event:se,direction:F})=>{if(!o){const de=Tx.includes(se.key)||se.shiftKey&&Ex.includes(se.key)?10:1,z=S.current,$=A[z],q=i*de*F;Q($+q,z,{commit:!0})}}})})})})});Dx.displayName=jo;var[Px,Lx]=Ax(jo,{startEdge:"left",endEdge:"right",size:"width",direction:1}),Lz=R.forwardRef((c,e)=>{const{min:t,max:s,dir:n,inverted:i,onSlideStart:a,onSlideMove:o,onSlideEnd:l,onStepKeyDown:d,...h}=c,[p,g]=R.useState(null),v=Ne(e,E=>g(E)),b=R.useRef(void 0),M=Lo(n),x=M==="ltr",S=x&&!i||!x&&i;function T(E){const A=b.current||p.getBoundingClientRect(),k=[0,A.width],L=Bp(k,S?[t,s]:[s,t]);return b.current=A,L(E-A.left)}return y.jsx(Px,{scope:c.__scopeSlider,startEdge:S?"left":"right",endEdge:S?"right":"left",direction:S?1:-1,size:"width",children:y.jsx(_x,{dir:M,"data-orientation":"horizontal",...h,ref:v,style:{...h.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:E=>{const A=T(E.clientX);a?.(A)},onSlideMove:E=>{const A=T(E.clientX);o?.(A)},onSlideEnd:()=>{b.current=void 0,l?.()},onStepKeyDown:E=>{const k=kx[S?"from-left":"from-right"].includes(E.key);d?.({event:E,direction:k?-1:1})}})})}),_z=R.forwardRef((c,e)=>{const{min:t,max:s,inverted:n,onSlideStart:i,onSlideMove:a,onSlideEnd:o,onStepKeyDown:l,...d}=c,h=R.useRef(null),p=Ne(e,h),g=R.useRef(void 0),v=!n;function b(M){const x=g.current||h.current.getBoundingClientRect(),S=[0,x.height],E=Bp(S,v?[s,t]:[t,s]);return g.current=x,E(M-x.top)}return y.jsx(Px,{scope:c.__scopeSlider,startEdge:v?"bottom":"top",endEdge:v?"top":"bottom",size:"height",direction:v?1:-1,children:y.jsx(_x,{"data-orientation":"vertical",...d,ref:p,style:{...d.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:M=>{const x=b(M.clientY);i?.(x)},onSlideMove:M=>{const x=b(M.clientY);a?.(x)},onSlideEnd:()=>{g.current=void 0,o?.()},onStepKeyDown:M=>{const S=kx[v?"from-bottom":"from-top"].includes(M.key);l?.({event:M,direction:S?-1:1})}})})}),_x=R.forwardRef((c,e)=>{const{__scopeSlider:t,onSlideStart:s,onSlideMove:n,onSlideEnd:i,onHomeKeyDown:a,onEndKeyDown:o,onStepKeyDown:l,...d}=c,h=_u(jo,t);return y.jsx(Le.span,{...d,ref:e,onKeyDown:be(c.onKeyDown,p=>{p.key==="Home"?(a(p),p.preventDefault()):p.key==="End"?(o(p),p.preventDefault()):Tx.concat(Ex).includes(p.key)&&(l(p),p.preventDefault())}),onPointerDown:be(c.onPointerDown,p=>{const g=p.target;g.setPointerCapture(p.pointerId),p.preventDefault(),h.thumbs.has(g)?g.focus():s(p)}),onPointerMove:be(c.onPointerMove,p=>{p.target.hasPointerCapture(p.pointerId)&&n(p)}),onPointerUp:be(c.onPointerUp,p=>{const g=p.target;g.hasPointerCapture(p.pointerId)&&(g.releasePointerCapture(p.pointerId),i(p))})})}),Ix="SliderTrack",Nx=R.forwardRef((c,e)=>{const{__scopeSlider:t,...s}=c,n=_u(Ix,t);return y.jsx(Le.span,{"data-disabled":n.disabled?"":void 0,"data-orientation":n.orientation,...s,ref:e})});Nx.displayName=Ix;var qf="SliderRange",zx=R.forwardRef((c,e)=>{const{__scopeSlider:t,...s}=c,n=_u(qf,t),i=Lx(qf,t),a=R.useRef(null),o=Ne(e,a),l=n.values.length,d=n.values.map(g=>qx(g,n.min,n.max)),h=l>1?Math.min(...d):0,p=100-Math.max(...d);return y.jsx(Le.span,{"data-orientation":n.orientation,"data-disabled":n.disabled?"":void 0,...s,ref:o,style:{...c.style,[i.startEdge]:h+"%",[i.endEdge]:p+"%"}})});zx.displayName=qf;var Hf="SliderThumb",jx=R.forwardRef((c,e)=>{const t=Az(c.__scopeSlider),[s,n]=R.useState(null),i=Ne(e,o=>n(o)),a=R.useMemo(()=>s?t().findIndex(o=>o.ref.current===s):-1,[t,s]);return y.jsx(Iz,{...c,ref:i,index:a})}),Iz=R.forwardRef((c,e)=>{const{__scopeSlider:t,index:s,name:n,...i}=c,a=_u(Hf,t),o=Lx(Hf,t),[l,d]=R.useState(null),h=Ne(e,T=>d(T)),p=l?a.form||!!l.closest("form"):!0,g=xu(l),v=a.values[s],b=v===void 0?0:qx(v,a.min,a.max),M=jz(s,a.values.length),x=g?.[o.size],S=x?qz(x,b,o.direction):0;return R.useEffect(()=>{if(l)return a.thumbs.add(l),()=>{a.thumbs.delete(l)}},[l,a.thumbs]),y.jsxs("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[o.startEdge]:`calc(${b}% + ${S}px)`},children:[y.jsx(Of.ItemSlot,{scope:c.__scopeSlider,children:y.jsx(Le.span,{role:"slider","aria-label":c["aria-label"]||M,"aria-valuemin":a.min,"aria-valuenow":v,"aria-valuemax":a.max,"aria-orientation":a.orientation,"data-orientation":a.orientation,"data-disabled":a.disabled?"":void 0,tabIndex:a.disabled?void 0:0,...i,ref:h,style:v===void 0?{display:"none"}:c.style,onFocus:be(c.onFocus,()=>{a.valueIndexToChangeRef.current=s})})}),p&&y.jsx(Ox,{name:n??(a.name?a.name+(a.values.length>1?"[]":""):void 0),form:a.form,value:v},s)]})});jx.displayName=Hf;var Nz="RadioBubbleInput",Ox=R.forwardRef(({__scopeSlider:c,value:e,...t},s)=>{const n=R.useRef(null),i=Ne(n,s),a=Au(e);return R.useEffect(()=>{const o=n.current;if(!o)return;const l=window.HTMLInputElement.prototype,h=Object.getOwnPropertyDescriptor(l,"value").set;if(a!==e&&h){const p=new Event("input",{bubbles:!0});h.call(o,e),o.dispatchEvent(p)}},[a,e]),y.jsx(Le.input,{style:{display:"none"},...t,ref:i,defaultValue:e})});Ox.displayName=Nz;function zz(c=[],e,t){const s=[...c];return s[t]=e,s.sort((n,i)=>n-i)}function qx(c,e,t){const i=100/(t-e)*(c-e);return qr(i,[0,100])}function jz(c,e){return e>2?`Value ${c+1} of ${e}`:e===2?["Minimum","Maximum"][c]:void 0}function Oz(c,e){if(c.length===1)return 0;const t=c.map(n=>Math.abs(n-e)),s=Math.min(...t);return t.indexOf(s)}function qz(c,e,t){const s=c/2,i=Bp([0,50],[0,s]);return(s-i(e)*t)*t}function Hz(c){return c.slice(0,-1).map((e,t)=>c[t+1]-e)}function $z(c,e){if(e>0){const t=Hz(c);return Math.min(...t)>=e}return!0}function Bp(c,e){return t=>{if(c[0]===c[1]||e[0]===e[1])return e[0];const s=(e[1]-e[0])/(c[1]-c[0]);return e[0]+s*(t-c[0])}}function Bz(c){return(String(c).split(".")[1]||"").length}function Uz(c,e){const t=Math.pow(10,e);return Math.round(c*t)/t}var Hx=Dx,Fz=Nx,Qz=zx,Vz=jx;const an=R.forwardRef(({className:c,...e},t)=>y.jsxs(Hx,{ref:t,className:Ae("relative flex w-full touch-none select-none items-center",c),...e,children:[y.jsx(Fz,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:y.jsx(Qz,{className:"absolute h-full bg-primary"})}),y.jsx(Vz,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));an.displayName=Hx.displayName;var Iu="Switch",[Gz]=ws(Iu),[Wz,Kz]=Gz(Iu),$x=R.forwardRef((c,e)=>{const{__scopeSwitch:t,name:s,checked:n,defaultChecked:i,required:a,disabled:o,value:l="on",onCheckedChange:d,form:h,...p}=c,[g,v]=R.useState(null),b=Ne(e,E=>v(E)),M=R.useRef(!1),x=g?h||!!g.closest("form"):!0,[S,T]=En({prop:n,defaultProp:i??!1,onChange:d,caller:Iu});return y.jsxs(Wz,{scope:t,checked:S,disabled:o,children:[y.jsx(Le.button,{type:"button",role:"switch","aria-checked":S,"aria-required":a,"data-state":Qx(S),"data-disabled":o?"":void 0,disabled:o,value:l,...p,ref:b,onClick:be(c.onClick,E=>{T(A=>!A),x&&(M.current=E.isPropagationStopped(),M.current||E.stopPropagation())})}),x&&y.jsx(Fx,{control:g,bubbles:!M.current,name:s,value:l,checked:S,required:a,disabled:o,form:h,style:{transform:"translateX(-100%)"}})]})});$x.displayName=Iu;var Bx="SwitchThumb",Ux=R.forwardRef((c,e)=>{const{__scopeSwitch:t,...s}=c,n=Kz(Bx,t);return y.jsx(Le.span,{"data-state":Qx(n.checked),"data-disabled":n.disabled?"":void 0,...s,ref:e})});Ux.displayName=Bx;var Yz="SwitchBubbleInput",Fx=R.forwardRef(({__scopeSwitch:c,control:e,checked:t,bubbles:s=!0,...n},i)=>{const a=R.useRef(null),o=Ne(a,i),l=Au(t),d=xu(e);return R.useEffect(()=>{const h=a.current;if(!h)return;const p=window.HTMLInputElement.prototype,v=Object.getOwnPropertyDescriptor(p,"checked").set;if(l!==t&&v){const b=new Event("click",{bubbles:s});v.call(h,t),h.dispatchEvent(b)}},[l,t,s]),y.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:t,...n,tabIndex:-1,ref:o,style:{...n.style,...d,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});Fx.displayName=Yz;function Qx(c){return c?"checked":"unchecked"}var Vx=$x,Xz=Ux;const ma=R.forwardRef(({className:c,...e},t)=>y.jsx(Vx,{className:Ae("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",c),...e,ref:t,children:y.jsx(Xz,{className:Ae("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));ma.displayName=Vx.displayName;const Ms=R.forwardRef(({className:c,...e},t)=>y.jsx("div",{ref:t,className:Ae("rounded-xl border bg-card text-card-foreground shadow",c),...e}));Ms.displayName="Card";const Cn=R.forwardRef(({className:c,...e},t)=>y.jsx("div",{ref:t,className:Ae("flex flex-col space-y-1.5 p-6",c),...e}));Cn.displayName="CardHeader";const Rn=R.forwardRef(({className:c,...e},t)=>y.jsx("div",{ref:t,className:Ae("font-semibold leading-none tracking-tight",c),...e}));Rn.displayName="CardTitle";const ba=R.forwardRef(({className:c,...e},t)=>y.jsx("div",{ref:t,className:Ae("text-sm text-muted-foreground",c),...e}));ba.displayName="CardDescription";const Tn=R.forwardRef(({className:c,...e},t)=>y.jsx("div",{ref:t,className:Ae("p-6 pt-0",c),...e}));Tn.displayName="CardContent";const Jz=R.forwardRef(({className:c,...e},t)=>y.jsx("div",{ref:t,className:Ae("flex items-center p-6 pt-0",c),...e}));Jz.displayName="CardFooter";const Zz=Gf("inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function pt({className:c,variant:e,...t}){return y.jsx("div",{className:Ae(Zz({variant:e}),c),...t})}const jr={heading:{h1:"text-2xl font-bold text-foreground",h2:"text-lg font-semibold text-foreground",h3:"text-sm font-semibold text-foreground",h4:"text-xs font-semibold text-foreground",h5:"text-[10px] font-semibold text-muted-foreground uppercase"},body:{base:"text-sm text-foreground",small:"text-xs text-foreground",micro:"text-[10px] text-foreground"},muted:{base:"text-sm text-muted-foreground",small:"text-xs text-muted-foreground",micro:"text-[10px] text-muted-foreground"},mono:{base:"font-mono text-sm text-foreground",small:"font-mono text-xs text-foreground",micro:"font-mono text-[10px] text-foreground"},status:{success:"text-success",warning:"text-warning",error:"text-destructive",info:"text-primary"}},on=R.forwardRef(({level:c,as:e,className:t,children:s,...n},i)=>{const a=e||`h${c}`,o=`h${c}`;return y.jsx(a,{ref:i,className:Ae(jr.heading[o],t),...n,children:s})});on.displayName="Heading";const et=R.forwardRef(({size:c="base",muted:e=!1,mono:t=!1,as:s="p",className:n,children:i,...a},o)=>{const l=s;let d;return t?d=jr.mono[c]:e?d=jr.muted[c]:d=jr.body[c],y.jsx(l,{ref:o,className:Ae(d,n),...a,children:i})});et.displayName="Text";const pa=R.forwardRef(({status:c,size:e="base",weight:t="normal",as:s="span",className:n,children:i,...a},o)=>{const l=s,d={base:"text-sm",small:"text-xs",micro:"text-[10px]"},h={normal:"font-normal",medium:"font-medium",semibold:"font-semibold",bold:"font-bold"};return y.jsx(l,{ref:o,className:Ae(d[e],h[t],jr.status[c],n),...a,children:i})});pa.displayName="StatusText";const ej=R.forwardRef(({as:c="h2",className:e,children:t,...s},n)=>y.jsx(on,{ref:n,level:1,as:c,className:e,...s,children:t}));ej.displayName="PageTitle";const tj=R.forwardRef(({as:c="h3",className:e,children:t,...s},n)=>y.jsx(on,{ref:n,level:2,as:c,className:e,...s,children:t}));tj.displayName="SectionTitle";const ti=R.forwardRef(({as:c="h3",className:e,children:t,...s},n)=>y.jsx(on,{ref:n,level:3,as:c,className:e,...s,children:t}));ti.displayName="PanelTitle";const sj=R.forwardRef(({as:c="p",className:e,children:t,...s},n)=>y.jsx(et,{ref:n,size:"base",muted:!0,as:c,className:Ae("mt-1",e),...s,children:t}));sj.displayName="Description";function nj({connection:c,onUpdate:e}){const t=c.data||{},{isRunning:s}=_t(),{getConnectionMessages:n,getMessageHistory:i}=zi(),[a,o]=R.useState([]),[l,d]=R.useState([]);R.useEffect(()=>{if(!s){o([]),d([]);return}const k=setInterval(()=>{const D=n(c.id),L=i(50).filter(I=>I.connectionId===c.id);o(D),d(L)},200);return()=>clearInterval(k)},[s,c.id,n,i]);const h=k=>{const D={...t,...k};e(c.id,{data:D})},p=k=>{h({latencyMs:Math.max(0,k)})},g=k=>{h({bandwidthMbps:Math.max(1,k)})},v=k=>{h({packetLossPercent:Math.max(0,Math.min(100,k))})},b=k=>{h({jitterMs:Math.max(0,k)})},M=k=>{h({retryCount:Math.max(0,k)})},x=k=>{h({timeoutMs:Math.max(1e3,k)})},S=c.type||t.protocol||"http",T=t.protocolConfig||{},E=k=>{const D={type:k,data:{...t,protocol:k}};e(c.id,D)},A=k=>{h({protocolConfig:{...T,...k}})};return y.jsxs("div",{className:"space-y-2",children:[y.jsxs("div",{className:"space-y-1",children:[y.jsx(ti,{children:"Connection"}),y.jsxs("div",{className:"space-y-0.5",children:[y.jsxs(et,{size:"micro",muted:!0,children:["From: ",c.source]}),y.jsxs(et,{size:"micro",muted:!0,children:["To: ",c.target]}),y.jsxs(et,{size:"micro",muted:!0,children:["Type: ",c.type]})]})]}),y.jsxs("div",{className:"border-t border-border pt-2 space-y-2",children:[y.jsxs("div",{children:[y.jsx(on,{level:5,className:"mb-1.5 opacity-70",children:"Network Parameters"}),y.jsxs("div",{className:"space-y-1 mb-2",children:[y.jsxs("div",{className:"flex justify-between items-center",children:[y.jsx(He,{className:"text-xs",children:"Latency (ms)"}),y.jsx(et,{mono:!0,size:"micro",className:"text-primary",children:t.latencyMs??0})]}),y.jsx(an,{value:[t.latencyMs??0],onValueChange:k=>p(k[0]),min:0,max:5e3,step:10,className:"w-full"}),y.jsx(ct,{type:"number",value:t.latencyMs??0,onChange:k=>p(parseInt(k.target.value)||0),placeholder:"0-5000",className:"h-7 text-xs"})]}),y.jsxs("div",{className:"space-y-1 mb-2",children:[y.jsxs("div",{className:"flex justify-between items-center",children:[y.jsx(He,{className:"text-xs",children:"Bandwidth (Mbps)"}),y.jsx(et,{mono:!0,size:"micro",className:"text-primary",children:t.bandwidthMbps??1e3})]}),y.jsx(an,{value:[t.bandwidthMbps??1e3],onValueChange:k=>g(k[0]),min:1,max:1e5,step:10,className:"w-full"}),y.jsx(ct,{type:"number",value:t.bandwidthMbps??1e3,onChange:k=>g(parseInt(k.target.value)||1e3),placeholder:"1-100000",className:"h-7 text-xs"})]}),y.jsxs("div",{className:"space-y-1 mb-2",children:[y.jsxs("div",{className:"flex justify-between items-center",children:[y.jsx(He,{className:"text-xs",children:"Packet Loss (%)"}),y.jsx(et,{mono:!0,size:"micro",className:"text-primary",children:t.packetLossPercent??0})]}),y.jsx(an,{value:[t.packetLossPercent??0],onValueChange:k=>v(k[0]),min:0,max:100,step:.1,className:"w-full"}),y.jsx(ct,{type:"number",step:"0.1",value:t.packetLossPercent??0,onChange:k=>v(parseFloat(k.target.value)||0),placeholder:"0-100",className:"h-7 text-xs"})]}),y.jsxs("div",{className:"space-y-1 mb-2",children:[y.jsxs("div",{className:"flex justify-between items-center",children:[y.jsx(He,{className:"text-xs",children:"Jitter (ms)"}),y.jsx(et,{mono:!0,size:"micro",className:"text-primary",children:t.jitterMs??0})]}),y.jsx(an,{value:[t.jitterMs??0],onValueChange:k=>b(k[0]),min:0,max:1e3,step:5,className:"w-full"}),y.jsx(ct,{type:"number",value:t.jitterMs??0,onChange:k=>b(parseInt(k.target.value)||0),placeholder:"0-1000",className:"h-7 text-xs"})]})]}),y.jsxs("div",{className:"border-t border-border pt-2",children:[y.jsx(on,{level:5,className:"mb-1.5 opacity-70",children:"Protocol"}),y.jsxs("div",{className:"space-y-1 mb-2",children:[y.jsx(He,{className:"text-xs",children:"Protocol"}),y.jsxs(ji,{value:S,onValueChange:E,children:[y.jsx(ni,{className:"h-7 text-[11px]",children:y.jsx(Oi,{})}),y.jsxs(ii,{children:[y.jsx(Ge,{value:"rest",children:"REST"}),y.jsx(Ge,{value:"graphql",children:"GraphQL"}),y.jsx(Ge,{value:"soap",children:"SOAP"}),y.jsx(Ge,{value:"grpc",children:"gRPC"}),y.jsx(Ge,{value:"websocket",children:"WebSocket"}),y.jsx(Ge,{value:"webhook",children:"Webhook"}),y.jsx(Ge,{value:"http",children:"HTTP (legacy)"}),y.jsx(Ge,{value:"sync",children:"Sync"}),y.jsx(Ge,{value:"async",children:"Async"})]})]})]}),S==="rest"&&y.jsxs("div",{className:"space-y-2 mt-2",children:[y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"HTTP Method"}),y.jsxs(ji,{value:T.httpMethod||"POST",onValueChange:k=>A({httpMethod:k}),children:[y.jsx(ni,{className:"h-7 text-[11px]",children:y.jsx(Oi,{})}),y.jsxs(ii,{children:[y.jsx(Ge,{value:"GET",children:"GET"}),y.jsx(Ge,{value:"POST",children:"POST"}),y.jsx(Ge,{value:"PUT",children:"PUT"}),y.jsx(Ge,{value:"DELETE",children:"DELETE"}),y.jsx(Ge,{value:"PATCH",children:"PATCH"})]})]})]}),y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"Content Type"}),y.jsxs(ji,{value:T.contentType||"json",onValueChange:k=>A({contentType:k}),children:[y.jsx(ni,{className:"h-7 text-[11px]",children:y.jsx(Oi,{})}),y.jsxs(ii,{children:[y.jsx(Ge,{value:"json",children:"JSON"}),y.jsx(Ge,{value:"xml",children:"XML"}),y.jsx(Ge,{value:"form-data",children:"Form Data"})]})]})]})]}),S==="graphql"&&y.jsx("div",{className:"space-y-2 mt-2",children:y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"Operation Name"}),y.jsx(ct,{value:T.operationName||"",onChange:k=>A({operationName:k.target.value}),placeholder:"query/mutation name",className:"h-7 text-xs"})]})}),S==="soap"&&y.jsxs("div",{className:"space-y-2 mt-2",children:[y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"SOAP Action"}),y.jsx(ct,{value:T.soapAction||"",onChange:k=>A({soapAction:k.target.value}),placeholder:"SOAP action URI",className:"h-7 text-xs"})]}),y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"WSDL URL"}),y.jsx(ct,{value:T.wsdlUrl||"",onChange:k=>A({wsdlUrl:k.target.value}),placeholder:"http://example.com/service.wsdl",className:"h-7 text-xs"})]})]}),S==="grpc"&&y.jsxs("div",{className:"space-y-2 mt-2",children:[y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"Service Name"}),y.jsx(ct,{value:T.serviceName||"",onChange:k=>A({serviceName:k.target.value}),placeholder:"com.example.Service",className:"h-7 text-xs"})]}),y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"Method Name"}),y.jsx(ct,{value:T.methodName||"",onChange:k=>A({methodName:k.target.value}),placeholder:"GetUser",className:"h-7 text-xs"})]})]}),S==="websocket"&&y.jsxs("div",{className:"space-y-2 mt-2",children:[y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"Subprotocol"}),y.jsx(ct,{value:T.wsProtocol||"",onChange:k=>A({wsProtocol:k.target.value}),placeholder:"chat, echo, etc.",className:"h-7 text-xs"})]}),y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"Binary Type"}),y.jsxs(ji,{value:T.binaryType||"blob",onValueChange:k=>A({binaryType:k}),children:[y.jsx(ni,{className:"h-7 text-[11px]",children:y.jsx(Oi,{})}),y.jsxs(ii,{children:[y.jsx(Ge,{value:"blob",children:"Blob"}),y.jsx(Ge,{value:"arraybuffer",children:"ArrayBuffer"})]})]})]})]}),S==="webhook"&&y.jsxs("div",{className:"space-y-2 mt-2",children:[y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"Event Type"}),y.jsx(ct,{value:T.webhookEvent||"",onChange:k=>A({webhookEvent:k.target.value}),placeholder:"push, pull_request, etc.",className:"h-7 text-xs"})]}),y.jsxs("div",{className:"space-y-1",children:[y.jsx(He,{className:"text-xs",children:"Signature Header"}),y.jsx(ct,{value:T.signatureHeader||"X-Signature",onChange:k=>A({signatureHeader:k.target.value}),placeholder:"X-Signature",className:"h-7 text-xs"})]})]})]}),y.jsxs("div",{className:"border-t border-border pt-2",children:[y.jsx("h4",{className:"text-[9px] font-semibold text-foreground mb-1.5 uppercase opacity-70",children:"Traffic Characteristics"}),y.jsxs("div",{className:"space-y-1 mb-2",children:[y.jsx(He,{className:"text-xs",children:"Priority Level"}),y.jsxs(ji,{value:t.priorityLevel||"medium",onValueChange:k=>h({priorityLevel:k}),children:[y.jsx(ni,{className:"h-7 text-[11px]",children:y.jsx(Oi,{})}),y.jsxs(ii,{children:[y.jsx(Ge,{value:"low",children:"Low"}),y.jsx(Ge,{value:"medium",children:"Medium"}),y.jsx(Ge,{value:"high",children:"High"}),y.jsx(Ge,{value:"critical",children:"Critical"})]})]})]}),y.jsxs("div",{className:"space-y-1 mb-2",children:[y.jsxs("div",{className:"flex justify-between items-center",children:[y.jsx(He,{className:"text-xs",children:"Retry Count"}),y.jsx(et,{mono:!0,size:"micro",className:"text-primary",children:t.retryCount??3})]}),y.jsx(an,{value:[t.retryCount??3],onValueChange:k=>M(k[0]),min:0,max:10,step:1,className:"w-full"}),y.jsx(ct,{type:"number",value:t.retryCount??3,onChange:k=>M(parseInt(k.target.value)||0),placeholder:"0-10",className:"h-7 text-xs"})]}),y.jsxs("div",{className:"space-y-1 mb-2",children:[y.jsxs("div",{className:"flex justify-between items-center",children:[y.jsx(He,{className:"text-xs",children:"Timeout (ms)"}),y.jsx(et,{mono:!0,size:"micro",className:"text-primary",children:t.timeoutMs??3e4})]}),y.jsx(an,{value:[t.timeoutMs??3e4],onValueChange:k=>x(k[0]),min:1e3,max:12e4,step:1e3,className:"w-full"}),y.jsx(ct,{type:"number",value:t.timeoutMs??3e4,onChange:k=>x(parseInt(k.target.value)||3e4),placeholder:"1000-120000",className:"h-7 text-xs"})]})]}),y.jsxs("div",{className:"border-t border-border pt-2",children:[y.jsx(on,{level:5,className:"mb-1.5 opacity-70",children:"Monitoring"}),y.jsxs("div",{className:"flex items-center justify-between p-1.5 bg-accent/20 rounded-md",children:[y.jsx(He,{className:"text-xs cursor-pointer",children:"Enable Monitoring"}),y.jsx(ma,{checked:t.enableMonitoring??!1,onCheckedChange:k=>h({enableMonitoring:k})})]})]}),y.jsx(Ms,{className:"bg-card/50 border-border/50 p-1.5 mt-2",children:y.jsxs("div",{className:"space-y-0.5",children:[y.jsxs("div",{className:"flex justify-between",children:[y.jsx(et,{size:"micro",muted:!0,children:"Effective Bandwidth:"}),y.jsxs(et,{mono:!0,size:"micro",children:[Math.max(1,(t.bandwidthMbps??1e3)*(1-(t.packetLossPercent??0)/100)).toFixed(2)," Mbps"]})]}),y.jsxs("div",{className:"flex justify-between",children:[y.jsx(et,{size:"micro",muted:!0,children:"Effective Latency:"}),y.jsxs(et,{mono:!0,size:"micro",children:[((t.latencyMs??0)+(t.jitterMs??0)/2).toFixed(0)," ms"]})]})]})}),s&&y.jsx("div",{className:"border-t border-border pt-2 mt-2",children:y.jsxs(Sp,{defaultValue:"active",className:"w-full",children:[y.jsxs(vu,{className:"grid w-full grid-cols-2 h-7",children:[y.jsxs(nn,{value:"active",className:"text-xs px-2",children:[y.jsx(wa,{className:"h-3 w-3 mr-1"}),"Active (",a.length,")"]}),y.jsxs(nn,{value:"history",className:"text-xs px-2",children:[y.jsx(pv,{className:"h-3 w-3 mr-1"}),"History (",l.length,")"]})]}),y.jsx(si,{value:"active",className:"mt-1.5 space-y-1",children:a.length===0?y.jsxs("div",{className:"text-center py-3",children:[y.jsx(wa,{className:"h-5 w-5 mx-auto mb-1 opacity-50"}),y.jsx(et,{size:"micro",muted:!0,children:"No active messages"})]}):y.jsx("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:a.map((k,D)=>y.jsxs(Ms,{className:"p-1 border-border/50",children:[y.jsx("div",{className:"flex items-start justify-between gap-1.5",children:y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsxs("div",{className:"flex items-center gap-1 mb-0.5",children:[y.jsx(pt,{variant:"outline",className:"text-xs px-0.5 py-0",children:k.format}),y.jsx(pt,{variant:k.status==="delivered"?"default":k.status==="failed"?"destructive":k.status==="transformed"?"secondary":"outline",className:"text-xs px-0.5 py-0",children:k.status})]}),y.jsxs("div",{className:"text-[9px] text-muted-foreground space-y-0.5",children:[y.jsxs("div",{children:["Size: ",(k.size/1024).toFixed(2)," KB"]}),k.latency&&y.jsxs("div",{children:["Latency: ",k.latency.toFixed(0)," ms"]})]}),k.error&&y.jsxs("div",{className:"text-[10px] text-destructive mt-0.5 flex items-center gap-0.5",children:[y.jsx(Sa,{className:"h-2.5 w-2.5"}),k.error]})]})}),k.payload&&y.jsxs("details",{className:"mt-1",children:[y.jsx("summary",{className:"text-[9px] cursor-pointer text-muted-foreground hover:text-foreground",children:"Show Data"}),y.jsx("pre",{className:"mt-1 p-1 bg-muted rounded text-[9px] overflow-x-auto max-h-32 overflow-y-auto",children:JSON.stringify(k.payload,null,2)})]})]},k.id||D))})}),y.jsx(si,{value:"history",className:"mt-1.5 space-y-1",children:l.length===0?y.jsxs("div",{className:"text-center py-3",children:[y.jsx(pv,{className:"h-5 w-5 mx-auto mb-1 opacity-50"}),y.jsx(et,{size:"micro",muted:!0,children:"History is empty"})]}):y.jsx("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:l.map((k,D)=>y.jsxs(Ms,{className:"p-1 border-border/50",children:[y.jsx("div",{className:"flex items-start justify-between gap-1.5",children:y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsxs("div",{className:"flex items-center gap-1 mb-0.5",children:[y.jsx(pt,{variant:"outline",className:"text-xs px-0.5 py-0",children:k.format}),y.jsx(pt,{variant:k.status==="delivered"?"default":k.status==="failed"?"destructive":"outline",className:"text-xs px-0.5 py-0",children:k.status}),y.jsx("span",{className:"text-[9px] text-muted-foreground",children:new Date(k.timestamp).toLocaleTimeString()})]}),y.jsxs("div",{className:"text-[9px] text-muted-foreground space-y-0.5",children:[y.jsxs("div",{children:["Size: ",(k.size/1024).toFixed(2)," KB"]}),k.latency&&y.jsxs("div",{children:["Latency: ",k.latency.toFixed(0)," ms"]})]}),k.error&&y.jsxs("div",{className:"text-[10px] text-destructive mt-0.5 flex items-center gap-0.5",children:[y.jsx(Sa,{className:"h-2.5 w-2.5"}),k.error]})]})}),k.payload&&y.jsxs("details",{className:"mt-1",children:[y.jsx("summary",{className:"text-[9px] cursor-pointer text-muted-foreground hover:text-foreground",children:"Show Data"}),y.jsx("pre",{className:"mt-1 p-1 bg-muted rounded text-[9px] overflow-x-auto max-h-32 overflow-y-auto",children:JSON.stringify(k.payload,null,2)})]})]},k.id||D))})})]})})]})]})}function ij(c){const e=aj(c),t=R.forwardRef((s,n)=>{const{children:i,...a}=s,o=R.Children.toArray(i),l=o.find(rj);if(l){const d=l.props.children,h=o.map(p=>p===l?R.Children.count(d)>1?R.Children.only(null):R.isValidElement(d)?d.props.children:null:p);return y.jsx(e,{...a,ref:n,children:R.isValidElement(d)?R.cloneElement(d,void 0,h):null})}return y.jsx(e,{...a,ref:n,children:i})});return t.displayName=`${c}.Slot`,t}function aj(c){const e=R.forwardRef((t,s)=>{const{children:n,...i}=t;if(R.isValidElement(n)){const a=lj(n),o=cj(i,n.props);return n.type!==R.Fragment&&(o.ref=s?An(s,a):a),R.cloneElement(n,o)}return R.Children.count(n)>1?R.Children.only(null):null});return e.displayName=`${c}.SlotClone`,e}var oj=Symbol("radix.slottable");function rj(c){return R.isValidElement(c)&&typeof c.type=="function"&&"__radixId"in c.type&&c.type.__radixId===oj}function cj(c,e){const t={...e};for(const s in e){const n=c[s],i=e[s];/^on[A-Z]/.test(s)?n&&i?t[s]=(...o)=>{const l=i(...o);return n(...o),l}:n&&(t[s]=n):s==="style"?t[s]={...n,...i}:s==="className"&&(t[s]=[n,i].filter(Boolean).join(" "))}return{...c,...t}}function lj(c){let e=Object.getOwnPropertyDescriptor(c.props,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning;return t?c.ref:(e=Object.getOwnPropertyDescriptor(c,"ref")?.get,t=e&&"isReactWarning"in e&&e.isReactWarning,t?c.props.ref:c.props.ref||c.ref)}var Nu="Popover",[Gx]=ws(Nu,[No]),nc=No(),[uj,Vi]=Gx(Nu),Wx=c=>{const{__scopePopover:e,children:t,open:s,defaultOpen:n,onOpenChange:i,modal:a=!1}=c,o=nc(e),l=R.useRef(null),[d,h]=R.useState(!1),[p,g]=En({prop:s,defaultProp:n??!1,onChange:i,caller:Nu});return y.jsx(Pp,{...o,children:y.jsx(uj,{scope:e,contentId:ln(),triggerRef:l,open:p,onOpenChange:g,onOpenToggle:R.useCallback(()=>g(v=>!v),[g]),hasCustomAnchor:d,onCustomAnchorAdd:R.useCallback(()=>h(!0),[]),onCustomAnchorRemove:R.useCallback(()=>h(!1),[]),modal:a,children:t})})};Wx.displayName=Nu;var Kx="PopoverAnchor",dj=R.forwardRef((c,e)=>{const{__scopePopover:t,...s}=c,n=Vi(Kx,t),i=nc(t),{onCustomAnchorAdd:a,onCustomAnchorRemove:o}=n;return R.useEffect(()=>(a(),()=>o()),[a,o]),y.jsx(Cu,{...i,...s,ref:e})});dj.displayName=Kx;var Yx="PopoverTrigger",Xx=R.forwardRef((c,e)=>{const{__scopePopover:t,...s}=c,n=Vi(Yx,t),i=nc(t),a=Ne(e,n.triggerRef),o=y.jsx(Le.button,{type:"button","aria-haspopup":"dialog","aria-expanded":n.open,"aria-controls":n.contentId,"data-state":sC(n.open),...s,ref:a,onClick:be(c.onClick,n.onOpenToggle)});return n.hasCustomAnchor?o:y.jsx(Cu,{asChild:!0,...i,children:o})});Xx.displayName=Yx;var Up="PopoverPortal",[hj,fj]=Gx(Up,{forceMount:void 0}),Jx=c=>{const{__scopePopover:e,forceMount:t,children:s,container:n}=c,i=Vi(Up,e);return y.jsx(hj,{scope:e,forceMount:t,children:y.jsx(cs,{present:t||i.open,children:y.jsx(Xr,{asChild:!0,container:n,children:s})})})};Jx.displayName=Up;var ko="PopoverContent",Zx=R.forwardRef((c,e)=>{const t=fj(ko,c.__scopePopover),{forceMount:s=t.forceMount,...n}=c,i=Vi(ko,c.__scopePopover);return y.jsx(cs,{present:s||i.open,children:i.modal?y.jsx(gj,{...n,ref:e}):y.jsx(mj,{...n,ref:e})})});Zx.displayName=ko;var pj=ij("PopoverContent.RemoveScroll"),gj=R.forwardRef((c,e)=>{const t=Vi(ko,c.__scopePopover),s=R.useRef(null),n=Ne(e,s),i=R.useRef(!1);return R.useEffect(()=>{const a=s.current;if(a)return cu(a)},[]),y.jsx(Jr,{as:pj,allowPinchZoom:!0,children:y.jsx(eC,{...c,ref:n,trapFocus:t.open,disableOutsidePointerEvents:!0,onCloseAutoFocus:be(c.onCloseAutoFocus,a=>{a.preventDefault(),i.current||t.triggerRef.current?.focus()}),onPointerDownOutside:be(c.onPointerDownOutside,a=>{const o=a.detail.originalEvent,l=o.button===0&&o.ctrlKey===!0,d=o.button===2||l;i.current=d},{checkForDefaultPrevented:!1}),onFocusOutside:be(c.onFocusOutside,a=>a.preventDefault(),{checkForDefaultPrevented:!1})})})}),mj=R.forwardRef((c,e)=>{const t=Vi(ko,c.__scopePopover),s=R.useRef(!1),n=R.useRef(!1);return y.jsx(eC,{...c,ref:e,trapFocus:!1,disableOutsidePointerEvents:!1,onCloseAutoFocus:i=>{c.onCloseAutoFocus?.(i),i.defaultPrevented||(s.current||t.triggerRef.current?.focus(),i.preventDefault()),s.current=!1,n.current=!1},onInteractOutside:i=>{c.onInteractOutside?.(i),i.defaultPrevented||(s.current=!0,i.detail.originalEvent.type==="pointerdown"&&(n.current=!0));const a=i.target;t.triggerRef.current?.contains(a)&&i.preventDefault(),i.detail.originalEvent.type==="focusin"&&n.current&&i.preventDefault()}})}),eC=R.forwardRef((c,e)=>{const{__scopePopover:t,trapFocus:s,onOpenAutoFocus:n,onCloseAutoFocus:i,disableOutsidePointerEvents:a,onEscapeKeyDown:o,onPointerDownOutside:l,onFocusOutside:d,onInteractOutside:h,...p}=c,g=Vi(ko,t),v=nc(t);return ou(),y.jsx(Yr,{asChild:!0,loop:!0,trapped:s,onMountAutoFocus:n,onUnmountAutoFocus:i,children:y.jsx(Kr,{asChild:!0,disableOutsidePointerEvents:a,onInteractOutside:h,onEscapeKeyDown:o,onPointerDownOutside:l,onFocusOutside:d,onDismiss:()=>g.onOpenChange(!1),children:y.jsx(Lp,{"data-state":sC(g.open),role:"dialog",id:g.contentId,...v,...p,ref:e,style:{...p.style,"--radix-popover-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-popover-content-available-width":"var(--radix-popper-available-width)","--radix-popover-content-available-height":"var(--radix-popper-available-height)","--radix-popover-trigger-width":"var(--radix-popper-anchor-width)","--radix-popover-trigger-height":"var(--radix-popper-anchor-height)"}})})})}),tC="PopoverClose",yj=R.forwardRef((c,e)=>{const{__scopePopover:t,...s}=c,n=Vi(tC,t);return y.jsx(Le.button,{type:"button",...s,ref:e,onClick:be(c.onClick,()=>n.onOpenChange(!1))})});yj.displayName=tC;var vj="PopoverArrow",bj=R.forwardRef((c,e)=>{const{__scopePopover:t,...s}=c,n=nc(t);return y.jsx(_p,{...n,...s,ref:e})});bj.displayName=vj;function sC(c){return c?"open":"closed"}var Mj=Wx,wj=Xx,Sj=Jx,nC=Zx;const xj=Mj,Cj=wj,iC=R.forwardRef(({className:c,align:e="center",sideOffset:t=4,...s},n)=>y.jsx(Sj,{children:y.jsx(nC,{ref:n,align:e,sideOffset:t,className:Ae("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",c),...s})}));iC.displayName=nC.displayName;const aC=hn((c,e)=>({componentStates:new Map,setComponentState:(t,s,n)=>{wo.setComponentState(t,s,n);const i=wo.getComponentState(t);i&&c(a=>({componentStates:new Map(a.componentStates).set(t,i)}))},resetComponent:t=>{wo.resetComponent(t),c(s=>{const n=new Map(s.componentStates);return n.delete(t),{componentStates:n}})},resetAll:()=>{wo.reset(),c({componentStates:new Map})},getComponentState:t=>e().componentStates.get(t),isEnabled:t=>wo.isEnabled(t),getAllStates:()=>Array.from(e().componentStates.values())}));function Rj({componentId:c,componentLabel:e}){const{isRunning:t}=_t(),{getComponentState:s,setComponentState:n,resetComponent:i}=aC(),a=s(c),o=a?.state||"enabled",[l,d]=R.useState(a?.degradedLevel||.5),[h,p]=R.useState(a?.failureRate||.1),[g,v]=R.useState(a?.latencyMultiplier||2),[b,M]=R.useState(a?.throughputMultiplier||.5),x=A=>{A==="degraded"?n(c,A,{degradedLevel:l,failureRate:h,latencyMultiplier:g,throughputMultiplier:b}):n(c,A)},S=()=>{i(c),d(.5),p(.1),v(2),M(.5)},T=A=>{switch(A){case"enabled":return"bg-green-500/20 text-green-500 border-green-500/50";case"disabled":return"bg-gray-500/20 text-gray-500 border-gray-500/50";case"degraded":return"bg-yellow-500/20 text-yellow-500 border-yellow-500/50";case"failed":return"bg-red-500/20 text-red-500 border-red-500/50"}},E=A=>{switch(A){case"enabled":return y.jsx(of,{className:"w-4 h-4"});case"disabled":return y.jsx(Ll,{className:"w-4 h-4"});case"degraded":return y.jsx(rn,{className:"w-4 h-4"});case"failed":return y.jsx(va,{className:"w-4 h-4"})}};return y.jsxs(Ms,{className:"border",children:[y.jsx(Cn,{className:"p-2 pb-1.5",children:y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs("div",{children:[y.jsxs(Rn,{className:"text-[11px] flex items-center gap-1",children:[y.jsx(wa,{className:"w-3 h-3"}),"Component State",y.jsxs(xj,{children:[y.jsx(Cj,{asChild:!0,children:y.jsx(De,{variant:"ghost",size:"icon",className:"h-3.5 w-3.5 rounded-full",children:y.jsx(cD,{className:"w-2.5 h-2.5 text-muted-foreground"})})}),y.jsx(iC,{className:"w-72 text-xs",align:"start",children:y.jsxs("div",{className:"space-y-2",children:[y.jsx("h4",{className:"font-semibold text-sm",children:"Component States"}),y.jsxs("div",{className:"space-y-1.5",children:[y.jsxs("div",{className:"flex items-start gap-2",children:[y.jsx(of,{className:"w-3.5 h-3.5 text-green-500 mt-0.5 flex-shrink-0"}),y.jsxs("div",{children:[y.jsx("span",{className:"font-medium text-green-500",children:"Enabled"}),y.jsx("span",{className:"text-muted-foreground",children:"  normal operation"})]})]}),y.jsxs("div",{className:"flex items-start gap-2",children:[y.jsx(Ll,{className:"w-3.5 h-3.5 text-gray-500 mt-0.5 flex-shrink-0"}),y.jsxs("div",{children:[y.jsx("span",{className:"font-medium text-gray-500",children:"Disabled"}),y.jsx("span",{className:"text-muted-foreground",children:"  turned off. Throughput=0, Errors=100%"})]})]}),y.jsxs("div",{className:"flex items-start gap-2",children:[y.jsx(rn,{className:"w-3.5 h-3.5 text-yellow-500 mt-0.5 flex-shrink-0"}),y.jsxs("div",{children:[y.jsx("span",{className:"font-medium text-yellow-500",children:"Degraded"}),y.jsx("span",{className:"text-muted-foreground",children:"  partial failure. Throughput 50%, Latency 2x, Errors 10%"})]})]}),y.jsxs("div",{className:"flex items-start gap-2",children:[y.jsx(va,{className:"w-3.5 h-3.5 text-red-500 mt-0.5 flex-shrink-0"}),y.jsxs("div",{children:[y.jsx("span",{className:"font-medium text-red-500",children:"Failed"}),y.jsx("span",{className:"text-muted-foreground",children:"  crashed. Same as Disabled but indicates failure"})]})]})]}),y.jsx("p",{className:"text-muted-foreground pt-1 border-t border-border",children:"Use to simulate failures and test architecture resilience."})]})})]})]}),y.jsx(ba,{className:"text-[9px] mt-0.5",children:"Control operational state"})]}),a&&y.jsxs(pt,{variant:"outline",className:`${T(o)} text-xs px-1 py-0.5`,children:[E(o),y.jsx("span",{className:"ml-0.5",children:o.toUpperCase()})]})]})}),y.jsxs(Tn,{className:"p-2 pt-1.5 space-y-2",children:[y.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[y.jsxs(De,{variant:o==="enabled"?"default":"outline",size:"sm",onClick:()=>x("enabled"),className:"flex items-center gap-1 h-7 text-xs",disabled:!t,children:[y.jsx(of,{className:"w-3.5 h-3.5"}),"Enabled"]}),y.jsxs(De,{variant:o==="disabled"?"destructive":"outline",size:"sm",onClick:()=>x("disabled"),className:"flex items-center gap-1 h-7 text-xs",disabled:!t,children:[y.jsx(Ll,{className:"w-3.5 h-3.5"}),"Disabled"]}),y.jsxs(De,{variant:o==="degraded"?"default":"outline",size:"sm",onClick:()=>x("degraded"),className:"flex items-center gap-1 h-7 text-xs bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-600 dark:text-yellow-400",disabled:!t,children:[y.jsx(rn,{className:"w-3.5 h-3.5"}),"Degraded"]}),y.jsxs(De,{variant:o==="failed"?"destructive":"outline",size:"sm",onClick:()=>x("failed"),className:"flex items-center gap-1 h-7 text-xs",disabled:!t,children:[y.jsx(va,{className:"w-3.5 h-3.5"}),"Failed"]})]}),o==="degraded"&&y.jsxs("div",{className:"space-y-2 p-2 bg-yellow-500/10 rounded-lg border border-yellow-500/20",children:[y.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[y.jsx(qb,{className:"w-3 h-3 text-yellow-600 dark:text-yellow-400"}),y.jsx(He,{className:"text-[11px] font-semibold text-yellow-600 dark:text-yellow-400",children:"Degradation Settings"})]}),y.jsxs("div",{className:"space-y-2",children:[y.jsxs("div",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[y.jsx(He,{className:"text-[10px]",children:"Degradation Level"}),y.jsxs("span",{className:"text-[9px] text-muted-foreground",children:[(l*100).toFixed(0),"%"]})]}),y.jsx(an,{value:[l],onValueChange:A=>{d(A[0]),x("degraded")},min:0,max:1,step:.1,className:"w-full"})]}),y.jsxs("div",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[y.jsx(He,{className:"text-[10px]",children:"Failure Rate"}),y.jsxs("span",{className:"text-[9px] text-muted-foreground",children:[(h*100).toFixed(0),"%"]})]}),y.jsx(an,{value:[h],onValueChange:A=>{p(A[0]),x("degraded")},min:0,max:1,step:.05,className:"w-full"})]}),y.jsxs("div",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[y.jsx(He,{className:"text-[10px]",children:"Latency Multiplier"}),y.jsxs("span",{className:"text-[9px] text-muted-foreground",children:[g.toFixed(1),"x"]})]}),y.jsx(an,{value:[g],onValueChange:A=>{v(A[0]),x("degraded")},min:1,max:5,step:.1,className:"w-full"})]}),y.jsxs("div",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[y.jsx(He,{className:"text-[10px]",children:"Throughput Multiplier"}),y.jsxs("span",{className:"text-[9px] text-muted-foreground",children:[(b*100).toFixed(0),"%"]})]}),y.jsx(an,{value:[b],onValueChange:A=>{M(A[0]),x("degraded")},min:0,max:1,step:.05,className:"w-full"})]})]})]}),a&&y.jsxs(De,{variant:"outline",size:"sm",onClick:S,className:"w-full flex items-center gap-1 h-7 text-xs",disabled:!t,children:[y.jsx(Ob,{className:"w-3.5 h-3.5"}),"Reset to Normal"]}),!t&&y.jsxs("div",{className:"flex items-center gap-1 p-1 bg-muted rounded text-[9px] text-muted-foreground",children:[y.jsx(Sa,{className:"w-3 h-3"}),"Start emulation to control component state"]})]})]})}function Tj({onFilterChange:c}){const{nodes:e,connections:t,selectNode:s}=ke(),{isRunning:n,getComponentMetrics:i}=_t(),{getAllComponentStatuses:a}=Ma(),[o,l]=R.useState(""),[d,h]=R.useState(!1),[p,g]=R.useState(!0),[v,b]=R.useState(!0),[M,x]=R.useState(!0),[S,T]=R.useState(!0),[E,A]=R.useState(100),[k,D]=R.useState(5),[L,I]=R.useState(new Set),U=Dt.useMemo(()=>n?e.filter(Y=>{if(o&&!Y.data.label.toLowerCase().includes(o.toLowerCase()))return!1;if(!d)return!0;const ae=i(Y.id),z=a().find($=>$.nodeId===Y.id);return!!(p&&t.some(q=>q.source===Y.id||q.target===Y.id?_t.getState().getConnectionMetrics(q.id)?.bottleneck:!1)||v&&ae&&ae.errorRate*100>=k||S&&ae&&ae.latency>=E||M&&z?.criticalPath||z&&(z.health==="critical"||z.health==="down"))}):e,[o,d,p,v,S,M,E,k,n,e,t]);Dt.useEffect(()=>{if(d){const Y=new Set(U.map(ae=>ae.id));I(Y),c?.(Array.from(Y))}else I(new Set),c?.(e.map(Y=>Y.id))},[d,U,e,c]);const Q=Y=>{s(Y)},se=U.length,F=e.filter(Y=>{if(!n)return!1;const ae=i(Y.id),z=a().find($=>$.nodeId===Y.id);return ae&&(ae.errorRate*100>=k||ae.latency>=E)||z?.criticalPath||z&&(z.health==="critical"||z.health==="down")||t.some($=>$.source===Y.id||$.target===Y.id?_t.getState().getConnectionMetrics($.id)?.bottleneck:!1)}).length;return y.jsxs(Ms,{className:"h-full border-2",children:[y.jsx(Cn,{className:"pb-3",children:y.jsxs(Rn,{className:"text-sm flex items-center gap-2",children:[y.jsx(Nb,{className:"w-4 h-4"}),"Problem Filters",se>0&&y.jsx(pt,{variant:"destructive",className:"ml-auto",children:se})]})}),y.jsxs(Tn,{className:"space-y-4",children:[y.jsxs("div",{className:"space-y-2",children:[y.jsx(He,{className:"text-xs",children:"Search Components"}),y.jsxs("div",{className:"relative",children:[y.jsx(Gr,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),y.jsx(ct,{placeholder:"Search by name...",value:o,onChange:Y=>l(Y.target.value),className:"pl-8 h-8 text-xs"})]})]}),y.jsxs("div",{className:"space-y-2",children:[y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs(He,{className:"text-xs flex items-center gap-2",children:[y.jsx(mD,{className:"w-4 h-4"}),"Show Only Problems"]}),y.jsx(ma,{checked:d,onCheckedChange:h})]}),d&&y.jsxs("div",{className:"pl-6 space-y-2 border-l-2 border-border",children:[y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs(He,{className:"text-xs flex items-center gap-2",children:[y.jsx(qb,{className:"w-4 h-4 text-red-500"}),"Bottlenecks"]}),y.jsx(ma,{checked:p,onCheckedChange:g})]}),y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs(He,{className:"text-xs flex items-center gap-2",children:[y.jsx(va,{className:"w-4 h-4 text-orange-500"}),"High Error Rate (>",k,"%)"]}),y.jsx(ma,{checked:v,onCheckedChange:b})]}),y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs(He,{className:"text-xs flex items-center gap-2",children:[y.jsx(Hb,{className:"w-4 h-4 text-yellow-500"}),"High Latency (>",E,"ms)"]}),y.jsx(ma,{checked:S,onCheckedChange:T})]}),y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs(He,{className:"text-xs flex items-center gap-2",children:[y.jsx(wa,{className:"w-4 h-4 text-purple-500"}),"Critical Paths"]}),y.jsx(ma,{checked:M,onCheckedChange:x})]})]})]}),d&&y.jsxs("div",{className:"space-y-2 pt-2 border-t border-border",children:[y.jsxs("div",{children:[y.jsx(He,{className:"text-xs",children:"Min Latency (ms)"}),y.jsx(ct,{type:"number",value:E,onChange:Y=>A(Number(Y.target.value)),className:"h-8 text-xs mt-1",min:0})]}),y.jsxs("div",{children:[y.jsx(He,{className:"text-xs",children:"Min Error Rate (%)"}),y.jsx(ct,{type:"number",value:k,onChange:Y=>D(Number(Y.target.value)),className:"h-8 text-xs mt-1",min:0,max:100})]})]}),n&&y.jsx("div",{className:"pt-2 border-t border-border",children:y.jsxs("div",{className:"text-xs text-muted-foreground",children:["Total problems detected: ",y.jsx("span",{className:"font-semibold text-foreground",children:F})]})}),d&&U.length>0&&y.jsx(ns,{className:"h-48 border border-border rounded p-2",children:y.jsx("div",{className:"space-y-1",children:U.map(Y=>{const ae=i(Y.id),z=a().find($=>$.nodeId===Y.id);return y.jsx(De,{variant:"ghost",size:"sm",className:"w-full justify-start text-xs h-auto py-1.5",onClick:()=>Q(Y.id),children:y.jsxs("div",{className:"flex items-center gap-2 w-full",children:[z?.criticalPath&&y.jsx(pt,{variant:"outline",className:"bg-purple-500/20 text-purple-500 border-purple-500/50 text-xs px-1",children:"Critical"}),y.jsx("span",{className:"flex-1 text-left truncate",children:Y.data.label}),ae&&ae.errorRate*100>=k&&y.jsxs(pt,{variant:"destructive",className:"text-xs px-1",children:[(ae.errorRate*100).toFixed(0),"%"]})]})},Y.id)})})}),!n&&y.jsx("div",{className:"text-xs text-muted-foreground text-center py-4",children:"Start emulation to see problems"})]})]})}function Ej(){const{nodes:c,connections:e}=ke(),{isRunning:t,getComponentMetrics:s,getConnectionMetrics:n}=_t(),{getAllComponentStatuses:i,getSystemAnalysis:a}=Ma(),[o,l]=R.useState(""),[d,h]=R.useState("all");if(!t)return y.jsx(Ms,{className:"h-full",children:y.jsxs(Cn,{children:[y.jsx(Rn,{children:"Diagnostics"}),y.jsx(ba,{children:"Start emulation to see diagnostics"})]})});const p=[],g=i();a(),c.forEach(x=>{const S=s(x.id),T=g.find(k=>k.nodeId===x.id);if(!S||!T)return;const E={nodeId:x.id,nodeLabel:x.data.label,problem:"",severity:"info",metrics:{throughput:S.throughput,latency:S.latency,errorRate:S.errorRate,utilization:S.utilization},affectedConnections:[],recommendations:[]},A=e.filter(k=>k.source===x.id||k.target===x.id?n(k.id)?.bottleneck:!1);if(A.length>0){E.problem=`Bottleneck detected in ${A.length} connection(s)`,E.severity="critical",E.affectedConnections=A.map(k=>k.id),E.rootCause="High throughput dependency or backpressure",E.recommendations=["Consider scaling this component horizontally","Optimize data processing logic","Check for connection bandwidth limits"],p.push(E);return}if(S.errorRate>.05){E.problem=`High error rate: ${(S.errorRate*100).toFixed(1)}%`,E.severity=S.errorRate>.1?"critical":"warning",E.rootCause="Component is experiencing failures",E.recommendations=["Check component logs for error details","Verify input data format and validation","Review retry and error handling logic"],p.push(E);return}if(S.latency>1e3){E.problem=`High latency: ${S.latency.toFixed(0)}ms`,E.severity=S.latency>2e3?"critical":"warning",E.rootCause="Component processing is slow",E.recommendations=["Optimize database queries or data processing","Consider caching frequently accessed data","Review component configuration for performance"],p.push(E);return}if(S.utilization>.9){E.problem=`High utilization: ${(S.utilization*100).toFixed(0)}%`,E.severity="warning",E.rootCause="Component is near capacity",E.recommendations=["Consider scaling this component","Optimize resource usage","Monitor for potential failures"],p.push(E);return}(T.health==="critical"||T.health==="down")&&(E.problem=`Component health: ${T.health}`,E.severity="critical",E.rootCause="Component is in critical state or down",E.recommendations=["Immediately check component status","Review error logs and metrics","Consider failover or restart"],p.push(E))});const v=p.filter(x=>!(d!=="all"&&x.severity!==d||o&&!x.nodeLabel.toLowerCase().includes(o.toLowerCase()))),b=x=>{switch(x){case"critical":return y.jsx(va,{className:"w-4 h-4 text-red-500"});case"warning":return y.jsx(rn,{className:"w-4 h-4 text-yellow-500"});default:return y.jsx(Sa,{className:"w-4 h-4 text-blue-500"})}},M=x=>{switch(x){case"critical":return y.jsx(pt,{variant:"destructive",className:"text-xs",children:"Critical"});case"warning":return y.jsx(pt,{variant:"outline",className:"border-yellow-500 text-yellow-600 text-xs",children:"Warning"});default:return y.jsx(pt,{variant:"outline",className:"text-xs",children:"Info"})}};return y.jsxs(Ms,{className:"h-full flex flex-col",children:[y.jsxs(Cn,{className:"pb-3",children:[y.jsx(Rn,{className:"text-sm font-semibold",children:"Diagnostics"}),y.jsxs(ba,{className:"text-xs text-muted-foreground",children:[v.length," problem",v.length!==1?"s":""," detected"]})]}),y.jsxs(Tn,{className:"flex-1 flex flex-col overflow-hidden p-0",children:[y.jsxs("div",{className:"p-4 border-b border-border space-y-2",children:[y.jsxs("div",{className:"relative",children:[y.jsx(Gr,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),y.jsx(ct,{placeholder:"Search components...",value:o,onChange:x=>l(x.target.value),className:"pl-8 h-8 text-xs"})]}),y.jsxs("div",{className:"flex gap-1",children:[y.jsx(De,{variant:d==="all"?"default":"outline",size:"sm",className:"h-7 text-xs px-2",onClick:()=>h("all"),children:"All"}),y.jsx(De,{variant:d==="critical"?"default":"outline",size:"sm",className:"h-7 text-xs px-2",onClick:()=>h("critical"),children:"Critical"}),y.jsx(De,{variant:d==="warning"?"default":"outline",size:"sm",className:"h-7 text-xs px-2",onClick:()=>h("warning"),children:"Warning"})]})]}),y.jsx(ns,{className:"flex-1",children:y.jsx("div",{className:"p-4 space-y-2",children:v.length===0?y.jsxs("div",{className:"text-center text-sm text-muted-foreground py-6",children:[y.jsx(wa,{className:"w-6 h-6 mx-auto mb-1.5 opacity-50"}),y.jsx("p",{children:"No problems detected"})]}):v.map((x,S)=>y.jsxs(Ms,{className:`border-l-4 ${x.severity==="critical"?"border-l-red-500":x.severity==="warning"?"border-l-yellow-500":"border-l-blue-500"}`,children:[y.jsxs(Cn,{className:"pb-2 p-3",children:[y.jsxs("div",{className:"flex items-start justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1.5",children:[b(x.severity),y.jsx(Rn,{className:"text-xs font-semibold",children:x.nodeLabel}),M(x.severity)]}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>{c.find(E=>E.id===x.nodeId)&&ke.getState().selectNode(x.nodeId)},children:y.jsx(YA,{className:"w-3.5 h-3.5"})})]}),y.jsx(ba,{className:"text-xs mt-0.5",children:x.problem})]}),y.jsxs(Tn,{className:"pt-0 p-3 space-y-2",children:[y.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[x.metrics.throughput!==void 0&&y.jsxs("div",{children:[y.jsx("span",{className:"text-muted-foreground",children:"Throughput: "}),y.jsxs("span",{className:"font-mono",children:[x.metrics.throughput.toFixed(0)," ops/s"]})]}),x.metrics.latency!==void 0&&y.jsxs("div",{children:[y.jsx("span",{className:"text-muted-foreground",children:"Latency: "}),y.jsxs("span",{className:"font-mono",children:[x.metrics.latency.toFixed(0),"ms"]})]}),x.metrics.errorRate!==void 0&&y.jsxs("div",{children:[y.jsx("span",{className:"text-muted-foreground",children:"Error Rate: "}),y.jsxs("span",{className:"font-mono",children:[(x.metrics.errorRate*100).toFixed(1),"%"]})]}),x.metrics.utilization!==void 0&&y.jsxs("div",{children:[y.jsx("span",{className:"text-muted-foreground",children:"Utilization: "}),y.jsxs("span",{className:"font-mono",children:[(x.metrics.utilization*100).toFixed(0),"%"]})]})]}),x.rootCause&&y.jsxs("div",{children:[y.jsx("div",{className:"text-xs font-semibold text-muted-foreground mb-0.5",children:"Root Cause:"}),y.jsx("div",{className:"text-xs",children:x.rootCause})]}),x.recommendations.length>0&&y.jsxs("div",{children:[y.jsx("div",{className:"text-xs font-semibold text-muted-foreground mb-0.5",children:"Recommendations:"}),y.jsx("ul",{className:"text-xs space-y-0.5 list-disc list-inside",children:x.recommendations.map((T,E)=>y.jsx("li",{className:"text-muted-foreground",children:T},E))})]})]})]},S))})})]})]})}function kj(){const{alerts:c,acknowledgeAlert:e,clearAlerts:t,getCriticalAlerts:s,getWarningAlerts:n}=Jf(),{selectNode:i}=ke(),a=s(),o=n();c.filter(h=>h.type==="info");const l=h=>{switch(h){case"critical":return y.jsx(va,{className:"w-4 h-4 text-red-500"});case"warning":return y.jsx(rn,{className:"w-4 h-4 text-yellow-500"});default:return y.jsx(zb,{className:"w-4 h-4 text-blue-500"})}},d=h=>{i(h)};return c.length===0?y.jsxs(Ms,{className:"h-full",children:[y.jsx(Cn,{children:y.jsx(Rn,{className:"text-sm",children:"Alerts"})}),y.jsx(Tn,{children:y.jsxs("div",{className:"text-center text-sm text-muted-foreground py-8",children:[y.jsx(tp,{className:"w-8 h-8 mx-auto mb-2 opacity-50 text-green-500"}),y.jsx("p",{children:"No active alerts"})]})})]}):y.jsxs(Ms,{className:"h-full flex flex-col",children:[y.jsx(Cn,{className:"pb-3",children:y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs("div",{children:[y.jsx(Rn,{className:"text-sm",children:"Alerts"}),y.jsxs("div",{className:"flex gap-2 mt-1",children:[a.length>0&&y.jsxs(pt,{variant:"destructive",className:"text-xs",children:[a.length," Critical"]}),o.length>0&&y.jsxs(pt,{variant:"outline",className:"text-xs border-yellow-500 text-yellow-600",children:[o.length," Warning"]})]})]}),y.jsx(De,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:t,children:"Clear All"})]})}),y.jsx(Tn,{className:"flex-1 overflow-hidden p-0",children:y.jsx(ns,{className:"h-full",children:y.jsx("div",{className:"p-4 space-y-2",children:c.map(h=>y.jsx(Ms,{className:`border-l-4 ${h.type==="critical"?"border-l-red-500 bg-red-500/5":h.type==="warning"?"border-l-yellow-500 bg-yellow-500/5":"border-l-blue-500 bg-blue-500/5"}`,children:y.jsx(Tn,{className:"p-3",children:y.jsxs("div",{className:"flex items-start justify-between gap-2",children:[y.jsxs("div",{className:"flex items-start gap-2 flex-1",children:[l(h.type),y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[y.jsx("h4",{className:"text-xs font-semibold",children:h.title}),y.jsx(pt,{variant:h.type==="critical"?"destructive":h.type==="warning"?"outline":"secondary",className:"text-xs",children:h.type})]}),y.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:h.message}),h.nodeLabel&&y.jsxs(De,{variant:"ghost",size:"sm",className:"h-6 text-xs p-1",onClick:()=>h.nodeId&&d(h.nodeId),children:["View: ",h.nodeLabel]}),y.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:new Date(h.timestamp).toLocaleTimeString()})]})]}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>e(h.id),children:y.jsx(cn,{className:"w-3 h-3"})})]})})},h.id))})})})]})}function Aj(){const{nodes:c,connections:e}=ke(),{isRunning:t,componentMetrics:s,connectionMetrics:n}=_t(),{getSystemAnalysis:i}=Ma(),{getCriticalAlerts:a,getWarningAlerts:o}=Jf(),l=R.useMemo(()=>{if(!t)return{totalThroughput:0,averageLatency:0,totalErrorRate:0,activeComponents:0,activeConnections:0,bottlenecks:0,healthyComponents:0,degradedComponents:0,criticalComponents:0};let p=0,g=0,v=0,b=0,M=0,x=0,S=0,T=0,E=0;s.forEach(L=>{(L.throughput>.1||L.errorRate>.001)&&(b++,p+=L.throughput||0,g+=L.latency||0,v+=L.errorRate||0)}),n.forEach(L=>{(L.effectiveThroughput>0||L.traffic>0)&&(M++,L.bottleneck&&x++)});const A=Ma.getState();c.forEach(L=>{const I=A.getComponentStatus(L.id);if(I)switch(I.health){case"healthy":S++;break;case"degraded":T++;break;case"critical":case"down":E++;break}});const k=b>0?g/b:0,D=b>0?v/b:0;return{totalThroughput:p,averageLatency:k,totalErrorRate:D,activeComponents:b,activeConnections:M,bottlenecks:x,healthyComponents:S,degradedComponents:T,criticalComponents:E}},[t,s,n,c]),d=a(),h=o();return t?y.jsxs("div",{className:"space-y-2.5",children:[y.jsxs("div",{className:"space-y-1.5",children:[y.jsx(on,{level:5,children:"Performance"}),y.jsxs("div",{className:"grid grid-cols-2 gap-1.5",children:[y.jsxs("div",{className:"p-1.5 bg-card border border-border rounded",children:[y.jsx(et,{size:"micro",muted:!0,className:"mb-0.5",children:"Total Throughput"}),y.jsxs(pa,{status:"success",size:"base",weight:"bold",children:[l.totalThroughput.toFixed(0),y.jsx(et,{size:"micro",muted:!0,className:"ml-0.5",children:"ops/s"})]})]}),y.jsxs("div",{className:"p-1.5 bg-card border border-border rounded",children:[y.jsx(et,{size:"micro",muted:!0,className:"mb-0.5",children:"Avg Latency"}),y.jsxs(pa,{status:"warning",size:"base",weight:"bold",children:[l.averageLatency.toFixed(0),y.jsx(et,{size:"micro",muted:!0,className:"ml-0.5",children:"ms"})]})]}),y.jsxs("div",{className:"p-1.5 bg-card border border-border rounded",children:[y.jsx(et,{size:"micro",muted:!0,className:"mb-0.5",children:"Error Rate"}),y.jsxs(pa,{status:"error",size:"base",weight:"bold",children:[(l.totalErrorRate*100).toFixed(2),y.jsx(et,{size:"micro",muted:!0,className:"ml-0.5",children:"%"})]})]}),y.jsxs("div",{className:"p-1.5 bg-card border border-border rounded",children:[y.jsx(et,{size:"micro",muted:!0,className:"mb-0.5",children:"Bottlenecks"}),y.jsxs(pa,{status:"warning",size:"base",weight:"bold",children:[l.bottlenecks,y.jsx(et,{size:"micro",muted:!0,className:"ml-0.5",children:"conn"})]})]})]})]}),y.jsxs("div",{className:"space-y-1.5",children:[y.jsx(on,{level:5,children:"Component Health"}),y.jsxs("div",{className:"space-y-0.5",children:[y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx(tp,{className:"w-4 h-4 text-success"}),y.jsx(et,{size:"micro",children:"Healthy"})]}),y.jsx(pt,{variant:"outline",className:"bg-success/20 border-success/50 text-success text-xs px-1 py-0",children:l.healthyComponents})]}),y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx(rn,{className:"w-4 h-4 text-warning"}),y.jsx(et,{size:"micro",children:"Degraded"})]}),y.jsx(pt,{variant:"outline",className:"bg-warning/20 border-warning/50 text-warning text-xs px-1 py-0",children:l.degradedComponents})]}),y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx(rn,{className:"w-4 h-4 text-destructive"}),y.jsx(et,{size:"micro",children:"Critical/Down"})]}),y.jsx(pt,{variant:"outline",className:"bg-destructive/20 border-destructive/50 text-destructive text-xs px-1 py-0",children:l.criticalComponents})]})]})]}),y.jsxs("div",{className:"space-y-1.5",children:[y.jsx(on,{level:5,children:"Activity"}),y.jsxs("div",{className:"space-y-0.5",children:[y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx(PD,{className:"w-4 h-4 text-muted-foreground"}),y.jsx(et,{size:"micro",children:"Active Components"})]}),y.jsxs(et,{mono:!0,size:"micro",children:[l.activeComponents," / ",c.length]})]}),y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx(Hb,{className:"w-4 h-4 text-muted-foreground"}),y.jsx(et,{size:"micro",children:"Active Connections"})]}),y.jsxs(et,{mono:!0,size:"micro",children:[l.activeConnections," / ",e.length]})]})]})]}),(d.length>0||h.length>0)&&y.jsxs("div",{className:"space-y-1.5",children:[y.jsx(on,{level:5,children:"Alerts"}),y.jsxs("div",{className:"space-y-0.5",children:[d.length>0&&y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsx(pa,{status:"error",size:"micro",children:"Critical"}),y.jsx(pt,{variant:"destructive",className:"text-xs px-1 py-0",children:d.length})]}),h.length>0&&y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsx(pa,{status:"warning",size:"micro",children:"Warnings"}),y.jsx(pt,{variant:"outline",className:"border-warning text-warning text-xs px-1 py-0",children:h.length})]})]})]})]}):y.jsxs("div",{className:"text-center text-sm text-muted-foreground py-8",children:[y.jsx(wa,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),y.jsx("p",{children:"Start emulation to see system statistics"})]})}const El=43200,Uv=1440,Fv=Symbol.for("constructDateFrom");function Fp(c,e){return typeof c=="function"?c(e):c&&typeof c=="object"&&Fv in c?c[Fv](e):c instanceof Date?new c.constructor(e):new Date(e)}function Bi(c,e){return Fp(c,c)}let Dj={};function Pj(){return Dj}function Qv(c){const e=Bi(c),t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()));return t.setUTCFullYear(e.getFullYear()),+c-+t}function Qp(c,...e){const t=Fp.bind(null,c||e.find(s=>typeof s=="object"));return e.map(t)}function jl(c,e){const t=+Bi(c)-+Bi(e);return t<0?-1:t>0?1:t}function Lj(c){return Fp(c,Date.now())}function _j(c,e,t){const[s,n]=Qp(t?.in,c,e),i=s.getFullYear()-n.getFullYear(),a=s.getMonth()-n.getMonth();return i*12+a}function Ij(c){return e=>{const s=(c?Math[c]:Math.trunc)(e);return s===0?0:s}}function Nj(c,e){return+Bi(c)-+Bi(e)}function zj(c,e){const t=Bi(c);return t.setHours(23,59,59,999),t}function jj(c,e){const t=Bi(c),s=t.getMonth();return t.setFullYear(t.getFullYear(),s+1,0),t.setHours(23,59,59,999),t}function Oj(c,e){const t=Bi(c);return+zj(t)==+jj(t)}function qj(c,e,t){const[s,n,i]=Qp(t?.in,c,c,e),a=jl(n,i),o=Math.abs(_j(n,i));if(o<1)return 0;n.getMonth()===1&&n.getDate()>27&&n.setDate(30),n.setMonth(n.getMonth()-a*o);let l=jl(n,i)===-a;Oj(s)&&o===1&&jl(s,i)===1&&(l=!1);const d=a*(o-+l);return d===0?0:d}function Hj(c,e,t){const s=Nj(c,e)/1e3;return Ij(t?.roundingMethod)(s)}const $j={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Bj=(c,e,t)=>{let s;const n=$j[c];return typeof n=="string"?s=n:e===1?s=n.one:s=n.other.replace("{{count}}",e.toString()),t?.addSuffix?t.comparison&&t.comparison>0?"in "+s:s+" ago":s};function vf(c){return(e={})=>{const t=e.width?String(e.width):c.defaultWidth;return c.formats[t]||c.formats[c.defaultWidth]}}const Uj={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},Fj={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},Qj={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Vj={date:vf({formats:Uj,defaultWidth:"full"}),time:vf({formats:Fj,defaultWidth:"full"}),dateTime:vf({formats:Qj,defaultWidth:"full"})},Gj={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Wj=(c,e,t,s)=>Gj[c];function Pr(c){return(e,t)=>{const s=t?.context?String(t.context):"standalone";let n;if(s==="formatting"&&c.formattingValues){const a=c.defaultFormattingWidth||c.defaultWidth,o=t?.width?String(t.width):a;n=c.formattingValues[o]||c.formattingValues[a]}else{const a=c.defaultWidth,o=t?.width?String(t.width):c.defaultWidth;n=c.values[o]||c.values[a]}const i=c.argumentCallback?c.argumentCallback(e):e;return n[i]}}const Kj={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Yj={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},Xj={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},Jj={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Zj={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},eO={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},tO=(c,e)=>{const t=Number(c),s=t%100;if(s>20||s<10)switch(s%10){case 1:return t+"st";case 2:return t+"nd";case 3:return t+"rd"}return t+"th"},sO={ordinalNumber:tO,era:Pr({values:Kj,defaultWidth:"wide"}),quarter:Pr({values:Yj,defaultWidth:"wide",argumentCallback:c=>c-1}),month:Pr({values:Xj,defaultWidth:"wide"}),day:Pr({values:Jj,defaultWidth:"wide"}),dayPeriod:Pr({values:Zj,defaultWidth:"wide",formattingValues:eO,defaultFormattingWidth:"wide"})};function Lr(c){return(e,t={})=>{const s=t.width,n=s&&c.matchPatterns[s]||c.matchPatterns[c.defaultMatchWidth],i=e.match(n);if(!i)return null;const a=i[0],o=s&&c.parsePatterns[s]||c.parsePatterns[c.defaultParseWidth],l=Array.isArray(o)?iO(o,p=>p.test(a)):nO(o,p=>p.test(a));let d;d=c.valueCallback?c.valueCallback(l):l,d=t.valueCallback?t.valueCallback(d):d;const h=e.slice(a.length);return{value:d,rest:h}}}function nO(c,e){for(const t in c)if(Object.prototype.hasOwnProperty.call(c,t)&&e(c[t]))return t}function iO(c,e){for(let t=0;t<c.length;t++)if(e(c[t]))return t}function aO(c){return(e,t={})=>{const s=e.match(c.matchPattern);if(!s)return null;const n=s[0],i=e.match(c.parsePattern);if(!i)return null;let a=c.valueCallback?c.valueCallback(i[0]):i[0];a=t.valueCallback?t.valueCallback(a):a;const o=e.slice(n.length);return{value:a,rest:o}}}const oO=/^(\d+)(th|st|nd|rd)?/i,rO=/\d+/i,cO={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},lO={any:[/^b/i,/^(a|c)/i]},uO={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},dO={any:[/1/i,/2/i,/3/i,/4/i]},hO={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},fO={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},pO={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},gO={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},mO={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},yO={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},vO={ordinalNumber:aO({matchPattern:oO,parsePattern:rO,valueCallback:c=>parseInt(c,10)}),era:Lr({matchPatterns:cO,defaultMatchWidth:"wide",parsePatterns:lO,defaultParseWidth:"any"}),quarter:Lr({matchPatterns:uO,defaultMatchWidth:"wide",parsePatterns:dO,defaultParseWidth:"any",valueCallback:c=>c+1}),month:Lr({matchPatterns:hO,defaultMatchWidth:"wide",parsePatterns:fO,defaultParseWidth:"any"}),day:Lr({matchPatterns:pO,defaultMatchWidth:"wide",parsePatterns:gO,defaultParseWidth:"any"}),dayPeriod:Lr({matchPatterns:mO,defaultMatchWidth:"any",parsePatterns:yO,defaultParseWidth:"any"})},bO={code:"en-US",formatDistance:Bj,formatLong:Vj,formatRelative:Wj,localize:sO,match:vO,options:{weekStartsOn:0,firstWeekContainsDate:1}};function MO(c,e,t){const s=Pj(),n=t?.locale??s.locale??bO,i=2520,a=jl(c,e);if(isNaN(a))throw new RangeError("Invalid time value");const o=Object.assign({},t,{addSuffix:t?.addSuffix,comparison:a}),[l,d]=Qp(t?.in,...a>0?[e,c]:[c,e]),h=Hj(d,l),p=(Qv(d)-Qv(l))/1e3,g=Math.round((h-p)/60);let v;if(g<2)return t?.includeSeconds?h<5?n.formatDistance("lessThanXSeconds",5,o):h<10?n.formatDistance("lessThanXSeconds",10,o):h<20?n.formatDistance("lessThanXSeconds",20,o):h<40?n.formatDistance("halfAMinute",0,o):h<60?n.formatDistance("lessThanXMinutes",1,o):n.formatDistance("xMinutes",1,o):g===0?n.formatDistance("lessThanXMinutes",1,o):n.formatDistance("xMinutes",g,o);if(g<45)return n.formatDistance("xMinutes",g,o);if(g<90)return n.formatDistance("aboutXHours",1,o);if(g<Uv){const b=Math.round(g/60);return n.formatDistance("aboutXHours",b,o)}else{if(g<i)return n.formatDistance("xDays",1,o);if(g<El){const b=Math.round(g/Uv);return n.formatDistance("xDays",b,o)}else if(g<El*2)return v=Math.round(g/El),n.formatDistance("aboutXMonths",v,o)}if(v=qj(d,l),v<12){const b=Math.round(g/El);return n.formatDistance("xMonths",b,o)}else{const b=v%12,M=Math.trunc(v/12);return b<3?n.formatDistance("aboutXYears",M,o):b<9?n.formatDistance("overXYears",M,o):n.formatDistance("almostXYears",M+1,o)}}function wO(c,e){return MO(c,Lj(c),e)}function SO(){const{errors:c,updateErrors:e,clearErrors:t,removeError:s,getErrorCount:n,getStats:i}=Pb(),{nodes:a}=ke(),[o,l]=R.useState("all"),[d,h]=R.useState("all"),[p,g]=R.useState("all"),[v,b]=R.useState("");R.useEffect(()=>{e();const D=setInterval(()=>{e()},1e3);return()=>clearInterval(D)},[e]);const M=i(),x=R.useMemo(()=>{let D=c;if(o!=="all"&&(D=D.filter(L=>L.severity===o)),d!=="all"&&(D=D.filter(L=>L.source===d)),p!=="all"&&(D=D.filter(L=>L.componentId===p)),v){const L=v.toLowerCase();D=D.filter(I=>I.message.toLowerCase().includes(L)||I.componentLabel?.toLowerCase().includes(L)||I.componentType?.toLowerCase().includes(L)||I.errorType?.toLowerCase().includes(L))}return D},[c,o,d,p,v]),S=R.useMemo(()=>{const D=new Map;return c.forEach(L=>{L.componentId&&L.componentLabel&&D.set(L.componentId,{id:L.componentId,label:L.componentLabel,type:L.componentType||"unknown"})}),Array.from(D.values())},[c]),T=D=>{switch(D){case"critical":return y.jsx(eD,{className:"h-3 w-3 text-red-500"});case"warning":return y.jsx(rn,{className:"h-3 w-3 text-yellow-500"});case"info":return y.jsx(zb,{className:"h-3 w-3 text-blue-500"})}},E=D=>{switch(D){case"critical":return y.jsx(pt,{variant:"destructive",className:"text-[9px] px-1 py-0 h-4",children:"Critical"});case"warning":return y.jsx(pt,{variant:"outline",className:"text-[9px] px-1 py-0 h-4 bg-yellow-500/10 text-yellow-600 border-yellow-500",children:"Warning"});case"info":return y.jsx(pt,{variant:"outline",className:"text-[9px] px-1 py-0 h-4 bg-blue-500/10 text-blue-600 border-blue-500",children:"Info"})}},A=D=>{const L={"emulation-engine":"bg-purple-500/10 text-purple-600 border-purple-500","component-engine":"bg-green-500/10 text-green-600 border-green-500","alert-system":"bg-orange-500/10 text-orange-600 border-orange-500","data-flow":"bg-cyan-500/10 text-cyan-600 border-cyan-500","routing-engine":"bg-pink-500/10 text-pink-600 border-pink-500",initialization:"bg-indigo-500/10 text-indigo-600 border-indigo-500",configuration:"bg-gray-500/10 text-gray-600 border-gray-500",unknown:"bg-gray-500/10 text-gray-600 border-gray-500"},I={"emulation-engine":"Engine","component-engine":"Component","alert-system":"Alert","data-flow":"DataFlow","routing-engine":"Routing",initialization:"Init",configuration:"Config",unknown:"Unknown"};return y.jsx(pt,{variant:"outline",className:`text-[9px] px-1 py-0 h-4 ${L[D]||L.unknown}`,children:I[D]||I.unknown})},k=D=>{try{return wO(new Date(D),{addSuffix:!0})}catch{return"unknown time"}};return y.jsxs("div",{className:"h-full flex flex-col",children:[y.jsxs("div",{className:"p-2 border-b border-border",children:[y.jsxs("div",{className:"flex items-center justify-between mb-2",children:[y.jsxs("div",{className:"flex items-center gap-2",children:[y.jsx(Sa,{className:"h-4 w-4 text-muted-foreground"}),y.jsx("h3",{className:"text-sm font-semibold",children:"Simulation Errors"})]}),c.length>0&&y.jsxs(De,{variant:"ghost",size:"sm",onClick:t,className:"h-6 text-xs",children:[y.jsx(su,{className:"h-3 w-3 mr-1"}),"Clear All"]})]}),y.jsxs("div",{className:"flex gap-2 text-xs",children:[y.jsxs(pt,{variant:"outline",className:"text-xs",children:["Total: ",M.total]}),M.critical>0&&y.jsxs(pt,{variant:"destructive",className:"text-xs",children:["Critical: ",M.critical]}),M.warning>0&&y.jsxs(pt,{variant:"outline",className:"text-xs bg-yellow-500/10 text-yellow-600 border-yellow-500",children:["Warning: ",M.warning]}),M.info>0&&y.jsxs(pt,{variant:"outline",className:"text-xs bg-blue-500/10 text-blue-600 border-blue-500",children:["Info: ",M.info]})]})]}),y.jsxs("div",{className:"p-2 border-b border-border space-y-2",children:[y.jsxs("div",{className:"relative",children:[y.jsx(Gr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-muted-foreground"}),y.jsx(ct,{placeholder:"Search errors...",value:v,onChange:D=>b(D.target.value),className:"h-7 pl-7 text-xs"})]}),y.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[y.jsxs(ji,{value:o,onValueChange:D=>l(D),children:[y.jsx(ni,{className:"h-7 text-xs",children:y.jsx(Oi,{placeholder:"Severity"})}),y.jsxs(ii,{children:[y.jsx(Ge,{value:"all",children:"All Severities"}),y.jsx(Ge,{value:"critical",children:"Critical"}),y.jsx(Ge,{value:"warning",children:"Warning"}),y.jsx(Ge,{value:"info",children:"Info"})]})]}),y.jsxs(ji,{value:d,onValueChange:D=>h(D),children:[y.jsx(ni,{className:"h-7 text-xs",children:y.jsx(Oi,{placeholder:"Source"})}),y.jsxs(ii,{children:[y.jsx(Ge,{value:"all",children:"All Sources"}),y.jsx(Ge,{value:"emulation-engine",children:"Emulation Engine"}),y.jsx(Ge,{value:"component-engine",children:"Component Engine"}),y.jsx(Ge,{value:"alert-system",children:"Alert System"}),y.jsx(Ge,{value:"data-flow",children:"Data Flow"}),y.jsx(Ge,{value:"routing-engine",children:"Routing Engine"}),y.jsx(Ge,{value:"initialization",children:"Initialization"}),y.jsx(Ge,{value:"configuration",children:"Configuration"})]})]})]}),S.length>0&&y.jsxs(ji,{value:p,onValueChange:g,children:[y.jsx(ni,{className:"h-7 text-xs",children:y.jsx(Oi,{placeholder:"Component"})}),y.jsxs(ii,{children:[y.jsx(Ge,{value:"all",children:"All Components"}),S.map(D=>y.jsxs(Ge,{value:D.id,children:[D.label," (",D.type,")"]},D.id))]})]})]}),y.jsx(ns,{className:"flex-1",children:y.jsx("div",{className:"p-1.5 space-y-1.5",children:x.length===0?y.jsx("div",{className:"text-center text-sm text-muted-foreground py-8",children:c.length===0?y.jsxs("div",{className:"flex flex-col items-center gap-2",children:[y.jsx(Sa,{className:"h-8 w-8 opacity-50"}),y.jsx("p",{children:"No errors detected"})]}):y.jsxs("div",{className:"flex flex-col items-center gap-2",children:[y.jsx(Nb,{className:"h-8 w-8 opacity-50"}),y.jsx("p",{children:"No errors match the filters"})]})}):x.map(D=>y.jsxs(Ms,{className:`border-l-2 ${D.severity==="critical"?"border-l-red-500":D.severity==="warning"?"border-l-yellow-500":"border-l-blue-500"}`,children:[y.jsx(Cn,{className:"pb-1 p-1.5",children:y.jsxs("div",{className:"flex items-start justify-between gap-1",children:[y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsxs("div",{className:"flex items-center gap-1 mb-0.5 flex-wrap",children:[y.jsx("span",{className:"flex-shrink-0",children:T(D.severity)}),y.jsx(Rn,{className:"text-[11px] font-semibold truncate",children:D.componentLabel||"System"}),y.jsx("span",{className:"flex-shrink-0",children:E(D.severity)}),y.jsx("span",{className:"flex-shrink-0",children:A(D.source)}),D.count&&D.count>1&&y.jsxs(pt,{variant:"outline",className:"text-[9px] px-1 py-0 h-4",children:[D.count,"x"]})]}),y.jsx(ba,{className:"text-[10px] mt-0.5 break-words line-clamp-2",children:D.message}),y.jsxs("div",{className:"flex items-center gap-2 mt-0.5 text-[9px] text-muted-foreground",children:[y.jsx("span",{children:k(D.timestamp)}),D.componentType&&y.jsxs("span",{className:"truncate",children:[" ",D.componentType]}),D.errorType&&y.jsxs("span",{className:"truncate",children:[" ",D.errorType]})]})]}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-5 w-5 flex-shrink-0",onClick:()=>s(D.id),children:y.jsx(cn,{className:"h-3 w-3"})})]})}),D.context&&Object.keys(D.context).length>0||D.stack?y.jsxs(Tn,{className:"pt-0 p-1.5 space-y-1",children:[D.context&&Object.keys(D.context).length>0&&y.jsxs("details",{className:"text-[9px]",children:[y.jsx("summary",{className:"cursor-pointer text-muted-foreground hover:text-foreground py-0.5",children:"Context"}),y.jsx("pre",{className:"mt-0.5 p-1 bg-muted rounded text-[8px] overflow-x-auto max-h-20",children:JSON.stringify(D.context,null,2)})]}),D.stack&&y.jsxs("details",{className:"text-[9px]",children:[y.jsx("summary",{className:"cursor-pointer text-muted-foreground hover:text-foreground py-0.5",children:"Stack"}),y.jsx("pre",{className:"mt-0.5 p-1 bg-muted rounded text-[8px] overflow-x-auto max-h-20",children:D.stack})]})]}):null]},D.id))})})]})}var zu="Checkbox",[xO]=ws(zu),[CO,Vp]=xO(zu);function RO(c){const{__scopeCheckbox:e,checked:t,children:s,defaultChecked:n,disabled:i,form:a,name:o,onCheckedChange:l,required:d,value:h="on",internal_do_not_use_render:p}=c,[g,v]=En({prop:t,defaultProp:n??!1,onChange:l,caller:zu}),[b,M]=R.useState(null),[x,S]=R.useState(null),T=R.useRef(!1),E=b?!!a||!!b.closest("form"):!0,A={checked:g,disabled:i,setChecked:v,control:b,setControl:M,name:o,form:a,value:h,hasConsumerStoppedPropagationRef:T,required:d,defaultChecked:qi(n)?!1:n,isFormControl:E,bubbleInput:x,setBubbleInput:S};return y.jsx(CO,{scope:e,...A,children:TO(p)?p(A):s})}var oC="CheckboxTrigger",rC=R.forwardRef(({__scopeCheckbox:c,onKeyDown:e,onClick:t,...s},n)=>{const{control:i,value:a,disabled:o,checked:l,required:d,setControl:h,setChecked:p,hasConsumerStoppedPropagationRef:g,isFormControl:v,bubbleInput:b}=Vp(oC,c),M=Ne(n,h),x=R.useRef(l);return R.useEffect(()=>{const S=i?.form;if(S){const T=()=>p(x.current);return S.addEventListener("reset",T),()=>S.removeEventListener("reset",T)}},[i,p]),y.jsx(Le.button,{type:"button",role:"checkbox","aria-checked":qi(l)?"mixed":l,"aria-required":d,"data-state":hC(l),"data-disabled":o?"":void 0,disabled:o,value:a,...s,ref:M,onKeyDown:be(e,S=>{S.key==="Enter"&&S.preventDefault()}),onClick:be(t,S=>{p(T=>qi(T)?!0:!T),b&&v&&(g.current=S.isPropagationStopped(),g.current||S.stopPropagation())})})});rC.displayName=oC;var Gp=R.forwardRef((c,e)=>{const{__scopeCheckbox:t,name:s,checked:n,defaultChecked:i,required:a,disabled:o,value:l,onCheckedChange:d,form:h,...p}=c;return y.jsx(RO,{__scopeCheckbox:t,checked:n,defaultChecked:i,disabled:o,required:a,onCheckedChange:d,name:s,form:h,value:l,internal_do_not_use_render:({isFormControl:g})=>y.jsxs(y.Fragment,{children:[y.jsx(rC,{...p,ref:e,__scopeCheckbox:t}),g&&y.jsx(dC,{__scopeCheckbox:t})]})})});Gp.displayName=zu;var cC="CheckboxIndicator",lC=R.forwardRef((c,e)=>{const{__scopeCheckbox:t,forceMount:s,...n}=c,i=Vp(cC,t);return y.jsx(cs,{present:s||qi(i.checked)||i.checked===!0,children:y.jsx(Le.span,{"data-state":hC(i.checked),"data-disabled":i.disabled?"":void 0,...n,ref:e,style:{pointerEvents:"none",...c.style}})})});lC.displayName=cC;var uC="CheckboxBubbleInput",dC=R.forwardRef(({__scopeCheckbox:c,...e},t)=>{const{control:s,hasConsumerStoppedPropagationRef:n,checked:i,defaultChecked:a,required:o,disabled:l,name:d,value:h,form:p,bubbleInput:g,setBubbleInput:v}=Vp(uC,c),b=Ne(t,v),M=Au(i),x=xu(s);R.useEffect(()=>{const T=g;if(!T)return;const E=window.HTMLInputElement.prototype,k=Object.getOwnPropertyDescriptor(E,"checked").set,D=!n.current;if(M!==i&&k){const L=new Event("click",{bubbles:D});T.indeterminate=qi(i),k.call(T,qi(i)?!1:i),T.dispatchEvent(L)}},[g,M,i,n]);const S=R.useRef(qi(i)?!1:i);return y.jsx(Le.input,{type:"checkbox","aria-hidden":!0,defaultChecked:a??S.current,required:o,disabled:l,name:d,value:h,form:p,...e,tabIndex:-1,ref:b,style:{...e.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0,transform:"translateX(-100%)"}})});dC.displayName=uC;function TO(c){return typeof c=="function"}function qi(c){return c==="indeterminate"}function hC(c){return qi(c)?"indeterminate":c?"checked":"unchecked"}const $f=R.forwardRef(({className:c,...e},t)=>y.jsx(Gp,{ref:t,className:Ae("grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",c),...e,children:y.jsx(lC,{className:Ae("grid place-content-center text-current"),children:y.jsx(Zf,{className:"h-4 w-4"})})}));$f.displayName=Gp.displayName;function fC({open:c,groupName:e,onConfirm:t,onCancel:s}){return y.jsx(XM,{open:c,onOpenChange:n=>!n&&s(),children:y.jsxs(pp,{children:[y.jsxs(ZM,{children:[y.jsx(gp,{children:"Delete Group?"}),y.jsxs(mp,{children:['Are you sure you want to delete the group "',e,'"? This action cannot be undone.']})]}),y.jsxs(ew,{children:[y.jsx(vp,{onClick:s,children:"Cancel"}),y.jsx(yp,{onClick:t,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete"})]})]})})}function EO({group:c}){const{nodes:e,updateGroup:t,deleteGroup:s,removeNodeFromGroup:n,addNodeToGroup:i,selectGroup:a}=ke(),[o,l]=R.useState(!1),[d,h]=R.useState(!1),[p,g]=R.useState(!1),[v,b]=R.useState(new Set),M=A=>{t(c.id,{name:A}),Ze.success("Group renamed"),h(!1)},x=()=>{l(!0)},S=()=>{s(c.id),a(null),Ze.success("Group deleted"),l(!1)},T=A=>{n(c.id,A),Ze.success("Component removed from group")},E=e.filter(A=>c.nodeIds.includes(A.id));return y.jsxs("div",{className:"space-y-2.5",children:[y.jsxs("div",{children:[y.jsx(He,{htmlFor:"group-name",className:"text-xs font-medium",children:"Group Name"}),y.jsxs("div",{className:"flex items-center gap-1.5 mt-1",children:[y.jsx(ct,{id:"group-name",value:c.name,onChange:A=>t(c.id,{name:A.target.value}),className:"flex-1 h-8 text-xs"}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:x,children:y.jsx(su,{className:"h-3.5 w-3.5 text-destructive"})})]})]}),y.jsx(fC,{open:o,groupName:c.name,onConfirm:S,onCancel:()=>l(!1)}),y.jsx(Mp,{open:d,initialName:c.name,onConfirm:M,onCancel:()=>h(!1)}),y.jsx(vs,{}),y.jsxs("div",{className:"flex items-center space-x-2",children:[y.jsx($f,{id:"show-name",checked:c.showName!==!1,onCheckedChange:A=>t(c.id,{showName:A!==!1})}),y.jsx(He,{htmlFor:"show-name",className:"text-xs font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Show name on canvas"})]}),y.jsx(vs,{}),y.jsxs("div",{children:[y.jsx(He,{className:"text-xs font-medium mb-1.5 block",children:"Color"}),y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx("input",{type:"color",value:c.color||"#3b82f6",onChange:A=>t(c.id,{color:A.target.value}),className:"w-10 h-8 rounded border border-border cursor-pointer"}),y.jsx(ct,{value:c.color||"#3b82f6",onChange:A=>t(c.id,{color:A.target.value}),className:"flex-1 font-mono text-xs h-8",placeholder:"#3b82f6"})]})]}),y.jsx(vs,{}),y.jsxs("div",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[y.jsxs(He,{className:"text-xs font-medium",children:["Components (",c.nodeIds.length,")"]}),y.jsxs(De,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:()=>{if(ke.getState().nodes.filter(D=>!c.nodeIds.includes(D.id)).length===0){Ze.info("All components are already in this group");return}b(new Set),g(!0)},children:[y.jsx(Bl,{className:"h-3 w-3 mr-1"}),"Add"]})]}),y.jsxs("div",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:[E.map(A=>y.jsxs("div",{className:"flex items-center justify-between p-1.5 bg-secondary/50 rounded border border-border",children:[y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsx("div",{className:"text-xs font-medium truncate",children:A.data?.label||A.type}),y.jsx("div",{className:"text-[10px] text-muted-foreground truncate",children:A.type})]}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-6 w-6 flex-shrink-0",onClick:()=>T(A.id),title:"Remove from group",children:y.jsx(cn,{className:"h-3 w-3"})})]},A.id)),E.length===0&&y.jsx("div",{className:"text-xs text-muted-foreground text-center py-3",children:"No components in group"})]})]}),y.jsx(vs,{}),y.jsxs("div",{className:"flex items-center justify-between text-[10px] text-muted-foreground",children:[y.jsx("span",{children:"Group ID:"}),y.jsx("code",{className:"font-mono bg-secondary/50 px-1.5 py-0.5 rounded text-[10px]",children:c.id})]}),y.jsx(bp,{open:p,onOpenChange:g,children:y.jsxs(uu,{className:"max-w-md",children:[y.jsxs(du,{children:[y.jsx(fu,{children:"Add Components to Group"}),y.jsxs(pu,{children:['Select components to add to "',c.name,'"']})]}),y.jsx(ns,{className:"max-h-96",children:y.jsxs("div",{className:"space-y-2 py-2",children:[e.filter(A=>!c.nodeIds.includes(A.id)).map(A=>y.jsxs("div",{className:"flex items-center space-x-2 p-2 rounded border border-border hover:bg-secondary/50 cursor-pointer",onClick:()=>{const k=new Set(v);k.has(A.id)?k.delete(A.id):k.add(A.id),b(k)},children:[y.jsx($f,{checked:v.has(A.id),onCheckedChange:k=>{const D=new Set(v);k?D.add(A.id):D.delete(A.id),b(D)}}),y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsx("div",{className:"text-sm font-medium truncate",children:A.data?.label||A.type}),y.jsx("div",{className:"text-xs text-muted-foreground truncate",children:A.type})]})]},A.id)),e.filter(A=>!c.nodeIds.includes(A.id)).length===0&&y.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"All components are already in this group"})]})}),y.jsxs(hu,{children:[y.jsx(De,{variant:"outline",onClick:()=>{g(!1),b(new Set)},children:"Cancel"}),y.jsxs(De,{onClick:()=>{if(v.size===0){Ze.error("Select at least one component");return}v.forEach(A=>{i(c.id,A)}),Ze.success(`${v.size} component(s) added to group`),g(!1),b(new Set)},children:["Add Selected (",v.size,")"]})]})]})})]})}function kO(){const{selectedNodeId:c,nodes:e,updateNode:t,selectNode:s,connections:n,updateConnection:i,selectedConnectionId:a,selectConnection:o,selectedGroupId:l,groups:d,selectGroup:h}=ke(),{addTab:p}=ku(),g=e.find(M=>M.id===c),v=n.find(M=>M.id===a),b=d.find(M=>M.id===l);return b?y.jsxs("div",{className:"w-60 h-full bg-card border-l border-border flex flex-col",children:[y.jsxs("div",{className:"p-1.5 border-b border-border flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1",children:[y.jsx(rf,{className:"h-3 w-3 text-muted-foreground"}),y.jsx(ti,{children:"Group Properties"})]}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>h(null),children:y.jsx(cn,{className:"h-3 w-3"})})]}),y.jsx(ns,{className:"flex-1",children:y.jsx("div",{className:"p-1.5",children:y.jsx(EO,{group:b})})})]}):!g&&!v?y.jsx("div",{className:"w-60 h-full bg-card border-l border-border flex flex-col",children:y.jsxs(Sp,{defaultValue:"stats",className:"h-full flex flex-col",children:[y.jsx("div",{className:"p-1 border-b border-border",children:y.jsxs(vu,{className:"grid w-full grid-cols-6 h-6 gap-0.5 p-0.5",children:[y.jsx(nn,{value:"stats",className:"text-xs px-1 py-0.5",children:"Stats"}),y.jsx(nn,{value:"diagnostics",className:"text-xs px-1 py-0.5",children:"Diag"}),y.jsx(nn,{value:"alerts",className:"text-xs px-1 py-0.5",children:"Alerts"}),y.jsx(nn,{value:"errors",className:"text-xs px-1 py-0.5",children:"Errors"}),y.jsx(nn,{value:"filters",className:"text-xs px-1 py-0.5",children:"Filter"}),y.jsx(nn,{value:"properties",className:"text-xs px-1 py-0.5",children:"Groups"})]})}),y.jsx(si,{value:"stats",className:"flex-1 m-0 p-0 overflow-hidden",children:y.jsx(ns,{className:"h-full",children:y.jsx("div",{className:"p-1.5",children:y.jsx(Aj,{})})})}),y.jsx(si,{value:"diagnostics",className:"flex-1 m-0 p-0 overflow-hidden",children:y.jsx(Ej,{})}),y.jsx(si,{value:"alerts",className:"flex-1 m-0 p-0 overflow-hidden",children:y.jsx(kj,{})}),y.jsx(si,{value:"errors",className:"flex-1 m-0 p-0 overflow-hidden",children:y.jsx(SO,{})}),y.jsx(si,{value:"filters",className:"flex-1 m-0 p-0 overflow-hidden",children:y.jsx(ns,{className:"h-full",children:y.jsx("div",{className:"p-1.5",children:y.jsx(Tj,{})})})}),y.jsx(si,{value:"properties",className:"flex-1 m-0 p-0 overflow-hidden",children:y.jsx(ns,{className:"h-full",children:y.jsx("div",{className:"p-1.5 space-y-1.5",children:y.jsxs("div",{children:[y.jsxs(ti,{as:"h4",className:"mb-1",children:["Groups (",d.length,")"]}),d.length>0?y.jsx("div",{className:"space-y-1",children:d.map(M=>y.jsx("div",{className:"p-1.5 bg-secondary/50 rounded border border-border cursor-pointer hover:bg-secondary transition-colors",onClick:()=>h(M.id),children:y.jsxs("div",{className:"flex items-center justify-between",children:[y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsx(et,{size:"small",className:"font-medium truncate",children:M.name}),y.jsxs(et,{size:"micro",muted:!0,children:[M.nodeIds.length," component",M.nodeIds.length!==1?"s":""]})]}),y.jsx("div",{className:"w-2.5 h-2.5 rounded border-2 border-border flex-shrink-0 ml-1",style:{backgroundColor:M.color||"hsl(var(--primary))"}})]})},M.id))}):y.jsx(et,{size:"micro",muted:!0,className:"text-center py-2",children:"No groups created yet"})]})})})})]})}):v?y.jsxs("div",{className:"w-60 h-full bg-card border-l border-border flex flex-col",children:[y.jsxs("div",{className:"p-1.5 border-b border-border flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1",children:[y.jsx(rf,{className:"h-3 w-3 text-muted-foreground"}),y.jsx(ti,{children:"Connection"})]}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>o(null),children:y.jsx(cn,{className:"h-3 w-3"})})]}),y.jsx(ns,{className:"flex-1",children:y.jsx("div",{className:"p-1.5",children:y.jsx(nj,{connection:v,onUpdate:(M,x)=>i(M,x)})})})]}):y.jsxs("div",{className:"w-60 h-full bg-card border-l border-border flex flex-col",children:[y.jsxs("div",{className:"p-1.5 border-b border-border flex items-center justify-between",children:[y.jsxs("div",{className:"flex items-center gap-1",children:[y.jsx(rf,{className:"h-3 w-3 text-muted-foreground"}),y.jsx(ti,{children:"Properties"})]}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>s(null),children:y.jsx(cn,{className:"h-3 w-3"})})]}),y.jsx(ns,{className:"flex-1",children:y.jsxs("div",{className:"p-1.5 space-y-1.5",children:[y.jsx(Rj,{componentId:g.id,componentLabel:g.data.label}),y.jsx(vs,{}),y.jsxs("div",{children:[y.jsx(He,{htmlFor:"label",className:"text-xs font-medium",children:"Label"}),y.jsx(ct,{id:"label",value:g.data.label,onChange:M=>t(g.id,{data:{...g.data,label:M.target.value}}),className:"mt-0.5 h-7 text-xs"})]}),y.jsx(vs,{}),y.jsxs("div",{children:[y.jsx(ti,{as:"h4",className:"mb-1",children:"Position"}),y.jsxs("div",{className:"grid grid-cols-2 gap-1.5",children:[y.jsxs("div",{children:[y.jsx(He,{htmlFor:"pos-x",className:"text-xs text-muted-foreground",children:"X"}),y.jsx(ct,{id:"pos-x",type:"number",value:Math.round(g.position.x),onChange:M=>t(g.id,{position:{...g.position,x:parseInt(M.target.value)||0}}),className:"mt-0.5 h-7 text-xs"})]}),y.jsxs("div",{children:[y.jsx(He,{htmlFor:"pos-y",className:"text-xs text-muted-foreground",children:"Y"}),y.jsx(ct,{id:"pos-y",type:"number",value:Math.round(g.position.y),onChange:M=>t(g.id,{position:{...g.position,y:parseInt(M.target.value)||0}}),className:"mt-0.5 h-7 text-xs"})]})]})]}),y.jsx(vs,{}),y.jsxs("div",{children:[y.jsx(ti,{as:"h4",className:"mb-1",children:"Component Type"}),y.jsx("div",{className:"bg-secondary/50 rounded-md p-1.5 border border-border",children:y.jsx(et,{mono:!0,size:"small",children:g.type})})]}),y.jsx(vs,{}),y.jsxs("div",{children:[y.jsx(ti,{as:"h4",className:"mb-1",children:"Configuration"}),y.jsx(De,{variant:"outline",size:"sm",className:"w-full h-7 text-xs",onClick:()=>{p({title:`${g.data.label} Config`,type:"component",componentId:g.id,componentType:g.type})},children:"Open Configuration Panel"})]})]})})]})}function AO(){const{tabs:c,setActiveTab:e,closeTab:t,addTab:s}=ku(),n=()=>{s({title:"Untitled Diagram",type:"diagram"})};return y.jsx("div",{className:"h-10 bg-secondary/30 border-b border-border flex items-center",children:y.jsxs(ns,{className:"flex-1",children:[y.jsxs("div",{className:"flex items-center",children:[c.map(i=>y.jsxs("div",{className:`
                flex items-center gap-2 px-4 h-10 border-r border-border cursor-pointer group
                transition-colors
                ${i.active?"bg-canvas-bg text-foreground":"text-muted-foreground hover:bg-secondary/50"}
              `,onClick:()=>e(i.id),children:[y.jsx("span",{className:"text-sm",children:i.title}),y.jsx(De,{variant:"ghost",size:"icon",className:"h-5 w-5 opacity-0 group-hover:opacity-100 hover:bg-destructive/10",onClick:a=>{a.stopPropagation(),t(i.id)},children:y.jsx(cn,{className:"h-3 w-3"})})]},i.id)),y.jsx(De,{variant:"ghost",size:"icon",className:"h-10 w-10 rounded-none",onClick:n,children:y.jsx(Bl,{className:"h-4 w-4"})})]}),y.jsx(au,{orientation:"horizontal"})]})})}const Vv=c=>Symbol.iterator in c,Gv=c=>"entries"in c,Wv=(c,e)=>{const t=c instanceof Map?c:new Map(c.entries()),s=e instanceof Map?e:new Map(e.entries());if(t.size!==s.size)return!1;for(const[n,i]of t)if(!s.has(n)||!Object.is(i,s.get(n)))return!1;return!0},DO=(c,e)=>{const t=c[Symbol.iterator](),s=e[Symbol.iterator]();let n=t.next(),i=s.next();for(;!n.done&&!i.done;){if(!Object.is(n.value,i.value))return!1;n=t.next(),i=s.next()}return!!n.done&&!!i.done};function PO(c,e){return Object.is(c,e)?!0:typeof c!="object"||c===null||typeof e!="object"||e===null||Object.getPrototypeOf(c)!==Object.getPrototypeOf(e)?!1:Vv(c)&&Vv(e)?Gv(c)&&Gv(e)?Wv(c,e):DO(c,e):Wv({entries:()=>Object.entries(c)},{entries:()=>Object.entries(e)})}function pC(c){const e=Dt.useRef(void 0);return t=>{const s=c(t);return PO(e.current,s)?e.current:e.current=s}}const Kv=globalThis;function kl(c){try{if(typeof Kv.structuredClone=="function")return Kv.structuredClone(c)}catch{}return JSON.parse(JSON.stringify(c))}function Ao(c,e,t=140,s=100,n=16){const i=[],a=t/2,o=s/2,l=c+a,d=e+o;for(let h=0;h<n;h++){const p=h/n*2*Math.PI-Math.PI/2;let g,v;const b=(p%(2*Math.PI)+2*Math.PI)%(2*Math.PI);if(b>=0&&b<Math.PI/2){const M=b/(Math.PI/2);g=l+a,v=d-o+M*s}else if(b>=Math.PI/2&&b<Math.PI){const M=(b-Math.PI/2)/(Math.PI/2);g=l+a-M*t,v=d+o}else if(b>=Math.PI&&b<3*Math.PI/2){const M=(b-Math.PI)/(Math.PI/2);g=l-a,v=d+o-M*s}else{const M=(b-3*Math.PI/2)/(Math.PI/2);g=l-a+M*t,v=d-o}i.push({x:g,y:v,index:h})}return i}function LO(c,e,t){let s=1/0,n=0;for(let i=0;i<c.length;i++){const a=c[i],o=Math.sqrt(Math.pow(e-a.x,2)+Math.pow(t-a.y,2));o<s&&(s=o,n=i)}return n}function Yv(c,e,t,s,n,i,a,o=140,l=100){const d=Ao(i,a,o,l),h=LO(d,t,s);if(n.filter(g=>g.source===c&&g.target===e&&g.sourcePort===h||g.target===c&&g.source===e&&g.targetPort===h).length===0)return h;for(let g=1;g<d.length;g++){const v=(h+g)%d.length,b=(h-g+d.length)%d.length;if(n.filter(S=>S.source===c&&S.target===e&&S.sourcePort===v||S.target===c&&S.source===e&&S.targetPort===v).length===0)return v;if(n.filter(S=>S.source===c&&S.target===e&&S.sourcePort===b||S.target===c&&S.source===e&&S.targetPort===b).length===0)return b}return h}const gC=R.createContext(null);function _O({children:c}){const e=R.useRef(new Map),t=R.useCallback((a,o)=>{o?e.current.set(a,o):e.current.delete(a)},[]),s=R.useCallback(a=>e.current.get(a)||null,[]),n=R.useCallback(a=>{e.current.delete(a)},[]),i={registerNodeRef:t,getNodeRef:s,unregisterNodeRef:n};return y.jsx(gC.Provider,{value:i,children:c})}function ju(){const c=R.useContext(gC);if(!c)throw new Error("useNodeRefs must be used within NodeRefsProvider");return c}function IO({node:c,onConnectionStart:e,onConnectionEnd:t,isConnecting:s=!1,onContextMenu:n}){const{registerNodeRef:i,unregisterNodeRef:a}=ju(),o=R.useRef(null);R.useEffect(()=>(o.current&&i(c.id,o.current),()=>{a(c.id)}),[c.id,i,a]);const l=ke(he=>he.selectNode),d=ke(he=>he.updateNode),h=ke(he=>he.updateNodes),p=ke(he=>he.deleteNode);ke(he=>he.addNode);const g=ke(he=>he.startDragOperation),v=ke(he=>he.endDragOperation);ke(he=>he.bringToFront),ke(he=>he.sendToBack),ke(he=>he.bringForward),ke(he=>he.sendBackward);const{connections:b,zoom:M,pan:x,nodes:S}=ke(pC(he=>({connections:he.connections,zoom:he.zoom,pan:he.pan,nodes:he.nodes}))),{addTab:T}=ku(),[E,A]=R.useState(!1),[k,D]=R.useState(!1),L=R.useRef({x:0,y:0}),I=R.useRef({x:0,y:0}),U=R.useRef({x:0,y:0}),Q=R.useRef({x:0,y:0}),se=R.useRef(null),F=R.useRef(null),Y=R.useRef(!1),ae=R.useRef(!1),de=R.useRef({}),z=R.useMemo(()=>Hr.find(he=>he.type===c.type),[c.type]),{isRunning:$,getComponentMetrics:q}=_t(),ee=Ma(he=>he.getComponentStatus(c.id)),me=aC(he=>he.getComponentState(c.id)),N=$?q(c.id):void 0,K=Wr(he=>he.highlightedNodeId)===c.id,ie=R.useMemo(()=>b.some(he=>he.source===c.id||he.target===c.id),[b,c.id]),Z=N&&(N.throughput&&N.throughput>.1||N.errorRate&&N.errorRate>.001||N.utilization&&N.utilization>.01),re=()=>{if(!$||!N||!ie||!Z)return"";const he=N.utilization||0,Qe=N.errorRate||0,Ue=Math.min(1,he*.7+Qe*.3);return Ue>.8?"border-red-500":Ue>.6?"border-orange-500":Ue>.4?"border-yellow-500":Ue>.2?"border-green-500":""},V=()=>{if(!$)return null;if(me)switch(me.state){case"disabled":case"failed":return y.jsx(Ll,{className:"text-red-500",size:16});case"degraded":return y.jsx(rn,{className:"text-yellow-500",size:16})}if(!ie||!Z||!ee)return null;const he=ee.health,Qe=16;switch(he){case"healthy":return y.jsx(tp,{className:"text-green-500",size:Qe});case"degraded":return y.jsx(rn,{className:"text-yellow-500",size:Qe});case"critical":return y.jsx(Sa,{className:"text-orange-500",size:Qe});case"down":return y.jsx(va,{className:"text-red-500",size:Qe});default:return null}},j=()=>{if(!$)return c.selected?"border-primary":"border-border";if(me)switch(me.state){case"disabled":case"failed":return"border-red-500 border-2";case"degraded":return"border-yellow-500 border-2"}if(!ee)return c.selected?"border-primary":"border-border";if(ee.criticalPath)return"border-purple-500 border-2";switch(ee.health){case"down":return"border-red-500 border-2";case"critical":return"border-orange-500";case"degraded":return"border-yellow-500";default:return c.selected?"border-primary":"border-border"}},ue=R.useRef(M),fe=R.useRef(x);R.useEffect(()=>{ue.current=M,fe.current=x},[M,x]),R.useEffect(()=>{const he=Ue=>{if(!Y.current)return;if(ke.getState().getIsGroupDragging()){Y.current=!1,ae.current=!1,A(!1);return}const yt=Ue.clientX-I.current.x,Ht=Ue.clientY-I.current.y,nt=Math.sqrt(yt*yt+Ht*Ht);if(!ae.current&&nt>3){ae.current=!0,A(!0),g(c.id);const wt=ke.getState().nodes.filter(vt=>vt.selected);de.current={},wt.forEach(vt=>{de.current[vt.id]={x:vt.position.x,y:vt.position.y}})}if(ae.current&&se.current){const It=ue.current,wt=fe.current,vt=se.current.getBoundingClientRect(),Xt=(Ue.clientX-vt.left-wt.x)/It,Vt=(Ue.clientY-vt.top-wt.y)/It,Ln=Xt-U.current.x,Xs=Vt-U.current.y,pn=ke.getState().nodes.filter(Gt=>Gt.selected),Jt=Object.keys(de.current).length>0;if(pn.length>1&&Jt){const Gt=[];pn.forEach(Nt=>{const Gi=de.current[Nt.id];Gi&&Gt.push({id:Nt.id,updates:{position:{x:Gi.x+Ln,y:Gi.y+Xs}}})}),Gt.length>0&&h(Gt,!0)}else{const Gt=Q.current.x+Ln,Nt=Q.current.y+Xs;d(c.id,{position:{x:Gt,y:Nt}},!0)}}},Qe=()=>{Y.current&&(Y.current=!1,ae.current&&(ae.current=!1,A(!1),v()))};return document.addEventListener("mousemove",he),document.addEventListener("mouseup",Qe),()=>{document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",Qe)}},[c.id,d,h,g,v]);const ge=he=>{if(he.button!==0)return;const Ue=ke.getState().nodes.filter(_s=>_s.selected),Mt=c.selected,yt=Ue.some(_s=>_s.id!==c.id);if(!(Mt&&yt&&!he.ctrlKey&&!he.metaKey)){const _s=he.ctrlKey||he.metaKey;l(c.id,_s)}const Ht=document.querySelector(".flex-1.overflow-hidden.relative");if(!Ht){L.current={x:0,y:0},U.current={x:0,y:0},Q.current={x:0,y:0},se.current=null,F.current=null;return}se.current=Ht;const nt=ue.current,It=fe.current,wt=Ht.getBoundingClientRect();F.current=wt;const vt=(he.clientX-wt.left-It.x)/nt,Xt=(he.clientY-wt.top-It.y)/nt;U.current={x:vt,y:Xt};const Xs=ke.getState().nodes.find(_s=>_s.id===c.id)?.position||c.position;Q.current={x:Xs.x,y:Xs.y},L.current={x:vt-Xs.x,y:Xt-Xs.y},I.current={x:he.clientX,y:he.clientY},Y.current=!0,ae.current=!1,he.stopPropagation()},pe=he=>{he.stopPropagation(),he.preventDefault(),E&&(A(!1),v()),T({title:`${c.data.label} Config`,type:"component",componentId:c.id,componentType:c.type})},we=he=>{he.key==="Delete"&&c.selected&&p(c.id)},Re=he=>{if(he.preventDefault(),he.stopPropagation(),!c.selected){const Qe=S.some(Ue=>Ue.id!==c.id&&Ue.selected);l(c.id,Qe)}n?.(he.clientX,he.clientY)},tt=(he,Qe)=>{he.stopPropagation(),e?.(Qe)},ze=R.useCallback(()=>{if(!o.current)return{width:140,height:100};const Ue=(o.current.querySelector(".bg-card")||o.current).getBoundingClientRect();return{width:Ue.width/M,height:Ue.height/M}},[M]),Ct=he=>{if(s){he.stopPropagation();const Qe=ze(),Ue=Ao(c.position.x,c.position.y,Qe.width,Qe.height,16),Mt=document.querySelector(".flex-1.overflow-hidden.relative");if(Mt){const yt=Mt.getBoundingClientRect(),Ht=(he.clientX-yt.left-x.x)/M,nt=(he.clientY-yt.top-x.y)/M;let It=1/0,wt=0;for(let vt=0;vt<Ue.length;vt++){const Xt=Ue[vt],Vt=Math.sqrt(Math.pow(Ht-Xt.x,2)+Math.pow(nt-Xt.y,2));Vt<It&&(It=Vt,wt=vt)}t?.(wt)}else t?.()}};return y.jsx(y.Fragment,{children:y.jsx("div",{ref:o,"data-node-id":c.id,className:`
          absolute cursor-move select-none
          transition-shadow
          ${c.selected?"glow-primary":""}
          ${E?"pointer-events-none":""}
        `,style:{left:`${c.position.x}px`,top:`${c.position.y}px`},onMouseDown:ge,onMouseUp:Ct,onDoubleClick:pe,onContextMenu:Re,onKeyDown:we,onMouseEnter:()=>D(!0),onMouseLeave:()=>D(!1),tabIndex:0,children:y.jsxs("div",{className:Ae("bg-card border-2 rounded-lg p-4 min-w-[140px] relative",j(),re(),"hover:border-primary/50 transition-colors",ee?.criticalPath&&"shadow-lg shadow-purple-500/20",K&&"ring-4 ring-yellow-400 ring-offset-2 animate-pulse"),children:[$&&ee&&y.jsx("div",{className:"absolute -top-2 -right-2 bg-card rounded-full p-0.5 border border-border",children:V()}),$&&ee?.criticalPath&&y.jsx("div",{className:"absolute -top-1 left-1/2 -translate-x-1/2 bg-purple-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-semibold",children:"CRITICAL"}),y.jsxs("div",{className:"flex flex-col items-center gap-2 select-none",children:[y.jsx("div",{className:"text-3xl select-none pointer-events-none",children:z?.icon}),y.jsx("div",{className:"text-sm font-medium text-center text-foreground select-none pointer-events-none",children:c.data.label})]}),(k||s)&&(()=>{const he=o.current?(()=>{const yt=(o.current.querySelector(".bg-card")||o.current).getBoundingClientRect();return{width:yt.width/M,height:yt.height/M}})():{width:140,height:100},Qe=Ao(c.position.x,c.position.y,he.width,he.height,16);return y.jsx(y.Fragment,{children:Qe.map((Ue,Mt)=>{const yt=Ue.x-c.position.x,Ht=Ue.y-c.position.y;return y.jsx("div",{className:"absolute w-3 h-3 rounded-full bg-primary/80 border-2 border-card cursor-crosshair hover:scale-150 hover:bg-primary transition-all z-10",style:{left:`${yt-6}px`,top:`${Ht-6}px`},onMouseDown:nt=>{nt.stopPropagation(),tt(nt,Mt)},onMouseUp:nt=>{nt.stopPropagation(),s&&t?.(Mt)},title:"Connection point"},Mt)})})})()]})})})}const NO=R.memo(IO,(c,e)=>!(c.node.id!==e.node.id||c.node.position.x!==e.node.position.x||c.node.position.y!==e.node.position.y||c.node.selected!==e.node.selected||c.node.type!==e.node.type||c.node.data.label!==e.node.data.label||c.isConnecting!==e.isConnecting||c.onConnectionStart!==e.onConnectionStart||c.onConnectionEnd!==e.onConnectionEnd||c.onContextMenu!==e.onContextMenu));function zO({selectedNodeId:c,highlightPath:e=!0}){const{nodes:t,connections:s}=ke(),{isRunning:n}=_t(),{getConnectionMessages:i}=zi(),[a,o]=R.useState(new Set),[l,d]=R.useState(new Map);return R.useEffect(()=>{if(!c||!e||!n){o(new Set),d(new Map);return}const h=new Set,p=new Map,g=[{nodeId:c,path:[c]}];for(;g.length>0;){const{nodeId:v,path:b}=g.shift();if(h.has(v))continue;h.add(v);const M=s.filter(x=>x.source===v);for(const x of M){const S=x.target,T=[...b,S];p.set(x.id,T),h.has(S)||g.push({nodeId:S,path:T})}}d(p),o(new Set(p.keys()))},[c,s,e,n]),R.useEffect(()=>{if(!c||!e||!n)return;const h=new Set,p=[{nodeId:c,path:[c]}];for(;p.length>0;){const{nodeId:g,path:v}=p.shift();if(h.has(g))continue;h.add(g);const b=s.filter(M=>M.target===g);for(const M of b){const x=M.source,S=[x,...v],T=l.get(M.id)||[];(T.length===0||S.length<T.length)&&(l.set(M.id,S),d(new Map(l))),h.has(x)||p.push({nodeId:x,path:S})}}o(new Set(l.keys()))},[c,s,e,n]),null}function jO(c){const{selectedNodeId:e}=ke(),{isRunning:t}=_t(),[s,n]=R.useState(!1);return R.useEffect(()=>{if(!e||!t){n(!1);return}const{nodes:i,connections:a}=ke.getState();if(!i.find(d=>d.id===e)){n(!1);return}const l=a.find(d=>d.id===c);l&&(l.source===e||l.target===e)?n(!0):n(!1)},[e,c,t]),s}const mC=R.createContext(null);function OO({children:c}){const e=R.useRef(null),t=R.useRef(new WeakMap);R.useEffect(()=>(e.current=new ResizeObserver(i=>{i.forEach(a=>{const o=t.current.get(a.target);o&&o()})}),()=>{e.current&&(e.current.disconnect(),e.current=null)}),[]);const n={observe:R.useCallback((i,a)=>e.current?(t.current.set(i,a),e.current.observe(i),()=>{e.current&&(e.current.unobserve(i),t.current.delete(i))}):()=>{},[])};return y.jsx(mC.Provider,{value:n,children:c})}function yC(){const c=R.useContext(mC);if(!c)throw new Error("useResizeObserver must be used within ResizeObserverProvider");return c}function qO({connection:c,sourceNode:e,targetNode:t,zoom:s,pan:n,isSelected:i=!1,onClick:a,onContextMenu:o}){const[l,d]=R.useState(!1),{isRunning:h,connectionMetrics:p}=_t(pC(j=>({isRunning:j.isRunning,connectionMetrics:j.connectionMetrics}))),g=h?p.get(c.id):void 0,{getConnectionMessages:v}=zi(),b=ke(j=>j.selectedNodeId),M=ke(j=>j.connections),x=h?v(c.id):[],S=R.useMemo(()=>x.filter(j=>j.status==="in-transit"||j.status==="pending"),[x]),T=jO(c.id);R.useMemo(()=>M.some(j=>j.source===c.target&&j.target===c.source),[M,c.target,c.source]);const{getNodeRef:E}=ju(),{observe:A}=yC(),[k,D]=R.useState(()=>{const j=ue=>{const fe=E(ue);if(!fe)return{width:140,height:100};const we=(fe.querySelector(".bg-card")||fe).getBoundingClientRect();return{width:we.width/s,height:we.height/s}};return{source:j(e.id),target:j(t.id)}});R.useEffect(()=>{const j=()=>{const ze=Ct=>{const he=E(Ct);if(!he)return{width:140,height:100};const Mt=(he.querySelector(".bg-card")||he).getBoundingClientRect();return{width:Mt.width/s,height:Mt.height/s}};D({source:ze(e.id),target:ze(t.id)})};j();const ue=E(e.id),fe=E(t.id),ge=ue?.querySelector(".bg-card"),pe=fe?.querySelector(".bg-card"),we=ge||ue,Re=pe||fe,tt=[];if(we){const ze=A(we,j);tt.push(ze)}if(Re){const ze=A(Re,j);tt.push(ze)}return()=>{tt.forEach(ze=>ze())}},[e.id,t.id,s,E,A]);const L=k.source.width,I=k.source.height,U=k.target.width,Q=k.target.height,se=L/2,F=I/2,Y=U/2,ae=Q/2;let de,z,$,q;if(c.sourcePort!==void 0&&c.targetPort!==void 0){const j=Ao(e.position.x,e.position.y,L,I,16),ue=Ao(t.position.x,t.position.y,U,Q,16),fe=j[c.sourcePort],ge=ue[c.targetPort];de=fe.x,z=fe.y,$=ge.x,q=ge.y}else{const j=e.position.x+se,ue=e.position.y+F,fe=t.position.x+Y,ge=t.position.y+ae,pe=Math.atan2(ge-ue,fe-j),we=(ze,Ct,he,Qe)=>{const Ue=Math.abs(he),Mt=Qe?se:Y,yt=Qe?F:ae,Ht=Math.atan2(yt,Mt);let nt,It;if(Ue<Ht||Ue>Math.PI-Ht){const wt=Qe?1:-1;nt=ze+wt*Mt*Math.sign(Math.cos(he)),It=Ct+wt*Mt*Math.tan(he)*Math.sign(Math.cos(he))}else{const wt=Qe?1:-1;nt=ze+wt*yt/Math.tan(he)*Math.sign(Math.sin(he)),It=Ct+wt*yt*Math.sign(Math.sin(he))}return{x:nt,y:It}},Re=we(j,ue,pe,!0),tt=we(fe,ge,pe,!1);de=Re.x,z=Re.y,$=tt.x,q=tt.y}const ee=$-de,me=q-z,N=Math.min(Math.abs(ee),Math.abs(me))*.3+30,J=`
    M ${de},${z}
    C ${de+N*Math.sign(ee)},${z}
      ${$-N*Math.sign(ee)},${q}
      ${$},${q}
  `;let K="hsl(var(--border))",ie=2;T&&b?(K="hsl(280 100% 70%)",ie=3):i?(K="hsl(var(--primary))",ie=2.5):l?(K="hsl(var(--accent))",ie=2.5):g&&h&&(g.effectiveThroughput>0||g.traffic>0)&&(g.bottleneck?(K="hsl(0 84% 60%)",ie=3):g.backpressure>.7?(K="hsl(25 95% 53%)",ie=2.5):g.congestion>.6?(K="hsl(45 93% 47%)",ie=2.5):g.throughputDependency>.5?(K="hsl(142 76% 36%)",ie=2):g.effectiveThroughput>0&&(K="hsl(var(--primary))",ie=2));const Z=j=>{j.stopPropagation(),a?.()},re=j=>{j.preventDefault(),j.stopPropagation(),o?.(j)},V=h&&g&&g.effectiveThroughput>0?g.effectiveThroughput%40/2:0;return y.jsxs("g",{children:[y.jsx("path",{d:J,fill:"none",stroke:"transparent",strokeWidth:20/s,style:{cursor:"pointer"},onClick:Z,onContextMenu:re,onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1)}),h&&g&&g.effectiveThroughput>0&&g.traffic>0&&y.jsx("path",{d:J,fill:"none",stroke:K,strokeWidth:Math.max(1,ie/s),strokeLinecap:"round",strokeDasharray:`${Math.max(4,8/s)} ${Math.max(2,4/s)}`,strokeDashoffset:-V,style:{opacity:.4,pointerEvents:"none",animation:"flow 2s linear infinite"}}),h&&S.map((j,ue)=>{const fe=Date.now()-j.timestamp,pe=j.latency?Math.min(1,fe/j.latency):0,we=de+($-de)*pe,Re=z+(q-z)*pe,ze={json:"hsl(142 76% 36%)",xml:"hsl(25 95% 53%)",binary:"hsl(221 83% 53%)",protobuf:"hsl(280 100% 70%)",text:"hsl(210 40% 50%)"}[j.format]||"hsl(var(--primary))";return y.jsxs("g",{children:[y.jsx("circle",{cx:we,cy:Re,r:4/s,fill:ze,stroke:"hsl(var(--background))",strokeWidth:1/s,style:{pointerEvents:"none",filter:"drop-shadow(0 0 2px rgba(0,0,0,0.3))"},children:y.jsx("animate",{attributeName:"opacity",values:"0.5;1;0.5",dur:"1s",repeatCount:"indefinite"})}),j.size>1e3&&y.jsx("text",{x:we,y:Re-8/s,fill:ze,fontSize:8/s,textAnchor:"middle",style:{pointerEvents:"none",userSelect:"none"},children:j.format})]},j.id||ue)}),y.jsx("path",{d:J,fill:"none",stroke:K,strokeWidth:Math.max(1,ie/s),strokeLinecap:"round",markerEnd:h&&g&&(g.effectiveThroughput>0||g.traffic>0)?`url(#arrowhead-${i?"selected":g?.bottleneck?"bottleneck":"default"})`:i?"url(#arrowhead-selected)":"url(#arrowhead-default)",style:{transition:"stroke 0.3s, stroke-width 0.3s",pointerEvents:"none"}}),h&&g&&(g.effectiveThroughput>0||g.traffic>0)?y.jsxs("g",{children:[y.jsx("text",{x:(de+$)/2,y:(z+q)/2-10/s,fill:"hsl(var(--primary))",fontSize:Math.max(8,11/s),textAnchor:"middle",fontWeight:"500",style:{pointerEvents:"none",userSelect:"none"},children:c.label||`${g.latency.toFixed(1)}ms`}),y.jsx("text",{x:(de+$)/2,y:(z+q)/2+8/s,fill:"hsl(var(--muted-foreground))",fontSize:Math.max(7,9/s),textAnchor:"middle",style:{pointerEvents:"none",userSelect:"none"},children:g.traffic>0?`${g.traffic.toFixed(1)} KB/s`:`${g.effectiveThroughput.toFixed(0)} msg/s`}),c.data?.bandwidthMbps&&g.traffic>0&&y.jsxs("text",{x:(de+$)/2,y:(z+q)/2+20/s,fill:"hsl(var(--muted-foreground))",fontSize:Math.max(6,8/s),textAnchor:"middle",style:{pointerEvents:"none",userSelect:"none",opacity:.7},children:["Limit: ",c.data.bandwidthMbps,"Mbps"]})]}):c.label?y.jsx("g",{children:y.jsx("text",{x:(de+$)/2,y:(z+q)/2-10/s,fill:"hsl(var(--primary))",fontSize:Math.max(8,11/s),textAnchor:"middle",fontWeight:"500",style:{pointerEvents:"none",userSelect:"none"},children:c.label})}):null]})}const HO=R.memo(qO,(c,e)=>!(c.connection.id!==e.connection.id||c.connection.sourcePort!==e.connection.sourcePort||c.connection.targetPort!==e.connection.targetPort||c.connection.label!==e.connection.label||c.sourceNode.id!==e.sourceNode.id||c.sourceNode.position.x!==e.sourceNode.position.x||c.sourceNode.position.y!==e.sourceNode.position.y||c.targetNode.id!==e.targetNode.id||c.targetNode.position.x!==e.targetNode.position.x||c.targetNode.position.y!==e.targetNode.position.y||c.zoom!==e.zoom||c.pan.x!==e.pan.x||c.pan.y!==e.pan.y||c.isSelected!==e.isSelected||c.onClick!==e.onClick||c.onContextMenu!==e.onContextMenu)),$O=140,BO=140,UO=16;function FO({nodeId:c,position:e}){const t=_t(h=>h.componentMetrics.get(c)),{connections:s}=ke(),{isRunning:n}=_t(),i=s.some(h=>h.source===c||h.target===c),a=t&&(t.throughput&&t.throughput>.1||t.errorRate&&t.errorRate>.001||t.utilization&&t.utilization>.01),o=R.useMemo(()=>{if(!t)return[];const h=[{label:"Throughput",value:`${Math.round(t.throughput)}`,unit:"ops/s",color:"text-blue-400"},{label:"Latency (avg)",value:`${Math.round(t.latency)}`,unit:"ms",color:"text-yellow-400"}];return t.latencyP50!==void 0&&h.push({label:"Latency (p50)",value:`${Math.round(t.latencyP50)}`,unit:"ms",color:"text-green-400"}),t.latencyP99!==void 0&&h.push({label:"Latency (p99)",value:`${Math.round(t.latencyP99)}`,unit:"ms",color:"text-red-400"}),h.push({label:"Error Rate",value:`${(t.errorRate*100).toFixed(2)}`,unit:"%",color:"text-orange-400"},{label:"Utilization",value:`${Math.round(t.utilization*100)}`,unit:"%",color:"text-purple-400"}),h},[t]);if(!n||!t||!i||!a||o.length===0)return null;const l=e.x+$O/2,d=e.y+BO+UO;return y.jsx("div",{className:"absolute pointer-events-none",style:{left:`${l}px`,top:`${d}px`,transform:"translateX(-50%)",zIndex:10},children:y.jsx("div",{className:"bg-slate-900 border border-slate-700 rounded-lg p-2 shadow-lg min-w-max",children:y.jsx("div",{className:"text-xs space-y-1",children:o.map(h=>y.jsxs("div",{className:"flex items-center justify-between gap-3",children:[y.jsxs("span",{className:"text-slate-400",children:[h.label,":"]}),y.jsxs("span",{className:`font-mono font-semibold ${h.color}`,children:[h.value," ",h.unit]})]},h.label))})})})}function QO({isVisible:c=!0}){return c?y.jsx("div",{className:"absolute bottom-4 right-4 bg-card/95 backdrop-blur-sm border border-border rounded-md p-2 z-10 pointer-events-none",children:y.jsxs("div",{className:"flex items-center gap-3 text-[10px] text-muted-foreground",children:[y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx("div",{className:"w-3 h-3 rounded bg-green-500/20 border border-green-500/30"}),y.jsx("span",{children:"<20%"})]}),y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx("div",{className:"w-3 h-3 rounded bg-yellow-500/20 border border-yellow-500/30"}),y.jsx("span",{children:"20-40%"})]}),y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx("div",{className:"w-3 h-3 rounded bg-orange-500/20 border border-orange-500/30"}),y.jsx("span",{children:"40-60%"})]}),y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx("div",{className:"w-3 h-3 rounded bg-red-500/20 border border-red-500/30"}),y.jsx("span",{children:">60%"})]})]})}):null}function VO({isVisible:c=!0}){const{nodes:e,connections:t,zoom:s,pan:n}=ke(),{isRunning:i}=_t(),a=Dt.useMemo(()=>{if(e.length===0)return{minX:0,minY:0,maxX:2e3,maxY:2e3};const T=e.map(I=>I.position.x),E=e.map(I=>I.position.y),A=Math.min(...T)-200,k=Math.min(...E)-200,D=Math.max(...T)+200,L=Math.max(...E)+200;return{minX:A,minY:k,maxX:D,maxY:L}},[e]),o=a.maxX-a.minX,l=a.maxY-a.minY,d=120,h=80,p=d/Math.max(o,1e3),g=h/Math.max(l,1e3),v=Math.min(p,g),b=window.innerWidth/s*v,M=window.innerHeight/s*v,x=(-n.x/s-a.minX)*v,S=(-n.y/s-a.minY)*v;return c?y.jsx("div",{className:"absolute bottom-4 left-4 bg-card/95 backdrop-blur-sm border border-border rounded-md p-2 z-10 pointer-events-none",children:y.jsxs("svg",{width:d,height:h,className:"border border-border/50 rounded",style:{background:"hsl(var(--background))"},children:[t.map(T=>{const E=e.find(U=>U.id===T.source),A=e.find(U=>U.id===T.target);if(!E||!A)return null;const k=(E.position.x-a.minX)*v,D=(E.position.y-a.minY)*v,L=(A.position.x-a.minX)*v,I=(A.position.y-a.minY)*v;return y.jsx("line",{x1:k,y1:D,x2:L,y2:I,stroke:"hsl(var(--border))",strokeWidth:.3,opacity:.2},T.id)}),e.map(T=>y.jsx("circle",{cx:(T.position.x-a.minX)*v,cy:(T.position.y-a.minY)*v,r:1.5,fill:"hsl(var(--muted-foreground))",opacity:.5},T.id)),y.jsx("rect",{x,y:S,width:b,height:M,fill:"hsl(var(--primary))",fillOpacity:.2,stroke:"hsl(var(--primary))",strokeWidth:1.5,strokeDasharray:"2 2"})]})}):null}function GO({x:c,y:e,onDelete:t,onRename:s,onCopyId:n,onClose:i}){const a=R.useRef(null),[o,l]=R.useState({x:c,y:e});return R.useEffect(()=>{if(a.current){const d=a.current.getBoundingClientRect(),h=window.innerWidth,p=window.innerHeight;let g=c,v=e;c+d.width>h&&(g=h-d.width-10),e+d.height>p&&(v=p-d.height-10),g=Math.max(10,g),v=Math.max(10,v),l({x:g,y:v})}},[c,e]),R.useEffect(()=>{const d=p=>{a.current&&!a.current.contains(p.target)&&i()},h=p=>{p.key==="Escape"&&i()};return document.addEventListener("mousedown",d),document.addEventListener("keydown",h),()=>{document.removeEventListener("mousedown",d),document.removeEventListener("keydown",h)}},[i]),y.jsxs("div",{ref:a,className:"fixed bg-popover border border-border rounded-md shadow-lg z-50 py-0.5 min-w-[120px]",style:{left:`${o.x}px`,top:`${o.y}px`},children:[y.jsxs("button",{onClick:()=>{s(),i()},className:"w-full px-2 py-1 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(tP,{className:"w-3.5 h-3.5"}),"Rename"]}),y.jsxs("button",{onClick:()=>{n(),i()},className:"w-full px-2 py-1 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(Ib,{className:"w-3.5 h-3.5"}),"Copy ID"]}),y.jsx("div",{className:"border-t border-border my-0.5"}),y.jsxs("button",{onClick:()=>{t(),i()},className:"w-full px-2.5 py-1.5 text-xs text-destructive hover:bg-destructive hover:text-destructive-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(su,{className:"w-3.5 h-3.5"}),"Delete"]})]})}const WO=140,KO=100;function YO(c,e,t){const s=t(c);if(!s)return{width:WO,height:KO};const a=(s.querySelector(".bg-card")||s).getBoundingClientRect();return{width:a.width/e,height:a.height/e}}function XO(c,e){const{getNodeRef:t}=ju(),{observe:s}=yC(),[n,i]=R.useState({}),a=R.useCallback(()=>{const o={};c.forEach(l=>{const d=YO(l,e,t);d&&(o[l]=d)}),i(l=>({...l,...o}))},[c,e,t]);return R.useEffect(()=>{if(c.length===0)return;a();const o=[];return c.forEach(l=>{const d=t(l);if(d){const p=d.querySelector(".bg-card")||d;if(p){const g=s(p,a);o.push(g)}}}),()=>{o.forEach(l=>l())}},[c,e,a,t,s]),n}const bf=20,JO=140,ZO=100,e5=18,t5=6,s5=e5+t5*2;function n5(c,e,t,s){return R.useMemo(()=>{const n=e.filter(g=>c.nodeIds.includes(g.id));if(n.length===0)return null;const i=bf,a=bf,o=c.showName!==!1?s5:bf;let l=1/0,d=1/0,h=-1/0,p=-1/0;return n.forEach(g=>{const v=t[g.id]||{width:JO,height:ZO},b=g.position.x,M=g.position.y,x=b+v.width,S=M+v.height;l=Math.min(l,b),d=Math.min(d,M),h=Math.max(h,x),p=Math.max(p,S)}),{x:l-i,y:d-o,width:h-l+i*2,height:p-d+o+a}},[e,c.nodeIds,t,s,c.showName])}function i5(c,e){const{nodes:t,updateNodes:s}=ke(),[n,i]=R.useState(!1),a=R.useRef({x:0,y:0}),o=R.useRef({}),l=R.useCallback(d=>{if(d.button!==0||d.target.closest("[data-node-id]"))return;d.stopPropagation();const g=ke.getState();g.selectGroup(c.id),i(!0),a.current.x=d.clientX,a.current.y=d.clientY,g.setGroupDragging(!0);const v=t.filter(b=>c.nodeIds.includes(b.id));o.current={},v.forEach(b=>{o.current[b.id]={...b.position}})},[c.id,c.nodeIds,t]);return R.useEffect(()=>{if(!n)return;let d=null,h=null,p=!0;const g=b=>{if(!p)return;const M=(b.clientX-a.current.x)/e,x=(b.clientY-a.current.y)/e;h={dx:M,dy:x},d===null&&(d=requestAnimationFrame(()=>{if(!p||!h){d=null,h=null;return}const{dx:S,dy:T}=h,E=ke.getState(),A=c.nodeIds.map(k=>{const D=o.current[k];return D?{id:k,updates:{position:{x:D.x+S,y:D.y+T}}}:null}).filter(k=>k!==null);A.length>0&&E.updateNodes(A,!0),d=null,h=null}))},v=b=>{if(b&&b.button!==0)return;p=!1,d!==null&&(cancelAnimationFrame(d),d=null);const M=ke.getState();if(h){const{dx:x,dy:S}=h,T=c.nodeIds.map(E=>{const A=o.current[E];return A?{id:E,updates:{position:{x:A.x+x,y:A.y+S}}}:null}).filter(E=>E!==null);if(M.setGroupDragging(!1),T.length>0){M.updateNodes(T,!0);const E=ke.getState();mt(E,E.diagramName)}}else M.setGroupDragging(!1);h=null,i(!1)};return document.addEventListener("mousemove",g,{passive:!0}),document.addEventListener("mouseup",v,{capture:!0}),()=>{p=!1,d!==null&&cancelAnimationFrame(d),document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",v,{capture:!0}),ke.getState().setGroupDragging(!1)}},[n,c.nodeIds,e]),{isDragging:n,handleMouseDown:l}}const Xv=18,Al=6;function a5({group:c,zoom:e}){const{nodes:t,selectedGroupId:s,selectGroup:n,deleteGroup:i,updateGroup:a}=ke(),[o,l]=R.useState(null),[d,h]=R.useState(!1),[p,g]=R.useState(!1),v=XO(c.nodeIds,e),b=n5(c,t,v,e),{handleMouseDown:M}=i5(c,e);if(!b)return null;const x=s===c.id,S=c.color||"hsl(var(--primary))",T=I=>{I.preventDefault(),I.stopPropagation(),n(c.id),l({x:I.clientX,y:I.clientY})},E=()=>{h(!0)},A=()=>{i(c.id),Ze.success("Group deleted"),h(!1)},k=()=>{g(!0)},D=I=>{a(c.id,{name:I}),Ze.success("Group renamed"),g(!1)},L=()=>{navigator.clipboard.writeText(c.id),Ze.success("Group ID copied to clipboard")};return y.jsxs(y.Fragment,{children:[y.jsxs("g",{children:[y.jsx("rect",{x:b.x,y:b.y,width:b.width,height:b.height,fill:S,fillOpacity:x?.1:.05,stroke:S,strokeWidth:x?3/e:2/e,strokeDasharray:x?"0":"5,5",rx:8/e,ry:8/e,style:{cursor:"pointer",transition:"all 0.2s"},onMouseDown:M,onContextMenu:T}),c.showName!==!1&&y.jsxs("g",{onClick:I=>{I.stopPropagation(),n(c.id)},onContextMenu:T,style:{cursor:"pointer"},children:[y.jsx("rect",{x:b.x+Al,y:b.y+Al,width:Math.max(80,c.name.length*6.5+16),height:Xv,fill:S,fillOpacity:.85,rx:3,ry:3,stroke:S,strokeWidth:.5}),y.jsx("text",{x:b.x+Al+8,y:b.y+Al+Xv/2,fill:"white",fontSize:11,fontWeight:"600",dominantBaseline:"middle",style:{pointerEvents:"none",userSelect:"none"},children:c.name})]})]}),o&&y.jsx(GO,{x:o.x,y:o.y,onDelete:E,onRename:k,onCopyId:L,onClose:()=>l(null)}),y.jsx(fC,{open:d,groupName:c.name,onConfirm:A,onCancel:()=>h(!1)}),y.jsx(Mp,{open:p,initialName:c.name,onConfirm:D,onCancel:()=>g(!1)})]})}const o5=R.memo(a5,(c,e)=>!(c.group.id!==e.group.id||c.group.name!==e.group.name||c.group.color!==e.group.color||c.group.nodeIds.length!==e.group.nodeIds.length||c.group.nodeIds.some((t,s)=>t!==e.group.nodeIds[s])||c.zoom!==e.zoom));function r5({isVisible:c,canvasRef:e}){const{zoom:t,pan:s}=ke(),[n,i]=R.useState(null),a=R.useRef(null);if(R.useEffect(()=>{if(!c){i(null);return}const k=()=>{if(e?.current)i(e.current.getBoundingClientRect());else if(a.current?.parentElement){const Q=a.current.parentElement.getBoundingClientRect(),se=24;i({...Q,width:Q.width-se,height:Q.height-se,left:Q.left+se,top:Q.top+se})}},D=setTimeout(k,10),L=requestAnimationFrame(k),I=requestAnimationFrame(()=>{requestAnimationFrame(k)});return window.addEventListener("resize",k),()=>{clearTimeout(D),cancelAnimationFrame(L),cancelAnimationFrame(I),window.removeEventListener("resize",k)}},[c,e]),R.useEffect(()=>{if(!c)return;const D=requestAnimationFrame(()=>{e?.current&&i(e.current.getBoundingClientRect())});return()=>cancelAnimationFrame(D)},[t,s,c,e]),!c)return null;if(!n)return y.jsx("div",{ref:a,className:"absolute inset-0 pointer-events-none z-20"});const o=20,l=o*t;let d=1;l<10?d=10:l<20?d=5:l<40&&(d=2);const h=o*d,p=24,g=24,v=n.width,b=n.height,M=Math.floor(-s.x/t/h)*h,x=Math.floor(-s.y/t/h)*h,S=M+v/t+h*2,T=x+b/t+h*2,E=[];for(let k=M;k<=S;k+=h)E.push(k);const A=[];for(let k=x;k<=T;k+=h)A.push(k);return y.jsxs("div",{ref:a,className:"absolute inset-0 pointer-events-none z-20",children:[y.jsx("div",{className:"absolute bg-card/90 backdrop-blur-sm border-b border-border pointer-events-none",style:{top:0,left:`${p}px`,right:0,height:`${g}px`,transform:`translate(${s.x}px, 0) scale(${t})`,transformOrigin:"0 0"},children:E.map(k=>y.jsx("div",{className:"absolute top-0 bottom-0 border-l border-border/60",style:{left:`${k}px`,width:"1px"},children:y.jsx("span",{className:"absolute top-0.5 left-1 text-[10px] text-muted-foreground font-mono whitespace-nowrap",style:{transform:`scale(${1/t})`,transformOrigin:"0 0"},children:k})},`h-${k}`))}),y.jsx("div",{className:"absolute bg-card/90 backdrop-blur-sm border-r border-border pointer-events-none",style:{top:`${g}px`,left:0,bottom:0,width:`${p}px`,transform:`translate(0, ${s.y}px) scale(${t})`,transformOrigin:"0 0"},children:A.map(k=>y.jsx("div",{className:"absolute left-0 right-0 border-t border-border/60",style:{top:`${k}px`,height:"1px"},children:y.jsx("span",{className:"absolute left-0.5 top-1 text-[10px] text-muted-foreground font-mono whitespace-nowrap",style:{transform:`scale(${1/t})`,transformOrigin:"0 0"},children:k})},`v-${k}`))}),y.jsx("div",{className:"absolute bg-card/90 backdrop-blur-sm border-b border-r border-border pointer-events-none",style:{top:0,left:0,width:`${p}px`,height:`${g}px`}})]})}function c5({x:c,y:e,onDelete:t,onDuplicate:s,onCopyId:n,onBringToFront:i,onSendToBack:a,onBringForward:o,onSendBackward:l,onAddToGroup:d,onRemoveFromGroup:h,onClose:p}){const g=R.useRef(null);R.useEffect(()=>{const D=I=>{g.current&&!g.current.contains(I.target)&&p()},L=I=>{I.key==="Escape"&&p()};return document.addEventListener("mousedown",D),document.addEventListener("keydown",L),()=>{document.removeEventListener("mousedown",D),document.removeEventListener("keydown",L)}},[p]);const v=()=>{t(),p()},b=()=>{s(),p()},M=()=>{n(),p()},x=()=>{i?.(),p()},S=()=>{a?.(),p()},T=()=>{o?.(),p()},E=()=>{l?.(),p()},A=()=>{d?.(),p()},k=()=>{h?.(),p()};return y.jsxs("div",{ref:g,className:"fixed bg-popover border border-border rounded-md shadow-lg z-50 py-0.5 min-w-[140px]",style:{left:`${c}px`,top:`${e}px`},children:[y.jsxs("button",{onClick:b,className:"w-full px-2 py-1.5 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(jb,{className:"w-3.5 h-3.5"}),"Duplicate"]}),y.jsxs("button",{onClick:M,className:"w-full px-2 py-1.5 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(Ib,{className:"w-3.5 h-3.5"}),"Copy ID"]}),(d||h)&&y.jsxs(y.Fragment,{children:[y.jsx("div",{className:"border-t border-border my-0.5"}),h&&y.jsxs("button",{onClick:k,className:"w-full px-2 py-1.5 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(bD,{className:"w-3.5 h-3.5"}),"Remove from Group"]}),d&&y.jsxs("button",{onClick:A,className:"w-full px-2 py-1.5 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(xf,{className:"w-3.5 h-3.5"}),"Add to Group"]})]}),y.jsx("div",{className:"border-t border-border my-0.5"}),(i||a||o||l)&&y.jsxs(y.Fragment,{children:[y.jsxs("button",{onClick:x,className:"w-full px-2 py-1.5 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(JA,{className:"w-3.5 h-3.5"}),"Bring to Front"]}),y.jsxs("button",{onClick:S,className:"w-full px-2 py-1.5 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(WA,{className:"w-3.5 h-3.5"}),"Send to Back"]}),y.jsxs("button",{onClick:T,className:"w-full px-2 py-1.5 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(_b,{className:"w-3.5 h-3.5"}),"Bring Forward"]}),y.jsxs("button",{onClick:E,className:"w-full px-2 py-1.5 text-xs text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(tu,{className:"w-3.5 h-3.5"}),"Send Backward"]}),y.jsx("div",{className:"border-t border-border my-0.5"})]}),y.jsxs("button",{onClick:v,className:"w-full px-2.5 py-1.5 text-xs text-destructive hover:bg-destructive hover:text-destructive-foreground flex items-center gap-1.5 transition-colors",children:[y.jsx(su,{className:"w-3.5 h-3.5"}),"Delete"]})]})}function l5({nodeId:c,x:e,y:t,onClose:s}){const n=R.useRef(null),{groups:i,addNodeToGroup:a}=ke();return R.useEffect(()=>{const o=d=>{n.current&&!n.current.contains(d.target)&&s()},l=d=>{d.key==="Escape"&&s()};return document.addEventListener("mousedown",o),document.addEventListener("keydown",l),()=>{document.removeEventListener("mousedown",o),document.removeEventListener("keydown",l)}},[s]),y.jsxs("div",{ref:n,className:"fixed bg-popover border border-border rounded-md shadow-lg z-50 py-1 min-w-[180px]",style:{left:`${e}px`,top:`${t}px`},children:[y.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold text-muted-foreground border-b border-border",children:"Add to Group"}),y.jsx("div",{className:"max-h-60 overflow-y-auto",children:(()=>{const o=i.filter(l=>!l.nodeIds.includes(c));return o.length>0?o.map(l=>y.jsxs("button",{onClick:()=>{a(l.id,c),Ze.success(`Added to "${l.name}"`),s()},className:"w-full px-2 py-1.5 text-xs text-left text-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-2 transition-colors",children:[y.jsx("div",{className:"w-3 h-3 rounded border border-border flex-shrink-0",style:{backgroundColor:l.color||"hsl(var(--primary))"}}),y.jsx("span",{className:"truncate flex-1",children:l.name})]},l.id)):y.jsx("div",{className:"px-2 py-4 text-xs text-muted-foreground text-center",children:i.length===0?"No groups available":"Already in all groups"})})()}),y.jsx("div",{className:"border-t border-border mt-1",children:y.jsx("button",{onClick:s,className:"w-full px-2 py-1.5 text-xs text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors",children:"Cancel"})})]})}function u5({nodeId:c,x:e,y:t,onClose:s}){const n=R.useRef(null),{groups:i,removeNodeFromGroup:a}=ke(),o=i.filter(l=>l.nodeIds.includes(c));return R.useEffect(()=>{const l=h=>{n.current&&!n.current.contains(h.target)&&s()},d=h=>{h.key==="Escape"&&s()};return document.addEventListener("mousedown",l),document.addEventListener("keydown",d),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("keydown",d)}},[s]),y.jsxs("div",{ref:n,className:"fixed bg-popover border border-border rounded-md shadow-lg z-50 py-1 min-w-[180px]",style:{left:`${e}px`,top:`${t}px`},children:[y.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold text-muted-foreground border-b border-border",children:"Remove from Group"}),y.jsx("div",{className:"max-h-60 overflow-y-auto",children:o.length>0?o.map(l=>y.jsxs("button",{onClick:()=>{a(l.id,c),Ze.success(`Removed from "${l.name}"`),s()},className:"w-full px-2 py-1.5 text-xs text-left text-destructive hover:bg-destructive/10 hover:text-destructive flex items-center gap-2 transition-colors",children:[y.jsx("div",{className:"w-3 h-3 rounded border border-border flex-shrink-0",style:{backgroundColor:l.color||"hsl(var(--primary))"}}),y.jsx("span",{className:"truncate flex-1",children:l.name})]},l.id)):y.jsx("div",{className:"px-2 py-4 text-xs text-muted-foreground text-center",children:"Not in any groups"})}),y.jsx("div",{className:"border-t border-border mt-1",children:y.jsx("button",{onClick:s,className:"w-full px-2 py-1.5 text-xs text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors",children:"Cancel"})})]})}function d5({x:c,y:e,onDelete:t,onClose:s}){const n=R.useRef(null),[i,a]=R.useState({x:c,y:e});return R.useEffect(()=>{if(n.current){const o=n.current.getBoundingClientRect(),l=window.innerWidth,d=window.innerHeight;let h=c,p=e;c+o.width>l&&(h=l-o.width-8),e+o.height>d&&(p=d-o.height-8),h=Math.max(8,h),p=Math.max(8,p),a({x:h,y:p})}},[c,e]),R.useEffect(()=>{const o=d=>{n.current&&!n.current.contains(d.target)&&s()},l=d=>{d.key==="Escape"&&s()};return document.addEventListener("mousedown",o),document.addEventListener("keydown",l),()=>{document.removeEventListener("mousedown",o),document.removeEventListener("keydown",l)}},[s]),y.jsx("div",{ref:n,className:"fixed bg-card border border-border rounded-md shadow-lg z-50",style:{left:`${i.x}px`,top:`${i.y}px`},children:y.jsx("button",{className:"w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors first:rounded-t-md last:rounded-b-md",onClick:t,children:"Delete"})})}function Jv(){const c=R.useRef(null),{nodes:e,connections:t,groups:s=[],addNode:n,addConnection:i,deleteConnection:a,zoom:o,pan:l,setPan:d,setZoom:h,selectNode:p,selectConnection:g,selectGroup:v,selectNodesByIds:b,selectedConnectionId:M,selectedNodeId:x,setViewportSize:S,deleteNode:T,updateNode:E,bringToFront:A,sendToBack:k,bringForward:D,sendBackward:L,canvasBounds:I,canvasChunks:U,addNodeToGroup:Q,removeNodeFromGroup:se}=ke(),{isRunning:F}=_t(),{showMinimap:Y,showHeatMapLegend:ae,showRuler:de}=Wr(),{getNodeRef:z}=ju(),[$,q]=R.useState(!1),[ee,me]=R.useState({x:0,y:0}),[N,J]=R.useState(!1),[K,ie]=R.useState(null),[Z,re]=R.useState(void 0),[V,j]=R.useState(null),[ue,fe]=R.useState(null),[ge,pe]=R.useState(null),[we,Re]=R.useState(null),[tt,ze]=R.useState(null),[Ct,he]=R.useState(null),[Qe,Ue]=R.useState(null);R.useEffect(()=>{if(!c.current)return;const ne=()=>{if(!c.current)return;const Me=c.current.getBoundingClientRect();S({width:Me.width,height:Me.height})};ne();const ye=new ResizeObserver(()=>{ne()});return ye.observe(c.current),window.addEventListener("resize",ne),()=>{ye.disconnect(),window.removeEventListener("resize",ne)}},[S]),R.useEffect(()=>{const ne=ye=>{if((ye.ctrlKey||ye.metaKey)&&c.current){const Me=c.current.getBoundingClientRect();ye.clientX>=Me.left&&ye.clientX<=Me.right&&ye.clientY>=Me.top&&ye.clientY<=Me.bottom&&ye.preventDefault()}};return document.addEventListener("wheel",ne,{passive:!1,capture:!0}),()=>{document.removeEventListener("wheel",ne,{capture:!0})}},[]);const Mt=ne=>{if(ne.preventDefault(),!c.current)return;const ye=ne.dataTransfer.getData("application/json");if(!ye)return;const Me=JSON.parse(ye),je=c.current.getBoundingClientRect(),$e=(ne.clientX-je.left-l.x)/o,it=(ne.clientY-je.top-l.y)/o,Wt={id:`node-${Date.now()}`,type:Me.type,position:{x:$e,y:it},data:{label:Me.label}};n(Wt)},yt=ne=>{ne.preventDefault(),ne.dataTransfer.dropEffect="copy"},Ht=ne=>{const ye=ne.button===0;if(ne.button===1||ye&&ne.ctrlKey){q(!0),me({x:ne.clientX-l.x,y:ne.clientY-l.y}),ne.preventDefault();return}if(ye&&!N&&!ne.ctrlKey&&!ne.metaKey){if(c.current){const je=c.current.getBoundingClientRect(),$e=(ne.clientX-je.left-l.x)/o,it=(ne.clientY-je.top-l.y)/o;Re({x:$e,y:it}),ze({x:$e,y:it,width:0,height:0})}p(null),g(null),v(null)}},nt=ne=>{if($)d({x:ne.clientX-ee.x,y:ne.clientY-ee.y});else if(N&&c.current){const ye=c.current.getBoundingClientRect();j({x:(ne.clientX-ye.left-l.x)/o,y:(ne.clientY-ye.top-l.y)/o})}else if(we&&c.current){const ye=c.current.getBoundingClientRect(),Me=(ne.clientX-ye.left-l.x)/o,je=(ne.clientY-ye.top-l.y)/o,$e=Math.min(we.x,Me),it=Math.min(we.y,je),Wt=Math.abs(Me-we.x),ls=Math.abs(je-we.y),$t={x:$e,y:it,width:Wt,height:ls};ze($t);const xs=e.filter(Et=>{const Tt=Et.position.x,bt=Et.position.y,Bt=Et.position.x+140,gn=Et.position.y+140;return Bt>=$t.x&&Tt<=$t.x+$t.width&&gn>=$t.y&&bt<=$t.y+$t.height}).map(Et=>Et.id);b(xs)}},It=()=>{q(!1),N&&(J(!1),ie(null),j(null)),we&&(Re(null),ze(null))},wt=R.useCallback((ne,ye)=>{J(!0),ie(ne),re(ye)},[]),vt=R.useCallback(ne=>{const ye=z(ne);if(!ye)return{width:140,height:100};const $e=(ye.querySelector(".bg-card")||ye).getBoundingClientRect();return{width:$e.width/o,height:$e.height/o}},[z,o]),Xt=R.useCallback((ne,ye)=>{if(N&&K&&K!==ne){const Me=e.find($e=>$e.id===K),je=e.find($e=>$e.id===ne);if(Me&&je){const $e=vt(K),it=vt(ne),Wt=V?.x??je.position.x+it.width/2,ls=V?.y??je.position.y+it.height/2,$t=Me.position.x+$e.width/2,xs=Me.position.y+$e.height/2,Et=Z!==void 0?Z:Yv(K,ne,Wt,ls,t,Me.position.x,Me.position.y,$e.width,$e.height),Tt=ye!==void 0?ye:Yv(ne,K,$t,xs,t,je.position.x,je.position.y,it.width,it.height),bt={id:`conn-${Date.now()}`,source:K,target:ne,type:"async",sourcePort:Et,targetPort:Tt};i(bt)}}J(!1),ie(null),re(void 0),j(null)},[N,K,Z,e,t,i,V,vt]),Vt=R.useCallback(ne=>{g(ne)},[g]),Ln=R.useCallback((ne,ye,Me)=>{fe({connectionId:ne,x:ye,y:Me})},[]),Xs=R.useCallback(ne=>{const ye=ne.target,Me=ye.closest?.("[data-node-id]"),je=ye.closest?.("[data-connection-id]"),$e=ye instanceof SVGElement,it=ye.closest?.("svg")!==null;if(Me||je||$e||it)return;const Wt=e.filter(ls=>ls.selected);Wt.length>0&&(ne.preventDefault(),ne.stopPropagation(),pe({nodeId:Wt[0].id,x:ne.clientX,y:ne.clientY}))},[e]),_s=R.useCallback(()=>{ue&&(a(ue.connectionId),fe(null))},[ue,a]),pn=R.useMemo(()=>e.map(ne=>ne.id).join(","),[e]),Jt=R.useMemo(()=>{const ne=new Map;return e.forEach(ye=>{const Me=ye.id;ne.set(Me,{onConnectionStart:je=>wt(Me,je),onConnectionEnd:je=>Xt(Me,je),onContextMenu:(je,$e)=>pe({nodeId:Me,x:je,y:$e})})}),ne},[pn,wt,Xt,e]),Gt=R.useMemo(()=>t.map(ne=>ne.id).join(","),[t]),Nt=R.useMemo(()=>{const ne=new Map;return t.forEach(ye=>{const Me=ye.id;ne.set(Me,{onClick:()=>Vt(Me),onContextMenu:je=>Ln(Me,je.clientX,je.clientY)})}),ne},[Gt,Vt,Ln,t]),Gi=ne=>{if(ne.ctrlKey&&c.current){ne.preventDefault();const{left:ye,top:Me,width:je,height:$e}=c.current.getBoundingClientRect(),it=ne.clientX-ye,Wt=ne.clientY-Me,ls=(it-l.x)/o,$t=(Wt-l.y)/o,xs=1+Math.min(Math.max(-ne.deltaY/500,-.5),.5);let Et=o*xs;Et=Math.min(Math.max(Et,.3),2.5);const Tt=it-ls*Et,bt=Wt-$t*Et;h(Et),d({x:Tt,y:bt})}},Aa=20,ic=de?24:0,Ss=2e3,Wi=o<.5,li=ke(ne=>ne.viewportWidth),Js=ke(ne=>ne.viewportHeight),_n=R.useMemo(()=>{if(li===0||Js===0)return e;const ne=-l.x/o,ye=-l.y/o,Me=(li-l.x)/o,je=(Js-l.y)/o,$e=200,it=ne-$e,Wt=ye-$e,ls=Me+$e,$t=je+$e;return e.filter(xs=>{const Et=xs.position.x,Tt=xs.position.y;return Et+140>=it&&Et<=ls&&Tt+100>=Wt&&Tt<=$t})},[e,o,l,li,Js]),In=R.useMemo(()=>new Set(_n.map(ne=>ne.id)),[_n]),Ou=R.useMemo(()=>t.filter(ne=>In.has(ne.source)&&In.has(ne.target)),[t,In]);return y.jsxs("div",{className:"flex-1 overflow-hidden relative",children:[y.jsx(r5,{isVisible:de,canvasRef:c}),y.jsx("div",{ref:c,className:"absolute overflow-hidden",style:{top:`${ic}px`,left:`${ic}px`,right:0,bottom:0,cursor:$?"grabbing":N?"crosshair":"default",backgroundColor:"hsl(var(--muted) / 0.1)"},onDrop:Mt,onDragOver:yt,onMouseDown:Ht,onMouseMove:nt,onMouseUp:It,onMouseLeave:It,onWheel:Gi,onContextMenu:Xs,children:y.jsxs("div",{style:{transform:`translate(${l.x}px, ${l.y}px) scale(${o})`,transformOrigin:"0 0",width:"100%",height:"100%",position:"relative"},children:[U.map(ne=>{const ye=ne.x*Ss,Me=ne.y*Ss,je=U.some(it=>it.x===ne.x+1&&it.y===ne.y),$e=U.some(it=>it.x===ne.x&&it.y===ne.y+1);return y.jsxs("div",{className:"absolute pointer-events-none",style:{left:`${ye}px`,top:`${Me}px`,width:`${Ss}px`,height:`${Ss}px`,backgroundColor:"hsl(var(--canvas-bg))",border:Wi?"2px dashed hsl(var(--border) / 0.6)":"none",boxShadow:Wi?"inset 0 0 0 1px hsl(var(--border) / 0.3)":"none"},children:[je&&y.jsx("div",{className:"absolute top-0 bottom-0 pointer-events-none z-10",style:{right:0,width:"1px",backgroundColor:"hsl(var(--border) / 0.5)"}}),$e&&y.jsx("div",{className:"absolute left-0 right-0 pointer-events-none z-10",style:{bottom:0,height:"1px",backgroundColor:"hsl(var(--border) / 0.5)"}})]},`chunk-${ne.x}-${ne.y}`)}),y.jsxs("svg",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:[y.jsx("defs",{children:y.jsx("pattern",{id:"grid-pattern",width:Aa,height:Aa,patternUnits:"userSpaceOnUse",children:y.jsx("path",{d:`M ${Aa} 0 L 0 0 0 ${Aa}`,fill:"none",stroke:"hsl(var(--canvas-grid))",strokeWidth:"1"})})}),U.map(ne=>{const ye=ne.x*Ss,Me=ne.y*Ss;return y.jsx("rect",{x:ye,y:Me,width:Ss,height:Ss,fill:"url(#grid-pattern)"},`grid-chunk-${ne.x}-${ne.y}`)})]}),tt&&y.jsx("div",{className:"absolute border-2 border-primary/60 bg-primary/10 pointer-events-none",style:{left:tt.x,top:tt.y,width:tt.width,height:tt.height}}),y.jsxs("svg",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:[y.jsxs("defs",{children:[y.jsx("marker",{id:"arrowhead-default",markerWidth:"8",markerHeight:"8",refX:"7",refY:"4",orient:"auto",markerUnits:"userSpaceOnUse",children:y.jsx("path",{d:"M0,0 L0,8 L8,4 z",fill:"hsl(var(--border))",stroke:"none"})}),y.jsx("marker",{id:"arrowhead-selected",markerWidth:"10",markerHeight:"10",refX:"8",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse",children:y.jsx("path",{d:"M0,0 L0,10 L10,5 z",fill:"hsl(var(--primary))",stroke:"none"})}),y.jsx("marker",{id:"arrowhead-bottleneck",markerWidth:"12",markerHeight:"12",refX:"10",refY:"6",orient:"auto",markerUnits:"userSpaceOnUse",children:y.jsx("path",{d:"M0,0 L0,12 L12,6 z",fill:"hsl(0 84% 60%)",stroke:"none"})})]}),s&&s.length>0&&y.jsx("g",{style:{pointerEvents:"auto"},children:s.map(ne=>y.jsx(o5,{group:ne,zoom:o},ne.id))}),y.jsxs("g",{style:{pointerEvents:"auto"},children:[Ou.map(ne=>{const ye=e.find($e=>$e.id===ne.source),Me=e.find($e=>$e.id===ne.target);if(!ye||!Me)return null;const je=Nt.get(ne.id);return je?y.jsx(HO,{connection:ne,sourceNode:ye,targetNode:Me,zoom:o,pan:l,isSelected:M===ne.id,onClick:je.onClick,onContextMenu:je.onContextMenu},ne.id):null}),N&&K&&V&&(()=>{const ne=e.find($e=>$e.id===K);if(!ne)return null;const ye=vt(K);let Me,je;if(Z!==void 0){const it=Ao(ne.position.x,ne.position.y,ye.width,ye.height,16)[Z];Me=it.x,je=it.y}else Me=ne.position.x+ye.width/2,je=ne.position.y+ye.height/2;return y.jsx("line",{x1:Me,y1:je,x2:V.x,y2:V.y,stroke:"hsl(var(--primary))",strokeWidth:2/o,strokeDasharray:"5,5",style:{pointerEvents:"none"}})})()]})]}),_n.map(ne=>{const ye=Jt.get(ne.id);return ye?y.jsx(NO,{node:ne,onConnectionStart:ye.onConnectionStart,onConnectionEnd:ye.onConnectionEnd,isConnecting:N,onContextMenu:ye.onContextMenu},ne.id):null}),F&&_n.map(ne=>y.jsx(FO,{nodeId:ne.id,position:ne.position},`metrics-${ne.id}`))]})}),y.jsx(QO,{isVisible:ae}),y.jsx(VO,{isVisible:Y}),y.jsx(zO,{selectedNodeId:x,highlightPath:!0}),ue&&y.jsx(d5,{x:ue.x,y:ue.y,onDelete:_s,onClose:()=>fe(null)}),ge&&(()=>{const ne=e.find(We=>We.id===ge.nodeId);if(!ne)return null;const ye=e.filter(We=>We.selected),Me=ye.length>1,je=()=>{Me?(ye.forEach(We=>{T(We.id)}),Ze.success(`${ye.length} elements deleted`)):(T(ne.id),Ze.success("Element deleted")),pe(null)},$e=()=>{if(Me)ye.forEach((We,Is)=>{const Ki={...kl(We),id:`${We.type}_${Date.now()}_${Is}`,position:{x:We.position.x+20+Is*10,y:We.position.y+20+Is*10},selected:!1};Ki.data?.config&&(Ki.data.config=kl(Ki.data.config)),n(Ki)}),Ze.success(`${ye.length} elements duplicated`);else{const We={...kl(ne),id:`${ne.type}_${Date.now()}`,position:{x:ne.position.x+20,y:ne.position.y+20},selected:!1};We.data?.config&&(We.data.config=kl(We.data.config)),n(We),Ze.success("Element duplicated")}pe(null)},it=()=>{if(Me){const We=ye.map(Is=>Is.id).join(", ");navigator.clipboard.writeText(We),Ze.success(`${ye.length} IDs copied to clipboard`)}else navigator.clipboard.writeText(ne.id),Ze.success("ID copied to clipboard");pe(null)},Wt=()=>{Me?(ye.forEach(We=>{A(We.id)}),Ze.success(`${ye.length} elements brought to front`)):(A(ne.id),Ze.success("Brought to front")),pe(null)},ls=()=>{Me?(ye.forEach(We=>{k(We.id)}),Ze.success(`${ye.length} elements sent to back`)):(k(ne.id),Ze.success("Sent to back")),pe(null)},$t=()=>{Me?(ye.forEach(We=>{D(We.id)}),Ze.success(`${ye.length} elements brought forward`)):(D(ne.id),Ze.success("Brought forward")),pe(null)},xs=()=>{Me?(ye.forEach(We=>{L(We.id)}),Ze.success(`${ye.length} elements sent backward`)):(L(ne.id),Ze.success("Sent backward")),pe(null)},Et=()=>{he(Me?{nodeId:ye[0].id,x:ge.x,y:ge.y}:{nodeId:ne.id,x:ge.x,y:ge.y}),pe(null)},Tt=Me?s.filter(We=>ye.some(Is=>We.nodeIds.includes(Is.id))):s.filter(We=>We.nodeIds.includes(ne.id)),bt=Tt.length>=1,Bt=Tt.length>=2,gn=()=>{if(Me){let We=0;ye.forEach(Is=>{s.filter(Da=>Da.nodeIds.includes(Is.id)).forEach(Da=>{se(Da.id,Is.id),We++})}),We>0&&Ze.success(`Removed ${ye.length} elements from groups`),pe(null)}else Bt?(Ue({nodeId:ne.id,x:ge.x,y:ge.y}),pe(null)):Tt.length===1&&(se(Tt[0].id,ne.id),Ze.success(`Removed from "${Tt[0].name}"`),pe(null))};return y.jsx(c5,{x:ge.x,y:ge.y,onDelete:je,onDuplicate:$e,onCopyId:it,onBringToFront:Wt,onSendToBack:ls,onBringForward:$t,onSendBackward:xs,onAddToGroup:Et,onRemoveFromGroup:bt?gn:void 0,onClose:()=>pe(null)})})(),Ct&&y.jsx(l5,{nodeId:Ct.nodeId,x:Ct.x,y:Ct.y,onClose:()=>he(null)}),Qe&&y.jsx(u5,{nodeId:Qe.nodeId,x:Qe.x,y:Qe.y,onClose:()=>Ue(null)})]})}const h5="modulepreload",f5=function(c){return"/"+c},Zv={},Te=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){let l=function(d){return Promise.all(d.map(h=>Promise.resolve(h).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),o=a?.nonce||a?.getAttribute("nonce");n=l(t.map(d=>{if(d=f5(d),d in Zv)return;Zv[d]=!0;const h=d.endsWith(".css"),p=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${p}`))return;const g=document.createElement("link");if(g.rel=h?"stylesheet":h5,h||(g.as="script"),g.crossOrigin="",g.href=d,o&&g.setAttribute("nonce",o),document.head.appendChild(g),h)return new Promise((v,b)=>{g.addEventListener("load",v),g.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return n.then(a=>{for(const o of a||[])o.status==="rejected"&&i(o.reason);return e().catch(i)})},p5=R.lazy(()=>Te(()=>import("./KafkaConfigAdvanced-BMvFA8TZ.js"),__vite__mapDeps([0,1,2,3,4,5,6,7])).then(c=>({default:c.KafkaConfigAdvanced}))),g5=R.lazy(()=>Te(()=>import("./RabbitMQConfigAdvanced-CzLt9wOL.js"),__vite__mapDeps([8,1,3,9,10,11,12,13,14,6,4])).then(c=>({default:c.RabbitMQConfigAdvanced}))),m5=R.lazy(()=>Te(()=>import("./PostgreSQLConfigAdvanced-Di9J_5uN.js"),__vite__mapDeps([15,2,9,11,10,4,16,17,5,14])).then(c=>({default:c.PostgreSQLConfigAdvanced}))),y5=R.lazy(()=>Te(()=>import("./MongoDBConfigAdvanced-BUUcBd6v.js"),__vite__mapDeps([18,2,9,11,10,4])).then(c=>({default:c.MongoDBConfigAdvanced}))),v5=R.lazy(()=>Te(()=>import("./RedisConfigAdvanced-Rl01YOxk.js"),__vite__mapDeps([19,2,11,10,4,14,20])).then(c=>({default:c.RedisConfigAdvanced}))),b5=R.lazy(()=>Te(()=>import("./ElasticsearchConfigAdvanced-BGlvMFbk.js"),__vite__mapDeps([21,2,11,7,22,4,6])).then(c=>({default:c.ElasticsearchConfigAdvanced}))),M5=R.lazy(()=>Te(()=>import("./CassandraConfigAdvanced-CL05MpF4.js"),__vite__mapDeps([23,1,2,4,17,22])).then(c=>({default:c.CassandraConfigAdvanced}))),w5=R.lazy(()=>Te(()=>import("./ClickHouseConfigAdvanced-Doj3lzSE.js"),__vite__mapDeps([24,2,1,9,10,11,25,4,22])).then(c=>({default:c.ClickHouseConfigAdvanced}))),S5=R.lazy(()=>Te(()=>import("./SnowflakeConfigAdvanced-CbXEYRqH.js"),__vite__mapDeps([26,2,7,4,14])).then(c=>({default:c.SnowflakeConfigAdvanced}))),x5=R.lazy(()=>Te(()=>import("./S3DataLakeConfigAdvanced-HfrTx3cx.js"),__vite__mapDeps([27,7,14,28])).then(c=>({default:c.S3DataLakeConfigAdvanced}))),C5=R.lazy(()=>Te(()=>import("./NginxConfigAdvanced-5DQhc154.js"),__vite__mapDeps([29,2,1,30,31,32,13,6])).then(c=>({default:c.NginxConfigAdvanced})));R.lazy(()=>Te(()=>import("./RestApiConfigAdvanced-DL3w07M6.js"),__vite__mapDeps([33,2,1,34,11,31,35,36,22])).then(c=>({default:c.RestApiConfigAdvanced})));R.lazy(()=>Te(()=>import("./GRPCConfigAdvanced-D6UVBL1o.js"),__vite__mapDeps([37,2,11,7,32,38])).then(c=>({default:c.GRPCConfigAdvanced})));R.lazy(()=>Te(()=>import("./WebSocketConfigAdvanced-C_qtt4JC.js"),__vite__mapDeps([39,2,11,7,12,40,41,38,42])).then(c=>({default:c.WebSocketConfigAdvanced})));R.lazy(()=>Te(()=>import("./GraphQLConfigAdvanced-F6o6akgq.js"),__vite__mapDeps([43,2,30,7,4,25,35,44,38])).then(c=>({default:c.GraphQLConfigAdvanced})));R.lazy(()=>Te(()=>import("./SOAPConfigAdvanced-BeXxI6yx.js"),__vite__mapDeps([45,2,30,7,32,38,6])).then(c=>({default:c.SOAPConfigAdvanced})));R.lazy(()=>Te(()=>import("./WebhookConfigAdvanced-BXfYor-6.js"),__vite__mapDeps([46,2,3,11,7,47,40,38,48,49,36,50])).then(c=>({default:c.WebhookConfigAdvanced})));const R5=R.lazy(()=>Te(()=>import("./DockerK8sConfigAdvanced-BtvbjrvM.js"),__vite__mapDeps([51,2,1,52,11,50,53])).then(c=>({default:c.DockerK8sConfigAdvanced})));R.lazy(()=>Te(()=>import("./InfrastructureConfig-DUWjzeNm.js"),__vite__mapDeps([54,2])).then(c=>({default:c.InfrastructureConfig})));const T5=R.lazy(()=>Te(()=>import("./KubernetesConfigAdvanced-BbnGVIiH.js"),__vite__mapDeps([55,2,11,1,6,4,32,53])).then(c=>({default:c.KubernetesConfigAdvanced}))),E5=R.lazy(()=>Te(()=>import("./HAProxyConfigAdvanced-B7NCHYQR.js"),__vite__mapDeps([56,11,7,35,38,32,6])).then(c=>({default:c.HAProxyConfigAdvanced}))),k5=R.lazy(()=>Te(()=>import("./TraefikConfigAdvanced-_4k6PvUH.js"),__vite__mapDeps([57,11,7,58,38,6])).then(c=>({default:c.TraefikConfigAdvanced}))),A5=R.lazy(()=>Te(()=>import("./EnvoyConfigAdvanced-QeykLm-d.js"),__vite__mapDeps([59,11,7,32,31,38])).then(c=>({default:c.EnvoyConfigAdvanced}))),D5=R.lazy(()=>Te(()=>import("./ActiveMQConfigAdvanced-PUfLyZdz.js"),__vite__mapDeps([60,1,52,11,3,7,12,4,5,6,42])).then(c=>({default:c.ActiveMQConfigAdvanced}))),P5=R.lazy(()=>Te(()=>import("./AWSSQSConfigAdvanced-DnL_F29D.js"),__vite__mapDeps([61,1,11,7,62,12,14,6,40])).then(c=>({default:c.AWSSQSConfigAdvanced}))),L5=R.lazy(()=>Te(()=>import("./AzureServiceBusConfigAdvanced-Bl9FSKIH.js"),__vite__mapDeps([63,2,52,12,6,14,36,38])).then(c=>({default:c.AzureServiceBusConfigAdvanced}))),_5=R.lazy(()=>Te(()=>import("./GCPPubSubConfigAdvanced-wU58Y-kd.js"),__vite__mapDeps([64,1,2,12,5,14,40,36])).then(c=>({default:c.GCPPubSubConfigAdvanced}))),I5=R.lazy(()=>Te(()=>import("./KongConfigAdvanced-DNenV9Lf.js"),__vite__mapDeps([65,2,11,32,58,5])).then(c=>({default:c.KongConfigAdvanced}))),N5=R.lazy(()=>Te(()=>import("./ApigeeConfigAdvanced-DoXrxHXg.js"),__vite__mapDeps([66,1,2,30,3,6,67,5,44,14,68])).then(c=>({default:c.ApigeeConfigAdvanced}))),z5=R.lazy(()=>Te(()=>import("./MuleSoftConfigAdvanced-BkEbNCa-.js"),__vite__mapDeps([69,1,30,2,4,38,70])).then(c=>({default:c.MuleSoftConfigAdvanced}))),j5=R.lazy(()=>Te(()=>import("./GraphQLGatewayConfigAdvanced-BgX0NhUn.js"),__vite__mapDeps([71,30,31,25,6])).then(c=>({default:c.GraphQLGatewayConfigAdvanced}))),O5=R.lazy(()=>Te(()=>import("./BFFServiceConfigAdvanced-B4jsDCpg.js"),__vite__mapDeps([72,7])).then(c=>({default:c.BFFServiceConfigAdvanced}))),q5=R.lazy(()=>Te(()=>import("./WebhookRelayConfigAdvanced-Sux-zuzw.js"),__vite__mapDeps([73,2,52,7,47,40,38,36])).then(c=>({default:c.WebhookRelayConfigAdvanced}))),H5=R.lazy(()=>Te(()=>import("./PrometheusConfigAdvanced-BBzyiCQZ.js"),__vite__mapDeps([74,2,11,53])).then(c=>({default:c.PrometheusConfigAdvanced}))),$5=R.lazy(()=>Te(()=>import("./GrafanaConfigAdvanced-D6Q6OHH2.js"),__vite__mapDeps([75,25,48,76,2,4])).then(c=>({default:c.GrafanaConfigAdvanced}))),B5=R.lazy(()=>Te(()=>import("./LokiConfigAdvanced-ChNLK29K.js"),__vite__mapDeps([77,2,42])).then(c=>({default:c.LokiConfigAdvanced}))),U5=R.lazy(()=>Te(()=>import("./JaegerConfigAdvanced-CvHGJzbI.js"),__vite__mapDeps([78,1,70])).then(c=>({default:c.JaegerConfigAdvanced}))),F5=R.lazy(()=>Te(()=>import("./OpenTelemetryCollectorConfigAdvanced-BtGpipeO.js"),__vite__mapDeps([79,1,7,13])).then(c=>({default:c.OpenTelemetryCollectorConfigAdvanced}))),Q5=R.lazy(()=>Te(()=>import("./PagerDutyConfigAdvanced-BqUbjtvy.js"),__vite__mapDeps([80,7,5,41,36])).then(c=>({default:c.PagerDutyConfigAdvanced}))),V5=R.lazy(()=>Te(()=>import("./KeycloakConfigAdvanced-xQs6iIpN.js"),__vite__mapDeps([81,2,30,6,31,14,5,36,82,83,68])).then(c=>({default:c.KeycloakConfigAdvanced}))),G5=R.lazy(()=>Te(()=>import("./WAFConfigAdvanced-Cfs4kHJj.js"),__vite__mapDeps([84,30,7,6,31,38])).then(c=>({default:c.WAFConfigAdvanced}))),W5=R.lazy(()=>Te(()=>import("./SecretsVaultConfigAdvanced-CRZJvJDF.js"),__vite__mapDeps([85,30,2,7,14,4,6,82,68,38])).then(c=>({default:c.SecretsVaultConfigAdvanced}))),K5=R.lazy(()=>Te(()=>import("./IDSIPSConfigAdvanced-ComGaEyd.js"),__vite__mapDeps([86,30,7,6,38])).then(c=>({default:c.IDSIPSConfigAdvanced}))),Y5=R.lazy(()=>Te(()=>import("./FirewallConfigAdvanced-DNi-iZnC.js"),__vite__mapDeps([87,52,30,7,6,38,35])).then(c=>({default:c.FirewallConfigAdvanced}))),X5=R.lazy(()=>Te(()=>import("./JenkinsConfigAdvanced-BuQgKsa6.js"),__vite__mapDeps([88,1,2,30,70,67,32,5,25,35,48,49,36,76,50])).then(c=>({default:c.JenkinsConfigAdvanced}))),J5=R.lazy(()=>Te(()=>import("./GitLabCIConfigAdvanced-DTq6IjOL.js"),__vite__mapDeps([89,1,30,70,22,32,4,31,90,36])).then(c=>({default:c.GitLabCIConfigAdvanced}))),Z5=R.lazy(()=>Te(()=>import("./ArgoCDConfigAdvanced-Dfwr3whk.js"),__vite__mapDeps([91,1,2,30,4,92,6,41,70,36])).then(c=>({default:c.ArgoCDConfigAdvanced}))),e3=R.lazy(()=>Te(()=>import("./HarborConfigAdvanced-C4dtI5FQ.js"),__vite__mapDeps([93,11,67,28,5,6])).then(c=>({default:c.HarborConfigAdvanced}))),t3=R.lazy(()=>Te(()=>import("./TerraformConfigAdvanced-DwWokWjC.js"),__vite__mapDeps([94,30,2,7,38,62,36])).then(c=>({default:c.TerraformConfigAdvanced}))),s3=R.lazy(()=>Te(()=>import("./AnsibleConfigAdvanced-CsvTAwDk.js"),__vite__mapDeps([95,30,2,7,32,38,92,14,90,36])).then(c=>({default:c.AnsibleConfigAdvanced}))),n3=R.lazy(()=>Te(()=>import("./IstioConfigAdvanced-C1Zfx6vV.js"),__vite__mapDeps([96,52,2,7,58,31,6])).then(c=>({default:c.IstioConfigAdvanced}))),i3=R.lazy(()=>Te(()=>import("./ServiceMeshConfigAdvanced-Bxootrd7.js"),__vite__mapDeps([97,52,2,11,7,58,31,6])).then(c=>({default:c.ServiceMeshConfigAdvanced}))),a3=R.lazy(()=>Te(()=>import("./APIGatewayConfigAdvanced-CM-erg39.js"),__vite__mapDeps([98,2,11,7,62,31,6,35,67,14,32,16,5,58])).then(c=>({default:c.APIGatewayConfigAdvanced}))),o3=R.lazy(()=>Te(()=>import("./VPNConfigAdvanced-DSi9JLiU.js"),__vite__mapDeps([99,11,7,5,82,36])).then(c=>({default:c.VPNConfigAdvanced}))),r3=R.lazy(()=>Te(()=>import("./CDNConfigAdvanced-h978UR_c.js"),__vite__mapDeps([100,30,3,7,31,35])).then(c=>({default:c.CDNConfigAdvanced}))),c3=R.lazy(()=>Te(()=>import("./SparkConfigAdvanced-Dlf5ZkWM.js"),__vite__mapDeps([101,2,1,34,30,7,4,22,36,53,20,25,38,48,49])).then(c=>({default:c.SparkConfigAdvanced}))),l3=R.lazy(()=>Te(()=>import("./TensorFlowServingConfigAdvanced-CfSgDJah.js"),__vite__mapDeps([102,2,30,7,4,25,38,48,49])).then(c=>({default:c.TensorFlowServingConfigAdvanced}))),u3=R.lazy(()=>Te(()=>import("./PyTorchServeConfigAdvanced-fQk2kAA_.js"),__vite__mapDeps([103,2,11,7,4,38])).then(c=>({default:c.PyTorchServeConfigAdvanced}))),d3=R.lazy(()=>Te(()=>import("./FeatureStoreConfigAdvanced-D-Oz3rXn.js"),__vite__mapDeps([104,2,30,7,67,4,35,32,48,49])).then(c=>({default:c.FeatureStoreConfigAdvanced}))),h3=R.lazy(()=>Te(()=>import("./CRMConfigAdvanced-Cxb9tHMg.js"),__vite__mapDeps([105,2,30,7,5,106,35,107,83])).then(c=>({default:c.CRMConfigAdvanced}))),f3=R.lazy(()=>Te(()=>import("./ERPConfigAdvanced-CR7plfTK.js"),__vite__mapDeps([108,2,30,7,67,106,35,109,5,25,107,50])).then(c=>({default:c.ERPConfigAdvanced}))),p3=R.lazy(()=>Te(()=>import("./PaymentGatewayConfigAdvanced-DJRTT9ek.js"),__vite__mapDeps([110,2,30,7,106,35,109,6,38,36])).then(c=>({default:c.PaymentGatewayConfigAdvanced}))),g3=()=>y.jsx("div",{className:"flex items-center justify-center h-full",children:y.jsx("div",{className:"text-muted-foreground",children:"Loading configuration..."})});function m3({componentId:c,componentType:e}){const t=()=>{switch(e){case"kafka":return y.jsx(p5,{componentId:c});case"rabbitmq":return y.jsx(g5,{componentId:c});case"postgres":return y.jsx(m5,{componentId:c});case"mongodb":return y.jsx(y5,{componentId:c});case"redis":return y.jsx(v5,{componentId:c});case"elasticsearch":return y.jsx(b5,{componentId:c});case"cassandra":return y.jsx(M5,{componentId:c});case"clickhouse":return y.jsx(w5,{componentId:c});case"snowflake":return y.jsx(S5,{componentId:c});case"s3-datalake":return y.jsx(x5,{componentId:c});case"nginx":return y.jsx(C5,{componentId:c});case"docker":return y.jsx(R5,{componentId:c});case"kubernetes":return y.jsx(T5,{componentId:c});case"haproxy":return y.jsx(E5,{componentId:c});case"traefik":return y.jsx(k5,{componentId:c});case"envoy":return y.jsx(A5,{componentId:c});case"activemq":return y.jsx(D5,{componentId:c});case"aws-sqs":return y.jsx(P5,{componentId:c});case"azure-service-bus":return y.jsx(L5,{componentId:c});case"gcp-pubsub":return y.jsx(_5,{componentId:c});case"kong":return y.jsx(I5,{componentId:c});case"apigee":return y.jsx(N5,{componentId:c});case"mulesoft":return y.jsx(z5,{componentId:c});case"graphql-gateway":return y.jsx(j5,{componentId:c});case"bff-service":return y.jsx(O5,{componentId:c});case"webhook-relay":return y.jsx(q5,{componentId:c});case"prometheus":return y.jsx(H5,{componentId:c});case"grafana":return y.jsx($5,{componentId:c});case"loki":return y.jsx(B5,{componentId:c});case"jaeger":return y.jsx(U5,{componentId:c});case"otel-collector":return y.jsx(F5,{componentId:c});case"pagerduty":return y.jsx(Q5,{componentId:c});case"keycloak":return y.jsx(V5,{componentId:c});case"waf":return y.jsx(G5,{componentId:c});case"firewall":return y.jsx(Y5,{componentId:c});case"secrets-vault":return y.jsx(W5,{componentId:c});case"ids-ips":return y.jsx(K5,{componentId:c});case"jenkins":return y.jsx(X5,{componentId:c});case"gitlab-ci":return y.jsx(J5,{componentId:c});case"argo-cd":return y.jsx(Z5,{componentId:c});case"terraform":return y.jsx(t3,{componentId:c});case"ansible":return y.jsx(s3,{componentId:c});case"harbor":return y.jsx(e3,{componentId:c});case"istio":return y.jsx(n3,{componentId:c});case"service-mesh":return y.jsx(i3,{componentId:c});case"api-gateway":return y.jsx(a3,{componentId:c});case"vpn":return y.jsx(o3,{componentId:c});case"cdn":return y.jsx(r3,{componentId:c});case"spark":return y.jsx(c3,{componentId:c});case"tensorflow-serving":return y.jsx(l3,{componentId:c});case"pytorch-serve":return y.jsx(u3,{componentId:c});case"feature-store":return y.jsx(d3,{componentId:c});case"crm":return y.jsx(h3,{componentId:c});case"erp":return y.jsx(f3,{componentId:c});case"payment-gateway":return y.jsx(p3,{componentId:c});default:return y.jsx("div",{className:"p-6 text-center text-muted-foreground",children:"Configuration panel not available for this component type"})}};return y.jsx(R.Suspense,{fallback:y.jsx(g3,{}),children:t()})}function y3(){const{undo:c,redo:e,zoom:t,setZoom:s,pan:n,setPan:i,resetCanvas:a,saveDiagram:o,selectedConnectionId:l,selectedNodeId:d,selectedGroupId:h,nodes:p,deleteConnection:g,deleteNode:v,deleteGroup:b,selectConnection:M,selectNode:x,selectGroup:S}=ke(),{canUndo:T,canRedo:E}=zr(),{isRunning:A,start:k,stop:D}=_t(),{showMinimap:L,toggleMinimap:I,showHeatMapLegend:U,toggleHeatMapLegend:Q}=Wr();R.useEffect(()=>{const se=F=>{const Y=F.ctrlKey||F.metaKey;if(Y&&F.key==="z"&&!F.shiftKey&&T){F.preventDefault(),c();return}if(Y&&(F.key==="z"&&F.shiftKey||F.key==="y")&&E){F.preventDefault(),e();return}if(Y&&(F.key==="="||F.key==="+")){F.preventDefault(),s(Math.min(t+.1,2));return}if(Y&&F.key==="-"){F.preventDefault(),s(Math.max(t-.1,.5));return}if(Y&&F.key==="0"){F.preventDefault(),s(1),i({x:0,y:0});return}const ae=50;if(!Y){if(F.key==="ArrowLeft"){F.preventDefault(),i({x:n.x+ae,y:n.y});return}if(F.key==="ArrowRight"){F.preventDefault(),i({x:n.x-ae,y:n.y});return}if(F.key==="ArrowUp"){F.preventDefault(),i({x:n.x,y:n.y+ae});return}if(F.key==="ArrowDown"){F.preventDefault(),i({x:n.x,y:n.y-ae});return}}if(!Y&&F.key===" "){const de=F.target;if(!de){if(F.preventDefault(),A)D();else{const{nodes:ee,connections:me}=ke.getState();_t.getState().initialize(ee,me),k()}return}const z=de.tagName;if(z==="INPUT"||z==="TEXTAREA"||z==="SELECT"||de.isContentEditable||de.closest('input, textarea, select, [contenteditable="true"]'))return;const q=de.getAttribute("role");if(q==="textbox"||q==="combobox"||q==="searchbox"||q==="spinbutton"||de.closest("[data-radix-select-trigger], [data-radix-select-content], [data-radix-select-viewport]"))return;if(F.preventDefault(),A)D();else{const{nodes:ee,connections:me}=ke.getState();_t.getState().initialize(ee,me),k()}return}if(Y&&(F.key==="s"||F.key==="")){F.preventDefault(),o();return}if(Y&&(F.key==="m"||F.key==="")){F.preventDefault(),I();return}if(Y&&(F.key==="h"||F.key==="")){F.preventDefault(),Q();return}if((F.key==="Delete"||F.key==="Backspace")&&!Y){const de=document.activeElement;if(de){const $=de.tagName;if($==="INPUT"||$==="TEXTAREA"||$==="SELECT"||de.isContentEditable)return;const q=de.getAttribute("role");if(q==="textbox"||q==="combobox"||q==="searchbox"||q==="spinbutton")return;const ee=de.closest("form")!==null,me=de.closest('[role="textbox"], [role="combobox"], [contenteditable="true"]')!==null,N=de.closest("[data-radix-select-trigger], [data-radix-select-content]")!==null,J=de.closest('[role="dialog"]')!==null;if(ee||me||N||J)return}if(F.preventDefault(),l){g(l),M(null);return}if(h){b(h),S(null);return}const z=p.filter($=>$.selected);if(z.length>0){z.forEach($=>v($.id)),x(null);return}if(d){v(d),x(null);return}}};return window.addEventListener("keydown",se),()=>{window.removeEventListener("keydown",se)}},[c,e,T,E,t,s,n,i,a,o,A,k,D,L,I,U,Q,l,d,h,p,g,v,b,M,x,S])}class Dl extends R.Component{constructor(e){super(e),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){bs("ErrorBoundary caught an error",e,{componentStack:t.componentStack}),this.setState({error:e,errorInfo:t}),this.props.onError&&this.props.onError(e,t)}handleReset=()=>{this.setState({hasError:!1,error:null,errorInfo:null})};render(){return this.state.hasError?this.props.fallback?this.props.fallback:y.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:y.jsxs(Ms,{className:"w-full max-w-2xl",children:[y.jsxs(Cn,{children:[y.jsxs("div",{className:"flex items-center gap-2",children:[y.jsx(rn,{className:"h-5 w-5 text-destructive"}),y.jsx(Rn,{children:"-   "})]}),y.jsx(ba,{children:"    "})]}),y.jsxs(Tn,{className:"space-y-4",children:[this.state.error&&y.jsxs("div",{className:"space-y-2",children:[y.jsx("p",{className:"text-sm font-semibold text-foreground",children:":"}),y.jsx("pre",{className:"text-xs bg-muted p-3 rounded-md overflow-auto max-h-48",children:this.state.error.toString()})]}),!1,y.jsxs("div",{className:"flex gap-2",children:[y.jsxs(De,{onClick:this.handleReset,variant:"default",children:[y.jsx(BD,{className:"h-4 w-4 mr-2"})," "]}),y.jsx(De,{onClick:()=>window.location.reload(),variant:"outline",children:" "})]})]})]})}):this.props.children}}function v3(){y3();const{tabs:c}=ku(),e=c.find(t=>t.active);return y.jsx(Dl,{children:y.jsx(OO,{children:y.jsx(_O,{children:y.jsxs("div",{className:"h-screen flex flex-col bg-background",children:[y.jsx(H_,{}),y.jsx(AO,{}),y.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[y.jsx(Dl,{children:y.jsx(QN,{})}),y.jsx(Dl,{children:e?.type==="diagram"?y.jsx(Jv,{}):e?.type==="component"&&e.componentId&&e.componentType?y.jsx("div",{className:"flex-1 overflow-hidden",children:y.jsx(m3,{componentId:e.componentId,componentType:e.componentType})}):y.jsx(Jv,{})}),y.jsx(Dl,{children:y.jsx(kO,{})})]})]})})})})}jR.createRoot(document.getElementById("root")).render(y.jsxs(Dt.StrictMode,{children:[y.jsx(RT,{position:"top-right"}),y.jsx(v3,{})]}));export{XM as $,wa as A,pt as B,Ms as C,bp as D,fu as E,pv as F,pu as G,hu as H,ct as I,_e as J,b3 as K,He as L,ej as M,sj as N,Gr as O,Bl as P,mD as Q,ND as R,vs as S,Sp as T,Nb as U,Ib as V,PD as W,tP as X,jb as Y,Hb as Z,cn as _,_t as a,S3 as a0,pp as a1,ZM as a2,gp as a3,mp as a4,ew as a5,vp as a6,yp as a7,tu as a8,ep as a9,cs as aA,Xr as aB,Kr as aC,Lp as aD,R3 as aE,_p as aF,M3 as aG,as as aH,Bf as aI,ub as aJ,Dt as aK,Gf as aL,ns as aM,bs as aN,x3 as aO,eD as aP,gu as aQ,Lo as aR,JA as aS,WA as aT,va as aa,rn as ab,pD as ac,uP as ad,Ae as ae,$f as af,Ob as ag,_b as ah,tp as ai,_D as aj,BD as ak,GD as al,zb as am,NE as an,aC as ao,Ma as ap,Vf as aq,ws as ar,No as as,ln as at,En as au,Pp as av,Ne as aw,Cu as ax,Le as ay,be as az,vu as b,nn as c,XD as d,ve as e,si as f,w3 as g,Cn as h,Rn as i,y as j,ba as k,De as l,Tn as m,Sa as n,su as o,cD as p,ji as q,R as r,ni as s,Oi as t,ke as u,ii as v,Ge as w,ma as x,uu as y,du as z};
