import{u as me,j as e,r as M,e as $,B as O,S as ue,C as c,h as d,i as o,m as n,T as he,b as je,c as A,D as Y,A as ge,d as pe,f as H,k as T,l as u,P as Z,o as fe,L as f,q as Ne,s as ve,t as be,v as ye,w as z,I as v,ag as ee,n as b}from"./index-HDGrDyRq.js";import{T as we}from"./textarea-CjQgIquO.js";import{P as se}from"./progress-DX86yUno.js";import{u as Ce}from"./usePortValidation-DV6YP6En.js";import{v as Te}from"./requiredFields-BLgUUVkB.js";import{a as V,s as I}from"./toast-CFyeuGtH.js";import{C as Ee}from"./chart-column-P2BXSWww.js";import{C as Se}from"./code-BU_fBAbx.js";function Pe({componentId:y}){const{nodes:W,updateNode:ae}=me(),D=W.find(s=>s.id===y);if(!D)return e.jsx("div",{className:"p-4 text-muted-foreground",children:"Component not found"});const r=D.data.config||{},E=r.host||"localhost",S=r.port||8123,_=r.database||"default",te=r.username||"default",le=r.password||"",x=r.tables||[],P=r.queries||[],[G,U]=M.useState(null),[re,F]=M.useState(!1),[h,B]=M.useState(""),t=$.getIsRunning(),Q=(t?$.getClickHouseRoutingEngine(y):null)?.getMetrics(),ie=Q?.totalRows??r.totalRows??x.reduce((s,a)=>s+a.rows,0),ne=Q?.totalSize??r.totalSize??x.reduce((s,a)=>s+a.size,0),j=t?Q?.queryThroughput??r.queryThroughput??0:r.queryThroughput??0,k=t?Q?.avgQueryTime??r.avgQueryTime??0:r.avgQueryTime??0,{portError:w,hostError:R,portConflict:C}=Ce(W,y,E,S),m=s=>{if(ae(y,{data:{...D.data,config:{...r,...s}}}),Object.keys(s).some(a=>["host","port","database"].includes(a))){const a={...i};Object.keys(s).forEach(l=>{a[l]&&delete a[l]}),J(a)}},[i,J]=M.useState({}),ce=[{field:"host",label:"Host"},{field:"port",label:"Port",validator:s=>typeof s=="number"&&s>0&&s<=65535},{field:"database",label:"Database"}],g=()=>{const s=Te({host:E,port:S,database:_},ce);return J(s.errors),s.isValid},de=()=>{const s="new_table";let a=s,l=1;for(;x.some(p=>p.name===a);)a=`${s}_${l}`,l++;m({tables:[...x,{name:a,engine:"MergeTree",rows:0,size:0,partitions:0}]})},oe=s=>{m({tables:x.filter((a,l)=>l!==s)})},K=(s,a,l)=>{const p=[...x];p[s]={...p[s],[a]:l},m({tables:p})},xe=()=>{if(!h.trim())return;const s=`query-${Date.now()}`,a=Date.now(),l={id:s,query:h,status:"running",duration:0},p=$.getClickHouseRoutingEngine(y);let N=l;if(p)try{const q=p.executeQuery(h),L=Date.now()-a;if(N={id:s,query:h,status:q.success?"completed":"failed",duration:q.latency||L},q.success){const X=h.trim().toUpperCase();X.startsWith("CREATE TABLE")||X.startsWith("DROP TABLE")}}catch{const L=Date.now()-a;N={id:s,query:h,status:"failed",duration:L}}else N.status="completed",N.duration=Date.now()-a;m({queries:[N,...P.slice(0,9)]}),B(""),F(!1),N.status==="failed"?I("Query execution failed"):V("Query executed successfully")};return e.jsx("div",{className:"h-full overflow-y-auto bg-background",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-yellow-500/10",children:e.jsx(Ee,{className:"h-6 w-6 text-yellow-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"ClickHouse"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Column-Oriented Analytics Database"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(O,{variant:"outline",className:"gap-2",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${t?"bg-green-500 animate-pulse":"bg-gray-400"}`}),t?"Running":"Stopped"]})})]}),e.jsx(ue,{}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Tables"})}),e.jsxs(n,{children:[e.jsx("div",{className:"text-2xl font-bold",children:x.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Total tables"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Total Rows"})}),e.jsxs(n,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[(ie/1e6).toFixed(1),"M"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Rows across all tables"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Total Size"})}),e.jsxs(n,{children:[e.jsx("div",{className:"text-2xl font-bold",children:ne.toFixed(1)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"GB"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Query Throughput"})}),e.jsxs(n,{children:[e.jsx("div",{className:`text-2xl font-bold ${!t&&j===0?"text-muted-foreground":""}`,children:t||j>0?j:"0"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["queries/sec ",!t&&j===0&&"(N/A)"]})]})]})]}),e.jsxs(he,{defaultValue:"tables",className:"w-full",children:[e.jsxs(je,{className:"grid w-full grid-cols-4",children:[e.jsxs(A,{value:"tables",className:"gap-2",children:[e.jsx(Y,{className:"h-4 w-4"}),"Tables"]}),e.jsxs(A,{value:"queries",className:"gap-2",children:[e.jsx(Se,{className:"h-4 w-4"}),"Query Console"]}),e.jsxs(A,{value:"performance",className:"gap-2",children:[e.jsx(ge,{className:"h-4 w-4"}),"Performance"]}),e.jsxs(A,{value:"settings",className:"gap-2",children:[e.jsx(pe,{className:"h-4 w-4"}),"Settings"]})]}),e.jsx(H,{value:"tables",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Tables"}),e.jsx(T,{children:"ClickHouse table configuration"})]}),e.jsxs(u,{size:"sm",onClick:de,variant:"outline",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Create Table"]})]})}),e.jsx(n,{children:e.jsx("div",{className:"space-y-3",children:x.map((s,a)=>e.jsxs(c,{className:"border-border",children:[e.jsx(d,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded bg-primary/10",children:e.jsx(Y,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx(o,{className:"text-lg",children:s.name}),e.jsxs(T,{className:"text-xs mt-1",children:[s.engine," • ",s.partitions," partitions • ",s.rows.toLocaleString()," rows • ",s.size," GB"]})]})]}),x.length>1&&e.jsx(u,{size:"icon",variant:"ghost",onClick:()=>oe(a),children:e.jsx(fe,{className:"h-4 w-4"})})]})}),G===a&&e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"Table Engine"}),e.jsxs(Ne,{value:s.engine,onValueChange:l=>K(a,"engine",l),children:[e.jsx(ve,{children:e.jsx(be,{})}),e.jsxs(ye,{children:[e.jsx(z,{value:"MergeTree",children:"MergeTree"}),e.jsx(z,{value:"SummingMergeTree",children:"SummingMergeTree"}),e.jsx(z,{value:"ReplacingMergeTree",children:"ReplacingMergeTree"}),e.jsx(z,{value:"AggregatingMergeTree",children:"AggregatingMergeTree"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"Partitions"}),e.jsx(v,{type:"number",value:s.partitions,onChange:l=>K(a,"partitions",Number(l.target.value)),min:0})]})]}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>U(null),children:"Done"})]}),G!==a&&e.jsx(n,{children:e.jsx(u,{size:"sm",variant:"outline",onClick:()=>U(a),children:"Edit Settings"})})]},a))})})]})}),e.jsx(H,{value:"queries",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Query Console"}),e.jsx(T,{children:"Execute ClickHouse SQL queries"})]}),e.jsxs(u,{size:"sm",onClick:()=>F(!0),variant:"outline",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"New Query"]})]})}),e.jsxs(n,{children:[re&&e.jsxs(c,{className:"mb-4 border-primary",children:[e.jsx(d,{children:e.jsx(o,{children:"Execute Query"})}),e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"SQL Query"}),e.jsx(we,{value:h,onChange:s=>B(s.target.value),placeholder:"SELECT count() FROM events WHERE date = today();",rows:8,className:"font-mono text-sm"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{onClick:xe,disabled:!h.trim(),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Execute"]}),e.jsx(u,{variant:"outline",onClick:()=>{F(!1),B("")},children:"Cancel"})]})]})]}),P.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No queries executed"}):e.jsx("div",{className:"space-y-2",children:P.map(s=>e.jsx(c,{className:"border-l-4 border-l-blue-500",children:e.jsx(n,{className:"pt-4",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.status==="running"&&e.jsx(ee,{className:"h-4 w-4 text-blue-500 animate-pulse"}),e.jsx(O,{variant:s.status==="completed"?"default":s.status==="failed"?"destructive":"secondary",children:s.status}),s.duration>0&&e.jsxs(O,{variant:"outline",children:[s.duration,"ms"]})]}),e.jsx("pre",{className:"text-xs font-mono bg-muted p-2 rounded overflow-x-auto",children:s.query})]})})})},s.id))})]})]})}),e.jsx(H,{value:"performance",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsxs(d,{children:[e.jsx(o,{children:"Performance Metrics"}),e.jsx(T,{children:t?"Query throughput and latency (real-time)":"Query throughput and latency (simulation not running)"})]}),e.jsxs(n,{className:"space-y-4",children:[!t&&e.jsx("div",{className:"rounded-md bg-muted p-3 text-sm text-muted-foreground",children:"Start the emulation to see real-time metrics. Current values are from configuration or default to 0."}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Query Throughput"}),e.jsx("span",{className:`font-semibold ${!t&&j===0?"text-muted-foreground":""}`,children:t||j>0?`${j.toLocaleString()} qps`:"0 qps (N/A)"})]}),e.jsx(se,{value:t?Math.min(j/5e3*100,100):0,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Avg Query Time"}),e.jsx("span",{className:`font-semibold ${!t&&k===0?"text-muted-foreground":""}`,children:t||k>0?`${k}ms`:"0ms (N/A)"})]}),e.jsx(se,{value:t?Math.min(k/200*100,100):0,className:"h-2"})]})]})]})]})}),e.jsx(H,{value:"settings",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsxs(d,{children:[e.jsx(o,{children:"Connection Settings"}),e.jsx(T,{children:"ClickHouse server configuration"})]}),e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"host",children:["Host ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(v,{id:"host",value:E,onChange:s=>{m({host:s.target.value}),i.host&&g()},onBlur:g,placeholder:"localhost",className:R||i.host?"border-destructive":""}),R&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(b,{className:"h-3 w-3"}),e.jsx("span",{children:R})]}),!R&&i.host&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(b,{className:"h-3 w-3"}),e.jsx("span",{children:i.host})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"port",children:["Port ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(v,{id:"port",type:"number",value:S,onChange:s=>{m({port:parseInt(s.target.value)||8123}),i.port&&g()},onBlur:g,placeholder:"8123",className:w||C.hasConflict||i.port?"border-destructive":""}),w&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(b,{className:"h-3 w-3"}),e.jsx("span",{children:w})]}),!w&&i.port&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(b,{className:"h-3 w-3"}),e.jsx("span",{children:i.port})]}),!w&&!i.port&&C.hasConflict&&C.conflictingNode&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-amber-600 dark:text-amber-400",children:[e.jsx(b,{className:"h-3 w-3"}),e.jsxs("span",{children:['Конфликт порта: компонент "',C.conflictingNode.data.label||C.conflictingNode.type,'" уже использует ',E,":",S]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"database",children:["Database ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(v,{id:"database",value:_,onChange:s=>{m({database:s.target.value}),i.database&&g()},onBlur:g,placeholder:"default",className:i.database?"border-destructive":""}),i.database&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(b,{className:"h-3 w-3"}),e.jsx("span",{children:i.database})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"username",children:"Username"}),e.jsx(v,{id:"username",value:te,onChange:s=>m({username:s.target.value}),placeholder:"default"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"password",children:"Password"}),e.jsx(v,{id:"password",type:"password",value:le,onChange:s=>m({password:s.target.value}),placeholder:"password"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsx(u,{onClick:()=>{g()?V("Параметры подключения сохранены"):I("Пожалуйста, заполните все обязательные поля")},children:"Сохранить настройки"}),e.jsx(u,{variant:"outline",onClick:()=>{g()?V("Параметры подключения валидны"):I("Пожалуйста, заполните все обязательные поля")},children:"Проверить подключение"})]})]})]})})]})]})})}export{Pe as ClickHouseConfigAdvanced};
