import{u as ue,a as he,j as e,r as j,F as M,B as W,S as je,T as ve,b as ge,c as _,a5 as V,d as Ne,f as F,C as g,h as N,i as p,k as y,l as c,P as z,m as b,I as m,am as Q,o as B,L as o}from"./index-UHkh-5io.js";import{T as H}from"./textarea-B1p-7d_b.js";import{O as pe}from"./profiles-DcjZ134_.js";import{P as X}from"./pen-CBsTCqYo.js";function Se({componentId:C}){const{nodes:Y,updateNode:J,connections:Z}=ue(),{componentMetrics:ee}=he(),I=Y.find(s=>s.id===C);if(!I)return e.jsx("div",{className:"p-4 text-muted-foreground",children:"Component not found"});const K=Z.some(s=>s.target===C),U=pe.loki?.defaults||{},h=I.data.config||{},se=h.serverUrl||U.serverUrl||"http://loki:3100",k=ee.get(C)?.customMetrics||{},A=k.ingestion_lines_per_second||0,ae=k.average_query_latency||0,le=k.active_streams||0,E=k.total_storage_size||0,i=h.streams&&Array.isArray(h.streams)?h.streams:[],w=h.queries&&Array.isArray(h.queries)?h.queries:[];j.useMemo(()=>i.length>0?i.reduce((s,a)=>s+(a.entries||0),0):Math.floor(A*60),[i,A]);const te=j.useMemo(()=>E>0?E/(1024*1024*1024):i.length>0?i.reduce((s,a)=>s+(a.size||0),0):0,[i,E]),[re,$]=j.useState(null),[q,f]=j.useState(null),[t,x]=j.useState(null),[P,G]=j.useState(null),[ne,T]=j.useState(!1),[d,L]=j.useState({query:"",duration:0,results:0}),u=s=>{J(C,{data:{...I.data,config:{...h,...s}}})},ie=()=>{u({streams:[...i,{name:"new-stream",labels:{app:"new"},entries:0,size:0}]})},ce=s=>{u({streams:i.filter((a,l)=>l!==s)})},de=(s,a,l)=>{const r=[...i];r[s]={...r[s],[a]:l},u({streams:r})},R=(s,a,l)=>{const r=[...i],n=r[s],v={...n.labels,[a]:l};r[s]={...n,labels:v},u({streams:r})},oe=(s,a)=>{const l=[...i],r=l[s],n={...r.labels};delete n[a],l[s]={...r,labels:n},u({streams:l})},O=(s,a,l)=>{if(!a||!l)return;const r=i[s];if(r.labels[a]){if(r.labels[a]===l){x(null);return}R(s,a,l)}else R(s,a,l);x(null)},me=()=>{if(!d.query.trim())return;const s={id:`query-${Date.now()}`,query:d.query,duration:d.duration,results:d.results};u({queries:[...w,s]}),L({query:"",duration:0,results:0}),T(!1)},xe=s=>{u({queries:w.filter(a=>a.id!==s)})},D=(s,a,l)=>{const r=w.map(n=>n.id===s?{...n,[a]:l}:n);u({queries:r})};return e.jsx("div",{className:"h-full overflow-y-auto bg-background",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-500/10",children:e.jsx(M,{className:"h-6 w-6 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"Loki"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Log Aggregation System"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(W,{variant:"outline",className:"gap-2",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${K?"bg-green-500 animate-pulse":"bg-gray-400"}`}),K?"Running":"Idle"]})})]}),e.jsx(je,{}),e.jsxs(ve,{defaultValue:"streams",className:"w-full",children:[e.jsxs(ge,{className:"grid w-full grid-cols-3",children:[e.jsxs(_,{value:"streams",className:"gap-2",children:[e.jsx(M,{className:"h-4 w-4"}),"Log Streams"]}),e.jsxs(_,{value:"queries",className:"gap-2",children:[e.jsx(V,{className:"h-4 w-4"}),"Queries"]}),e.jsxs(_,{value:"settings",className:"gap-2",children:[e.jsx(Ne,{className:"h-4 w-4"}),"Settings"]})]}),e.jsx(F,{value:"streams",className:"space-y-4 mt-4",children:e.jsxs(g,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(p,{children:"Log Streams"}),e.jsx(y,{children:"Log stream configuration and labels"})]}),e.jsxs(c,{size:"sm",onClick:ie,variant:"outline",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Add Stream"]})]})}),e.jsx(b,{children:e.jsx("div",{className:"space-y-3",children:i.map((s,a)=>e.jsxs(g,{className:"border-border",children:[e.jsx(N,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:"p-2 rounded bg-primary/10",children:e.jsx(M,{className:"h-4 w-4 text-primary"})}),e.jsx("div",{className:"flex-1",children:re===a?e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{value:s.name,onChange:l=>de(a,"name",l.target.value),placeholder:"stream-name",className:"font-semibold"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(c,{size:"sm",variant:"outline",onClick:()=>$(null),children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"Done"]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"text-lg",children:s.name}),e.jsx(c,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:()=>$(a),children:e.jsx(X,{className:"h-3 w-3"})})]}),e.jsxs(y,{className:"text-xs mt-1",children:[s.entries?.toLocaleString()||0," entries • ",s.size?.toFixed(2)||0," GB",s.lastEntry&&` • Last: ${s.lastEntry}`]})]})})]}),e.jsx("div",{className:"flex gap-2",children:i.length>1&&e.jsx(c,{size:"icon",variant:"ghost",onClick:()=>ce(a),children:e.jsx(B,{className:"h-4 w-4"})})})]})}),e.jsx(b,{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(o,{className:"text-sm font-semibold",children:"Labels"}),e.jsxs(c,{size:"sm",variant:"outline",onClick:()=>{t&&t.streamIndex===a?x(null):x({streamIndex:a,key:"",value:""})},disabled:q?.streamIndex===a,children:[e.jsx(z,{className:"h-3 w-3 mr-1"}),t&&t.streamIndex===a?"Cancel":"Add Label"]})]}),e.jsxs("div",{className:"space-y-2",children:[Object.entries(s.labels).map(([l,r])=>e.jsx("div",{className:"flex items-center gap-2",children:q?.streamIndex===a&&q.labelKey===l?e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx(m,{value:l,placeholder:"label-key",className:"flex-1",disabled:!0}),e.jsx(m,{value:r,onChange:n=>R(a,l,n.target.value),placeholder:"label-value",className:"flex-1",onBlur:()=>f(null),onKeyDown:n=>{n.key==="Enter"&&f(null),n.key==="Escape"&&f(null)},autoFocus:!0}),e.jsx(c,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>{oe(a,l),f(null)},children:e.jsx(B,{className:"h-3 w-3"})}),e.jsx(c,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>f(null),children:e.jsx(Q,{className:"h-3 w-3"})})]}):e.jsxs(W,{variant:"outline",className:"text-xs cursor-pointer hover:bg-accent",onClick:()=>f({streamIndex:a,labelKey:l}),children:[l,"=",r]})},l)),t&&t.streamIndex===a&&(()=>{const l=i[a],r=l.labels[t.key]!==void 0,n=l.labels[t.key]===t.value,v=r&&n;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{value:t.key,onChange:S=>x({...t,key:S.target.value}),placeholder:"label-key",className:`flex-1 ${r?"border-yellow-500":""}`}),e.jsx(m,{value:t.value,onChange:S=>x({...t,value:S.target.value}),placeholder:"label-value",className:"flex-1",onKeyDown:S=>{S.key==="Enter"&&t.key&&t.value&&!v&&(O(a,t.key,t.value),x({streamIndex:a,key:"",value:""}))}}),e.jsx(c,{size:"sm",variant:"outline",onClick:()=>{t.key&&t.value&&!v&&(O(a,t.key,t.value),x({streamIndex:a,key:"",value:""}))},disabled:!t.key||!t.value||v,title:v?"Label with this key and value already exists":r?"Will update existing label value":"Add new label",children:e.jsx(z,{className:"h-3 w-3"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>x(null),children:e.jsx(Q,{className:"h-3 w-3"})})]}),r&&e.jsx("p",{className:"text-xs text-muted-foreground",children:v?`⚠️ Label "${t.key}" already exists with value "${t.value}"`:`ℹ️ Label "${t.key}" exists with value "${l.labels[t.key]}". Will be updated.`})]})})()]})]})})]},a))})})]})}),e.jsx(F,{value:"queries",className:"space-y-4 mt-4",children:e.jsxs(g,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(p,{children:"LogQL Queries"}),e.jsx(y,{children:"Query log streams with LogQL"})]}),e.jsxs(c,{size:"sm",onClick:()=>T(!0),variant:"outline",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Add Query"]})]})}),e.jsxs(b,{children:[ne&&e.jsxs(g,{className:"mb-4 border-primary",children:[e.jsx(N,{children:e.jsx(p,{className:"text-sm",children:"New Query"})}),e.jsxs(b,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"LogQL Query"}),e.jsx(H,{value:d.query,onChange:s=>L({...d,query:s.target.value}),placeholder:'{app="web"} |= "error"',className:"font-mono text-sm",rows:2})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Duration (ms)"}),e.jsx(m,{type:"number",value:d.duration,onChange:s=>L({...d,duration:parseInt(s.target.value)||0}),placeholder:"125"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Results"}),e.jsx(m,{type:"number",value:d.results,onChange:s=>L({...d,results:parseInt(s.target.value)||0}),placeholder:"1250"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{size:"sm",onClick:me,disabled:!d.query.trim(),children:"Add"}),e.jsx(c,{size:"sm",variant:"outline",onClick:()=>{T(!1),L({query:"",duration:0,results:0})},children:"Cancel"})]})]})]}),e.jsx("div",{className:"space-y-3",children:w.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(V,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No queries configured"}),e.jsx("p",{className:"text-xs mt-2",children:'Click "Add Query" to create a new LogQL query'})]}):w.map(s=>e.jsx(g,{className:"border-border",children:e.jsx(N,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex-1",children:P===s.id?e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{value:s.query,onChange:a=>D(s.id,"query",a.target.value),placeholder:'{app="web"} |= "error"',className:"font-mono text-sm",rows:2}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:"Duration (ms)"}),e.jsx(m,{type:"number",value:s.duration,onChange:a=>D(s.id,"duration",parseInt(a.target.value)||0)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:"Results"}),e.jsx(m,{type:"number",value:s.results,onChange:a=>D(s.id,"results",parseInt(a.target.value)||0)})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(c,{size:"sm",variant:"outline",onClick:()=>G(null),children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"Done"]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"text-sm font-mono",children:s.query}),e.jsx(c,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:()=>G(s.id),children:e.jsx(X,{className:"h-3 w-3"})})]}),e.jsxs(y,{className:"text-xs mt-1",children:[s.results," results • ",s.duration,"ms"]})]})}),!P&&e.jsx(c,{size:"icon",variant:"ghost",onClick:()=>xe(s.id),children:e.jsx(B,{className:"h-4 w-4"})})]})})},s.id))})]})]})}),e.jsxs(F,{value:"settings",className:"space-y-4 mt-4",children:[e.jsxs(g,{children:[e.jsxs(N,{children:[e.jsx(p,{children:"Loki Server"}),e.jsx(y,{children:"Server configuration"})]}),e.jsx(b,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"server-url",children:"Server URL"}),e.jsx(m,{id:"server-url",type:"url",value:se,onChange:s=>{const a=s.target.value;(a===""||a.startsWith("http://")||a.startsWith("https://"))&&u({serverUrl:a})},placeholder:U.serverUrl||"http://loki:3100",pattern:"https?://.*"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Server URL is used to identify this Loki instance when connecting from Grafana or other components. In simulation, logs are received automatically from connected components via data flow connections. The URL is also used by Grafana datasource configuration to find this Loki instance."})]})})]}),e.jsxs(g,{children:[e.jsxs(N,{children:[e.jsx(p,{children:"Real-time Metrics"}),e.jsx(y,{children:"Current metrics from simulation"})]}),e.jsx(b,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-sm font-semibold",children:"Ingestion Rate"}),e.jsx("div",{className:"text-2xl font-bold",children:Math.round(A).toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"lines/second"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-sm font-semibold",children:"Query Latency"}),e.jsx("div",{className:"text-2xl font-bold",children:Math.round(ae)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"ms (average)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-sm font-semibold",children:"Active Streams"}),e.jsx("div",{className:"text-2xl font-bold",children:le.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"streams"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-sm font-semibold",children:"Storage Size"}),e.jsx("div",{className:"text-2xl font-bold",children:te.toFixed(2)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"GB"})]})]})})]})]})]})]})})}export{Se as LokiConfigAdvanced};
