import{u as us,j as e,r as g,B as Se,S as js,C as D,e as J,f as z,h as M,k as I,L as i,I as b,l as R,i as d,T as gs,a as ps,b as X,F as fs,O as vs,Q as Ns,R as ys,d as Y,P as q,U as Be,m as T,t as B,n as Z,o as ee,p as se,q as ae,s as v,K as Fe}from"./index-CHKNZn98.js";import{T as te}from"./textarea-DXRXS1XW.js";import{u as bs}from"./usePortValidation-DOXRk3SG.js";import{a as w,s as o,b as Cs}from"./toast-C_NWfU7n.js";import{v as Ss}from"./requiredFields-BLgUUVkB.js";import{D as Re}from"./database-DQr0aayQ.js";function Ds({componentId:ue}){const{nodes:we,updateNode:qe}=us(),je=we.find(s=>s.id===ue);if(!je)return e.jsx("div",{className:"p-4 text-muted-foreground",children:"Component not found"});const p=je.data.config||{},ne=p.host||"localhost",re=p.port||27017,ge=p.database||"test",Te=p.username||"admin",Pe=p.password||"",Ve=p.authSource||"admin",$e=p.enableReplicaSet??!1,Le=p.replicaSetName||"rs0",O=p.replicaSetMembers||[{host:"localhost",port:27017,priority:1,votes:1},{host:"localhost",port:27018,priority:1,votes:1},{host:"localhost",port:27019,priority:0,votes:0,arbiterOnly:!0}],ke=p.enableSharding??!1,E=p.shardConfig||{shardKey:{_id:"hashed"},shards:["shard1","shard2"]},x=p.collections||[],pe=p.selectedDatabase||ge,S=p.selectedCollection||"";p.documents;const A=p.aggregationPipeline||[],[Ke,fe]=g.useState(!1),[ie,le]=g.useState(""),[ve,Ue]=g.useState(null),[He,ce]=g.useState(!1),[Qe,oe]=g.useState(null),[C,de]=g.useState(null),[me,P]=g.useState(""),[Ie,V]=g.useState("{}"),[Oe,L]=g.useState(!1),[Ee,K]=g.useState(!1),[Ae,U]=g.useState(!1),[We,Ne]=g.useState(!1),[_e,ye]=g.useState("{}"),[F,Ge]=g.useState("{}"),[ws,$s]=g.useState(!1),[he,Xe]=g.useState(""),[be,Ye]=g.useState([]),{portError:H,hostError:xe,portConflict:Q}=bs(we,ue,ne,re),[N,De]=g.useState({}),Ze=[{field:"host",label:"Host"},{field:"port",label:"Port",validator:s=>typeof s=="number"&&s>0&&s<=65535},{field:"database",label:"Database"}],_=()=>{const s=Ss({host:ne,port:re,database:ge},Ze);return De(s.errors),s.isValid},l=s=>{if(qe(ue,{data:{...je.data,config:{...p,...s}}}),Object.keys(s).some(a=>["host","port","database"].includes(a))){const a={...N};Object.keys(s).forEach(n=>{a[n]&&delete a[n]}),De(a)}},Je=()=>{if(!ie||ie.trim()===""){o("Имя коллекции не может быть пустым");return}const s=ie.trim();if(x.some(t=>t.name===s&&t.database===pe)){o(`Коллекция "${s}" уже существует в базе "${pe}"`);return}const n={name:s,database:pe,documentCount:0,size:0,indexes:[{name:"_id_",keys:{_id:1},unique:!0}]};l({collections:[...x,n]}),fe(!1),le(""),w(`Коллекция "${s}" успешно создана`)},es=s=>{l({collections:x.filter((a,n)=>n!==s)})},W=(s,a,n)=>{const t=[...x];t[s]={...t[s],[a]:n},l({collections:t})},ss=s=>{const a=x.findIndex(h=>h.name===s);if(a===-1){o(`Коллекция "${s}" не найдена`);return}if(!me||me.trim()===""){o("Имя индекса не может быть пустым");return}const n=me.trim(),t=x[a].indexes||[],r=C!==null;if((!r||C!==n)&&t.some(h=>h.name===n)){o(`Индекс с именем "${n}" уже существует`);return}let m;try{const h=JSON.parse(Ie);if(typeof h!="object"||Array.isArray(h)||Object.keys(h).length===0){o("Ключи индекса должны быть объектом с хотя бы одним полем");return}for(const[G,$]of Object.entries(h))if($!==1&&$!==-1&&$!=="text"&&$!=="2dsphere"&&$!=="hashed"){o(`Неверное значение для поля "${G}": должно быть 1, -1, "text", "2dsphere" или "hashed"`);return}m=h}catch(h){o(`Неверный формат JSON для ключей индекса: ${h instanceof Error?h.message:"Неизвестная ошибка"}`);return}const j={name:n,keys:m,unique:Oe,sparse:Ee,background:Ae},f=[...x];if(f[a].indexes||(f[a].indexes=[]),r){const h=f[a].indexes.findIndex(G=>G.name===C);if(h!==-1)f[a].indexes[h]=j,w(`Индекс "${j.name}" успешно обновлен`);else{o(`Индекс "${C}" не найден для обновления`);return}}else f[a].indexes=[...f[a].indexes,j],w(`Индекс "${j.name}" успешно создан`);l({collections:f}),ce(!1),oe(null),de(null),P(""),V("{}"),L(!1),K(!1),U(!1)},as=(s,a)=>{const n=x.find(r=>r.name===s);if(!n){o(`Коллекция "${s}" не найдена`);return}const t=n.indexes?.find(r=>r.name===a);if(!t){o(`Индекс "${a}" не найден`);return}oe(s),de(a),P(t.name),V(JSON.stringify(t.keys,null,2)),L(t.unique||!1),K(t.sparse||!1),U(t.background||!1),ce(!0)},ts=(s,a)=>{const n=x.findIndex(r=>r.name===s);if(n===-1)return;const t=[...x];t[n].indexes=t[n].indexes?.filter(r=>r.name!==a),l({collections:t}),w(`Индекс "${a}" удален`)},ns=()=>{if(!S){o("Выберите коллекцию для добавления документа");return}const s=x.findIndex(a=>a.name===S);if(s===-1){o(`Коллекция "${S}" не найдена`);return}try{const a=JSON.parse(_e),n={_id:a._id||`doc_${Date.now()}`,...a},t=x[s];if(t.validation&&t.validation.validationLevel!=="off"){const j=ls(n,t.validation.validator);if(!j.valid&&t.validation.validationAction==="error"){o(`Валидация не пройдена: ${j.error}`);return}}const r=[...x];r[s].documents||(r[s].documents=[]),r[s].documents=[...r[s].documents,n],r[s].documentCount=(r[s].documentCount||0)+1;const m=JSON.stringify(n).length;r[s].size=((r[s].size||0)*1024*1024+m)/(1024*1024),l({collections:r}),ye("{}"),Ne(!1),w(`Документ добавлен в коллекцию "${S}"`)}catch(a){o(`Неверный формат JSON: ${a instanceof Error?a.message:"Неизвестная ошибка"}`)}},rs=(s,a)=>{const n=x.findIndex(r=>r.name===s);if(n===-1)return;const t=[...x];if(t[n].documents){const r=t[n].documents.find(m=>m._id===a);if(r){const m=JSON.stringify(r).length;t[n].documents=t[n].documents.filter(j=>j._id!==a),t[n].documentCount=Math.max(0,(t[n].documentCount||0)-1),t[n].size=Math.max(0,((t[n].size||0)*1024*1024-m)/(1024*1024)),l({collections:t}),w("Документ удален")}}},is=()=>{if(!S){o("Выберите коллекцию для поиска");return}const s=x.find(a=>a.name===S);if(!s||!s.documents||s.documents.length===0){o("В коллекции нет документов");return}try{const a=F.trim()?JSON.parse(F):{},n=s.documents.filter(t=>{for(const[r,m]of Object.entries(a))if(t[r]!==m)return!1;return!0});n.length===0?Cs("Найдено документов: 0"):w(`Найдено документов: ${n.length}`)}catch(a){o(`Неверный формат фильтра JSON: ${a instanceof Error?a.message:"Неизвестная ошибка"}`)}},ls=(s,a)=>{if(!a||!a.$jsonSchema)return{valid:!0};const n=a.$jsonSchema;if(n.required&&Array.isArray(n.required)){for(const t of n.required)if(!(t in s)||s[t]===void 0||s[t]===null)return{valid:!1,error:`Required field "${t}" is missing`}}if(n.properties){for(const[t,r]of Object.entries(n.properties))if(t in s){const m=s[t],j=r;if(j.type){const f=j.type,h=Array.isArray(m)?"array":typeof m;if(f==="string"&&h!=="string")return{valid:!1,error:`Field "${t}" must be of type string`};if(f==="number"&&h!=="number")return{valid:!1,error:`Field "${t}" must be of type number`};if(f==="boolean"&&h!=="boolean")return{valid:!1,error:`Field "${t}" must be of type boolean`};if(f==="array"&&h!=="array")return{valid:!1,error:`Field "${t}" must be of type array`};if(f==="object"&&(h!=="object"||Array.isArray(m)))return{valid:!1,error:`Field "${t}" must be of type object`}}}}return{valid:!0}},cs=()=>{l({replicaSetMembers:[...O,{host:"localhost",port:27020,priority:1,votes:1}]})},os=s=>{l({replicaSetMembers:O.filter((a,n)=>n!==s)})},ds=()=>{l({shardConfig:{...E,shards:[...E.shards,`shard${E.shards.length+1}`]}})},ms=()=>{const s={stage:"$match",expression:"{}"};l({aggregationPipeline:[...A,s]})},hs=s=>{l({aggregationPipeline:A.filter((a,n)=>n!==s)})},ze=(s,a,n)=>{const t=[...A];t[s]={...t[s],[a]:n},l({aggregationPipeline:t})},xs=()=>{if(!he){o("Выберите коллекцию для агрегации");return}const s=x.find(a=>a.name===he);if(!s||!s.documents||s.documents.length===0){o("В коллекции нет документов для агрегации");return}if(A.length===0){o("Добавьте хотя бы одну стадию в pipeline");return}try{let a=[...s.documents];for(const n of A)try{const t=JSON.parse(n.expression||"{}");switch(n.stage){case"$match":a=a.filter(y=>{for(const[c,u]of Object.entries(t))if(y[c]!==u)return!1;return!0});break;case"$group":const r={},m=t._id;m&&(a.forEach(y=>{const c=typeof m=="string"?y[m]:JSON.stringify(m);r[c]||(r[c]={_id:c}),Object.entries(t).forEach(([u,k])=>{u!=="_id"&&typeof k=="object"&&(k.$sum?r[c][u]=(r[c][u]||0)+(y[k.$sum]||0):k.$avg?(r[c][`${u}_count`]||(r[c][`${u}_count`]=0),r[c][`${u}_sum`]||(r[c][`${u}_sum`]=0),r[c][`${u}_count`]++,r[c][`${u}_sum`]+=y[k.$avg]||0,r[c][u]=r[c][`${u}_sum`]/r[c][`${u}_count`]):k.$count&&(r[c][u]=(r[c][u]||0)+1))})}),a=Object.values(r));break;case"$project":a=a.map(y=>{const c={};return Object.entries(t).forEach(([u,k])=>{(k===1||k===!0)&&(c[u]=y[u])}),c});break;case"$sort":const j=Object.keys(t)[0],f=t[j]||1;a.sort((y,c)=>y[j]<c[j]?-f:y[j]>c[j]?f:0);break;case"$limit":const h=parseInt(t)||t.$limit||10;a=a.slice(0,h);break;case"$skip":const G=parseInt(t)||t.$skip||0;a=a.slice(G);break;case"$unwind":const $=t||"$unwind",Me=typeof $=="string"?$.replace("$",""):$,Ce=[];a.forEach(y=>{const c=y[Me];Array.isArray(c)?c.forEach(u=>{Ce.push({...y,[Me]:u})}):Ce.push(y)}),a=Ce;break}}catch(t){o(`Ошибка в стадии ${n.stage}: ${t instanceof Error?t.message:"Неверный формат JSON"}`);return}Ye(a),w(`Агрегация выполнена. Результатов: ${a.length}`)}catch(a){o(`Ошибка выполнения агрегации: ${a instanceof Error?a.message:"Неизвестная ошибка"}`)}};return e.jsx("div",{className:"h-full overflow-y-auto bg-background",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(Re,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"MongoDB"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Document database management"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{variant:"outline",children:"v7.0"}),e.jsxs(Se,{variant:"secondary",className:"gap-2",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-green-500 animate-pulse"}),"Connected"]})]})]}),e.jsx(js,{}),e.jsxs(D,{children:[e.jsxs(J,{children:[e.jsx(z,{children:"Connection Settings"}),e.jsx(M,{children:"Configure MongoDB connection parameters"})]}),e.jsxs(I,{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Host ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(b,{value:ne,onChange:s=>{l({host:s.target.value}),N.host&&_()},onBlur:_,className:xe||N.host?"border-destructive":""}),xe&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsx("span",{children:xe})]}),!xe&&N.host&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsx("span",{children:N.host})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Port ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(b,{type:"number",value:re,onChange:s=>{l({port:parseInt(s.target.value)||27017}),N.port&&_()},onBlur:_,className:H||Q.hasConflict||N.port?"border-destructive":""}),H&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsx("span",{children:H})]}),!H&&!N.port&&Q.hasConflict&&Q.conflictingNode&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-amber-600 dark:text-amber-400",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsxs("span",{children:['Конфликт порта: компонент "',Q.conflictingNode.data.label||Q.conflictingNode.type,'" уже использует ',ne,":",re]})]}),!H&&N.port&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsx("span",{children:N.port})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Database ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(b,{value:ge,onChange:s=>{l({database:s.target.value}),N.database&&_()},onBlur:_,className:N.database?"border-destructive":""}),N.database&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsx("span",{children:N.database})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Username"}),e.jsx(b,{value:Te,onChange:s=>l({username:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Password"}),e.jsx(b,{type:"password",value:Pe,onChange:s=>l({password:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Auth Source"}),e.jsx(b,{value:Ve,onChange:s=>l({authSource:s.target.value})})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsx(d,{onClick:()=>{_()?w("Параметры подключения сохранены"):o("Пожалуйста, заполните все обязательные поля")},children:"Сохранить настройки"}),e.jsx(d,{variant:"outline",onClick:()=>{_()?w("Параметры подключения валидны"):o("Пожалуйста, заполните все обязательные поля")},children:"Проверить подключение"})]})]})]}),e.jsxs(gs,{defaultValue:"collections",className:"w-full",children:[e.jsxs(ps,{className:"grid w-full grid-cols-5",children:[e.jsxs(X,{value:"collections",className:"gap-2",children:[e.jsx(fs,{className:"h-4 w-4"}),"Collections"]}),e.jsxs(X,{value:"documents",className:"gap-2",children:[e.jsx(Re,{className:"h-4 w-4"}),"Documents"]}),e.jsxs(X,{value:"aggregations",className:"gap-2",children:[e.jsx(vs,{className:"h-4 w-4"}),"Aggregations"]}),e.jsxs(X,{value:"replication",className:"gap-2",children:[e.jsx(Ns,{className:"h-4 w-4"}),"Replication"]}),e.jsxs(X,{value:"sharding",className:"gap-2",children:[e.jsx(ys,{className:"h-4 w-4"}),"Sharding"]})]}),e.jsx(Y,{value:"collections",className:"mt-4 space-y-4",children:e.jsxs(D,{children:[e.jsxs(J,{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(z,{children:"Collections"}),e.jsx(M,{children:"Manage database collections and indexes"})]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{fe(!0),le("")},children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Create Collection"]})]}),Ke&&e.jsx(I,{className:"border-b pb-4 mb-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Collection Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(b,{value:ie,onChange:s=>le(s.target.value),placeholder:"my_collection",onKeyDown:s=>{s.key==="Enter"&&Je()}})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{onClick:Je,children:"Create Collection"}),e.jsx(d,{variant:"outline",onClick:()=>{fe(!1),le("")},children:"Cancel"})]})]})}),e.jsx(I,{className:"space-y-3",children:x.map((s,a)=>e.jsxs("div",{className:"p-4 border border-border rounded-lg bg-card space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-semibold",children:s.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[s.documentCount||0," documents • ",s.size||0," MB"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>Ue(ve===a?null:a),children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),ve===a?"Hide":"Edit"]}),e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>es(a),children:e.jsx(T,{className:"h-4 w-4"})})]})]}),ve===a&&e.jsxs("div",{className:"space-y-4 pt-3 border-t",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{children:"Indexes"}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{oe(s.name),de(null),ce(!0),P(""),V("{}"),L(!1),K(!1),U(!1)},children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Add Index"]})]}),He&&Qe===s.name&&e.jsxs("div",{className:"p-4 border rounded-lg bg-muted/30 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold text-sm",children:C?"Edit Index":"Create Index"}),C&&e.jsxs(Se,{variant:"secondary",children:["Editing: ",C]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Index Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(b,{value:me,onChange:n=>P(n.target.value),placeholder:"my_index",className:"font-mono text-sm",disabled:C!==null&&C==="_id_"}),C==="_id_"&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Системный индекс _id_ нельзя переименовать"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Index Keys (JSON) ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(te,{className:"font-mono text-xs",rows:3,value:Ie,onChange:n=>V(n.target.value),placeholder:'{"field1": 1, "field2": -1}'}),e.jsx("p",{className:"text-xs text-muted-foreground",children:'Значения: 1 (ascending), -1 (descending), "text", "2dsphere", "hashed"'})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{checked:Oe,onCheckedChange:L}),e.jsx(i,{className:"text-sm",children:"Unique"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{checked:Ee,onCheckedChange:K}),e.jsx(i,{className:"text-sm",children:"Sparse"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{checked:Ae,onCheckedChange:U}),e.jsx(i,{className:"text-sm",children:"Background"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{size:"sm",onClick:()=>ss(s.name),children:C?"Save Changes":"Create Index"}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{ce(!1),oe(null),de(null),P(""),V("{}"),L(!1),K(!1),U(!1)},children:"Cancel"})]})]}),s.indexes&&s.indexes.length>0&&e.jsx("div",{className:"space-y-2",children:s.indexes.map((n,t)=>e.jsxs("div",{className:"p-2 border rounded bg-muted/50 flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1 flex-1",children:[e.jsx("div",{className:"font-mono text-sm",children:n.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[Object.entries(n.keys).map(([r,m])=>`${r}: ${m}`).join(", "),n.unique&&" • unique",n.sparse&&" • sparse",n.background&&" • background"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>as(s.name,n.name),title:"Edit index",children:e.jsx(Be,{className:"h-3 w-3"})}),e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>ts(s.name,n.name),title:"Delete index",disabled:n.name==="_id_",children:e.jsx(T,{className:"h-3 w-3"})})]})]},t))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{children:"Schema Validation"}),e.jsx(B,{checked:s.validation!==void 0&&s.validation!==null,onCheckedChange:n=>{n?W(a,"validation",{validator:{},validationLevel:"strict",validationAction:"error"}):W(a,"validation",void 0)}})]}),s.validation&&e.jsxs("div",{className:"space-y-3 p-3 border rounded-lg bg-muted/30",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Validation Schema (JSON) ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(te,{className:"font-mono text-xs",rows:4,value:JSON.stringify(s.validation.validator,null,2),onChange:n=>{try{const t=JSON.parse(n.target.value);W(a,"validation",{...s.validation,validator:t})}catch(t){o(`Неверный формат JSON: ${t instanceof Error?t.message:"Неизвестная ошибка"}`)}},placeholder:'{"$jsonSchema": {"required": ["name", "email"], "properties": {"name": {"type": "string"}, "email": {"type": "string"}}}}'}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Используйте MongoDB JSON Schema для валидации документов"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Validation Level"}),e.jsxs(Z,{value:s.validation.validationLevel||"strict",onValueChange:n=>{W(a,"validation",{...s.validation,validationLevel:n})},children:[e.jsx(ee,{children:e.jsx(se,{})}),e.jsxs(ae,{children:[e.jsx(v,{value:"off",children:"Off"}),e.jsx(v,{value:"moderate",children:"Moderate"}),e.jsx(v,{value:"strict",children:"Strict"})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.validation.validationLevel==="off"&&"Валидация отключена",s.validation.validationLevel==="moderate"&&"Валидация только для новых и измененных документов",s.validation.validationLevel==="strict"&&"Валидация для всех документов"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Validation Action"}),e.jsxs(Z,{value:s.validation.validationAction||"error",onValueChange:n=>{W(a,"validation",{...s.validation,validationAction:n})},children:[e.jsx(ee,{children:e.jsx(se,{})}),e.jsxs(ae,{children:[e.jsx(v,{value:"error",children:"Error (Reject)"}),e.jsx(v,{value:"warn",children:"Warn (Log only)"})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.validation.validationAction==="error"&&"Отклонять невалидные документы",s.validation.validationAction==="warn"&&"Только предупреждать о невалидных документах"]})]})]})]})]})]})]},a))})]})}),e.jsx(Y,{value:"documents",className:"mt-4 space-y-4",children:e.jsxs(D,{children:[e.jsxs(J,{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(z,{children:"Documents"}),e.jsx(M,{children:"View and manage collection documents"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Z,{value:S,onValueChange:s=>l({selectedCollection:s}),children:[e.jsx(ee,{className:"w-48",children:e.jsx(se,{placeholder:"Select collection"})}),e.jsx(ae,{children:x.map((s,a)=>e.jsx(v,{value:s.name,children:s.name},a))})]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>Ne(!0),children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Insert Document"]})]})]}),We&&e.jsx(I,{className:"border-b pb-4 mb-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Document (JSON)"}),e.jsx(te,{className:"font-mono text-sm",rows:6,value:_e,onChange:s=>ye(s.target.value),placeholder:'{"name": "John", "email": "john@example.com"}'})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{onClick:ns,children:"Insert Document"}),e.jsx(d,{variant:"outline",onClick:()=>{Ne(!1),ye("{}")},children:"Cancel"})]})]})}),e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Query Filter (JSON)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{className:"font-mono text-sm",value:F,onChange:s=>Ge(s.target.value),placeholder:'{"status": "active"}'}),e.jsxs(d,{variant:"outline",size:"sm",onClick:is,children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Find"]})]})]}),e.jsx("div",{className:"space-y-2",children:S?(()=>{const a=x.find(t=>t.name===S)?.documents||[];let n=a;if(F.trim())try{const t=JSON.parse(F);n=a.filter(r=>{for(const[m,j]of Object.entries(t))if(r[m]!==j)return!1;return!0})}catch{}return n.length>0?n.map((t,r)=>e.jsxs("div",{className:"p-3 border rounded bg-muted/50 font-mono text-xs flex items-start justify-between",children:[e.jsx("pre",{className:"flex-1",children:JSON.stringify(t,null,2)}),e.jsx(d,{variant:"ghost",size:"icon",className:"ml-2 h-6 w-6",onClick:()=>rs(S,t._id),children:e.jsx(T,{className:"h-3 w-3"})})]},t._id||r)):e.jsx("div",{className:"text-center text-muted-foreground py-8",children:F.trim()?"No documents match the filter":"No documents in this collection. Insert a document to get started."})})():e.jsx("div",{className:"text-center text-muted-foreground py-8",children:"Select a collection to view documents"})})]})]})}),e.jsxs(Y,{value:"aggregations",className:"mt-4 space-y-4",children:[e.jsxs(D,{children:[e.jsxs(J,{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(z,{children:"Aggregation Pipeline"}),e.jsx(M,{children:"Build MongoDB aggregation pipelines"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Z,{value:he,onValueChange:Xe,children:[e.jsx(ee,{className:"w-48",children:e.jsx(se,{placeholder:"Select collection"})}),e.jsx(ae,{children:x.map((s,a)=>e.jsx(v,{value:s.name,children:s.name},a))})]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:ms,children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Add Stage"]}),e.jsxs(d,{size:"sm",onClick:xs,disabled:!he||A.length===0,children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Execute"]})]})]}),e.jsxs(I,{className:"space-y-3",children:[A.map((s,a)=>e.jsxs("div",{className:"p-4 border border-border rounded-lg bg-card space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Z,{value:s.stage,onValueChange:n=>ze(a,"stage",n),children:[e.jsx(ee,{className:"w-48",children:e.jsx(se,{})}),e.jsxs(ae,{children:[e.jsx(v,{value:"$match",children:"$match"}),e.jsx(v,{value:"$group",children:"$group"}),e.jsx(v,{value:"$project",children:"$project"}),e.jsx(v,{value:"$sort",children:"$sort"}),e.jsx(v,{value:"$limit",children:"$limit"}),e.jsx(v,{value:"$skip",children:"$skip"}),e.jsx(v,{value:"$unwind",children:"$unwind"}),e.jsx(v,{value:"$lookup",children:"$lookup"})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Stage Type"})]}),e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>hs(a),children:e.jsx(T,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Expression (JSON)"}),e.jsx(te,{className:"font-mono text-xs",rows:3,value:s.expression,onChange:n=>ze(a,"expression",n.target.value),placeholder:'{"status": "active"}'})]})]},a)),A.length===0&&e.jsx("div",{className:"text-center text-muted-foreground py-8",children:"No aggregation stages. Add a stage to build your pipeline."})]})]}),be.length>0&&e.jsxs(D,{children:[e.jsxs(J,{children:[e.jsx(z,{children:"Aggregation Results"}),e.jsxs(M,{children:[be.length," document(s) returned"]})]}),e.jsx(I,{className:"space-y-2 max-h-96 overflow-y-auto",children:be.map((s,a)=>e.jsx("div",{className:"p-3 border rounded bg-muted/50 font-mono text-xs",children:e.jsx("pre",{children:JSON.stringify(s,null,2)})},a))})]})]}),e.jsx(Y,{value:"replication",className:"mt-4 space-y-4",children:e.jsxs(D,{children:[e.jsxs(J,{children:[e.jsx(z,{children:"Replica Set Configuration"}),e.jsx(M,{children:"Configure MongoDB replica set members"})]}),e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{children:"Enable Replica Set"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Enable MongoDB replica set for high availability"})]}),e.jsx(B,{checked:$e,onCheckedChange:s=>l({enableReplicaSet:s})})]}),$e&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Replica Set Name"}),e.jsx(b,{value:Le,onChange:s=>l({replicaSetName:s.target.value})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{children:"Replica Set Members"}),e.jsxs(d,{variant:"outline",size:"sm",onClick:cs,children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Add Member"]})]}),O.map((s,a)=>e.jsxs("div",{className:"p-4 border border-border rounded-lg bg-card space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 flex-1",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Host"}),e.jsx(b,{value:s.host,onChange:n=>{const t=[...O];t[a]={...t[a],host:n.target.value},l({replicaSetMembers:t})}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Port"}),e.jsx(b,{type:"number",value:s.port,onChange:n=>{const t=[...O];t[a]={...t[a],port:parseInt(n.target.value)||27017},l({replicaSetMembers:t})}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Priority"}),e.jsx(b,{type:"number",value:s.priority||1,onChange:n=>{const t=[...O];t[a]={...t[a],priority:parseInt(n.target.value)||1},l({replicaSetMembers:t})}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Votes"}),e.jsx(b,{type:"number",value:s.votes||1,onChange:n=>{const t=[...O];t[a]={...t[a],votes:parseInt(n.target.value)||1},l({replicaSetMembers:t})}})]})]}),e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>os(a),children:e.jsx(T,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{checked:s.arbiterOnly||!1,onCheckedChange:n=>{const t=[...O];t[a]={...t[a],arbiterOnly:n},l({replicaSetMembers:t})}}),e.jsx(i,{children:"Arbiter Only"})]})]},a))]})]})]})]})}),e.jsx(Y,{value:"sharding",className:"mt-4 space-y-4",children:e.jsxs(D,{children:[e.jsxs(J,{children:[e.jsx(z,{children:"Sharding Configuration"}),e.jsx(M,{children:"Configure MongoDB sharding for horizontal scaling"})]}),e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{children:"Enable Sharding"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Enable sharding for distributed data storage"})]}),e.jsx(B,{checked:ke,onCheckedChange:s=>l({enableSharding:s})})]}),ke&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Shard Key (JSON)"}),e.jsx(te,{className:"font-mono text-xs",rows:3,value:JSON.stringify(E.shardKey,null,2),onChange:s=>{try{const a=JSON.parse(s.target.value);l({shardConfig:{...E,shardKey:a}})}catch(a){o(`Неверный формат JSON: ${a instanceof Error?a.message:"Неизвестная ошибка"}`)}},placeholder:'{"_id": "hashed"}'})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{children:"Shards"}),e.jsxs(d,{variant:"outline",size:"sm",onClick:ds,children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Add Shard"]})]}),e.jsx("div",{className:"space-y-2",children:E.shards.map((s,a)=>e.jsxs("div",{className:"p-3 border rounded bg-muted/50 flex items-center justify-between",children:[e.jsx("span",{className:"font-mono",children:s}),e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>{l({shardConfig:{...E,shards:E.shards.filter((n,t)=>t!==a)}})},children:e.jsx(T,{className:"h-3 w-3"})})]},a))})]})]})]})]})})]})]})})}export{Ds as MongoDBConfigAdvanced};
