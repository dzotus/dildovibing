import{u as Os,a as zs,j as e,r as m,B as Xe,S as Ds,C as I,h as M,i as J,k as B,m as E,L as i,I as j,n as q,l as c,T as _s,b as Ms,c as Y,F as Js,ag as Bs,ad as Fs,a3 as Rs,f as ee,P as T,ah as Me,o as P,x as F,q as se,s as ae,t as te,v as ne,w as y,a4 as Ye,e as qs}from"./index-Car91T5O.js";import{T as re}from"./textarea-Cgvn3GTT.js";import{u as Ts}from"./usePortValidation-DoJkq6FT.js";import{a as S,s as o,b as Ps}from"./toast-DPBPUnYB.js";import{v as Vs}from"./requiredFields-BLgUUVkB.js";import{D as es}from"./database-0M_zUzYF.js";function Ys({componentId:O}){const{nodes:Je,updateNode:ss,connections:Be}=Os(),{isRunning:be,getComponentMetrics:as}=zs(),V=Je.find(s=>s.id===O);if(!V)return e.jsx("div",{className:"p-4 text-muted-foreground",children:"Component not found"});(be?as(O):void 0)?.customMetrics;const[Ce,Se]=m.useState("disconnected");m.useEffect(()=>{if(!V){Se("disconnected");return}const s=()=>{const n=Be.some(r=>r.source===O||r.target===O),t=be?qs.getMongoDBEmulationEngine(O):null;Se(n||t?"connected":"disconnected")};s();const a=setInterval(s,500);return()=>clearInterval(a)},[V,O,Be,be]);const v=V.data.config||{},ie=v.host||"localhost",le=v.port||27017,we=v.database||"test",ts=v.username||"admin",ns=v.password||"",rs=v.authSource||"admin",Fe=v.enableReplicaSet??!1,is=v.replicaSetName||"rs0",z=v.replicaSetMembers||[{host:"localhost",port:27017,priority:1,votes:1},{host:"localhost",port:27018,priority:1,votes:1},{host:"localhost",port:27019,priority:0,votes:0,arbiterOnly:!0}],Re=v.enableSharding??!1;m.useEffect(()=>{const s=v.shardConfig;if(s&&Array.isArray(s.shards)&&s.shards.length>0&&typeof s.shards[0]=="string"){const a={...s,shards:s.shards.map((n,t)=>({name:n,hosts:[`localhost:${27017+t}`],zones:[],weight:1,tags:{}}))};l({shardConfig:a})}},[]);let d=v.shardConfig;d?Array.isArray(d.shards)?d.shards.length>0&&typeof d.shards[0]=="string"?d={...d,shards:d.shards.map((s,a)=>({name:s,hosts:[`localhost:${27017+a}`],zones:[],weight:1,tags:{}}))}:d={...d,shards:d.shards.map(s=>({name:s.name||`shard${d.shards.indexOf(s)+1}`,hosts:Array.isArray(s.hosts)?s.hosts:["localhost:27017"],zones:Array.isArray(s.zones)?s.zones:[],weight:typeof s.weight=="number"?s.weight:1,tags:typeof s.tags=="object"?s.tags:{}}))}:d={...d,shards:[]}:d={shardKey:{_id:"hashed"},shards:[{name:"shard1",hosts:["localhost:27017"],zones:[],weight:1},{name:"shard2",hosts:["localhost:27018"],zones:[],weight:1}]};const g=v.collections||[],$e=v.selectedDatabase||we,$=v.selectedCollection||"";v.documents;const D=v.aggregationPipeline||[],[ls,ke]=m.useState(!1),[ce,oe]=m.useState(""),[Ae,cs]=m.useState(null),[os,de]=m.useState(!1),[ds,he]=m.useState(null),[w,me]=m.useState(null),[xe,L]=m.useState(""),[qe,H]=m.useState("{}"),[Te,K]=m.useState(!1),[Pe,W]=m.useState(!1),[Ve,U]=m.useState(!1),[hs,Ie]=m.useState(!1),[Le,Ee]=m.useState("{}"),[R,ms]=m.useState("{}"),[Hs,Ks]=m.useState(!1),[ue,xs]=m.useState(""),[Oe,us]=m.useState([]),{portError:Z,hostError:je,portConflict:Q}=Ts(Je,O,ie,le),[b,He]=m.useState({}),js=[{field:"host",label:"Host"},{field:"port",label:"Port",validator:s=>typeof s=="number"&&s>0&&s<=65535},{field:"database",label:"Database"}],_=()=>{const s=Vs({host:ie,port:le,database:we},js);return He(s.errors),s.isValid},l=s=>{if(ss(O,{data:{...V.data,config:{...v,...s}}}),Object.keys(s).some(a=>["host","port","database"].includes(a))){const a={...b};Object.keys(s).forEach(n=>{a[n]&&delete a[n]}),He(a)}},Ke=()=>{if(!ce||ce.trim()===""){o("Имя коллекции не может быть пустым");return}const s=ce.trim();if(g.some(t=>t.name===s&&t.database===$e)){o(`Коллекция "${s}" уже существует в базе "${$e}"`);return}const n={name:s,database:$e,documentCount:0,size:0,indexes:[{name:"_id_",keys:{_id:1},unique:!0}]};l({collections:[...g,n]}),ke(!1),oe(""),S(`Коллекция "${s}" успешно создана`)},gs=s=>{l({collections:g.filter((a,n)=>n!==s)})},G=(s,a,n)=>{const t=[...g];t[s]={...t[s],[a]:n},l({collections:t})},ps=s=>{const a=g.findIndex(u=>u.name===s);if(a===-1){o(`Коллекция "${s}" не найдена`);return}if(!xe||xe.trim()===""){o("Имя индекса не может быть пустым");return}const n=xe.trim(),t=g[a].indexes||[],r=w!==null;if((!r||w!==n)&&t.some(u=>u.name===n)){o(`Индекс с именем "${n}" уже существует`);return}let x;try{const u=JSON.parse(qe);if(typeof u!="object"||Array.isArray(u)||Object.keys(u).length===0){o("Ключи индекса должны быть объектом с хотя бы одним полем");return}for(const[X,k]of Object.entries(u))if(k!==1&&k!==-1&&k!=="text"&&k!=="2dsphere"&&k!=="hashed"){o(`Неверное значение для поля "${X}": должно быть 1, -1, "text", "2dsphere" или "hashed"`);return}x=u}catch(u){o(`Неверный формат JSON для ключей индекса: ${u instanceof Error?u.message:"Неизвестная ошибка"}`);return}const f={name:n,keys:x,unique:Te,sparse:Pe,background:Ve},N=[...g];if(N[a].indexes||(N[a].indexes=[]),r){const u=N[a].indexes.findIndex(X=>X.name===w);if(u!==-1)N[a].indexes[u]=f,S(`Индекс "${f.name}" успешно обновлен`);else{o(`Индекс "${w}" не найден для обновления`);return}}else N[a].indexes=[...N[a].indexes,f],S(`Индекс "${f.name}" успешно создан`);l({collections:N}),de(!1),he(null),me(null),L(""),H("{}"),K(!1),W(!1),U(!1)},fs=(s,a)=>{const n=g.find(r=>r.name===s);if(!n){o(`Коллекция "${s}" не найдена`);return}const t=n.indexes?.find(r=>r.name===a);if(!t){o(`Индекс "${a}" не найден`);return}he(s),me(a),L(t.name),H(JSON.stringify(t.keys,null,2)),K(t.unique||!1),W(t.sparse||!1),U(t.background||!1),de(!0)},vs=(s,a)=>{const n=g.findIndex(r=>r.name===s);if(n===-1)return;const t=[...g];t[n].indexes=t[n].indexes?.filter(r=>r.name!==a),l({collections:t}),S(`Индекс "${a}" удален`)},Ns=()=>{if(!$){o("Выберите коллекцию для добавления документа");return}const s=g.findIndex(a=>a.name===$);if(s===-1){o(`Коллекция "${$}" не найдена`);return}try{const a=JSON.parse(Le),n={_id:a._id||`doc_${Date.now()}`,...a},t=g[s];if(t.validation&&t.validation.validationLevel!=="off"){const f=Cs(n,t.validation.validator);if(!f.valid&&t.validation.validationAction==="error"){o(`Валидация не пройдена: ${f.error}`);return}}const r=[...g];r[s].documents||(r[s].documents=[]),r[s].documents=[...r[s].documents,n],r[s].documentCount=(r[s].documentCount||0)+1;const x=JSON.stringify(n).length;r[s].size=((r[s].size||0)*1024*1024+x)/(1024*1024),l({collections:r}),Ee("{}"),Ie(!1),S(`Документ добавлен в коллекцию "${$}"`)}catch(a){o(`Неверный формат JSON: ${a instanceof Error?a.message:"Неизвестная ошибка"}`)}},ys=(s,a)=>{const n=g.findIndex(r=>r.name===s);if(n===-1)return;const t=[...g];if(t[n].documents){const r=t[n].documents.find(x=>x._id===a);if(r){const x=JSON.stringify(r).length;t[n].documents=t[n].documents.filter(f=>f._id!==a),t[n].documentCount=Math.max(0,(t[n].documentCount||0)-1),t[n].size=Math.max(0,((t[n].size||0)*1024*1024-x)/(1024*1024)),l({collections:t}),S("Документ удален")}}},bs=()=>{if(!$){o("Выберите коллекцию для поиска");return}const s=g.find(a=>a.name===$);if(!s||!s.documents||s.documents.length===0){o("В коллекции нет документов");return}try{const a=R.trim()?JSON.parse(R):{},n=s.documents.filter(t=>{for(const[r,x]of Object.entries(a))if(t[r]!==x)return!1;return!0});n.length===0?Ps("Найдено документов: 0"):S(`Найдено документов: ${n.length}`)}catch(a){o(`Неверный формат фильтра JSON: ${a instanceof Error?a.message:"Неизвестная ошибка"}`)}},Cs=(s,a)=>{if(!a||!a.$jsonSchema)return{valid:!0};const n=a.$jsonSchema;if(n.required&&Array.isArray(n.required)){for(const t of n.required)if(!(t in s)||s[t]===void 0||s[t]===null)return{valid:!1,error:`Required field "${t}" is missing`}}if(n.properties){for(const[t,r]of Object.entries(n.properties))if(t in s){const x=s[t],f=r;if(f.type){const N=f.type,u=Array.isArray(x)?"array":typeof x;if(N==="string"&&u!=="string")return{valid:!1,error:`Field "${t}" must be of type string`};if(N==="number"&&u!=="number")return{valid:!1,error:`Field "${t}" must be of type number`};if(N==="boolean"&&u!=="boolean")return{valid:!1,error:`Field "${t}" must be of type boolean`};if(N==="array"&&u!=="array")return{valid:!1,error:`Field "${t}" must be of type array`};if(N==="object"&&(u!=="object"||Array.isArray(x)))return{valid:!1,error:`Field "${t}" must be of type object`}}}}return{valid:!0}},Ss=()=>{l({replicaSetMembers:[...z,{host:"localhost",port:27020,priority:1,votes:1}]})},ws=s=>{l({replicaSetMembers:z.filter((a,n)=>n!==s)})},[We,ge]=m.useState(null),[Ue,pe]=m.useState(""),[ze,fe]=m.useState(""),[De,ve]=m.useState(""),[Ze,Ne]=m.useState(1),$s=()=>{const s=Ue.trim()||`shard${d.shards.length+1}`;if(d.shards.some(r=>r.name===s)){o(`Шард с именем "${s}" уже существует`);return}const a=ze.trim()?ze.split(",").map(r=>r.trim()).filter(r=>r):[`localhost:${27017+d.shards.length}`],n=De.trim()?De.split(",").map(r=>r.trim()).filter(r=>r):[],t={name:s,hosts:a,zones:n,weight:Ze||1,tags:{}};l({shardConfig:{...d,shards:[...d.shards,t]}}),pe(""),fe(""),ve(""),Ne(1),S(`Шард "${s}" успешно добавлен`)},ye=(s,a,n)=>{const t=[...d.shards];t[s]={...t[s],[a]:n},l({shardConfig:{...d,shards:t}})},ks=s=>{const a=d.shards[s].name;l({shardConfig:{...d,shards:d.shards.filter((n,t)=>t!==s)}}),S(`Шард "${a}" удален`)},As=()=>{const s={stage:"$match",expression:"{}"};l({aggregationPipeline:[...D,s]})},Is=s=>{l({aggregationPipeline:D.filter((a,n)=>n!==s)})},Qe=(s,a,n)=>{const t=[...D];t[s]={...t[s],[a]:n},l({aggregationPipeline:t})},Es=()=>{if(!ue){o("Выберите коллекцию для агрегации");return}const s=g.find(a=>a.name===ue);if(!s||!s.documents||s.documents.length===0){o("В коллекции нет документов для агрегации");return}if(D.length===0){o("Добавьте хотя бы одну стадию в pipeline");return}try{let a=[...s.documents];for(const n of D)try{const t=JSON.parse(n.expression||"{}");switch(n.stage){case"$match":a=a.filter(C=>{for(const[h,p]of Object.entries(t))if(C[h]!==p)return!1;return!0});break;case"$group":const r={},x=t._id;x&&(a.forEach(C=>{const h=typeof x=="string"?C[x]:JSON.stringify(x);r[h]||(r[h]={_id:h}),Object.entries(t).forEach(([p,A])=>{p!=="_id"&&typeof A=="object"&&(A.$sum?r[h][p]=(r[h][p]||0)+(C[A.$sum]||0):A.$avg?(r[h][`${p}_count`]||(r[h][`${p}_count`]=0),r[h][`${p}_sum`]||(r[h][`${p}_sum`]=0),r[h][`${p}_count`]++,r[h][`${p}_sum`]+=C[A.$avg]||0,r[h][p]=r[h][`${p}_sum`]/r[h][`${p}_count`]):A.$count&&(r[h][p]=(r[h][p]||0)+1))})}),a=Object.values(r));break;case"$project":a=a.map(C=>{const h={};return Object.entries(t).forEach(([p,A])=>{(A===1||A===!0)&&(h[p]=C[p])}),h});break;case"$sort":const f=Object.keys(t)[0],N=t[f]||1;a.sort((C,h)=>C[f]<h[f]?-N:C[f]>h[f]?N:0);break;case"$limit":const u=parseInt(t)||t.$limit||10;a=a.slice(0,u);break;case"$skip":const X=parseInt(t)||t.$skip||0;a=a.slice(X);break;case"$unwind":const k=t||"$unwind",Ge=typeof k=="string"?k.replace("$",""):k,_e=[];a.forEach(C=>{const h=C[Ge];Array.isArray(h)?h.forEach(p=>{_e.push({...C,[Ge]:p})}):_e.push(C)}),a=_e;break}}catch(t){o(`Ошибка в стадии ${n.stage}: ${t instanceof Error?t.message:"Неверный формат JSON"}`);return}us(a),S(`Агрегация выполнена. Результатов: ${a.length}`)}catch(a){o(`Ошибка выполнения агрегации: ${a instanceof Error?a.message:"Неизвестная ошибка"}`)}};return e.jsx("div",{className:"h-full overflow-y-auto bg-background",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(es,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"MongoDB"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Document database management"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(Xe,{variant:Ce==="connected"?"secondary":"outline",className:"gap-2",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${Ce==="connected"?"bg-green-500 animate-pulse":"bg-gray-400"}`}),Ce==="connected"?"Connected":"Disconnected"]})})]}),e.jsx(Ds,{}),e.jsxs(I,{children:[e.jsxs(M,{children:[e.jsx(J,{children:"Connection Settings"}),e.jsx(B,{children:"Configure MongoDB connection parameters"})]}),e.jsxs(E,{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Host ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(j,{value:ie,onChange:s=>{l({host:s.target.value}),b.host&&_()},onBlur:_,className:je||b.host?"border-destructive":""}),je&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsx("span",{children:je})]}),!je&&b.host&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsx("span",{children:b.host})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Port ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(j,{type:"number",value:le,onChange:s=>{l({port:parseInt(s.target.value)||27017}),b.port&&_()},onBlur:_,className:Z||Q.hasConflict||b.port?"border-destructive":""}),Z&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsx("span",{children:Z})]}),!Z&&!b.port&&Q.hasConflict&&Q.conflictingNode&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-amber-600 dark:text-amber-400",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsxs("span",{children:['Конфликт порта: компонент "',Q.conflictingNode.data.label||Q.conflictingNode.type,'" уже использует ',ie,":",le]})]}),!Z&&b.port&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsx("span",{children:b.port})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Database ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(j,{value:we,onChange:s=>{l({database:s.target.value}),b.database&&_()},onBlur:_,className:b.database?"border-destructive":""}),b.database&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsx("span",{children:b.database})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Username"}),e.jsx(j,{value:ts,onChange:s=>l({username:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Password"}),e.jsx(j,{type:"password",value:ns,onChange:s=>l({password:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Auth Source"}),e.jsx(j,{value:rs,onChange:s=>l({authSource:s.target.value})})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsx(c,{onClick:()=>{_()?S("Параметры подключения сохранены"):o("Пожалуйста, заполните все обязательные поля")},children:"Сохранить настройки"}),e.jsx(c,{variant:"outline",onClick:()=>{_()?S("Параметры подключения валидны"):o("Пожалуйста, заполните все обязательные поля")},children:"Проверить подключение"})]})]})]}),e.jsxs(_s,{defaultValue:"collections",className:"w-full",children:[e.jsx("div",{className:"overflow-x-auto -mx-6 px-6 pb-2",children:e.jsxs(Ms,{className:"inline-flex w-auto min-w-full sm:flex-wrap sm:min-w-0 gap-1 h-auto py-1",children:[e.jsxs(Y,{value:"collections",className:"whitespace-nowrap flex-shrink-0 gap-2",children:[e.jsx(Js,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Collections"}),e.jsx("span",{className:"sm:hidden",children:"Coll"})]}),e.jsxs(Y,{value:"documents",className:"whitespace-nowrap flex-shrink-0 gap-2",children:[e.jsx(es,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Documents"}),e.jsx("span",{className:"sm:hidden",children:"Docs"})]}),e.jsxs(Y,{value:"aggregations",className:"whitespace-nowrap flex-shrink-0 gap-2",children:[e.jsx(Bs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Aggregations"}),e.jsx("span",{className:"sm:hidden",children:"Agg"})]}),e.jsxs(Y,{value:"replication",className:"whitespace-nowrap flex-shrink-0 gap-2",children:[e.jsx(Fs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Replication"}),e.jsx("span",{className:"sm:hidden",children:"Repl"})]}),e.jsxs(Y,{value:"sharding",className:"whitespace-nowrap flex-shrink-0 gap-2",children:[e.jsx(Rs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Sharding"}),e.jsx("span",{className:"sm:hidden",children:"Shard"})]})]})}),e.jsx(ee,{value:"collections",className:"mt-4 space-y-4",children:e.jsxs(I,{children:[e.jsxs(M,{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(J,{children:"Collections"}),e.jsx(B,{children:"Manage database collections and indexes"})]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>{ke(!0),oe("")},children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Create Collection"]})]}),ls&&e.jsx(E,{className:"border-b pb-4 mb-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Collection Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(j,{value:ce,onChange:s=>oe(s.target.value),placeholder:"my_collection",onKeyDown:s=>{s.key==="Enter"&&Ke()}})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{onClick:Ke,children:"Create Collection"}),e.jsx(c,{variant:"outline",onClick:()=>{ke(!1),oe("")},children:"Cancel"})]})]})}),e.jsx(E,{className:"space-y-3",children:g.map((s,a)=>e.jsxs("div",{className:"p-4 border border-border rounded-lg bg-card space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-semibold",children:s.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[s.documentCount||0," documents • ",s.size||0," MB"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(c,{variant:"ghost",size:"sm",onClick:()=>cs(Ae===a?null:a),children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),Ae===a?"Hide":"Edit"]}),e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>gs(a),children:e.jsx(P,{className:"h-4 w-4"})})]})]}),Ae===a&&e.jsxs("div",{className:"space-y-4 pt-3 border-t",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{children:"Indexes"}),e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>{he(s.name),me(null),de(!0),L(""),H("{}"),K(!1),W(!1),U(!1)},children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Add Index"]})]}),os&&ds===s.name&&e.jsxs("div",{className:"p-4 border rounded-lg bg-muted/30 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold text-sm",children:w?"Edit Index":"Create Index"}),w&&e.jsxs(Xe,{variant:"secondary",children:["Editing: ",w]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Index Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(j,{value:xe,onChange:n=>L(n.target.value),placeholder:"my_index",className:"font-mono text-sm",disabled:w!==null&&w==="_id_"}),w==="_id_"&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Системный индекс _id_ нельзя переименовать"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Index Keys (JSON) ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(re,{className:"font-mono text-xs",rows:3,value:qe,onChange:n=>H(n.target.value),placeholder:'{"field1": 1, "field2": -1}'}),e.jsx("p",{className:"text-xs text-muted-foreground",children:'Значения: 1 (ascending), -1 (descending), "text", "2dsphere", "hashed"'})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{checked:Te,onCheckedChange:K}),e.jsx(i,{className:"text-sm",children:"Unique"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{checked:Pe,onCheckedChange:W}),e.jsx(i,{className:"text-sm",children:"Sparse"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{checked:Ve,onCheckedChange:U}),e.jsx(i,{className:"text-sm",children:"Background"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{size:"sm",onClick:()=>ps(s.name),children:w?"Save Changes":"Create Index"}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>{de(!1),he(null),me(null),L(""),H("{}"),K(!1),W(!1),U(!1)},children:"Cancel"})]})]}),s.indexes&&s.indexes.length>0&&e.jsx("div",{className:"space-y-2",children:s.indexes.map((n,t)=>e.jsxs("div",{className:"p-2 border rounded bg-muted/50 flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1 flex-1",children:[e.jsx("div",{className:"font-mono text-sm",children:n.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[Object.entries(n.keys).map(([r,x])=>`${r}: ${x}`).join(", "),n.unique&&" • unique",n.sparse&&" • sparse",n.background&&" • background"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>fs(s.name,n.name),title:"Edit index",children:e.jsx(Me,{className:"h-3 w-3"})}),e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>vs(s.name,n.name),title:"Delete index",disabled:n.name==="_id_",children:e.jsx(P,{className:"h-3 w-3"})})]})]},t))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{children:"Schema Validation"}),e.jsx(F,{checked:s.validation!==void 0&&s.validation!==null,onCheckedChange:n=>{n?G(a,"validation",{validator:{},validationLevel:"strict",validationAction:"error"}):G(a,"validation",void 0)}})]}),s.validation&&e.jsxs("div",{className:"space-y-3 p-3 border rounded-lg bg-muted/30",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:["Validation Schema (JSON) ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(re,{className:"font-mono text-xs",rows:4,value:JSON.stringify(s.validation.validator,null,2),onChange:n=>{try{const t=JSON.parse(n.target.value);G(a,"validation",{...s.validation,validator:t})}catch(t){o(`Неверный формат JSON: ${t instanceof Error?t.message:"Неизвестная ошибка"}`)}},placeholder:'{"$jsonSchema": {"required": ["name", "email"], "properties": {"name": {"type": "string"}, "email": {"type": "string"}}}}'}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Используйте MongoDB JSON Schema для валидации документов"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Validation Level"}),e.jsxs(se,{value:s.validation.validationLevel||"strict",onValueChange:n=>{G(a,"validation",{...s.validation,validationLevel:n})},children:[e.jsx(ae,{children:e.jsx(te,{})}),e.jsxs(ne,{children:[e.jsx(y,{value:"off",children:"Off"}),e.jsx(y,{value:"moderate",children:"Moderate"}),e.jsx(y,{value:"strict",children:"Strict"})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.validation.validationLevel==="off"&&"Валидация отключена",s.validation.validationLevel==="moderate"&&"Валидация только для новых и измененных документов",s.validation.validationLevel==="strict"&&"Валидация для всех документов"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Validation Action"}),e.jsxs(se,{value:s.validation.validationAction||"error",onValueChange:n=>{G(a,"validation",{...s.validation,validationAction:n})},children:[e.jsx(ae,{children:e.jsx(te,{})}),e.jsxs(ne,{children:[e.jsx(y,{value:"error",children:"Error (Reject)"}),e.jsx(y,{value:"warn",children:"Warn (Log only)"})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.validation.validationAction==="error"&&"Отклонять невалидные документы",s.validation.validationAction==="warn"&&"Только предупреждать о невалидных документах"]})]})]})]})]})]})]},a))})]})}),e.jsx(ee,{value:"documents",className:"mt-4 space-y-4",children:e.jsxs(I,{children:[e.jsxs(M,{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(J,{children:"Documents"}),e.jsx(B,{children:"View and manage collection documents"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(se,{value:$,onValueChange:s=>l({selectedCollection:s}),children:[e.jsx(ae,{className:"w-48",children:e.jsx(te,{placeholder:"Select collection"})}),e.jsx(ne,{children:g.map((s,a)=>e.jsx(y,{value:s.name,children:s.name},a))})]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>Ie(!0),children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Insert Document"]})]})]}),hs&&e.jsx(E,{className:"border-b pb-4 mb-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Document (JSON)"}),e.jsx(re,{className:"font-mono text-sm",rows:6,value:Le,onChange:s=>Ee(s.target.value),placeholder:'{"name": "John", "email": "john@example.com"}'})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{onClick:Ns,children:"Insert Document"}),e.jsx(c,{variant:"outline",onClick:()=>{Ie(!1),Ee("{}")},children:"Cancel"})]})]})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Query Filter (JSON)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{className:"font-mono text-sm",value:R,onChange:s=>ms(s.target.value),placeholder:'{"status": "active"}'}),e.jsxs(c,{variant:"outline",size:"sm",onClick:bs,children:[e.jsx(Ye,{className:"h-4 w-4 mr-2"}),"Find"]})]})]}),e.jsx("div",{className:"space-y-2",children:$?(()=>{const a=g.find(t=>t.name===$)?.documents||[];let n=a;if(R.trim())try{const t=JSON.parse(R);n=a.filter(r=>{for(const[x,f]of Object.entries(t))if(r[x]!==f)return!1;return!0})}catch{}return n.length>0?n.map((t,r)=>e.jsxs("div",{className:"p-3 border rounded bg-muted/50 font-mono text-xs flex items-start justify-between",children:[e.jsx("pre",{className:"flex-1",children:JSON.stringify(t,null,2)}),e.jsx(c,{variant:"ghost",size:"icon",className:"ml-2 h-6 w-6",onClick:()=>ys($,t._id),children:e.jsx(P,{className:"h-3 w-3"})})]},t._id||r)):e.jsx("div",{className:"text-center text-muted-foreground py-8",children:R.trim()?"No documents match the filter":"No documents in this collection. Insert a document to get started."})})():e.jsx("div",{className:"text-center text-muted-foreground py-8",children:"Select a collection to view documents"})})]})]})}),e.jsxs(ee,{value:"aggregations",className:"mt-4 space-y-4",children:[e.jsxs(I,{children:[e.jsxs(M,{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(J,{children:"Aggregation Pipeline"}),e.jsx(B,{children:"Build MongoDB aggregation pipelines"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(se,{value:ue,onValueChange:xs,children:[e.jsx(ae,{className:"w-48",children:e.jsx(te,{placeholder:"Select collection"})}),e.jsx(ne,{children:g.map((s,a)=>e.jsx(y,{value:s.name,children:s.name},a))})]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:As,children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Add Stage"]}),e.jsxs(c,{size:"sm",onClick:Es,disabled:!ue||D.length===0,children:[e.jsx(Ye,{className:"h-4 w-4 mr-2"}),"Execute"]})]})]}),e.jsxs(E,{className:"space-y-3",children:[D.map((s,a)=>e.jsxs("div",{className:"p-4 border border-border rounded-lg bg-card space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(se,{value:s.stage,onValueChange:n=>Qe(a,"stage",n),children:[e.jsx(ae,{className:"w-48",children:e.jsx(te,{})}),e.jsxs(ne,{children:[e.jsx(y,{value:"$match",children:"$match"}),e.jsx(y,{value:"$group",children:"$group"}),e.jsx(y,{value:"$project",children:"$project"}),e.jsx(y,{value:"$sort",children:"$sort"}),e.jsx(y,{value:"$limit",children:"$limit"}),e.jsx(y,{value:"$skip",children:"$skip"}),e.jsx(y,{value:"$unwind",children:"$unwind"}),e.jsx(y,{value:"$lookup",children:"$lookup"})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Stage Type"})]}),e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>Is(a),children:e.jsx(P,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Expression (JSON)"}),e.jsx(re,{className:"font-mono text-xs",rows:3,value:s.expression,onChange:n=>Qe(a,"expression",n.target.value),placeholder:'{"status": "active"}'})]})]},a)),D.length===0&&e.jsx("div",{className:"text-center text-muted-foreground py-8",children:"No aggregation stages. Add a stage to build your pipeline."})]})]}),Oe.length>0&&e.jsxs(I,{children:[e.jsxs(M,{children:[e.jsx(J,{children:"Aggregation Results"}),e.jsxs(B,{children:[Oe.length," document(s) returned"]})]}),e.jsx(E,{className:"space-y-2 max-h-96 overflow-y-auto",children:Oe.map((s,a)=>e.jsx("div",{className:"p-3 border rounded bg-muted/50 font-mono text-xs",children:e.jsx("pre",{children:JSON.stringify(s,null,2)})},a))})]})]}),e.jsx(ee,{value:"replication",className:"mt-4 space-y-4",children:e.jsxs(I,{children:[e.jsxs(M,{children:[e.jsx(J,{children:"Replica Set Configuration"}),e.jsx(B,{children:"Configure MongoDB replica set members"})]}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{children:"Enable Replica Set"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Enable MongoDB replica set for high availability"})]}),e.jsx(F,{checked:Fe,onCheckedChange:s=>l({enableReplicaSet:s})})]}),Fe&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Replica Set Name"}),e.jsx(j,{value:is,onChange:s=>l({replicaSetName:s.target.value})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{children:"Replica Set Members"}),e.jsxs(c,{variant:"outline",size:"sm",onClick:Ss,children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Add Member"]})]}),z.map((s,a)=>e.jsxs("div",{className:"p-4 border border-border rounded-lg bg-card space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 flex-1",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Host"}),e.jsx(j,{value:s.host,onChange:n=>{const t=[...z];t[a]={...t[a],host:n.target.value},l({replicaSetMembers:t})}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Port"}),e.jsx(j,{type:"number",value:s.port,onChange:n=>{const t=[...z];t[a]={...t[a],port:parseInt(n.target.value)||27017},l({replicaSetMembers:t})}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Priority"}),e.jsx(j,{type:"number",value:s.priority||1,onChange:n=>{const t=[...z];t[a]={...t[a],priority:parseInt(n.target.value)||1},l({replicaSetMembers:t})}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Votes"}),e.jsx(j,{type:"number",value:s.votes||1,onChange:n=>{const t=[...z];t[a]={...t[a],votes:parseInt(n.target.value)||1},l({replicaSetMembers:t})}})]})]}),e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>ws(a),children:e.jsx(P,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{checked:s.arbiterOnly||!1,onCheckedChange:n=>{const t=[...z];t[a]={...t[a],arbiterOnly:n},l({replicaSetMembers:t})}}),e.jsx(i,{children:"Arbiter Only"})]})]},a))]})]})]})]})}),e.jsx(ee,{value:"sharding",className:"mt-4 space-y-4",children:e.jsxs(I,{children:[e.jsxs(M,{children:[e.jsx(J,{children:"Sharding Configuration"}),e.jsx(B,{children:"Configure MongoDB sharding for horizontal scaling"})]}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{children:"Enable Sharding"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Enable sharding for distributed data storage"})]}),e.jsx(F,{checked:Re,onCheckedChange:s=>l({enableSharding:s})})]}),Re&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Shard Key (JSON)"}),e.jsx(re,{className:"font-mono text-xs",rows:3,value:JSON.stringify(d.shardKey,null,2),onChange:s=>{try{const a=JSON.parse(s.target.value);l({shardConfig:{...d,shardKey:a}})}catch(a){o(`Неверный формат JSON: ${a instanceof Error?a.message:"Неизвестная ошибка"}`)}},placeholder:'{"_id": "hashed"}'})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{children:"Shards"}),e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>{ge(null),pe(""),fe(""),ve(""),Ne(1)},children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Add Shard"]})]}),We===null&&e.jsx(I,{className:"p-4 border-dashed",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Shard Name"}),e.jsx(j,{value:Ue,onChange:s=>pe(s.target.value),placeholder:"shard1"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Hosts (comma-separated)"}),e.jsx(j,{value:ze,onChange:s=>fe(s.target.value),placeholder:"localhost:27017,localhost:27018"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Format: host:port,host:port (for replica sets)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Zones (comma-separated, optional)"}),e.jsx(j,{value:De,onChange:s=>ve(s.target.value),placeholder:"us-east,us-west"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Weight (1-100)"}),e.jsx(j,{type:"number",min:"1",max:"100",value:Ze,onChange:s=>Ne(parseInt(s.target.value)||1)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{onClick:$s,size:"sm",children:"Add Shard"}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>{pe(""),fe(""),ve(""),Ne(1)},children:"Cancel"})]})]})}),e.jsx("div",{className:"space-y-2",children:d.shards.map((s,a)=>e.jsx(I,{className:"p-4",children:We===a?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Shard Name"}),e.jsx(j,{value:s.name,onChange:n=>ye(a,"name",n.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Hosts (comma-separated)"}),e.jsx(j,{value:Array.isArray(s.hosts)?s.hosts.join(", "):"",onChange:n=>{const t=n.target.value.split(",").map(r=>r.trim()).filter(r=>r);ye(a,"hosts",t)}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Zones (comma-separated)"}),e.jsx(j,{value:Array.isArray(s.zones)?s.zones.join(", "):"",onChange:n=>{const t=n.target.value.split(",").map(r=>r.trim()).filter(r=>r);ye(a,"zones",t)}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Weight (1-100)"}),e.jsx(j,{type:"number",min:"1",max:"100",value:s.weight||1,onChange:n=>ye(a,"weight",parseInt(n.target.value)||1)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{size:"sm",onClick:()=>{ge(null),S(`Шард "${s.name}" обновлен`)},children:"Save"}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>ge(null),children:"Cancel"})]})]}):e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-semibold font-mono",children:s.name||`shard${a+1}`}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Hosts: ",Array.isArray(s.hosts)?s.hosts.join(", "):"N/A"]}),Array.isArray(s.zones)&&s.zones.length>0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Zones: ",s.zones.join(", ")]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Weight: ",s.weight||1]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{variant:"ghost",size:"sm",onClick:()=>ge(a),children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Edit"]}),e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>ks(a),children:e.jsx(P,{className:"h-4 w-4"})})]})]})})},a))})]})]})]})]})})]})]})})}export{Ys as MongoDBConfigAdvanced};
