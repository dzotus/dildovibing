import{u as ie,j as e,r as T,B as R,i as n,c as O,S as ce,C as c,e as d,f as o,k as i,T as ne,a as de,b as S,A as oe,d as E,h as f,P as _,m as xe,L as u,n as me,o as he,p as ue,q as je,s as Q,I as j,N as $,l as p}from"./index-Dd33G1rA.js";import{T as pe}from"./textarea-DbhW0zkJ.js";import{P as G}from"./progress-zyfouKmR.js";import{u as ge}from"./usePortValidation-DnH6EGea.js";import{v as Ne}from"./requiredFields-BLgUUVkB.js";import{a as U,s as W}from"./toast-DIwbB4rV.js";import{C as ve}from"./chart-column-Cfk5dXNs.js";import{D as J}from"./database-CTo8fyrd.js";import{C as fe}from"./code-CeqdEWNh.js";function Me({componentId:k}){const{nodes:H,updateNode:K}=ie(),M=H.find(s=>s.id===k);if(!M)return e.jsx("div",{className:"p-4 text-muted-foreground",children:"Component not found"});const r=M.data.config||{},b=r.host||"localhost",y=r.port||8123,A=r.database||"default",X=r.username||"default",Y=r.password||"",x=r.tables||[],z=r.queries||[],[B,D]=T.useState(null),[Z,F]=T.useState(!1),[w,P]=T.useState(""),ee=r.totalRows||x.reduce((s,a)=>s+a.rows,0),se=r.totalSize||x.reduce((s,a)=>s+a.size,0),q=r.queryThroughput||1250,L=r.avgQueryTime||45,{portError:g,hostError:C,portConflict:N}=ge(H,k,b,y),m=s=>{if(K(k,{data:{...M.data,config:{...r,...s}}}),Object.keys(s).some(a=>["host","port","database"].includes(a))){const a={...t};Object.keys(s).forEach(l=>{a[l]&&delete a[l]}),V(a)}},[t,V]=T.useState({}),ae=[{field:"host",label:"Host"},{field:"port",label:"Port",validator:s=>typeof s=="number"&&s>0&&s<=65535},{field:"database",label:"Database"}],h=()=>{const s=Ne({host:b,port:y,database:A},ae);return V(s.errors),s.isValid},te=()=>{const s="new_table";let a=s,l=1;for(;x.some(v=>v.name===a);)a=`${s}_${l}`,l++;m({tables:[...x,{name:a,engine:"MergeTree",rows:0,size:0,partitions:0}]})},le=s=>{m({tables:x.filter((a,l)=>l!==s)})},I=(s,a,l)=>{const v=[...x];v[s]={...v[s],[a]:l},m({tables:v})},re=()=>{if(!w.trim())return;const s={id:`query-${Date.now()}`,query:w,status:"running",duration:0};m({queries:[s,...z.slice(0,9)]}),P(""),F(!1)};return e.jsx("div",{className:"h-full overflow-y-auto bg-background",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-yellow-500/10",children:e.jsx(ve,{className:"h-6 w-6 text-yellow-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"ClickHouse"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Column-Oriented Analytics Database"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(R,{variant:"outline",className:"gap-2",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-green-500 animate-pulse"}),"Running"]}),e.jsxs(n,{size:"sm",variant:"outline",children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Query Console"]})]})]}),e.jsx(ce,{}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Tables"})}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:x.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Total tables"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Total Rows"})}),e.jsxs(i,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[(ee/1e6).toFixed(1),"M"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Rows across all tables"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Total Size"})}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:se.toFixed(1)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"GB"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Query Throughput"})}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:q}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"queries/sec"})]})]})]}),e.jsxs(ne,{defaultValue:"tables",className:"w-full",children:[e.jsxs(de,{className:"grid w-full grid-cols-4",children:[e.jsxs(S,{value:"tables",className:"gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Tables"]}),e.jsxs(S,{value:"queries",className:"gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),"Query Console"]}),e.jsxs(S,{value:"performance",className:"gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),"Performance"]}),e.jsxs(S,{value:"settings",className:"gap-2",children:[e.jsx(O,{className:"h-4 w-4"}),"Settings"]})]}),e.jsx(E,{value:"tables",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Tables"}),e.jsx(f,{children:"ClickHouse table configuration"})]}),e.jsxs(n,{size:"sm",onClick:te,variant:"outline",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Create Table"]})]})}),e.jsx(i,{children:e.jsx("div",{className:"space-y-3",children:x.map((s,a)=>e.jsxs(c,{className:"border-border",children:[e.jsx(d,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded bg-primary/10",children:e.jsx(J,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx(o,{className:"text-lg",children:s.name}),e.jsxs(f,{className:"text-xs mt-1",children:[s.engine," • ",s.partitions," partitions • ",s.rows.toLocaleString()," rows • ",s.size," GB"]})]})]}),x.length>1&&e.jsx(n,{size:"icon",variant:"ghost",onClick:()=>le(a),children:e.jsx(xe,{className:"h-4 w-4"})})]})}),B===a&&e.jsxs(i,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Table Engine"}),e.jsxs(me,{value:s.engine,onValueChange:l=>I(a,"engine",l),children:[e.jsx(he,{children:e.jsx(ue,{})}),e.jsxs(je,{children:[e.jsx(Q,{value:"MergeTree",children:"MergeTree"}),e.jsx(Q,{value:"SummingMergeTree",children:"SummingMergeTree"}),e.jsx(Q,{value:"ReplacingMergeTree",children:"ReplacingMergeTree"}),e.jsx(Q,{value:"AggregatingMergeTree",children:"AggregatingMergeTree"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Partitions"}),e.jsx(j,{type:"number",value:s.partitions,onChange:l=>I(a,"partitions",Number(l.target.value)),min:0})]})]}),e.jsx(n,{size:"sm",variant:"outline",onClick:()=>D(null),children:"Done"})]}),B!==a&&e.jsx(i,{children:e.jsx(n,{size:"sm",variant:"outline",onClick:()=>D(a),children:"Edit Settings"})})]},a))})})]})}),e.jsx(E,{value:"queries",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Query Console"}),e.jsx(f,{children:"Execute ClickHouse SQL queries"})]}),e.jsxs(n,{size:"sm",onClick:()=>F(!0),variant:"outline",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"New Query"]})]})}),e.jsxs(i,{children:[Z&&e.jsxs(c,{className:"mb-4 border-primary",children:[e.jsx(d,{children:e.jsx(o,{children:"Execute Query"})}),e.jsxs(i,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"SQL Query"}),e.jsx(pe,{value:w,onChange:s=>P(s.target.value),placeholder:"SELECT count() FROM events WHERE date = today();",rows:8,className:"font-mono text-sm"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{onClick:re,disabled:!w.trim(),children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Execute"]}),e.jsx(n,{variant:"outline",onClick:()=>{F(!1),P("")},children:"Cancel"})]})]})]}),z.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No queries executed"}):e.jsx("div",{className:"space-y-2",children:z.map(s=>e.jsx(c,{className:"border-l-4 border-l-blue-500",children:e.jsx(i,{className:"pt-4",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.status==="running"&&e.jsx($,{className:"h-4 w-4 text-blue-500 animate-pulse"}),e.jsx(R,{variant:s.status==="completed"?"default":s.status==="failed"?"destructive":"secondary",children:s.status}),s.duration>0&&e.jsxs(R,{variant:"outline",children:[s.duration,"ms"]})]}),e.jsx("pre",{className:"text-xs font-mono bg-muted p-2 rounded overflow-x-auto",children:s.query})]})})})},s.id))})]})]})}),e.jsx(E,{value:"performance",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsxs(d,{children:[e.jsx(o,{children:"Performance Metrics"}),e.jsx(f,{children:"Query throughput and latency"})]}),e.jsx(i,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Query Throughput"}),e.jsxs("span",{className:"font-semibold",children:[q.toLocaleString()," qps"]})]}),e.jsx(G,{value:Math.min(q/5e3*100,100),className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Avg Query Time"}),e.jsxs("span",{className:"font-semibold",children:[L,"ms"]})]}),e.jsx(G,{value:Math.min(L/200*100,100),className:"h-2"})]})]})})]})}),e.jsx(E,{value:"settings",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsxs(d,{children:[e.jsx(o,{children:"Connection Settings"}),e.jsx(f,{children:"ClickHouse server configuration"})]}),e.jsxs(i,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(u,{htmlFor:"host",children:["Host ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(j,{id:"host",value:b,onChange:s=>{m({host:s.target.value}),t.host&&h()},onBlur:h,placeholder:"localhost",className:C||t.host?"border-destructive":""}),C&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(p,{className:"h-3 w-3"}),e.jsx("span",{children:C})]}),!C&&t.host&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(p,{className:"h-3 w-3"}),e.jsx("span",{children:t.host})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(u,{htmlFor:"port",children:["Port ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(j,{id:"port",type:"number",value:y,onChange:s=>{m({port:parseInt(s.target.value)||8123}),t.port&&h()},onBlur:h,placeholder:"8123",className:g||N.hasConflict||t.port?"border-destructive":""}),g&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(p,{className:"h-3 w-3"}),e.jsx("span",{children:g})]}),!g&&t.port&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(p,{className:"h-3 w-3"}),e.jsx("span",{children:t.port})]}),!g&&!t.port&&N.hasConflict&&N.conflictingNode&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-amber-600 dark:text-amber-400",children:[e.jsx(p,{className:"h-3 w-3"}),e.jsxs("span",{children:['Конфликт порта: компонент "',N.conflictingNode.data.label||N.conflictingNode.type,'" уже использует ',b,":",y]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(u,{htmlFor:"database",children:["Database ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(j,{id:"database",value:A,onChange:s=>{m({database:s.target.value}),t.database&&h()},onBlur:h,placeholder:"default",className:t.database?"border-destructive":""}),t.database&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(p,{className:"h-3 w-3"}),e.jsx("span",{children:t.database})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"username",children:"Username"}),e.jsx(j,{id:"username",value:X,onChange:s=>m({username:s.target.value}),placeholder:"default"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"password",children:"Password"}),e.jsx(j,{id:"password",type:"password",value:Y,onChange:s=>m({password:s.target.value}),placeholder:"password"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsx(n,{onClick:()=>{h()?U("Параметры подключения сохранены"):W("Пожалуйста, заполните все обязательные поля")},children:"Сохранить настройки"}),e.jsx(n,{variant:"outline",onClick:()=>{h()?U("Параметры подключения валидны"):W("Пожалуйста, заполните все обязательные поля")},children:"Проверить подключение"})]})]})]})})]})]})})}export{Me as ClickHouseConfigAdvanced};
