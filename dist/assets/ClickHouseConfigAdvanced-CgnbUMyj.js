import{u as me,j as e,r as k,V as K,B,i as n,c as X,S as ue,C as c,e as d,f as o,k as i,T as he,a as je,b as M,A as pe,d as R,h as w,P as Y,m as ge,L as p,n as Ne,o as fe,p as ve,q as be,s as q,I as N,N as Z,l as f}from"./index-CR3GNhD5.js";import{T as ye}from"./textarea-Bv7Bb31R.js";import{P as ee}from"./progress-DUB59v6W.js";import{u as we}from"./usePortValidation-B-lobkaJ.js";import{v as Ce}from"./requiredFields-BLgUUVkB.js";import{a as L,s as V}from"./toast-dtxw459m.js";import{C as Te}from"./chart-column-InwYMKMc.js";import{D as se}from"./database-C_6ixwPf.js";import{C as Ee}from"./code-bgKzZBKf.js";function Fe({componentId:v}){const{nodes:O,updateNode:ae}=me(),z=O.find(s=>s.id===v);if(!z)return e.jsx("div",{className:"p-4 text-muted-foreground",children:"Component not found"});const r=z.data.config||{},C=r.host||"localhost",T=r.port||8123,I=r.database||"default",te=r.username||"default",le=r.password||"",x=r.tables||[],H=r.queries||[],[W,_]=k.useState(null),[re,D]=k.useState(!1),[u,P]=k.useState(""),E=K.getClickHouseRoutingEngine(v)?.getMetrics(),ie=E?.totalRows||r.totalRows||x.reduce((s,a)=>s+a.rows,0),ce=E?.totalSize||r.totalSize||x.reduce((s,a)=>s+a.size,0),F=E?.queryThroughput||r.queryThroughput||1250,$=E?.avgQueryTime||r.avgQueryTime||45,{portError:b,hostError:S,portConflict:y}=we(O,v,C,T),m=s=>{if(ae(v,{data:{...z.data,config:{...r,...s}}}),Object.keys(s).some(a=>["host","port","database"].includes(a))){const a={...l};Object.keys(s).forEach(t=>{a[t]&&delete a[t]}),G(a)}},[l,G]=k.useState({}),ne=[{field:"host",label:"Host"},{field:"port",label:"Port",validator:s=>typeof s=="number"&&s>0&&s<=65535},{field:"database",label:"Database"}],h=()=>{const s=Ce({host:C,port:T,database:I},ne);return G(s.errors),s.isValid},de=()=>{const s="new_table";let a=s,t=1;for(;x.some(j=>j.name===a);)a=`${s}_${t}`,t++;m({tables:[...x,{name:a,engine:"MergeTree",rows:0,size:0,partitions:0}]})},oe=s=>{m({tables:x.filter((a,t)=>t!==s)})},U=(s,a,t)=>{const j=[...x];j[s]={...j[s],[a]:t},m({tables:j})},xe=()=>{if(!u.trim())return;const s=`query-${Date.now()}`,a=Date.now(),t={id:s,query:u,status:"running",duration:0},j=K.getClickHouseRoutingEngine(v);let g=t;if(j)try{const Q=j.executeQuery(u),A=Date.now()-a;if(g={id:s,query:u,status:Q.success?"completed":"failed",duration:Q.latency||A},Q.success){const J=u.trim().toUpperCase();J.startsWith("CREATE TABLE")||J.startsWith("DROP TABLE")}}catch{const A=Date.now()-a;g={id:s,query:u,status:"failed",duration:A}}else g.status="completed",g.duration=Date.now()-a;m({queries:[g,...H.slice(0,9)]}),P(""),D(!1),g.status==="failed"?V("Query execution failed"):L("Query executed successfully")};return e.jsx("div",{className:"h-full overflow-y-auto bg-background",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-yellow-500/10",children:e.jsx(Te,{className:"h-6 w-6 text-yellow-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"ClickHouse"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Column-Oriented Analytics Database"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(B,{variant:"outline",className:"gap-2",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-green-500 animate-pulse"}),"Running"]}),e.jsxs(n,{size:"sm",variant:"outline",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Query Console"]})]})]}),e.jsx(ue,{}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Tables"})}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:x.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Total tables"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Total Rows"})}),e.jsxs(i,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[(ie/1e6).toFixed(1),"M"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Rows across all tables"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Total Size"})}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:ce.toFixed(1)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"GB"})]})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-3",children:e.jsx(o,{className:"text-sm font-medium",children:"Query Throughput"})}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:F}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"queries/sec"})]})]})]}),e.jsxs(he,{defaultValue:"tables",className:"w-full",children:[e.jsxs(je,{className:"grid w-full grid-cols-4",children:[e.jsxs(M,{value:"tables",className:"gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),"Tables"]}),e.jsxs(M,{value:"queries",className:"gap-2",children:[e.jsx(Ee,{className:"h-4 w-4"}),"Query Console"]}),e.jsxs(M,{value:"performance",className:"gap-2",children:[e.jsx(pe,{className:"h-4 w-4"}),"Performance"]}),e.jsxs(M,{value:"settings",className:"gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),"Settings"]})]}),e.jsx(R,{value:"tables",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Tables"}),e.jsx(w,{children:"ClickHouse table configuration"})]}),e.jsxs(n,{size:"sm",onClick:de,variant:"outline",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Create Table"]})]})}),e.jsx(i,{children:e.jsx("div",{className:"space-y-3",children:x.map((s,a)=>e.jsxs(c,{className:"border-border",children:[e.jsx(d,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded bg-primary/10",children:e.jsx(se,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx(o,{className:"text-lg",children:s.name}),e.jsxs(w,{className:"text-xs mt-1",children:[s.engine," • ",s.partitions," partitions • ",s.rows.toLocaleString()," rows • ",s.size," GB"]})]})]}),x.length>1&&e.jsx(n,{size:"icon",variant:"ghost",onClick:()=>oe(a),children:e.jsx(ge,{className:"h-4 w-4"})})]})}),W===a&&e.jsxs(i,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Table Engine"}),e.jsxs(Ne,{value:s.engine,onValueChange:t=>U(a,"engine",t),children:[e.jsx(fe,{children:e.jsx(ve,{})}),e.jsxs(be,{children:[e.jsx(q,{value:"MergeTree",children:"MergeTree"}),e.jsx(q,{value:"SummingMergeTree",children:"SummingMergeTree"}),e.jsx(q,{value:"ReplacingMergeTree",children:"ReplacingMergeTree"}),e.jsx(q,{value:"AggregatingMergeTree",children:"AggregatingMergeTree"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Partitions"}),e.jsx(N,{type:"number",value:s.partitions,onChange:t=>U(a,"partitions",Number(t.target.value)),min:0})]})]}),e.jsx(n,{size:"sm",variant:"outline",onClick:()=>_(null),children:"Done"})]}),W!==a&&e.jsx(i,{children:e.jsx(n,{size:"sm",variant:"outline",onClick:()=>_(a),children:"Edit Settings"})})]},a))})})]})}),e.jsx(R,{value:"queries",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Query Console"}),e.jsx(w,{children:"Execute ClickHouse SQL queries"})]}),e.jsxs(n,{size:"sm",onClick:()=>D(!0),variant:"outline",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"New Query"]})]})}),e.jsxs(i,{children:[re&&e.jsxs(c,{className:"mb-4 border-primary",children:[e.jsx(d,{children:e.jsx(o,{children:"Execute Query"})}),e.jsxs(i,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"SQL Query"}),e.jsx(ye,{value:u,onChange:s=>P(s.target.value),placeholder:"SELECT count() FROM events WHERE date = today();",rows:8,className:"font-mono text-sm"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{onClick:xe,disabled:!u.trim(),children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Execute"]}),e.jsx(n,{variant:"outline",onClick:()=>{D(!1),P("")},children:"Cancel"})]})]})]}),H.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No queries executed"}):e.jsx("div",{className:"space-y-2",children:H.map(s=>e.jsx(c,{className:"border-l-4 border-l-blue-500",children:e.jsx(i,{className:"pt-4",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.status==="running"&&e.jsx(Z,{className:"h-4 w-4 text-blue-500 animate-pulse"}),e.jsx(B,{variant:s.status==="completed"?"default":s.status==="failed"?"destructive":"secondary",children:s.status}),s.duration>0&&e.jsxs(B,{variant:"outline",children:[s.duration,"ms"]})]}),e.jsx("pre",{className:"text-xs font-mono bg-muted p-2 rounded overflow-x-auto",children:s.query})]})})})},s.id))})]})]})}),e.jsx(R,{value:"performance",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsxs(d,{children:[e.jsx(o,{children:"Performance Metrics"}),e.jsx(w,{children:"Query throughput and latency"})]}),e.jsx(i,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Query Throughput"}),e.jsxs("span",{className:"font-semibold",children:[F.toLocaleString()," qps"]})]}),e.jsx(ee,{value:Math.min(F/5e3*100,100),className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Avg Query Time"}),e.jsxs("span",{className:"font-semibold",children:[$,"ms"]})]}),e.jsx(ee,{value:Math.min($/200*100,100),className:"h-2"})]})]})})]})}),e.jsx(R,{value:"settings",className:"space-y-4 mt-4",children:e.jsxs(c,{children:[e.jsxs(d,{children:[e.jsx(o,{children:"Connection Settings"}),e.jsx(w,{children:"ClickHouse server configuration"})]}),e.jsxs(i,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{htmlFor:"host",children:["Host ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(N,{id:"host",value:C,onChange:s=>{m({host:s.target.value}),l.host&&h()},onBlur:h,placeholder:"localhost",className:S||l.host?"border-destructive":""}),S&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(f,{className:"h-3 w-3"}),e.jsx("span",{children:S})]}),!S&&l.host&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(f,{className:"h-3 w-3"}),e.jsx("span",{children:l.host})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{htmlFor:"port",children:["Port ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(N,{id:"port",type:"number",value:T,onChange:s=>{m({port:parseInt(s.target.value)||8123}),l.port&&h()},onBlur:h,placeholder:"8123",className:b||y.hasConflict||l.port?"border-destructive":""}),b&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(f,{className:"h-3 w-3"}),e.jsx("span",{children:b})]}),!b&&l.port&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(f,{className:"h-3 w-3"}),e.jsx("span",{children:l.port})]}),!b&&!l.port&&y.hasConflict&&y.conflictingNode&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-amber-600 dark:text-amber-400",children:[e.jsx(f,{className:"h-3 w-3"}),e.jsxs("span",{children:['Конфликт порта: компонент "',y.conflictingNode.data.label||y.conflictingNode.type,'" уже использует ',C,":",T]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{htmlFor:"database",children:["Database ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(N,{id:"database",value:I,onChange:s=>{m({database:s.target.value}),l.database&&h()},onBlur:h,placeholder:"default",className:l.database?"border-destructive":""}),l.database&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-destructive",children:[e.jsx(f,{className:"h-3 w-3"}),e.jsx("span",{children:l.database})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"username",children:"Username"}),e.jsx(N,{id:"username",value:te,onChange:s=>m({username:s.target.value}),placeholder:"default"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"password",children:"Password"}),e.jsx(N,{id:"password",type:"password",value:le,onChange:s=>m({password:s.target.value}),placeholder:"password"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsx(n,{onClick:()=>{h()?L("Параметры подключения сохранены"):V("Пожалуйста, заполните все обязательные поля")},children:"Сохранить настройки"}),e.jsx(n,{variant:"outline",onClick:()=>{h()?L("Параметры подключения валидны"):V("Пожалуйста, заполните все обязательные поля")},children:"Проверить подключение"})]})]})]})})]})]})})}export{Fe as ClickHouseConfigAdvanced};
