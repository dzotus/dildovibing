# Network Firewall - Документация компонента

## Обзор

Network Firewall - это сетевой файрвол для контроля и фильтрации сетевого трафика на уровне IP адресов, портов и протоколов. Компонент Firewall в системе симуляции полностью эмулирует поведение реальных сетевых файрволов (iptables, pfSense, AWS Network Firewall), включая stateful inspection, connection tracking, правила фильтрации с поддержкой CIDR, логирование пакетов и полный набор метрик производительности.

### Основные возможности

- ✅ **Packet Filtering** - Фильтрация пакетов по IP адресам, портам и протоколам
- ✅ **Stateful Inspection** - Отслеживание состояний соединений (TCP, UDP, ICMP)
- ✅ **Connection Tracking** - Отслеживание активных соединений с timeout для разных протоколов
- ✅ **CIDR Support** - Поддержка CIDR нотации для IP адресов и сетей
- ✅ **Rule Priority** - Приоритет правил с первым совпадением
- ✅ **Default Policy** - Политика по умолчанию для несовпадающих пакетов (allow/deny/reject)
- ✅ **Packet Logging** - Логирование всех обработанных пакетов
- ✅ **Protocol Support** - Поддержка TCP, UDP, ICMP и всех протоколов
- ✅ **Port Filtering** - Фильтрация по source и destination портам
- ✅ **Connection Rules** - Автоматическая настройка конфигов при подключении компонентов
- ✅ **Метрики Firewall** - Полный набор метрик производительности и безопасности

---

## Основные функции

### 1. Packet Filtering (Фильтрация пакетов)

**Описание:** Firewall фильтрует сетевые пакеты на основе правил, определяющих, какие пакеты разрешены, заблокированы или отклонены.

**Критерии фильтрации:**
- **Source IP** - IP адрес источника (поддержка CIDR)
- **Destination IP** - IP адрес назначения (поддержка CIDR)
- **Protocol** - Протокол (TCP, UDP, ICMP, all)
- **Port** - Destination порт (для TCP/UDP)
- **Source Port** - Source порт (для TCP/UDP)

**Действия:**
- **allow** - Разрешить пакет
- **deny** - Заблокировать пакет (тихая блокировка)
- **reject** - Отклонить пакет (с отправкой ICMP ошибки)

**Пример правила:**
```json
{
  "id": "allow-http",
  "name": "Allow HTTP",
  "action": "allow",
  "protocol": "tcp",
  "destination": "192.168.1.100",
  "port": 80,
  "enabled": true,
  "priority": 100
}
```

### 2. Stateful Inspection (Stateful инспекция)

**Описание:** Firewall отслеживает состояния соединений для более умной фильтрации пакетов.

**Поддерживаемые протоколы:**

#### 2.1. TCP State Tracking

**Состояния TCP:**
- **new** - Новое соединение (SYN пакет)
- **syn-sent** - SYN отправлен, ожидается SYN-ACK
- **syn-received** - SYN-ACK получен, ожидается ACK
- **established** - Соединение установлено
- **fin-wait-1** - FIN отправлен, ожидается ACK
- **fin-wait-2** - FIN ACK получен, ожидается FIN
- **close-wait** - FIN получен, ожидается закрытие
- **closing** - Обе стороны закрывают соединение
- **last-ack** - Последний ACK перед закрытием
- **time-wait** - Ожидание перед полным закрытием
- **closed** - Соединение закрыто
- **related** - Связанное соединение (например, FTP data connection)
- **invalid** - Невалидное состояние

**TCP Flags:**
- **SYN** - Синхронизация (начало соединения)
- **ACK** - Подтверждение
- **FIN** - Завершение соединения
- **RST** - Сброс соединения
- **PSH** - Push (немедленная отправка данных)
- **URG** - Urgent (срочные данные)

**Timeout:**
- **Established connections**: 1 час
- **New connections**: 2 минуты
- **TIME-WAIT**: 2 минуты

#### 2.2. UDP Session Tracking

**Описание:** UDP не имеет состояний, но Firewall отслеживает "сессии" по паре IP:port.

**Состояния UDP:**
- **new** - Новый UDP пакет
- **established** - UDP сессия установлена (есть ответные пакеты)
- **related** - Связанная UDP сессия

**Timeout:** 30 секунд

#### 2.3. ICMP Tracking

**Описание:** ICMP сообщения связываются с запросами и ответами.

**Состояния ICMP:**
- **new** - Новый ICMP пакет
- **established** - ICMP сессия установлена (есть ответ)
- **related** - Связанный ICMP пакет (например, ICMP ошибка для TCP/UDP)

**ICMP Types:**
- **0** - Echo Reply
- **3** - Destination Unreachable
- **8** - Echo Request
- **11** - Time Exceeded
- И другие типы

**Timeout:** 30 секунд

**Параметры:**
- **enableStatefulInspection** - Включить stateful inspection (по умолчанию: `true`)

**Как работает:**
1. Firewall отслеживает все соединения в таблице соединений
2. При получении пакета проверяется состояние соединения
3. Если соединение в состоянии `established`, пакет разрешается автоматически (быстрее)
4. Если соединение в невалидном состоянии, пакет блокируется
5. Старые соединения очищаются по timeout

**Пример конфигурации:**
```json
{
  "enableStatefulInspection": true
}
```

### 3. Connection Tracking (Отслеживание соединений)

**Описание:** Firewall отслеживает активные соединения для stateful inspection.

**Параметры:**
- **MAX_CONNECTIONS** - Максимальное количество отслеживаемых соединений (по умолчанию: `10000`)

**Информация о соединении:**
- Source IP и порт
- Destination IP и порт
- Протокол (TCP, UDP, ICMP)
- Состояние соединения
- TCP flags (для TCP)
- ICMP type/code (для ICMP)
- Время первого и последнего пакета
- Количество пакетов и байт
- Направление (original/reply)

**Очистка соединений:**
- Соединения очищаются автоматически по timeout
- Старые соединения удаляются при достижении лимита
- Приоритетная очистка неактивных соединений

### 4. Rules (Правила)

**Описание:** Firewall использует правила для фильтрации пакетов.

**Структура правила:**
```json
{
  "id": "rule-1",
  "name": "Allow HTTP from Internal",
  "action": "allow",
  "protocol": "tcp",
  "source": "192.168.1.0/24",
  "destination": "10.0.0.1",
  "port": 80,
  "sourcePort": 1024,
  "enabled": true,
  "priority": 100,
  "hits": 0
}
```

**Параметры правила:**
- **id** - Уникальный идентификатор (обязательно)
- **name** - Имя правила (обязательно)
- **action** - Действие: `allow`, `deny`, `reject` (обязательно)
- **protocol** - Протокол: `tcp`, `udp`, `icmp`, `all` (обязательно)
- **source** - Source IP или CIDR (опционально)
- **destination** - Destination IP или CIDR (опционально)
- **port** - Destination порт (опционально, для TCP/UDP)
- **sourcePort** - Source порт (опционально, для TCP/UDP)
- **enabled** - Включено ли правило (по умолчанию: `true`)
- **priority** - Приоритет правила (больше = выше приоритет, проверяется первым)
- **hits** - Количество совпадений (автоматически обновляется)

**Приоритет правил:**
- Правила обрабатываются по приоритету (от большего к меньшему)
- Первое совпавшее правило определяет действие
- Если правило совпало, дальнейшая проверка останавливается

**Примеры правил:**

**Разрешить HTTP из внутренней сети:**
```json
{
  "id": "allow-http-internal",
  "name": "Allow HTTP from Internal",
  "action": "allow",
  "protocol": "tcp",
  "source": "192.168.1.0/24",
  "port": 80,
  "enabled": true,
  "priority": 100
}
```

**Заблокировать SSH из внешней сети:**
```json
{
  "id": "block-ssh-external",
  "name": "Block SSH from External",
  "action": "deny",
  "protocol": "tcp",
  "source": "0.0.0.0/0",
  "port": 22,
  "enabled": true,
  "priority": 200
}
```

**Разрешить ICMP ping:**
```json
{
  "id": "allow-icmp",
  "name": "Allow ICMP Ping",
  "action": "allow",
  "protocol": "icmp",
  "enabled": true,
  "priority": 50
}
```

### 5. Default Policy (Политика по умолчанию)

**Описание:** Политика по умолчанию применяется к пакетам, которые не соответствуют ни одному правилу.

**Параметры:**
- **defaultPolicy** - Политика по умолчанию: `allow`, `deny`, `reject` (по умолчанию: `deny`)

**Действия:**
- **allow** - Разрешить все несовпадающие пакеты
- **deny** - Заблокировать все несовпадающие пакеты (тихая блокировка)
- **reject** - Отклонить все несовпадающие пакеты (с отправкой ICMP ошибки)

**Рекомендации:**
- Для production используйте `deny` (более безопасно)
- Для разработки можно использовать `allow` (удобнее)

**Пример конфигурации:**
```json
{
  "defaultPolicy": "deny"
}
```

### 6. CIDR Support (Поддержка CIDR)

**Описание:** Firewall поддерживает CIDR нотацию для указания IP адресов и сетей.

**Формат CIDR:**
- Отдельный IP: `192.168.1.1`
- CIDR сеть: `192.168.1.0/24` (256 адресов)
- CIDR сеть: `10.0.0.0/16` (65536 адресов)
- CIDR сеть: `0.0.0.0/0` (все адреса)

**Примеры использования:**
- `192.168.1.0/24` - Вся подсеть 192.168.1.x
- `10.0.0.0/8` - Вся сеть 10.x.x.x
- `172.16.0.0/12` - Вся сеть 172.16-31.x.x
- `0.0.0.0/0` - Все IP адреса

**Пример правила с CIDR:**
```json
{
  "id": "allow-internal",
  "name": "Allow Internal Network",
  "action": "allow",
  "protocol": "all",
  "source": "192.168.1.0/24",
  "enabled": true,
  "priority": 100
}
```

### 7. Packet Logging (Логирование пакетов)

**Описание:** Firewall может логировать все обработанные пакеты для аудита и анализа.

**Параметры:**
- **enableLogging** - Включить логирование (по умолчанию: `true`)
- **logRetention** - Хранение логов в днях (по умолчанию: `30`)
- **MAX_LOGS** - Максимальное количество логов в памяти (по умолчанию: `10000`)

**Информация в логе:**
- **id** - Уникальный идентификатор лога
- **timestamp** - Время обработки пакета
- **action** - Действие: `allowed`, `blocked`, `rejected`
- **source** - IP адрес источника
- **destination** - IP адрес назначения
- **protocol** - Протокол (tcp, udp, icmp)
- **port** - Destination порт (если применимо)
- **sourcePort** - Source порт (если применимо)
- **ruleId** - ID правила (если пакет совпал с правилом)
- **ruleName** - Имя правила (если пакет совпал с правилом)
- **reason** - Причина действия (например, "Default policy: deny")

**Пример лога:**
```json
{
  "id": "log-1",
  "timestamp": 1609459200000,
  "action": "blocked",
  "source": "192.168.1.100",
  "destination": "10.0.0.1",
  "protocol": "tcp",
  "port": 22,
  "ruleId": "block-ssh",
  "ruleName": "Block SSH",
  "reason": "Rule matched"
}
```

**Очистка логов:**
- Старые логи автоматически удаляются при достижении лимита
- Логи старше `logRetention` дней удаляются

### 8. Protocol Support (Поддержка протоколов)

**Описание:** Firewall поддерживает фильтрацию по различным протоколам.

**Поддерживаемые протоколы:**
- **tcp** - Transmission Control Protocol
- **udp** - User Datagram Protocol
- **icmp** - Internet Control Message Protocol
- **all** - Все протоколы

**Особенности протоколов:**

#### 8.1. TCP
- Поддержка фильтрации по source и destination портам
- Stateful inspection с полным отслеживанием состояний
- Поддержка TCP flags (SYN, ACK, FIN, RST, PSH, URG)

#### 8.2. UDP
- Поддержка фильтрации по source и destination портам
- Stateful inspection с отслеживанием UDP сессий
- Timeout: 30 секунд

#### 8.3. ICMP
- Поддержка фильтрации по ICMP type и code
- Stateful inspection с отслеживанием ICMP запросов/ответов
- Связывание ICMP ошибок с TCP/UDP соединениями
- Timeout: 30 секунд

#### 8.4. All
- Применяется ко всем протоколам
- Не требует указания протокола в пакете

---

## Руководство пользователя

### Быстрый старт

1. **Добавление компонента Firewall:**
   - Перетащите компонент "Firewall" из библиотеки компонентов на canvas
   - Откройте панель конфигурации компонента

2. **Настройка Default Policy:**
   - Перейдите на вкладку **"Settings"**
   - Выберите **Default Policy**: `deny` (рекомендуется для production) или `allow`
   - Для production используйте `deny` для максимальной безопасности

3. **Включение Stateful Inspection:**
   - В секции **"Inspection & Logging"** включите **Stateful Inspection**
   - Stateful inspection позволяет отслеживать состояния соединений

4. **Создание первого правила:**
   - Перейдите на вкладку **"Rules"**
   - Нажмите кнопку **"Add Rule"**
   - Заполните параметры правила
   - Нажмите **"Save"**

5. **Подключение к другим компонентам:**
   - Создайте соединение от одного компонента к другому через Firewall
   - Firewall автоматически настроится для фильтрации трафика (Connection Rules)

### Работа с правилами

#### Создание правила

1. Перейдите на вкладку **"Rules"**
2. Нажмите кнопку **"Add Rule"**
3. Заполните параметры:
   - **Name** - Имя правила (обязательно)
   - **Action** - Действие: `allow`, `deny`, `reject`
   - **Protocol** - Протокол: `tcp`, `udp`, `icmp`, `all`
   - **Source** - Source IP или CIDR (опционально)
   - **Destination** - Destination IP или CIDR (опционально)
   - **Port** - Destination порт (опционально, для TCP/UDP)
   - **Source Port** - Source порт (опционально, для TCP/UDP)
   - **Enabled** - Включить правило
   - **Priority** - Приоритет правила (больше = выше приоритет)
4. Нажмите **"Save"**

**Примечание:** Правила обрабатываются по приоритету. Первое совпавшее правило определяет действие.

#### Редактирование правила

1. Найдите правило в списке
2. Нажмите кнопку **"Edit"** рядом с правилом
3. Измените параметры
4. Нажмите **"Save"**

#### Удаление правила

1. Найдите правило в списке
2. Нажмите кнопку **"Delete"** рядом с правилом
3. Подтвердите удаление

#### Включение/отключение правила

1. Найдите правило в списке
2. Переключите переключатель **"Enabled"** рядом с правилом
3. Правило будет включено/отключено немедленно

#### Изменение приоритета правила

1. Найдите правило в списке
2. Нажмите кнопку **"Edit"**
3. Измените значение **Priority**
4. Нажмите **"Save"**

**Примечание:** Правила с большим приоритетом проверяются первыми.

### Работа с CIDR

#### Использование CIDR в правилах

**Отдельный IP:**
```
192.168.1.1
```

**CIDR подсеть:**
```
192.168.1.0/24  # 192.168.1.0 - 192.168.1.255 (256 адресов)
10.0.0.0/16     # 10.0.0.0 - 10.0.255.255 (65536 адресов)
172.16.0.0/12   # 172.16.0.0 - 172.31.255.255 (1048576 адресов)
```

**Все адреса:**
```
0.0.0.0/0  # Все IP адреса
```

**Примеры правил с CIDR:**

Разрешить всю внутреннюю сеть:
```json
{
  "source": "192.168.1.0/24",
  "action": "allow"
}
```

Заблокировать внешнюю сеть:
```json
{
  "source": "0.0.0.0/0",
  "destination": "192.168.1.0/24",
  "action": "deny"
}
```

### Работа с Stateful Inspection

#### Включение Stateful Inspection

1. Перейдите на вкладку **"Settings"**
2. В секции **"Inspection & Logging"** включите **Stateful Inspection**
3. Нажмите **"Save"**

**Поведение:**
- Firewall отслеживает состояния всех соединений
- Установленные соединения (established) разрешаются автоматически
- Невалидные состояния блокируются
- Старые соединения очищаются по timeout

#### Просмотр активных соединений

1. Перейдите на вкладку **"Activity"**
2. Просматривайте метрики:
   - **Total Connections** - Общее количество соединений
   - **Active Connections** - Количество активных соединений

**Примечание:** Детальная информация о соединениях доступна в логах.

### Работа с логами

#### Просмотр логов

1. Перейдите на вкладку **"Logs"**
2. Просматривайте список обработанных пакетов
3. Фильтруйте логи по действию: `all`, `allowed`, `blocked`, `rejected`
4. Используйте поиск для фильтрации по тексту

#### Фильтрация логов

1. В секции **"Filter"** выберите действие: `all`, `allowed`, `blocked`, `rejected`
2. Используйте поле поиска для фильтрации по IP адресам, портам, протоколам

#### Поиск в логах

1. Введите текст в поле поиска
2. Логи фильтруются по:
   - Source IP
   - Destination IP
   - Protocol
   - Port
   - Rule name
   - Reason

### Мониторинг метрик

#### Просмотр метрик

1. Перейдите на вкладку **"Activity"**
2. Просматривайте метрики в реальном времени:
   - **Total Packets** - Общее количество обработанных пакетов
   - **Allowed Packets** - Количество разрешенных пакетов
   - **Blocked Packets** - Количество заблокированных пакетов
   - **Rejected Packets** - Количество отклоненных пакетов
   - **Active Rules** - Количество активных правил
   - **Total Connections** - Общее количество соединений
   - **Active Connections** - Количество активных соединений

#### Понимание метрик

- **Total Packets** - Все пакеты, обработанные Firewall
- **Allowed Packets** - Пакеты, разрешенные правилами или stateful inspection
- **Blocked Packets** - Пакеты, заблокированные правилами (deny)
- **Rejected Packets** - Пакеты, отклоненные правилами (reject)
- **Active Rules** - Количество включенных правил
- **Total Connections** - Общее количество отслеживаемых соединений
- **Active Connections** - Количество активных соединений в данный момент

---

## Руководство администратора

### Рекомендации по конфигурации

#### Production Firewall

```json
{
  "enableFirewall": true,
  "enableStatefulInspection": true,
  "enableLogging": true,
  "defaultPolicy": "deny",
  "logRetention": 30,
  "rules": [
    {
      "id": "allow-internal",
      "name": "Allow Internal Network",
      "action": "allow",
      "protocol": "all",
      "source": "192.168.1.0/24",
      "enabled": true,
      "priority": 100
    },
    {
      "id": "allow-http",
      "name": "Allow HTTP",
      "action": "allow",
      "protocol": "tcp",
      "port": 80,
      "enabled": true,
      "priority": 90
    },
    {
      "id": "allow-https",
      "name": "Allow HTTPS",
      "action": "allow",
      "protocol": "tcp",
      "port": 443,
      "enabled": true,
      "priority": 90
    },
    {
      "id": "block-ssh-external",
      "name": "Block SSH from External",
      "action": "deny",
      "protocol": "tcp",
      "source": "0.0.0.0/0",
      "port": 22,
      "enabled": true,
      "priority": 200
    }
  ]
}
```

**Рекомендации:**
- Используйте `defaultPolicy: "deny"` для максимальной безопасности
- Включите `enableStatefulInspection: true` для умной фильтрации
- Включите `enableLogging: true` для аудита
- Используйте приоритеты правил для правильного порядка проверки
- Разрешайте только необходимые протоколы и порты
- Блокируйте нежелательный трафик явными правилами

### Оптимизация производительности

#### Приоритет правил

**Рекомендации:**
- Размещайте наиболее часто используемые правила с высоким приоритетом
- Размещайте общие правила (например, блокировка всего) с низким приоритетом
- Группируйте правила по типу трафика

**Пример оптимизации:**
```json
[
  {
    "name": "Allow Internal (high priority)",
    "source": "192.168.1.0/24",
    "action": "allow",
    "priority": 100  // Проверяется первым
  },
  {
    "name": "Block SSH (medium priority)",
    "port": 22,
    "action": "deny",
    "priority": 50   // Проверяется вторым
  },
  {
    "name": "Default Deny (low priority)",
    "action": "deny",
    "priority": 1    // Проверяется последним
  }
]
```

#### Stateful Inspection

**Рекомендации:**
- Включите stateful inspection для улучшения производительности
- Установленные соединения обрабатываются быстрее (не проверяются правила)
- Мониторьте количество активных соединений

**Преимущества:**
- Быстрая обработка установленных соединений
- Автоматическая блокировка невалидных состояний
- Меньше нагрузки на правила для установленных соединений

#### Количество правил

**Рекомендации:**
- Минимизируйте количество правил для лучшей производительности
- Объединяйте похожие правила
- Используйте CIDR для группировки IP адресов
- Отключайте неиспользуемые правила

**Влияние на производительность:**
- Каждое правило добавляет ~0.01ms к латентности
- При большом количестве правил (>100) латентность может увеличиться
- Используйте приоритеты для раннего выхода из проверки

### Безопасность

#### Управление доступом

- Используйте `defaultPolicy: "deny"` для максимальной безопасности
- Разрешайте только необходимые протоколы и порты
- Блокируйте нежелательный трафик явными правилами
- Используйте CIDR для группировки IP адресов
- Регулярно проверяйте логи на подозрительную активность

#### Защита от атак

- Блокируйте известные вредоносные IP адреса
- Ограничивайте доступ к административным портам (SSH, RDP)
- Используйте stateful inspection для обнаружения невалидных состояний
- Мониторьте количество блокированных пакетов

#### Логирование

- Включите логирование для аудита (`enableLogging: true`)
- Настройте `logRetention` для хранения логов
- Регулярно анализируйте логи на подозрительную активность
- Экспортируйте логи для долгосрочного хранения

### Мониторинг и алертинг

#### Ключевые метрики

1. **Total Packets**
   - Нормальное значение: зависит от нагрузки
   - Алерт: резкое увеличение может указывать на атаку

2. **Blocked Packets**
   - Нормальное значение: зависит от правил
   - Алерт: резкое увеличение может указывать на атаку

3. **Active Connections**
   - Нормальное значение: зависит от нагрузки
   - Алерт: activeConnections > 10000 (высокая нагрузка на память)

4. **Average Latency**
   - Нормальное значение: < 5ms (software firewall)
   - Алерт: averageLatency > 10ms (медленная обработка)

5. **Active Rules**
   - Нормальное значение: зависит от конфигурации
   - Алерт: activeRules > 200 (может замедлить обработку)

#### Рекомендации по алертингу

- Настройте алерты на резкое увеличение `blockedPackets`
- Настройте алерты на высокую `activeConnections`
- Настройте алерты на высокую `averageLatency`
- Настройте алерты на большое количество `activeRules`

---

## Метрики и мониторинг

### Метрики Packets

- **totalPackets** - Общее количество обработанных пакетов
- **allowedPackets** - Количество разрешенных пакетов
- **blockedPackets** - Количество заблокированных пакетов
- **rejectedPackets** - Количество отклоненных пакетов

### Метрики Rules

- **activeRules** - Количество активных правил

### Метрики Connections

- **totalConnections** - Общее количество отслеживаемых соединений
- **activeConnections** - Количество активных соединений в данный момент

### Per-Second Метрики

- **packetsPerSecond** - Скорость обработки пакетов (PPS)
- **averageLatency** - Средняя latency обработки (ms)
- **blockRate** - Процент заблокированных пакетов (0-1)
- **rejectionRate** - Процент отклоненных пакетов (0-1)

### Мониторинг в реальном времени

Все метрики обновляются в реальном времени во время симуляции:
- Метрики синхронизируются из `FirewallEmulationEngine` каждые 500ms
- Метрики отображаются в UI компонента
- Логи обновляются в реальном времени
- Правила применяются к каждому пакету

---

## Примеры использования

### Пример 1: Базовый Firewall для защиты сервера

**Сценарий:** Защита веб-сервера от нежелательного трафика

```json
{
  "enableFirewall": true,
  "enableStatefulInspection": true,
  "defaultPolicy": "deny",
  "rules": [
    {
      "id": "allow-http",
      "name": "Allow HTTP",
      "action": "allow",
      "protocol": "tcp",
      "port": 80,
      "enabled": true,
      "priority": 100
    },
    {
      "id": "allow-https",
      "name": "Allow HTTPS",
      "action": "allow",
      "protocol": "tcp",
      "port": 443,
      "enabled": true,
      "priority": 100
    },
    {
      "id": "allow-ssh-internal",
      "name": "Allow SSH from Internal",
      "action": "allow",
      "protocol": "tcp",
      "source": "192.168.1.0/24",
      "port": 22,
      "enabled": true,
      "priority": 100
    }
  ]
}
```

### Пример 2: Firewall с блокировкой внешнего доступа

**Сценарий:** Разрешить доступ только из внутренней сети

```json
{
  "enableFirewall": true,
  "defaultPolicy": "deny",
  "rules": [
    {
      "id": "allow-internal",
      "name": "Allow Internal Network",
      "action": "allow",
      "protocol": "all",
      "source": "192.168.1.0/24",
      "enabled": true,
      "priority": 100
    },
    {
      "id": "block-external",
      "name": "Block External",
      "action": "deny",
      "protocol": "all",
      "source": "0.0.0.0/0",
      "enabled": true,
      "priority": 200
    }
  ]
}
```

### Пример 3: Firewall для защиты базы данных

**Сценарий:** Защита базы данных, разрешить доступ только из приложения

```json
{
  "enableFirewall": true,
  "enableStatefulInspection": true,
  "defaultPolicy": "deny",
  "rules": [
    {
      "id": "allow-app-db",
      "name": "Allow App to DB",
      "action": "allow",
      "protocol": "tcp",
      "source": "192.168.1.10",
      "destination": "192.168.1.20",
      "port": 5432,
      "enabled": true,
      "priority": 100
    },
    {
      "id": "block-all-db",
      "name": "Block All Other DB Access",
      "action": "deny",
      "protocol": "tcp",
      "destination": "192.168.1.20",
      "port": 5432,
      "enabled": true,
      "priority": 50
    }
  ]
}
```

### Пример 4: Firewall с логированием

**Сценарий:** Firewall с полным логированием для аудита

```json
{
  "enableFirewall": true,
  "enableLogging": true,
  "logRetention": 90,
  "defaultPolicy": "deny",
  "rules": [
    {
      "id": "allow-all-logged",
      "name": "Allow All (Logged)",
      "action": "allow",
      "protocol": "all",
      "enabled": true,
      "priority": 100
    }
  ]
}
```

### Пример 5: Firewall с ICMP фильтрацией

**Сценарий:** Разрешить ICMP ping только из внутренней сети

```json
{
  "enableFirewall": true,
  "defaultPolicy": "deny",
  "rules": [
    {
      "id": "allow-icmp-internal",
      "name": "Allow ICMP from Internal",
      "action": "allow",
      "protocol": "icmp",
      "source": "192.168.1.0/24",
      "enabled": true,
      "priority": 100
    },
    {
      "id": "block-icmp-external",
      "name": "Block ICMP from External",
      "action": "deny",
      "protocol": "icmp",
      "source": "0.0.0.0/0",
      "enabled": true,
      "priority": 200
    }
  ]
}
```

---

## Часто задаваемые вопросы (FAQ)

### Что такое Network Firewall?

Network Firewall - это сетевой файрвол для контроля и фильтрации сетевого трафика на уровне IP адресов, портов и протоколов. Firewall анализирует каждый пакет и решает, разрешить его, заблокировать или отклонить на основе правил.

### Как работает Firewall?

1. Firewall получает сетевые пакеты от компонентов
2. Firewall проверяет пакеты на соответствие правилам (если включен stateful inspection, сначала проверяется состояние соединения)
3. Первое совпавшее правило определяет действие (allow, deny, reject)
4. Если правило не совпало, применяется default policy
5. Все действия логируются (если включено логирование)

### Что такое Stateful Inspection?

Stateful Inspection - это метод фильтрации пакетов, который отслеживает состояния соединений. Firewall запоминает установленные соединения и разрешает пакеты от установленных соединений автоматически, без проверки правил.

### Что такое Default Policy?

Default Policy - это политика по умолчанию, которая применяется к пакетам, не соответствующим ни одному правилу. Может быть `allow` (разрешить все), `deny` (заблокировать все) или `reject` (отклонить все).

### Как работает приоритет правил?

Правила обрабатываются по приоритету (от большего к меньшему). Первое совпавшее правило определяет действие, и дальнейшая проверка останавливается.

### Что такое CIDR?

CIDR (Classless Inter-Domain Routing) - это метод указания IP адресов и сетей. Например, `192.168.1.0/24` означает все адреса от 192.168.1.0 до 192.168.1.255.

### Как настроить правило?

1. Перейдите на вкладку **"Rules"**
2. Нажмите **"Add Rule"**
3. Заполните параметры (name, action, protocol, source, destination, port)
4. Установите приоритет
5. Нажмите **"Save"**

### Как работает логирование?

Если включено логирование (`enableLogging: true`), Firewall логирует все обработанные пакеты с информацией о действии, source, destination, protocol, port и правиле (если совпало).

### Как мониторить Firewall?

Используйте метрики Firewall:
- **Total Packets** - Общее количество обработанных пакетов
- **Blocked Packets** - Количество заблокированных пакетов
- **Active Connections** - Количество активных соединений
- **Average Latency** - Средняя latency обработки

### Как работает Connection Rules?

Connection Rules автоматически настраивают Firewall при подключении компонентов:
- Компоненты могут подключаться через Firewall
- Firewall автоматически фильтрует трафик между компонентами
- Правила могут автоматически создаваться на основе подключений

---

## Дополнительные ресурсы

- [iptables Documentation](https://www.netfilter.org/documentation/)
- [pfSense Documentation](https://docs.netgate.com/pfsense/)
- [AWS Network Firewall Documentation](https://docs.aws.amazon.com/network-firewall/)
- [Linux netfilter conntrack](https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt)
- [TCP/IP Protocol Suite](https://en.wikipedia.org/wiki/Internet_protocol_suite)
- [CIDR Notation](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing)
